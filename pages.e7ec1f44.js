let t,e,i,s;const r=Number.isFinite||function(t){return"number"==typeof t&&isFinite(t)},a=Number.isSafeInteger||function(t){return"number"==typeof t&&Math.abs(t)<=n},n=Number.MAX_SAFE_INTEGER||0x1fffffffffffff;let l=((E={}).NETWORK_ERROR="networkError",E.MEDIA_ERROR="mediaError",E.KEY_SYSTEM_ERROR="keySystemError",E.MUX_ERROR="muxError",E.OTHER_ERROR="otherError",E),o=((T={}).KEY_SYSTEM_NO_KEYS="keySystemNoKeys",T.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",T.KEY_SYSTEM_NO_SESSION="keySystemNoSession",T.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",T.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",T.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",T.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",T.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",T.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",T.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",T.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR="keySystemDestroyMediaKeysError",T.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR="keySystemDestroyCloseSessionError",T.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR="keySystemDestroyRemoveSessionError",T.MANIFEST_LOAD_ERROR="manifestLoadError",T.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",T.MANIFEST_PARSING_ERROR="manifestParsingError",T.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",T.LEVEL_EMPTY_ERROR="levelEmptyError",T.LEVEL_LOAD_ERROR="levelLoadError",T.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",T.LEVEL_PARSING_ERROR="levelParsingError",T.LEVEL_SWITCH_ERROR="levelSwitchError",T.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",T.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",T.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",T.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",T.FRAG_LOAD_ERROR="fragLoadError",T.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",T.FRAG_DECRYPT_ERROR="fragDecryptError",T.FRAG_PARSING_ERROR="fragParsingError",T.FRAG_GAP="fragGap",T.REMUX_ALLOC_ERROR="remuxAllocError",T.KEY_LOAD_ERROR="keyLoadError",T.KEY_LOAD_TIMEOUT="keyLoadTimeOut",T.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",T.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",T.BUFFER_APPEND_ERROR="bufferAppendError",T.BUFFER_APPENDING_ERROR="bufferAppendingError",T.BUFFER_STALLED_ERROR="bufferStalledError",T.BUFFER_FULL_ERROR="bufferFullError",T.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",T.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",T.ASSET_LIST_LOAD_ERROR="assetListLoadError",T.ASSET_LIST_LOAD_TIMEOUT="assetListLoadTimeout",T.ASSET_LIST_PARSING_ERROR="assetListParsingError",T.INTERSTITIAL_ASSET_ITEM_ERROR="interstitialAssetItemError",T.INTERNAL_EXCEPTION="internalException",T.INTERNAL_ABORTED="aborted",T.ATTACH_MEDIA_ERROR="attachMediaError",T.UNKNOWN="unknown",T),h=((b={}).MEDIA_ATTACHING="hlsMediaAttaching",b.MEDIA_ATTACHED="hlsMediaAttached",b.MEDIA_DETACHING="hlsMediaDetaching",b.MEDIA_DETACHED="hlsMediaDetached",b.MEDIA_ENDED="hlsMediaEnded",b.STALL_RESOLVED="hlsStallResolved",b.BUFFER_RESET="hlsBufferReset",b.BUFFER_CODECS="hlsBufferCodecs",b.BUFFER_CREATED="hlsBufferCreated",b.BUFFER_APPENDING="hlsBufferAppending",b.BUFFER_APPENDED="hlsBufferAppended",b.BUFFER_EOS="hlsBufferEos",b.BUFFERED_TO_END="hlsBufferedToEnd",b.BUFFER_FLUSHING="hlsBufferFlushing",b.BUFFER_FLUSHED="hlsBufferFlushed",b.MANIFEST_LOADING="hlsManifestLoading",b.MANIFEST_LOADED="hlsManifestLoaded",b.MANIFEST_PARSED="hlsManifestParsed",b.LEVEL_SWITCHING="hlsLevelSwitching",b.LEVEL_SWITCHED="hlsLevelSwitched",b.LEVEL_LOADING="hlsLevelLoading",b.LEVEL_LOADED="hlsLevelLoaded",b.LEVEL_UPDATED="hlsLevelUpdated",b.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",b.LEVELS_UPDATED="hlsLevelsUpdated",b.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",b.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",b.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",b.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",b.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",b.AUDIO_TRACK_UPDATED="hlsAudioTrackUpdated",b.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",b.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",b.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",b.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",b.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",b.SUBTITLE_TRACK_UPDATED="hlsSubtitleTrackUpdated",b.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",b.CUES_PARSED="hlsCuesParsed",b.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",b.INIT_PTS_FOUND="hlsInitPtsFound",b.FRAG_LOADING="hlsFragLoading",b.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",b.FRAG_LOADED="hlsFragLoaded",b.FRAG_DECRYPTED="hlsFragDecrypted",b.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",b.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",b.FRAG_PARSING_METADATA="hlsFragParsingMetadata",b.FRAG_PARSED="hlsFragParsed",b.FRAG_BUFFERED="hlsFragBuffered",b.FRAG_CHANGED="hlsFragChanged",b.FPS_DROP="hlsFpsDrop",b.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",b.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",b.ERROR="hlsError",b.DESTROYING="hlsDestroying",b.KEY_LOADING="hlsKeyLoading",b.KEY_LOADED="hlsKeyLoaded",b.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",b.BACK_BUFFER_REACHED="hlsBackBufferReached",b.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",b.ASSET_LIST_LOADING="hlsAssetListLoading",b.ASSET_LIST_LOADED="hlsAssetListLoaded",b.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",b.INTERSTITIALS_BUFFERED_TO_BOUNDARY="hlsInterstitialsBufferedToBoundary",b.INTERSTITIAL_ASSET_PLAYER_CREATED="hlsInterstitialAssetPlayerCreated",b.INTERSTITIAL_STARTED="hlsInterstitialStarted",b.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",b.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",b.INTERSTITIAL_ASSET_ERROR="hlsInterstitialAssetError",b.INTERSTITIAL_ENDED="hlsInterstitialEnded",b.INTERSTITIALS_PRIMARY_RESUMED="hlsInterstitialsPrimaryResumed",b.PLAYOUT_LIMIT_REACHED="hlsPlayoutLimitReached",b.EVENT_CUE_ENTER="hlsEventCueEnter",b);var d,u,c,f,g,p,m,y,v,E,T,b,S,A,_={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},x={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};class L{constructor(t,e=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=t,this.alpha_=t?Math.exp(Math.log(.5)/t):0,this.estimate_=e,this.totalWeight_=i}sample(t,e){let i=Math.pow(this.alpha_,t);this.estimate_=e*(1-i)+i*this.estimate_,this.totalWeight_+=t}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){let t=1-Math.pow(this.alpha_,this.totalWeight_);if(t)return this.estimate_/t}return this.estimate_}}class I{constructor(t,e,i,s=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new L(t),this.fast_=new L(e),this.defaultTTFB_=s,this.ttfb_=new L(t)}update(t,e){let{slow_:i,fast_:s,ttfb_:r}=this;i.halfLife!==t&&(this.slow_=new L(t,i.getEstimate(),i.getTotalWeight())),s.halfLife!==e&&(this.fast_=new L(e,s.getEstimate(),s.getTotalWeight())),r.halfLife!==t&&(this.ttfb_=new L(t,r.getEstimate(),r.getTotalWeight()))}sample(t,e){let i=(t=Math.max(t,this.minDelayMs_))/1e3,s=8*e/i;this.fast_.sample(i,s),this.slow_.sample(i,s)}sampleTTFB(t){let e=Math.sqrt(2)*Math.exp(-Math.pow(t/1e3,2)/2);this.ttfb_.sample(e,Math.max(t,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}get defaultEstimate(){return this.defaultEstimate_}destroy(){}}function R(){return(R=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var s in i)({}).hasOwnProperty.call(i,s)&&(t[s]=i[s])}return t}).apply(null,arguments)}function D(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,s)}return i}function k(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?D(Object(i),!0).forEach(function(e){var s,r;s=e,r=i[e],(s=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var s=i.call(t,e);if("object"!=typeof s)return s;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}(s))in t?Object.defineProperty(t,s,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[s]=r}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):D(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}class P{constructor(t,e){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;let i=`[${t}]:`;this.trace=C,this.debug=e.debug.bind(null,i),this.log=e.log.bind(null,i),this.warn=e.warn.bind(null,i),this.info=e.info.bind(null,i),this.error=e.error.bind(null,i)}}const C=function(){},M={trace:C,debug:C,log:C,warn:C,info:C,error:C};function w(){return R({},M)}function O(t,e,i){return e[t]?e[t].bind(e):function(t,e){let i=self.console[t];return i?i.bind(self.console,`${e?"["+e+"] ":""}[${t}] >`):C}(t,i)}const F=w();function N(t=!0){if("undefined"!=typeof self)return(t||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function B(t,e){let i=Object.keys(t),s=Object.keys(e),r=i.length,a=s.length;return!r||!a||r===a&&!i.some(t=>-1===s.indexOf(t))}function U(t,e=!1){let i,s;if("undefined"!=typeof TextDecoder){let i=new TextDecoder("utf-8").decode(t);if(e){let t=i.indexOf("\0");return -1!==t?i.substring(0,t):i}return i.replace(/\0/g,"")}let r=t.length,a="",n=0;for(;n<r&&(0!==(i=t[n++])||!e);)if(0!==i&&3!==i)switch(i>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:a+=String.fromCharCode(i);break;case 12:case 13:a+=String.fromCharCode((31&i)<<6|63&(s=t[n++]));break;case 14:a+=String.fromCharCode((15&i)<<12|(63&(s=t[n++]))<<6|63&t[n++])}return a}const $={hexDump:function(t){let e="";for(let i=0;i<t.length;i++){let s=t[i].toString(16);s.length<2&&(s="0"+s),e+=s}return e}};var G={exports:{}},V=S?G.exports:(S=1,d=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,u=/^(?=([^\/?#]*))\1([^]*)$/,c=/(?:\/|^)\.(?=\/)/g,f=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,G.exports=g={buildAbsoluteURL:function(t,e,i){if(i=i||{},t=t.trim(),!(e=e.trim())){if(!i.alwaysNormalize)return t;var s=g.parseURL(t);if(!s)throw Error("Error trying to parse base URL.");return s.path=g.normalizePath(s.path),g.buildURLFromParts(s)}var r=g.parseURL(e);if(!r)throw Error("Error trying to parse relative URL.");if(r.scheme)return i.alwaysNormalize?(r.path=g.normalizePath(r.path),g.buildURLFromParts(r)):e;var a=g.parseURL(t);if(!a)throw Error("Error trying to parse base URL.");if(!a.netLoc&&a.path&&"/"!==a.path[0]){var n=u.exec(a.path);a.netLoc=n[1],a.path=n[2]}a.netLoc&&!a.path&&(a.path="/");var l={scheme:a.scheme,netLoc:r.netLoc,path:null,params:r.params,query:r.query,fragment:r.fragment};if(!r.netLoc&&(l.netLoc=a.netLoc,"/"!==r.path[0]))if(r.path){var o=a.path,h=o.substring(0,o.lastIndexOf("/")+1)+r.path;l.path=g.normalizePath(h)}else l.path=a.path,!r.params&&(l.params=a.params,r.query||(l.query=a.query));return null===l.path&&(l.path=i.alwaysNormalize?g.normalizePath(r.path):r.path),g.buildURLFromParts(l)},parseURL:function(t){var e=d.exec(t);return e?{scheme:e[1]||"",netLoc:e[2]||"",path:e[3]||"",params:e[4]||"",query:e[5]||"",fragment:e[6]||""}:null},normalizePath:function(t){for(t=t.split("").reverse().join("").replace(c,"");t.length!==(t=t.replace(f,"")).length;);return t.split("").reverse().join("")},buildURLFromParts:function(t){return t.scheme+t.netLoc+t.path+t.params+t.query+t.fragment}},G.exports);class H{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var K={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class W{constructor(t){this._byteRange=null,this._url=null,this._stats=null,this._streams=null,this.base=void 0,this.relurl=void 0,"string"==typeof t&&(t={url:t}),this.base=t,function(t,e){let i=function t(e,i){let s=Object.getPrototypeOf(e);if(s){let e=Object.getOwnPropertyDescriptor(s,i);return e||t(s,i)}}(t,e);i&&(i.enumerable=!0,Object.defineProperty(t,e,i))}(this,"stats")}setByteRange(t,e){let i,s=t.split("@",2);i=1===s.length?(null==e?void 0:e.byteRangeEndOffset)||0:parseInt(s[1]),this._byteRange=[i,parseInt(s[0])+i]}get baseurl(){return this.base.url}get byteRange(){return null===this._byteRange?[]:this._byteRange}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get elementaryStreams(){return null===this._streams&&(this._streams={[K.AUDIO]:null,[K.VIDEO]:null,[K.AUDIOVIDEO]:null}),this._streams}set elementaryStreams(t){this._streams=t}get hasStats(){return null!==this._stats}get hasStreams(){return null!==this._streams}get stats(){return null===this._stats&&(this._stats=new H),this._stats}set stats(t){this._stats=t}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=V.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(t){this._url=t}clearElementaryStreamInfo(){let{elementaryStreams:t}=this;t[K.AUDIO]=null,t[K.VIDEO]=null,t[K.AUDIOVIDEO]=null}}function Y(t){return"initSegment"!==t.sn}class j extends W{constructor(t,e){super(e),this._decryptdata=null,this._programDateTime=null,this._ref=null,this._bitrate=void 0,this.rawProgramDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.playlistOffset=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=t}get byteLength(){if(this.hasStats){let t=this.stats.total;if(t)return t}if(this.byteRange){let t=this.byteRange[0],e=this.byteRange[1];if(r(t)&&r(e))return e-t}return null}get bitrate(){return this.byteLength?8*this.byteLength/this.duration:this._bitrate?this._bitrate:null}set bitrate(t){this._bitrate=t}get decryptdata(){let{levelkeys:t}=this;if(!t&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){let t=this.levelkeys.identity;if(t)this._decryptdata=t.getDecryptData(this.sn);else{let t=Object.keys(this.levelkeys);if(1===t.length)return this._decryptdata=this.levelkeys[t[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(null===this.programDateTime)return null;let t=r(this.duration)?this.duration:0;return this.programDateTime+1e3*t}get encrypted(){var t;if(null!=(t=this._decryptdata)&&t.encrypted)return!0;if(this.levelkeys){let t=Object.keys(this.levelkeys),e=t.length;if(e>1||1===e&&this.levelkeys[t[0]].encrypted)return!0}return!1}get programDateTime(){return null===this._programDateTime&&this.rawProgramDateTime&&(this.programDateTime=Date.parse(this.rawProgramDateTime)),this._programDateTime}set programDateTime(t){if(!r(t)){this._programDateTime=this.rawProgramDateTime=null;return}this._programDateTime=t}get ref(){return Y(this)?(this._ref||(this._ref={base:this.base,start:this.start,duration:this.duration,sn:this.sn,programDateTime:this.programDateTime}),this._ref):null}addStart(t){this.setStart(this.start+t)}setStart(t){this.start=t,this._ref&&(this._ref.start=t)}setDuration(t){this.duration=t,this._ref&&(this._ref.duration=t)}setKeyFormat(t){if(this.levelkeys){let e=this.levelkeys[t];e&&!this._decryptdata&&(this._decryptdata=e.getDecryptData(this.sn))}}abortRequests(){var t,e;null==(t=this.loader)||t.abort(),null==(e=this.keyLoader)||e.abort()}setElementaryStreamInfo(t,e,i,s,r,a=!1){let{elementaryStreams:n}=this,l=n[t];if(!l){n[t]={startPTS:e,endPTS:i,startDTS:s,endDTS:r,partial:a};return}l.startPTS=Math.min(l.startPTS,e),l.endPTS=Math.max(l.endPTS,i),l.startDTS=Math.min(l.startDTS,s),l.endDTS=Math.max(l.endDTS,r)}}class z extends W{constructor(t,e,i,s,r){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.duration=t.decimalFloatingPoint("DURATION"),this.gap=t.bool("GAP"),this.independent=t.bool("INDEPENDENT"),this.relurl=t.enumeratedString("URI"),this.fragment=e,this.index=s;let a=t.enumeratedString("BYTERANGE");a&&this.setByteRange(a,r),r&&(this.fragOffset=r.fragOffset+r.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){let{elementaryStreams:t}=this;return!!(t.audio||t.video||t.audiovideo)}}const q=[].push,X={video:1,audio:2,id3:3,text:4};function Q(t){return String.fromCharCode.apply(null,t)}function Z(t,e){let i=t[e]<<8|t[e+1];return i<0?65536+i:i}function J(t,e){let i=te(t,e);return i<0?0x100000000+i:i}function tt(t,e){let i=J(t,e);return i*=0x100000000,i+=J(t,e+4)}function te(t,e){return t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3]}function ti(t,e,i){t[e]=i>>24,t[e+1]=i>>16&255,t[e+2]=i>>8&255,t[e+3]=255&i}function ts(t,e){let i=[];if(!e.length)return i;let s=t.byteLength;for(let r=0;r<s;){let a=J(t,r),n=Q(t.subarray(r+4,r+8)),l=a>1?r+a:s;if(n===e[0])if(1===e.length)i.push(t.subarray(r+8,l));else{let s=ts(t.subarray(r+8,l),e.slice(1));s.length&&q.apply(i,s)}r=l}return i}function tr(t){let e=[],i=ts(t,["moov","trak"]);for(let t=0;t<i.length;t++){let s=i[t],r=ts(s,["tkhd"])[0];if(r){let t=r[0],i=J(r,0===t?12:20),a=ts(s,["mdia","mdhd"])[0];if(a){t=a[0];let r=J(a,0===t?12:20),n=ts(s,["mdia","hdlr"])[0];if(n){let t=Q(n.subarray(8,12)),a={soun:K.AUDIO,vide:K.VIDEO}[t],l=function(t){let e,i=t.subarray(8),s=i.subarray(86),r=Q(i.subarray(4,8)),a=r,n="enca"===r||"encv"===r;if(n){let t=ts(i,[r])[0].subarray("enca"===r?28:78);ts(t,["sinf"]).forEach(t=>{let e=ts(t,["schm"])[0];if(e){let i=Q(e.subarray(4,8));if("cbcs"===i||"cenc"===i){let e=ts(t,["frma"])[0];e&&(a=Q(e))}}})}let l=a;switch(a){case"avc1":case"avc2":case"avc3":case"avc4":{let t=ts(s,["avcC"])[0];t&&t.length>3&&(a+="."+tl(t[1])+tl(t[2])+tl(t[3]),e=ta("avc1"===l?"dva1":"dvav",s));break}case"mp4a":{let t=ts(i,[r])[0],e=ts(t.subarray(28),["esds"])[0];if(e&&e.length>7){let t=4;if(3!==e[t++])break;t=tn(e,t)+2;let i=e[t++];if(128&i&&(t+=2),64&i&&(t+=e[t++]),4!==e[t++])break;t=tn(e,t);let s=e[t++];if(64===s)a+="."+tl(s);else break;if(t+=12,5!==e[t++])break;t=tn(e,t);let r=e[t++],n=(248&r)>>3;31===n&&(n+=1+((7&r)<<3)+((224&e[t])>>5)),a+="."+n}break}case"hvc1":case"hev1":{let t=ts(s,["hvcC"])[0];if(t&&t.length>12){let e=t[1],i=["","A","B","C"][e>>6],s=J(t,2),r=t[12],n=t.subarray(6,12);a+="."+i+(31&e),a+="."+(function(t){let e=0;for(let i=0;i<32;i++)e|=(t>>i&1)<<31-i;return e>>>0})(s).toString(16).toUpperCase(),a+="."+((32&e)>>5?"H":"L")+r;let l="";for(let t=n.length;t--;){let e=n[t];(e||l)&&(l="."+e.toString(16).toUpperCase()+l)}a+=l}e=ta("hev1"==l?"dvhe":"dvh1",s);break}case"dvh1":case"dvhe":case"dvav":case"dva1":case"dav1":a=ta(a,s)||a;break;case"vp09":{let t=ts(s,["vpcC"])[0];if(t&&t.length>6){let e=t[4],i=t[5],s=t[6]>>4&15;a+="."+to(e)+"."+to(i)+"."+to(s)}break}case"av01":{let t=ts(s,["av1C"])[0];if(t&&t.length>2){let i=t[1]>>>5,r=31&t[1],n=t[2]>>>7?"H":"M",l=(64&t[2])>>6,o=(32&t[2])>>5,h=(16&t[2])>>4,d=(8&t[2])>>3,u=(4&t[2])>>2,c=3&t[2];a+="."+i+"."+to(r)+n+"."+to(2===i&&l?o?12:10:l?10:8)+"."+h+"."+d+u+c+"."+to(1)+"."+to(1)+"."+to(1)+".0",e=ta("dav1",s)}}}return{codec:a,encrypted:n,supplemental:e}}(ts(s,["mdia","minf","stbl","stsd"])[0]);a?(e[i]={timescale:r,type:a,stsd:l},e[a]=k({timescale:r,id:i},l)):e[i]={timescale:r,type:t,stsd:l}}}}}return ts(t,["moov","mvex","trex"]).forEach(t=>{let i=e[J(t,4)];i&&(i.default={duration:J(t,12),flags:J(t,20)})}),e}function ta(t,e){let i=ts(e,["dvvC"]),s=i.length?i[0]:ts(e,["dvcC"])[0];if(s){let e=s[2]>>1&127,i=s[2]<<5&32|s[3]>>3&31;return t+"."+to(e)+"."+to(i)}}function tn(t,e){let i=e+5;for(;128&t[e++]&&e<i;);return e}function tl(t){return("0"+t.toString(16).toUpperCase()).slice(-2)}function to(t){return(t<10?"0":"")+t}function th(t){let e=ts(t,["schm"])[0];if(e){let i=Q(e.subarray(4,8));if("cbcs"===i||"cenc"===i)return ts(t,["schi","tenc"])[0]}return null}function td(t,e){let i=new Uint8Array(t.length+e.length);return i.set(t),i.set(e,t.length),i}function tu(t,e){let i=[],s=e.samples,r=e.timescale,a=e.id,n=!1;return ts(s,["moof"]).map(l=>{let o=l.byteOffset-8;ts(l,["traf"]).map(l=>{let h=ts(l,["tfdt"]).map(t=>{let e=t[0],i=J(t,4);return 1===e&&(i*=0x100000000,i+=J(t,8)),i/r})[0];return void 0!==h&&(t=h),ts(l,["tfhd"]).map(h=>{let d=J(h,4),u=0xffffff&J(h,0),c=0,f=0,g=8;d===a&&((1&u)!=0&&(g+=8),(2&u)!=0&&(g+=4),(8&u)!=0&&(c=J(h,g),g+=4),(16&u)!=0&&(f=J(h,g),g+=4),(32&u)!=0&&(g+=4),"video"===e.type&&(n=tc(e.codec)),ts(l,["trun"]).map(a=>{let l=a[0],h=0xffffff&J(a,0),d=0,u=(256&h)!=0,g=0,p=(512&h)!=0,m=0,y=(1024&h)!=0,v=(2048&h)!=0,E=0,T=J(a,4),b=8;(1&h)!=0&&(d=J(a,b),b+=4),(4&h)!=0&&(b+=4);let S=d+o;for(let o=0;o<T;o++){if(u?(g=J(a,b),b+=4):g=c,p?(m=J(a,b),b+=4):m=f,y&&(b+=4),v&&(E=0===l?J(a,b):te(a,b),b+=4),e.type===K.VIDEO){let e=0;for(;e<m;){let a=J(s,S);S+=4,function(t,e){if(!t)return 6==(31&e);{let t=e>>1&63;return 39===t||40===t}}(n,s[S])&&tf(s.subarray(S,S+a),n?2:1,t+E/r,i),S+=a,e+=a+4}}t+=g/r}}))})})}),i}function tc(t){if(!t)return!1;let e=t.substring(0,4);return"hvc1"===e||"hev1"===e||"dvh1"===e||"dvhe"===e}function tf(t,e,i,s){let r,a=tg(t);r=0+e;let n=0,l=0,o=0;for(;r<a.length;){n=0;do{if(r>=a.length)break;n+=o=a[r++]}while(255===o)l=0;do{if(r>=a.length)break;l+=o=a[r++]}while(255===o)let t=a.length-r,e=r;if(l<t)r+=l;else if(l>t){F.error(`Malformed SEI payload. ${l} is too small, only ${t} bytes left to parse.`);break}if(4===n){if(181===a[e++]){let t=Z(a,e);if(e+=2,49===t){let t=J(a,e);if(e+=4,0x47413934===t){let t=a[e++];if(3===t){let r=a[e++],l=31&r,o=64&r,h=o?2+3*l:0,d=new Uint8Array(h);if(o){d[0]=r;for(let t=1;t<h;t++)d[t]=a[e++]}s.push({type:t,payloadType:n,pts:i,bytes:d})}}}}}else if(5===n&&l>16){let t=[];for(let i=0;i<16;i++){let s=a[e++].toString(16);t.push(1==s.length?"0"+s:s),(3===i||5===i||7===i||9===i)&&t.push("-")}let r=l-16,o=new Uint8Array(r);for(let t=0;t<r;t++)o[t]=a[e++];s.push({payloadType:n,pts:i,uuid:t.join(""),userData:U(o),userDataBytes:o})}}}function tg(t){let e=t.byteLength,i=[],s=1;for(;s<e-2;)0===t[s]&&0===t[s+1]&&3===t[s+2]?(i.push(s+2),s+=2):s++;if(0===i.length)return t;let r=e-i.length,a=new Uint8Array(r),n=0;for(s=0;s<r;n++,s++)n===i[0]&&(n++,i.shift()),a[s]=t[n];return a}const tp=()=>/\(Windows.+Firefox\//i.test(navigator.userAgent),tm={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function ty(t,e){let i=tm[e];return!!i&&!!i[t.slice(0,4)]}function tv(t,e,i=!0){return!t.split(",").some(t=>!tE(t,e,i))}function tE(t,e,i=!0){var s;let r=N(i);return null!=(s=null==r?void 0:r.isTypeSupported(tT(t,e)))&&s}function tT(t,e){return`${e}/mp4;codecs=${t}`}function tb(t){if(t){let e=t.substring(0,4);return tm.video[e]}return 2}function tS(t){let e=tp();return t.split(",").reduce((t,i)=>{let s=e&&tc(i)?9:tm.video[i];return s?(2*s+t)/(t?3:2):(tm.audio[i]+t)/(t?2:1)},0)}const tA={},t_=/flac|opus|mp4a\.40\.34/i;function tx(t,e=!0){return t.replace(t_,t=>(function(t,e=!0){if(tA[t])return tA[t];let i={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"],"mp4a.40.34":["mp3"]}[t];for(let r=0;r<i.length;r++){var s;if(tE(i[r],"audio",e))return tA[t]=i[r],i[r];if("mp3"===i[r]&&null!=(s=N(e))&&s.isTypeSupported("audio/mpeg"))return""}return t})(t.toLowerCase(),e))}function tL(t,e){if(t&&(t.length>4||-1!==["ac-3","ec-3","alac","fLaC","Opus"].indexOf(t)))return t;if(e){let i=e.split(",");if(i.length>1){if(t){for(let e=i.length;e--;)if(i[e].substring(0,4)===t.substring(0,4))return i[e]}return i[0]}}return e||t}function tI(t){let e=N(t)||{isTypeSupported:()=>!1};return{mpeg:e.isTypeSupported("audio/mpeg"),mp3:e.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:e.isTypeSupported('audio/mp4; codecs="ac-3"')}}function tR(t){return t.replace(/^.+codecs=["']?([^"']+).*$/,"$1")}const tD={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]};function tk(t,e){return{supported:!1,configurations:e,decodingInfoResults:[{supported:!1,smooth:!1,powerEfficient:!1}],error:t}}const tP={};function tC(t,e,i){let s=t.videoCodec,a=t.audioCodec;if(!s&&!a||!i)return Promise.resolve(tD);let n=[];if(s){let e={width:t.width,height:t.height,bitrate:Math.ceil(Math.max(.9*t.bitrate,t.averageBitrate)),framerate:t.frameRate||30},i=t.videoRange;"SDR"!==i&&(e.transferFunction=i.toLowerCase());let r=s.split(","),a=navigator.userAgent;if(r.some(t=>tc(t))&&tp())return Promise.resolve(tk(Error(`Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent sting: (${a})`),n));n.push.apply(n,r.map(t=>({type:"media-source",video:k(k({},e),{},{contentType:tT(function(t){if(t.startsWith("av01.")){let e=t.split("."),i=["0","111","01","01","01","0"];for(let t=e.length;t>4&&t<10;t++)e[t]=i[t-4];return e.join(".")}return t}(t),"video")})})))}return a&&t.audioGroups&&t.audioGroups.forEach(t=>{var i;t&&(null==(i=e.groups[t])||i.tracks.forEach(e=>{if(e.groupId===t){let t=parseFloat(e.channels||"");r(t)&&t>2&&n.push.apply(n,a.split(",").map(e=>({type:"media-source",audio:{contentType:tT(e,"audio"),channels:""+t}})))}}))}),Promise.all(n.map(t=>{let e=function(t){let{audio:e,video:i}=t,s=i||e;if(s){let t=tR(s.contentType);if(i)return`r${i.height}x${i.width}f${Math.ceil(i.framerate)}${i.transferFunction||"sd"}_${t}_${Math.ceil(i.bitrate/1e5)}`;if(e)return`c${e.channels}${e.spatialRendering?"s":"n"}_${t}`}return""}(t);return tP[e]||(tP[e]=i.decodingInfo(t))})).then(t=>({supported:!t.some(t=>!t.supported),configurations:n,decodingInfoResults:t})).catch(t=>({supported:!1,configurations:n,decodingInfoResults:[],error:t}))}const tM=["NONE","TYPE-0","TYPE-1",null],tw=["SDR","PQ","HLG"];var tO={No:"",Yes:"YES",v2:"v2"};function tF(t){let{canSkipUntil:e,canSkipDateRanges:i,age:s}=t;return e&&s<e/2?i?tO.v2:tO.Yes:tO.No}class tN{constructor(t,e,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=t,this.part=e,this.skip=i}addDirectives(t){let e=new self.URL(t);return void 0!==this.msn&&e.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&e.searchParams.set("_HLS_part",this.part.toString()),this.skip&&e.searchParams.set("_HLS_skip",this.skip),e.href}}class tB{constructor(t){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[t.url],this._attrs=[t.attrs],this.bitrate=t.bitrate,t.details&&(this.details=t.details),this.id=t.id||0,this.name=t.name,this.width=t.width||0,this.height=t.height||0,this.frameRate=t.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=t.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=t.audioCodec,this.videoCodec=t.videoCodec,this.codecSet=[t.videoCodec,t.audioCodec].filter(t=>!!t).map(t=>t.substring(0,4)).join(","),"supplemental"in t){var e;this.supplemental=t.supplemental;let i=null==(e=t.supplemental)?void 0:e.videoCodec;i&&i!==t.videoCodec&&(this.codecSet+=`,${i.substring(0,4)}`)}this.addGroupId("audio",t.attrs.AUDIO),this.addGroupId("text",t.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(t){return tU(this._audioGroups,t)}hasSubtitleGroup(t){return tU(this._subtitleGroups,t)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(t,e){if(e){if("audio"===t){let t=this._audioGroups;t||(t=this._audioGroups=[]),-1===t.indexOf(e)&&t.push(e)}else if("text"===t){let t=this._subtitleGroups;t||(t=this._subtitleGroups=[]),-1===t.indexOf(e)&&t.push(e)}}}get urlId(){return 0}set urlId(t){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var t;return null==(t=this.audioGroups)?void 0:t[0]}get textGroupId(){var t;return null==(t=this.subtitleGroups)?void 0:t[0]}addFallback(){}}function tU(t,e){return!!e&&!!t&&-1!==t.indexOf(e)}const t$=t=>{let e=new WeakSet;return(i,s)=>{if(t&&(s=t(i,s)),"object"==typeof s&&null!==s){if(e.has(s))return;e.add(s)}return s}},tG=(t,e)=>JSON.stringify(t,t$(e));function tV(t,e){F.log(`[abr] start candidates with "${t}" ignored because ${e}`)}function tH(t){return t.reduce((t,e)=>{let i=t.groups[e.groupId];i||(i=t.groups[e.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(e);let s=e.channels||"2";return i.channels[s]=(i.channels[s]||0)+1,i.hasDefault=i.hasDefault||e.default,i.hasAutoSelect=i.hasAutoSelect||e.autoselect,i.hasDefault&&(t.hasDefaultAudio=!0),i.hasAutoSelect&&(t.hasAutoSelectAudio=!0),t},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function tK(t){if(!t)return t;let{lang:e,assocLang:i,characteristics:s,channels:r,audioCodec:a}=t;return{lang:e,assocLang:i,characteristics:s,channels:r,audioCodec:a}}function tW(t,e,i){if("attrs"in t){let i=e.indexOf(t);if(-1!==i)return i}for(let s=0;s<e.length;s++)if(tY(t,e[s],i))return s;return -1}function tY(t,e,i){let{groupId:s,name:r,lang:a,assocLang:n,default:l}=t,o=t.forced;return(void 0===s||e.groupId===s)&&(void 0===r||e.name===r)&&(void 0===a||function(t,e="--"){return t.length===e.length?t===e:t.startsWith(e)||e.startsWith(t)}(a,e.lang))&&(void 0===a||e.assocLang===n)&&(void 0===l||e.default===l)&&(void 0===o||e.forced===o)&&(!("characteristics"in t)||function(t,e=""){let i=t.split(","),s=e.split(",");return i.length===s.length&&!i.some(t=>-1===s.indexOf(t))}(t.characteristics||"",e.characteristics))&&(void 0===i||i(t,e))}function tj(t,e){let{audioCodec:i,channels:s}=t;return(void 0===i||(e.audioCodec||"").substring(0,4)===i.substring(0,4))&&(void 0===s||s===(e.channels||"2"))}function tz(t,e,i){for(let s=e;s>-1;s--)if(i(t[s]))return s;for(let s=e+1;s<t.length;s++)if(i(t[s]))return s;return -1}function tq(t,e){var i;return!!t&&t!==(null==(i=e.loadLevelObj)?void 0:i.uri)}const tX={search:function(t,e){let i=0,s=t.length-1,r=null,a=null;for(;i<=s;){let n=e(a=t[r=(i+s)/2|0]);if(n>0)i=r+1;else{if(!(n<0))return a;s=r-1}}return null}};function tQ(t,e,i=0,s=0,r=.005){let a=null;if(t){a=e[1+t.sn-e[0].sn]||null;let s=t.endDTS-i;s>0&&s<15e-7&&(i+=15e-7),a&&t.level!==a.level&&a.end<=t.end&&(a=e[2+t.sn-e[0].sn]||null)}else 0===i&&0===e[0].start&&(a=e[0]);if(a&&((!t||t.level===a.level)&&0===tZ(i,s,a)||function(t,e,i){if(e&&0===e.start&&e.level<t.level&&(e.endPTS||0)>0){let s=e.tagList.reduce((t,e)=>("INF"===e[0]&&(t+=parseFloat(e[1])),t),i);return t.start<=s}return!1}(a,t,Math.min(r,s))))return a;let n=tX.search(e,tZ.bind(null,i,s));return n&&(n!==t||!a)?n:a}function tZ(t=0,e=0,i){if(i.start<=t&&i.start+i.duration>t)return 0;let s=Math.min(e,i.duration+(i.deltaPTS?i.deltaPTS:0));return i.start+i.duration-s<=t?1:i.start-s>t&&i.start?-1:0}function tJ(t,e,i){if(t&&t.startCC<=e&&t.endCC>=e){let s,r=t.fragments,{fragmentHint:a}=t;return a&&(r=r.concat(a)),tX.search(r,t=>t.cc<e?1:t.cc>e?-1:(s=t,t.end<=i)?1:t.start>i?-1:0),s||null}return null}function t0(t){switch(t.details){case o.FRAG_LOAD_TIMEOUT:case o.KEY_LOAD_TIMEOUT:case o.LEVEL_LOAD_TIMEOUT:case o.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function t1(t,e){let i=t0(e);return t.default[`${i?"timeout":"error"}Retry`]}function t2(t,e){return Math.min(("linear"===t.backoff?1:Math.pow(2,e))*t.retryDelayMs,t.maxRetryDelayMs)}function t5(t){return k(k({},t),{errorRetry:null,timeoutRetry:null})}function t3(t,e,i,s){var r;if(!t)return!1;let a=null==s?void 0:s.code,n=e<t.maxNumRetry&&(0===(r=a)&&!1===navigator.onLine||!!r&&(r<400||r>499)||!!i);return t.shouldRetry?t.shouldRetry(t,e,i,s,n):n}var t4={DoNothing:0,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,RetryRequest:5},t8={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2};function t6(t){let e={action:t4.DoNothing,flags:t8.None};return t&&(e.resolved=!0),e}var t9={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class t7{constructor(t){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=t,this._registerListeners()}_registerListeners(){let{hls:t}=this;t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.BUFFER_APPENDED,this.onBufferAppended,this),t.on(h.FRAG_BUFFERED,this.onFragBuffered,this),t.on(h.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){let{hls:t}=this;t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.BUFFER_APPENDED,this.onBufferAppended,this),t.off(h.FRAG_BUFFERED,this.onFragBuffered,this),t.off(h.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(t,e){let i=this.activePartLists[e];if(i)for(let e=i.length;e--;){let s=i[e];if(!s)break;let r=s.end;if(s.start<=t&&null!==r&&t<=r)return s}return this.getBufferedFrag(t,e)}getBufferedFrag(t,e){return this.getFragAtPos(t,e,!0)}getFragAtPos(t,e,i){let{fragments:s}=this,r=Object.keys(s);for(let a=r.length;a--;){let n=s[r[a]];if((null==n?void 0:n.body.type)===e&&(!i||n.buffered)){let e=n.body;if(e.start<=t&&t<=e.end)return e}}return null}detectEvictedFragments(t,e,i,s,r){this.timeRanges&&(this.timeRanges[t]=e);let a=(null==s?void 0:s.fragment.sn)||-1;Object.keys(this.fragments).forEach(s=>{let n=this.fragments[s];if(!n||a>=n.body.sn)return;if(!n.buffered&&(!n.loaded||r)){n.body.type===i&&this.removeFragment(n.body);return}let l=n.range[t];if(l){if(0===l.time.length)return void this.removeFragment(n.body);l.time.some(t=>{let i=!this.isTimeBuffered(t.startPTS,t.endPTS,e);return i&&this.removeFragment(n.body),i})}})}detectPartialFragments(t){let e=this.timeRanges;if(!e||"initSegment"===t.frag.sn)return;let i=t.frag,s=ee(i),r=this.fragments[s];if(!r||r.buffered&&i.gap)return;let a=!i.relurl;Object.keys(e).forEach(s=>{let n=i.elementaryStreams[s];if(!n)return;let l=e[s],o=a||!0===n.partial;r.range[s]=this.getBufferedTimes(i,t.part,o,l)}),r.loaded=null,Object.keys(r.range).length?(r.buffered=!0,(r.body.endList=i.endList||r.body.endList)&&(this.endListFragments[r.body.type]=r),et(r)||this.removeParts(i.sn-1,i.type)):this.removeFragment(r.body)}removeParts(t,e){let i=this.activePartLists[e];i&&(this.activePartLists[e]=ei(i,e=>e.fragment.sn>=t))}fragBuffered(t,e){let i=ee(t),s=this.fragments[i];!s&&e&&(s=this.fragments[i]={body:t,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},t.gap&&(this.hasGaps=!0)),s&&(s.loaded=null,s.buffered=!0)}getBufferedTimes(t,e,i,s){let r={time:[],partial:i},a=t.start,n=t.end,l=t.minEndPTS||n,o=t.maxStartPTS||a;for(let t=0;t<s.length;t++){let e=s.start(t)-this.bufferPadding,i=s.end(t)+this.bufferPadding;if(o>=e&&l<=i){r.time.push({startPTS:Math.max(a,s.start(t)),endPTS:Math.min(n,s.end(t))});break}if(a<i&&n>e){let e=Math.max(a,s.start(t)),i=Math.min(n,s.end(t));i>e&&(r.partial=!0,r.time.push({startPTS:e,endPTS:i}))}else if(n<=e)break}return r}getPartialFragment(t){let e,i,s,r=null,a=0,{bufferPadding:n,fragments:l}=this;return Object.keys(l).forEach(o=>{let h=l[o];h&&et(h)&&(i=h.body.start-n,s=h.body.end+n,t>=i&&t<=s&&a<=(e=Math.min(t-i,s-t))&&(r=h.body,a=e))}),r}isEndListAppended(t){let e=this.endListFragments[t];return void 0!==e&&(e.buffered||et(e))}getState(t){let e=ee(t),i=this.fragments[e];if(i)if(!i.buffered)return t9.APPENDING;else if(et(i))return t9.PARTIAL;else return t9.OK;return t9.NOT_LOADED}isTimeBuffered(t,e,i){let s,r;for(let a=0;a<i.length;a++){if(s=i.start(a)-this.bufferPadding,r=i.end(a)+this.bufferPadding,t>=s&&e<=r)return!0;if(e<=s)break}return!1}onManifestLoading(){this.removeAllFragments()}onFragLoaded(t,e){if("initSegment"===e.frag.sn||e.frag.bitrateTest)return;let i=e.frag,s=e.part?null:e,r=ee(i);this.fragments[r]={body:i,appendedPTS:null,loaded:s,buffered:!1,range:Object.create(null)}}onBufferAppended(t,e){let{frag:i,part:s,timeRanges:r,type:a}=e;if("initSegment"===i.sn)return;let n=i.type;if(s){let t=this.activePartLists[n];t||(this.activePartLists[n]=t=[]),t.push(s)}this.timeRanges=r;let l=r[a];this.detectEvictedFragments(a,l,n,s)}onFragBuffered(t,e){this.detectPartialFragments(e)}hasFragment(t){let e=ee(t);return!!this.fragments[e]}hasFragments(t){let{fragments:e}=this,i=Object.keys(e);if(!t)return i.length>0;for(let s=i.length;s--;){let r=e[i[s]];if((null==r?void 0:r.body.type)===t)return!0}return!1}hasParts(t){var e;return!!(null!=(e=this.activePartLists[t])&&e.length)}removeFragmentsInRange(t,e,i,s,r){(!s||this.hasGaps)&&Object.keys(this.fragments).forEach(a=>{let n=this.fragments[a];if(!n)return;let l=n.body;l.type===i&&(!s||l.gap)&&l.start<e&&l.end>t&&(n.buffered||r)&&this.removeFragment(l)})}removeFragment(t){let e=ee(t);t.clearElementaryStreamInfo();let i=this.activePartLists[t.type];if(i){let e=t.sn;this.activePartLists[t.type]=ei(i,t=>t.fragment.sn!==e)}delete this.fragments[e],t.endList&&delete this.endListFragments[t.type]}removeAllFragments(){var t,e;this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1;let i=null==(t=this.hls)||null==(e=t.latestLevelDetails)?void 0:e.partList;i&&i.forEach(t=>t.clearElementaryStreamInfo())}}function et(t){var e,i,s;return t.buffered&&(t.body.gap||(null==(e=t.range.video)?void 0:e.partial)||(null==(i=t.range.audio)?void 0:i.partial)||(null==(s=t.range.audiovideo)?void 0:s.partial))}function ee(t){return`${t.type}_${t.level}_${t.sn}`}function ei(t,e){return t.filter(t=>{let i=e(t);return i||t.clearElementaryStreamInfo(),i})}var es={cbc:0,ctr:1};class er{constructor(t,e,i){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=t,this.aesIV=e,this.aesMode=i}decrypt(t,e){switch(this.aesMode){case es.cbc:return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},e,t);case es.ctr:return this.subtle.decrypt({name:"AES-CTR",counter:this.aesIV,length:64},e,t);default:throw Error(`[AESCrypto] invalid aes mode ${this.aesMode}`)}}}class ea{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(t){let e=new DataView(t),i=new Uint32Array(4);for(let t=0;t<4;t++)i[t]=e.getUint32(4*t);return i}initTable(){let t=this.sBox,e=this.invSBox,i=this.subMix,s=i[0],r=i[1],a=i[2],n=i[3],l=this.invSubMix,o=l[0],h=l[1],d=l[2],u=l[3],c=new Uint32Array(256),f=0,g=0,p=0;for(p=0;p<256;p++)p<128?c[p]=p<<1:c[p]=p<<1^283;for(p=0;p<256;p++){let i=g^g<<1^g<<2^g<<3^g<<4;i=i>>>8^255&i^99,t[f]=i,e[i]=f;let l=c[f],p=c[l],m=c[p],y=257*c[i]^0x1010100*i;s[f]=y<<24|y>>>8,r[f]=y<<16|y>>>16,a[f]=y<<8|y>>>24,n[f]=y,y=0x1010101*m^65537*p^257*l^0x1010100*f,o[i]=y<<24|y>>>8,h[i]=y<<16|y>>>16,d[i]=y<<8|y>>>24,u[i]=y,f?(f=l^c[c[c[m^l]]],g^=c[c[g]]):f=g=1}}expandKey(t){let e,i,s,r,a=this.uint8ArrayToUint32Array_(t),n=!0,l=0;for(;l<a.length&&n;)n=a[l]===this.key[l],l++;if(n)return;this.key=a;let o=this.keySize=a.length;if(4!==o&&6!==o&&8!==o)throw Error("Invalid aes key size="+o);let h=this.ksRows=(o+6+1)*4,d=this.keySchedule=new Uint32Array(h),u=this.invKeySchedule=new Uint32Array(h),c=this.sBox,f=this.rcon,g=this.invSubMix,p=g[0],m=g[1],y=g[2],v=g[3];for(e=0;e<h;e++){if(e<o){s=d[e]=a[e];continue}r=s,e%o==0?r=(c[(r=r<<8|r>>>24)>>>24]<<24|c[r>>>16&255]<<16|c[r>>>8&255]<<8|c[255&r])^f[e/o|0]<<24:o>6&&e%o==4&&(r=c[r>>>24]<<24|c[r>>>16&255]<<16|c[r>>>8&255]<<8|c[255&r]),d[e]=s=(d[e-o]^r)>>>0}for(i=0;i<h;i++)e=h-i,r=3&i?d[e]:d[e-4],i<4||e<=4?u[i]=r:u[i]=p[c[r>>>24]]^m[c[r>>>16&255]]^y[c[r>>>8&255]]^v[c[255&r]],u[i]=u[i]>>>0}networkToHostOrderSwap(t){return t<<24|(65280&t)<<8|(0xff0000&t)>>8|t>>>24}decrypt(t,e,i){let s,r,a,n,l,o,h,d,u,c,f,g,p,m,y=this.keySize+6,v=this.invKeySchedule,E=this.invSBox,T=this.invSubMix,b=T[0],S=T[1],A=T[2],_=T[3],x=this.uint8ArrayToUint32Array_(i),L=x[0],I=x[1],R=x[2],D=x[3],k=new Int32Array(t),P=new Int32Array(k.length),C=this.networkToHostOrderSwap;for(;e<k.length;){for(m=1,u=C(k[e]),c=C(k[e+1]),f=C(k[e+2]),g=C(k[e+3]),l=u^v[0],o=g^v[1],h=f^v[2],d=c^v[3],p=4;m<y;m++)s=b[l>>>24]^S[o>>16&255]^A[h>>8&255]^_[255&d]^v[p],r=b[o>>>24]^S[h>>16&255]^A[d>>8&255]^_[255&l]^v[p+1],a=b[h>>>24]^S[d>>16&255]^A[l>>8&255]^_[255&o]^v[p+2],n=b[d>>>24]^S[l>>16&255]^A[o>>8&255]^_[255&h]^v[p+3],l=s,o=r,h=a,d=n,p+=4;s=E[l>>>24]<<24^E[o>>16&255]<<16^E[h>>8&255]<<8^E[255&d]^v[p],r=E[o>>>24]<<24^E[h>>16&255]<<16^E[d>>8&255]<<8^E[255&l]^v[p+1],a=E[h>>>24]<<24^E[d>>16&255]<<16^E[l>>8&255]<<8^E[255&o]^v[p+2],n=E[d>>>24]<<24^E[l>>16&255]<<16^E[o>>8&255]<<8^E[255&h]^v[p+3],P[e]=C(s^L),P[e+1]=C(n^I),P[e+2]=C(a^R),P[e+3]=C(r^D),L=u,I=c,R=f,D=g,e+=4}return P.buffer}}class en{constructor(t,e,i){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=t,this.key=e,this.aesMode=i}expandKey(){let t=function(t){switch(t){case es.cbc:return"AES-CBC";case es.ctr:return"AES-CTR";default:throw Error(`[FastAESKey] invalid aes mode ${t}`)}}(this.aesMode);return this.subtle.importKey("raw",this.key,{name:t},!1,["encrypt","decrypt"])}}class el{constructor(t,{removePKCS7Padding:e=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=t.enableSoftwareAES,this.removePKCS7Padding=e,e)try{let t=self.crypto;t&&(this.subtle=t.subtle||t.webkitSubtle)}catch(t){}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){let{currentResult:t,remainderData:e}=this;if(!t||e)return this.reset(),null;let i=new Uint8Array(t);if(this.reset(),this.removePKCS7Padding){let t=i.byteLength,e=t&&new DataView(i.buffer).getUint8(t-1);return e?i.slice(0,t-e):i}return i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(t,e,i,s){return this.useSoftware?new Promise((r,a)=>{let n=ArrayBuffer.isView(t)?t:new Uint8Array(t);this.softwareDecrypt(n,e,i,s);let l=this.flush();l?r(l.buffer):a(Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(t),e,i,s)}softwareDecrypt(t,e,i,s){let{currentIV:r,currentResult:a,remainderData:n}=this;if(s!==es.cbc||16!==e.byteLength)return F.warn("SoftwareDecrypt: can only handle AES-128-CBC"),null;this.logOnce("JS AES decrypt"),n&&(t=td(n,t),this.remainderData=null);let l=this.getValidChunk(t);if(!l.length)return null;r&&(i=r);let o=this.softwareDecrypter;return(o||(o=this.softwareDecrypter=new ea),o.expandKey(e),this.currentResult=o.decrypt(l.buffer,0,i),this.currentIV=l.slice(-16).buffer,a)?a:null}webCryptoDecrypt(t,e,i,s){if(this.key!==e||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(t,e,i,s));this.key=e,this.fastAesKey=new en(this.subtle,e,s)}return this.fastAesKey.expandKey().then(e=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new er(this.subtle,new Uint8Array(i),s).decrypt(t.buffer,e)):Promise.reject(Error("web crypto not initialized"))).catch(r=>(F.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${r.name}: ${r.message}`),this.onWebCryptoError(t,e,i,s)))}onWebCryptoError(t,e,i,s){let r=this.enableSoftwareAES;if(r){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(t,e,i,s);let r=this.flush();if(r)return r.buffer}throw Error("WebCrypto"+(r?" and softwareDecrypt":"")+": failed to decrypt data")}getValidChunk(t){let e=t,i=t.length-t.length%16;return i!==t.length&&(e=t.slice(0,i),this.remainderData=t.slice(i)),e}logOnce(t){this.logEnabled&&(F.log(`[decrypter]: ${t}`),this.logEnabled=!1)}}class eo{constructor(t){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=t}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(t,e){let i=t.url;if(!i)return Promise.reject(new eu({type:l.NETWORK_ERROR,details:o.FRAG_LOAD_ERROR,fatal:!1,frag:t,error:Error(`Fragment does not have a ${i?"part list":"url"}`),networkDetails:null}));this.abort();let s=this.config,r=s.fLoader,a=s.loader;return new Promise((n,h)=>{if(this.loader&&this.loader.destroy(),t.gap)if(t.tagList.some(t=>"GAP"===t[0]))return void h(ed(t));else t.gap=!1;let d=this.loader=r?new r(s):new a(s),u=eh(t);t.loader=d;let c=t5(s.fragLoadPolicy.default),f={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:"initSegment"===t.sn?1/0:131072};t.stats=d.stats;let g={onSuccess:(e,i,s,r)=>{this.resetLoader(t,d);let a=e.data;s.resetIV&&t.decryptdata&&(t.decryptdata.iv=new Uint8Array(a.slice(0,16)),a=a.slice(16)),n({frag:t,part:null,payload:a,networkDetails:r})},onError:(e,s,r,a)=>{this.resetLoader(t,d),h(new eu({type:l.NETWORK_ERROR,details:o.FRAG_LOAD_ERROR,fatal:!1,frag:t,response:k({url:i,data:void 0},e),error:Error(`HTTP Error ${e.code} ${e.text}`),networkDetails:r,stats:a}))},onAbort:(e,i,s)=>{this.resetLoader(t,d),h(new eu({type:l.NETWORK_ERROR,details:o.INTERNAL_ABORTED,fatal:!1,frag:t,error:Error("Aborted"),networkDetails:s,stats:e}))},onTimeout:(e,i,s)=>{this.resetLoader(t,d),h(new eu({type:l.NETWORK_ERROR,details:o.FRAG_LOAD_TIMEOUT,fatal:!1,frag:t,error:Error(`Timeout after ${f.timeout}ms`),networkDetails:s,stats:e}))}};e&&(g.onProgress=(i,s,r,a)=>e({frag:t,part:null,payload:r,networkDetails:a})),d.load(u,f,g)})}loadPart(t,e,i){this.abort();let s=this.config,r=s.fLoader,a=s.loader;return new Promise((n,h)=>{if(this.loader&&this.loader.destroy(),t.gap||e.gap)return void h(ed(t,e));let d=this.loader=r?new r(s):new a(s),u=eh(t,e);t.loader=d;let c=t5(s.fragLoadPolicy.default),f={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:131072};e.stats=d.stats,d.load(u,f,{onSuccess:(s,r,a,l)=>{this.resetLoader(t,d),this.updateStatsFromPart(t,e);let o={frag:t,part:e,payload:s.data,networkDetails:l};i(o),n(o)},onError:(i,s,r,a)=>{this.resetLoader(t,d),h(new eu({type:l.NETWORK_ERROR,details:o.FRAG_LOAD_ERROR,fatal:!1,frag:t,part:e,response:k({url:u.url,data:void 0},i),error:Error(`HTTP Error ${i.code} ${i.text}`),networkDetails:r,stats:a}))},onAbort:(i,s,r)=>{t.stats.aborted=e.stats.aborted,this.resetLoader(t,d),h(new eu({type:l.NETWORK_ERROR,details:o.INTERNAL_ABORTED,fatal:!1,frag:t,part:e,error:Error("Aborted"),networkDetails:r,stats:i}))},onTimeout:(i,s,r)=>{this.resetLoader(t,d),h(new eu({type:l.NETWORK_ERROR,details:o.FRAG_LOAD_TIMEOUT,fatal:!1,frag:t,part:e,error:Error(`Timeout after ${f.timeout}ms`),networkDetails:r,stats:i}))}})})}updateStatsFromPart(t,e){let i=t.stats,s=e.stats,r=s.total;if(i.loaded+=s.loaded,r){let s=Math.round(t.duration/e.duration),a=Math.min(Math.round(i.loaded/r),s),n=(s-a)*Math.round(i.loaded/a);i.total=i.loaded+n}else i.total=Math.max(i.loaded,i.total);let a=i.loading,n=s.loading;a.start?a.first+=n.first-n.start:(a.start=n.start,a.first=n.first),a.end=n.end}resetLoader(t,e){t.loader=null,this.loader===e&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),e.destroy()}}function eh(t,e=null){let i=e||t,s={frag:t,part:e,responseType:"arraybuffer",url:i.url,headers:{},rangeStart:0,rangeEnd:0},a=i.byteRangeStartOffset,n=i.byteRangeEndOffset;if(r(a)&&r(n)){var l,o;let e=a,i=n;if("initSegment"===t.sn&&("AES-128"===(o=null==(l=t.decryptdata)?void 0:l.method)||"AES-256"===o)){let t=n-a;t%16&&(i=n+(16-t%16)),0!==a&&(s.resetIV=!0,e=a-16)}s.rangeStart=e,s.rangeEnd=i}return s}function ed(t,e){let i=Error(`GAP ${t.gap?"tag":"attribute"} found`),s={type:l.MEDIA_ERROR,details:o.FRAG_GAP,fatal:!1,frag:t,error:i,networkDetails:null};return e&&(s.part=e),(e||t).stats.aborted=!0,new eu(s)}class eu extends Error{constructor(t){super(t.error.message),this.data=void 0,this.data=t}}class ec extends P{constructor(t,e){super(t,e),this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(t){return!this._tickInterval&&(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,t),!0)}clearInterval(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)}clearNextTick(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)}tick(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}class ef{constructor(t,e,i,s=0,r=-1,a=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=eg(),this.buffering={audio:eg(),video:eg(),audiovideo:eg()},this.level=t,this.sn=e,this.id=i,this.size=s,this.part=r,this.partial=a}}function eg(){return{start:0,executeStart:0,executeEnd:0,end:0}}const ep={length:0,start:()=>0,end:()=>0};class em{static isBuffered(t,e){if(t){let i=em.getBuffered(t);for(let t=i.length;t--;)if(e>=i.start(t)&&e<=i.end(t))return!0}return!1}static bufferedRanges(t){if(t){let e=em.getBuffered(t);return em.timeRangesToArray(e)}return[]}static timeRangesToArray(t){let e=[];for(let i=0;i<t.length;i++)e.push({start:t.start(i),end:t.end(i)});return e}static bufferInfo(t,e,i){if(t){let s=em.bufferedRanges(t);if(s.length)return em.bufferedInfo(s,e,i)}return{len:0,start:e,end:e,bufferedIndex:-1}}static bufferedInfo(t,e,i){let s;e=Math.max(0,e),t.length>1&&t.sort((t,e)=>t.start-e.start||e.end-t.end);let r=-1,a=[];if(i)for(let s=0;s<t.length;s++){e>=t[s].start&&e<=t[s].end&&(r=s);let n=a.length;if(n){let e=a[n-1].end;t[s].start-e<i?t[s].end>e&&(a[n-1].end=t[s].end):a.push(t[s])}else a.push(t[s])}else a=t;let n=0,l=e,o=e;for(let t=0;t<a.length;t++){let h=a[t].start,d=a[t].end;if(-1===r&&e>=h&&e<=d&&(r=t),e+i>=h&&e<d)l=h,n=(o=d)-e;else if(e+i<h){s=h;break}}return{len:n,start:l||0,end:o||0,nextStart:s,buffered:t,bufferedIndex:r}}static getBuffered(t){try{return t.buffered||ep}catch(t){return F.log("failed to get media.buffered",t),ep}}}const ey=/\{\$([a-zA-Z0-9-_]+)\}/g;function ev(t,e){if(null!==t.variableList||t.hasVariableRefs){let i=t.variableList;return e.replace(ey,e=>{let s=e.substring(2,e.length-1),r=null==i?void 0:i[s];return void 0===r?(t.playlistParsingError||(t.playlistParsingError=Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${s}"`)),e):r})}return e}function eE(t,e,i){let s,r,a=t.variableList;if(a||(t.variableList=a={}),"QUERYPARAM"in e){s=e.QUERYPARAM;try{let t=new self.URL(i).searchParams;if(t.has(s))r=t.get(s);else throw Error(`"${s}" does not match any query parameter in URI: "${i}"`)}catch(e){t.playlistParsingError||(t.playlistParsingError=Error(`EXT-X-DEFINE QUERYPARAM: ${e.message}`))}}else s=e.NAME,r=e.VALUE;s in a?t.playlistParsingError||(t.playlistParsingError=Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${s}"`)):a[s]=r||""}const eT=/^(\d+)x(\d+)$/,eb=/(.+?)=(".*?"|.*?)(?:,|$)/g;class eS{constructor(t,e){"string"==typeof t&&(t=eS.parseAttrList(t,e)),R(this,t)}get clientAttrs(){return Object.keys(this).filter(t=>"X-"===t.substring(0,2))}decimalInteger(t){let e=parseInt(this[t],10);return e>Number.MAX_SAFE_INTEGER?1/0:e}hexadecimalInteger(t){if(this[t]){let e=(this[t]||"0x").slice(2),i=new Uint8Array((e=(1&e.length?"0":"")+e).length/2);for(let t=0;t<e.length/2;t++)i[t]=parseInt(e.slice(2*t,2*t+2),16);return i}return null}hexadecimalIntegerAsNumber(t){let e=parseInt(this[t],16);return e>Number.MAX_SAFE_INTEGER?1/0:e}decimalFloatingPoint(t){return parseFloat(this[t])}optionalFloat(t,e){let i=this[t];return i?parseFloat(i):e}enumeratedString(t){return this[t]}enumeratedStringList(t,e){let i=this[t];return(i?i.split(/[ ,]+/):[]).reduce((t,e)=>(t[e.toLowerCase()]=!0,t),e)}bool(t){return"YES"===this[t]}decimalResolution(t){let e=eT.exec(this[t]);if(null!==e)return{width:parseInt(e[1],10),height:parseInt(e[2],10)}}static parseAttrList(t,e){let i,s={};for(eb.lastIndex=0;null!==(i=eb.exec(t));){let r=i[1].trim(),a=i[2],n=0===a.indexOf('"')&&a.lastIndexOf('"')===a.length-1,l=!1;if(n)a=a.slice(1,-1);else switch(r){case"IV":case"SCTE35-CMD":case"SCTE35-IN":case"SCTE35-OUT":l=!0}if(e&&(n||l))a=ev(e,a);else if(!l&&!n)switch(r){case"CLOSED-CAPTIONS":if("NONE"===a)break;case"ALLOWED-CPC":case"CLASS":case"ASSOC-LANGUAGE":case"AUDIO":case"BYTERANGE":case"CHANNELS":case"CHARACTERISTICS":case"CODECS":case"DATA-ID":case"END-DATE":case"GROUP-ID":case"ID":case"IMPORT":case"INSTREAM-ID":case"KEYFORMAT":case"KEYFORMATVERSIONS":case"LANGUAGE":case"NAME":case"PATHWAY-ID":case"QUERYPARAM":case"RECENTLY-REMOVED-DATERANGES":case"SERVER-URI":case"STABLE-RENDITION-ID":case"STABLE-VARIANT-ID":case"START-DATE":case"SUBTITLES":case"SUPPLEMENTAL-CODECS":case"URI":case"VALUE":case"VIDEO":case"X-ASSET-LIST":case"X-ASSET-URI":F.warn(`${t}: attribute ${r} is missing quotes`)}s[r]=a}return s}}class eA{constructor(t,e,i=0){var s;if(this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=(null==e?void 0:e.tagAnchor)||null,this.tagOrder=null!=(s=null==e?void 0:e.tagOrder)?s:i,e){let i=e.attr;for(let e in i)if(Object.prototype.hasOwnProperty.call(t,e)&&t[e]!==i[e]){F.warn(`DATERANGE tag attribute: "${e}" does not match for tags with ID: "${t.ID}"`),this._badValueForSameId=e;break}t=R(new eS({}),i,t)}if(this.attr=t,e?(this._startDate=e._startDate,this._cue=e._cue,this._endDate=e._endDate,this._dateAtEnd=e._dateAtEnd):this._startDate=new Date(t["START-DATE"]),"END-DATE"in this.attr){let t=(null==e?void 0:e.endDate)||new Date(this.attr["END-DATE"]);r(t.getTime())&&(this._endDate=t)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get cue(){let t=this._cue;return void 0===t?this._cue=this.attr.enumeratedStringList(this.attr.CUE?"CUE":"X-CUE",{pre:!1,post:!1,once:!1}):t}get startTime(){let{tagAnchor:t}=this;return null===t||null===t.programDateTime?(F.warn(`Expected tagAnchor Fragment with PDT set for DateRange "${this.id}": ${t}`),NaN):t.start+(this.startDate.getTime()-t.programDateTime)/1e3}get startDate(){return this._startDate}get endDate(){let t=this._endDate||this._dateAtEnd;if(t)return t;let e=this.duration;return null!==e?this._dateAtEnd=new Date(this._startDate.getTime()+1e3*e):null}get duration(){if("DURATION"in this.attr){let t=this.attr.decimalFloatingPoint("DURATION");if(r(t))return t}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isInterstitial(){return"com.apple.hls.interstitial"===this.class}get isValid(){return!!this.id&&!this._badValueForSameId&&r(this.startDate.getTime())&&(null===this.duration||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||"X-ASSET-URI"in this.attr||"X-ASSET-LIST"in this.attr)}}class e_{constructor(t){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.dateRangeTagCount=0,this.live=!0,this.requestScheduled=-1,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.appliedTimelineOffset=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=t}reloaded(t){if(!t){this.advanced=!0,this.updated=!0;return}let e=this.lastPartSn-t.lastPartSn,i=this.lastPartIndex-t.lastPartIndex;this.updated=this.endSN!==t.endSN||!!i||!!e||!this.live,this.advanced=this.endSN>t.endSN||e>0||0===e&&i>0,this.updated||this.advanced?this.misses=Math.floor(.6*t.misses):this.misses=t.misses+1}get hasProgramDateTime(){return!!this.fragments.length&&r(this.fragments[this.fragments.length-1].programDateTime)}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||10}get drift(){let t=this.driftEndTime-this.driftStartTime;return t>0?1e3*(this.driftEnd-this.driftStart)/t:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var t;return null!=(t=this.partList)&&t.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var t;return null!=(t=this.fragments)&&t.length?this.fragments[this.fragments.length-1].end:0}get fragmentStart(){var t;return null!=(t=this.fragments)&&t.length?this.fragments[0].start:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var t;return null!=(t=this.partList)&&t.length?this.partList[this.partList.length-1].index:-1}get maxPartIndex(){let t=this.partList;if(t){let e=this.lastPartIndex;if(-1!==e){for(let i=t.length;i--;)if(t[i].index>e)return t[i].index;return e}}return 0}get lastPartSn(){var t;return null!=(t=this.partList)&&t.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}get expired(){if(this.live&&this.age&&this.misses<3){let t=this.partEnd-this.fragmentStart;return this.age>Math.max(t,this.totalduration)+this.levelTargetDuration}return!1}}function ex(t){return"AES-128"===t||"AES-256"===t||"AES-256-CTR"===t}function eL(t){switch(t){case"AES-128":case"AES-256":return es.cbc;case"AES-256-CTR":return es.ctr;default:throw Error(`invalid full segment method ${t}`)}}function eI(t){return Uint8Array.from(atob(t),t=>t.charCodeAt(0))}function eR(t){return Uint8Array.from(unescape(encodeURIComponent(t)),t=>t.charCodeAt(0))}const eD="undefined"!=typeof self?self:void 0;var ek={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},eP={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function eC(t){switch(t){case eP.FAIRPLAY:return ek.FAIRPLAY;case eP.PLAYREADY:return ek.PLAYREADY;case eP.WIDEVINE:return ek.WIDEVINE;case eP.CLEARKEY:return ek.CLEARKEY}}var eM={CENC:"1077efecc0b24d02ace33c1e52e2fb4b",CLEARKEY:"e2719d58a985b3c9781ab030af78d30e",PLAYREADY:"9a04f07998404286ab92e65be0885f95",WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"};function ew(t){return t===eM.WIDEVINE?ek.WIDEVINE:t===eM.PLAYREADY?ek.PLAYREADY:t===eM.CENC||t===eM.CLEARKEY?ek.CLEARKEY:void 0}function eO(t){switch(t){case ek.FAIRPLAY:return eP.FAIRPLAY;case ek.PLAYREADY:return eP.PLAYREADY;case ek.WIDEVINE:return eP.WIDEVINE;case ek.CLEARKEY:return eP.CLEARKEY}}function eF(t){let{drmSystems:e,widevineLicenseUrl:i}=t,s=e?[ek.FAIRPLAY,ek.WIDEVINE,ek.PLAYREADY,ek.CLEARKEY].filter(t=>!!e[t]):[];return!s[ek.WIDEVINE]&&i&&s.push(ek.WIDEVINE),s}const eN=null!=eD&&null!=(p=eD.navigator)&&p.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null;function eB(t){let e=new Uint16Array(t.buffer,t.byteOffset,t.byteLength/2),i=String.fromCharCode.apply(null,Array.from(e)),s=i.substring(i.indexOf("<"),i.length),r=new DOMParser().parseFromString(s,"text/xml").getElementsByTagName("KID")[0];if(r){let t=r.childNodes[0]?r.childNodes[0].nodeValue:r.getAttribute("VALUE");if(t){let e=eI(t).subarray(0,16),i=function(t,e,i){let s=t[e];t[e]=t[i],t[i]=s};return i(e,0,3),i(e,1,2),i(e,4,5),i(e,6,7),e}}return null}let eU={};class e${static clearKeyUriToKeyIdMap(){eU={}}constructor(t,e,i,s=[1],r=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=t,this.uri=e,this.keyFormat=i,this.keyFormatVersions=s,this.iv=r,this.encrypted=!!t&&"NONE"!==t,this.isCommonEncryption=this.encrypted&&!ex(t)}isSupported(){if(this.method){if(ex(this.method)||"NONE"===this.method)return!0;if("identity"===this.keyFormat)return"SAMPLE-AES"===this.method;switch(this.keyFormat){case eP.FAIRPLAY:case eP.WIDEVINE:case eP.PLAYREADY:case eP.CLEARKEY:return -1!==["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)}}return!1}getDecryptData(t){if(!this.encrypted||!this.uri)return null;if(ex(this.method)&&this.uri&&!this.iv){"number"!=typeof t&&(F.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),t=0);let e=function(t){let e=new Uint8Array(16);for(let i=12;i<16;i++)e[i]=t>>8*(15-i)&255;return e}(t);return new e$(this.method,this.uri,"identity",this.keyFormatVersions,e)}let e=function(t){let e=t.split(":"),i=null;if("data"===e[0]&&2===e.length){let t=e[1].split(";"),s=t[t.length-1].split(",");if(2===s.length){let e="base64"===s[0],r=s[1];e?(t.splice(-1,1),i=eI(r)):i=function(t){let e=eR(t).subarray(0,16),i=new Uint8Array(16);return i.set(e,16-e.length),i}(r)}}return i}(this.uri);if(e)switch(this.keyFormat){case eP.WIDEVINE:this.pssh=e,e.length>=22&&(this.keyId=e.subarray(e.length-22,e.length-6));break;case eP.PLAYREADY:{let t=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=function(t,e,i){let s,r;if(16!==t.byteLength)throw RangeError("Invalid system id");s=new Uint8Array,r=new Uint8Array;let a=new Uint8Array(4);return i&&i.byteLength>0&&new DataView(a.buffer).setUint32(0,i.byteLength,!1),function(t,...e){let i=e.length,s=8,r=i;for(;r--;)s+=e[r].byteLength;let a=new Uint8Array(s);for(a[0]=s>>24&255,a[1]=s>>16&255,a[2]=s>>8&255,a[3]=255&s,a.set(t,4),r=0,s=8;r<i;r++)a.set(e[r],s),s+=e[r].byteLength;return a}([112,115,115,104],new Uint8Array([0,0,0,0]),t,r,s,a,i||new Uint8Array)}(t,0,e),this.keyId=eB(e);break}default:{let t=e.subarray(0,16);if(16!==t.length){let e=new Uint8Array(16);e.set(t,16-t.length),t=e}this.keyId=t}}if(!this.keyId||16!==this.keyId.byteLength){let t=eU[this.uri];if(!t){let e=Object.keys(eU).length%Number.MAX_SAFE_INTEGER;new DataView((t=new Uint8Array(16)).buffer,12,4).setUint32(0,e),eU[this.uri]=t}this.keyId=t}return this}}const eG=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,eV=/#EXT-X-MEDIA:(.*)/g,eH=/^#EXT(?:INF|-X-TARGETDURATION):/m,eK=RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#.*/.source].join("|"),"g"),eW=new RegExp([/#EXT-X-(PROGRAM-DATE-TIME|BYTERANGE|DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class eY{static findGroup(t,e){for(let i=0;i<t.length;i++){let s=t[i];if(s.id===e)return s}}static resolve(t,e){return V.buildAbsoluteURL(e,t,{alwaysNormalize:!0})}static isMediaPlaylist(t){return eH.test(t)}static parseMasterPlaylist(t,e){var i;let s,r={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:ey.test(t)},a=[];for(eG.lastIndex=0;null!=(s=eG.exec(t));)if(s[1]){let t=new eS(s[1],r),n=ev(r,s[2]),l={attrs:t,bitrate:t.decimalInteger("BANDWIDTH")||t.decimalInteger("AVERAGE-BANDWIDTH"),name:t.NAME,url:eY.resolve(n,e)},o=t.decimalResolution("RESOLUTION");o&&(l.width=o.width,l.height=o.height),eX(t.CODECS,l);let h=t["SUPPLEMENTAL-CODECS"];h&&(l.supplemental={},eX(h,l.supplemental)),null!=(i=l.unknownCodecs)&&i.length||a.push(l),r.levels.push(l)}else if(s[3]){let t=s[3],i=s[4];switch(t){case"SESSION-DATA":{let t=new eS(i,r),e=t["DATA-ID"];e&&(null===r.sessionData&&(r.sessionData={}),r.sessionData[e]=t);break}case"SESSION-KEY":{let t=ez(i,e,r);t.encrypted&&t.isSupported()?(null===r.sessionKeys&&(r.sessionKeys=[]),r.sessionKeys.push(t)):F.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${i}"`);break}case"DEFINE":{let t=new eS(i,r);eE(r,t,e)}break;case"CONTENT-STEERING":{let t=new eS(i,r);r.contentSteering={uri:eY.resolve(t["SERVER-URI"],e),pathwayId:t["PATHWAY-ID"]||"."};break}case"START":r.startTimeOffset=eq(i)}}let n=a.length>0&&a.length<r.levels.length;return r.levels=n?a:r.levels,0===r.levels.length&&(r.playlistParsingError=Error("no levels found in manifest")),r}static parseMasterPlaylistMedia(t,e,i){let s,r={},a=i.levels,n={AUDIO:a.map(t=>({id:t.attrs.AUDIO,audioCodec:t.audioCodec})),SUBTITLES:a.map(t=>({id:t.attrs.SUBTITLES,textCodec:t.textCodec})),"CLOSED-CAPTIONS":[]},l=0;for(eV.lastIndex=0;null!==(s=eV.exec(t));){let t=new eS(s[1],i),a=t.TYPE;if(a){let i=n[a],s=r[a]||[];r[a]=s;let o=t.LANGUAGE,h=t["ASSOC-LANGUAGE"],d=t.CHANNELS,u=t.CHARACTERISTICS,c=t["INSTREAM-ID"],f={attrs:t,bitrate:0,id:l++,groupId:t["GROUP-ID"]||"",name:t.NAME||o||"",type:a,default:t.bool("DEFAULT"),autoselect:t.bool("AUTOSELECT"),forced:t.bool("FORCED"),lang:o,url:t.URI?eY.resolve(t.URI,e):""};if(h&&(f.assocLang=h),d&&(f.channels=d),u&&(f.characteristics=u),c&&(f.instreamId=c),null!=i&&i.length){let t=eY.findGroup(i,f.groupId)||i[0];eQ(f,t,"audioCodec"),eQ(f,t,"textCodec")}s.push(f)}}return r}static parseLevelPlaylist(t,e,i,s,a,n){let l,o,h,d,u={url:e},c=new e_(e),f=c.fragments,g=[],p=null,m=0,y=0,v=0,E=0,T=0,b=null,S=new j(s,u),A=-1,_=!1,x=null;if(eK.lastIndex=0,c.m3u8=t,c.hasVariableRefs=ey.test(t),(null==(L=eK.exec(t))?void 0:L[0])!=="#EXTM3U")return c.playlistParsingError=Error("Missing format identifier #EXTM3U"),c;for(;null!==(l=eK.exec(t));){_&&(_=!1,(S=new j(s,u)).playlistOffset=v,S.start=v,S.sn=m,S.cc=E,T&&(S.bitrate=T),S.level=i,p&&(S.initSegment=p,p.rawProgramDateTime&&(S.rawProgramDateTime=p.rawProgramDateTime,p.rawProgramDateTime=null),x&&(S.setByteRange(x),x=null)));let t=l[1];if(t){S.duration=parseFloat(t);let e=(" "+l[2]).slice(1);S.title=e||null,S.tagList.push(e?["INF",t,e]:["INF",t])}else if(l[3]){if(r(S.duration)){S.playlistOffset=v,S.start=v,h&&e0(S,h,c),S.sn=m,S.level=i,S.cc=E,f.push(S);let t=(" "+l[3]).slice(1);S.relurl=ev(c,t),eZ(S,b,g),b=S,v+=S.duration,m++,y=0,_=!0}}else{if(!(l=l[0].match(eW))){F.warn("No matches on slow regex match for level playlist!");continue}for(o=1;o<l.length&&void 0===l[o];o++);let t=(" "+l[o]).slice(1),a=(" "+l[o+1]).slice(1),g=l[o+2]?(" "+l[o+2]).slice(1):null;switch(t){case"BYTERANGE":b?S.setByteRange(a,b):S.setByteRange(a);break;case"PROGRAM-DATE-TIME":S.rawProgramDateTime=a,S.tagList.push(["PROGRAM-DATE-TIME",a]),-1===A&&(A=f.length);break;case"PLAYLIST-TYPE":c.type&&e1(c,t,l),c.type=a.toUpperCase();break;case"MEDIA-SEQUENCE":0!==c.startSN?e1(c,t,l):f.length>0&&e2(c,t,l),m=c.startSN=parseInt(a);break;case"SKIP":{c.skippedSegments&&e1(c,t,l);let e=new eS(a,c),i=e.decimalInteger("SKIPPED-SEGMENTS");if(r(i)){c.skippedSegments+=i;for(let t=i;t--;)f.push(null);m+=i}let s=e.enumeratedString("RECENTLY-REMOVED-DATERANGES");s&&(c.recentlyRemovedDateranges=(c.recentlyRemovedDateranges||[]).concat(s.split("	")));break}case"TARGETDURATION":0!==c.targetduration&&e1(c,t,l),c.targetduration=Math.max(parseInt(a),1);break;case"VERSION":null!==c.version&&e1(c,t,l),c.version=parseInt(a);break;case"INDEPENDENT-SEGMENTS":break;case"ENDLIST":c.live||e1(c,t,l),c.live=!1;break;case"#":(a||g)&&S.tagList.push(g?[a,g]:[a]);break;case"DISCONTINUITY":E++,S.tagList.push(["DIS"]);break;case"GAP":S.gap=!0,S.tagList.push([t]);break;case"BITRATE":S.tagList.push([t,a]),r(T=1e3*parseInt(a))?S.bitrate=T:T=0;break;case"DATERANGE":{let t=new eS(a,c),e=new eA(t,c.dateRanges[t.ID],c.dateRangeTagCount);c.dateRangeTagCount++,e.isValid||c.skippedSegments?c.dateRanges[e.id]=e:F.warn(`Ignoring invalid DATERANGE tag: "${a}"`),S.tagList.push(["EXT-X-DATERANGE",a]);break}case"DEFINE":{let t=new eS(a,c);if("IMPORT"in t){var L;let e=t.IMPORT;if(n&&e in n){let t=c.variableList;t||(c.variableList=t={}),t[e]=n[e]}else c.playlistParsingError||(c.playlistParsingError=Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${e}"`))}else eE(c,t,e)}break;case"DISCONTINUITY-SEQUENCE":0!==c.startCC?e1(c,t,l):f.length>0&&e2(c,t,l),c.startCC=E=parseInt(a);break;case"KEY":{let t=ez(a,e,c);if(t.isSupported()){if("NONE"===t.method){h=void 0;break}h||(h={}),h[t.keyFormat]&&(h=R({},h)),h[t.keyFormat]=t}else F.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${a}"`);break}case"START":c.startTimeOffset=eq(a);break;case"MAP":{let t=new eS(a,c);if(S.duration){let e=new j(s,u);eJ(e,t,i,h),p=e,S.initSegment=p,p.rawProgramDateTime&&!S.rawProgramDateTime&&(S.rawProgramDateTime=p.rawProgramDateTime)}else{let e=S.byteRangeEndOffset;if(e){let t=S.byteRangeStartOffset;x=`${e-t}@${t}`}else x=null;eJ(S,t,i,h),p=S,_=!0}p.cc=E;break}case"SERVER-CONTROL":d&&e1(c,t,l),c.canBlockReload=(d=new eS(a)).bool("CAN-BLOCK-RELOAD"),c.canSkipUntil=d.optionalFloat("CAN-SKIP-UNTIL",0),c.canSkipDateRanges=c.canSkipUntil>0&&d.bool("CAN-SKIP-DATERANGES"),c.partHoldBack=d.optionalFloat("PART-HOLD-BACK",0),c.holdBack=d.optionalFloat("HOLD-BACK",0);break;case"PART-INF":c.partTarget&&e1(c,t,l),c.partTarget=new eS(a).decimalFloatingPoint("PART-TARGET");break;case"PART":{let t=c.partList;t||(t=c.partList=[]);let e=y>0?t[t.length-1]:void 0,i=y++,s=new z(new eS(a,c),S,u,i,e);t.push(s),S.duration+=s.duration;break}case"PRELOAD-HINT":{let t=new eS(a,c);c.preloadHint=t;break}case"RENDITION-REPORT":{let t=new eS(a,c);c.renditionReports=c.renditionReports||[],c.renditionReports.push(t);break}default:F.warn(`line parsed but not handled: ${l}`)}}}b&&!b.relurl?(f.pop(),v-=b.duration,c.partList&&(c.fragmentHint=b)):c.partList&&(eZ(S,b,g),S.cc=E,c.fragmentHint=S,h&&e0(S,h,c)),c.targetduration||(c.playlistParsingError=Error("#EXT-X-TARGETDURATION is required"));let I=f.length,D=f[0],k=f[I-1];if((v+=c.skippedSegments*c.targetduration)>0&&I&&k){c.averagetargetduration=v/I;let t=k.sn;c.endSN="initSegment"!==t?t:0,c.live||(k.endList=!0),D&&void 0===c.startCC&&(c.startCC=D.cc),A>0&&(function(t,e){let i=t[e];for(let s=e;s--;){let e=t[s];if(!e)return;e.programDateTime=i.programDateTime-1e3*e.duration,i=e}}(f,A),D&&g.unshift(D))}else c.endSN=0,c.startCC=0;return c.fragmentHint&&(v+=c.fragmentHint.duration),c.totalduration=v,g.length&&c.dateRangeTagCount&&D&&ej(g,c),c.endCC=E,c}}function ej(t,e){let i=t.length;if(!i)return;let s=t[i-1],r=e.live?1/0:e.totalduration,a=Object.keys(e.dateRanges);for(let n=a.length;n--;){let l=e.dateRanges[a[n]],o=l.startDate.getTime();l.tagAnchor=s.ref;for(let s=i;s--;){let i=function(t,e,i,s,r){let a=i[s];if(a){let l=a.programDateTime;if(e>=l||0===s){var n;if(e<=l+1e3*(((null==(n=i[s+1])?void 0:n.start)||r)-a.start)){let r=i[s].sn-t.startSN,a=t.fragments;if(a.length>i.length){let n=(i[s+1]||a[a.length-1]).sn-t.startSN;for(let t=n;t>r;t--){let i=a[t].programDateTime;if(e>=i&&e<i+1e3*a[t].duration)return t}}return r}}}return -1}(e,o,t,s,r);if(-1!==i){l.tagAnchor=e.fragments[i].ref;break}}}}function ez(t,e,i){var s,r;let a=new eS(t,i),n=null!=(s=a.METHOD)?s:"",l=a.URI,o=a.hexadecimalInteger("IV"),h=a.KEYFORMATVERSIONS,d=null!=(r=a.KEYFORMAT)?r:"identity";return l&&a.IV&&!o&&F.error(`Invalid IV: ${a.IV}`),new e$(n,l?eY.resolve(l,e):"",d,(h||"1").split("/").map(Number).filter(Number.isFinite),o)}function eq(t){let e=new eS(t).decimalFloatingPoint("TIME-OFFSET");return r(e)?e:null}function eX(t,e){let i=(t||"").split(/[ ,]+/).filter(t=>t);["video","audio","text"].forEach(t=>{let s=i.filter(e=>ty(e,t));s.length&&(e[`${t}Codec`]=s.map(t=>t.split("/")[0]).join(","),i=i.filter(t=>-1===s.indexOf(t)))}),e.unknownCodecs=i}function eQ(t,e,i){let s=e[i];s&&(t[i]=s)}function eZ(t,e,i){t.rawProgramDateTime?i.push(t):null!=e&&e.programDateTime&&(t.programDateTime=e.endProgramDateTime)}function eJ(t,e,i,s){t.relurl=e.URI,e.BYTERANGE&&t.setByteRange(e.BYTERANGE),t.level=i,t.sn="initSegment",s&&(t.levelkeys=s),t.initSegment=null}function e0(t,e,i){t.levelkeys=e;let{encryptedFragments:s}=i;(!s.length||s[s.length-1].levelkeys!==e)&&Object.keys(e).some(t=>e[t].isCommonEncryption)&&s.push(t)}function e1(t,e,i){t.playlistParsingError=Error(`#EXT-X-${e} must not appear more than once (${i[0]})`)}function e2(t,e,i){t.playlistParsingError=Error(`#EXT-X-${e} must appear before the first Media Segment (${i[0]})`)}function e5(t,e){let i=e.startPTS;if(r(i)){let s,r=0;e.sn>t.sn?(r=i-t.start,s=t):(r=t.start-i,s=e),s.duration!==r&&s.setDuration(r)}else e.sn>t.sn?t.cc===e.cc&&t.minEndPTS?e.setStart(t.start+(t.minEndPTS-t.start)):e.setStart(t.start+t.duration):e.setStart(Math.max(t.start-e.duration,0))}function e3(t,e,i,s,a,n){let l;s-i<=0&&(F.warn("Fragment should have a positive duration",e),s=i+e.duration,n=a+e.duration);let o=i,h=s,d=e.startPTS,u=e.endPTS;if(r(d)){let t=Math.abs(d-i);r(e.deltaPTS)?e.deltaPTS=Math.max(t,e.deltaPTS):e.deltaPTS=t,o=Math.max(i,d),i=Math.min(i,d),a=Math.min(a,e.startDTS),h=Math.min(s,u),s=Math.max(s,u),n=Math.max(n,e.endDTS)}let c=i-e.start;0!==e.start&&e.setStart(i),e.setDuration(s-e.start),e.startPTS=i,e.maxStartPTS=o,e.startDTS=a,e.endPTS=s,e.minEndPTS=h,e.endDTS=n;let f=e.sn;if(!t||f<t.startSN||f>t.endSN)return 0;let g=f-t.startSN,p=t.fragments;for(p[g]=e,l=g;l>0;l--)e5(p[l],p[l-1]);for(l=g;l<p.length-1;l++)e5(p[l],p[l+1]);return t.fragmentHint&&e5(p[p.length-1],t.fragmentHint),t.PTSKnown=t.alignedSliding=!0,c}function e4(t,e,i,s,r){return Error(`${t} ${r.url}
Playlist starting @${e.startSN}
${e.m3u8}

Playlist starting @${i.startSN}
${i.m3u8}`)}function e8(t,e,i=!0){let s=e.startSN+e.skippedSegments-t.startSN,r=t.fragments,a=s>=0,n=0;if(a&&s<r.length)n=r[s].start;else if(a&&e.startSN===t.endSN+1)n=t.fragmentEnd;else if(a&&i)n=t.fragmentStart+s*e.levelTargetDuration;else{if(e.skippedSegments||0!==e.fragmentStart)return;n=t.fragmentStart}e6(e,n)}function e6(t,e){if(e){let i=t.fragments;for(let s=t.skippedSegments;s<i.length;s++)i[s].addStart(e);t.fragmentHint&&t.fragmentHint.addStart(e)}}function e9(t,e=1/0){let i=1e3*t.targetduration;if(t.updated){let s=t.fragments;if(s.length&&4*i>e){let t=1e3*s[s.length-1].duration;t<i&&(i=t)}}else i/=2;return Math.round(i)}function e7(t,e,i){if(!t)return null;let s=t.fragments[e-t.startSN];return s||(s=t.fragmentHint)&&s.sn===e?s:e<t.startSN&&i&&i.sn===e?i:null}function it(t,e,i){return t?ie(t.partList,e,i):null}function ie(t,e,i){if(t)for(let s=t.length;s--;){let r=t[s];if(r.index===i&&r.fragment.sn===e)return r}return null}function ii(t){t.forEach((t,e)=>{var i;null==(i=t.details)||i.fragments.forEach(t=>{t.level=e,t.initSegment&&(t.initSegment.level=e)})})}function is(t,e){for(let s=0,r=t.length;s<r;s++){var i;if((null==(i=t[s])?void 0:i.cc)===e)return t[s]}return null}function ir(t,e){if(t){let i=t.start+e;t.start=t.startPTS=i,t.endPTS=i+t.duration}}function ia(t,e){let i=e.fragments;for(let e=0,s=i.length;e<s;e++)ir(i[e],t);e.fragmentHint&&ir(e.fragmentHint,t),e.alignedSliding=!0}function il(t,e){if((!e||!(t.startCC<e.endCC)||!(t.endCC>e.startCC))&&1)return;let i=Math.min(e.endCC,t.endCC),s=is(e.fragments,i),r=is(t.fragments,i);s&&r&&(F.log(`Aligning playlist at start of dicontinuity sequence ${i}`),ia(s.start-r.start,t))}function io(t,e){let i,s;if(!t.hasProgramDateTime||!e.hasProgramDateTime)return;let r=t.fragments,a=e.fragments;if(!r.length||!a.length)return;let n=Math.min(e.endCC,t.endCC);e.startCC<n&&t.startCC<n&&(i=is(a,n),s=is(r,n)),i&&s||(s=is(r,(i=a[Math.floor(a.length/2)]).cc)||r[Math.floor(r.length/2)]);let l=i.programDateTime,o=s.programDateTime;l&&o&&ia((o-l)/1e3-(s.start-i.start),t)}const ih={toString:function(t){let e="",i=t.length;for(let s=0;s<i;s++)e+=`[${t.start(s).toFixed(3)}-${t.end(s).toFixed(3)}]`;return e}},id={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class iu extends ec{constructor(t,e,i,s,a){super(s,t.logger),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=id.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.loadingParts=!1,this.loopSn=void 0,this.onMediaSeeking=()=>{let{config:t,fragCurrent:e,media:i,mediaBuffer:s,state:a}=this,n=i?i.currentTime:0,l=em.bufferInfo(s||i,n,t.maxBufferHole);if(this.log(`media seeking to ${r(n)?n.toFixed(3):n}, state: ${a}`),this.state===id.ENDED)this.resetLoadingState();else if(e){let i=t.maxFragLookUpTolerance,s=e.start-i,r=e.start+e.duration+i;if(!l.len||r<l.start||s>l.end){let t=n>r;(n<s||t)&&(t&&e.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),e.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}if(i&&(this.fragmentTracker.removeFragmentsInRange(n,1/0,this.playlistType,!0),n>this.lastCurrentTime&&(this.lastCurrentTime=n),!this.loadingParts)){let t=Math.max(l.end,n),e=this.shouldLoadParts(this.getLevelDetails(),t);e&&(this.log(`LL-Part loading ON after seeking to ${n.toFixed(2)} with buffer @${t.toFixed(2)}`),this.loadingParts=e)}this.hls.hasEnoughToStart||l.len||(this.log(`setting startPosition to ${n} because of seek before start`),this.nextLoadPosition=this.startPosition=n),this.tickImmediate()},this.onMediaEnded=()=>{this.log("setting startPosition to 0 because media ended"),this.startPosition=this.lastCurrentTime=0},this.playlistType=a,this.hls=t,this.fragmentLoader=new eo(t.config),this.keyLoader=i,this.fragmentTracker=e,this.config=t.config,this.decrypter=new el(t.config)}registerListeners(){let{hls:t}=this;t.on(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(h.ERROR,this.onError,this)}unregisterListeners(){let{hls:t}=this;t.off(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(h.ERROR,this.onError,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(t){}stopLoad(){if(this.state===id.STOPPED)return;this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);let t=this.fragCurrent;null!=t&&t.loader&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=id.STOPPED}get startPositionValue(){let{nextLoadPosition:t,startPosition:e}=this;return -1===e&&t?t:e}get bufferingEnabled(){return this.buffering}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}get inFlightFrag(){return{frag:this.fragCurrent,state:this.state}}_streamEnded(t,e){if(e.live||!this.media)return!1;let i=t.end||0,s=this.config.timelineOffset||0;if(i<=s)return!1;let r=t.buffered;this.config.maxBufferHole&&r&&r.length>1&&(t=em.bufferedInfo(r,t.start,0));let a=t.nextStart;if(a&&a>s&&a<e.edge||this.media.currentTime<t.start)return!1;let n=e.partList;if(null!=n&&n.length){let t=n[n.length-1];return em.isBuffered(this.media,t.start+t.duration/2)}let l=e.fragments[e.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(l)}getLevelDetails(){if(this.levels&&null!==this.levelLastLoaded){var t;return null==(t=this.levelLastLoaded)?void 0:t.details}}get timelineOffset(){let t=this.config.timelineOffset;if(t){var e;return(null==(e=this.getLevelDetails())?void 0:e.appliedTimelineOffset)||t}return 0}onMediaAttached(t,e){let i=this.media=this.mediaBuffer=e.media;i.removeEventListener("seeking",this.onMediaSeeking),i.removeEventListener("ended",this.onMediaEnded),i.addEventListener("seeking",this.onMediaSeeking),i.addEventListener("ended",this.onMediaEnded);let s=this.config;this.levels&&s.autoStartLoad&&this.state===id.STOPPED&&this.startLoad(s.startPosition)}onMediaDetaching(t,e){let i=!!e.transferMedia,s=this.media;if(null!==s){if(s.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),s.removeEventListener("seeking",this.onMediaSeeking),s.removeEventListener("ended",this.onMediaEnded),this.keyLoader&&!i&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,i){this.resetLoadingState(),this.resetTransmuxer();return}this.loadingParts=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}}onManifestLoading(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=!1}onError(t,e){}onManifestLoaded(t,e){this.startTimeOffset=e.startTimeOffset}onHandlerDestroying(){this.stopLoad(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),super.onHandlerDestroying(),this.hls=this.onMediaSeeking=this.onMediaEnded=null}onHandlerDestroyed(){this.state=id.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(t,e,i){this.startFragRequested=!0,this._loadFragForPlayback(t,e,i)}_loadFragForPlayback(t,e,i){this._doFragLoad(t,e,i,t=>{let e=t.frag;if(this.fragContextChanged(e)){this.warn(`${e.type} sn: ${e.sn}${t.part?" part: "+t.part.index:""} of ${this.fragInfo(e,!1,t.part)}) was dropped during download.`),this.fragmentTracker.removeFragment(e);return}e.stats.chunkCount++,this._handleFragmentLoadProgress(t)}).then(t=>{if(!t)return;let e=this.state,i=t.frag;if(this.fragContextChanged(i)){e!==id.FRAG_LOADING&&(this.fragCurrent||e!==id.PARSING)||(this.fragmentTracker.removeFragment(i),this.state=id.IDLE);return}"payload"in t&&(this.log(`Loaded ${i.type} sn: ${i.sn} of ${this.playlistLabel()} ${i.level}`),this.hls.trigger(h.FRAG_LOADED,t)),this._handleFragmentLoadComplete(t)}).catch(e=>{this.state!==id.STOPPED&&this.state!==id.ERROR&&(this.warn(`Frag error: ${(null==e?void 0:e.message)||e}`),this.resetFragmentLoading(t))})}clearTrackerIfNeeded(t){var e;let{fragmentTracker:i}=this;if(i.getState(t)===t9.APPENDING){let e=t.type,s=this.getFwdBufferInfo(this.mediaBuffer,e),r=Math.max(t.duration,s?s.len:this.config.maxBufferLength),a=this.backtrackFragment;(1==(a?t.sn-a.sn:0)||this.reduceMaxBufferLength(r,t.duration))&&i.removeFragment(t)}else(null==(e=this.mediaBuffer)?void 0:e.buffered.length)===0?i.removeAllFragments():i.hasParts(t.type)&&(i.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type}),i.getState(t)===t9.PARTIAL&&i.removeFragment(t))}checkLiveUpdate(t){if(t.updated&&!t.live){let e=t.fragments[t.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type})}t.fragments[0]||(t.deltaUpdateFailed=!0)}waitForLive(t){let e=t.details;return(null==e?void 0:e.live)&&"EVENT"!==e.type&&(this.levelLastLoaded!==t||e.expired)}flushMainBuffer(t,e,i=null){t-e&&this.hls.trigger(h.BUFFER_FLUSHING,{startOffset:t,endOffset:e,type:i})}_loadInitSegment(t,e){this._doFragLoad(t,e).then(t=>{let e=null==t?void 0:t.frag;if(!e||this.fragContextChanged(e)||!this.levels)throw Error("init load aborted");return t}).then(t=>{let{hls:e}=this,{frag:i,payload:s}=t,r=i.decryptdata;if(s&&s.byteLength>0&&null!=r&&r.key&&r.iv&&ex(r.method)){let a=self.performance.now();return this.decrypter.decrypt(new Uint8Array(s),r.key.buffer,r.iv.buffer,eL(r.method)).catch(t=>{throw e.trigger(h.ERROR,{type:l.MEDIA_ERROR,details:o.FRAG_DECRYPT_ERROR,fatal:!1,error:t,reason:t.message,frag:i}),t}).then(s=>{let r=self.performance.now();return e.trigger(h.FRAG_DECRYPTED,{frag:i,payload:s,stats:{tstart:a,tdecrypt:r}}),t.payload=s,this.completeInitSegmentLoad(t)})}return this.completeInitSegmentLoad(t)}).catch(e=>{this.state!==id.STOPPED&&this.state!==id.ERROR&&(this.warn(e),this.resetFragmentLoading(t))})}completeInitSegmentLoad(t){let{levels:e}=this;if(!e)throw Error("init load aborted, missing levels");let i=t.frag.stats;this.state!==id.STOPPED&&(this.state=id.IDLE),t.frag.data=new Uint8Array(t.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}fragContextChanged(t){let{fragCurrent:e}=this;return!t||!e||t.sn!==e.sn||t.level!==e.level}fragBufferedComplete(t,e){let i=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${t.type} sn: ${t.sn}${e?" part: "+e.index:""} of ${this.fragInfo(t,!1,e)} > buffer:${i?ih.toString(em.getBuffered(i)):"(detached)"})`),Y(t)){var s;if(t.type!==x.SUBTITLE){let e=t.elementaryStreams;if(!Object.keys(e).some(t=>!!e[t])){this.state=id.IDLE;return}}let e=null==(s=this.levels)?void 0:s[t.level];null!=e&&e.fragmentError&&(this.log(`Resetting level fragment error count of ${e.fragmentError} on frag buffered`),e.fragmentError=0)}this.state=id.IDLE}_handleFragmentLoadComplete(t){let{transmuxer:e}=this;if(!e)return;let{frag:i,part:s,partsLoaded:r}=t,a=!r||0===r.length||r.some(t=>!t),n=new ef(i.level,i.sn,i.stats.chunkCount+1,0,s?s.index:-1,!a);e.flush(n)}_handleFragmentLoadProgress(t){}_doFragLoad(t,e,i=null,s){var a;let n;this.fragCurrent=t;let l=null==e?void 0:e.details;if(!this.levels||!l)throw Error(`frag load aborted, missing level${l?"":" detail"}s`);let o=null;t.encrypted&&!(null!=(a=t.decryptdata)&&a.key)?(this.log(`Loading key for ${t.sn} of [${l.startSN}-${l.endSN}], ${this.playlistLabel()} ${t.level}`),this.state=id.KEY_LOADING,this.fragCurrent=t,o=this.keyLoader.load(t).then(t=>{if(!this.fragContextChanged(t.frag))return this.hls.trigger(h.KEY_LOADED,t),this.state===id.KEY_LOADING&&(this.state=id.IDLE),t}),this.hls.trigger(h.KEY_LOADING,{frag:t}),null===this.fragCurrent&&(o=Promise.reject(Error("frag load aborted, context changed in KEY_LOADING")))):!t.encrypted&&(o=this.keyLoader.loadClear(t,l.encryptedFragments))&&this.log("[eme] blocking frag load until media-keys acquired");let d=this.fragPrevious;if(Y(t)&&(!d||t.sn!==d.sn)){let i=this.shouldLoadParts(e.details,t.end);i!==this.loadingParts&&(this.log(`LL-Part loading ${i?"ON":"OFF"} loading sn ${null==d?void 0:d.sn}->${t.sn}`),this.loadingParts=i)}if(i=Math.max(t.start,i||0),this.loadingParts&&Y(t)){let r=l.partList;if(r&&s){i>t.end&&l.fragmentHint&&(t=l.fragmentHint);let a=this.getNextPart(r,t,i);if(a>-1){let n,d=r[a];return(t=this.fragCurrent=d.fragment,this.log(`Loading ${t.type} sn: ${t.sn} part: ${d.index} (${a}/${r.length-1}) of ${this.fragInfo(t,!1,d)}) cc: ${t.cc} [${l.startSN}-${l.endSN}], target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=d.start+d.duration,this.state=id.FRAG_LOADING,n=o?o.then(i=>!i||this.fragContextChanged(i.frag)?null:this.doFragPartsLoad(t,d,e,s)).catch(t=>this.handleFragLoadError(t)):this.doFragPartsLoad(t,d,e,s).catch(t=>this.handleFragLoadError(t)),this.hls.trigger(h.FRAG_LOADING,{frag:t,part:d,targetBufferTime:i}),null===this.fragCurrent)?Promise.reject(Error("frag load aborted, context changed in FRAG_LOADING parts")):n}if(!t.url||this.loadedEndOfParts(r,i))return Promise.resolve(null)}}if(Y(t)&&this.loadingParts)this.log(`LL-Part loading OFF after next part miss @${i.toFixed(2)}`),this.loadingParts=!1;else if(!t.url)return Promise.resolve(null);this.log(`Loading ${t.type} sn: ${t.sn} of ${this.fragInfo(t,!1)}) cc: ${t.cc} ${l?"["+l.startSN+"-"+l.endSN+"]":""}, target: ${parseFloat(i.toFixed(3))}`),r(t.sn)&&!this.bitrateTest&&(this.nextLoadPosition=t.start+t.duration),this.state=id.FRAG_LOADING;let u=this.config.progressive;return(n=u&&o?o.then(e=>!e||this.fragContextChanged(null==e?void 0:e.frag)?null:this.fragmentLoader.load(t,s)).catch(t=>this.handleFragLoadError(t)):Promise.all([this.fragmentLoader.load(t,u?s:void 0),o]).then(([t])=>(!u&&t&&s&&s(t),t)).catch(t=>this.handleFragLoadError(t)),this.hls.trigger(h.FRAG_LOADING,{frag:t,targetBufferTime:i}),null===this.fragCurrent)?Promise.reject(Error("frag load aborted, context changed in FRAG_LOADING")):n}doFragPartsLoad(t,e,i,s){return new Promise((r,a)=>{var n;let l=[],o=null==(n=i.details)?void 0:n.partList,d=e=>{this.fragmentLoader.loadPart(t,e,s).then(s=>{l[e.index]=s;let a=s.part;this.hls.trigger(h.FRAG_LOADED,s);let n=it(i.details,t.sn,e.index+1)||ie(o,t.sn,e.index+1);if(!n)return r({frag:t,part:a,partsLoaded:l});d(n)}).catch(a)};d(e)})}handleFragLoadError(t){if("data"in t){let e=t.data;t.data&&e.details===o.INTERNAL_ABORTED?this.handleFragLoadAborted(e.frag,e.part):this.hls.trigger(h.ERROR,e)}else this.hls.trigger(h.ERROR,{type:l.OTHER_ERROR,details:o.INTERNAL_EXCEPTION,err:t,error:t,fatal:!0});return null}_handleTransmuxerFlush(t){let e=this.getCurrentContext(t);if(!e||this.state!==id.PARSING){this.fragCurrent||this.state===id.STOPPED||this.state===id.ERROR||(this.state=id.IDLE);return}let{frag:i,part:s,level:r}=e,a=self.performance.now();i.stats.parsing.end=a,s&&(s.stats.parsing.end=a);let n=this.getLevelDetails(),l=n&&i.sn>n.endSN||this.shouldLoadParts(n,i.end);l!==this.loadingParts&&(this.log(`LL-Part loading ${l?"ON":"OFF"} after parsing segment ending @${i.end.toFixed(2)}`),this.loadingParts=l),this.updateLevelTiming(i,s,r,t.partial)}shouldLoadParts(t,e){if(this.config.lowLatencyMode){if(!t)return this.loadingParts;if(null!=t&&t.partList){var i,s;let r=t.partList[0];if(e>=r.end+((null==(i=t.fragmentHint)?void 0:i.duration)||0)&&(this.hls.hasEnoughToStart?(null==(s=this.media)?void 0:s.currentTime)||this.lastCurrentTime:this.getLoadPosition())>r.start-r.fragment.duration)return!0}}return!1}getCurrentContext(t){let{levels:e,fragCurrent:i}=this,{level:s,sn:r,part:a}=t;if(!(null!=e&&e[s]))return this.warn(`Levels object was unset while buffering fragment ${r} of ${this.playlistLabel()} ${s}. The current chunk will not be buffered.`),null;let n=e[s],l=n.details,o=a>-1?it(l,r,a):null,h=o?o.fragment:e7(l,r,i);return h?(i&&i!==h&&(h.stats=i.stats),{frag:h,part:o,level:n}):null}bufferFragmentData(t,e,i,s,r){var a;if(!t||this.state!==id.PARSING)return;let{data1:n,data2:l}=t,o=n;if(n&&l&&(o=td(n,l)),!(null!=(a=o)&&a.length))return;let d={type:t.type,frag:e,part:i,chunkMeta:s,parent:e.type,data:o};if(this.hls.trigger(h.BUFFER_APPENDING,d),t.dropped&&t.independent&&!i){if(r)return;this.flushBufferGap(e)}}flushBufferGap(t){let e=this.media;if(!e)return;if(!em.isBuffered(e,e.currentTime))return void this.flushMainBuffer(0,t.start);let i=e.currentTime,s=em.bufferInfo(e,i,0),r=t.duration,a=Math.min(2*this.config.maxFragLookUpTolerance,.25*r),n=Math.max(Math.min(t.start-a,s.end-a),i+a);t.start-n>a&&this.flushMainBuffer(n,t.start)}getFwdBufferInfo(t,e){var i;let s=this.getLoadPosition();if(!r(s))return null;let a=this.lastCurrentTime>s||null!=(i=this.media)&&i.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(t,s,e,a)}getFwdBufferInfoAtPos(t,e,i,s){let r=em.bufferInfo(t,e,s);if(0===r.len&&void 0!==r.nextStart){let a=this.fragmentTracker.getBufferedFrag(e,i);if(a&&(r.nextStart<=a.end||a.gap)){let i=Math.max(Math.min(r.nextStart,a.end)-e,s);return em.bufferInfo(t,e,i)}}return r}getMaxBufferLength(t){let e,{config:i}=this;return Math.min(t?Math.max(8*i.maxBufferSize/t,i.maxBufferLength):i.maxBufferLength,i.maxMaxBufferLength)}reduceMaxBufferLength(t,e){let i=this.config,s=Math.max(Math.min(t-e,i.maxBufferLength),e),r=Math.max(t-3*e,i.maxMaxBufferLength/2,s);return r>=s&&(i.maxMaxBufferLength=r,this.warn(`Reduce max buffer length to ${r}s`),!0)}getAppendedFrag(t,e=x.MAIN){var i;let s=null==(i=this.fragmentTracker)?void 0:i.getAppendedFrag(t,e);return s&&"fragment"in s?s.fragment:s}getNextFragment(t,e){let i=e.fragments,s=i.length;if(!s)return null;let{config:r}=this,a=i[0].start,n=r.lowLatencyMode&&!!e.partList,l=null;if(e.live){let i=r.initialLiveManifestSize;if(s<i)return this.warn(`Not enough fragments to start playback (have: ${s}, need: ${i})`),null;if(!e.PTSKnown&&!this.startFragRequested&&-1===this.startPosition||t<a){var o;n&&!this.loadingParts&&(this.log("LL-Part loading ON for initial live fragment"),this.loadingParts=!0),l=this.getInitialLiveFragment(e);let i=this.hls.startPosition,s=this.hls.liveSyncPosition,r=l?(-1!==i&&i>=a?i:s)||l.start:t;this.log(`Setting startPosition to ${r} to match start frag at live edge. mainStart: ${i} liveSyncPosition: ${s} frag.start: ${null==(o=l)?void 0:o.start}`),this.startPosition=this.nextLoadPosition=r}}else t<=a&&(l=i[0]);if(!l){let i=this.loadingParts?e.partEnd:e.fragmentEnd;l=this.getFragmentAtPosition(t,i,e)}let h=this.filterReplacedPrimary(l,e);if(!h&&l){let t=l.sn-e.startSN;h=this.filterReplacedPrimary(i[t+1]||null,e)}return this.mapToInitFragWhenRequired(h)}isLoopLoading(t,e){let i=this.fragmentTracker.getState(t);return(i===t9.OK||i===t9.PARTIAL&&!!t.gap)&&this.nextLoadPosition>e}getNextFragmentLoopLoading(t,e,i,s,r){let a=null;if(t.gap&&(a=this.getNextFragment(this.nextLoadPosition,e))&&!a.gap&&i.nextStart){let t=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,s,0);if(null!==t&&i.len+t.len>=r){let t=a.sn;return this.loopSn!==t&&(this.log(`buffer full after gaps in "${s}" playlist starting at sn: ${t}`),this.loopSn=t),null}}return this.loopSn=void 0,a}get primaryPrefetch(){if(ic(this.hls.config)){var t,e;if(null==(t=this.hls.interstitialsManager)||null==(e=t.playingItem)?void 0:e.event)return!0}return!1}filterReplacedPrimary(t,e){if(!t)return t;if(ic(this.hls.config)&&t.type!==x.SUBTITLE){let i=this.hls.interstitialsManager,s=null==i?void 0:i.bufferingItem;if(s){let i=s.event;if(i){if(i.appendInPlace||Math.abs(t.start-s.start)>1||0===s.start)return null}else if(t.end<=s.start&&(null==e?void 0:e.live)===!1||t.start>s.end&&s.nextEvent&&(s.nextEvent.appendInPlace||t.start-s.end>1))return null}let r=null==i?void 0:i.playerQueue;if(r)for(let e=r.length;e--;){let i=r[e].interstitial;if(i.appendInPlace&&t.start>=i.startTime&&t.end<=i.resumeTime)return null}}return t}mapToInitFragWhenRequired(t){return null==t||!t.initSegment||null!=t&&t.initSegment.data||this.bitrateTest?t:t.initSegment}getNextPart(t,e,i){let s=-1,r=!1,a=!0;for(let n=0,l=t.length;n<l;n++){let l=t[n];if(a=a&&!l.independent,s>-1&&i<l.start)break;let o=l.loaded;o?s=-1:(r||l.independent||a)&&l.fragment===e&&(s=n),r=o}return s}loadedEndOfParts(t,e){let i=t[t.length-1];return i&&e>i.start&&i.loaded}getInitialLiveFragment(t){let e=t.fragments,i=this.fragPrevious,s=null;if(i){if(t.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),s=function(t,e,i){if(null===e||!Array.isArray(t)||!t.length||!r(e)||e<(t[0].programDateTime||0)||e>=(t[t.length-1].endProgramDateTime||0))return null;for(let s=0;s<t.length;++s){let r=t[s];if(function(t,e,i){let s=1e3*Math.min(e,i.duration+(i.deltaPTS?i.deltaPTS:0));return(i.endProgramDateTime||0)-s>t}(e,i,r))return r}return null}(e,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!s){let r=i.sn+1;if(r>=t.startSN&&r<=t.endSN){let a=e[r-t.startSN];i.cc===a.cc&&(s=a,this.log(`Live playlist, switching playlist, load frag with next SN: ${s.sn}`))}!s&&(s=tJ(t,i.cc,i.end))&&this.log(`Live playlist, switching playlist, load frag with same CC: ${s.sn}`)}}else{let e=this.hls.liveSyncPosition;null!==e&&(s=this.getFragmentAtPosition(e,this.bitrateTest?t.fragmentEnd:t.edge,t))}return s}getFragmentAtPosition(t,e,i){let s,{config:r}=this,{fragPrevious:a}=this,{fragments:n,endSN:l}=i,{fragmentHint:o}=i,{maxFragLookUpTolerance:h}=r,d=i.partList,u=!!(this.loadingParts&&null!=d&&d.length&&o);if(u&&o&&!this.bitrateTest&&d[d.length-1].fragment.sn===o.sn&&(n=n.concat(o),l=o.sn),t<e){var c;let i=t<this.lastCurrentTime||t>e-h||null!=(c=this.media)&&c.paused||!this.startFragRequested?0:h;s=tQ(a,n,t,i)}else s=n[n.length-1];if(s){let t=s.sn-i.startSN,e=this.fragmentTracker.getState(s);if((e===t9.OK||e===t9.PARTIAL&&s.gap)&&(a=s),a&&s.sn===a.sn&&(!u||d[0].fragment.sn>s.sn||!i.live&&!u)&&a&&s.level===a.level){let e=n[t+1];s=s.sn<l&&this.fragmentTracker.getState(e)!==t9.OK?e:null}}return s}alignPlaylists(t,e,i){let s=t.fragments.length;if(!s)return this.warn("No fragments in live playlist"),0;let a=t.fragmentStart,n=!e,l=t.alignedSliding&&r(a);if(n||!l&&!a){i&&(il(t,i),!t.alignedSliding&&i&&io(t,i),t.alignedSliding||!i||t.skippedSegments||e8(i,t,!1));let r=t.fragmentStart;return this.log(`Live playlist sliding: ${r.toFixed(2)} start-sn: ${e?e.startSN:"na"}->${t.startSN} fragments: ${s}`),r}return a}waitForCdnTuneIn(t){return t.live&&t.canBlockReload&&t.partTarget&&t.tuneInGoal>Math.max(t.partHoldBack,3*t.partTarget)}setStartPosition(t,e){let i=this.startPosition;i<e&&(i=-1);let s=this.timelineOffset;if(-1===i){let a=null!==this.startTimeOffset,n=a?this.startTimeOffset:t.startTimeOffset;null!==n&&r(n)?(i=e+n,n<0&&(i+=t.edge),i=Math.min(Math.max(e,i),e+t.totalduration),this.log(`Setting startPosition to ${i} for start time offset ${n} found in ${a?"multivariant":"media"} playlist`),this.startPosition=i):t.live?(i=this.hls.liveSyncPosition||e,this.log(`Setting startPosition to -1 to start at live edge ${i}`),this.startPosition=-1):(this.log("setting startPosition to 0 by default"),this.startPosition=i=0),this.lastCurrentTime=i+s}this.nextLoadPosition=i+s}getLoadPosition(){var t;let{media:e}=this,i=0;return null!=(t=this.hls)&&t.hasEnoughToStart&&e?i=e.currentTime:this.nextLoadPosition>=0&&(i=this.nextLoadPosition),i}handleFragLoadAborted(t,e){this.transmuxer&&t.type===this.playlistType&&Y(t)&&t.stats.aborted&&(this.warn(`Fragment ${t.sn}${e?" part "+e.index:""} of ${this.playlistLabel()} ${t.level} was aborted`),this.resetFragmentLoading(t))}resetFragmentLoading(t){this.fragCurrent&&(this.fragContextChanged(t)||this.state===id.FRAG_LOADING_WAITING_RETRY)||(this.state=id.IDLE)}onFragmentOrKeyLoadError(t,e){if(e.chunkMeta&&!e.frag){let t=this.getCurrentContext(e.chunkMeta);t&&(e.frag=t.frag)}let i=e.frag;if(!i||i.type!==t||!this.levels)return;if(this.fragContextChanged(i)){var s;this.warn(`Frag load error must match current frag to retry ${i.url} > ${null==(s=this.fragCurrent)?void 0:s.url}`);return}let r=e.details===o.FRAG_GAP;r&&this.fragmentTracker.fragBuffered(i,!0);let a=e.errorAction,{action:n,flags:l,retryCount:h=0,retryConfig:d}=a||{},u=!!a&&!!d,c=u&&n===t4.RetryRequest,f=u&&!a.resolved&&l===t8.MoveAllAlternatesMatchingHost;if(!c&&f&&Y(i)&&!i.endList)this.resetFragmentErrors(t),this.treatAsGap(i),a.resolved=!0;else if((c||f)&&h<d.maxNumRetry){this.resetStartWhenNotLoaded(this.levelLastLoaded);let s=t2(d,h);this.warn(`Fragment ${i.sn} of ${t} ${i.level} errored with ${e.details}, retrying loading ${h+1}/${d.maxNumRetry} in ${s}ms`),a.resolved=!0,this.retryDate=self.performance.now()+s,this.state=id.FRAG_LOADING_WAITING_RETRY}else if(d&&a){if(this.resetFragmentErrors(t),!(h<d.maxNumRetry))return void this.warn(`${e.details} reached or exceeded max retry (${h})`);r||n===t4.RemoveAlternatePermanently||(a.resolved=!0)}else n===t4.SendAlternateToPenaltyBox?this.state=id.WAITING_LEVEL:this.state=id.ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(t){if(this.state===id.PARSING||this.state===id.PARSED){let e=t.frag,i=t.parent,s=this.getFwdBufferInfo(this.mediaBuffer,i),r=s&&s.len>.5;r&&this.reduceMaxBufferLength(s.len,(null==e?void 0:e.duration)||10);let a=!r;return a&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${i} buffer`),e&&(this.fragmentTracker.removeFragment(e),this.nextLoadPosition=e.start),this.resetLoadingState(),a}return!1}resetFragmentErrors(t){t===x.AUDIO&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.state!==id.STOPPED&&(this.state=id.IDLE)}afterBufferFlushed(t,e,i){if(!t)return;let s=em.getBuffered(t);this.fragmentTracker.detectEvictedFragments(e,s,i),this.state===id.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state!==id.STOPPED&&(this.state=id.IDLE)}resetStartWhenNotLoaded(t){if(!this.hls.hasEnoughToStart){this.startFragRequested=!1;let e=t?t.details:null;null!=e&&e.live?(this.log("resetting startPosition for live start"),this.startPosition=-1,this.setStartPosition(e,e.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(t){this.warn(`The loading context changed while buffering fragment ${t.sn} of ${this.playlistLabel()} ${t.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(t=0){this.fragmentTracker.removeFragmentsInRange(t,1/0,this.playlistType,!1,!0)}updateLevelTiming(t,e,i,s){let r=i.details;if(!r)return void this.warn("level.details undefined");if(!Object.keys(t.elementaryStreams).reduce((e,a)=>{let n=t.elementaryStreams[a];if(n){let l=n.endPTS-n.startPTS;if(l<=0)return this.warn(`Could not parse fragment ${t.sn} ${a} duration reliably (${l})`),e||!1;let o=s?0:e3(r,t,n.startPTS,n.endPTS,n.startDTS,n.endDTS);return this.hls.trigger(h.LEVEL_PTS_UPDATED,{details:r,level:i,drift:o,type:a,frag:t,start:n.startPTS,end:n.endPTS}),!0}return e},!1)){var a;if(0===i.fragmentError&&this.treatAsGap(t,i),(null==(a=this.transmuxer)?void 0:a.error)===null){let e=Error(`Found no media in fragment ${t.sn} of ${this.playlistLabel()} ${t.level} resetting transmuxer to fallback to playlist timing`);if(this.warn(e.message),this.hls.trigger(h.ERROR,{type:l.MEDIA_ERROR,details:o.FRAG_PARSING_ERROR,fatal:!1,error:e,frag:t,reason:`Found no media in msn ${t.sn} of ${this.playlistLabel()} "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}}this.state=id.PARSED,this.log(`Parsed ${t.type} sn: ${t.sn}${e?" part: "+e.index:""} of ${this.fragInfo(t,!1,e)})`),this.hls.trigger(h.FRAG_PARSED,{frag:t,part:e})}playlistLabel(){return this.playlistType===x.MAIN?"level":"track"}fragInfo(t,e=!0,i){var s,r;return`${this.playlistLabel()} ${t.level} (${i?"part":"frag"}:[${(null!=(s=e&&!i?t.startPTS:(i||t).start)?s:NaN).toFixed(3)}-${(null!=(r=e&&!i?t.endPTS:(i||t).end)?r:NaN).toFixed(3)}]${i&&"main"===t.type?"INDEPENDENT="+(i.independent?"YES":"NO"):""}`}treatAsGap(t,e){e&&e.fragmentError++,t.gap=!0,this.fragmentTracker.removeFragment(t),this.fragmentTracker.fragBuffered(t,!0)}resetTransmuxer(){var t;null==(t=this.transmuxer)||t.reset()}recoverWorkerError(t){"demuxerWorker"===t.event&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(t){let e=this._state;e!==t&&(this._state=t,this.log(`${e}->${t}`))}get state(){return this._state}}function ic(t){return!!t.interstitialsController&&!1!==t.enableInterstitialPlayback}class ig{constructor(){this.chunks=[],this.dataLength=0}push(t){this.chunks.push(t),this.dataLength+=t.length}flush(){let t,{chunks:e,dataLength:i}=this;return e.length?(t=1===e.length?e[0]:function(t,e){let i=new Uint8Array(e),s=0;for(let e=0;e<t.length;e++){let r=t[e];i.set(r,s),s+=r.length}return i}(e,i),this.reset(),t):new Uint8Array(0)}reset(){this.chunks.length=0,this.dataLength=0}}var ip={exports:{}},im=(A||(A=1,!function(t){var e=Object.prototype.hasOwnProperty,i="~";function s(){}function r(t,e,i){this.fn=t,this.context=e,this.once=i||!1}function a(t,e,s,a,n){if("function"!=typeof s)throw TypeError("The listener must be a function");var l=new r(s,a||t,n),o=i?i+e:e;return t._events[o]?t._events[o].fn?t._events[o]=[t._events[o],l]:t._events[o].push(l):(t._events[o]=l,t._eventsCount++),t}function n(t,e){0==--t._eventsCount?t._events=new s:delete t._events[e]}function l(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),new s().__proto__||(i=!1)),l.prototype.eventNames=function(){var t,s,r=[];if(0===this._eventsCount)return r;for(s in t=this._events)e.call(t,s)&&r.push(i?s.slice(1):s);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(t)):r},l.prototype.listeners=function(t){var e=i?i+t:t,s=this._events[e];if(!s)return[];if(s.fn)return[s.fn];for(var r=0,a=s.length,n=Array(a);r<a;r++)n[r]=s[r].fn;return n},l.prototype.listenerCount=function(t){var e=i?i+t:t,s=this._events[e];return s?s.fn?1:s.length:0},l.prototype.emit=function(t,e,s,r,a,n){var l=i?i+t:t;if(!this._events[l])return!1;var o,h,d=this._events[l],u=arguments.length;if(d.fn){switch(d.once&&this.removeListener(t,d.fn,void 0,!0),u){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,e),!0;case 3:return d.fn.call(d.context,e,s),!0;case 4:return d.fn.call(d.context,e,s,r),!0;case 5:return d.fn.call(d.context,e,s,r,a),!0;case 6:return d.fn.call(d.context,e,s,r,a,n),!0}for(h=1,o=Array(u-1);h<u;h++)o[h-1]=arguments[h];d.fn.apply(d.context,o)}else{var c,f=d.length;for(h=0;h<f;h++)switch(d[h].once&&this.removeListener(t,d[h].fn,void 0,!0),u){case 1:d[h].fn.call(d[h].context);break;case 2:d[h].fn.call(d[h].context,e);break;case 3:d[h].fn.call(d[h].context,e,s);break;case 4:d[h].fn.call(d[h].context,e,s,r);break;default:if(!o)for(c=1,o=Array(u-1);c<u;c++)o[c-1]=arguments[c];d[h].fn.apply(d[h].context,o)}}return!0},l.prototype.on=function(t,e,i){return a(this,t,e,i,!1)},l.prototype.once=function(t,e,i){return a(this,t,e,i,!0)},l.prototype.removeListener=function(t,e,s,r){var a=i?i+t:t;if(!this._events[a])return this;if(!e)return n(this,a),this;var l=this._events[a];if(l.fn)l.fn!==e||r&&!l.once||s&&l.context!==s||n(this,a);else{for(var o=0,h=[],d=l.length;o<d;o++)(l[o].fn!==e||r&&!l[o].once||s&&l[o].context!==s)&&h.push(l[o]);h.length?this._events[a]=1===h.length?h[0]:h:n(this,a)}return this},l.prototype.removeAllListeners=function(t){var e;return t?(e=i?i+t:t,this._events[e]&&n(this,e)):(this._events=new s,this._eventsCount=0),this},l.prototype.off=l.prototype.removeListener,l.prototype.addListener=l.prototype.on,l.prefixed=i,l.EventEmitter=l,t.exports=l}(ip)),(m=ip.exports)&&m.__esModule&&Object.prototype.hasOwnProperty.call(m,"default"))?m.default:m;const iy="1.6.5",iv={};function iE(t,e){return e+10<=t.length&&51===t[e]&&68===t[e+1]&&73===t[e+2]&&t[e+3]<255&&t[e+4]<255&&t[e+6]<128&&t[e+7]<128&&t[e+8]<128&&t[e+9]<128||!1}function iT(t,e){return e+10<=t.length&&73===t[e]&&68===t[e+1]&&51===t[e+2]&&t[e+3]<255&&t[e+4]<255&&t[e+6]<128&&t[e+7]<128&&t[e+8]<128&&t[e+9]<128||!1}function ib(t,e){let i=0;return(127&t[e])<<21|(127&t[e+1])<<14|(127&t[e+2])<<7|127&t[e+3]}function iS(t,e){let i=e,s=0;for(;iT(t,e);)s+=10,s+=ib(t,e+6),iE(t,e+10)&&(s+=10),e+=s;if(s>0)return t.subarray(i,i+s)}function iA(t,e){return 255===t[e]&&(246&t[e+1])==240}function i_(t,e){return 1&t[e+1]?7:9}function ix(t,e){return(3&t[e+3])<<11|t[e+4]<<3|(224&t[e+5])>>>5}function iL(t,e){return e+1<t.length&&iA(t,e)}function iI(t,e,i,s,r){if(!t.samplerate){let a=function(t,e,i,s){let r=e[i+2],a=r>>2&15;if(a>12){let e=Error(`invalid ADTS sampling index:${a}`);t.emit(h.ERROR,h.ERROR,{type:l.MEDIA_ERROR,details:o.FRAG_PARSING_ERROR,fatal:!0,error:e,reason:e.message});return}let n=(r>>6&3)+1,d=e[i+3]>>6&3|(1&r)<<2,u="mp4a.40."+n,c=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][a],f=a;(5===n||29===n)&&(f-=3);let g=[n<<3|(14&f)>>1,(1&f)<<7|d<<3];return F.log(`manifest codec:${s}, parsed codec:${u}, channels:${d}, rate:${c} (ADTS object type:${n} sampling index:${a})`),{config:g,samplerate:c,channelCount:d,codec:u,parsedCodec:u,manifestCodec:s}}(e,i,s,r);a&&R(t,a)}}function iR(t,e,i,s,r){let a,n=s+r*(9216e4/t.samplerate),l=function(t,e){let i=i_(t,e);if(e+i<=t.length){let s=ix(t,e)-i;if(s>0)return{headerLength:i,frameLength:s}}}(e,i);if(l){let{frameLength:s,headerLength:r}=l,o=r+s,h=Math.max(0,i+o-e.length);h?(a=new Uint8Array(o-r)).set(e.subarray(i+r,e.length),0):a=e.subarray(i+r,i+o);let d={unit:a,pts:n};return h||t.samples.push(d),{sample:d,length:o,missing:h}}let o=e.length-i;return(a=new Uint8Array(o)).set(e.subarray(i,e.length),0),{sample:{unit:a,pts:n},length:o,missing:-1}}function iD(t,e=0,i=1/0){return function(t,e,i,s){var r,a;let n=(r=t)instanceof ArrayBuffer?r:r.buffer,l=1;"BYTES_PER_ELEMENT"in s&&(l=s.BYTES_PER_ELEMENT);let o=(a=t)&&a.buffer instanceof ArrayBuffer&&void 0!==a.byteLength&&void 0!==a.byteOffset?t.byteOffset:0,h=(o+t.byteLength)/l,d=Math.floor(Math.max(0,Math.min((o+e)/l,h))),u=Math.floor(Math.min(d+Math.max(i,0),h));return new s(n,d,u-d)}(t,e,i,Uint8Array)}function ik(t){let e=0,i=[];for(;iT(t,e);){let s=ib(t,e+6);t[e+5]>>6&1&&(e+=10);let r=(e+=10)+s;for(;e+10<r;){let s=function(t){let e=String.fromCharCode(t[0],t[1],t[2],t[3]),i=ib(t,4);return{type:e,size:i,data:t.subarray(10,10+i)}}(t.subarray(e)),r=function(t){if("PRIV"===t.type){if(t.size<2)return;let e=U(t.data,!0),i=new Uint8Array(t.data.subarray(e.length+1));return{key:t.type,info:e,data:i.buffer}}if("W"===t.type[0]){if("WXXX"===t.type){if(t.size<2)return;let e=1,i=U(t.data.subarray(e),!0);e+=i.length+1;let s=U(t.data.subarray(e));return{key:t.type,info:i,data:s}}let e=U(t.data);return{key:t.type,info:"",data:e}}if("APIC"===t.type)return function(t){let e,i={key:t.type,description:"",data:"",mimeType:null,pictureType:null};if(t.size<2)return;if(3!==t.data[0])return void console.log("Ignore frame with unrecognized character encoding");let s=t.data.subarray(1).indexOf(0);if(-1===s)return;let r=U(iD(t.data,1,s)),a=t.data[2+s],n=t.data.subarray(3+s).indexOf(0);if(-1===n)return;let l=U(iD(t.data,3+s,n));if("--\x3e"===r)e=U(iD(t.data,4+s+n));else{var o;e=(o=t.data.subarray(4+s+n))instanceof ArrayBuffer?o:0==o.byteOffset&&o.byteLength==o.buffer.byteLength?o.buffer:new Uint8Array(o).buffer}return i.mimeType=r,i.pictureType=a,i.description=l,i.data=e,i}(t);if(t.size<2)return;if("TXXX"===t.type){let e=1,i=U(t.data.subarray(e),!0);e+=i.length+1;let s=U(t.data.subarray(e));return{key:t.type,info:i,data:s}}let e=U(t.data.subarray(1));return{key:t.type,info:"",data:e}}(s);r&&i.push(r),e+=s.size+10}iE(t,e)&&(e+=10)}return i}function iP(t){return t&&"PRIV"===t.key&&"com.apple.streaming.transportStreamTimestamp"===t.info}function iC(t){let e=ik(t);for(let t=0;t<e.length;t++){let i=e[t];if(iP(i)){if(8===i.data.byteLength){let t=new Uint8Array(i.data),e=1&t[3],s=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return s/=45,e&&(s+=47721858.84),Math.round(s)}return}}}let iM=((y={}).audioId3="org.id3",y.dateRange="com.apple.quicktime.HLS",y.emsg="https://aomedia.org/emsg/ID3",y.misbklv="urn:misb:KLV:bin:1910.1",y);function iw(t="",e=9e4){return{type:t,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}class iO{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(t,e,i,s){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(t){this.initPTS=t,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(t,e){return!1}appendFrame(t,e,i){}demux(t,e){let i;this.cachedData&&(t=td(this.cachedData,t),this.cachedData=null);let s=iS(t,0),a=s?s.length:0,n=this._audioTrack,l=this._id3Track,o=s?iC(s):void 0,h=t.length;for((null===this.basePTS||0===this.frameIndex&&r(o))&&(this.basePTS=iF(o,e,this.initPTS),this.lastPTS=this.basePTS),null===this.lastPTS&&(this.lastPTS=this.basePTS),s&&s.length>0&&l.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:s,type:iM.audioId3,duration:Number.POSITIVE_INFINITY});a<h;){if(this.canParse(t,a)){let e=this.appendFrame(n,t,a);e?(this.frameIndex++,this.lastPTS=e.sample.pts,a+=e.length,i=a):a=h}else{var d,u;iT(d=t,u=a)&&ib(d,u+6)+10<=d.length-u?(s=iS(t,a),l.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:s,type:iM.audioId3,duration:Number.POSITIVE_INFINITY}),a+=s.length,i=a):a++}if(a===h&&i!==h){let e=t.slice(i);this.cachedData?this.cachedData=td(this.cachedData,e):this.cachedData=e}}return{audioTrack:n,videoTrack:iw(),id3Track:l,textTrack:iw()}}demuxSampleAes(t,e,i){return Promise.reject(Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(t){let e=this.cachedData;return e&&(this.cachedData=null,this.demux(e,0)),{audioTrack:this._audioTrack,videoTrack:iw(),id3Track:this._id3Track,textTrack:iw()}}destroy(){this.cachedData=null,this._audioTrack=this._id3Track=void 0}}const iF=(t,e,i)=>r(t)?90*t:9e4*e+(i?9e4*i.baseTime/i.timescale:0);let iN=null;const iB=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],iU=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],i$=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],iG=[0,1,1,4];function iV(t,e,i,s,r){if(i+24>e.length)return;let a=iH(e,i);if(a&&i+a.frameLength<=e.length){let n=s+r*(9e4*a.samplesPerFrame/a.sampleRate),l={unit:e.subarray(i,i+a.frameLength),pts:n,dts:n};return t.config=[],t.channelCount=a.channelCount,t.samplerate=a.sampleRate,t.samples.push(l),{sample:l,length:a.frameLength,missing:0}}}function iH(t,e){let i=t[e+1]>>3&3,s=t[e+1]>>1&3,r=t[e+2]>>4&15,a=t[e+2]>>2&3;if(1!==i&&0!==r&&15!==r&&3!==a){let n=t[e+2]>>1&1,l=t[e+3]>>6,o=1e3*iB[14*(3===i?3-s:3===s?3:4)+r-1],h=iU[3*(3===i?0:2===i?1:2)+a],d=i$[i][s],u=iG[s],c=Math.floor(d*o/h+n)*u;if(null===iN){let t=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);iN=t?parseInt(t[1]):0}return iN&&iN<=87&&2===s&&o>=224e3&&0===l&&(t[e+3]=128|t[e+3]),{sampleRate:h,channelCount:3===l?1:2,frameLength:c,samplesPerFrame:8*d*u}}}function iK(t,e){return 255===t[e]&&(224&t[e+1])==224&&(6&t[e+1])!=0}function iW(t,e){return e+1<t.length&&iK(t,e)}function iY(t,e){if(e+1<t.length&&iK(t,e)){let i=iH(t,e),s=4;null!=i&&i.frameLength&&(s=i.frameLength);let r=e+s;return r===t.length||iW(t,r)}return!1}const ij=(t,e)=>{let i=0,s=5;e+=5;let r=new Uint32Array(1),a=new Uint32Array(1),n=new Uint8Array(1);for(;s>0;){n[0]=t[e];let l=Math.min(s,8),o=8-l;a[0]=0xff000000>>>24+o<<o,r[0]=(n[0]&a[0])>>o,i=i?i<<l|r[0]:r[0],e+=1,s-=l}return i};function iz(t,e,i,s,r){if(i+8>e.length||11!==e[i]||119!==e[i+1])return -1;let a=e[i+4]>>6;if(a>=3)return -1;let n=[48e3,44100,32e3][a],l=63&e[i+4],o=2*[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][3*l+a];if(i+o>e.length)return -1;let h=e[i+6]>>5,d=0;2===h?d+=2:(1&h&&1!==h&&(d+=2),4&h&&(d+=2));let u=(e[i+6]<<8|e[i+7])>>12-d&1,c=[2,1,2,3,3,4,4,5][h]+u,f=e[i+5]>>3,g=7&e[i+5],p=new Uint8Array([a<<6|f<<1|g>>2,(3&g)<<6|h<<3|u<<2|l>>4,l<<4&224]),m=e.subarray(i,i+o);return t.config=p,t.channelCount=c,t.samplerate=n,t.samples.push({unit:m,pts:s+1536/n*9e4*r}),o}const iq=/\/emsg[-/]ID3/i;function iX(t,e){return r(t.presentationTime)?t.presentationTime/t.timeScale:e+t.presentationTimeDelta/t.timeScale}class iQ{constructor(t,e,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new el(e,{removePKCS7Padding:!1})}decryptBuffer(t){return this.decrypter.decrypt(t,this.keyData.key.buffer,this.keyData.iv.buffer,es.cbc)}decryptAacSample(t,e,i){let s=t[e].unit;if(s.length<=16)return;let r=s.subarray(16,s.length-s.length%16),a=r.buffer.slice(r.byteOffset,r.byteOffset+r.length);this.decryptBuffer(a).then(r=>{let a=new Uint8Array(r);s.set(a,16),this.decrypter.isSync()||this.decryptAacSamples(t,e+1,i)})}decryptAacSamples(t,e,i){for(;;e++){if(e>=t.length)return void i();if(!(t[e].unit.length<32)&&(this.decryptAacSample(t,e,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(t){let e=new Int8Array(16*Math.floor((t.length-48)/160)+16),i=0;for(let s=32;s<t.length-16;s+=160,i+=16)e.set(t.subarray(s,s+16),i);return e}getAvcDecryptedUnit(t,e){let i=new Uint8Array(e),s=0;for(let e=32;e<t.length-16;e+=160,s+=16)t.set(i.subarray(s,s+16),e);return t}decryptAvcSample(t,e,i,s,r){let a=tg(r.data),n=this.getAvcEncryptedData(a);this.decryptBuffer(n.buffer).then(n=>{r.data=this.getAvcDecryptedUnit(a,n),this.decrypter.isSync()||this.decryptAvcSamples(t,e,i+1,s)})}decryptAvcSamples(t,e,i,s){if(t instanceof Uint8Array)throw Error("Cannot decrypt samples of type Uint8Array");for(;;e++,i=0){if(e>=t.length)return void s();let r=t[e].units;for(;!(i>=r.length);i++){let a=r[i];if(!(a.data.length<=48)&&(1===a.type||5===a.type)&&(this.decryptAvcSample(t,e,i,s,a),!this.decrypter.isSync()))return}}}}class iZ{constructor(){this.VideoSample=null}createVideoSample(t,e,i){return{key:t,frame:!1,pts:e,dts:i,units:[],length:0}}getLastNalUnit(t){var e;let i,s=this.VideoSample;if(s&&0!==s.units.length||(s=t[t.length-1]),null!=(e=s)&&e.units){let t=s.units;i=t[t.length-1]}return i}pushAccessUnit(t,e){if(t.units.length&&t.frame){if(void 0===t.pts){let i=e.samples,s=i.length;if(!s)return void e.dropped++;{let e=i[s-1];t.pts=e.pts,t.dts=e.dts}}e.samples.push(t)}}parseNALu(t,e,i){let s,r,a,n=e.byteLength,l=t.naluState||0,o=l,h=[],d=0,u=-1,c=0;for(-1===l&&(u=0,c=this.getNALuType(e,0),l=0,d=1);d<n;){if(s=e[d++],!l){l=+!s;continue}if(1===l){l=2*!s;continue}if(s)if(1===s){if(r=d-l-1,u>=0){let t={data:e.subarray(u,r),type:c};h.push(t)}else{let i=this.getLastNalUnit(t.samples);i&&(o&&d<=4-o&&i.state&&(i.data=i.data.subarray(0,i.data.byteLength-o)),r>0&&(i.data=td(i.data,e.subarray(0,r)),i.state=0))}d<n?(a=this.getNALuType(e,d),u=d,c=a,l=0):l=-1}else l=0;else l=3}if(u>=0&&l>=0){let t={data:e.subarray(u,n),type:c,state:l};h.push(t)}if(0===h.length){let i=this.getLastNalUnit(t.samples);i&&(i.data=td(i.data,e))}return t.naluState=l,h}}class iJ{constructor(t){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=t,this.bytesAvailable=t.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){let t=this.data,e=this.bytesAvailable,i=t.byteLength-e,s=new Uint8Array(4),r=Math.min(4,e);if(0===r)throw Error("no bytes available");s.set(t.subarray(i,i+r)),this.word=new DataView(s.buffer).getUint32(0),this.bitsAvailable=8*r,this.bytesAvailable-=r}skipBits(t){let e;t=Math.min(t,8*this.bytesAvailable+this.bitsAvailable),this.bitsAvailable>t||(t-=this.bitsAvailable,e=t>>3,t-=e<<3,this.bytesAvailable-=e,this.loadWord()),this.word<<=t,this.bitsAvailable-=t}readBits(t){let e=Math.min(this.bitsAvailable,t),i=this.word>>>32-e;if(t>32&&F.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=e,this.bitsAvailable>0)this.word<<=e;else if(this.bytesAvailable>0)this.loadWord();else throw Error("no bits available");return(e=t-e)>0&&this.bitsAvailable?i<<e|this.readBits(e):i}skipLZ(){let t;for(t=0;t<this.bitsAvailable;++t)if((this.word&0x80000000>>>t)!=0)return this.word<<=t,this.bitsAvailable-=t,t;return this.loadWord(),t+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){let t=this.skipLZ();return this.readBits(t+1)-1}readEG(){let t=this.readUEG();return 1&t?1+t>>>1:-1*(t>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}}class i0 extends iZ{parsePES(t,e,i,s){let r,a=this.parseNALu(t,i.data,s),n=this.VideoSample,l=!1;i.data=null,n&&a.length&&!t.audFound&&(this.pushAccessUnit(n,t),n=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),a.forEach(s=>{var a,o,h,d,u;switch(s.type){case 1:{let e=!1;r=!0;let a=s.data;if(l&&a.length>4){let t=this.readSliceType(a);(2===t||4===t||7===t||9===t)&&(e=!0)}e&&null!=(h=n)&&h.frame&&!n.key&&(this.pushAccessUnit(n,t),n=this.VideoSample=null),n||(n=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),n.frame=!0,n.key=e;break}case 5:r=!0,null!=(a=n)&&a.frame&&!n.key&&(this.pushAccessUnit(n,t),n=this.VideoSample=null),n||(n=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),n.key=!0,n.frame=!0;break;case 6:r=!0,tf(s.data,1,i.pts,e.samples);break;case 7:{r=!0,l=!0;let e=s.data,i=this.readSPS(e);if(!t.sps||t.width!==i.width||t.height!==i.height||(null==(d=t.pixelRatio)?void 0:d[0])!==i.pixelRatio[0]||(null==(u=t.pixelRatio)?void 0:u[1])!==i.pixelRatio[1]){t.width=i.width,t.height=i.height,t.pixelRatio=i.pixelRatio,t.sps=[e];let s=e.subarray(1,4),r="avc1.";for(let t=0;t<3;t++){let e=s[t].toString(16);e.length<2&&(e="0"+e),r+=e}t.codec=r}break}case 8:r=!0,t.pps=[s.data];break;case 9:r=!0,t.audFound=!0,null!=(o=n)&&o.frame&&(this.pushAccessUnit(n,t),n=null),n||(n=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;case 12:r=!0;break;default:r=!1}n&&r&&n.units.push(s)}),s&&n&&(this.pushAccessUnit(n,t),this.VideoSample=null)}getNALuType(t,e){return 31&t[e]}readSliceType(t){let e=new iJ(t);return e.readUByte(),e.readUEG(),e.readUEG()}skipScalingList(t,e){let i=8,s=8;for(let r=0;r<t;r++)0!==s&&(s=(i+e.readEG()+256)%256),i=0===s?i:s}readSPS(t){let e,i,s,r=new iJ(t),a=0,n=0,l=0,o=0,h=r.readUByte.bind(r),d=r.readBits.bind(r),u=r.readUEG.bind(r),c=r.readBoolean.bind(r),f=r.skipBits.bind(r),g=r.skipEG.bind(r),p=r.skipUEG.bind(r),m=this.skipScalingList.bind(this);h();let y=h();if(d(5),f(3),h(),p(),100===y||110===y||122===y||244===y||44===y||83===y||86===y||118===y||128===y){let t=u();if(3===t&&f(1),p(),p(),f(1),c())for(s=0,i=3!==t?8:12;s<i;s++)c()&&m(s<6?16:64,r)}p();let v=u();if(0===v)u();else if(1===v)for(f(1),g(),g(),e=u(),s=0;s<e;s++)g();p(),f(1);let E=u(),T=u(),b=d(1);0===b&&f(1),f(1),c()&&(a=u(),n=u(),l=u(),o=u());let S=[1,1];if(c()&&c())switch(h()){case 1:S=[1,1];break;case 2:S=[12,11];break;case 3:S=[10,11];break;case 4:S=[16,11];break;case 5:S=[40,33];break;case 6:S=[24,11];break;case 7:S=[20,11];break;case 8:S=[32,11];break;case 9:S=[80,33];break;case 10:S=[18,11];break;case 11:S=[15,11];break;case 12:S=[64,33];break;case 13:S=[160,99];break;case 14:S=[4,3];break;case 15:S=[3,2];break;case 16:S=[2,1];break;case 255:S=[h()<<8|h(),h()<<8|h()]}return{width:Math.ceil((E+1)*16-2*a-2*n),height:(2-b)*(T+1)*16-(b?2:4)*(l+o),pixelRatio:S}}}class i1 extends iZ{constructor(...t){super(...t),this.initVPS=null}parsePES(t,e,i,s){let r,a=this.parseNALu(t,i.data,s),n=this.VideoSample,l=!1;i.data=null,n&&a.length&&!t.audFound&&(this.pushAccessUnit(n,t),n=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),a.forEach(s=>{var a,o,h;switch(s.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:n||(n=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),n.frame=!0,r=!0;break;case 16:case 17:case 18:case 21:r=!0,l&&null!=(h=n)&&h.frame&&!n.key&&(this.pushAccessUnit(n,t),n=this.VideoSample=null),n||(n=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),n.key=!0,n.frame=!0;break;case 19:case 20:r=!0,null!=(a=n)&&a.frame&&!n.key&&(this.pushAccessUnit(n,t),n=this.VideoSample=null),n||(n=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),n.key=!0,n.frame=!0;break;case 39:r=!0,tf(s.data,2,i.pts,e.samples);break;case 32:r=!0,t.vps||("object"!=typeof t.params&&(t.params={}),t.params=R(t.params,this.readVPS(s.data)),this.initVPS=s.data),t.vps=[s.data];break;case 33:if(r=!0,l=!0,void 0===t.vps||t.vps[0]===this.initVPS||void 0===t.sps||this.matchSPS(t.sps[0],s.data)||(this.initVPS=t.vps[0],t.sps=t.pps=void 0),!t.sps){let e=this.readSPS(s.data);for(let i in t.width=e.width,t.height=e.height,t.pixelRatio=e.pixelRatio,t.codec=e.codecString,t.sps=[],"object"!=typeof t.params&&(t.params={}),e.params)t.params[i]=e.params[i]}this.pushParameterSet(t.sps,s.data,t.vps),n||(n=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),n.key=!0;break;case 34:if(r=!0,"object"==typeof t.params){if(!t.pps){t.pps=[];let e=this.readPPS(s.data);for(let i in e)t.params[i]=e[i]}this.pushParameterSet(t.pps,s.data,t.vps)}break;case 35:r=!0,t.audFound=!0,null!=(o=n)&&o.frame&&(this.pushAccessUnit(n,t),n=null),n||(n=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;default:r=!1}n&&r&&n.units.push(s)}),s&&n&&(this.pushAccessUnit(n,t),this.VideoSample=null)}pushParameterSet(t,e,i){(!i||i[0]!==this.initVPS)&&(i||t.length)||t.push(e)}getNALuType(t,e){return(126&t[e])>>>1}ebsp2rbsp(t){let e=new Uint8Array(t.byteLength),i=0;for(let s=0;s<t.byteLength;s++)(!(s>=2)||3!==t[s]||0!==t[s-1]||0!==t[s-2])&&(e[i]=t[s],i++);return new Uint8Array(e.buffer,0,i)}pushAccessUnit(t,e){super.pushAccessUnit(t,e),this.initVPS&&(this.initVPS=null)}readVPS(t){let e=new iJ(t);return e.readUByte(),e.readUByte(),e.readBits(4),e.skipBits(2),e.readBits(6),{numTemporalLayers:e.readBits(3)+1,temporalIdNested:e.readBoolean()}}readSPS(t){let e=new iJ(this.ebsp2rbsp(t));e.readUByte(),e.readUByte(),e.readBits(4);let i=e.readBits(3);e.readBoolean();let s=e.readBits(2),r=e.readBoolean(),a=e.readBits(5),n=e.readUByte(),l=e.readUByte(),o=e.readUByte(),h=e.readUByte(),d=e.readUByte(),u=e.readUByte(),c=e.readUByte(),f=e.readUByte(),g=e.readUByte(),p=e.readUByte(),m=e.readUByte(),y=[],v=[];for(let t=0;t<i;t++)y.push(e.readBoolean()),v.push(e.readBoolean());if(i>0)for(let t=i;t<8;t++)e.readBits(2);for(let t=0;t<i;t++)y[t]&&(e.readUByte(),e.readUByte(),e.readUByte(),e.readUByte(),e.readUByte(),e.readUByte(),e.readUByte(),e.readUByte(),e.readUByte(),e.readUByte(),e.readUByte()),v[t]&&e.readUByte();e.readUEG();let E=e.readUEG();3==E&&e.skipBits(1);let T=e.readUEG(),b=e.readUEG(),S=e.readBoolean(),A=0,_=0,x=0,L=0;S&&(A+=e.readUEG(),_+=e.readUEG(),x+=e.readUEG(),L+=e.readUEG());let I=e.readUEG(),R=e.readUEG(),D=e.readUEG(),k=e.readBoolean();for(let t=k?0:i;t<=i;t++)e.skipUEG(),e.skipUEG(),e.skipUEG();if(e.skipUEG(),e.skipUEG(),e.skipUEG(),e.skipUEG(),e.skipUEG(),e.skipUEG(),e.readBoolean()&&e.readBoolean())for(let t=0;t<4;t++)for(let i=0;i<(3===t?2:6);i++)if(e.readBoolean()){let i=Math.min(64,1<<4+(t<<1));t>1&&e.readEG();for(let t=0;t<i;t++)e.readEG()}else e.readUEG();e.readBoolean(),e.readBoolean(),e.readBoolean()&&(e.readUByte(),e.skipUEG(),e.skipUEG(),e.readBoolean());let P=e.readUEG(),C=0;for(let t=0;t<P;t++){let i=!1;if(0!==t&&(i=e.readBoolean()),i){t===P&&e.readUEG(),e.readBoolean(),e.readUEG();let i=0;for(let t=0;t<=C;t++){let t=e.readBoolean(),s=!1;t||(s=e.readBoolean()),(t||s)&&i++}C=i}else{let t=e.readUEG(),i=e.readUEG();C=t+i;for(let i=0;i<t;i++)e.readUEG(),e.readBoolean();for(let t=0;t<i;t++)e.readUEG(),e.readBoolean()}}if(e.readBoolean()){let t=e.readUEG();for(let i=0;i<t;i++){for(let t=0;t<D+4;t++)e.readBits(1);e.readBits(1)}}let M=0,w=1,O=1,F=!0,N=1,B=0;e.readBoolean(),e.readBoolean();let U=!1;if(e.readBoolean()){if(e.readBoolean()){let t=e.readUByte();t>0&&t<16?(w=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2][t-1],O=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1][t-1]):255===t&&(w=e.readBits(16),O=e.readBits(16))}if(e.readBoolean()&&e.readBoolean(),e.readBoolean()&&(e.readBits(3),e.readBoolean(),e.readBoolean()&&(e.readUByte(),e.readUByte(),e.readUByte())),e.readBoolean()&&(e.readUEG(),e.readUEG()),e.readBoolean(),e.readBoolean(),e.readBoolean(),(U=e.readBoolean())&&(A+=e.readUEG(),_+=e.readUEG(),x+=e.readUEG(),L+=e.readUEG()),e.readBoolean()&&(N=e.readBits(32),B=e.readBits(32),e.readBoolean()&&e.readUEG(),e.readBoolean())){let t=e.readBoolean(),s=e.readBoolean(),r=!1;(t||s)&&((r=e.readBoolean())&&(e.readUByte(),e.readBits(5),e.readBoolean(),e.readBits(5)),e.readBits(4),e.readBits(4),r&&e.readBits(4),e.readBits(5),e.readBits(5),e.readBits(5));for(let a=0;a<=i;a++){let i=(F=e.readBoolean())||e.readBoolean(),a=!1;i?e.readEG():a=e.readBoolean();let n=a?1:e.readUEG()+1;if(t)for(let t=0;t<n;t++)e.readUEG(),e.readUEG(),r&&(e.readUEG(),e.readUEG()),e.skipBits(1);if(s)for(let t=0;t<n;t++)e.readUEG(),e.readUEG(),r&&(e.readUEG(),e.readUEG()),e.skipBits(1)}}e.readBoolean()&&(e.readBoolean(),e.readBoolean(),e.readBoolean(),M=e.readUEG())}let $=T,G=b;if(S||U){let t=1,e=1;1===E?t=e=2:2==E&&(t=2),$=T-t*_-t*A,G=b-e*L-e*x}let V=s?["A","B","C"][s]:"",H=n<<24|l<<16|o<<8|h,K=0;for(let t=0;t<32;t++)K=(K|(H>>t&1)<<31-t)>>>0;let W=K.toString(16);return 1===a&&"2"===W&&(W="6"),{codecString:`hvc1.${V}${a}.${W}.${r?"H":"L"}${m}.B0`,params:{general_tier_flag:r,general_profile_idc:a,general_profile_space:s,general_profile_compatibility_flags:[n,l,o,h],general_constraint_indicator_flags:[d,u,c,f,g,p],general_level_idc:m,bit_depth:I+8,bit_depth_luma_minus8:I,bit_depth_chroma_minus8:R,min_spatial_segmentation_idc:M,chroma_format_idc:E,frame_rate:{fixed:F,fps:B/N}},width:$,height:G,pixelRatio:[w,O]}}readPPS(t){let e=new iJ(this.ebsp2rbsp(t));e.readUByte(),e.readUByte(),e.skipUEG(),e.skipUEG(),e.skipBits(2),e.skipBits(3),e.skipBits(2),e.skipUEG(),e.skipUEG(),e.skipEG(),e.skipBits(2),e.readBoolean()&&e.skipUEG(),e.skipEG(),e.skipEG(),e.skipBits(4);let i=e.readBoolean(),s=e.readBoolean(),r=1;return s&&i?r=0:s?r=3:i&&(r=2),{parallelismType:r}}matchSPS(t,e){return String.fromCharCode.apply(null,t).substr(3)===String.fromCharCode.apply(null,e).substr(3)}}class i2{constructor(t,e,i,s){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=t,this.config=e,this.typeSupported=i,this.logger=s,this.videoParser=null}static probe(t,e){let i=i2.syncOffset(t);return i>0&&e.warn(`MPEG2-TS detected but first sync word found @ offset ${i}`),-1!==i}static syncOffset(t){let e=t.length,i=Math.min(940,e-188)+1,s=0;for(;s<i;){let r=!1,a=-1,n=0;for(let l=s;l<e;l+=188)if(71===t[l]&&(e-l==188||71===t[l+188])){if(n++,-1===a&&0!==(a=l)&&(i=Math.min(a+18612,t.length-188)+1),r||(r=0===i5(t,l)),r&&n>1&&(0===a&&n>2||l+188>i))return a}else if(n)return -1;else break;s++}return -1}static createTrack(t,e){return{container:"video"===t||"audio"===t?"video/mp2t":void 0,type:t,id:X[t],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===t?e:void 0}}resetInitSegment(t,e,i,s){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=i2.createTrack("video"),this._videoTrack.duration=s,this._audioTrack=i2.createTrack("audio",s),this._id3Track=i2.createTrack("id3"),this._txtTrack=i2.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=e,this.videoCodec=i}resetTimeStamp(){}resetContiguity(){let{_audioTrack:t,_videoTrack:e,_id3Track:i}=this;t&&(t.pesData=null),e&&(e.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(t,e,i=!1,s=!1){let r;i||(this.sampleAes=null);let a=this._videoTrack,n=this._audioTrack,l=this._id3Track,o=this._txtTrack,h=a.pid,d=a.pesData,u=n.pid,c=l.pid,f=n.pesData,g=l.pesData,p=null,m=this.pmtParsed,y=this._pmtId,v=t.length;if(this.remainderData&&(v=(t=td(this.remainderData,t)).length,this.remainderData=null),v<188&&!s)return this.remainderData=t,{audioTrack:n,videoTrack:a,id3Track:l,textTrack:o};let E=Math.max(0,i2.syncOffset(t));(v-=(v-E)%188)<t.byteLength&&!s&&(this.remainderData=new Uint8Array(t.buffer,v,t.buffer.byteLength-v));let T=0;for(let e=E;e<v;e+=188)if(71===t[e]){let s,v=!!(64&t[e+1]),T=i5(t,e);if((48&t[e+3])>>4>1){if((s=e+5+t[e+4])===e+188)continue}else s=e+4;switch(T){case h:if(v){if(d&&(r=i8(d,this.logger))){if(null===this.videoParser)switch(a.segmentCodec){case"avc":this.videoParser=new i0;break;case"hevc":this.videoParser=new i1}null!==this.videoParser&&this.videoParser.parsePES(a,o,r,!1)}d={data:[],size:0}}d&&(d.data.push(t.subarray(s,e+188)),d.size+=e+188-s);break;case u:if(v){if(f&&(r=i8(f,this.logger)))switch(n.segmentCodec){case"aac":this.parseAACPES(n,r);break;case"mp3":this.parseMPEGPES(n,r);break;case"ac3":this.parseAC3PES(n,r)}f={data:[],size:0}}f&&(f.data.push(t.subarray(s,e+188)),f.size+=e+188-s);break;case c:v&&(g&&(r=i8(g,this.logger))&&this.parseID3PES(l,r),g={data:[],size:0}),g&&(g.data.push(t.subarray(s,e+188)),g.size+=e+188-s);break;case 0:var b,S;v&&(s+=t[s]+1),y=this._pmtId=(31&(b=t)[(S=s)+10])<<8|b[S+11];break;case y:{v&&(s+=t[s]+1);let r=function(t,e,i,s,r,a){let n={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},l=(15&t[e+1])<<8|t[e+2],o=e+3+l-4,h=(15&t[e+10])<<8|t[e+11];for(e+=12+h;e<o;){let l=i5(t,e),o=(15&t[e+3])<<8|t[e+4];switch(t[e]){case 207:if(!s){i4("ADTS AAC",a);break}case 15:-1===n.audioPid&&(n.audioPid=l);break;case 21:-1===n.id3Pid&&(n.id3Pid=l);break;case 219:if(!s){i4("H.264",a);break}case 27:-1===n.videoPid&&(n.videoPid=l);break;case 3:case 4:i.mpeg||i.mp3?-1===n.audioPid&&(n.audioPid=l,n.segmentAudioCodec="mp3"):a.log("MPEG audio found, not supported in this browser");break;case 193:if(!s){i4("AC-3",a);break}case 129:i.ac3?-1===n.audioPid&&(n.audioPid=l,n.segmentAudioCodec="ac3"):a.log("AC-3 audio found, not supported in this browser");break;case 6:if(-1===n.audioPid&&o>0){let s=e+5,r=o;for(;r>2;){106===t[s]&&(!0!==i.ac3?a.log("AC-3 audio found, not supported in this browser for now"):(n.audioPid=l,n.segmentAudioCodec="ac3"));let e=t[s+1]+2;s+=e,r-=e}}break;case 194:case 135:return i3(r,Error("Unsupported EC-3 in M2TS found"),void 0,a),n;case 36:-1===n.videoPid&&(n.videoPid=l,n.segmentVideoCodec="hevc",a.log("HEVC in M2TS found"))}e+=o+5}return n}(t,s,this.typeSupported,i,this.observer,this.logger);(h=r.videoPid)>0&&(a.pid=h,a.segmentCodec=r.segmentVideoCodec),(u=r.audioPid)>0&&(n.pid=u,n.segmentCodec=r.segmentAudioCodec),(c=r.id3Pid)>0&&(l.pid=c),null===p||m||(this.logger.warn(`MPEG-TS PMT found at ${e} after unknown PID '${p}'. Backtracking to sync byte @${E} to parse all TS packets.`),p=null,e=E-188),m=this.pmtParsed=!0;break}case 17:case 8191:break;default:p=T}}else T++;T>0&&i3(this.observer,Error(`Found ${T} TS packet/s that do not start with 0x47`),void 0,this.logger),a.pesData=d,n.pesData=f,l.pesData=g;let A={audioTrack:n,videoTrack:a,id3Track:l,textTrack:o};return s&&this.extractRemainingSamples(A),A}flush(){let t,{remainderData:e}=this;return(this.remainderData=null,t=e?this.demux(e,-1,!1,!0):{videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes)?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(t){let e,{audioTrack:i,videoTrack:s,id3Track:r,textTrack:a}=t,n=s.pesData,l=i.pesData,o=r.pesData;if(n&&(e=i8(n,this.logger))){if(null===this.videoParser)switch(s.segmentCodec){case"avc":this.videoParser=new i0;break;case"hevc":this.videoParser=new i1}null!==this.videoParser&&(this.videoParser.parsePES(s,a,e,!0),s.pesData=null)}else s.pesData=n;if(l&&(e=i8(l,this.logger))){switch(i.segmentCodec){case"aac":this.parseAACPES(i,e);break;case"mp3":this.parseMPEGPES(i,e);break;case"ac3":this.parseAC3PES(i,e)}i.pesData=null}else null!=l&&l.size&&this.logger.log("last AAC PES packet truncated,might overlap between fragments"),i.pesData=l;o&&(e=i8(o,this.logger))?(this.parseID3PES(r,e),r.pesData=null):r.pesData=o}demuxSampleAes(t,e,i){let s=this.demux(t,i,!0,!this.config.progressive),r=this.sampleAes=new iQ(this.observer,this.config,e);return this.decrypt(s,r)}decrypt(t,e){return new Promise(i=>{let{audioTrack:s,videoTrack:r}=t;s.samples&&"aac"===s.segmentCodec?e.decryptAacSamples(s.samples,0,()=>{r.samples?e.decryptAvcSamples(r.samples,0,0,()=>{i(t)}):i(t)}):r.samples&&e.decryptAvcSamples(r.samples,0,0,()=>{i(t)})})}destroy(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0}parseAACPES(t,e){let i,s,r,a,n=0,l=this.aacOverFlow,o=e.data;if(l){this.aacOverFlow=null;let e=l.missing,i=l.sample.unit.byteLength;-1===e?o=td(l.sample.unit,o):(l.sample.unit.set(o.subarray(0,e),i-e),t.samples.push(l.sample),n=l.missing)}for(i=n,s=o.length;i<s-1&&!iL(o,i);i++);if(i!==n){let t,e=i<s-1;if(t=e?`AAC PES did not start with ADTS header,offset:${i}`:"No ADTS header found in AAC PES",i3(this.observer,Error(t),e,this.logger),!e)return}if(iI(t,this.observer,o,i,this.audioCodec),void 0!==e.pts)r=e.pts;else{if(!l)return void this.logger.warn("[tsdemuxer]: AAC PES unknown PTS");let e=9216e4/t.samplerate;r=l.sample.pts+e}let h=0;for(;i<s;){if(a=iR(t,o,i,r,h),i+=a.length,a.missing){this.aacOverFlow=a;break}for(h++;i<s-1&&!iL(o,i);i++);}}parseMPEGPES(t,e){let i=e.data,s=i.length,r=0,a=0,n=e.pts;if(void 0===n)return void this.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");for(;a<s;)if(iW(i,a)){let e=iV(t,i,a,n,r);if(e)a+=e.length,r++;else break}else a++}parseAC3PES(t,e){{let i,s=e.data,r=e.pts;if(void 0===r)return void this.logger.warn("[tsdemuxer]: AC3 PES unknown PTS");let a=s.length,n=0,l=0;for(;l<a&&(i=iz(t,s,l,r,n++))>0;)l+=i}}parseID3PES(t,e){if(void 0===e.pts)return void this.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");let i=R({},e,{type:this._videoTrack?iM.emsg:iM.audioId3,duration:Number.POSITIVE_INFINITY});t.samples.push(i)}}function i5(t,e){return((31&t[e+1])<<8)+t[e+2]}function i3(t,e,i,s){s.warn(`parsing error: ${e.message}`),t.emit(h.ERROR,h.ERROR,{type:l.MEDIA_ERROR,details:o.FRAG_PARSING_ERROR,fatal:!1,levelRetry:i,error:e,reason:e.message})}function i4(t,e){e.log(`${t} with AES-128-CBC encryption found in unencrypted stream`)}function i8(t,e){let i,s,r,a,n,l=0,o=t.data;if(!t||0===t.size)return null;for(;o[0].length<19&&o.length>1;)o[0]=td(o[0],o[1]),o.splice(1,1);if(1===((i=o[0])[0]<<16)+(i[1]<<8)+i[2]){if((s=(i[4]<<8)+i[5])&&s>t.size-6)return null;let h=i[7];192&h&&(a=(14&i[9])*0x20000000+(255&i[10])*4194304+(254&i[11])*16384+(255&i[12])*128+(254&i[13])/2,64&h?a-(n=(14&i[14])*0x20000000+(255&i[15])*4194304+(254&i[16])*16384+(255&i[17])*128+(254&i[18])/2)>54e5&&(e.warn(`${Math.round((a-n)/9e4)}s delta between PTS and DTS, align them`),a=n):n=a);let d=(r=i[8])+9;if(t.size<=d)return null;t.size-=d;let u=new Uint8Array(t.size);for(let t=0,e=o.length;t<e;t++){let e=(i=o[t]).byteLength;if(d)if(d>e){d-=e;continue}else i=i.subarray(d),e-=d,d=0;u.set(i,l),l+=e}return s&&(s-=r+3),{data:u,pts:a,dts:n,len:s}}return null}class i6{static getSilentFrame(t,e){if("mp4a.40.2"===t){if(1===e)return new Uint8Array([0,200,0,128,35,128]);if(2===e)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);else if(4===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);else if(5===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);else if(6===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===e)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===e)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===e)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}class i9{static init(){let t;for(t in i9.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},i9.types)i9.types.hasOwnProperty(t)&&(i9.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);i9.HDLR_TYPES={video:new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),audio:new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0])};let e=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]);i9.STTS=i9.STSC=i9.STCO=new Uint8Array([0,0,0,0,0,0,0,0]),i9.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),i9.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),i9.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),i9.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);let i=new Uint8Array([105,115,111,109]),s=new Uint8Array([97,118,99,49]),r=new Uint8Array([0,0,0,1]);i9.FTYP=i9.box(i9.types.ftyp,i,r,i,s),i9.DINF=i9.box(i9.types.dinf,i9.box(i9.types.dref,e))}static box(t,...e){let i=8,s=e.length,r=s;for(;s--;)i+=e[s].byteLength;let a=new Uint8Array(i);for(a[0]=i>>24&255,a[1]=i>>16&255,a[2]=i>>8&255,a[3]=255&i,a.set(t,4),s=0,i=8;s<r;s++)a.set(e[s],i),i+=e[s].byteLength;return a}static hdlr(t){return i9.box(i9.types.hdlr,i9.HDLR_TYPES[t])}static mdat(t){return i9.box(i9.types.mdat,t)}static mdhd(t,e){let i=Math.floor((e*=t)/0x100000000),s=Math.floor(e%0x100000000);return i9.box(i9.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,i>>24,i>>16&255,i>>8&255,255&i,s>>24,s>>16&255,s>>8&255,255&s,85,196,0,0]))}static mdia(t){return i9.box(i9.types.mdia,i9.mdhd(t.timescale||0,t.duration||0),i9.hdlr(t.type),i9.minf(t))}static mfhd(t){return i9.box(i9.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t]))}static minf(t){return"audio"===t.type?i9.box(i9.types.minf,i9.box(i9.types.smhd,i9.SMHD),i9.DINF,i9.stbl(t)):i9.box(i9.types.minf,i9.box(i9.types.vmhd,i9.VMHD),i9.DINF,i9.stbl(t))}static moof(t,e,i){return i9.box(i9.types.moof,i9.mfhd(t),i9.traf(i,e))}static moov(t){let e=t.length,i=[];for(;e--;)i[e]=i9.trak(t[e]);return i9.box.apply(null,[i9.types.moov,i9.mvhd(t[0].timescale||0,t[0].duration||0)].concat(i).concat(i9.mvex(t)))}static mvex(t){let e=t.length,i=[];for(;e--;)i[e]=i9.trex(t[e]);return i9.box.apply(null,[i9.types.mvex,...i])}static mvhd(t,e){let i=Math.floor((e*=t)/0x100000000),s=Math.floor(e%0x100000000),r=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,i>>24,i>>16&255,i>>8&255,255&i,s>>24,s>>16&255,s>>8&255,255&s,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return i9.box(i9.types.mvhd,r)}static sdtp(t){let e,i,s=t.samples||[],r=new Uint8Array(4+s.length);for(e=0;e<s.length;e++)i=s[e].flags,r[e+4]=i.dependsOn<<4|i.isDependedOn<<2|i.hasRedundancy;return i9.box(i9.types.sdtp,r)}static stbl(t){return i9.box(i9.types.stbl,i9.stsd(t),i9.box(i9.types.stts,i9.STTS),i9.box(i9.types.stsc,i9.STSC),i9.box(i9.types.stsz,i9.STSZ),i9.box(i9.types.stco,i9.STCO))}static avc1(t){let e,i,s,r=[],a=[];for(e=0;e<t.sps.length;e++)s=(i=t.sps[e]).byteLength,r.push(s>>>8&255),r.push(255&s),r=r.concat(Array.prototype.slice.call(i));for(e=0;e<t.pps.length;e++)s=(i=t.pps[e]).byteLength,a.push(s>>>8&255),a.push(255&s),a=a.concat(Array.prototype.slice.call(i));let n=i9.box(i9.types.avcC,new Uint8Array([1,r[3],r[4],r[5],255,224|t.sps.length].concat(r).concat([t.pps.length]).concat(a))),l=t.width,o=t.height,h=t.pixelRatio[0],d=t.pixelRatio[1];return i9.box(i9.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,255&l,o>>8&255,255&o,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),n,i9.box(i9.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),i9.box(i9.types.pasp,new Uint8Array([h>>24,h>>16&255,h>>8&255,255&h,d>>24,d>>16&255,d>>8&255,255&d])))}static esds(t){return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2,...t.config,6,1,2])}static audioStsd(t){let e=t.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount||0,0,16,0,0,0,0,e>>8&255,255&e,0,0])}static mp4a(t){return i9.box(i9.types.mp4a,i9.audioStsd(t),i9.box(i9.types.esds,i9.esds(t)))}static mp3(t){return i9.box(i9.types[".mp3"],i9.audioStsd(t))}static ac3(t){return i9.box(i9.types["ac-3"],i9.audioStsd(t),i9.box(i9.types.dac3,t.config))}static stsd(t){let{segmentCodec:e}=t;if("audio"===t.type){if("aac"===e)return i9.box(i9.types.stsd,i9.STSD,i9.mp4a(t));if("ac3"===e&&t.config)return i9.box(i9.types.stsd,i9.STSD,i9.ac3(t));if("mp3"===e&&"mp3"===t.codec)return i9.box(i9.types.stsd,i9.STSD,i9.mp3(t))}else if(t.pps&&t.sps){if("avc"===e)return i9.box(i9.types.stsd,i9.STSD,i9.avc1(t));if("hevc"===e&&t.vps)return i9.box(i9.types.stsd,i9.STSD,i9.hvc1(t))}else throw Error("video track missing pps or sps");throw Error(`unsupported ${t.type} segment codec (${e}/${t.codec})`)}static tkhd(t){let e=t.id,i=(t.duration||0)*(t.timescale||0),s=t.width||0,r=t.height||0,a=Math.floor(i/0x100000000),n=Math.floor(i%0x100000000);return i9.box(i9.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,0,0,0,0,a>>24,a>>16&255,a>>8&255,255&a,n>>24,n>>16&255,n>>8&255,255&n,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,s>>8&255,255&s,0,0,r>>8&255,255&r,0,0]))}static traf(t,e){let i=i9.sdtp(t),s=t.id,r=Math.floor(e/0x100000000),a=Math.floor(e%0x100000000);return i9.box(i9.types.traf,i9.box(i9.types.tfhd,new Uint8Array([0,0,0,0,s>>24,s>>16&255,s>>8&255,255&s])),i9.box(i9.types.tfdt,new Uint8Array([1,0,0,0,r>>24,r>>16&255,r>>8&255,255&r,a>>24,a>>16&255,a>>8&255,255&a])),i9.trun(t,i.length+16+20+8+16+8+8),i)}static trak(t){return t.duration=t.duration||0xffffffff,i9.box(i9.types.trak,i9.tkhd(t),i9.mdia(t))}static trex(t){let e=t.id;return i9.box(i9.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(t,e){let i,s,r,a,n,l,o=t.samples||[],h=o.length,d=12+16*h,u=new Uint8Array(d);for(e+=8+d,u.set([+("video"===t.type),0,15,1,h>>>24&255,h>>>16&255,h>>>8&255,255&h,e>>>24&255,e>>>16&255,e>>>8&255,255&e],0),i=0;i<h;i++)r=(s=o[i]).duration,a=s.size,n=s.flags,l=s.cts,u.set([r>>>24&255,r>>>16&255,r>>>8&255,255&r,a>>>24&255,a>>>16&255,a>>>8&255,255&a,n.isLeading<<2|n.dependsOn,n.isDependedOn<<6|n.hasRedundancy<<4|n.paddingValue<<1|n.isNonSync,61440&n.degradPrio,15&n.degradPrio,l>>>24&255,l>>>16&255,l>>>8&255,255&l],12+16*i);return i9.box(i9.types.trun,u)}static initSegment(t){i9.types||i9.init();let e=i9.moov(t);return td(i9.FTYP,e)}static hvc1(t){let e=t.params,i=[t.vps,t.sps,t.pps],s=new Uint8Array([1,e.general_profile_space<<6|32*!!e.general_tier_flag|e.general_profile_idc,e.general_profile_compatibility_flags[0],e.general_profile_compatibility_flags[1],e.general_profile_compatibility_flags[2],e.general_profile_compatibility_flags[3],e.general_constraint_indicator_flags[0],e.general_constraint_indicator_flags[1],e.general_constraint_indicator_flags[2],e.general_constraint_indicator_flags[3],e.general_constraint_indicator_flags[4],e.general_constraint_indicator_flags[5],e.general_level_idc,240|e.min_spatial_segmentation_idc>>8,255&e.min_spatial_segmentation_idc,252|e.parallelismType,252|e.chroma_format_idc,248|e.bit_depth_luma_minus8,248|e.bit_depth_chroma_minus8,0,parseInt(e.frame_rate.fps),3|e.temporal_id_nested<<2|e.num_temporal_layers<<3|64*!!e.frame_rate.fixed,i.length]),r=s.length;for(let t=0;t<i.length;t+=1){r+=3;for(let e=0;e<i[t].length;e+=1)r+=2+i[t][e].length}let a=new Uint8Array(r);a.set(s,0),r=s.length;let n=i.length-1;for(let t=0;t<i.length;t+=1){a.set(new Uint8Array([32+t|128*(t===n),0,i[t].length]),r),r+=3;for(let e=0;e<i[t].length;e+=1)a.set(new Uint8Array([i[t][e].length>>8,255&i[t][e].length]),r),r+=2,a.set(i[t][e],r),r+=i[t][e].length}let l=i9.box(i9.types.hvcC,a),o=t.width,h=t.height,d=t.pixelRatio[0],u=t.pixelRatio[1];return i9.box(i9.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,255&o,h>>8&255,255&h,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l,i9.box(i9.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),i9.box(i9.types.pasp,new Uint8Array([d>>24,d>>16&255,d>>8&255,255&d,u>>24,u>>16&255,u>>8&255,255&u])))}}function i7(t,e,i=1,s=!1){let r=t*e*i;return s?Math.round(r):r}function st(t,e=!1){return i7(t,1e3,11111111111111112e-21,e)}i9.types=void 0,i9.HDLR_TYPES=void 0,i9.STTS=void 0,i9.STSC=void 0,i9.STCO=void 0,i9.STSZ=void 0,i9.VMHD=void 0,i9.SMHD=void 0,i9.STSD=void 0,i9.FTYP=void 0,i9.DINF=void 0;let se=null,si=null;function ss(t,e,i,s){return{duration:e,size:i,cts:s,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:t?2:1,isNonSync:+!t}}}class sr{constructor(t,e,i,s){if(this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=t,this.config=e,this.typeSupported=i,this.logger=s,this.ISGenerated=!1,null===se){let t=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);se=t?parseInt(t[1]):0}if(null===si){let t=navigator.userAgent.match(/Safari\/(\d+)/i);si=t?parseInt(t[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(t){this.logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=t}resetNextTimestamp(){this.logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){this.logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(t){let e=!1,i=t[0].pts,s=t.reduce((t,s)=>{let r=s.pts,a=r-t;return(a<-0x100000000&&(e=!0,a=(r=sa(r,i))-t),a>0)?t:r},i);return e&&this.logger.debug("PTS rollover detected"),s}remux(t,e,i,s,r,a,n,l){let o,h,d,u,c,f,g=r,p=r,m=t.pid>-1,y=e.pid>-1,v=e.samples.length,E=t.samples.length>0,T=n&&v>0||v>1;if((!m||E)&&(!y||T)||this.ISGenerated||n){let i;if(this.ISGenerated){var b,S,A,_;let t=this.videoTrackConfig;(t&&(e.width!==t.width||e.height!==t.height||(null==(b=e.pixelRatio)?void 0:b[0])!==(null==(S=t.pixelRatio)?void 0:S[0])||(null==(A=e.pixelRatio)?void 0:A[1])!==(null==(_=t.pixelRatio)?void 0:_[1]))||!t&&T||null===this.nextAudioPts&&E)&&this.resetInitSegment()}this.ISGenerated||(d=this.generateIS(t,e,r,a));let s=this.isVideoContiguous,n=-1;if(T&&(n=function(t){for(let e=0;e<t.length;e++)if(t[e].key)return e;return -1}(e.samples),!s&&this.config.forceKeyFrameOnDiscontinuity))if(f=!0,n>0){this.logger.warn(`[mp4-remuxer]: Dropped ${n} out of ${v} video samples due to a missing keyframe`);let t=this.getVideoStartPts(e.samples);e.samples=e.samples.slice(n),e.dropped+=n,p+=(e.samples[0].pts-t)/e.inputTimeScale,i=p}else -1===n&&(this.logger.warn(`[mp4-remuxer]: No keyframe found out of ${v} video samples`),f=!1);if(this.ISGenerated){if(E&&T){let i=this.getVideoStartPts(e.samples),s=(sa(t.samples[0].pts,i)-i)/e.inputTimeScale;g+=Math.max(0,s),p+=Math.max(0,-s)}if(E){if(t.samplerate||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),d=this.generateIS(t,e,r,a)),h=this.remuxAudio(t,g,this.isAudioContiguous,a,y||T||l===x.AUDIO?p:void 0),T){let i=h?h.endPTS-h.startPTS:0;e.inputTimeScale||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),d=this.generateIS(t,e,r,a)),o=this.remuxVideo(e,p,s,i)}}else T&&(o=this.remuxVideo(e,p,s,0));o&&(o.firstKeyFrame=n,o.independent=-1!==n,o.firstKeyFramePTS=i)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(c=sn(i,r,this._initPTS,this._initDTS)),s.samples.length&&(u=sl(s,r,this._initPTS))),{audio:h,video:o,initSegment:d,independent:f,text:u,id3:c}}generateIS(t,e,i,s){let r,a,n,l,o=t.samples,h=e.samples,d=this.typeSupported,u={},c=this._initPTS,f=!c||s,g="audio/mp4";if(f&&(r=a=1/0),t.config&&o.length){switch(t.timescale=t.samplerate,t.segmentCodec){case"mp3":d.mpeg?(g="audio/mpeg",t.codec=""):d.mp3&&(t.codec="mp3");break;case"ac3":t.codec="ac-3"}u.audio={id:"audio",container:g,codec:t.codec,initSegment:"mp3"===t.segmentCodec&&d.mpeg?new Uint8Array(0):i9.initSegment([t]),metadata:{channelCount:t.channelCount}},f&&(l=t.id,n=t.inputTimeScale,c&&n===c.timescale?f=!1:r=a=o[0].pts-Math.round(n*i))}if(e.sps&&e.pps&&h.length){if(e.timescale=e.inputTimeScale,u.video={id:"main",container:"video/mp4",codec:e.codec,initSegment:i9.initSegment([e]),metadata:{width:e.width,height:e.height}},f)if(l=e.id,n=e.inputTimeScale,c&&n===c.timescale)f=!1;else{let t=this.getVideoStartPts(h),e=Math.round(n*i);a=Math.min(a,sa(h[0].dts,t)-e),r=Math.min(r,t-e)}this.videoTrackConfig={width:e.width,height:e.height,pixelRatio:e.pixelRatio}}if(Object.keys(u).length)return this.ISGenerated=!0,f?(this._initPTS={baseTime:r,timescale:n},this._initDTS={baseTime:a,timescale:n}):r=n=void 0,{tracks:u,initPTS:r,timescale:n,trackId:l}}remuxVideo(t,e,i,s){let r,a,n,d=t.inputTimeScale,u=t.samples,c=[],f=u.length,g=this._initPTS,p=this.nextAvcDts,m=8,y=this.videoSampleDuration,v=Number.POSITIVE_INFINITY,E=Number.NEGATIVE_INFINITY,T=!1;if(!i||null===p){let t=e*d,s=u[0].pts-sa(u[0].dts,u[0].pts);se&&null!==p&&15e3>Math.abs(t-s-p)?i=!0:p=t-s}let b=g.baseTime*d/g.timescale;for(let t=0;t<f;t++){let e=u[t];e.pts=sa(e.pts-b,p),e.dts=sa(e.dts-b,p),e.dts<u[t>0?t-1:t].dts&&(T=!0)}T&&u.sort(function(t,e){let i=t.dts-e.dts,s=t.pts-e.pts;return i||s}),r=u[0].dts;let S=(a=u[u.length-1].dts)-r,A=S?Math.round(S/(f-1)):y||t.inputTimeScale/30;if(i){let i=r-p,s=i>A,a=i<-1;if((s||a)&&(s?this.logger.warn(`${(t.segmentCodec||"").toUpperCase()}: ${st(i,!0)} ms (${i}dts) hole between fragments detected at ${e.toFixed(3)}`):this.logger.warn(`${(t.segmentCodec||"").toUpperCase()}: ${st(-i,!0)} ms (${i}dts) overlapping between fragments detected at ${e.toFixed(3)}`),!a||p>=u[0].pts||se)){r=p;let t=u[0].pts-i;if(s)u[0].dts=r,u[0].pts=t;else{let e=!0;for(let s=0;s<u.length&&(!(u[s].dts>t)||!e);s++){let t=u[s].pts;if(u[s].dts-=i,u[s].pts-=i,s<u.length-1){let i=u[s+1].pts;e=i<=u[s].pts==i<=t}}}this.logger.log(`Video: Initial PTS/DTS adjusted: ${st(t,!0)}/${st(r,!0)}, delta: ${st(i,!0)} ms`)}}let _=0,x=0,L=r=Math.max(0,r);for(let t=0;t<f;t++){let e=u[t],i=e.units,s=i.length,r=0;for(let t=0;t<s;t++)r+=i[t].data.length;x+=r,_+=s,e.length=r,e.dts<L?(e.dts=L,L+=A/4|0||1):L=e.dts,v=Math.min(e.pts,v),E=Math.max(e.pts,E)}a=u[f-1].dts;let I=x+4*_+8;try{n=new Uint8Array(I)}catch(t){this.observer.emit(h.ERROR,h.ERROR,{type:l.MUX_ERROR,details:o.REMUX_ALLOC_ERROR,fatal:!1,error:t,bytes:I,reason:`fail allocating video mdat ${I}`});return}let D=new DataView(n.buffer);D.setUint32(0,I),n.set(i9.types.mdat,4);let k=!1,P=Number.POSITIVE_INFINITY,C=Number.POSITIVE_INFINITY,M=Number.NEGATIVE_INFINITY,w=Number.NEGATIVE_INFINITY;for(let t=0;t<f;t++){let e,i=u[t],r=i.units,a=0;for(let t=0,e=r.length;t<e;t++){let e=r[t],i=e.data,s=e.data.byteLength;D.setUint32(m,s),m+=4,n.set(i,m),m+=s,a+=4+s}if(t<f-1)y=u[t+1].dts-i.dts,e=u[t+1].pts-i.pts;else{let r=this.config,a=t>0?i.dts-u[t-1].dts:A;if(e=t>0?i.pts-u[t-1].pts:A,r.stretchShortVideoTrack&&null!==this.nextAudioPts){let t=Math.floor(r.maxBufferHole*d),e=(s?v+s*d:this.nextAudioPts)-i.pts;e>t?((y=e-a)<0?y=a:k=!0,this.logger.log(`[mp4-remuxer]: It is approximately ${e/90} ms to the next segment; using duration ${y/90} ms for the last video frame.`)):y=a}else y=a}let l=Math.round(i.pts-i.dts);P=Math.min(P,y),M=Math.max(M,y),C=Math.min(C,e),w=Math.max(w,e),c.push(ss(i.key,y,a,l))}if(c.length){if(se){if(se<70){let t=c[0].flags;t.dependsOn=2,t.isNonSync=0}}else if(si&&w-C<M-P&&A/M<.025&&0===c[0].cts){this.logger.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let t=r;for(let e=0,i=c.length;e<i;e++){let s=t+c[e].duration,r=t+c[e].cts;if(e<i-1){let t=s+c[e+1].cts;c[e].duration=t-r}else c[e].duration=e?c[e-1].duration:A;c[e].cts=0,t=s}}}y=k||!y?A:y,this.nextAvcDts=p=a+y,this.videoSampleDuration=y,this.isVideoContiguous=!0;let O={data1:i9.moof(t.sequenceNumber++,r,R(t,{samples:c})),data2:n,startPTS:v/d,endPTS:(E+y)/d,startDTS:r/d,endDTS:p/d,type:"video",hasAudio:!1,hasVideo:!0,nb:c.length,dropped:t.dropped};return t.samples=[],t.dropped=0,O}getSamplesPerFrame(t){switch(t.segmentCodec){case"mp3":return 1152;case"ac3":return 1536;default:return 1024}}remuxAudio(t,e,i,s,r){let a,n=t.inputTimeScale,d=t.samplerate?t.samplerate:n,u=n/d,c=this.getSamplesPerFrame(t),f=c*u,g=this._initPTS,p="mp3"===t.segmentCodec&&this.typeSupported.mpeg,m=[],y=void 0!==r,v=t.samples,E=8*!p,T=this.nextAudioPts||-1,b=e*n,S=g.baseTime*n/g.timescale;if(this.isAudioContiguous=i=i||v.length&&T>0&&(s&&9e3>Math.abs(b-T)||Math.abs(sa(v[0].pts-S,b)-T)<20*f),v.forEach(function(t){t.pts=sa(t.pts-S,b)}),!i||T<0){if(!(v=v.filter(t=>t.pts>=0)).length)return;T=0===r?0:s&&!y?Math.max(0,b):v[0].pts}if("aac"===t.segmentCodec){let e=this.config.maxAudioFramesDrift;for(let i=0,s=T;i<v.length;i++){let r=v[i],a=r.pts,l=a-s,o=Math.abs(1e3*l/n);if(l<=-e*f&&y)0===i&&(this.logger.warn(`Audio frame @ ${(a/n).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*l/n)} ms.`),this.nextAudioPts=T=s=a);else if(l>=e*f&&o<1e4&&y){let e=Math.round(l/f);(s=a-e*f)<0&&(e--,s+=f),0===i&&(this.nextAudioPts=T=s),this.logger.warn(`[mp4-remuxer]: Injecting ${e} audio frame @ ${(s/n).toFixed(3)}s due to ${Math.round(1e3*l/n)} ms gap.`);for(let a=0;a<e;a++){let e=Math.max(s,0),a=i6.getSilentFrame(t.parsedCodec||t.manifestCodec||t.codec,t.channelCount);a||(this.logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),a=r.unit.subarray()),v.splice(i,0,{unit:a,pts:e}),s+=f,i++}}r.pts=s,s+=f}}let A=null,_=null,x=0,L=v.length;for(;L--;)x+=v[L].unit.byteLength;for(let e=0,s=v.length;e<s;e++){let s=v[e],r=s.unit,n=s.pts;if(null!==_)m[e-1].duration=Math.round((n-_)/u);else{if(i&&"aac"===t.segmentCodec&&(n=T),A=n,!(x>0))return;x+=E;try{a=new Uint8Array(x)}catch(t){this.observer.emit(h.ERROR,h.ERROR,{type:l.MUX_ERROR,details:o.REMUX_ALLOC_ERROR,fatal:!1,error:t,bytes:x,reason:`fail allocating audio mdat ${x}`});return}p||(new DataView(a.buffer).setUint32(0,x),a.set(i9.types.mdat,4))}a.set(r,E);let d=r.byteLength;E+=d,m.push(ss(!0,c,d,0)),_=n}let I=m.length;if(!I)return;let D=m[m.length-1];this.nextAudioPts=T=_+u*D.duration;let k=p?new Uint8Array(0):i9.moof(t.sequenceNumber++,A/u,R({},t,{samples:m}));t.samples=[];let P=A/n,C=T/n,M={data1:k,data2:a,startPTS:P,endPTS:C,startDTS:P,endDTS:C,type:"audio",hasAudio:!0,hasVideo:!1,nb:I};return this.isAudioContiguous=!0,M}}function sa(t,e){let i;if(null===e)return t;for(i=e<t?-0x200000000:0x200000000;Math.abs(t-e)>0x100000000;)t+=i;return t}function sn(t,e,i,s){let r=t.samples.length;if(!r)return;let a=t.inputTimeScale;for(let n=0;n<r;n++){let r=t.samples[n];r.pts=sa(r.pts-i.baseTime*a/i.timescale,e*a)/a,r.dts=sa(r.dts-s.baseTime*a/s.timescale,e*a)/a}let n=t.samples;return t.samples=[],{samples:n}}function sl(t,e,i){let s=t.samples.length;if(!s)return;let r=t.inputTimeScale;for(let a=0;a<s;a++){let s=t.samples[a];s.pts=sa(s.pts-i.baseTime*r/i.timescale,e*r)/r}t.samples.sort((t,e)=>t.pts-e.pts);let a=t.samples;return t.samples=[],{samples:a}}function so(t,e,i=!1){return(null==t?void 0:t.start)!==void 0?(t.start+(i?t.duration:0))/t.timescale:e}function sh(t,e,i){let s=null==t?void 0:t.codec;return s&&s.length>4?s:e===K.AUDIO?"ec-3"===s||"ac-3"===s||"alac"===s?s:"fLaC"===s||"Opus"===s?tx(s,!1):(i.warn(`Unhandled audio codec "${s}" in mp4 MAP`),s||"mp4a"):(i.warn(`Unhandled video codec "${s}" in mp4 MAP`),s||"avc1")}try{t=self.performance.now.bind(self.performance)}catch(e){t=Date.now}const sd=[{demux:class{constructor(t,e){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=e}resetTimeStamp(){}resetInitSegment(t,e,i,s){let r=this.videoTrack=iw("video",1),a=this.audioTrack=iw("audio",1),n=this.txtTrack=iw("text",1);if(this.id3Track=iw("id3",1),this.timeOffset=0,!(null!=t&&t.byteLength))return;let l=tr(t);if(l.video){let{id:t,timescale:e,codec:i,supplemental:s}=l.video;r.id=t,r.timescale=n.timescale=e,r.codec=i,r.supplemental=s}if(l.audio){let{id:t,timescale:e,codec:i}=l.audio;a.id=t,a.timescale=e,a.codec=i}n.id=X.text,r.sampleDuration=0,r.duration=a.duration=s}resetContiguity(){this.remainderData=null}static probe(t){let e=t.byteLength;for(let i=0;i<e;){let s=J(t,i);if(s>8&&109===t[i+4]&&111===t[i+5]&&111===t[i+6]&&102===t[i+7])return!0;i=s>1?i+s:e}return!1}demux(t,e){this.timeOffset=e;let i=t,s=this.videoTrack,r=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=td(this.remainderData,t));let e=function(t){let e={valid:null,remainder:null},i=ts(t,["moof"]);if(i.length<2)return e.remainder=t,e;let s=i[i.length-1];return e.valid=t.slice(0,s.byteOffset-8),e.remainder=t.slice(s.byteOffset-8),e}(i);this.remainderData=e.remainder,s.samples=e.valid||new Uint8Array}else s.samples=i;let a=this.extractID3Track(s,e);return r.samples=tu(e,s),{videoTrack:s,audioTrack:this.audioTrack,id3Track:a,textTrack:this.txtTrack}}flush(){let t=this.timeOffset,e=this.videoTrack,i=this.txtTrack;e.samples=this.remainderData||new Uint8Array,this.remainderData=null;let s=this.extractID3Track(e,this.timeOffset);return i.samples=tu(t,e),{videoTrack:e,audioTrack:iw(),id3Track:s,textTrack:iw()}}extractID3Track(t,e){let i=this.id3Track;if(t.samples.length){let s=ts(t.samples,["emsg"]);s&&s.forEach(t=>{let s=function(t){let e=t[0],i="",s="",r=0,n=0,l=0,o=0,h=0,d=0;if(0===e){for(;"\0"!==Q(t.subarray(d,d+1));)i+=Q(t.subarray(d,d+1)),d+=1;for(i+=Q(t.subarray(d,d+1)),d+=1;"\0"!==Q(t.subarray(d,d+1));)s+=Q(t.subarray(d,d+1)),d+=1;s+=Q(t.subarray(d,d+1)),d+=1,r=J(t,12),n=J(t,16),o=J(t,20),h=J(t,24),d=28}else if(1===e){d+=4,r=J(t,d);let e=J(t,d+=4),n=J(t,d+=4);for(d+=4,a(l=0x100000000*e+n)||(l=Number.MAX_SAFE_INTEGER,F.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),o=J(t,d),d+=4,h=J(t,d),d+=4;"\0"!==Q(t.subarray(d,d+1));)i+=Q(t.subarray(d,d+1)),d+=1;for(i+=Q(t.subarray(d,d+1)),d+=1;"\0"!==Q(t.subarray(d,d+1));)s+=Q(t.subarray(d,d+1)),d+=1;s+=Q(t.subarray(d,d+1)),d+=1}return{schemeIdUri:i,value:s,timeScale:r,presentationTime:l,presentationTimeDelta:n,eventDuration:o,id:h,payload:t.subarray(d,t.byteLength)}}(t);if(iq.test(s.schemeIdUri)){let t=iX(s,e),r=0xffffffff===s.eventDuration?Number.POSITIVE_INFINITY:s.eventDuration/s.timeScale;r<=.001&&(r=Number.POSITIVE_INFINITY);let a=s.payload;i.samples.push({data:a,len:a.byteLength,dts:t,pts:t,type:iM.emsg,duration:r})}else if(this.config.enableEmsgKLVMetadata&&s.schemeIdUri.startsWith("urn:misb:KLV:bin:1910.1")){let t=iX(s,e);i.samples.push({data:s.payload,len:s.payload.byteLength,dts:t,pts:t,type:iM.misbklv,duration:Number.POSITIVE_INFINITY})}})}return i}demuxSampleAes(t,e,i){return Promise.reject(Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0}},remux:class{constructor(t,e,i,s){this.logger=void 0,this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.isVideoContiguous=!1,this.logger=s}destroy(){}resetTimeStamp(t){this.initPTS=t,this.lastEndTime=null}resetNextTimestamp(){this.isVideoContiguous=!1,this.lastEndTime=null}resetInitSegment(t,e,i,s){this.audioCodec=e,this.videoCodec=i,this.generateInitSegment(function(t,e){if(!t||!e)return t;let i=e.keyId;return i&&e.isCommonEncryption&&ts(t,["moov","trak"]).forEach(t=>{let e=ts(t,["mdia","minf","stbl","stsd"])[0].subarray(8),s=ts(e,["enca"]),r=s.length>0;r||(s=ts(e,["encv"])),s.forEach(t=>{ts(r?t.subarray(28):t.subarray(78),["sinf"]).forEach(t=>{let e=th(t);if(e){let t=e.subarray(8,24);t.some(t=>0!==t)||(F.log(`[eme] Patching keyId in 'enc${r?"a":"v"}>sinf>>tenc' box: ${$.hexDump(t)} -> ${$.hexDump(i)}`),e.set(i,8))}})})}),t}(t,s)),this.emitInitSegment=!0}generateInitSegment(t){let{audioCodec:e,videoCodec:i}=this;if(!(null!=t&&t.byteLength)){this.initTracks=void 0,this.initData=void 0;return}let s=this.initData=tr(t);s.audio&&(e=sh(s.audio,K.AUDIO,this.logger)),s.video&&(i=sh(s.video,K.VIDEO,this.logger));let r={};s.audio&&s.video?r.audiovideo={container:"video/mp4",codec:e+","+i,supplemental:s.video.supplemental,initSegment:t,id:"main"}:s.audio?r.audio={container:"audio/mp4",codec:e,initSegment:t,id:"audio"}:s.video?r.video={container:"video/mp4",codec:i,supplemental:s.video.supplemental,initSegment:t,id:"main"}:this.logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=r}remux(t,e,i,s,a,n){var l,o,h,d;let u,{initPTS:c,lastEndTime:f}=this,g={audio:void 0,video:void 0,text:s,id3:i,initSegment:void 0};r(f)||(f=this.lastEndTime=a||0);let p=e.samples;if(!(null!=p&&p.length))return g;let m={initPTS:void 0,timescale:void 0,trackId:void 0},y=this.initData;if(null!=(l=y)&&l.length||(this.generateInitSegment(p),y=this.initData),!(null!=(o=y)&&o.length))return this.logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),g;this.emitInitSegment&&(m.tracks=this.initTracks,this.emitInitSegment=!1);let v=function(t,e,i){let s={},a=ts(t,["moof","traf"]);for(let t=0;t<a.length;t++){let n=a[t],l=ts(n,["tfhd"])[0],o=J(l,4),h=e[o];if(!h)continue;let d=s[o]||(s[o]={start:NaN,duration:0,sampleCount:0,timescale:h.timescale,type:h.type}),u=ts(n,["tfdt"])[0];if(u){let t=u[0],e=J(u,4);1===t&&(0xffffffff===e?i.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"):(e*=0x100000000,e+=J(u,8))),r(e)&&(!r(d.start)||e<d.start)&&(d.start=e)}let c=h.default,f=J(l,0)|(null==c?void 0:c.flags),g=(null==c?void 0:c.duration)||0;8&f&&(g=2&f?J(l,12):J(l,8));let p=ts(n,["trun"]),m=d.start||0,y=0,v=g;for(let t=0;t<p.length;t++){let e=p[t],i=J(e,4),s=d.sampleCount;d.sampleCount+=i;let r=1&e[3],a=4&e[3],n=1&e[2],l=2&e[2],o=4&e[2],h=8&e[2],u=8,c=i;for(r&&(u+=4),a&&i&&(1&e[u+1]||void 0!==d.keyFrameIndex||(d.keyFrameIndex=s),u+=4,n?(v=J(e,u),u+=4):v=g,l&&(u+=4),h&&(u+=4),m+=v,y+=v,c--);c--;)n?(v=J(e,u),u+=4):v=g,l&&(u+=4),o&&(1&e[u+1]||void 0!==d.keyFrameIndex||(d.keyFrameIndex=d.sampleCount-(c+1),d.keyFrameStart=m),u+=4),h&&(u+=4),m+=v,y+=v;!y&&g&&(y+=g*i)}d.duration+=y}if(!Object.keys(s).some(t=>s[t].duration)){let e=1/0,i=0,a=ts(t,["sidx"]);for(let t=0;t<a.length;t++){let s=function(t){let e=[],i=t[0],s=8,r=J(t,8);s+=4;let a=0,n=0;0===i?(a=J(t,s),n=J(t,s+4),s+=8):(a=tt(t,s),n=tt(t,s+8),s+=16),s+=2;let l=t.length+n,o=Z(t,s);s+=2;for(let i=0;i<o;i++){let i=s,a=J(t,i);i+=4;let n=0x7fffffff&a;if(1==(0x80000000&a)>>>31)return F.warn("SIDX has hierarchical references (not supported)"),null;let o=J(t,i);i+=4,e.push({referenceSize:n,subsegmentDuration:o,info:{duration:o/r,start:l,end:l+n-1}}),l+=n,i+=4,s=i}return{earliestPresentationTime:a,timescale:r,version:i,referencesCount:o,references:e}}(a[t]);if(null!=s&&s.references){e=Math.min(e,s.earliestPresentationTime/s.timescale);let t=s.references.reduce((t,e)=>t+e.info.duration||0,0);i=Math.max(i,t+s.earliestPresentationTime/s.timescale)}}i&&r(i)&&Object.keys(s).forEach(t=>{s[t].duration||(s[t].duration=i*s[t].timescale-s[t].start)})}return s}(p,y,this.logger),E=y.audio?v[y.audio.id]:null,T=y.video?v[y.video.id]:null,b=so(T,1/0),S=so(E,1/0),A=so(T,0,!0),_=so(E,0,!0),x=a,L=0;if(E&&(!T||!c&&S<b||c&&c.trackId===y.audio.id)?(m.trackId=y.audio.id,u=E,L=_-S):T&&(m.trackId=y.video.id,u=T,L=A-b),u){let t=u.timescale;x=u.start/t,m.timescale=t,c||(m.initPTS=u.start-a*t,this.initPTS=c={baseTime:m.initPTS,timescale:t,trackId:m.trackId})}(n||!c)&&(function(t,e,i,s){if(null===t)return!0;let r=Math.max(s,1);return Math.abs(e-t.baseTime/t.timescale-i)>r}(c,x,a,L)||m.timescale!==c.timescale)&&(m.initPTS=x-a,c&&1===c.timescale&&this.logger.warn(`Adjusting initPTS @${a} from ${c.baseTime/c.timescale} to ${m.initPTS}`),this.initPTS=c={baseTime:m.initPTS,timescale:1});let I=t?x-c.baseTime/c.timescale:f;h=y,d=c.baseTime/c.timescale,ts(p,["moof","traf"]).forEach(t=>{ts(t,["tfhd"]).forEach(e=>{let i=h[J(e,4)];if(!i)return;let s=i.timescale||9e4;ts(t,["tfdt"]).forEach(t=>{let e=t[0],i=d*s;if(i){let s=J(t,4);if(0===e)s-=i,ti(t,4,s=Math.max(s,0));else{s*=0x100000000,s+=J(t,8),s-=i;let e=Math.floor((s=Math.max(s,0))/0x100000000),r=Math.floor(s%0x100000000);ti(t,4,e),ti(t,8,r)}}})})});let R=I+L;L>0?this.lastEndTime=R:(this.logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());let D=!!y.audio,k=!!y.video,P="";D&&(P+="audio"),k&&(P+="video");let C={data1:p,startPTS:I,startDTS:I,endPTS:R,endDTS:R,type:P,hasAudio:D,hasVideo:k,nb:1,dropped:0};g.audio=D&&!k?C:void 0,g.video=k?C:void 0;let M=null==T?void 0:T.sampleCount;if(M){let t=T.keyFrameIndex,e=-1!==t;C.nb=M,C.dropped=0===t||this.isVideoContiguous?0:e?t:M,C.independent=e,C.firstKeyFrame=t,e&&T.keyFrameStart&&(C.firstKeyFramePTS=T.keyFrameStart-c.baseTime/c.timescale),this.isVideoContiguous||(g.independent=e),this.isVideoContiguous||(this.isVideoContiguous=e),C.dropped&&this.logger.warn(`fmp4 does not start with IDR: firstIDR ${t}/${M} dropped: ${C.dropped} pts: ${C.firstKeyFramePTS||"NA"}`)}return g.initSegment=m,g.id3=sn(i,a,c,c),s.samples.length&&(g.text=sl(s,a,c)),g}}},{demux:i2,remux:sr},{demux:class extends iO{constructor(t,e){super(),this.observer=void 0,this.config=void 0,this.observer=t,this.config=e}resetInitSegment(t,e,i,s){super.resetInitSegment(t,e,i,s),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:e,duration:s,inputTimeScale:9e4,dropped:0}}static probe(t,e){if(!t)return!1;let i=iS(t,0),s=(null==i?void 0:i.length)||0;if(iY(t,s))return!1;for(let i=t.length;s<i;s++)if(function(t,e){if(iL(t,e)){let i=i_(t,e);if(e+i>=t.length)return!1;let s=ix(t,e);if(s<=i)return!1;let r=e+s;return r===t.length||iL(t,r)}return!1}(t,s))return e.log("ADTS sync word found !"),!0;return!1}canParse(t,e){return e+5<t.length&&iA(t,e)&&ix(t,e)<=t.length-e}appendFrame(t,e,i){iI(t,this.observer,e,i,t.manifestCodec);let s=iR(t,e,i,this.basePTS,this.frameIndex);if(s&&0===s.missing)return s}},remux:sr},{demux:class extends iO{resetInitSegment(t,e,i,s){super.resetInitSegment(t,e,i,s),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:e,duration:s,inputTimeScale:9e4,dropped:0}}static probe(t){if(!t)return!1;let e=iS(t,0),i=(null==e?void 0:e.length)||0;if(e&&11===t[i]&&119===t[i+1]&&void 0!==iC(e)&&16>=ij(t,i))return!1;for(let e=t.length;i<e;i++)if(iY(t,i))return F.log("MPEG Audio sync word found !"),!0;return!1}canParse(t,e){return iK(t,e)&&4<=t.length-e}appendFrame(t,e,i){if(null!==this.basePTS)return iV(t,e,i,this.basePTS,this.frameIndex)}},remux:sr}];sd.splice(2,0,{demux:class extends iO{constructor(t){super(),this.observer=void 0,this.observer=t}resetInitSegment(t,e,i,s){super.resetInitSegment(t,e,i,s),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:e,duration:s,inputTimeScale:9e4,dropped:0}}canParse(t,e){return e+64<t.length}appendFrame(t,e,i){let s=iz(t,e,i,this.basePTS,this.frameIndex);if(-1!==s)return{sample:t.samples[t.samples.length-1],length:s,missing:0}}static probe(t){if(!t)return!1;let e=iS(t,0);if(!e)return!1;let i=e.length;return!!(11===t[i]&&119===t[i+1]&&void 0!==iC(e)&&16>ij(t,i))}},remux:sr});class su{constructor(t,e,i,s,r,a){this.asyncResult=!1,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=t,this.typeSupported=e,this.config=i,this.id=r,this.logger=a}configure(t){this.transmuxConfig=t,this.decrypter&&this.decrypter.reset()}push(e,i,s,r){var a,n;let d,u=s.transmuxing;u.executeStart=t();let c=new Uint8Array(e),{currentTransmuxState:f,transmuxConfig:g}=this;r&&(this.currentTransmuxState=r);let{contiguous:p,discontinuity:m,trackSwitch:y,accurateTimeOffset:v,timeOffset:E,initSegmentChange:T}=r||f,{audioCodec:b,videoCodec:S,defaultInitPts:A,duration:_,initSegmentData:x}=g,L=(a=c,n=i,d=null,a.byteLength>0&&(null==n?void 0:n.key)!=null&&null!==n.iv&&null!=n.method&&(d=n),d);if(L&&ex(L.method)){let e=this.getDecrypter(),i=eL(L.method);if(!e.isSync())return this.asyncResult=!0,this.decryptionPromise=e.webCryptoDecrypt(c,L.key.buffer,L.iv.buffer,i).then(t=>{let e=this.push(t,null,s);return this.decryptionPromise=null,e}),this.decryptionPromise;{let r=e.softwareDecrypt(c,L.key.buffer,L.iv.buffer,i);if(s.part>-1){let t=e.flush();r=t?t.buffer:t}if(!r)return u.executeEnd=t(),sc(s);c=new Uint8Array(r)}}let I=this.needsProbing(m,y);if(I){let e=this.configureTransmuxer(c);if(e)return this.logger.warn(`[transmuxer] ${e.message}`),this.observer.emit(h.ERROR,h.ERROR,{type:l.MEDIA_ERROR,details:o.FRAG_PARSING_ERROR,fatal:!1,error:e,reason:e.message}),u.executeEnd=t(),sc(s)}(m||y||T||I)&&this.resetInitSegment(x,b,S,_,i),(m||T||I)&&this.resetInitialTimestamp(A),p||this.resetContiguity();let R=this.transmux(c,L,E,v,s);this.asyncResult=sf(R);let D=this.currentTransmuxState;return D.contiguous=!0,D.discontinuity=!1,D.trackSwitch=!1,u.executeEnd=t(),R}flush(e){let i=e.transmuxing;i.executeStart=t();let{decrypter:s,currentTransmuxState:r,decryptionPromise:a}=this;if(a)return this.asyncResult=!0,a.then(()=>this.flush(e));let n=[],{timeOffset:l}=r;if(s){let t=s.flush();t&&n.push(this.push(t.buffer,null,e))}let{demuxer:o,remuxer:h}=this;if(!o||!h){i.executeEnd=t();let s=[sc(e)];return this.asyncResult?Promise.resolve(s):s}let d=o.flush(l);return sf(d)?(this.asyncResult=!0,d.then(t=>(this.flushRemux(n,t,e),n))):(this.flushRemux(n,d,e),this.asyncResult)?Promise.resolve(n):n}flushRemux(e,i,s){let{audioTrack:r,videoTrack:a,id3Track:n,textTrack:l}=i,{accurateTimeOffset:o,timeOffset:h}=this.currentTransmuxState;this.logger.log(`[transmuxer.ts]: Flushed ${this.id} sn: ${s.sn}${s.part>-1?" part: "+s.part:""} of ${this.id===x.MAIN?"level":"track"} ${s.level}`);let d=this.remuxer.remux(r,a,n,l,h,o,!0,this.id);e.push({remuxResult:d,chunkMeta:s}),s.transmuxing.executeEnd=t()}resetInitialTimestamp(t){let{demuxer:e,remuxer:i}=this;e&&i&&(e.resetTimeStamp(t),i.resetTimeStamp(t))}resetContiguity(){let{demuxer:t,remuxer:e}=this;t&&e&&(t.resetContiguity(),e.resetNextTimestamp())}resetInitSegment(t,e,i,s,r){let{demuxer:a,remuxer:n}=this;a&&n&&(a.resetInitSegment(t,e,i,s),n.resetInitSegment(t,e,i,r))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(t,e,i,s,r){let a;return e&&"SAMPLE-AES"===e.method?this.transmuxSampleAes(t,e,i,s,r):this.transmuxUnencrypted(t,i,s,r)}transmuxUnencrypted(t,e,i,s){let{audioTrack:r,videoTrack:a,id3Track:n,textTrack:l}=this.demuxer.demux(t,e,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(r,a,n,l,e,i,!1,this.id),chunkMeta:s}}transmuxSampleAes(t,e,i,s,r){return this.demuxer.demuxSampleAes(t,e,i).then(t=>({remuxResult:this.remuxer.remux(t.audioTrack,t.videoTrack,t.id3Track,t.textTrack,i,s,!1,this.id),chunkMeta:r}))}configureTransmuxer(t){let e,{config:i,observer:s,typeSupported:r}=this;for(let i=0,s=sd.length;i<s;i++){var a;if(null!=(a=sd[i].demux)&&a.probe(t,this.logger)){e=sd[i];break}}if(!e)return Error("Failed to find demuxer by probing fragment data");let n=this.demuxer,l=this.remuxer,o=e.remux,h=e.demux;l&&l instanceof o||(this.remuxer=new o(s,i,r,this.logger)),n&&n instanceof h||(this.demuxer=new h(s,i,r,this.logger),this.probe=h.probe)}needsProbing(t,e){return!this.demuxer||!this.remuxer||t||e}getDecrypter(){let t=this.decrypter;return t||(t=this.decrypter=new el(this.config)),t}}const sc=t=>({remuxResult:{},chunkMeta:t});function sf(t){return"then"in t&&t.then instanceof Function}class sg{constructor(t,e,i,s,r){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=t,this.videoCodec=e,this.initSegmentData=i,this.duration=s,this.defaultInitPts=r||null}}class sp{constructor(t,e,i,s,r,a){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=t,this.contiguous=e,this.accurateTimeOffset=i,this.trackSwitch=s,this.timeOffset=r,this.initSegmentChange=a}}let sm=0;class sy{constructor(t,e,i,s){this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=sm++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=t=>{let e=t.data,i=this.hls;if(i&&null!=e&&e.event&&e.instanceNo===this.instanceNo)switch(e.event){case"init":{var s;let t=null==(s=this.workerContext)?void 0:s.objectURL;t&&self.URL.revokeObjectURL(t);break}case"transmuxComplete":this.handleTransmuxComplete(e.data);break;case"flush":this.onFlush(e.data);break;case"workerLog":i.logger[e.data.logType]&&i.logger[e.data.logType](e.data.message);break;default:e.data=e.data||{},e.data.frag=this.frag,e.data.part=this.part,e.data.id=this.id,i.trigger(e.event,e.data)}},this.onWorkerError=t=>{if(!this.hls)return;let e=Error(`${t.message}  (${t.filename}:${t.lineno})`);this.hls.config.enableWorker=!1,this.hls.logger.warn(`Error in "${this.id}" Web Worker, fallback to inline`),this.hls.trigger(h.ERROR,{type:l.OTHER_ERROR,details:o.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:e})};let r=t.config;this.hls=t,this.id=e,this.useWorker=!!r.enableWorker,this.onTransmuxComplete=i,this.onFlush=s;let a=(t,e)=>{(e=e||{}).frag=this.frag||void 0,t===h.ERROR&&(e.parent=this.id,e.part=this.part,this.error=e.error),this.hls.trigger(t,e)};this.observer=new im,this.observer.on(h.FRAG_DECRYPTED,a),this.observer.on(h.ERROR,a);let n=tI(r.preferManagedMediaSource);if(this.useWorker&&"undefined"!=typeof Worker){let i=this.hls.logger;if(r.workerPath||"function"==typeof __HLS_WORKER_BUNDLE__){try{r.workerPath?(i.log(`loading Web Worker ${r.workerPath} for "${e}"`),this.workerContext=function(t){let e=iv[t];if(e)return e.clientCount++,e;let i=new self.URL(t,self.location.href).href,s={worker:new self.Worker(i),scriptURL:i,clientCount:1};return iv[t]=s,s}(r.workerPath)):(i.log(`injecting Web Worker for "${e}"`),this.workerContext=function(){let t=iv[iy];if(t)return t.clientCount++,t;let e=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),i=self.URL.createObjectURL(e),s={worker:new self.Worker(i),objectURL:i,clientCount:1};return iv[iy]=s,s}());let{worker:t}=this.workerContext;t.addEventListener("message",this.onWorkerMessage),t.addEventListener("error",this.onWorkerError),t.postMessage({instanceNo:this.instanceNo,cmd:"init",typeSupported:n,id:e,config:tG(r)})}catch(s){i.warn(`Error setting up "${e}" Web Worker, fallback to inline`,s),this.terminateWorker(),this.error=null,this.transmuxer=new su(this.observer,n,r,"",e,t.logger)}return}}this.transmuxer=new su(this.observer,n,r,"",e,t.logger)}reset(){if(this.frag=null,this.part=null,this.workerContext){let t=this.instanceNo;this.instanceNo=sm++;let e=this.hls.config,i=tI(e.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:"reset",resetNo:t,typeSupported:i,id:this.id,config:tG(e)})}}terminateWorker(){if(this.workerContext){let{worker:e}=this.workerContext;this.workerContext=null,e.removeEventListener("message",this.onWorkerMessage),e.removeEventListener("error",this.onWorkerError);var t=this.hls.config.workerPath;let i=iv[t||iy];if(i&&1==i.clientCount--){let{worker:e,objectURL:s}=i;delete iv[t||iy],s&&self.URL.revokeObjectURL(s),e.terminate()}}}destroy(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else{let t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}let t=this.observer;t&&t.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null}push(t,e,i,s,r,a,n,l,o,h){var d,u;o.transmuxing.start=self.performance.now();let{instanceNo:c,transmuxer:f}=this,g=a?a.start:r.start,p=r.decryptdata,m=this.frag,y=!(m&&r.cc===m.cc),v=!(m&&o.level===m.level),E=m?o.sn-m.sn:-1,T=this.part?o.part-this.part.index:-1,b=0===E&&o.id>1&&o.id===(null==m?void 0:m.stats.chunkCount),S=!v&&(1===E||0===E&&(1===T||b&&T<=0)),A=self.performance.now();(v||E||0===r.stats.parsing.start)&&(r.stats.parsing.start=A),a&&(T||!S)&&(a.stats.parsing.start=A);let _=!(m&&(null==(d=r.initSegment)?void 0:d.url)===(null==(u=m.initSegment)?void 0:u.url)),L=new sp(y,S,l,v,g,_);if(!S||y||_){this.hls.logger.log(`[transmuxer-interface]: Starting new transmux session for ${r.type} sn: ${o.sn}${o.part>-1?" part: "+o.part:""} ${this.id===x.MAIN?"level":"track"}: ${o.level} id: ${o.id}
        discontinuity: ${y}
        trackSwitch: ${v}
        contiguous: ${S}
        accurateTimeOffset: ${l}
        timeOffset: ${g}
        initSegmentChange: ${_}`);let t=new sg(i,s,e,n,h);this.configureTransmuxer(t)}if(this.frag=r,this.part=a,this.workerContext)this.workerContext.worker.postMessage({instanceNo:c,cmd:"demux",data:t,decryptdata:p,chunkMeta:o,state:L},t instanceof ArrayBuffer?[t]:[]);else if(f){let e=f.push(t,p,o,L);sf(e)?e.then(t=>{this.handleTransmuxComplete(t)}).catch(t=>{this.transmuxerError(t,o,"transmuxer-interface push error")}):this.handleTransmuxComplete(e)}}flush(t){t.transmuxing.start=self.performance.now();let{instanceNo:e,transmuxer:i}=this;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:e,cmd:"flush",chunkMeta:t});else if(i){let e=i.flush(t);sf(e)?e.then(e=>{this.handleFlushResult(e,t)}).catch(e=>{this.transmuxerError(e,t,"transmuxer-interface flush error")}):this.handleFlushResult(e,t)}}transmuxerError(t,e,i){this.hls&&(this.error=t,this.hls.trigger(h.ERROR,{type:l.MEDIA_ERROR,details:o.FRAG_PARSING_ERROR,chunkMeta:e,frag:this.frag||void 0,part:this.part||void 0,fatal:!1,error:t,err:t,reason:i}))}handleFlushResult(t,e){t.forEach(t=>{this.handleTransmuxComplete(t)}),this.onFlush(e)}configureTransmuxer(t){let{instanceNo:e,transmuxer:i}=this;this.workerContext?this.workerContext.worker.postMessage({instanceNo:e,cmd:"configure",config:t}):i&&i.configure(t)}handleTransmuxComplete(t){t.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(t)}}class sv extends P{constructor(t,e){super(e,t.logger),this.hls=void 0,this.canLoad=!1,this.timer=-1,this.hls=t}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){-1!==this.timer&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(t,e,i){let s=null==e?void 0:e.renditionReports;if(s){let r=-1;for(let i=0;i<s.length;i++){let a,n=s[i];try{a=new self.URL(n.URI,e.url).href}catch(t){this.warn(`Could not construct new URL for Rendition Report: ${t}`),a=n.URI||""}if(a===t){r=i;break}a===t.substring(0,a.length)&&(r=i)}if(-1!==r){let t=s[r],a=parseInt(t["LAST-MSN"])||(null==e?void 0:e.lastPartSn),n=parseInt(t["LAST-PART"])||(null==e?void 0:e.lastPartIndex);if(this.hls.config.lowLatencyMode){let t=Math.min(e.age-e.partTarget,e.targetduration);n>=0&&t>e.partTarget&&(n+=1)}return new tN(a,n>=0?n:void 0,i&&tF(i))}}}loadPlaylist(t){this.clearTimer()}loadingPlaylist(t,e){this.clearTimer()}shouldLoadPlaylist(t){return this.canLoad&&!!t&&!!t.url&&(!t.details||t.details.live)}getUrlWithDirectives(t,e){if(e)try{return e.addDirectives(t)}catch(t){this.warn(`Could not construct new URL with HLS Delivery Directives: ${t}`)}return t}playlistLoaded(t,e,i){let{details:s,stats:a}=e,n=self.performance.now(),d=a.loading.first?Math.max(0,n-a.loading.first):0;s.advancedDateTime=Date.now()-d;let u=this.hls.config.timelineOffset;if(u!==s.appliedTimelineOffset){let t=Math.max(u||0,0);s.appliedTimelineOffset=t,s.fragments.forEach(e=>{e.start=e.playlistOffset+t})}if(s.live||null!=i&&i.live){let u,f,g,p="levelInfo"in e?e.levelInfo:e.track;if(s.reloaded(i),i&&s.fragments.length>0){!function(t,e){let i;if(t===e)return;let s=null,a=t.fragments;for(let t=a.length-1;t>=0;t--){let e=a[t].initSegment;if(e){s=e;break}}t.fragmentHint&&delete t.fragmentHint.endPTS,function(t,e,i){let s=e.skippedSegments,r=Math.max(t.startSN,e.startSN)-e.startSN,a=+!!t.fragmentHint+(s?e.endSN:Math.min(t.endSN,e.endSN))-e.startSN,n=e.startSN-t.startSN,l=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,o=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments;for(let h=r;h<=a;h++){let r=o[n+h],a=l[h];if(s&&!a&&r&&(a=e.fragments[h]=r),r&&a){if(i(r,a,h,l),r.url&&r.url!==a.url){e.playlistParsingError=e4(`media sequence mismatch ${a.sn}:`,t,e,r,a);return}if(r.cc!==a.cc){e.playlistParsingError=e4(`discontinuity sequence mismatch (${r.cc}!=${a.cc})`,t,e,r,a);return}}}}(t,e,(t,a,n,l)=>{if((!e.startCC||e.skippedSegments)&&a.cc!==t.cc){let i=t.cc-a.cc;for(let t=n;t<l.length;t++)l[t].cc+=i;e.endCC=l[l.length-1].cc}r(t.startPTS)&&r(t.endPTS)&&(a.setStart(a.startPTS=t.startPTS),a.startDTS=t.startDTS,a.maxStartPTS=t.maxStartPTS,a.endPTS=t.endPTS,a.endDTS=t.endDTS,a.minEndPTS=t.minEndPTS,a.setDuration(t.endPTS-t.startPTS),a.duration&&(i=a),e.PTSKnown=e.alignedSliding=!0),t.hasStreams&&(a.elementaryStreams=t.elementaryStreams),a.loader=t.loader,t.hasStats&&(a.stats=t.stats),t.initSegment&&(a.initSegment=t.initSegment,s=t.initSegment)});let n=e.fragments,l=e.fragmentHint?n.concat(e.fragmentHint):n;if(s&&l.forEach(t=>{var e;t&&(!t.initSegment||t.initSegment.relurl===(null==(e=s)?void 0:e.relurl))&&(t.initSegment=s)}),e.skippedSegments){if(e.deltaUpdateFailed=n.some(t=>!t),e.deltaUpdateFailed){F.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let t=e.skippedSegments;t--;)n.shift();e.startSN=n[0].sn}else{e.canSkipDateRanges&&(e.dateRanges=function(t,e){let{dateRanges:i,recentlyRemovedDateranges:s}=e,r=R({},t);s&&s.forEach(t=>{delete r[t]});let a=Object.keys(r).length;return a&&Object.keys(i).forEach(t=>{let e=r[t],s=new eA(i[t].attr,e);s.isValid?(r[t]=s,e||(s.tagOrder+=a)):F.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${tG(i[t].attr)}"`)}),r}(t.dateRanges,e));let i=t.fragments.filter(t=>t.rawProgramDateTime);if(t.hasProgramDateTime&&!e.hasProgramDateTime)for(let t=1;t<l.length;t++)null===l[t].programDateTime&&eZ(l[t],l[t-1],i);ej(i,e)}e.endCC=n[n.length-1].cc}if(!e.startCC){var o;let i=e7(t,e.startSN-1);e.startCC=null!=(o=null==i?void 0:i.cc)?o:n[0].cc}(function(t,e,i){if(t&&e){let s=0;for(let r=0,a=t.length;r<=a;r++){let a=t[r],n=e[r+s];a&&n&&a.index===n.index&&a.fragment.sn===n.fragment.sn?i(a,n):s--}}})(t.partList,e.partList,(t,e)=>{e.elementaryStreams=t.elementaryStreams,e.stats=t.stats}),i?e3(e,i,i.startPTS,i.endPTS,i.startDTS,i.endDTS):e8(t,e),n.length&&(e.totalduration=e.edge-n[0].start),e.driftStartTime=t.driftStartTime,e.driftStart=t.driftStart;let h=e.advancedDateTime;if(e.advanced&&h){let t=e.edge;e.driftStart||(e.driftStartTime=h,e.driftStart=t),e.driftEndTime=h,e.driftEnd=t}else e.driftEndTime=t.driftEndTime,e.driftEnd=t.driftEnd,e.advancedDateTime=t.advancedDateTime;-1===e.requestScheduled&&(e.requestScheduled=t.requestScheduled)}(i,s);let t=s.playlistParsingError;if(t){this.warn(t);let i=this.hls;if(!i.config.ignorePlaylistParsingErrors){var c;let{networkDetails:r}=e;i.trigger(h.ERROR,{type:l.NETWORK_ERROR,details:o.LEVEL_PARSING_ERROR,fatal:!1,url:s.url,error:t,reason:t.message,level:e.level||void 0,parent:null==(c=s.fragments[0])?void 0:c.type,networkDetails:r,stats:a});return}s.playlistParsingError=null}}-1===s.requestScheduled&&(s.requestScheduled=a.loading.start);let m=this.hls.mainForwardBufferInfo,y=m?m.end-m.len:0,v=(s.edge-y)*1e3,E=e9(s,v);if(s.requestScheduled+E<n?s.requestScheduled=n:s.requestScheduled+=E,this.log(`live playlist ${t} ${s.advanced?"REFRESHED "+s.lastPartSn+"-"+s.lastPartIndex:s.updated?"UPDATED":"MISSED"}`),!this.canLoad||!s.live)return;if(s.canBlockReload&&s.endSN&&s.advanced){let t=this.hls.config.lowLatencyMode,r=s.lastPartSn,a=s.endSN,l=s.lastPartIndex,o=r===a;-1!==l?o?(f=a+1,g=t?0:l):(f=r,g=t?l+1:s.maxPartIndex):f=a+1;let h=s.age,d=h+s.ageHeader,c=Math.min(d-s.partTarget,1.5*s.targetduration);if(c>0){if(d>3*s.targetduration)this.log(`Playlist last advanced ${h.toFixed(2)}s ago. Omitting segment and part directives.`),f=void 0,g=void 0;else if(null!=i&&i.tuneInGoal&&d-s.partTarget>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${c} with playlist age: ${s.age}`),c=0;else{let t=Math.floor(c/s.targetduration);f+=t,void 0!==g&&(g+=Math.round(c%s.targetduration/s.partTarget)),this.log(`CDN Tune-in age: ${s.ageHeader}s last advanced ${h.toFixed(2)}s goal: ${c} skip sn ${t} to part ${g}`)}s.tuneInGoal=c}if(u=this.getDeliveryDirectives(s,e.deliveryDirectives,f,g),t||!o){s.requestScheduled=n,this.loadingPlaylist(p,u);return}}else(s.canBlockReload||s.canSkipUntil)&&(u=this.getDeliveryDirectives(s,e.deliveryDirectives,f,g));u&&void 0!==f&&s.canBlockReload&&(s.requestScheduled=a.loading.first+Math.max(E-2*d,E/2)),this.scheduleLoading(p,u,s)}else this.clearTimer()}scheduleLoading(t,e,i){let s=i||t.details;if(!s)return void this.loadingPlaylist(t,e);let r=self.performance.now(),a=s.requestScheduled;if(r>=a)return void this.loadingPlaylist(t,e);let n=a-r;this.log(`reload live playlist ${t.name||t.bitrate+"bps"} in ${Math.round(n)} ms`),this.clearTimer(),this.timer=self.setTimeout(()=>this.loadingPlaylist(t,e),n)}getDeliveryDirectives(t,e,i,s){let r=tF(t);return null!=e&&e.skip&&t.deltaUpdateFailed&&(i=e.msn,s=e.part,r=tO.No),new tN(i,s,r)}checkRetry(t){let e=t.details,i=t0(t),s=t.errorAction,{action:r,retryCount:a=0,retryConfig:n}=s||{},l=!!s&&!!n&&(r===t4.RetryRequest||!s.resolved&&r===t4.SendAlternateToPenaltyBox);if(l){var o;if(a>=n.maxNumRetry)return!1;if(i&&null!=(o=t.context)&&o.deliveryDirectives)this.warn(`Retrying playlist loading ${a+1}/${n.maxNumRetry} after "${e}" without delivery-directives`),this.loadPlaylist();else{let t=t2(n,a);this.clearTimer(),this.timer=self.setTimeout(()=>this.loadPlaylist(),t),this.warn(`Retrying playlist loading ${a+1}/${n.maxNumRetry} after "${e}" in ${t}ms`)}t.levelRetry=!0,s.resolved=!0}return l}}function sE(t,e){if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(!sT(t[i].attrs,e[i].attrs))return!1;return!0}function sT(t,e,i){let s=t["STABLE-RENDITION-ID"];return s&&!i?s===e["STABLE-RENDITION-ID"]:!(i||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(i=>t[i]!==e[i])}function sb(t,e){return e.label.toLowerCase()===t.name.toLowerCase()&&(!e.language||e.language.toLowerCase()===(t.lang||"").toLowerCase())}class sS{constructor(t){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=t}destroy(){this.tracks=this.queues=null}append(t,e,i){if(null===this.queues||null===this.tracks)return;let s=this.queues[e];s.push(t),1!==s.length||i||this.executeNext(e)}appendBlocker(t){return new Promise(e=>{this.append({label:"async-blocker",execute:e,onStart:()=>{},onComplete:()=>{},onError:()=>{}},t)})}prependBlocker(t){return new Promise(e=>{this.queues&&this.queues[t].unshift({label:"async-blocker-prepend",execute:e,onStart:()=>{},onComplete:()=>{},onError:()=>{}})})}removeBlockers(){null!==this.queues&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(t=>{var e;let i=null==(e=t[0])?void 0:e.label;("async-blocker"===i||"async-blocker-prepend"===i)&&(t[0].execute(),t.splice(0,1))})}unblockAudio(t){null!==this.queues&&this.queues.audio[0]===t&&this.shiftAndExecuteNext("audio")}executeNext(t){if(null===this.queues||null===this.tracks)return;let e=this.queues[t];if(e.length){let s=e[0];try{s.execute()}catch(r){var i;if(s.onError(r),null===this.queues||null===this.tracks)return;let e=null==(i=this.tracks[t])?void 0:i.buffer;null!=e&&e.updating||this.shiftAndExecuteNext(t)}}}shiftAndExecuteNext(t){null!==this.queues&&(this.queues[t].shift(),this.executeNext(t))}current(t){var e;return(null==(e=this.queues)?void 0:e[t][0])||null}toString(){let{queues:t,tracks:e}=this;return null===t||null===e?"<destroyed>":`
${this.list("video")}
${this.list("audio")}
${this.list("audiovideo")}}`}list(t){var e,i;return null!=(e=this.queues)&&e[t]||null!=(i=this.tracks)&&i[t]?`${t}: (${this.listSbInfo(t)}) ${this.listOps(t)}`:""}listSbInfo(t){var e;let i=null==(e=this.tracks)?void 0:e[t],s=null==i?void 0:i.buffer;return s?`SourceBuffer${s.updating?" updating":""}${i.ended?" ended":""}${i.ending?" ending":""}`:"none"}listOps(t){var e;return(null==(e=this.queues)?void 0:e[t].map(t=>t.label).join(", "))||""}}const sA=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,s_="HlsJsTrackRemovedError";class sx extends Error{constructor(t){super(t),this.name=s_}}function sL(t){let e=t.querySelectorAll("source");[].slice.call(e).forEach(e=>{t.removeChild(e)})}function sI(t){return+("audio"===t)}class sR{constructor(t){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=t,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(t){this.streamController=t}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){let{hls:t}=this;t.on(h.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.on(h.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(h.MANIFEST_PARSED,this.onManifestParsed,this),t.on(h.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(h.BUFFER_CODECS,this.onBufferCodecs,this),t.on(h.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){let{hls:t}=this;t.off(h.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.off(h.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(h.MANIFEST_PARSED,this.onManifestParsed,this),t.off(h.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(h.BUFFER_CODECS,this.onBufferCodecs,this),t.off(h.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(t,e){let i=this.hls.levels[e.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(t,e){this.media=e.media instanceof HTMLVideoElement?e.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(t,e){let i=this.hls;this.restrictedLevels=[],this.firstLevel=e.firstLevel,i.config.capLevelToPlayerSize&&e.video&&this.startCapping()}onLevelsUpdated(t,e){this.timer&&r(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(t,e){this.hls.config.capLevelToPlayerSize&&e.video&&this.startCapping()}onMediaDetaching(){this.stopCapping(),this.media=null}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}let t=this.hls.levels;if(t.length){let e=this.hls,i=this.getMaxLevel(t.length-1);i!==this.autoLevelCapping&&e.logger.log(`Setting autoLevelCapping to ${i}: ${t[i].height}p@${t[i].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),e.autoLevelCapping=i,e.autoLevelEnabled&&e.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=e.autoLevelCapping}}}getMaxLevel(t){let e=this.hls.levels;if(!e.length)return -1;let i=e.filter((e,i)=>this.isLevelAllowed(e)&&i<=t);return this.clientRect=null,sR.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;let t=this.media,e={width:0,height:0};if(t){let i=t.getBoundingClientRect();e.width=i.width,e.height=i.height,e.width||e.height||(e.width=i.right-i.left||t.width||0,e.height=i.bottom-i.top||t.height||0)}return this.clientRect=e,e}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let t=1;if(!this.hls.config.ignoreDevicePixelRatio)try{t=self.devicePixelRatio}catch(t){}return Math.min(t,this.hls.config.maxDevicePixelRatio)}isLevelAllowed(t){return!this.restrictedLevels.some(e=>t.bitrate===e.bitrate&&t.width===e.width&&t.height===e.height)}static getMaxLevelByMediaSize(t,e,i){if(!(null!=t&&t.length))return -1;let s=(t,e)=>!e||t.width!==e.width||t.height!==e.height,r=t.length-1,a=Math.max(e,i);for(let e=0;e<t.length;e+=1){let i=t[e];if((i.width>=a||i.height>=a)&&s(i,t[e+1])){r=e;break}}return r}}const sD={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",TIMED_TEXT:"tt"},sk={OBJECT:"CMCD-Object",REQUEST:"CMCD-Request",SESSION:"CMCD-Session",STATUS:"CMCD-Status"},sP={[sk.OBJECT]:["br","d","ot","tb"],[sk.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[sk.SESSION]:["cid","pr","sf","sid","st","v"],[sk.STATUS]:["bs","rtp"]};class sC{constructor(t,e){Array.isArray(t)&&(t=t.map(t=>t instanceof sC?t:new sC(t))),this.value=t,this.params=e}}function sM(t,e,i){return Error(`failed to serialize "${Array.isArray(t)?JSON.stringify(t):t instanceof Map?"Map{}":t instanceof Set?"Set{}":"object"==typeof t?JSON.stringify(t):String(t)}" as ${e}`,{cause:i})}class sw{constructor(t){this.description=t}}const sO="Bare Item";function sF(t){if(t<-0x38d7ea4c67fff||0x38d7ea4c67fff<t)throw sM(t,"Integer");return t.toString()}const sN=/[\x00-\x1f\x7f]+/;function sB(t){let e=t.description||t.toString().slice(7,-1);if(!1===/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(e))throw sM(e,"Token");return e}function sU(t){switch(typeof t){case"number":if(!r(t))throw sM(t,sO);if(Number.isInteger(t))return sF(t);let e=function t(e,i){if(e<0)return-t(-e,i);let s=Math.pow(10,i);if(!(Math.abs(e*s%1-.5)<Number.EPSILON))return Math.round(e*s)/s;{let t=Math.floor(e*s);return(t%2==0?t:t+1)/s}}(t,3);if(Math.floor(Math.abs(e)).toString().length>12)throw sM(t,"Decimal");let i=e.toString();return i.includes(".")?i:`${i}.0`;case"string":if(sN.test(t))throw sM(t,"String");return`"${t.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`;case"symbol":return sB(t);case"boolean":if("boolean"!=typeof t)throw sM(t,"Boolean");return t?"?1":"?0";case"object":if(t instanceof Date)return`@${sF(t.getTime()/1e3)}`;if(t instanceof Uint8Array){if(!1===ArrayBuffer.isView(t))throw sM(t,"Byte Sequence");return`:${btoa(String.fromCharCode(...t))}:`}if(t instanceof sw)return sB(t);default:throw sM(t,sO)}}function s$(t){if(!1===/^[a-z*][a-z0-9\-_.*]*$/.test(t))throw sM(t,"Key");return t}function sG(t){return null==t?"":Object.entries(t).map(([t,e])=>!0===e?`;${s$(t)}`:`;${s$(t)}=${sU(e)}`).join("")}function sV(t){return t instanceof sC?`${sU(t.value)}${sG(t.params)}`:sU(t)}const sH=t=>Math.round(t),sK=t=>100*sH(t/100),sW={br:sH,d:sH,bl:sK,dl:sK,mtp:sK,nor:(t,e)=>((null==e?void 0:e.baseUrl)&&(t=function(t,e){let i=new URL(t),s=new URL(e);if(i.origin!==s.origin)return t;let r=i.pathname.split("/").slice(1),a=s.pathname.split("/").slice(1,-1);for(;r[0]===a[0];)r.shift(),a.shift();for(;a.length;)a.shift(),r.unshift("..");return r.join("/")}(t,e.baseUrl)),encodeURIComponent(t)),rtp:sK,tb:sH};function sY(t,e={}){return t?function(t,e={whitespace:!0}){if("object"!=typeof t)throw sM(t,"Dict");let i=t instanceof Map?t.entries():Object.entries(t),s=(null==e?void 0:e.whitespace)?" ":"";return Array.from(i).map(([t,e])=>{e instanceof sC==!1&&(e=new sC(e));let i=s$(t);if(!0===e.value)i+=sG(e.params);else if(i+="=",Array.isArray(e.value)){var s;i+=(s=e,`(${s.value.map(sV).join(" ")})${sG(s.params)}`)}else i+=sV(e);return i}).join(`,${s}`)}(function(t,e){let i={};if(null==t||"object"!=typeof t)return i;let s=Object.keys(t).sort(),a=R({},sW,null==e?void 0:e.formatters),n=null==e?void 0:e.filter;return s.forEach(s=>{var l;if(null==n?void 0:n(s))return;let o=t[s],h=a[s];h&&(o=h(o,e)),("v"!==s||1!==o)&&("pr"!=s||1!==o)&&("number"==typeof(l=o)?r(l):null!=l&&""!==l&&!1!==l)&&(("ot"===s||"sf"===s||"st"===s)&&"string"==typeof o&&(o=new sw(o)),i[s]=o)}),i}(t,e),R({whitespace:!1},e)):""}const sj=/CMCD=[^&#]+/;function sz(t,e,i,s){t&&Object.keys(e).forEach(r=>{let a=t.filter(t=>t.groupId===r).map(t=>{let a=R({},t);return a.details=void 0,a.attrs=new eS(a.attrs),a.url=a.attrs.URI=sq(t.url,t.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",i),a.groupId=a.attrs["GROUP-ID"]=e[r],a.attrs["PATHWAY-ID"]=s,a});t.push(...a)})}function sq(t,e,i,s){let r,{HOST:a,PARAMS:n,[i]:l}=s;e&&(r=null==l?void 0:l[e])&&(t=r);let o=new self.URL(t);return a&&!r&&(o.host=a),n&&Object.keys(n).sort().forEach(t=>{t&&o.searchParams.set(t,n[t])}),o.href}function sX(t,e,i){sQ(t,e,i),t.addEventListener(e,i)}function sQ(t,e,i){t.removeEventListener(e,i)}class sZ extends P{constructor(t){super("eme",t.logger),this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.mediaKeys=null,this.setMediaKeysQueue=sZ.CDMCleanupPromise?[sZ.CDMCleanupPromise]:[],this.onMediaEncrypted=t=>{let{initDataType:e,initData:i}=t,s=`"${t.type}" event: init data type: "${e}"`;if(this.debug(s),null!==i){if(!this.keyFormatPromise){let t=Object.keys(this.keySystemAccessPromises);t.length||(t=eF(this.config));let e=t.map(eO).filter(t=>!!t);this.keyFormatPromise=this.getKeyFormatPromise(e)}this.keyFormatPromise.then(r=>{let a,n,l=eC(r);if("sinf"===e){if(l!==ek.FAIRPLAY)return void this.warn(`Ignoring unexpected "${t.type}" event with init data type: "${e}" for selected key-system ${l}`);let r=Q(new Uint8Array(i));try{let t=eI(JSON.parse(r).sinf),e=th(t);if(!e)throw Error("'schm' box missing or not cbcs/cenc with schi > tenc");a=new Uint8Array(e.subarray(8,24)),n=ek.FAIRPLAY}catch(t){this.warn(`${s} Failed to parse sinf: ${t}`);return}}else{if(l!==ek.WIDEVINE&&l!==ek.PLAYREADY)return void this.warn(`Ignoring unexpected "${t.type}" event with init data type: "${e}" for selected key-system ${l}`);let r=function(t){let e=[];if(t instanceof ArrayBuffer){let i=t.byteLength,s=0;for(;s+32<i;){let i=function(t){let e=t.getUint32(0),i=t.byteOffset,s=t.byteLength;if(s<e)return{offset:i,size:s};if(0x70737368!==t.getUint32(4))return{offset:i,size:e};let r=t.getUint32(8)>>>24;if(0!==r&&1!==r)return{offset:i,size:e};let a=t.buffer,n=$.hexDump(new Uint8Array(a,i+12,16)),l=t.getUint32(28),o=null,h=null;if(0===r){if(e-32<l||l<22)return{offset:i,size:e};h=new Uint8Array(a,i+32,l)}else if(1===r){if(!l||s<i+32+16*l+16)return{offset:i,size:e};o=[];for(let t=0;t<l;t++)o.push(new Uint8Array(a,i+32+16*t,16))}return{version:r,systemId:n,kids:o,data:h,offset:i,size:e}}(new DataView(t,s));e.push(i),s+=i.size}}return e}(i),o=r.filter(t=>!!t.systemId&&ew(t.systemId)===l);o.length>1&&this.warn(`${s} Using first of ${o.length} pssh found for selected key-system ${l}`);let h=o[0];if(!h)return void(0===r.length||r.some(t=>!t.systemId)?this.warn(`${s} contains incomplete or invalid pssh data`):this.log(`ignoring ${s} for ${r.map(t=>ew(t.systemId)).join(",")} pssh data in favor of playlist keys`));if(n=ew(h.systemId),0===h.version&&h.data)if(n===ek.WIDEVINE){let t=h.data.length-22;a=new Uint8Array(h.data.subarray(t,t+16))}else n===ek.PLAYREADY&&(a=eB(h.data))}if(!n||!a)return;let o=$.hexDump(a),{keyIdToKeySessionPromise:h,mediaKeySessions:d}=this,u=h[o];for(let t=0;t<d.length;t++){let s=d[t],r=s.decryptdata;if(!r.keyId)continue;let n=$.hexDump(r.keyId);if(o===n||-1!==r.uri.replace(/-/g,"").indexOf(o)){if(u=h[n],r.pssh)break;delete h[n],r.pssh=new Uint8Array(i),r.keyId=a,(u=h[o]=u.then(()=>this.generateRequestWithPreferredKeySession(s,e,i,"encrypted-event-key-match"))).catch(t=>this.handleError(t));break}}if(!u){if(n!==l)return void this.log(`Ignoring "${t.type}" event with ${n} init data for selected key-system ${l}`);(u=h[o]=this.getKeySystemSelectionPromise([n]).then(({keySystem:t,mediaKeys:s})=>{var r;this.throwIfDestroyed();let n=new e$("ISO-23001-7",o,null!=(r=eO(t))?r:"");return n.pssh=new Uint8Array(i),n.keyId=a,this.attemptSetMediaKeys(t,s).then(()=>{this.throwIfDestroyed();let r=this.createMediaKeySessionContext({decryptdata:n,keySystem:t,mediaKeys:s});return this.generateRequestWithPreferredKeySession(r,e,i,"encrypted-event-no-match")})})).catch(t=>this.handleError(t))}})}},this.onWaitingForKey=t=>{this.log(`"${t.type}" event`)},this.hls=t,this.config=t.config,this.registerListeners()}destroy(){this.onDestroying(),this.onMediaDetached();let t=this.config;t.requestMediaKeySystemAccessFunc=null,t.licenseXhrSetup=t.licenseResponseCallback=void 0,t.drmSystems=t.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null}registerListeners(){this.hls.on(h.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(h.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(h.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(h.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.on(h.DESTROYING,this.onDestroying,this)}unregisterListeners(){this.hls.off(h.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(h.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(h.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(h.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.off(h.DESTROYING,this.onDestroying,this)}getLicenseServerUrl(t){let{drmSystems:e,widevineLicenseUrl:i}=this.config,s=e[t];return s?s.licenseUrl:t===ek.WIDEVINE&&i?i:void 0}getLicenseServerUrlOrThrow(t){let e=this.getLicenseServerUrl(t);if(void 0===e)throw Error(`no license server URL configured for key-system "${t}"`);return e}getServerCertificateUrl(t){let{drmSystems:e}=this.config,i=e[t];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${t}"]`)}attemptKeySystemAccess(t){let e=this.hls.levels,i=(t,e,i)=>!!t&&i.indexOf(t)===e,s=e.map(t=>t.audioCodec).filter(i),r=e.map(t=>t.videoCodec).filter(i);return s.length+r.length===0&&r.push("avc1.42e01e"),new Promise((e,i)=>{let a=t=>{let n=t.shift();this.getMediaKeysPromise(n,s,r).then(t=>e({keySystem:n,mediaKeys:t})).catch(e=>{t.length?a(t):e instanceof sJ?i(e):i(new sJ({type:l.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_NO_ACCESS,error:e,fatal:!0},e.message))})};a(t)})}requestMediaKeySystemAccess(t,e){let{requestMediaKeySystemAccessFunc:i}=this.config;if("function"!=typeof i){let t=`Configured requestMediaKeySystemAccess is not a function ${i}`;return null===eN&&"http:"===self.location.protocol&&(t=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(Error(t))}return i(t,e)}getMediaKeysPromise(t,e,i){let s=function(t,e,i,s){var r,a,n,l;let o;switch(t){case ek.FAIRPLAY:o=["cenc","sinf"];break;case ek.WIDEVINE:case ek.PLAYREADY:o=["cenc"];break;case ek.CLEARKEY:o=["cenc","keyids"];break;default:throw Error(`Unknown key-system: ${t}`)}return r=o,a=e,n=i,[{initDataTypes:r,persistentState:(l=s).persistentState||"optional",distinctiveIdentifier:l.distinctiveIdentifier||"optional",sessionTypes:l.sessionTypes||[l.sessionType||"temporary"],audioCapabilities:a.map(t=>({contentType:`audio/mp4; codecs=${t}`,robustness:l.audioRobustness||"",encryptionScheme:l.audioEncryptionScheme||null})),videoCapabilities:n.map(t=>({contentType:`video/mp4; codecs=${t}`,robustness:l.videoRobustness||"",encryptionScheme:l.videoEncryptionScheme||null}))}]}(t,e,i,this.config.drmSystemOptions),r=this.keySystemAccessPromises[t],a=null==r?void 0:r.keySystemAccess;if(!a){this.log(`Requesting encrypted media "${t}" key-system access with config: ${tG(s)}`),a=this.requestMediaKeySystemAccess(t,s);let e=this.keySystemAccessPromises[t]={keySystemAccess:a};return a.catch(e=>{this.log(`Failed to obtain access to key-system "${t}": ${e}`)}),a.then(i=>{this.log(`Access for key-system "${i.keySystem}" obtained`);let s=this.fetchServerCertificate(t);return this.log(`Create media-keys for "${t}"`),e.mediaKeys=i.createMediaKeys().then(i=>(this.log(`Media-keys created for "${t}"`),e.hasMediaKeys=!0,s.then(e=>e?this.setMediaKeysServerCertificate(i,t,e):i))),e.mediaKeys.catch(e=>{this.error(`Failed to create media-keys for "${t}"}: ${e}`)}),e.mediaKeys})}return a.then(()=>r.mediaKeys)}createMediaKeySessionContext({decryptdata:t,keySystem:e,mediaKeys:i}){this.log(`Creating key-system session "${e}" keyId: ${$.hexDump(t.keyId||[])}`);let s=i.createSession(),r={decryptdata:t,keySystem:e,mediaKeys:i,mediaKeysSession:s,keyStatus:"status-pending"};return this.mediaKeySessions.push(r),r}renewKeySession(t){let e=t.decryptdata;if(e.pssh){let i=this.createMediaKeySessionContext(t),s=this.getKeyIdString(e);this.keyIdToKeySessionPromise[s]=this.generateRequestWithPreferredKeySession(i,"cenc",e.pssh.buffer,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(t)}getKeyIdString(t){if(!t)throw Error("Could not read keyId of undefined decryptdata");if(null===t.keyId)throw Error("keyId is null");return $.hexDump(t.keyId)}updateKeySession(t,e){var i;let s=t.mediaKeysSession;return this.log(`Updating key-session "${s.sessionId}" for keyID ${$.hexDump((null==(i=t.decryptdata)?void 0:i.keyId)||[])}
      } (data length: ${e?e.byteLength:e})`),s.update(e)}getSelectedKeySystemFormats(){return Object.keys(this.keySystemAccessPromises).map(t=>({keySystem:t,hasMediaKeys:this.keySystemAccessPromises[t].hasMediaKeys})).filter(({hasMediaKeys:t})=>!!t).map(({keySystem:t})=>eO(t)).filter(t=>!!t)}getKeySystemAccess(t){return this.getKeySystemSelectionPromise(t).then(({keySystem:t,mediaKeys:e})=>this.attemptSetMediaKeys(t,e))}selectKeySystem(t){return new Promise((e,i)=>this.getKeySystemSelectionPromise(t).then(({keySystem:t})=>{let s=eO(t);s?e(s):i(Error(`Unable to find format for key-system "${t}"`))}).catch(i))}selectKeySystemFormat(t){let e=Object.keys(t.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${t.sn} ${t.type}: ${t.level}) key formats ${e.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(e)),this.keyFormatPromise}getKeyFormatPromise(t){let e=eF(this.config),i=t.map(eC).filter(t=>!!t&&-1!==e.indexOf(t));return this.selectKeySystem(i)}loadKey(t){let e=t.keyInfo.decryptdata,i=this.getKeyIdString(e),s=`(keyId: ${i} format: "${e.keyFormat}" method: ${e.method} uri: ${e.uri})`;this.log(`Starting session for key ${s}`);let r=this.keyIdToKeySessionPromise[i];return r||(r=this.getKeySystemForKeyPromise(e).then(({keySystem:i,mediaKeys:r})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${t.frag.sn} ${t.frag.type}: ${t.frag.level} using key ${s}`),this.attemptSetMediaKeys(i,r).then(()=>(this.throwIfDestroyed(),this.createMediaKeySessionContext({keySystem:i,mediaKeys:r,decryptdata:e}))))),(this.keyIdToKeySessionPromise[i]=r.then(t=>{let i=e.pssh?e.pssh.buffer:null;return this.generateRequestWithPreferredKeySession(t,"cenc",i,"playlist-key")})).catch(t=>this.handleError(t))),r}throwIfDestroyed(t="Invalid state"){if(!this.hls)throw Error("invalid state")}handleError(t){this.hls&&(this.error(t.message),t instanceof sJ?this.hls.trigger(h.ERROR,t.data):this.hls.trigger(h.ERROR,{type:l.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_NO_KEYS,error:t,fatal:!0}))}getKeySystemForKeyPromise(t){let e=this.getKeyIdString(t),i=this.keyIdToKeySessionPromise[e];if(!i){let e=eC(t.keyFormat),i=e?[e]:eF(this.config);return this.attemptKeySystemAccess(i)}return i}getKeySystemSelectionPromise(t){if(t.length||(t=eF(this.config)),0===t.length)throw new sJ({type:l.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${tG({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(t)}attemptSetMediaKeys(t,e){if(this.mediaKeys===e)return Promise.resolve();let i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${t}"`);let s=Promise.all(i).then(()=>{if(!this.media)throw this.mediaKeys=null,Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(e)});return this.mediaKeys=e,this.setMediaKeysQueue.push(s),s.then(()=>{this.log(`Media-keys set for "${t}"`),i.push(s),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(t=>-1===i.indexOf(t))})}generateRequestWithPreferredKeySession(t,e,i,s){var r,a,n;let h=null==(r=this.config.drmSystems)||null==(a=r[t.keySystem])?void 0:a.generateRequest;if(h)try{let s=h.call(this.hls,e,i,t);if(!s)throw Error("Invalid response from configured generateRequest filter");e=s.initDataType,i=s.initData?s.initData:null,t.decryptdata.pssh=i?new Uint8Array(i):null}catch(t){if(this.warn(t.message),null!=(n=this.hls)&&n.config.debug)throw t}if(null===i)return this.log(`Skipping key-session request for "${s}" (no initData)`),Promise.resolve(t);let d=this.getKeyIdString(t.decryptdata);this.log(`Generating key-session request for "${s}": ${d} (init data type: ${e} length: ${i?i.byteLength:null})`);let u=new im,c=t._onmessage=e=>{let i=t.mediaKeysSession;if(!i)return void u.emit("error",Error("invalid state"));let{messageType:s,message:r}=e;this.log(`"${s}" message event for session "${i.sessionId}" message size: ${r.byteLength}`),"license-request"===s||"license-renewal"===s?this.renewLicense(t,r).catch(t=>{u.eventNames().length?u.emit("error",t):this.handleError(t)}):"license-release"===s?t.keySystem===ek.FAIRPLAY&&(this.updateKeySession(t,eR("acknowledged")),this.removeSession(t)):this.warn(`unhandled media key message type "${s}"`)},f=t._onkeystatuseschange=e=>{if(!t.mediaKeysSession)return void u.emit("error",Error("invalid state"));this.onKeyStatusChange(t);let i=t.keyStatus;u.emit("keyStatus",i),"expired"===i&&(this.warn(`${t.keySystem} expired for key ${d}`),this.renewKeySession(t))};sX(t.mediaKeysSession,"message",c),sX(t.mediaKeysSession,"keystatuseschange",f);let g=new Promise((t,e)=>{u.on("error",e),u.on("keyStatus",i=>{i.startsWith("usable")?t():"output-restricted"===i?e(new sJ({type:l.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):"internal-error"===i?e(new sJ({type:l.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${i}"`)):"expired"===i?e(Error("key expired while generating request")):this.warn(`unhandled key status change "${i}"`)})});return t.mediaKeysSession.generateRequest(e,i).then(()=>{var e;this.log(`Request generated for key-session "${null==(e=t.mediaKeysSession)?void 0:e.sessionId}" keyId: ${d}`)}).catch(t=>{throw new sJ({type:l.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_NO_SESSION,error:t,fatal:!1},`Error generating key-session request: ${t}`)}).then(()=>g).catch(e=>{throw u.removeAllListeners(),this.removeSession(t),e}).then(()=>(u.removeAllListeners(),t))}onKeyStatusChange(t){t.mediaKeysSession.keyStatuses.forEach((e,i)=>{if("string"==typeof i&&"object"==typeof e){let t=i;i=e,e=t}this.log(`key status change "${e}" for keyStatuses keyId: ${$.hexDump("buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i))} session keyId: ${$.hexDump(new Uint8Array(t.decryptdata.keyId||[]))} uri: ${t.decryptdata.uri}`),t.keyStatus=e})}fetchServerCertificate(t){let e=this.config,i=new e.loader(e),s=this.getServerCertificateUrl(t);return s?(this.log(`Fetching server certificate for "${t}"`),new Promise((r,a)=>{let n={responseType:"arraybuffer",url:s},h=e.certLoadPolicy.default,d={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0};i.load(n,d,{onSuccess:(t,e,i,s)=>{r(t.data)},onError:(e,i,r,h)=>{a(new sJ({type:l.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:r,response:k({url:n.url,data:void 0},e)},`"${t}" certificate request failed (${s}). Status: ${e.code} (${e.text})`))},onTimeout:(e,i,r)=>{a(new sJ({type:l.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:r,response:{url:n.url,data:void 0}},`"${t}" certificate request timed out (${s})`))},onAbort:(t,e,i)=>{a(Error("aborted"))}})})):Promise.resolve()}setMediaKeysServerCertificate(t,e,i){return new Promise((s,r)=>{t.setServerCertificate(i).then(r=>{this.log(`setServerCertificate ${r?"success":"not supported by CDM"} (${null==i?void 0:i.byteLength}) on "${e}"`),s(t)}).catch(t=>{r(new sJ({type:l.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:t,fatal:!0},t.message))})})}renewLicense(t,e){return this.requestLicense(t,new Uint8Array(e)).then(e=>this.updateKeySession(t,new Uint8Array(e)).catch(t=>{throw new sJ({type:l.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:t,fatal:!0},t.message)}))}unpackPlayReadyKeyMessage(t,e){let i=String.fromCharCode.apply(null,new Uint16Array(e.buffer));if(!i.includes("PlayReadyKeyMessage"))return t.setRequestHeader("Content-Type","text/xml; charset=utf-8"),e;let s=new DOMParser().parseFromString(i,"application/xml"),r=s.querySelectorAll("HttpHeader");if(r.length>0){let e;for(let i=0,s=r.length;i<s;i++){var a,n;let s=null==(a=(e=r[i]).querySelector("name"))?void 0:a.textContent,l=null==(n=e.querySelector("value"))?void 0:n.textContent;s&&l&&t.setRequestHeader(s,l)}}let l=s.querySelector("Challenge"),o=null==l?void 0:l.textContent;if(!o)throw Error("Cannot find <Challenge> in key message");return eR(atob(o))}setupLicenseXHR(t,e,i,s){let r=this.config.licenseXhrSetup;return r?Promise.resolve().then(()=>{if(!i.decryptdata)throw Error("Key removed");return r.call(this.hls,t,e,i,s)}).catch(a=>{if(!i.decryptdata)throw a;return t.open("POST",e,!0),r.call(this.hls,t,e,i,s)}).then(i=>(t.readyState||t.open("POST",e,!0),{xhr:t,licenseChallenge:i||s})):(t.open("POST",e,!0),Promise.resolve({xhr:t,licenseChallenge:s}))}requestLicense(t,e){let i=this.config.keyLoadPolicy.default;return new Promise((s,r)=>{let a=this.getLicenseServerUrlOrThrow(t.keySystem);this.log(`Sending license request to URL: ${a}`);let n=new XMLHttpRequest;n.responseType="arraybuffer",n.onreadystatechange=()=>{if(!this.hls||!t.mediaKeysSession)return r(Error("invalid state"));if(4===n.readyState)if(200===n.status){this._requestLicenseFailureCount=0;let e=n.response;this.log(`License received ${e instanceof ArrayBuffer?e.byteLength:e}`);let i=this.config.licenseResponseCallback;if(i)try{e=i.call(this.hls,n,a,t)}catch(t){this.error(t)}s(e)}else{let h=i.errorRetry,d=h?h.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>d||n.status>=400&&n.status<500)r(new sJ({type:l.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:n,response:{url:a,data:void 0,code:n.status,text:n.statusText}},`License Request XHR failed (${a}). Status: ${n.status} (${n.statusText})`));else{let i=d-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${i} attempts left`),this.requestLicense(t,e).then(s,r)}}},t.licenseXhr&&t.licenseXhr.readyState!==XMLHttpRequest.DONE&&t.licenseXhr.abort(),t.licenseXhr=n,this.setupLicenseXHR(n,a,t,e).then(({xhr:e,licenseChallenge:i})=>{t.keySystem==ek.PLAYREADY&&(i=this.unpackPlayReadyKeyMessage(e,i)),e.send(i)})})}onDestroying(){this.unregisterListeners(),this._clear()}onMediaAttached(t,e){if(!this.config.emeEnabled)return;let i=e.media;this.media=i,sX(i,"encrypted",this.onMediaEncrypted),sX(i,"waitingforkey",this.onWaitingForKey)}onMediaDetached(){let t=this.media;t&&(sQ(t,"encrypted",this.onMediaEncrypted),sQ(t,"waitingforkey",this.onWaitingForKey),this.media=null,this.mediaKeys=null)}_clear(){var t;if(this._requestLicenseFailureCount=0,this.keyIdToKeySessionPromise={},!this.mediaKeys&&!this.mediaKeySessions.length)return;let e=this.media,i=this.mediaKeySessions.slice();this.mediaKeySessions=[],this.mediaKeys=null,e$.clearKeyUriToKeyIdMap();let s=i.length;sZ.CDMCleanupPromise=Promise.all(i.map(t=>this.removeSession(t)).concat(null==e||null==(t=e.setMediaKeys(null))?void 0:t.catch(t=>{var e;this.log(`Could not clear media keys: ${t}`),null==(e=this.hls)||e.trigger(h.ERROR,{type:l.OTHER_ERROR,details:o.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:!1,error:Error(`Could not clear media keys: ${t}`)})}))).catch(t=>{var e;this.log(`Could not close sessions and clear media keys: ${t}`),null==(e=this.hls)||e.trigger(h.ERROR,{type:l.OTHER_ERROR,details:o.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:Error(`Could not close sessions and clear media keys: ${t}`)})}).then(()=>{s&&this.log("finished closing key sessions and clearing media keys")})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(t,{sessionKeys:e}){if(e&&this.config.emeEnabled&&!this.keyFormatPromise){let t=e.reduce((t,e)=>(-1===t.indexOf(e.keyFormat)&&t.push(e.keyFormat),t),[]);this.log(`Selecting key-system from session-keys ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)}}removeSession(t){let{mediaKeysSession:e,licenseXhr:i}=t;if(e){var s;this.log(`Remove licenses and keys and close session ${e.sessionId}`),t._onmessage&&(e.removeEventListener("message",t._onmessage),t._onmessage=void 0),t._onkeystatuseschange&&(e.removeEventListener("keystatuseschange",t._onkeystatuseschange),t._onkeystatuseschange=void 0),i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),t.mediaKeysSession=t.decryptdata=t.licenseXhr=void 0;let r=this.mediaKeySessions.indexOf(t);r>-1&&this.mediaKeySessions.splice(r,1);let{drmSystemOptions:a}=this.config;return("persistent-license"===a.sessionType||null!=(s=a.sessionTypes)&&s.some(t=>"persistent-license"===t)?new Promise((t,i)=>{self.setTimeout(()=>i(Error("MediaKeySession.remove() timeout")),8e3),e.remove().then(t)}):Promise.resolve()).catch(t=>{var e;this.log(`Could not remove session: ${t}`),null==(e=this.hls)||e.trigger(h.ERROR,{type:l.OTHER_ERROR,details:o.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:!1,error:Error(`Could not remove session: ${t}`)})}).then(()=>e.close()).catch(t=>{var e;this.log(`Could not close session: ${t}`),null==(e=this.hls)||e.trigger(h.ERROR,{type:l.OTHER_ERROR,details:o.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:Error(`Could not close session: ${t}`)})})}}}sZ.CDMCleanupPromise=void 0;class sJ extends Error{constructor(t,e){super(e),this.data=void 0,t.error||(t.error=Error(e)),this.data=t,t.err=t.error}}function s0(t,e){let i;try{i=new Event("addtrack")}catch(t){(i=document.createEvent("Event")).initEvent("addtrack",!1,!1)}i.track=t,e.dispatchEvent(i)}function s1(t,e){let i=t.mode;if("disabled"===i&&(t.mode="hidden"),t.cues&&!t.cues.getCueById(e.id))try{if(t.addCue(e),!t.cues.getCueById(e.id))throw Error(`addCue is failed for: ${e}`)}catch(i){F.debug(`[texttrack-utils]: ${i}`);try{let i=new self.TextTrackCue(e.startTime,e.endTime,e.text);i.id=e.id,t.addCue(i)}catch(t){F.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${t}`)}}"disabled"===i&&(t.mode=i)}function s2(t,e){let i=t.mode;if("disabled"===i&&(t.mode="hidden"),t.cues)for(let i=t.cues.length;i--;)e&&t.cues[i].removeEventListener("enter",e),t.removeCue(t.cues[i]);"disabled"===i&&(t.mode=i)}function s5(t,e,i,s){let r=t.mode;if("disabled"===r&&(t.mode="hidden"),t.cues&&t.cues.length>0){let r=function(t,e,i){let s=[],r=function(t,e){let i;if(e<=t[0].startTime)return 0;let s=t.length-1;if(e>t[s].endTime)return -1;let r=0,a=s;for(;r<=a;)if(e<t[i=Math.floor((a+r)/2)].startTime)a=i-1;else{if(!(e>t[i].startTime)||!(r<s))return i;r=i+1}return t[r].startTime-e<e-t[a].startTime?r:a}(t,e);if(r>-1)for(let a=r,n=t.length;a<n;a++){let r=t[a];if(r.startTime>=e&&r.endTime<=i)s.push(r);else if(r.startTime>i)break}return s}(t.cues,e,i);for(let e=0;e<r.length;e++)(!s||s(r[e]))&&t.removeCue(r[e])}"disabled"===r&&(t.mode=r)}function s3(t){let e=[];for(let i=0;i<t.length;i++){let s=t[i];("subtitles"===s.kind||"captions"===s.kind)&&s.label&&e.push(t[i])}return e}function s4(t){let e=5381,i=t.length;for(;i;)e=33*e^t.charCodeAt(--i);return(e>>>0).toString()}let s8=((v={})[v.Point=0]="Point",v[v.Range=1]="Range",v);class s6{constructor(t,e){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=!1,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:!1,jump:!1},this.snapOptions={out:!1,in:!1},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=e,this.dateRange=t,this.setDateRange(t)}setDateRange(t){this.dateRange=t,this.resumeOffset=t.attr.optionalFloat("X-RESUME-OFFSET",this.resumeOffset),this.playoutLimit=t.attr.optionalFloat("X-PLAYOUT-LIMIT",this.playoutLimit),this.restrictions=t.attr.enumeratedStringList("X-RESTRICT",this.restrictions),this.snapOptions=t.attr.enumeratedStringList("X-SNAP",this.snapOptions)}reset(){var t;this.appendInPlaceStarted=!1,null==(t=this.assetListLoader)||t.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null)}isAssetPastPlayoutLimit(t){var e;if(t>0&&t>=this.assetList.length)return!0;let i=this.playoutLimit;return!(t<=0||isNaN(i))&&(0===i||((null==(e=this.assetList[t])?void 0:e.startOffset)||0)>i)}findAssetIndex(t){return this.assetList.indexOf(t)}get identifier(){return this.dateRange.id}get startDate(){return this.dateRange.startDate}get startTime(){let t=this.dateRange.startTime;if(this.snapOptions.out){let e=this.dateRange.tagAnchor;if(e)return s9(t,e)}return t}get startOffset(){return this.cue.pre?0:this.startTime}get startIsAligned(){if(0===this.startTime||this.snapOptions.out)return!0;let t=this.dateRange.tagAnchor;if(t){let e=this.dateRange.startTime,i=s9(e,t);return e-i<.1}return!1}get resumptionOffset(){let t=this.resumeOffset,e=r(t)?t:this.duration;return this.cumulativeDuration+e}get resumeTime(){let t=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){let e=this.resumeAnchor;if(e)return s9(t,e)}return t}get appendInPlace(){return!!this.appendInPlaceStarted||!this.appendInPlaceDisabled&&!!(!this.cue.once&&!this.cue.pre&&this.startIsAligned&&(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&.025>Math.abs(this.resumeOffset-this.duration)))}set appendInPlace(t){if(this.appendInPlaceStarted){this.resetOnResume=!t;return}this.appendInPlaceDisabled=!t}get timelineStart(){return null!==this._timelineStart?this._timelineStart:this.startTime}set timelineStart(t){this._timelineStart=t}get duration(){let t,e=this.playoutLimit;return t=null!==this._duration?this._duration:this.dateRange.duration?this.dateRange.duration:this.dateRange.plannedDuration||0,!isNaN(e)&&e<t&&(t=e),t}set duration(t){this._duration=t}get cue(){return this.dateRange.cue}get timelineOccupancy(){return"RANGE"===this.dateRange.attr["X-TIMELINE-OCCUPIES"]?s8.Range:s8.Point}get supplementsPrimary(){return"PRIMARY"===this.dateRange.attr["X-TIMELINE-STYLE"]}get contentMayVary(){return"NO"!==this.dateRange.attr["X-CONTENT-MAY-VARY"]}get assetUrl(){return this.dateRange.attr["X-ASSET-URI"]}get assetListUrl(){return this.dateRange.attr["X-ASSET-LIST"]}get baseUrl(){return this.base.url}get assetListLoaded(){return this.assetList.length>0||null!==this.assetListResponse}toString(){var t;return t=this,`["${t.identifier}" ${t.cue.pre?"<pre>":t.cue.post?"<post>":""}${t.timelineStart.toFixed(2)}-${t.resumeTime.toFixed(2)}]`}}function s9(t,e){return t-e.start<e.duration/2&&!(.025>Math.abs(t-(e.start+e.duration)))?e.start:e.start+e.duration}function s7(t,e,i){let s=new self.URL(t,i);return"data:"!==s.protocol&&s.searchParams.set("_HLS_primary_id",e),s}function rt(t,e){for(;null!=(i=t.assetList[++e])&&i.error;)var i;return e}function re(t){let e=t.timelineStart,i=t.duration||0;return`["${t.identifier}" ${e.toFixed(2)}-${(e+i).toFixed(2)}]`}class ri{constructor(t,e,i,s){this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=!1,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=()=>{this.reachedPlayout(this.currentTime)&&this.hls.trigger(h.PLAYOUT_LIMIT_REACHED,{})};let r=this.hls=new t(e);this.interstitial=i,this.assetItem=s;let a=s.uri;try{a=s7(a,e.primarySessionId).href}catch(t){}r.loadSource(a);let n=()=>{this.hasDetails=!0};r.once(h.LEVEL_LOADED,n),r.once(h.AUDIO_TRACK_LOADED,n),r.once(h.SUBTITLE_TRACK_LOADED,n),r.on(h.MEDIA_ATTACHING,(t,{media:e})=>{this.removeMediaListeners(),this.mediaAttached=e,this.interstitial.playoutLimit&&(e.addEventListener("timeupdate",this.checkPlayout),this.appendInPlace&&r.on(h.BUFFER_APPENDED,()=>{let t=this.bufferedEnd;this.reachedPlayout(t)&&(this._bufferedEosTime=t,r.trigger(h.BUFFERED_TO_END,void 0))}))})}get appendInPlace(){var t;return(null==(t=this.interstitial)?void 0:t.appendInPlace)||!1}bufferedInPlaceToEnd(t){var e;if(!this.appendInPlace)return!1;if(null!=(e=this.hls)&&e.bufferedToEnd)return!0;if(!t||!this._bufferedEosTime)return!1;let i=this.timelineOffset,s=em.bufferInfo(t,i,0);return this.getAssetTime(s.end)>=this._bufferedEosTime-.02}reachedPlayout(t){let e=this.interstitial.playoutLimit;return this.startOffset+t>=e}get destroyed(){var t;return!(null!=(t=this.hls)&&t.userConfig)}get assetId(){return this.assetItem.identifier}get interstitialId(){return this.assetItem.parentIdentifier}get media(){var t;return(null==(t=this.hls)?void 0:t.media)||null}get bufferedEnd(){let t=this.media||this.mediaAttached;if(!t)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;let e=em.bufferInfo(t,t.currentTime,.001);return this.getAssetTime(e.end)}get currentTime(){let t=this.media||this.mediaAttached;return t?this.getAssetTime(t.currentTime):this._currentTime||0}get duration(){let t=this.assetItem.duration;return t||0}get remaining(){let t=this.duration;return t?Math.max(0,t-this.currentTime):0}get startOffset(){return this.assetItem.startOffset}get timelineOffset(){var t;return(null==(t=this.hls)?void 0:t.config.timelineOffset)||0}set timelineOffset(t){let e=this.timelineOffset;if(t!==e&&Math.abs(t-e)>1/9e4){if(this.hasDetails)throw Error("Cannot set timelineOffset after playlists are loaded");this.hls.config.timelineOffset=t}}getAssetTime(t){return Math.min(Math.max(0,t-this.timelineOffset),this.duration)}removeMediaListeners(){let t=this.mediaAttached;t&&(this._currentTime=t.currentTime,this.bufferSnapShot(),t.removeEventListener("timeupdate",this.checkPlayout))}bufferSnapShot(){if(this.mediaAttached){var t;null!=(t=this.hls)&&t.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd)}}destroy(){this.removeMediaListeners(),this.hls.destroy(),this.hls=this.interstitial=null,this.tracks=this.mediaAttached=this.checkPlayout=null}attachMedia(t){this.hls.attachMedia(t)}detachMedia(){this.removeMediaListeners(),this.mediaAttached=null,this.hls.detachMedia()}resumeBuffering(){this.hls.resumeBuffering()}pauseBuffering(){this.hls.pauseBuffering()}transferMedia(){return this.bufferSnapShot(),this.hls.transferMedia()}resetDetails(){let t=this.hls;if(this.hasDetails){t.stopLoad();let e=t=>delete t.details;t.levels.forEach(e),t.allAudioTracks.forEach(e),t.allSubtitleTracks.forEach(e),this.hasDetails=!1}}on(t,e,i){this.hls.on(t,e)}once(t,e,i){this.hls.once(t,e)}off(t,e,i){this.hls.off(t,e)}toString(){var t;return`HlsAssetPlayer: ${re(this.assetItem)} ${null==(t=this.hls)?void 0:t.sessionId} ${this.appendInPlace?"append-in-place":""}`}}class rs extends P{constructor(t,e){super("interstitials-sched",e),this.onScheduleUpdate=void 0,this.eventMap={},this.events=null,this.items=null,this.durations={primary:0,playout:0,integrated:0},this.onScheduleUpdate=t}destroy(){this.reset(),this.onScheduleUpdate=null}reset(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(t=>t.reset()),this.events=this.items=null}resetErrorsInRange(t,e){return this.events?this.events.reduce((i,s)=>t<=s.startOffset&&e>s.startOffset?(delete s.error,i+1):i,0):0}get duration(){let t=this.items;return t?t[t.length-1].end:0}get length(){return this.items?this.items.length:0}getEvent(t){return t&&this.eventMap[t]||null}hasEvent(t){return t in this.eventMap}findItemIndex(t,e){if(t.event)return this.findEventIndex(t.event.identifier);let i=-1;t.nextEvent?i=this.findEventIndex(t.nextEvent.identifier)-1:t.previousEvent&&(i=this.findEventIndex(t.previousEvent.identifier)+1);let s=this.items;if(s)for(s[i]||(void 0===e&&(e=t.start),i=this.findItemIndexAtTime(e));i>=0&&null!=(r=s[i])&&r.event;){var r;i--}return i}findItemIndexAtTime(t,e){let i=this.items;if(i)for(let s=0;s<i.length;s++){let r=i[s];if(e&&"primary"!==e&&(r=r[e]),t===r.start||t>r.start&&t<r.end)return s}return -1}findJumpRestrictedIndex(t,e){let i=this.items;if(i)for(let s=t;s<=e&&i[s];s++){let t=i[s].event;if(null!=t&&t.restrictions.jump&&!t.appendInPlace)return s}return -1}findEventIndex(t){let e=this.items;if(e)for(let s=e.length;s--;){var i;if((null==(i=e[s].event)?void 0:i.identifier)===t)return s}return -1}findAssetIndex(t,e){let i=t.assetList,s=i.length;if(s>1)for(let t=0;t<s;t++){let s=i[t];if(!s.error){let i=s.timelineStart;if(e===i||e>i&&e<i+(s.duration||0))return t}}return 0}get assetIdAtEnd(){var t,e;let i=null==(t=this.items)||null==(e=t[this.length-1])?void 0:e.event;if(i){let t=i.assetList,e=t[t.length-1];if(e)return e.identifier}return null}parseInterstitialDateRanges(t,e){let i=t.main.details,{dateRanges:s}=i,r=this.events,a=this.parseDateRanges(s,{url:i.url},e),n=Object.keys(s),l=r?r.filter(t=>!n.includes(t.identifier)):[];a.length&&a.sort((t,e)=>{let i=t.cue.pre,s=t.cue.post,r=e.cue.pre,a=e.cue.post;if(i&&!r)return -1;if(r&&!i||s&&!a)return 1;if(a&&!s)return -1;if(!i&&!r&&!s&&!a){let i=t.startTime,s=e.startTime;if(i!==s)return i-s}return t.dateRange.tagOrder-e.dateRange.tagOrder}),this.events=a,l.forEach(t=>{this.removeEvent(t)}),this.updateSchedule(t,l)}updateSchedule(t,e=[]){let i=this.events||[];if(i.length||e.length||this.length<2){let s=this.items,r=this.parseSchedule(i,t);(e.length||(null==s?void 0:s.length)!==r.length||r.some((t,e)=>Math.abs(t.playout.start-s[e].playout.start)>.005||Math.abs(t.playout.end-s[e].playout.end)>.005))&&(this.items=r,this.onScheduleUpdate(e,s))}}parseDateRanges(t,e,i){let s=[],r=Object.keys(t);for(let a=0;a<r.length;a++){let n=r[a],l=t[n];if(l.isInterstitial){let t=this.eventMap[n];t?t.setDateRange(l):(t=new s6(l,e),this.eventMap[n]=t,!1===i&&(t.appendInPlace=i)),s.push(t)}}return s}parseSchedule(t,e){let i=[],s=e.main.details,r=s.live?1/0:s.edge,a=0;if((t=t.filter(t=>!t.error&&!(t.cue.once&&t.hasPlayed))).length){this.resolveOffsets(t,e);let s=0,l=0;if(t.forEach((e,n)=>{let o=e.cue.pre,h=e.cue.post,d=t[n-1]||null,u=e.appendInPlace,c=h?r:e.startOffset,f=e.duration,g=e.timelineOccupancy===s8.Range?f:0,p=e.resumptionOffset,m=(null==d?void 0:d.startTime)===c,y=c+e.cumulativeDuration,v=u?y+f:c+p;if(o||!h&&c<=0){let t=l;l+=g,e.timelineStart=y;let s=a;a+=f,i.push({event:e,start:y,end:v,playout:{start:s,end:a},integrated:{start:t,end:l}})}else{if(!(c<=r))return;if(!m){let r=c-s;if(r>.033){let o=s,h=l;l+=r;let d=a;a+=r;let u={previousEvent:t[n-1]||null,nextEvent:e,start:o,end:o+r,playout:{start:d,end:a},integrated:{start:h,end:l}};i.push(u)}else r>0&&d&&(d.cumulativeDuration+=r,i[i.length-1].end=c)}h&&(v=y),e.timelineStart=y;let o=l;l+=g;let u=a;a+=f,i.push({event:e,start:y,end:v,playout:{start:u,end:a},integrated:{start:o,end:l}})}let E=e.resumeTime;s=h||E>r?r:E}),s<r){var n;let t=s,e=l,o=r-s;l+=o;let h=a;a+=o,i.push({previousEvent:(null==(n=i[i.length-1])?void 0:n.event)||null,nextEvent:null,start:s,end:t+o,playout:{start:h,end:a},integrated:{start:e,end:l}})}this.setDurations(r,a,l)}else i.push({previousEvent:null,nextEvent:null,start:0,end:r,playout:{start:0,end:r},integrated:{start:0,end:r}}),this.setDurations(r,r,r);return i}setDurations(t,e,i){this.durations={primary:t,playout:e,integrated:i}}resolveOffsets(t,e){let i=e.main.details,s=i.live?1/0:i.edge,a=0,n=-1;t.forEach((l,o)=>{let h=l.cue.pre,d=l.cue.post,u=h?0:d?s:l.startTime;this.updateAssetDurations(l),n===u?l.cumulativeDuration=a:(a=0,n=u),!d&&l.snapOptions.in&&(l.resumeAnchor=tQ(null,i.fragments,l.startOffset+l.resumptionOffset,0,0)||void 0),l.appendInPlace&&!l.appendInPlaceStarted&&(this.primaryCanResumeInPlaceAt(l,e)||(l.appendInPlace=!1)),!l.appendInPlace&&o+1<t.length&&t[o+1].startTime-t[o].resumeTime<.033&&(t[o+1].appendInPlace=!1,t[o+1].appendInPlace&&this.warn(`Could not change append strategy for abutting event ${l}`));let c=r(l.resumeOffset)?l.resumeOffset:l.duration;a+=c})}primaryCanResumeInPlaceAt(t,e){let i=t.resumeTime,s=t.startTime+t.resumptionOffset;return Math.abs(i-s)>.025?(this.log(`"${t.identifier}" resumption ${i} not aligned with estimated timeline end ${s}`),!1):e?!Object.keys(e).some(s=>{let r=e[s].details,a=r.edge;if(i>=a)return this.log(`"${t.identifier}" resumption ${i} past ${s} playlist end ${a}`),!1;let n=tQ(null,r.fragments,i);if(!n)return this.log(`"${t.identifier}" resumption ${i} does not align with any fragments in ${s} playlist (${r.fragStart}-${r.fragmentEnd})`),!0;let l=.175*("audio"===s);return!(Math.abs(n.start-i)<.025+l||Math.abs(n.end-i)<.025+l)&&(this.log(`"${t.identifier}" resumption ${i} not aligned with ${s} fragment bounds (${n.start}-${n.end} sn: ${n.sn} cc: ${n.cc})`),!0)}):(this.log(`"${t.identifier}" resumption ${i} can not be aligned with media (none selected)`),!1)}updateAssetDurations(t){if(!t.assetListLoaded)return;let e=t.timelineStart,i=0,s=!1,r=!1;t.assetList.forEach((t,a)=>{let n=e+i;t.startOffset=i,t.timelineStart=n,s||(s=null===t.duration),r||(r=!!t.error);let l=t.error?0:t.duration||0;i+=l}),s&&!r?t.duration=Math.max(i,t.duration):t.duration=i}removeEvent(t){t.reset(),delete this.eventMap[t.identifier]}}function rr(t){return`[${t.event?'"'+t.event.identifier+'"':"primary"}: ${t.start.toFixed(2)}-${t.end.toFixed(2)}]`}class ra{constructor(t){this.hls=void 0,this.hls=t}destroy(){this.hls=null}loadAssetList(t,e){let i,s=t.assetListUrl;try{i=s7(s,this.hls.sessionId,t.baseUrl)}catch(i){let e=this.assignAssetListError(t,o.ASSET_LIST_LOAD_ERROR,i,s);this.hls.trigger(h.ERROR,e);return}e&&"data:"!==i.protocol&&i.searchParams.set("_HLS_start_offset",""+e);let r=this.hls.config,a=new r.loader(r),n={responseType:"json",url:i.href},l=r.interstitialAssetListLoadPolicy.default,d={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0};return a.load(n,d,{onSuccess:(e,i,s,r)=>{let a=e.data;if(!Array.isArray(null==a?void 0:a.ASSETS)){let e=this.assignAssetListError(t,o.ASSET_LIST_PARSING_ERROR,Error("Invalid interstitial asset list"),s.url,i,r);this.hls.trigger(h.ERROR,e);return}t.assetListResponse=a,this.hls.trigger(h.ASSET_LIST_LOADED,{event:t,assetListResponse:a,networkDetails:r})},onError:(e,i,s,r)=>{let a=this.assignAssetListError(t,o.ASSET_LIST_LOAD_ERROR,Error(`Error loading X-ASSET-LIST: HTTP status ${e.code} ${e.text} (${i.url})`),i.url,r,s);this.hls.trigger(h.ERROR,a)},onTimeout:(e,i,s)=>{let r=this.assignAssetListError(t,o.ASSET_LIST_LOAD_TIMEOUT,Error(`Timeout loading X-ASSET-LIST (${i.url})`),i.url,e,s);this.hls.trigger(h.ERROR,r)}}),this.hls.trigger(h.ASSET_LIST_LOADING,{event:t}),a}assignAssetListError(t,e,i,s,r,a){return t.error=i,{type:l.NETWORK_ERROR,details:e,fatal:!1,interstitial:t,url:s,error:i,networkDetails:a,stats:r}}}function rn(t){null==t||t.play().catch(()=>{})}class rl{constructor(t){this.buffered=void 0;let e=(e,i,s)=>{if((i>>>=0)>s-1)throw new DOMException(`Failed to execute '${e}' on 'TimeRanges': The index provided (${i}) is greater than the maximum bound (${s})`);return t[i][e]};this.buffered={get length(){return t.length},end:i=>e("end",i,t.length),start:i=>e("start",i,t.length)}}}const ro={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},rh=t=>String.fromCharCode(ro[t]||t),rd={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},ru={17:2,18:4,21:6,22:8,23:10,19:13,20:15},rc={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},rf={25:2,26:4,29:6,30:8,31:10,27:13,28:15},rg=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class rp{constructor(){this.time=null,this.verboseLevel=0}log(t,e){if(this.verboseLevel>=t){let i="function"==typeof e?e():e;F.log(`${this.time} [${t}] ${i}`)}}}const rm=function(t){let e=[];for(let i=0;i<t.length;i++)e.push(t[i].toString(16));return e};class ry{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(t){let e=["foreground","underline","italics","background","flash"];for(let i=0;i<e.length;i++){let s=e[i];t.hasOwnProperty(s)&&(this[s]=t[s])}}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(t){return this.foreground===t.foreground&&this.underline===t.underline&&this.italics===t.italics&&this.background===t.background&&this.flash===t.flash}copy(t){this.foreground=t.foreground,this.underline=t.underline,this.italics=t.italics,this.background=t.background,this.flash=t.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class rv{constructor(){this.uchar=" ",this.penState=new ry}reset(){this.uchar=" ",this.penState.reset()}setChar(t,e){this.uchar=t,this.penState.copy(e)}setPenState(t){this.penState.copy(t)}equals(t){return this.uchar===t.uchar&&this.penState.equals(t.penState)}copy(t){this.uchar=t.uchar,this.penState.copy(t.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}}class rE{constructor(t){this.chars=[],this.pos=0,this.currPenState=new ry,this.cueStartTime=null,this.logger=void 0;for(let t=0;t<100;t++)this.chars.push(new rv);this.logger=t}equals(t){for(let e=0;e<100;e++)if(!this.chars[e].equals(t.chars[e]))return!1;return!0}copy(t){for(let e=0;e<100;e++)this.chars[e].copy(t.chars[e])}isEmpty(){let t=!0;for(let e=0;e<100;e++)if(!this.chars[e].isEmpty()){t=!1;break}return t}setCursor(t){this.pos!==t&&(this.pos=t),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>100&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=100)}moveCursor(t){let e=this.pos+t;if(t>1)for(let t=this.pos+1;t<e+1;t++)this.chars[t].setPenState(this.currPenState);this.setCursor(e)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(t){t>=144&&this.backSpace();let e=rh(t);if(this.pos>=100)return void this.logger.log(0,()=>"Cannot insert "+t.toString(16)+" ("+e+") at position "+this.pos+". Skipping it!");this.chars[this.pos].setChar(e,this.currPenState),this.moveCursor(1)}clearFromPos(t){let e;for(e=t;e<100;e++)this.chars[e].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){let t=[],e=!0;for(let i=0;i<100;i++){let s=this.chars[i].uchar;" "!==s&&(e=!1),t.push(s)}return e?"":t.join("")}setPenStyles(t){this.currPenState.setStyles(t),this.chars[this.pos].setPenState(this.currPenState)}}class rT{constructor(t){this.rows=[],this.currRow=14,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let e=0;e<15;e++)this.rows.push(new rE(t));this.logger=t}reset(){for(let t=0;t<15;t++)this.rows[t].clear();this.currRow=14}equals(t){let e=!0;for(let i=0;i<15;i++)if(!this.rows[i].equals(t.rows[i])){e=!1;break}return e}copy(t){for(let e=0;e<15;e++)this.rows[e].copy(t.rows[e])}isEmpty(){let t=!0;for(let e=0;e<15;e++)if(!this.rows[e].isEmpty()){t=!1;break}return t}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(t){this.rows[this.currRow].insertChar(t)}setPen(t){this.rows[this.currRow].setPenStyles(t)}moveCursor(t){this.rows[this.currRow].moveCursor(t)}setCursor(t){this.logger.log(2,"setCursor: "+t),this.rows[this.currRow].setCursor(t)}setPAC(t){this.logger.log(2,()=>"pacData = "+tG(t));let e=t.row-1;if(this.nrRollUpRows&&e<this.nrRollUpRows-1&&(e=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==e){for(let t=0;t<15;t++)this.rows[t].clear();let t=this.currRow+1-this.nrRollUpRows,i=this.lastOutputScreen;if(i){let s=i.rows[t].cueStartTime,r=this.logger.time;if(null!==s&&null!==r&&s<r)for(let s=0;s<this.nrRollUpRows;s++)this.rows[e-this.nrRollUpRows+s+1].copy(i.rows[t+s])}}this.currRow=e;let i=this.rows[this.currRow];if(null!==t.indent){let e=Math.max(t.indent-1,0);i.setCursor(t.indent),t.color=i.chars[e].penState.foreground}let s={foreground:t.color,underline:t.underline,italics:t.italics,background:"black",flash:!1};this.setPen(s)}setBkgData(t){this.logger.log(2,()=>"bkgData = "+tG(t)),this.backSpace(),this.setPen(t),this.insertChar(32)}setRollUpRows(t){this.nrRollUpRows=t}rollUp(){if(null===this.nrRollUpRows)return void this.logger.log(3,"roll_up but nrRollUpRows not set yet");this.logger.log(1,()=>this.getDisplayText());let t=this.currRow+1-this.nrRollUpRows,e=this.rows.splice(t,1)[0];e.clear(),this.rows.splice(this.currRow,0,e),this.logger.log(2,"Rolling up")}getDisplayText(t){t=t||!1;let e=[],i="",s=-1;for(let i=0;i<15;i++){let r=this.rows[i].getTextString();r&&(s=i+1,t?e.push("Row "+s+": '"+r+"'"):e.push(r.trim()))}return e.length>0&&(i=t?"["+e.join(" | ")+"]":e.join("\n")),i}getTextAndFormat(){return this.rows}}class rb{constructor(t,e,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=t,this.outputFilter=e,this.mode=null,this.verbose=0,this.displayedMemory=new rT(i),this.nonDisplayedMemory=new rT(i),this.lastOutputScreen=new rT(i),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(t){this.outputFilter=t}setPAC(t){this.writeScreen.setPAC(t)}setBkgData(t){this.writeScreen.setBkgData(t)}setMode(t){t!==this.mode&&(this.mode=t,this.logger.log(2,()=>"MODE="+t),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=t)}insertChars(t){for(let e=0;e<t.length;e++)this.writeScreen.insertChar(t[e]);let e=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>e+": "+this.writeScreen.getDisplayText(!0)),("MODE_PAINT-ON"===this.mode||"MODE_ROLL-UP"===this.mode)&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(t){this.logger.log(2,"RU("+t+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(t)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){let t=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=t,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(t){this.logger.log(2,"TO("+t+") - Tab Offset"),this.writeScreen.moveCursor(t)}ccMIDROW(t){let e={flash:!1};(e.underline=t%2==1,e.italics=t>=46,e.italics)?e.foreground="white":e.foreground=["white","green","blue","cyan","red","yellow","magenta"][Math.floor(t/2)-16],this.logger.log(2,"MIDROW: "+tG(e)),this.writeScreen.setPen(e)}outputDataUpdate(t=!1){let e=this.logger.time;null!==e&&this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,e,this.lastOutputScreen),t&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:e):this.cueStartTime=e,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(t){this.outputFilter&&!this.displayedMemory.isEmpty()&&(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,t,this.displayedMemory),this.cueStartTime=t)}}class rS{constructor(t,e,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory={a:null,b:null},this.logger=void 0;let s=this.logger=new rp;this.channels=[null,new rb(t,e,s),new rb(t+1,i,s)]}getHandler(t){return this.channels[t].getHandler()}setHandler(t,e){this.channels[t].setHandler(e)}addData(t,e){this.logger.time=t;for(let t=0;t<e.length;t+=2){var i,s,r,a,n,l,o,h,d,u,c,f;let g=127&e[t],p=127&e[t+1],m=!1,y=null;if(0===g&&0===p)continue;this.logger.log(3,()=>"["+rm([e[t],e[t+1]])+"] -> ("+rm([g,p])+")");let v=this.cmdHistory;if(g>=16&&g<=31){if(i=g,s=p,(r=v).a===i&&r.b===s){a=null,n=null,(l=v).a=null,l.b=null,this.logger.log(3,()=>"Repeated command ("+rm([g,p])+") is dropped");continue}o=g,h=p,(d=this.cmdHistory).a=o,d.b=h,(m=this.parseCmd(g,p))||(m=this.parseMidrow(g,p)),m||(m=this.parsePAC(g,p)),m||(m=this.parseBackgroundAttributes(g,p))}else{u=null,c=null,(f=v).a=null,f.b=null}if(!m&&(y=this.parseChars(g,p))){let t=this.currentChannel;t&&t>0?this.channels[t].insertChars(y):this.logger.log(2,"No channel found yet. TEXT-MODE?")}m||y||this.logger.log(2,()=>"Couldn't parse cleaned data "+rm([g,p])+" orig: "+rm([e[t],e[t+1]]))}}parseCmd(t,e){if(!((20===t||28===t||21===t||29===t)&&e>=32&&e<=47||(23===t||31===t)&&e>=33&&e<=35))return!1;let i=20===t||21===t||23===t?1:2,s=this.channels[i];return 20===t||21===t||28===t||29===t?32===e?s.ccRCL():33===e?s.ccBS():34===e?s.ccAOF():35===e?s.ccAON():36===e?s.ccDER():37===e?s.ccRU(2):38===e?s.ccRU(3):39===e?s.ccRU(4):40===e?s.ccFON():41===e?s.ccRDC():42===e?s.ccTR():43===e?s.ccRTD():44===e?s.ccEDM():45===e?s.ccCR():46===e?s.ccENM():47===e&&s.ccEOC():s.ccTO(e-32),this.currentChannel=i,!0}parseMidrow(t,e){let i=0;if((17===t||25===t)&&e>=32&&e<=47){if((i=17===t?1:2)!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;let s=this.channels[i];return!!s&&(s.ccMIDROW(e),this.logger.log(3,()=>"MIDROW ("+rm([t,e])+")"),!0)}return!1}parsePAC(t,e){let i,s=(t>=17&&t<=23||t>=25&&t<=31)&&e>=64&&e<=127,r=(16===t||24===t)&&e>=64&&e<=95;if(!(s||r))return!1;let a=t<=23?1:2;i=e>=64&&e<=95?1===a?rd[t]:rc[t]:1===a?ru[t]:rf[t];let n=this.channels[a];return!!n&&(n.setPAC(this.interpretPAC(i,e)),this.currentChannel=a,!0)}interpretPAC(t,e){let i,s={color:null,italics:!1,indent:null,underline:!1,row:t};return s.underline=(1&(i=e>95?e-96:e-64))==1,i<=13?s.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(s.italics=!0,s.color="white"):s.indent=4*Math.floor((i-16)/2),s}parseChars(t,e){let i,s=null,r=null;if(t>=25?(i=2,r=t-8):(i=1,r=t),r>=17&&r<=19){let t;t=17===r?e+80:18===r?e+112:e+144,this.logger.log(2,()=>"Special char '"+rh(t)+"' in channel "+i),s=[t]}else t>=32&&t<=127&&(s=0===e?[t]:[t,e]);return s&&this.logger.log(3,()=>"Char codes =  "+rm(s).join(",")),s}parseBackgroundAttributes(t,e){if(!((16===t||24===t)&&e>=32&&e<=47||(23===t||31===t)&&e>=45&&e<=47))return!1;let i={};return 16===t||24===t?(i.background=rg[Math.floor((e-32)/2)],e%2==1&&(i.background=i.background+"_semi")):45===e?i.background="transparent":(i.foreground="black",47===e&&(i.underline=!0)),this.channels[t<=23?1:2].setBkgData(i),!0}reset(){var t,e,i;for(let t=0;t<Object.keys(this.channels).length;t++){let e=this.channels[t];e&&e.reset()}t=null,e=null,(i=this.cmdHistory).a=null,i.b=null}cueSplitAtTime(t){for(let e=0;e<this.channels.length;e++){let i=this.channels[e];i&&i.cueSplitAtTime(t)}}}var rA=function(){if(null!=eD&&eD.VTTCue)return self.VTTCue;let t=["","lr","rl"],e=["start","middle","end","left","right"];function i(t,e){if("string"!=typeof e||!Array.isArray(t))return!1;let i=e.toLowerCase();return!!~t.indexOf(i)&&i}function s(t,...e){let i=1;for(;i<arguments.length;i++){let e=arguments[i];for(let i in e)t[i]=e[i]}return t}function r(r,a,n){let l={enumerable:!0};this.hasBeenReset=!1;let o="",h=!1,d=r,u=a,c=n,f=null,g="",p=!0,m="auto",y="start",v=50,E="middle",T=50,b="middle";Object.defineProperty(this,"id",s({},l,{get:function(){return o},set:function(t){o=""+t}})),Object.defineProperty(this,"pauseOnExit",s({},l,{get:function(){return h},set:function(t){h=!!t}})),Object.defineProperty(this,"startTime",s({},l,{get:function(){return d},set:function(t){if("number"!=typeof t)throw TypeError("Start time must be set to a number.");d=t,this.hasBeenReset=!0}})),Object.defineProperty(this,"endTime",s({},l,{get:function(){return u},set:function(t){if("number"!=typeof t)throw TypeError("End time must be set to a number.");u=t,this.hasBeenReset=!0}})),Object.defineProperty(this,"text",s({},l,{get:function(){return c},set:function(t){c=""+t,this.hasBeenReset=!0}})),Object.defineProperty(this,"region",s({},l,{get:function(){return f},set:function(t){f=t,this.hasBeenReset=!0}})),Object.defineProperty(this,"vertical",s({},l,{get:function(){return g},set:function(e){let s=i(t,e);if(!1===s)throw SyntaxError("An invalid or illegal string was specified.");g=s,this.hasBeenReset=!0}})),Object.defineProperty(this,"snapToLines",s({},l,{get:function(){return p},set:function(t){p=!!t,this.hasBeenReset=!0}})),Object.defineProperty(this,"line",s({},l,{get:function(){return m},set:function(t){if("number"!=typeof t&&"auto"!==t)throw SyntaxError("An invalid number or illegal string was specified.");m=t,this.hasBeenReset=!0}})),Object.defineProperty(this,"lineAlign",s({},l,{get:function(){return y},set:function(t){let s=i(e,t);if(!s)throw SyntaxError("An invalid or illegal string was specified.");y=s,this.hasBeenReset=!0}})),Object.defineProperty(this,"position",s({},l,{get:function(){return v},set:function(t){if(t<0||t>100)throw Error("Position must be between 0 and 100.");v=t,this.hasBeenReset=!0}})),Object.defineProperty(this,"positionAlign",s({},l,{get:function(){return E},set:function(t){let s=i(e,t);if(!s)throw SyntaxError("An invalid or illegal string was specified.");E=s,this.hasBeenReset=!0}})),Object.defineProperty(this,"size",s({},l,{get:function(){return T},set:function(t){if(t<0||t>100)throw Error("Size must be between 0 and 100.");T=t,this.hasBeenReset=!0}})),Object.defineProperty(this,"align",s({},l,{get:function(){return b},set:function(t){let s=i(e,t);if(!s)throw SyntaxError("An invalid or illegal string was specified.");b=s,this.hasBeenReset=!0}})),this.displayState=void 0}return r.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},r}();class r_{decode(t,e){if(!t)return"";if("string"!=typeof t)throw Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(t))}}function rx(t){function e(t,e,i,s){return(0|t)*3600+(0|e)*60+(0|i)+parseFloat(s||0)}let i=t.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return i?parseFloat(i[2])>59?e(i[2],i[3],0,i[4]):e(i[1],i[2],i[3],i[4]):null}class rL{constructor(){this.values=Object.create(null)}set(t,e){this.get(t)||""===e||(this.values[t]=e)}get(t,e,i){return i?this.has(t)?this.values[t]:e[i]:this.has(t)?this.values[t]:e}has(t){return t in this.values}alt(t,e,i){for(let s=0;s<i.length;++s)if(e===i[s]){this.set(t,e);break}}integer(t,e){/^-?\d+$/.test(e)&&this.set(t,parseInt(e,10))}percent(t,e){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(e)){let i=parseFloat(e);if(i>=0&&i<=100)return this.set(t,i),!0}return!1}}function rI(t,e,i,s){let r=s?t.split(s):[t];for(let t in r){if("string"!=typeof r[t])continue;let s=r[t].split(i);if(2===s.length)e(s[0],s[1])}}const rR=new rA(0,0,""),rD="middle"===rR.align?"middle":"center";function rk(t){return t.replace(/<br(?: \/)?>/gi,"\n")}class rP{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new r_,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(t){let e=this;function i(){let t=e.buffer,i=0;for(t=rk(t);i<t.length&&"\r"!==t[i]&&"\n"!==t[i];)++i;let s=t.slice(0,i);return"\r"===t[i]&&++i,"\n"===t[i]&&++i,e.buffer=t.slice(i),s}t&&(e.buffer+=e.decoder.decode(t,{stream:!0}));try{let t="";if("INITIAL"===e.state){if(!/\r\n|\n/.test(e.buffer))return this;let s=(t=i()).match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(!(null!=s&&s[0]))throw Error("Malformed WebVTT signature.");e.state="HEADER"}let r=!1;for(;e.buffer&&/\r\n|\n/.test(e.buffer);)switch(r?r=!1:t=i(),e.state){case"HEADER":if(/:/.test(t)){var s;s=t,rI(s,function(t,e){},/:/)}else t||(e.state="ID");continue;case"NOTE":t||(e.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(t)){e.state="NOTE";break}if(!t)continue;if(e.cue=new rA(0,0,""),e.state="CUE",-1===t.indexOf("--\x3e")){e.cue.id=t;continue}case"CUE":if(!e.cue){e.state="BADCUE";continue}try{!function(t,e,i){let s=t;function r(){let e=rx(t);if(null===e)throw Error("Malformed timestamp: "+s);return t=t.replace(/^[^\sa-zA-Z-]+/,""),e}function a(){t=t.replace(/^\s+/,"")}if(a(),e.startTime=r(),a(),"--\x3e"!==t.slice(0,3))throw Error("Malformed time stamp (time stamps must be separated by '--\x3e'): "+s);t=t.slice(3),a(),e.endTime=r(),a();var n=t;let l=new rL;rI(n,function(t,e){let s;switch(t){case"region":for(let s=i.length-1;s>=0;s--)if(i[s].id===e){l.set(t,i[s].region);break}break;case"vertical":l.alt(t,e,["rl","lr"]);break;case"line":s=e.split(","),l.integer(t,s[0]),l.percent(t,s[0])&&l.set("snapToLines",!1),l.alt(t,s[0],["auto"]),2===s.length&&l.alt("lineAlign",s[1],["start",rD,"end"]);break;case"position":s=e.split(","),l.percent(t,s[0]),2===s.length&&l.alt("positionAlign",s[1],["start",rD,"end","line-left","line-right","auto"]);break;case"size":l.percent(t,e);break;case"align":l.alt(t,e,["start",rD,"end","left","right"])}},/:/,/\s/),e.region=l.get("region",null),e.vertical=l.get("vertical","");let o=l.get("line","auto");"auto"===o&&-1===rR.line&&(o=-1),e.line=o,e.lineAlign=l.get("lineAlign","start"),e.snapToLines=l.get("snapToLines",!0),e.size=l.get("size",100),e.align=l.get("align",rD);let h=l.get("position","auto");"auto"===h&&50===rR.position&&(h="start"===e.align||"left"===e.align?0:"end"===e.align||"right"===e.align?100:50),e.position=h}(t,e.cue,e.regionList)}catch(t){e.cue=null,e.state="BADCUE";continue}e.state="CUETEXT";continue;case"CUETEXT":{let i=-1!==t.indexOf("--\x3e");if(!t||i&&(r=!0)){e.oncue&&e.cue&&e.oncue(e.cue),e.cue=null,e.state="ID";continue}if(null===e.cue)continue;e.cue.text&&(e.cue.text+="\n"),e.cue.text+=t}continue;case"BADCUE":t||(e.state="ID")}}catch(t){"CUETEXT"===e.state&&e.cue&&e.oncue&&e.oncue(e.cue),e.cue=null,e.state="INITIAL"===e.state?"BADWEBVTT":"BADCUE"}return this}flush(){try{if((this.cue||"HEADER"===this.state)&&(this.buffer+="\n\n",this.parse()),"INITIAL"===this.state||"BADWEBVTT"===this.state)throw Error("Malformed WebVTT signature.")}catch(t){this.onparsingerror&&this.onparsingerror(t)}return this.onflush&&this.onflush(),this}}const rC=/\r\n|\n\r|\n|\r/g,rM=function(t,e,i=0){return t.slice(i,i+e.length)===e},rw=function(t){let e=parseInt(t.slice(-3)),i=parseInt(t.slice(-6,-4)),s=parseInt(t.slice(-9,-7)),a=t.length>9?parseInt(t.substring(0,t.indexOf(":"))):0;if(!r(e)||!r(i)||!r(s)||!r(a))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${t}`);return e+=1e3*i,e+=6e4*s,e+=36e5*a};function rO(t,e,i){return s4(t.toString())+s4(e.toString())+s4(i)}const rF=function(t,e,i){let s=t[e],r=t[s.prevCC];if(!r||!r.new&&s.new){t.ccOffset=t.presentationOffset=s.start,s.new=!1;return}for(;null!=(a=r)&&a.new;){var a;t.ccOffset+=s.start-r.start,s.new=!1,r=t[(s=r).prevCC]}t.presentationOffset=i},rN="stpp.ttml.im1t",rB=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,rU=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,r$={left:"start",center:"center",right:"end",start:"start",end:"end"};function rG(t,e,i,s){let r=ts(new Uint8Array(t),["mdat"]);if(0===r.length)return void s(Error("Could not parse IMSC1 mdat"));let a=r.map(t=>U(t)),n=function(t,e,i=1,s=!1){return i7(t,1,1/i,s)}(e.baseTime,0,e.timescale);try{a.forEach(t=>i(function(t,e){let i=new DOMParser().parseFromString(t,"text/xml").getElementsByTagName("tt")[0];if(!i)throw Error("Invalid ttml");let s={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},r=Object.keys(s).reduce((t,e)=>(t[e]=i.getAttribute(`ttp:${e}`)||s[e],t),{}),a="preserve"!==i.getAttribute("xml:space"),n=rH(rV(i,"styling","style")),l=rH(rV(i,"layout","region")),o=rV(i,"body","[begin]");return[].map.call(o,t=>{let i=function t(e,i){return[].slice.call(e.childNodes).reduce((e,s,r)=>{var a;return"br"===s.nodeName&&r?e+"\n":null!=(a=s.childNodes)&&a.length?t(s,i):i?e+s.textContent.trim().replace(/\s+/g," "):e+s.textContent},"")}(t,a);if(!i||!t.hasAttribute("begin"))return null;let s=rY(t.getAttribute("begin"),r),o=rY(t.getAttribute("dur"),r),h=rY(t.getAttribute("end"),r);if(null===s)throw rW(t);if(null===h){if(null===o)throw rW(t);h=s+o}let d=new rA(s-e,h-e,i);d.id=rO(d.startTime,d.endTime,d.text);let u=l[t.getAttribute("region")],c=function(t,e,i){let s="http://www.w3.org/ns/ttml#styling",r=null,a=null!=t&&t.hasAttribute("style")?t.getAttribute("style"):null;return a&&i.hasOwnProperty(a)&&(r=i[a]),["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"].reduce((i,a)=>{let n=rK(e,s,a)||rK(t,s,a)||rK(r,s,a);return n&&(i[a]=n),i},{})}(u,n[t.getAttribute("style")],n),{textAlign:f}=c;if(f){let t=r$[f];t&&(d.lineAlign=t),d.align=f}return R(d,c),d}).filter(t=>null!==t)}(t,n)))}catch(t){s(t)}}function rV(t,e,i){let s=t.getElementsByTagName(e)[0];return s?[].slice.call(s.querySelectorAll(i)):[]}function rH(t){return t.reduce((t,e)=>{let i=e.getAttribute("xml:id");return i&&(t[i]=e),t},{})}function rK(t,e,i){return t&&t.hasAttributeNS(e,i)?t.getAttributeNS(e,i):null}function rW(t){return Error(`Could not parse ttml timestamp ${t}`)}function rY(t,e){if(!t)return null;let i=rx(t);return null===i&&(rB.test(t)?i=function(t,e){let i=rB.exec(t),s=(0|i[4])+(0|i[5])/e.subFrameRate;return(0|i[1])*3600+(0|i[2])*60+(0|i[3])+s/e.frameRate}(t,e):rU.test(t)&&(i=function(t,e){let i=rU.exec(t),s=Number(i[1]);switch(i[2]){case"h":return 3600*s;case"m":return 60*s;case"ms":return 1e3*s;case"f":return s/e.frameRate;case"t":return s/e.tickRate}return s}(t,e))),i}class rj{constructor(t,e){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=t,this.trackName=e}dispatchCue(){null!==this.startTime&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(t,e,i){(null===this.startTime||this.startTime>t)&&(this.startTime=t),this.endTime=e,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}function rz(t){return t.characteristics&&/transcribes-spoken-dialog/gi.test(t.characteristics)&&/describes-music-and-sound/gi.test(t.characteristics)?"captions":"subtitles"}function rq(t,e){return!!t&&t.kind===rz(e)&&sb(e,t)}function rX(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}const rQ=/\s/,rZ={newCue(t,e,i,s){let r,a,n,l,o,h=[],d=self.VTTCue||self.TextTrackCue;for(let c=0;c<s.rows.length;c++)if(r=s.rows[c],n=!0,l=0,o="",!r.isEmpty()){var u;for(let t=0;t<r.chars.length;t++)rQ.test(r.chars[t].uchar)&&n?l++:(o+=r.chars[t].uchar,n=!1);r.cueStartTime=e,e===i&&(i+=1e-4),l>=16?l--:l++;let s=rk(o.trim()),f=rO(e,i,s);null!=t&&null!=(u=t.cues)&&u.getCueById(f)||((a=new d(e,i,s)).id=f,a.line=c+1,a.align="left",a.position=10+Math.min(80,10*Math.floor(8*l/32)),h.push(a))}return t&&h.length&&(h.sort((t,e)=>"auto"===t.line||"auto"===e.line?0:t.line>8&&e.line>8?e.line-t.line:t.line-e.line),h.forEach(e=>s1(t,e))),h}},rJ=/(\d+)-(\d+)\/(\d+)/;class r0{constructor(t){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=t.fetchSetup||r1,this.controller=new self.AbortController,this.stats=new H}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var t;this.abortInternal(),null!=(t=this.callbacks)&&t.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(t,e,i){let s=this.stats;if(s.loading.start)throw Error("Loader can only be used once.");s.loading.start=self.performance.now();let a=function(t,e){let i={method:"GET",mode:"cors",credentials:"same-origin",signal:e,headers:new self.Headers(R({},t.headers))};return t.rangeEnd&&i.headers.set("Range","bytes="+t.rangeStart+"-"+String(t.rangeEnd-1)),i}(t,this.controller.signal),n="arraybuffer"===t.responseType,l=n?"byteLength":"length",{maxTimeToFirstByteMs:o,maxLoadTimeMs:h}=e.loadPolicy;this.context=t,this.config=e,this.callbacks=i,this.request=this.fetchSetup(t,a),self.clearTimeout(this.requestTimeout),e.timeout=o&&r(o)?o:h,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(s,t,this.response))},e.timeout),(sf(this.request)?this.request.then(self.fetch):self.fetch(this.request)).then(i=>{var a;this.response=this.loader=i;let l=Math.max(self.performance.now(),s.loading.start);if(self.clearTimeout(this.requestTimeout),e.timeout=h,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(s,t,this.response))},h-(l-s.loading.start)),!i.ok){let{status:t,statusText:e}=i;throw new r2(e||"fetch, bad network response",t,i)}s.loading.first=l,s.total=function(t){let e=t.get("Content-Range");if(e){let t=function(t){let e=rJ.exec(t);if(e)return parseInt(e[2])-parseInt(e[1])+1}(e);if(r(t))return t}let i=t.get("Content-Length");if(i)return parseInt(i)}(i.headers)||s.total;let o=null==(a=this.callbacks)?void 0:a.onProgress;return o&&r(e.highWaterMark)?this.loadProgressively(i,s,t,e.highWaterMark,o):n?i.arrayBuffer():"json"===t.responseType?i.json():i.text()}).then(i=>{var a,n;let o=this.response;if(!o)throw Error("loader destroyed");self.clearTimeout(this.requestTimeout),s.loading.end=Math.max(self.performance.now(),s.loading.first);let h=i[l];h&&(s.loaded=s.total=h);let d={url:o.url,data:i,code:o.status},u=null==(a=this.callbacks)?void 0:a.onProgress;u&&!r(e.highWaterMark)&&u(s,t,i,o),null==(n=this.callbacks)||n.onSuccess(d,s,t,o)}).catch(e=>{var i;if(self.clearTimeout(this.requestTimeout),s.aborted)return;let r=e&&e.code||0,a=e?e.message:null;null==(i=this.callbacks)||i.onError({code:r,text:a},t,e?e.details:null,s)})}getCacheAge(){let t=null;if(this.response){let e=this.response.headers.get("age");t=e?parseFloat(e):null}return t}getResponseHeader(t){return this.response?this.response.headers.get(t):null}loadProgressively(t,e,i,s=0,r){let a=new ig,n=t.body.getReader(),l=()=>n.read().then(n=>{if(n.done)return a.dataLength&&r(e,i,a.flush().buffer,t),Promise.resolve(new ArrayBuffer(0));let o=n.value,h=o.length;return e.loaded+=h,h<s||a.dataLength?(a.push(o),a.dataLength>=s&&r(e,i,a.flush().buffer,t)):r(e,i,o.buffer,t),l()}).catch(()=>Promise.reject());return l()}}function r1(t,e){return new self.Request(t.url,e)}class r2 extends Error{constructor(t,e,i){super(t),this.code=void 0,this.details=void 0,this.code=e,this.details=i}}const r5=/^age:\s*[\d.]+\s*$/im;class r3{constructor(t){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=t&&t.xhrSetup||null,this.stats=new H,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){let t=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),t&&(t.onreadystatechange=null,t.onprogress=null,4!==t.readyState&&(this.stats.aborted=!0,t.abort()))}abort(){var t;this.abortInternal(),null!=(t=this.callbacks)&&t.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(t,e,i){if(this.stats.loading.start)throw Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=t,this.config=e,this.callbacks=i,this.loadInternal()}loadInternal(){let{config:t,context:e}=this;if(!t||!e)return;let i=this.loader=new self.XMLHttpRequest,s=this.stats;s.loading.first=0,s.loaded=0,s.aborted=!1;let r=this.xhrSetup;r?Promise.resolve().then(()=>{if(this.loader===i&&!this.stats.aborted)return r(i,e.url)}).catch(t=>{if(this.loader===i&&!this.stats.aborted)return i.open("GET",e.url,!0),r(i,e.url)}).then(()=>{this.loader!==i||this.stats.aborted||this.openAndSendXhr(i,e,t)}).catch(t=>{var r;null==(r=this.callbacks)||r.onError({code:i.status,text:t.message},e,i,s)}):this.openAndSendXhr(i,e,t)}openAndSendXhr(t,e,i){t.readyState||t.open("GET",e.url,!0);let s=e.headers,{maxTimeToFirstByteMs:a,maxLoadTimeMs:n}=i.loadPolicy;if(s)for(let e in s)t.setRequestHeader(e,s[e]);e.rangeEnd&&t.setRequestHeader("Range","bytes="+e.rangeStart+"-"+(e.rangeEnd-1)),t.onreadystatechange=this.readystatechange.bind(this),t.onprogress=this.loadprogress.bind(this),t.responseType=e.responseType,self.clearTimeout(this.requestTimeout),i.timeout=a&&r(a)?a:n,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),t.send()}readystatechange(){let{context:t,loader:e,stats:i}=this;if(!t||!e)return;let s=e.readyState,r=this.config;if(!i.aborted&&s>=2&&(0===i.loading.first&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),r.timeout!==r.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),r.timeout=r.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),r.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),4===s)){var a,n,l;self.clearTimeout(this.requestTimeout),e.onreadystatechange=null,e.onprogress=null;let s=e.status,o="text"===e.responseType?e.responseText:null;if(s>=200&&s<300){let r=null!=o?o:e.response;if(null!=r){i.loading.end=Math.max(self.performance.now(),i.loading.first),i.loaded=i.total="arraybuffer"===e.responseType?r.byteLength:r.length,i.bwEstimate=8e3*i.total/(i.loading.end-i.loading.first);let l=null==(a=this.callbacks)?void 0:a.onProgress;l&&l(i,t,r,e);let o={url:e.responseURL,data:r,code:s};null==(n=this.callbacks)||n.onSuccess(o,i,t,e);return}}let h=r.loadPolicy.errorRetry;t3(h,i.retry,!1,{url:t.url,data:void 0,code:s})?this.retry(h):(F.error(`${s} while loading ${t.url}`),null==(l=this.callbacks)||l.onError({code:s,text:e.statusText},t,e,i))}}loadtimeout(){if(!this.config)return;let t=this.config.loadPolicy.timeoutRetry;if(t3(t,this.stats.retry,!0))this.retry(t);else{var e;F.warn(`timeout while loading ${null==(e=this.context)?void 0:e.url}`);let t=this.callbacks;t&&(this.abortInternal(),t.onTimeout(this.stats,this.context,this.loader))}}retry(t){let{context:e,stats:i}=this;this.retryDelay=t2(t,i.retry),i.retry++,F.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${null==e?void 0:e.url}, retrying ${i.retry}/${t.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(t){let e=this.stats;e.loaded=t.loaded,t.lengthComputable&&(e.total=t.total)}getCacheAge(){let t=null;if(this.loader&&r5.test(this.loader.getAllResponseHeaders())){let e=this.loader.getResponseHeader("age");t=e?parseFloat(e):null}return t}getResponseHeader(t){return this.loader&&RegExp(`^${t}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(t):null}}const r4=k(k({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,maxDevicePixelRatio:Number.POSITIVE_INFINITY,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,startOnSegmentBoundary:!1,maxBufferSize:6e7,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:!0,liveSyncMode:"edge",liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:!1,loader:r3,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:class extends P{constructor(t){super("abr",t.logger),this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.rebufferNotice=-1,this.bwEstimator=void 0,this._abandonRulesCheck=t=>{var e;let i,{fragCurrent:s,partCurrent:a,hls:n}=this,{autoLevelEnabled:l,media:o}=n;if(!s||!o)return;let d=performance.now(),u=a?a.stats:s.stats,c=a?a.duration:s.duration,f=d-u.loading.start,g=n.minAutoLevel,p=s.level,m=this._nextAutoLevel;if(u.aborted||u.loaded&&u.loaded===u.total||p<=g){this.clearTimer(),this._nextAutoLevel=-1;return}if(!l)return;let y=m>-1&&m!==p,v=!!t||y;if(!v&&(o.paused||!o.playbackRate||!o.readyState))return;let E=n.mainForwardBufferInfo;if(!v&&null===E)return;let T=this.bwEstimator.getEstimateTTFB(),b=Math.abs(o.playbackRate);if(f<=Math.max(T,c/(2*b)*1e3))return;let S=E?E.len/b:0,A=u.loading.first?u.loading.first-u.loading.start:-1,_=u.loaded&&A>-1,x=this.getBwEstimate(),L=n.levels,I=L[p],R=Math.max(u.loaded,Math.round(c*(s.bitrate||I.averageBitrate)/8)),D=_?f-A:f;D<1&&_&&(D=Math.min(f,8*u.loaded/x));let k=_?1e3*u.loaded/D:0,P=T/1e3,C=k?(R-u.loaded)/k:8*R/x+P;if(C<=S)return;let M=k?8*k:x,w=(null==(e=(null==t?void 0:t.details)||this.hls.latestLevelDetails)?void 0:e.live)===!0,O=this.hls.config.abrBandWidthUpFactor,F=Number.POSITIVE_INFINITY;for(i=p-1;i>g;i--){let t=L[i].maxBitrate,e=!L[i].details||w;if((F=this.getTimeToLoadFrag(P,M,c*t,e))<Math.min(S,c+P))break}if(F>=C||F>10*c)return;_?this.bwEstimator.sample(f-Math.min(T,A),u.loaded):this.bwEstimator.sampleTTFB(f);let N=L[i].maxBitrate;this.getBwEstimate()*O>N&&this.resetEstimator(N);let B=this.findBestLevel(N,g,i,0,S,1,1);B>-1&&(i=B),this.warn(`Fragment ${s.sn}${a?" part "+a.index:""} of level ${p} is loading too slowly;
      Fragment duration: ${s.duration.toFixed(3)}
      Time to underbuffer: ${S.toFixed(3)} s
      Estimated load time for current fragment: ${C.toFixed(3)} s
      Estimated load time for down switch fragment: ${F.toFixed(3)} s
      TTFB estimate: ${0|A} ms
      Current BW estimate: ${r(x)?0|x:"Unknown"} bps
      New BW estimate: ${0|this.getBwEstimate()} bps
      Switching to level ${i} @ ${0|N} bps`),n.nextLoadLevel=n.nextAutoLevel=i,this.clearTimer();let U=()=>{if(this.clearTimer(),this.fragCurrent===s&&this.hls.loadLevel===i&&i>0){let t=this.getStarvationDelay();if(this.warn(`Aborting inflight request ${i>0?"and switching down":""}
      Fragment duration: ${s.duration.toFixed(3)} s
      Time to underbuffer: ${t.toFixed(3)} s`),s.abortRequests(),this.fragCurrent=this.partCurrent=null,i>g){let e=this.findBestLevel(this.hls.levels[g].bitrate,g,i,0,t,1,1);-1===e&&(e=g),this.hls.nextLoadLevel=this.hls.nextAutoLevel=e,this.resetEstimator(this.hls.levels[e].bitrate)}}};y||C>2*F?U():this.timer=self.setInterval(U,1e3*F),n.trigger(h.FRAG_LOAD_EMERGENCY_ABORTED,{frag:s,part:a,stats:u})},this.hls=t,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(t){t&&(this.log(`setting initial bwe to ${t}`),this.hls.config.abrEwmaDefaultEstimate=t),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){let t=this.hls.config;return new I(t.abrEwmaSlowVoD,t.abrEwmaFastVoD,t.abrEwmaDefaultEstimate)}registerListeners(){let{hls:t}=this;t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.FRAG_LOADING,this.onFragLoading,this),t.on(h.FRAG_LOADED,this.onFragLoaded,this),t.on(h.FRAG_BUFFERED,this.onFragBuffered,this),t.on(h.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(h.LEVEL_LOADED,this.onLevelLoaded,this),t.on(h.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(h.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),t.on(h.ERROR,this.onError,this)}unregisterListeners(){let{hls:t}=this;t&&(t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.FRAG_LOADING,this.onFragLoading,this),t.off(h.FRAG_LOADED,this.onFragLoaded,this),t.off(h.FRAG_BUFFERED,this.onFragBuffered,this),t.off(h.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(h.LEVEL_LOADED,this.onLevelLoaded,this),t.off(h.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(h.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),t.off(h.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(t,e){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(t,e){let i=e.frag;if(!this.ignoreFragment(i)){if(!i.bitrateTest){var s;this.fragCurrent=i,this.partCurrent=null!=(s=e.part)?s:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(t,e){this.clearTimer()}onError(t,e){if(!e.fatal)switch(e.details){case o.BUFFER_ADD_CODEC_ERROR:case o.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case o.FRAG_LOAD_TIMEOUT:{let t=e.frag,{fragCurrent:i,partCurrent:s}=this;if(t&&i&&t.sn===i.sn&&t.level===i.level){let e=performance.now(),i=s?s.stats:t.stats,r=e-i.loading.start,a=i.loading.first?i.loading.first-i.loading.start:-1;if(i.loaded&&a>-1){let t=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(r-Math.min(t,a),i.loaded)}else this.bwEstimator.sampleTTFB(r)}}}}getTimeToLoadFrag(t,e,i,s){let r=s?t+this.lastLevelLoadSec:0;return t+i/e+r}onLevelLoaded(t,e){let i=this.hls.config,{loading:s}=e.stats,a=s.end-s.first;r(a)&&(this.lastLevelLoadSec=a/1e3),e.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(e.levelInfo)}onFragLoaded(t,{frag:e,part:i}){let s=i?i.stats:e.stats;if(e.type===x.MAIN&&this.bwEstimator.sampleTTFB(s.loading.first-s.loading.start),!this.ignoreFragment(e)){if(this.clearTimer(),e.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){let t=i?i.duration:e.duration,r=this.hls.levels[e.level],a=(r.loaded?r.loaded.bytes:0)+s.loaded,n=(r.loaded?r.loaded.duration:0)+t;r.loaded={bytes:a,duration:n},r.realBitrate=Math.round(8*a/n)}if(e.bitrateTest){let t={stats:s,frag:e,part:i,id:e.type};this.onFragBuffered(h.FRAG_BUFFERED,t),e.bitrateTest=!1}else this.lastLoadedFragLevel=e.level}}onFragBuffered(t,e){let{frag:i,part:s}=e,r=null!=s&&s.stats.loaded?s.stats:i.stats;if(r.aborted||this.ignoreFragment(i))return;let a=r.parsing.end-r.loading.start-Math.min(r.loading.first-r.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(a,r.loaded),r.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=a/1e3:this.bitrateTestDelay=0}ignoreFragment(t){return t.type!==x.MAIN||"initSegment"===t.sn}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){let{maxAutoLevel:t,minAutoLevel:e}=this.hls,i=this.getBwEstimate(),s=this.hls.config.maxStarvationDelay,r=this.findBestLevel(i,e,t,0,s,1,1);if(r>-1)return r;let a=this.hls.firstLevel,n=Math.min(Math.max(a,e),t);return this.warn(`Could not find best starting auto level. Defaulting to first in playlist ${a} clamped to ${n}`),n}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){let t=this.forcedAutoLevel,e=this.bwEstimator.canEstimate(),i=this.lastLoadedFragLevel>-1;if(-1!==t&&(!e||!i||this.nextAutoLevelKey===this.getAutoLevelKey()))return t;let s=e&&i?this.getNextABRAutoLevel():this.firstAutoLevel;if(-1!==t){let e=this.hls.levels;if(e.length>Math.max(t,s)&&e[t].loadError<=e[s].loadError)return t}return this._nextAutoLevel=s,this.nextAutoLevelKey=this.getAutoLevelKey(),s}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){let{fragCurrent:t,partCurrent:e,hls:i}=this;if(i.levels.length<=1)return i.loadLevel;let{maxAutoLevel:s,config:r,minAutoLevel:a}=i,n=e?e.duration:t?t.duration:0,l=this.getBwEstimate(),o=this.getStarvationDelay(),h=r.abrBandWidthFactor,d=r.abrBandWidthUpFactor;if(o){let t=this.findBestLevel(l,a,s,o,0,h,d);if(t>=0)return this.rebufferNotice=-1,t}let u=n?Math.min(n,r.maxStarvationDelay):r.maxStarvationDelay;if(!o){let t=this.bitrateTestDelay;t&&(u=(n?Math.min(n,r.maxLoadingDelay):r.maxLoadingDelay)-t,this.info(`bitrate test took ${Math.round(1e3*t)}ms, set first fragment max fetchDuration to ${Math.round(1e3*u)} ms`),h=d=1)}let c=this.findBestLevel(l,a,s,o,u,h,d);if(this.rebufferNotice!==c&&(this.rebufferNotice=c,this.info(`${o?"rebuffering expected":"buffer is empty"}, optimal quality level ${c}`)),c>-1)return c;let f=i.levels[a],g=i.loadLevelObj;return g&&(null==f?void 0:f.bitrate)<g.bitrate?a:i.loadLevel}getStarvationDelay(){let t=this.hls,e=t.media;if(!e)return 1/0;let i=e&&0!==e.playbackRate?Math.abs(e.playbackRate):1,s=t.mainForwardBufferInfo;return(s?s.len:0)/i}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(t,e,i,s,a,n,l){var o,h;let d,u=s+a,c=this.lastLoadedFragLevel,f=-1===c?this.hls.firstLevel:c,{fragCurrent:g,partCurrent:p}=this,{levels:m,allAudioTracks:y,loadLevel:v,config:E}=this.hls;if(1===m.length)return 0;let T=m[f],b=!!(null!=(o=this.hls.latestLevelDetails)&&o.live),S=-1===v||-1===c,A="SDR",_=(null==T?void 0:T.frameRate)||0,{audioPreference:x,videoPreference:L}=E,I=this.audioTracksByGroup||(this.audioTracksByGroup=tH(y)),R=-1;if(S){if(-1!==this.firstSelection)return this.firstSelection;let s=function(t,e,i,s,a){let n=Object.keys(t),l=null==s?void 0:s.channels,o=null==s?void 0:s.audioCodec,h=null==a?void 0:a.videoCodec,d=l&&2===parseInt(l),u=!1,c=!1,f=1/0,g=1/0,p=1/0,m=1/0,y=0,v=[],{preferHDR:E,allowedVideoRanges:T}=function(t,e){let i=!1,s=[];if(t&&(i="SDR"!==t,s=[t]),e){let t="SDR"!==(s=e.allowedVideoRanges||tw.slice(0)).join("")&&!e.videoCodec;(i=void 0!==e.preferHDR?e.preferHDR:t&&function(){if("function"==typeof matchMedia){let t=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(t.media!==e.media)return!0===t.matches}return!1}())||(s=["SDR"])}return{preferHDR:i,allowedVideoRanges:s}}(e,a);for(let e=n.length;e--;){let i=t[n[e]];u||(u=i.channels[2]>0),f=Math.min(f,i.minHeight),g=Math.min(g,i.minFramerate),p=Math.min(p,i.minBitrate),T.filter(t=>i.videoRanges[t]>0).length>0&&(c=!0)}f=r(f)?f:0,g=r(g)?g:0;let b=Math.max(1080,f),S=Math.max(30,g);i=Math.max(p=r(p)?p:i,i),c||(e=void 0);let A=n.length>1;return{codecSet:n.reduce((e,s)=>{let r=t[s];if(s===e)return e;if(v=c?T.filter(t=>r.videoRanges[t]>0):[],A){if(r.minBitrate>i)return tV(s,`min bitrate of ${r.minBitrate} > current estimate of ${i}`),e;if(!r.hasDefaultAudio)return tV(s,"no renditions with default or auto-select sound found"),e;if(o&&s.indexOf(o.substring(0,4))%5!=0)return tV(s,`audio codec preference "${o}" not found`),e;if(l&&!d){if(!r.channels[l])return tV(s,`no renditions with ${l} channel sound found (channels options: ${Object.keys(r.channels)})`),e}else if((!o||d)&&u&&0===r.channels["2"])return tV(s,"no renditions with stereo sound found"),e;if(r.minHeight>b)return tV(s,`min resolution of ${r.minHeight} > maximum of ${b}`),e;if(r.minFramerate>S)return tV(s,`min framerate of ${r.minFramerate} > maximum of ${S}`),e;if(!v.some(t=>r.videoRanges[t]>0))return tV(s,`no variants with VIDEO-RANGE of ${tG(v)} found`),e;if(h&&s.indexOf(h.substring(0,4))%5!=0)return tV(s,`video codec preference "${h}" not found`),e;if(r.maxScore<y)return tV(s,`max score of ${r.maxScore} < selected max of ${y}`),e}return e&&(tS(s)>=tS(e)||r.fragmentError>t[e].fragmentError)?e:(m=r.minIndex,y=r.maxScore,s)},void 0),videoRanges:v,preferHDR:E,minFramerate:g,minBitrate:p,minIndex:m}}(this.codecTiers||(this.codecTiers=m.slice(e,i+1).reduce((t,e,i)=>{if(!e.codecSet)return t;let s=e.audioGroups,r=t[e.codecSet];r||(t[e.codecSet]=r={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:i,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!s,fragmentError:0}),r.minBitrate=Math.min(r.minBitrate,e.bitrate);let a=Math.min(e.height,e.width);return r.minHeight=Math.min(r.minHeight,a),r.minFramerate=Math.min(r.minFramerate,e.frameRate),r.minIndex=Math.min(r.minIndex,i),r.maxScore=Math.max(r.maxScore,e.score),r.fragmentError+=e.fragmentError,r.videoRanges[e.videoRange]=(r.videoRanges[e.videoRange]||0)+1,s&&s.forEach(t=>{if(!t)return;let e=I.groups[t];e&&(r.hasDefaultAudio=r.hasDefaultAudio||I.hasDefaultAudio?e.hasDefault:e.hasAutoSelect||!I.hasDefaultAudio&&!I.hasAutoSelectAudio,Object.keys(e.channels).forEach(t=>{r.channels[t]=(r.channels[t]||0)+e.channels[t]}))}),t},{})),A,t,x,L),{codecSet:a,videoRanges:n,minFramerate:l,minBitrate:o,minIndex:h,preferHDR:u}=s;R=h,d=a,A=u?n[n.length-1]:n[0],_=l,t=Math.max(t,o),this.log(`picked start tier ${tG(s)}`)}else d=null==T?void 0:T.codecSet,A=null==T?void 0:T.videoRange;let D=p?p.duration:g?g.duration:0,k=this.bwEstimator.getEstimateTTFB()/1e3,P=[];for(let o=i;o>=e;o--){let e,g=m[o],y=o>f;if(!g)continue;if(E.useMediaCapabilities&&!g.supportedResult&&!g.supportedPromise){let e=navigator.mediaCapabilities;"function"==typeof(null==e?void 0:e.decodingInfo)&&(function(t,e,i,s,a,n){let l=t.audioCodec?t.audioGroups:null,o=null==n?void 0:n.audioCodec,h=null==n?void 0:n.channels,d=h?parseInt(h):o?1/0:2,u=null;if(null!=l&&l.length)try{u=1===l.length&&l[0]?e.groups[l[0]].channels:l.reduce((t,i)=>{if(i){let s=e.groups[i];if(!s)throw Error(`Audio track group ${i} not found`);Object.keys(s.channels).forEach(e=>{t[e]=(t[e]||0)+s.channels[e]})}return t},{2:0})}catch(t){return!0}return void 0!==t.videoCodec&&(t.width>1920&&t.height>1088||t.height>1920&&t.width>1088||t.frameRate>Math.max(s,30)||"SDR"!==t.videoRange&&t.videoRange!==i||t.bitrate>Math.max(a,8e6))||!!u&&r(d)&&Object.keys(u).some(t=>parseInt(t)>d)}(g,I,A,_,t,x)||tc(g.videoCodec))?(g.supportedPromise=tC(g,I,e),g.supportedPromise.then(t=>{if(!this.hls)return;g.supportedResult=t;let e=this.hls.levels,i=e.indexOf(g);t.error?this.warn(`MediaCapabilities decodingInfo error: "${t.error}" for level ${i} ${tG(t)}`):!t.supported&&(this.warn(`Unsupported MediaCapabilities decodingInfo result for level ${i} ${tG(t)}`),i>-1&&e.length>1&&(this.log(`Removing unsupported level ${i}`),this.hls.removeLevel(i),-1===this.hls.loadLevel&&(this.hls.nextLoadLevel=0)))})):g.supportedResult=tD}if((d&&g.codecSet!==d||A&&g.videoRange!==A||y&&_>g.frameRate||!y&&_>0&&_<g.frameRate||g.supportedResult&&!(null!=(h=g.supportedResult.decodingInfoResults)&&h[0].smooth))&&(!S||o!==R)){P.push(o);continue}let T=g.details,L=(p?null==T?void 0:T.partTarget:null==T?void 0:T.averagetargetduration)||D;e=y?l*t:n*t;let C=D&&s>=2*D&&0===a?g.averageBitrate:g.maxBitrate,M=this.getTimeToLoadFrag(k,e,C*L,void 0===T);if(e>=C&&(o===c||0===g.loadError&&0===g.fragmentError)&&(M<=k||!r(M)||b&&!this.bitrateTestDelay||M<u)){let t=this.forcedAutoLevel;return o!==v&&(-1===t||t!==v)&&(P.length&&this.trace(`Skipped level(s) ${P.join(",")} of ${i} max with CODECS and VIDEO-RANGE:"${m[P[0]].codecs}" ${m[P[0]].videoRange}; not compatible with "${d}" ${A}`),this.info(`switch candidate:${f}->${o} adjustedbw(${Math.round(e)})-bitrate=${Math.round(e-C)} ttfb:${k.toFixed(1)} avgDuration:${L.toFixed(1)} maxFetchDuration:${u.toFixed(1)} fetchDuration:${M.toFixed(1)} firstSelection:${S} codecSet:${g.codecSet} videoRange:${g.videoRange} hls.loadLevel:${v}`)),S&&(this.firstSelection=o),o}}return -1}set nextAutoLevel(t){let e=this.deriveNextAutoLevel(t);this._nextAutoLevel!==e&&(this.nextAutoLevelKey="",this._nextAutoLevel=e)}deriveNextAutoLevel(t){let{maxAutoLevel:e,minAutoLevel:i}=this.hls;return Math.min(Math.max(t,i),e)}},bufferController:class extends P{constructor(t,e){var i;super("buffer-controller",t.logger),this.hls=void 0,this.fragmentTracker=void 0,this.details=null,this._objectUrl=null,this.operationQueue=null,this.bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.blockedAudioAppend=null,this.lastVideoAppendEnd=0,this.appendSource=void 0,this.transferData=void 0,this.overrides=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.sourceBuffers=[[null,null],[null,null]],this._onEndStreaming=t=>{var e;this.hls&&(null==(e=this.mediaSource)?void 0:e.readyState)==="open"&&this.hls.pauseBuffering()},this._onStartStreaming=t=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=t=>{let{media:e,mediaSource:i}=this;t&&this.log("Media source opened"),e&&i&&(i.removeEventListener("sourceopen",this._onMediaSourceOpen),e.removeEventListener("emptied",this._onMediaEmptied),this.updateDuration(),this.hls.trigger(h.MEDIA_ATTACHED,{media:e,mediaSource:i}),null!==this.mediaSource&&this.checkPendingTracks())},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{let{mediaSrc:t,_objectUrl:e}=this;t!==e&&this.error(`Media element src was set while attaching MediaSource (${e} > ${t})`)},this.hls=t,this.fragmentTracker=e,this.appendSource=(i=N(t.config.preferManagedMediaSource),"undefined"!=typeof self&&i===self.ManagedMediaSource),this.initTracks(),this.registerListeners()}hasSourceTypes(){return Object.keys(this.tracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&(this.operationQueue.destroy(),this.operationQueue=null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null}registerListeners(){let{hls:t}=this;t.on(h.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.MANIFEST_PARSED,this.onManifestParsed,this),t.on(h.BUFFER_RESET,this.onBufferReset,this),t.on(h.BUFFER_APPENDING,this.onBufferAppending,this),t.on(h.BUFFER_CODECS,this.onBufferCodecs,this),t.on(h.BUFFER_EOS,this.onBufferEos,this),t.on(h.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(h.LEVEL_UPDATED,this.onLevelUpdated,this),t.on(h.FRAG_PARSED,this.onFragParsed,this),t.on(h.FRAG_CHANGED,this.onFragChanged,this),t.on(h.ERROR,this.onError,this)}unregisterListeners(){let{hls:t}=this;t.off(h.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.MANIFEST_PARSED,this.onManifestParsed,this),t.off(h.BUFFER_RESET,this.onBufferReset,this),t.off(h.BUFFER_APPENDING,this.onBufferAppending,this),t.off(h.BUFFER_CODECS,this.onBufferCodecs,this),t.off(h.BUFFER_EOS,this.onBufferEos,this),t.off(h.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(h.LEVEL_UPDATED,this.onLevelUpdated,this),t.off(h.FRAG_PARSED,this.onFragParsed,this),t.off(h.FRAG_CHANGED,this.onFragChanged,this),t.off(h.ERROR,this.onError,this)}transferMedia(){let{media:t,mediaSource:e}=this;if(!t)return null;let i={};if(this.operationQueue){let t=this.isUpdating();t||this.operationQueue.removeBlockers();let e=this.isQueued();(t||e)&&this.warn(`Transfering MediaSource with${e?" operations in queue":""}${t?" updating SourceBuffer(s)":""} ${this.operationQueue}`),this.operationQueue.destroy()}let s=this.transferData;return!this.sourceBufferCount&&s&&s.mediaSource===e?R(i,s.tracks):this.sourceBuffers.forEach(t=>{let[e]=t;e&&(i[e]=R({},this.tracks[e]),this.removeBuffer(e)),t[0]=t[1]=null}),{media:t,mediaSource:e,tracks:i}}initTracks(){this.sourceBuffers=[[null,null],[null,null]],this.tracks={},this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0}onManifestLoading(){this.bufferCodecEventsTotal=0,this.details=null}onManifestParsed(t,e){var i;let s=2;(!e.audio||e.video)&&e.altAudio||(s=1),this.bufferCodecEventsTotal=s,this.log(`${s} bufferCodec event(s) expected.`),null!=(i=this.transferData)&&i.mediaSource&&this.sourceBufferCount&&s&&this.bufferCreated()}onMediaAttaching(t,e){let i=this.media=e.media,s=N(this.appendSource);if(this.transferData=this.overrides=void 0,i&&s){let t=!!e.mediaSource;(t||e.overrides)&&(this.transferData=e,this.overrides=e.overrides);let r=this.mediaSource=e.mediaSource||new s;if(this.assignMediaSource(r),t)this._objectUrl=i.src,this.attachTransferred();else{let t=this._objectUrl=self.URL.createObjectURL(r);if(this.appendSource)try{i.removeAttribute("src");let e=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||e&&r instanceof e,sL(i),function(t,e){let i=self.document.createElement("source");i.type="video/mp4",i.src=e,t.appendChild(i)}(i,t),i.load()}catch(e){i.src=t}else i.src=t}i.addEventListener("emptied",this._onMediaEmptied)}}assignMediaSource(t){var e,i;this.log(`${(null==(e=this.transferData)?void 0:e.mediaSource)===t?"transferred":"created"} media source: ${null==(i=t.constructor)?void 0:i.name}`),t.addEventListener("sourceopen",this._onMediaSourceOpen),t.addEventListener("sourceended",this._onMediaSourceEnded),t.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(t.addEventListener("startstreaming",this._onStartStreaming),t.addEventListener("endstreaming",this._onEndStreaming))}attachTransferred(){let t=this.media,e=this.transferData;if(!e||!t)return;let i=this.tracks,s=e.tracks,r=s?Object.keys(s):null,a=r?r.length:0,n=()=>{this.media&&this.mediaSourceOpenOrEnded&&this._onMediaSourceOpen()};if(s&&r&&a){if(!this.tracksReady){this.hls.config.startFragPrefetch=!0,this.log("attachTransferred: waiting for SourceBuffer track info");return}if(this.log(`attachTransferred: (bufferCodecEventsTotal ${this.bufferCodecEventsTotal})
required tracks: ${tG(i,(t,e)=>"initSegment"===t?void 0:e)};
transfer tracks: ${tG(s,(t,e)=>"initSegment"===t?void 0:e)}}`),!B(s,i)){e.mediaSource=null,e.tracks=void 0;let r=t.currentTime,a=this.details,n=Math.max(r,(null==a?void 0:a.fragments[0].start)||0);return n-r>1?void this.log(`attachTransferred: waiting for playback to reach new tracks start time ${r} -> ${n}`):(this.warn(`attachTransferred: resetting MediaSource for incompatible tracks ("${Object.keys(s)}"->"${Object.keys(i)}") start time: ${n} currentTime: ${r}`),this.onMediaDetaching(h.MEDIA_DETACHING,{}),this.onMediaAttaching(h.MEDIA_ATTACHING,e),void(t.currentTime=n))}this.transferData=void 0,r.forEach(t=>{let e=s[t];if(e){let i=e.buffer;if(i){let s=this.fragmentTracker,r=e.id;if(s.hasFragments(r)||s.hasParts(r)){let e=em.getBuffered(i);s.detectEvictedFragments(t,e,r,null,!0)}let a=sI(t),n=[t,i];this.sourceBuffers[a]=n,i.updating&&this.operationQueue&&this.operationQueue.prependBlocker(t),this.trackSourceBuffer(t,e)}}}),n(),this.bufferCreated()}else this.log("attachTransferred: MediaSource w/o SourceBuffers"),n()}get mediaSourceOpenOrEnded(){var t;let e=null==(t=this.mediaSource)?void 0:t.readyState;return"open"===e||"ended"===e}onMediaDetaching(t,e){let i=!!e.transferMedia;this.transferData=this.overrides=void 0;let{media:s,mediaSource:r,_objectUrl:a}=this;if(r){if(this.log(`media source ${i?"transferring":"detaching"}`),i)this.sourceBuffers.forEach(([t])=>{t&&this.removeBuffer(t)}),this.resetQueue();else{if(this.mediaSourceOpenOrEnded){let t="open"===r.readyState;try{let e=r.sourceBuffers;for(let i=e.length;i--;)t&&e[i].abort(),r.removeSourceBuffer(e[i]);t&&r.endOfStream()}catch(t){this.warn(`onMediaDetaching: ${t.message} while calling endOfStream`)}}this.sourceBufferCount&&this.onBufferReset()}r.removeEventListener("sourceopen",this._onMediaSourceOpen),r.removeEventListener("sourceended",this._onMediaSourceEnded),r.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(r.removeEventListener("startstreaming",this._onStartStreaming),r.removeEventListener("endstreaming",this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null}s&&(s.removeEventListener("emptied",this._onMediaEmptied),i||(a&&self.URL.revokeObjectURL(a),this.mediaSrc===a?(s.removeAttribute("src"),this.appendSource&&sL(s),s.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.media=null),this.hls.trigger(h.MEDIA_DETACHED,e)}onBufferReset(){this.sourceBuffers.forEach(([t])=>{t&&this.resetBuffer(t)}),this.initTracks()}resetBuffer(t){var e,i;let s=null==(e=this.tracks[t])?void 0:e.buffer;if(this.removeBuffer(t),s)try{null!=(i=this.mediaSource)&&i.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(s)}catch(e){this.warn(`onBufferReset ${t}`,e)}delete this.tracks[t]}removeBuffer(t){this.removeBufferListeners(t),this.sourceBuffers[sI(t)]=[null,null];let e=this.tracks[t];e&&(e.buffer=void 0)}resetQueue(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new sS(this.tracks)}onBufferCodecs(t,e){let i=this.tracks,s=Object.keys(e);this.log(`BUFFER_CODECS: "${s}" (current SB count ${this.sourceBufferCount})`);let r="audiovideo"in e&&(i.audio||i.video)||i.audiovideo&&("audio"in e||"video"in e),a=!r&&this.sourceBufferCount&&this.media&&s.some(t=>!i[t]);if(r||a)return void this.warn(`Unsupported transition between "${Object.keys(i)}" and "${s}" SourceBuffers`);s.forEach(t=>{var s,r,a;let{id:n,codec:l,levelCodec:o,container:h,metadata:d,supplemental:u}=e[t],c=i[t],f=null==(s=this.transferData)||null==(r=s.tracks)?void 0:r[t],g=null!=f&&f.buffer?f:c,p=(null==g?void 0:g.pendingCodec)||(null==g?void 0:g.codec),m=null==g?void 0:g.levelCodec;c||(c=i[t]={buffer:void 0,listeners:[],codec:l,supplemental:u,container:h,levelCodec:o,metadata:d,id:n});let y=tL(p,m),v=null==y?void 0:y.replace(sA,"$1"),E=tL(l,o),T=null==(a=E)?void 0:a.replace(sA,"$1");E&&y&&v!==T&&("audio"===t.slice(0,5)&&(E=tx(E,this.appendSource)),this.log(`switching codec ${p} to ${E}`),E!==(c.pendingCodec||c.codec)&&(c.pendingCodec=E),c.container=h,this.appendChangeType(t,h,E))}),(this.tracksReady||this.sourceBufferCount)&&(e.tracks=this.sourceBufferTracks),!this.sourceBufferCount&&this.mediaSourceOpenOrEnded&&this.checkPendingTracks()}get sourceBufferTracks(){return Object.keys(this.tracks).reduce((t,e)=>{let i=this.tracks[e];return t[e]={id:i.id,container:i.container,codec:i.codec,levelCodec:i.levelCodec},t},{})}appendChangeType(t,e,i){let s=`${e};codecs=${i}`,r={label:`change-type=${s}`,execute:()=>{let r=this.tracks[t];if(r){let a=r.buffer;null!=a&&a.changeType&&(this.log(`changing ${t} sourceBuffer type to ${s}`),a.changeType(s),r.codec=i,r.container=e)}this.shiftAndExecuteNext(t)},onStart:()=>{},onComplete:()=>{},onError:e=>{this.warn(`Failed to change ${t} SourceBuffer type`,e)}};this.append(r,t,this.isPending(this.tracks[t]))}blockAudio(t){var e;let i=t.start,s=i+.05*t.duration;if((null==(e=this.fragmentTracker.getAppendedFrag(i,x.MAIN))?void 0:e.gap)===!0)return;let r={label:"block-audio",execute:()=>{var t;let e=this.tracks.video;(this.lastVideoAppendEnd>s||null!=e&&e.buffer&&em.isBuffered(e.buffer,s)||(null==(t=this.fragmentTracker.getAppendedFrag(s,x.MAIN))?void 0:t.gap)===!0)&&(this.blockedAudioAppend=null,this.shiftAndExecuteNext("audio"))},onStart:()=>{},onComplete:()=>{},onError:t=>{this.warn("Error executing block-audio operation",t)}};this.blockedAudioAppend={op:r,frag:t},this.append(r,"audio",!0)}unblockAudio(){let{blockedAudioAppend:t,operationQueue:e}=this;t&&e&&(this.blockedAudioAppend=null,e.unblockAudio(t.op))}onBufferAppending(t,e){let{tracks:i}=this,{data:s,type:r,parent:a,frag:n,part:d,chunkMeta:u}=e,c=u.buffering[r],f=n.sn,g=self.performance.now();c.start=g;let p=n.stats.buffering,m=d?d.stats.buffering:null;0===p.start&&(p.start=g),m&&0===m.start&&(m.start=g);let y=i.audio,v=!1;"audio"===r&&(null==y?void 0:y.container)==="audio/mpeg"&&(v=!this.lastMpegAudioChunk||1===u.id||this.lastMpegAudioChunk.sn!==u.sn,this.lastMpegAudioChunk=u);let E=this.tracks.video,T=null==E?void 0:E.buffer;if(T&&"initSegment"!==f){let t=d||n,e=this.blockedAudioAppend;if("audio"!==r||"main"===a||this.blockedAudioAppend){if("video"===r){let i=t.end;if(e){let t=e.frag.start;(i>t||i<this.lastVideoAppendEnd||em.isBuffered(T,t))&&this.unblockAudio()}this.lastVideoAppendEnd=i}}else{let e=t.start+.05*t.duration,i=T.buffered,s=this.currentOp("video");(i.length||s)&&(s||em.isBuffered(T,e)||!(this.lastVideoAppendEnd<e))||this.blockAudio(t)}}let b=(d||n).start,S={label:`append-${r}`,execute:()=>{if(c.executeStart=self.performance.now(),v){let t=this.tracks[r];if(t){let e=t.buffer;if(e){let t=b-e.timestampOffset;Math.abs(t)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${b} (delta: ${t}) sn: ${f})`),e.timestampOffset=b)}}}this.appendExecutor(s,r)},onStart:()=>{},onComplete:()=>{let t=self.performance.now();c.executeEnd=c.end=t,0===p.first&&(p.first=t),m&&0===m.first&&(m.first=t);let e={};this.sourceBuffers.forEach(([t,i])=>{t&&(e[t]=em.getBuffered(i))}),this.appendErrors[r]=0,"audio"===r||"video"===r?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(h.BUFFER_APPENDED,{type:r,frag:n,part:d,chunkMeta:u,parent:n.type,timeRanges:e})},onError:t=>{var e;let i={type:l.MEDIA_ERROR,parent:n.type,details:o.BUFFER_APPEND_ERROR,sourceBufferName:r,frag:n,part:d,chunkMeta:u,error:t,err:t,fatal:!1},s=null==(e=this.media)?void 0:e.error;if(t.code===DOMException.QUOTA_EXCEEDED_ERR)i.details=o.BUFFER_FULL_ERROR;else if(t.code===DOMException.INVALID_STATE_ERR&&this.mediaSourceOpenOrEnded&&!s)i.errorAction=t6(!0);else if(t.name===s_&&0===this.sourceBufferCount)i.errorAction=t6(!0);else{let t=++this.appendErrors[r];this.warn(`Failed ${t}/${this.hls.config.appendErrorMaxRetry} times to append segment in "${r}" sourceBuffer (${s||"no media error"})`),(t>=this.hls.config.appendErrorMaxRetry||s)&&(i.fatal=!0)}this.hls.trigger(h.ERROR,i)}};this.append(S,r,this.isPending(this.tracks[r]))}getFlushOp(t,e,i){return this.log(`queuing "${t}" remove ${e}-${i}`),{label:"remove",execute:()=>{this.removeExecutor(t,e,i)},onStart:()=>{},onComplete:()=>{this.hls.trigger(h.BUFFER_FLUSHED,{type:t})},onError:s=>{this.warn(`Failed to remove ${e}-${i} from "${t}" SourceBuffer`,s)}}}onBufferFlushing(t,e){let{type:i,startOffset:s,endOffset:r}=e;i?this.append(this.getFlushOp(i,s,r),i):this.sourceBuffers.forEach(([t])=>{t&&this.append(this.getFlushOp(t,s,r),t)})}onFragParsed(t,e){let{frag:i,part:s}=e,r=[],a=s?s.elementaryStreams:i.elementaryStreams;a[K.AUDIOVIDEO]?r.push("audiovideo"):(a[K.AUDIO]&&r.push("audio"),a[K.VIDEO]&&r.push("video")),0===r.length&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers(()=>{let t=self.performance.now();i.stats.buffering.end=t,s&&(s.stats.buffering.end=t);let e=s?s.stats:i.stats;this.hls.trigger(h.FRAG_BUFFERED,{frag:i,part:s,stats:e,id:i.type})},r).catch(t=>{this.warn(`Fragment buffered callback ${t}`),this.stepOperationQueue(this.sourceBufferTypes)})}onFragChanged(t,e){this.trimBuffers()}get bufferedToEnd(){return this.sourceBufferCount>0&&!this.sourceBuffers.some(([t])=>{var e,i;return t&&(!(null!=(e=this.tracks[t])&&e.ended)||(null==(i=this.tracks[t])?void 0:i.ending))})}onBufferEos(t,e){var i;this.sourceBuffers.forEach(([t])=>{if(t){let i=this.tracks[t];(!e.type||e.type===t)&&(i.ending=!0,i.ended||(i.ended=!0,this.log(`${t} buffer reached EOS`)))}});let s=(null==(i=this.overrides)?void 0:i.endOfStream)!==!1;this.sourceBufferCount>0&&!this.sourceBuffers.some(([t])=>{var e;return t&&!(null!=(e=this.tracks[t])&&e.ended)})&&(s?(this.log("Queueing EOS"),this.blockUntilOpen(()=>{this.tracksEnded();let{mediaSource:t}=this;if(!t||"open"!==t.readyState){t&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${t.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),t.endOfStream(),this.hls.trigger(h.BUFFERED_TO_END,void 0)})):(this.tracksEnded(),this.hls.trigger(h.BUFFERED_TO_END,void 0)))}tracksEnded(){this.sourceBuffers.forEach(([t])=>{if(null!==t){let e=this.tracks[t];e&&(e.ending=!1)}})}onLevelUpdated(t,{details:e}){e.fragments.length&&(this.details=e,this.updateDuration())}updateDuration(){let t=this.getDurationAndRange();t&&this.blockUntilOpen(()=>this.updateMediaSource(t))}onError(t,e){if(e.details===o.BUFFER_APPEND_ERROR&&e.frag){var i;let t=null==(i=e.errorAction)?void 0:i.nextAutoLevel;r(t)&&t!==e.frag.level&&this.resetAppendErrors()}}resetAppendErrors(){this.appendErrors={audio:0,video:0,audiovideo:0}}trimBuffers(){let{hls:t,details:e,media:i}=this;if(!i||null===e||!this.sourceBufferCount)return;let s=t.config,a=i.currentTime,n=e.levelTargetDuration,l=e.live&&null!==s.liveBackBufferLength?s.liveBackBufferLength:s.backBufferLength;if(r(l)&&l>=0){let t=Math.max(l,n),e=Math.floor(a/n)*n-t;this.flushBackBuffer(a,n,e)}if(r(s.frontBufferFlushThreshold)&&s.frontBufferFlushThreshold>0){let t=Math.max(Math.max(s.maxBufferLength,s.frontBufferFlushThreshold),n),e=Math.floor(a/n)*n+t;this.flushFrontBuffer(a,n,e)}}flushBackBuffer(t,e,i){this.sourceBuffers.forEach(([t,e])=>{if(e){let r=em.getBuffered(e);if(r.length>0&&i>r.start(0)){var s;this.hls.trigger(h.BACK_BUFFER_REACHED,{bufferEnd:i});let e=this.tracks[t];if(null!=(s=this.details)&&s.live)this.hls.trigger(h.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(null!=e&&e.ended)return void this.log(`Cannot flush ${t} back buffer while SourceBuffer is in ended state`);this.hls.trigger(h.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:t})}}})}flushFrontBuffer(t,e,i){this.sourceBuffers.forEach(([e,s])=>{if(s){let r=em.getBuffered(s),a=r.length;if(a<2)return;let n=r.start(a-1),l=r.end(a-1);i>n||t>=n&&t<=l||this.hls.trigger(h.BUFFER_FLUSHING,{startOffset:n,endOffset:1/0,type:e})}})}getDurationAndRange(){var t;let{details:e,mediaSource:i}=this;if(!e||!this.media||(null==i?void 0:i.readyState)!=="open")return null;let s=e.edge;if(e.live&&this.hls.config.liveDurationInfinity){if(e.fragments.length&&e.live&&i.setLiveSeekableRange){let t=Math.max(0,e.fragmentStart),i=Math.max(t,s);return{duration:1/0,start:t,end:i}}return{duration:1/0}}let a=null==(t=this.overrides)?void 0:t.duration;if(a)return r(a)?{duration:a}:null;let n=this.media.duration;return s>(r(i.duration)?i.duration:0)&&s>n||!r(n)?{duration:s}:null}updateMediaSource({duration:t,start:e,end:i}){let s=this.mediaSource;this.media&&s&&"open"===s.readyState&&(s.duration!==t&&(r(t)&&this.log(`Updating MediaSource duration to ${t.toFixed(3)}`),s.duration=t),void 0!==e&&void 0!==i&&(this.log(`MediaSource duration is set to ${s.duration}. Setting seekable range to ${e}-${i}.`),s.setLiveSeekableRange(e,i)))}get tracksReady(){let t=this.pendingTrackCount;return t>0&&(t>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}checkPendingTracks(){let{bufferCodecEventsTotal:t,pendingTrackCount:e,tracks:i}=this;if(this.log(`checkPendingTracks (pending: ${e} codec events expected: ${t}) ${tG(i)}`),this.tracksReady){var s;let t=null==(s=this.transferData)?void 0:s.tracks;t&&Object.keys(t).length?this.attachTransferred():this.createSourceBuffers()}}bufferCreated(){if(this.sourceBufferCount){let t={};this.sourceBuffers.forEach(([e,i])=>{if(e){let s=this.tracks[e];t[e]={buffer:i,container:s.container,codec:s.codec,supplemental:s.supplemental,levelCodec:s.levelCodec,id:s.id,metadata:s.metadata}}}),this.hls.trigger(h.BUFFER_CREATED,{tracks:t}),this.log(`SourceBuffers created. Running queue: ${this.operationQueue}`),this.sourceBuffers.forEach(([t])=>{this.executeNext(t)})}else{let t=Error("could not create source buffer for media codec(s)");this.hls.trigger(h.ERROR,{type:l.MEDIA_ERROR,details:o.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:t,reason:t.message})}}createSourceBuffers(){let{tracks:t,sourceBuffers:e,mediaSource:i}=this;if(!i)throw Error("createSourceBuffers called when mediaSource was null");for(let r in t){let a=t[r];if(this.isPending(a)){let t=this.getTrackCodec(a,r),n=`${a.container};codecs=${t}`;a.codec=t,this.log(`creating sourceBuffer(${n})${this.currentOp(r)?" Queued":""} ${tG(a)}`);try{let t=i.addSourceBuffer(n),s=sI(r),l=[r,t];e[s]=l,a.buffer=t}catch(t){var s;this.error(`error while trying to add sourceBuffer: ${t.message}`),this.shiftAndExecuteNext(r),null==(s=this.operationQueue)||s.removeBlockers(),delete this.tracks[r],this.hls.trigger(h.ERROR,{type:l.MEDIA_ERROR,details:o.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:t,sourceBufferName:r,mimeType:n,parent:a.id});return}this.trackSourceBuffer(r,a)}}this.bufferCreated()}getTrackCodec(t,e){let i=t.supplemental,s=t.codec;i&&("video"===e||"audiovideo"===e)&&tv(i,"video")&&(s=function(t,e){let i=[];if(t){let e=t.split(",");for(let t=0;t<e.length;t++)ty(e[t],"video")||i.push(e[t])}return e&&i.push(e),i.join(",")}(s,i));let r=tL(s,t.levelCodec);return r?"audio"===e.slice(0,5)?tx(r,this.appendSource):r:""}trackSourceBuffer(t,e){let i=e.buffer;if(!i)return;let s=this.getTrackCodec(e,t);this.tracks[t]={buffer:i,codec:s,container:e.container,levelCodec:e.levelCodec,supplemental:e.supplemental,metadata:e.metadata,id:e.id,listeners:[]},this.removeBufferListeners(t),this.addBufferListener(t,"updatestart",this.onSBUpdateStart),this.addBufferListener(t,"updateend",this.onSBUpdateEnd),this.addBufferListener(t,"error",this.onSBUpdateError),this.appendSource&&this.addBufferListener(t,"bufferedchange",(t,e)=>{let i=e.removedRanges;null!=i&&i.length&&this.hls.trigger(h.BUFFER_FLUSHED,{type:t})})}get mediaSrc(){var t,e;let i=(null==(t=this.media)||null==(e=t.querySelector)?void 0:e.call(t,"source"))||this.media;return null==i?void 0:i.src}onSBUpdateStart(t){let e=this.currentOp(t);e&&e.onStart()}onSBUpdateEnd(t){var e;if((null==(e=this.mediaSource)?void 0:e.readyState)==="closed")return void this.resetBuffer(t);let i=this.currentOp(t);i&&(i.onComplete(),this.shiftAndExecuteNext(t))}onSBUpdateError(t,e){var i;let s=Error(`${t} SourceBuffer error. MediaSource readyState: ${null==(i=this.mediaSource)?void 0:i.readyState}`);this.error(`${s}`,e),this.hls.trigger(h.ERROR,{type:l.MEDIA_ERROR,details:o.BUFFER_APPENDING_ERROR,sourceBufferName:t,error:s,fatal:!1});let r=this.currentOp(t);r&&r.onError(s)}removeExecutor(t,e,i){let{media:s,mediaSource:a}=this,n=this.tracks[t],l=null==n?void 0:n.buffer;if(!s||!a||!l){this.warn(`Attempting to remove from the ${t} SourceBuffer, but it does not exist`),this.shiftAndExecuteNext(t);return}let o=r(s.duration)?s.duration:1/0,h=r(a.duration)?a.duration:1/0,d=Math.max(0,e),u=Math.min(i,o,h);u>d&&(!n.ending||n.ended)?(n.ended=!1,this.log(`Removing [${d},${u}] from the ${t} SourceBuffer`),l.remove(d,u)):this.shiftAndExecuteNext(t)}appendExecutor(t,e){let i=this.tracks[e],s=null==i?void 0:i.buffer;if(!s)throw new sx(`Attempting to append to the ${e} SourceBuffer, but it does not exist`);i.ending=!1,i.ended=!1,s.appendBuffer(t)}blockUntilOpen(t){if(this.isUpdating()||this.isQueued())this.blockBuffers(t).catch(t=>{this.warn(`SourceBuffer blocked callback ${t}`),this.stepOperationQueue(this.sourceBufferTypes)});else try{t()}catch(t){this.warn(`Callback run without blocking ${this.operationQueue} ${t}`)}}isUpdating(){return this.sourceBuffers.some(([t,e])=>t&&e.updating)}isQueued(){return this.sourceBuffers.some(([t])=>t&&!!this.currentOp(t))}isPending(t){return!!t&&!t.buffer}blockBuffers(t,e=this.sourceBufferTypes){if(!e.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(t);let{operationQueue:i}=this,s=e.map(t=>this.appendBlocker(t));return e.length>1&&this.blockedAudioAppend&&this.unblockAudio(),Promise.all(s).then(e=>{i===this.operationQueue&&(t(),this.stepOperationQueue(this.sourceBufferTypes))})}stepOperationQueue(t){t.forEach(t=>{var e;let i=null==(e=this.tracks[t])?void 0:e.buffer;i&&!i.updating&&this.shiftAndExecuteNext(t)})}append(t,e,i){this.operationQueue&&this.operationQueue.append(t,e,i)}appendBlocker(t){if(this.operationQueue)return this.operationQueue.appendBlocker(t)}currentOp(t){return this.operationQueue?this.operationQueue.current(t):null}executeNext(t){t&&this.operationQueue&&this.operationQueue.executeNext(t)}shiftAndExecuteNext(t){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(t)}get pendingTrackCount(){return Object.keys(this.tracks).reduce((t,e)=>t+ +!!this.isPending(this.tracks[e]),0)}get sourceBufferCount(){return this.sourceBuffers.reduce((t,[e])=>t+ +!!e,0)}get sourceBufferTypes(){return this.sourceBuffers.map(([t])=>t).filter(t=>!!t)}addBufferListener(t,e,i){let s=this.tracks[t];if(!s)return;let r=s.buffer;if(!r)return;let a=i.bind(this,t);s.listeners.push({event:e,listener:a}),r.addEventListener(e,a)}removeBufferListeners(t){let e=this.tracks[t];if(!e)return;let i=e.buffer;i&&(e.listeners.forEach(t=>{i.removeEventListener(t.event,t.listener)}),e.listeners.length=0)}},capLevelController:sR,errorController:class extends P{constructor(t){super("error-controller",t.logger),this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.hls=t,this.registerListeners()}registerListeners(){let t=this.hls;t.on(h.ERROR,this.onError,this),t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){let t=this.hls;t&&(t.off(h.ERROR,this.onError,this),t.off(h.ERROR,this.onErrorOut,this),t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(t){}stopLoad(){this.playlistError=0}getVariantLevelIndex(t){return(null==t?void 0:t.type)===x.MAIN?t.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(t,e){var i,s,r,a;if(e.fatal)return;let n=this.hls,h=e.context;switch(e.details){case o.FRAG_LOAD_ERROR:case o.FRAG_LOAD_TIMEOUT:case o.KEY_LOAD_ERROR:case o.KEY_LOAD_TIMEOUT:e.errorAction=this.getFragRetryOrSwitchAction(e);return;case o.FRAG_PARSING_ERROR:if(null!=(i=e.frag)&&i.gap){e.errorAction=t6();return}case o.FRAG_GAP:case o.FRAG_DECRYPT_ERROR:e.errorAction=this.getFragRetryOrSwitchAction(e),e.errorAction.action=t4.SendAlternateToPenaltyBox;return;case o.LEVEL_EMPTY_ERROR:case o.LEVEL_PARSING_ERROR:{let t=e.parent===x.MAIN?e.level:n.loadLevel;e.details===o.LEVEL_EMPTY_ERROR&&null!=(s=e.context)&&null!=(r=s.levelDetails)&&r.live?e.errorAction=this.getPlaylistRetryOrSwitchAction(e,t):(e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t))}return;case o.LEVEL_LOAD_ERROR:case o.LEVEL_LOAD_TIMEOUT:"number"==typeof(null==h?void 0:h.level)&&(e.errorAction=this.getPlaylistRetryOrSwitchAction(e,h.level));return;case o.AUDIO_TRACK_LOAD_ERROR:case o.AUDIO_TRACK_LOAD_TIMEOUT:case o.SUBTITLE_LOAD_ERROR:case o.SUBTITLE_TRACK_LOAD_TIMEOUT:if(h){let t=n.loadLevelObj;t&&(h.type===_.AUDIO_TRACK&&t.hasAudioGroup(h.groupId)||h.type===_.SUBTITLE_TRACK&&t.hasSubtitleGroup(h.groupId))&&(e.errorAction=this.getPlaylistRetryOrSwitchAction(e,n.loadLevel),e.errorAction.action=t4.SendAlternateToPenaltyBox,e.errorAction.flags=t8.MoveAllAlternatesMatchingHost)}return;case o.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{let t=n.loadLevelObj,i=null==t?void 0:t.attrs["HDCP-LEVEL"];i?e.errorAction={action:t4.SendAlternateToPenaltyBox,flags:t8.MoveAllAlternatesMatchingHDCP,hdcpLevel:i}:this.keySystemError(e)}return;case o.BUFFER_ADD_CODEC_ERROR:case o.REMUX_ALLOC_ERROR:case o.BUFFER_APPEND_ERROR:e.errorAction||(e.errorAction=this.getLevelSwitchAction(e,null!=(a=e.level)?a:n.loadLevel));return;case o.INTERNAL_EXCEPTION:case o.BUFFER_APPENDING_ERROR:case o.BUFFER_FULL_ERROR:case o.LEVEL_SWITCH_ERROR:case o.BUFFER_STALLED_ERROR:case o.BUFFER_SEEK_OVER_HOLE:case o.BUFFER_NUDGE_ON_STALL:e.errorAction=t6();return}e.type===l.KEY_SYSTEM_ERROR&&this.keySystemError(e)}keySystemError(t){let e=this.getVariantLevelIndex(t.frag);t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,e)}getPlaylistRetryOrSwitchAction(t,e){let i=t1(this.hls.config.playlistLoadPolicy,t),s=this.playlistError++;if(t3(i,s,t0(t),t.response))return{action:t4.RetryRequest,flags:t8.None,retryConfig:i,retryCount:s};let r=this.getLevelSwitchAction(t,e);return i&&(r.retryConfig=i,r.retryCount=s),r}getFragRetryOrSwitchAction(t){let e=this.hls,i=this.getVariantLevelIndex(t.frag),s=e.levels[i],{fragLoadPolicy:r,keyLoadPolicy:a}=e.config,n=t1(t.details.startsWith("key")?a:r,t),l=e.levels.reduce((t,e)=>t+e.fragmentError,0);if(s&&(t.details!==o.FRAG_GAP&&s.fragmentError++,t3(n,l,t0(t),t.response)))return{action:t4.RetryRequest,flags:t8.None,retryConfig:n,retryCount:l};let h=this.getLevelSwitchAction(t,i);return n&&(h.retryConfig=n,h.retryCount=l),h}getLevelSwitchAction(t,e){let i=this.hls;null==e&&(e=i.loadLevel);let s=this.hls.levels[e];if(s){var r,a,n,l;let e=t.details;s.loadError++,e===o.BUFFER_APPEND_ERROR&&s.fragmentError++;let h=-1,{levels:d,loadLevel:u,minAutoLevel:c,maxAutoLevel:f}=i;i.autoLevelEnabled||i.config.preserveManualLevelOnError||(i.loadLevel=-1);let g=null==(r=t.frag)?void 0:r.type,p=(g===x.AUDIO&&e===o.FRAG_PARSING_ERROR||"audio"===t.sourceBufferName&&(e===o.BUFFER_ADD_CODEC_ERROR||e===o.BUFFER_APPEND_ERROR))&&d.some(({audioCodec:t})=>s.audioCodec!==t),m="video"===t.sourceBufferName&&(e===o.BUFFER_ADD_CODEC_ERROR||e===o.BUFFER_APPEND_ERROR)&&d.some(({codecSet:t,audioCodec:e})=>s.codecSet!==t&&s.audioCodec===e),{type:y,groupId:v}=null!=(a=t.context)?a:{};for(let i=d.length;i--;){let r=(i+u)%d.length;if(r!==u&&r>=c&&r<=f&&0===d[r].loadError){let i=d[r];if(e===o.FRAG_GAP&&g===x.MAIN&&t.frag){let e=d[r].details;if(e){let i=tQ(t.frag,e.fragments,t.frag.start);if(null!=i&&i.gap)continue}}else if(y===_.AUDIO_TRACK&&i.hasAudioGroup(v)||y===_.SUBTITLE_TRACK&&i.hasSubtitleGroup(v))continue;else if(g===x.AUDIO&&null!=(n=s.audioGroups)&&n.some(t=>i.hasAudioGroup(t))||g===x.SUBTITLE&&null!=(l=s.subtitleGroups)&&l.some(t=>i.hasSubtitleGroup(t))||p&&s.audioCodec===i.audioCodec||!p&&s.audioCodec!==i.audioCodec||m&&s.codecSet===i.codecSet)continue;h=r;break}}if(h>-1&&i.loadLevel!==h)return t.levelRetry=!0,this.playlistError=0,{action:t4.SendAlternateToPenaltyBox,flags:t8.None,nextAutoLevel:h}}return{action:t4.SendAlternateToPenaltyBox,flags:t8.MoveAllAlternatesMatchingHost}}onErrorOut(t,e){var i;switch(null==(i=e.errorAction)?void 0:i.action){case t4.DoNothing:break;case t4.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(e),e.errorAction.resolved||e.details===o.FRAG_GAP?/MediaSource readyState: ended/.test(e.error.message)&&(this.warn(`MediaSource ended after "${e.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError()):e.fatal=!0;case t4.RetryRequest:}if(e.fatal)return void this.hls.stopLoad()}sendAlternateToPenaltyBox(t){let e=this.hls,i=t.errorAction;if(!i)return;let{flags:s,hdcpLevel:r,nextAutoLevel:a}=i;switch(s){case t8.None:this.switchLevel(t,a);break;case t8.MoveAllAlternatesMatchingHDCP:r&&(e.maxHdcpLevel=tM[tM.indexOf(r)-1],i.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${e.maxHdcpLevel}" or lower`)}i.resolved||this.switchLevel(t,a)}switchLevel(t,e){if(void 0!==e&&t.errorAction&&(this.warn(`switching to level ${e} after ${t.details}`),this.hls.nextAutoLevel=e,t.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel,t.details===o.BUFFER_ADD_CODEC_ERROR&&t.mimeType&&"audiovideo"!==t.sourceBufferName)){let e=tR(t.mimeType),i=this.hls.levels;for(let s=i.length;s--;)i[s][`${t.sourceBufferName}Codec`]===e&&this.hls.removeLevel(s)}}},fpsController:class{constructor(t){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=t,this.registerListeners()}setStreamController(t){this.streamController=t}registerListeners(){this.hls.on(h.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(h.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListeners(){this.hls.off(h.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(h.MEDIA_DETACHING,this.onMediaDetaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(t,e){let i=this.hls.config;if(i.capLevelOnFPSDrop){let t=e.media instanceof self.HTMLVideoElement?e.media:null;this.media=t,t&&"function"==typeof t.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}onMediaDetaching(){this.media=null}checkFPS(t,e,i){let s=performance.now();if(e){if(this.lastTime){let t=s-this.lastTime,r=i-this.lastDroppedFrames,a=e-this.lastDecodedFrames,n=1e3*r/t,l=this.hls;if(l.trigger(h.FPS_DROP,{currentDropped:r,currentDecoded:a,totalDroppedFrames:i}),n>0&&r>l.config.fpsDroppedMonitoringThreshold*a){let t=l.currentLevel;l.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+t),t>0&&(-1===l.autoLevelCapping||l.autoLevelCapping>=t)&&(t-=1,l.trigger(h.FPS_DROP_LEVEL_CAPPING,{level:t,droppedLevel:l.currentLevel}),l.autoLevelCapping=t,this.streamController.nextLevelSwitch())}}this.lastTime=s,this.lastDroppedFrames=i,this.lastDecodedFrames=e}}checkFPSInterval(){let t=this.media;if(t)if(this.isVideoPlaybackQualityAvailable){let e=t.getVideoPlaybackQuality();this.checkFPS(t,e.totalVideoFrames,e.droppedVideoFrames)}else this.checkFPS(t,t.webkitDecodedFrameCount,t.webkitDroppedFrameCount)}},stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:eN,requireKeySystemAccessOnStart:!1,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableEmsgKLVMetadata:!1,enableID3MetadataCues:!0,enableInterstitialPlayback:!0,interstitialAppendInPlace:!0,interstitialLiveLookAhead:10,useMediaCapabilities:!0,preserveManualLevelOnError:!1,certLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null}},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},{cueHandler:rZ,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}),{},{subtitleStreamController:class extends iu{constructor(t,e,i){super(t,e,i,"subtitle-stream-controller",x.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}registerListeners(){super.registerListeners();let{hls:t}=this;t.on(h.LEVEL_LOADED,this.onLevelLoaded,this),t.on(h.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.on(h.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.on(h.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(h.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),t.on(h.BUFFER_FLUSHING,this.onBufferFlushing,this)}unregisterListeners(){super.unregisterListeners();let{hls:t}=this;t.off(h.LEVEL_LOADED,this.onLevelLoaded,this),t.off(h.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.off(h.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.off(h.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(h.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),t.off(h.BUFFER_FLUSHING,this.onBufferFlushing,this)}startLoad(t,e){this.stopLoad(),this.state=id.IDLE,this.setInterval(500),this.nextLoadPosition=this.lastCurrentTime=t+this.timelineOffset,this.startPosition=e?-1:t,this.tick()}onManifestLoading(){super.onManifestLoading(),this.mainDetails=null}onMediaDetaching(t,e){this.tracksBuffered=[],super.onMediaDetaching(t,e)}onLevelLoaded(t,e){this.mainDetails=e.details}onSubtitleFragProcessed(t,e){let i,{frag:s,success:r}=e;if(Y(s)&&(this.fragPrevious=s),this.state=id.IDLE,!r)return;let a=this.tracksBuffered[this.currentTrackId];if(!a)return;let n=s.start;for(let t=0;t<a.length;t++)if(n>=a[t].start&&n<=a[t].end){i=a[t];break}let l=s.start+s.duration;i?i.end=l:(i={start:n,end:l},a.push(i)),this.fragmentTracker.fragBuffered(s),this.fragBufferedComplete(s,null),this.media&&this.tick()}onBufferFlushing(t,e){let{startOffset:i,endOffset:s}=e;if(0===i&&s!==Number.POSITIVE_INFINITY){let t=s-1;if(t<=0)return;e.endOffsetSubtitles=Math.max(0,t),this.tracksBuffered.forEach(e=>{for(let i=0;i<e.length;){if(e[i].end<=t){e.shift();continue}if(e[i].start<t)e[i].start=t;else break;i++}}),this.fragmentTracker.removeFragmentsInRange(i,t,x.SUBTITLE)}}onError(t,e){let i=e.frag;(null==i?void 0:i.type)===x.SUBTITLE&&(e.details===o.FRAG_GAP&&this.fragmentTracker.fragBuffered(i,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==id.STOPPED&&(this.state=id.IDLE))}onSubtitleTracksUpdated(t,{subtitleTracks:e}){if(this.levels&&sE(this.levels,e)){this.levels=e.map(t=>new tB(t));return}this.tracksBuffered=[],this.levels=e.map(t=>{let e=new tB(t);return this.tracksBuffered[e.id]=[],e}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,x.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(t,e){var i;if(this.currentTrackId=e.id,!(null!=(i=this.levels)&&i.length)||-1===this.currentTrackId)return void this.clearInterval();let s=this.levels[this.currentTrackId];null!=s&&s.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,s&&this.state!==id.STOPPED&&this.setInterval(500)}onSubtitleTrackLoaded(t,e){var i,s;let{currentTrackId:r,levels:a}=this,{details:n,id:l}=e;if(!a)return void this.warn(`Subtitle tracks were reset while loading level ${l}`);let o=a[l];if(l>=a.length||!o)return;this.log(`Subtitle track ${l} loaded [${n.startSN},${n.endSN}]${n.lastPartSn?`[part-${n.lastPartSn}-${n.lastPartIndex}]`:""},duration:${n.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let d=0;if(n.live||null!=(i=o.details)&&i.live){let t=this.mainDetails;if(n.deltaUpdateFailed||!t)return;let e=t.fragments[0];o.details?0===this.alignPlaylists(n,o.details,null==(s=this.levelLastLoaded)?void 0:s.details)&&e&&e6(n,e.start):n.hasProgramDateTime&&t.hasProgramDateTime?(io(n,t),n.fragmentStart):e&&e6(n,e.start)}o.details=n,this.levelLastLoaded=o,l===r&&(this.hls.trigger(h.SUBTITLE_TRACK_UPDATED,{details:n,id:l,groupId:e.groupId}),this.tick(),n.live&&!this.fragCurrent&&this.media&&this.state===id.IDLE&&(tQ(null,n.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),o.details=void 0)))}_handleFragmentLoadComplete(t){let{frag:e,payload:i}=t,s=e.decryptdata,r=this.hls;if(!this.fragContextChanged(e)&&i&&i.byteLength>0&&null!=s&&s.key&&s.iv&&ex(s.method)){let t=performance.now();this.decrypter.decrypt(new Uint8Array(i),s.key.buffer,s.iv.buffer,eL(s.method)).catch(t=>{throw r.trigger(h.ERROR,{type:l.MEDIA_ERROR,details:o.FRAG_DECRYPT_ERROR,fatal:!1,error:t,reason:t.message,frag:e}),t}).then(i=>{let s=performance.now();r.trigger(h.FRAG_DECRYPTED,{frag:e,payload:i,stats:{tstart:t,tdecrypt:s}})}).catch(t=>{this.warn(`${t.name}: ${t.message}`),this.state=id.IDLE})}}doTick(){if(!this.media){this.state=id.IDLE;return}if(this.state===id.IDLE){let{currentTrackId:t,levels:e}=this,i=null==e?void 0:e[t];if(!i||!e.length||!i.details||this.waitForLive(i))return;let{config:s}=this,r=this.getLoadPosition(),{end:a,len:n}=em.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],r,s.maxBufferHole),l=i.details;if(n>this.hls.maxBufferLength+l.levelTargetDuration)return;let o=l.fragments,h=o.length,d=l.edge,u=null,c=this.fragPrevious;if(a<d){let t=s.maxFragLookUpTolerance;(u=tQ(c,o,Math.max(o[0].start,a),a>d-t?0:t))||!c||!(c.start<o[0].start)||(u=o[0])}else u=o[h-1];if(!(u=this.filterReplacedPrimary(u,i.details)))return;let f=o[u.sn-l.startSN-1];if(f&&f.cc===u.cc&&this.fragmentTracker.getState(f)===t9.NOT_LOADED&&(u=f),this.fragmentTracker.getState(u)===t9.NOT_LOADED){let t=this.mapToInitFragWhenRequired(u);t&&this.loadFragment(t,i,a)}}}loadFragment(t,e,i){Y(t)?super.loadFragment(t,e,i):this._loadInitSegment(t,e)}get mediaBufferTimeRanges(){return new rl(this.tracksBuffered[this.currentTrackId]||[])}},subtitleTrackController:class extends sv{constructor(t){super(t,"subtitle-track-controller"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let t=null,e=s3(this.media.textTracks);for(let i=0;i<e.length;i++)if("hidden"===e[i].mode)t=e[i];else if("showing"===e[i].mode){t=e[i];break}let i=this.findTrackForTextTrack(t);this.subtitleTrack!==i&&this.setSubtitleTrack(i)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(t){this._subtitleDisplay=t,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){let{hls:t}=this;t.on(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.MANIFEST_PARSED,this.onManifestParsed,this),t.on(h.LEVEL_LOADING,this.onLevelLoading,this),t.on(h.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(h.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(h.ERROR,this.onError,this)}unregisterListeners(){let{hls:t}=this;t.off(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.MANIFEST_PARSED,this.onManifestParsed,this),t.off(h.LEVEL_LOADING,this.onLevelLoading,this),t.off(h.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(h.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(h.ERROR,this.onError,this)}onMediaAttached(t,e){this.media=e.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(t){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,t)}onMediaDetaching(t,e){let i=this.media;if(!i)return;let s=!!e.transferMedia;self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||i.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,s||s3(i.textTracks).forEach(t=>{s2(t)})}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(t,e){this.tracks=e.subtitleTracks}onSubtitleTrackLoaded(t,e){let{id:i,groupId:s,details:r}=e,a=this.tracksInGroup[i];if(!a||a.groupId!==s)return void this.warn(`Subtitle track with id:${i} and group:${s} not found in active group ${null==a?void 0:a.groupId}`);let n=a.details;a.details=e.details,this.log(`Subtitle track ${i} "${a.name}" lang:${a.lang} group:${s} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,e,n)}onLevelLoading(t,e){this.switchLevel(e.level)}onLevelSwitching(t,e){this.switchLevel(e.level)}switchLevel(t){let e=this.hls.levels[t];if(!e)return;let i=e.subtitleGroups||null,s=this.groupIds,r=this.currentTrack;if(!i||(null==s?void 0:s.length)!==(null==i?void 0:i.length)||null!=i&&i.some(t=>(null==s?void 0:s.indexOf(t))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;let t=this.tracks.filter(t=>!i||-1!==i.indexOf(t.groupId));if(t.length)this.selectDefaultTrack&&!t.some(t=>t.default)&&(this.selectDefaultTrack=!1),t.forEach((t,e)=>{t.id=e});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=t;let e=this.hls.config.subtitlePreference;if(!r&&e){this.selectDefaultTrack=!1;let i=tW(e,t);if(i>-1)r=t[i];else{let t=tW(e,this.tracks);r=this.tracks[t]}}let s=this.findTrackId(r);-1===s&&r&&(s=this.findTrackId(null)),this.log(`Updating subtitle tracks, ${t.length} track(s) found in "${null==i?void 0:i.join(",")}" group-id`),this.hls.trigger(h.SUBTITLE_TRACKS_UPDATED,{subtitleTracks:t}),-1!==s&&-1===this.trackId&&this.setSubtitleTrack(s)}}findTrackId(t){let e=this.tracksInGroup,i=this.selectDefaultTrack;for(let s=0;s<e.length;s++){let r=e[s];if((!i||r.default)&&(i||t)&&(!t||tY(r,t)))return s}if(t){for(let i=0;i<e.length;i++){let s=e[i];if(sT(t.attrs,s.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return i}for(let i=0;i<e.length;i++){let s=e[i];if(sT(t.attrs,s.attrs,["LANGUAGE"]))return i}}return -1}findTrackForTextTrack(t){if(t){let e=this.tracksInGroup;for(let i=0;i<e.length;i++)if(sb(e[i],t))return i}return -1}onError(t,e){!e.fatal&&e.context&&(e.context.type!==_.SUBTITLE_TRACK||e.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(e.context.groupId)||this.checkRetry(e))}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(t){this.selectDefaultTrack=!1,this.setSubtitleTrack(t)}setSubtitleOption(t){if(this.hls.config.subtitlePreference=t,t){if(-1===t.id)return this.setSubtitleTrack(-1),null;let e=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,e.length){let i=this.currentTrack;if(i&&tY(t,i))return i;let s=tW(t,this.tracksInGroup);if(s>-1){let t=this.tracksInGroup[s];return this.setSubtitleTrack(s),t}{if(i)return null;let s=tW(t,e);if(s>-1)return e[s]}}}return null}loadPlaylist(t){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,t)}loadingPlaylist(t,e){super.loadingPlaylist(t,e);let i=t.id,s=t.groupId,r=this.getUrlWithDirectives(t.url,e),a=t.details,n=null==a?void 0:a.age;this.log(`Loading subtitle ${i} "${t.name}" lang:${t.lang} group:${s}${(null==e?void 0:e.msn)!==void 0?" at sn "+e.msn+" part "+e.part:""}${n&&a.live?" age "+n.toFixed(1)+(a.type?" "+a.type:""):""} ${r}`),this.hls.trigger(h.SUBTITLE_TRACK_LOADING,{url:r,id:i,groupId:s,deliveryDirectives:e||null,track:t})}toggleTrackModes(){let t,{media:e}=this;if(!e)return;let i=s3(e.textTracks),s=this.currentTrack;if(s&&((t=i.filter(t=>sb(s,t))[0])||this.warn(`Unable to find subtitle TextTrack with name "${s.name}" and language "${s.lang}"`)),[].slice.call(i).forEach(e=>{"disabled"!==e.mode&&e!==t&&(e.mode="disabled")}),t){let e=this.subtitleDisplay?"showing":"hidden";t.mode!==e&&(t.mode=e)}}setSubtitleTrack(t){let e=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=t;return}if(t<-1||t>=e.length||!r(t))return void this.warn(`Invalid subtitle track id: ${t}`);this.selectDefaultTrack=!1;let i=this.currentTrack,s=e[t]||null;if(this.trackId=t,this.currentTrack=s,this.toggleTrackModes(),!s)return void this.hls.trigger(h.SUBTITLE_TRACK_SWITCH,{id:t});let a=!!s.details&&!s.details.live;if(t===this.trackId&&s===i&&a)return;this.log(`Switching to subtitle-track ${t}`+(s?` "${s.name}" lang:${s.lang} group:${s.groupId}`:""));let{id:n,groupId:l="",name:o,type:d,url:u}=s;this.hls.trigger(h.SUBTITLE_TRACK_SWITCH,{id:n,groupId:l,name:o,type:d,url:u});let c=this.switchParams(s.url,null==i?void 0:i.details,s.details);this.loadPlaylist(c)}},timelineController:class{constructor(t){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=rX(),this.captionsProperties=void 0,this.hls=t,this.config=t.config,this.Cues=t.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},t.on(h.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(h.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.on(h.FRAG_LOADING,this.onFragLoading,this),t.on(h.FRAG_LOADED,this.onFragLoaded,this),t.on(h.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),t.on(h.FRAG_DECRYPTED,this.onFragDecrypted,this),t.on(h.INIT_PTS_FOUND,this.onInitPtsFound,this),t.on(h.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),t.on(h.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){let{hls:t}=this;t.off(h.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(h.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.off(h.FRAG_LOADING,this.onFragLoading,this),t.off(h.FRAG_LOADED,this.onFragLoaded,this),t.off(h.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),t.off(h.FRAG_DECRYPTED,this.onFragDecrypted,this),t.off(h.INIT_PTS_FOUND,this.onInitPtsFound,this),t.off(h.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),t.off(h.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){let t=new rj(this,"textTrack1"),e=new rj(this,"textTrack2"),i=new rj(this,"textTrack3"),s=new rj(this,"textTrack4");this.cea608Parser1=new rS(1,t,e),this.cea608Parser2=new rS(3,i,s)}addCues(t,e,i,s,r){let a=!1;for(let t=r.length;t--;){var n,l;let s=r[t],o=(n=s[0],l=s[1],Math.min(l,i)-Math.max(n,e));if(o>=0&&(s[0]=Math.min(s[0],e),s[1]=Math.max(s[1],i),a=!0,o/(i-e)>.5))return}if(a||r.push([e,i]),this.config.renderTextTracksNatively){let r=this.captionsTracks[t];this.Cues.newCue(r,e,i,s)}else{let r=this.Cues.newCue(null,e,i,s);this.hls.trigger(h.CUES_PARSED,{type:"captions",cues:r,track:t})}}onInitPtsFound(t,{frag:e,id:i,initPTS:s,timescale:r}){let{unparsedVttFrags:a}=this;i===x.MAIN&&(this.initPTS[e.cc]={baseTime:s,timescale:r}),a.length&&(this.unparsedVttFrags=[],a.forEach(t=>{this.onFragLoaded(h.FRAG_LOADED,t)}))}getExistingTrack(t,e){let{media:i}=this;if(i)for(let s=0;s<i.textTracks.length;s++){let r=i.textTracks[s];if(rq(r,{name:t,lang:e,characteristics:"transcribes-spoken-dialog,describes-music-and-sound"}))return r}return null}createCaptionsTrack(t){this.config.renderTextTracksNatively?this.createNativeTrack(t):this.createNonNativeTrack(t)}createNativeTrack(t){if(this.captionsTracks[t])return;let{captionsProperties:e,captionsTracks:i,media:s}=this,{label:r,languageCode:a}=e[t],n=this.getExistingTrack(r,a);if(n)i[t]=n,s2(i[t]),s0(i[t],s);else{let e=this.createTextTrack("captions",r,a);e&&(e[t]=!0,i[t]=e)}}createNonNativeTrack(t){if(this.nonNativeCaptionsTracks[t])return;let e=this.captionsProperties[t];if(!e)return;let i={_id:t,label:e.label,kind:"captions",default:!!e.media&&!!e.media.default,closedCaptions:e.media};this.nonNativeCaptionsTracks[t]=i,this.hls.trigger(h.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[i]})}createTextTrack(t,e,i){let s=this.media;if(s)return s.addTextTrack(t,e,i)}onMediaAttaching(t,e){this.media=e.media,e.mediaSource||this._cleanTracks()}onMediaDetaching(t,e){let i=!!e.transferMedia;if(this.media=null,i)return;let{captionsTracks:s}=this;Object.keys(s).forEach(t=>{s2(s[t]),delete s[t]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=rX(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){let{media:t}=this;if(!t)return;let e=t.textTracks;if(e)for(let t=0;t<e.length;t++)s2(e[t])}onSubtitleTracksUpdated(t,e){let i=e.subtitleTracks||[],s=i.some(t=>t.textCodec===rN);if(this.config.enableWebVTT||s&&this.config.enableIMSC1){if(sE(this.tracks,i)){this.tracks=i;return}if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){let t=this.media,e=t?s3(t.textTracks):null;if(this.tracks.forEach((t,i)=>{let s;if(e){let i=null;for(let s=0;s<e.length;s++)if(e[s]&&rq(e[s],t)){i=e[s],e[s]=null;break}i&&(s=i)}if(s)s2(s);else{let e=rz(t);(s=this.createTextTrack(e,t.name,t.lang))&&(s.mode="disabled")}s&&this.textTracks.push(s)}),null!=e&&e.length){let t=e.filter(t=>null!==t).map(t=>t.label);t.length&&this.hls.logger.warn(`Media element contains unused subtitle tracks: ${t.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){let t=this.tracks.map(t=>({label:t.name,kind:t.type.toLowerCase(),default:t.default,subtitleTrack:t}));this.hls.trigger(h.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:t})}}}onManifestLoaded(t,e){this.config.enableCEA708Captions&&e.captions&&e.captions.forEach(t=>{let e=/(?:CC|SERVICE)([1-4])/.exec(t.instreamId);if(!e)return;let i=`textTrack${e[1]}`,s=this.captionsProperties[i];s&&(s.label=t.name,t.lang&&(s.languageCode=t.lang),s.media=t)})}closedCaptionsForLevel(t){let e=this.hls.levels[t.level];return null==e?void 0:e.attrs["CLOSED-CAPTIONS"]}onFragLoading(t,e){if(this.enabled&&e.frag.type===x.MAIN){var i,s;let{cea608Parser1:t,cea608Parser2:r,lastSn:a}=this,{cc:n,sn:l}=e.frag,o=null!=(i=null==(s=e.part)?void 0:s.index)?i:-1;t&&r&&(l!==a+1||l===a&&o!==this.lastPartIndex+1||n!==this.lastCc)&&(t.reset(),r.reset()),this.lastCc=n,this.lastSn=l,this.lastPartIndex=o}}onFragLoaded(t,e){let{frag:i,payload:s}=e;if(i.type===x.SUBTITLE)if(s.byteLength){let t=i.decryptdata,r="stats"in e;if(null==t||!t.encrypted||r){let t=this.tracks[i.level],r=this.vttCCs;r[i.cc]||(r[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),t&&t.textCodec===rN?this._parseIMSC1(i,s):this._parseVTTs(e)}}else this.hls.trigger(h.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:Error("Empty subtitle payload")})}_parseIMSC1(t,e){let i=this.hls;rG(e,this.initPTS[t.cc],e=>{this._appendCues(e,t.level),i.trigger(h.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:t})},e=>{i.logger.log(`Failed to parse IMSC1: ${e}`),i.trigger(h.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:t,error:e})})}_parseVTTs(t){var e;let{frag:i,payload:s}=t,{initPTS:r,unparsedVttFrags:a}=this,n=r.length-1;if(!r[i.cc]&&-1===n)return void a.push(t);let l=this.hls;!function(t,e,i,s,r,a,n){let l,o=new rP,h=U(new Uint8Array(t)).trim().replace(rC,"\n").split("\n"),d=[],u=e?function(t,e=1){return i7(t,9e4,1/e)}(e.baseTime,e.timescale):0,c="00:00.000",f=0,g=0,p=!0;o.oncue=function(t){let a=i[s],n=i.ccOffset,o=(f-u)/9e4;if(null!=a&&a.new&&(void 0!==g?n=i.ccOffset=a.start:rF(i,s,o)),o){if(!e){l=Error("Missing initPTS for VTT MPEGTS");return}n=o-i.presentationOffset}let h=t.endTime-t.startTime,c=sa((t.startTime+n-g)*9e4,9e4*r)/9e4;t.startTime=Math.max(c,0),t.endTime=Math.max(c+h,0);let p=t.text.trim();t.text=decodeURIComponent(encodeURIComponent(p)),t.id||(t.id=rO(t.startTime,t.endTime,p)),t.endTime>0&&d.push(t)},o.onparsingerror=function(t){l=t},o.onflush=function(){if(l)return void n(l);a(d)},h.forEach(t=>{if(p)if(rM(t,"X-TIMESTAMP-MAP=")){p=!1,t.slice(16).split(",").forEach(t=>{rM(t,"LOCAL:")?c=t.slice(6):rM(t,"MPEGTS:")&&(f=parseInt(t.slice(7)))});try{g=rw(c)/1e3}catch(t){l=t}return}else""===t&&(p=!1);o.parse(t+"\n")}),o.flush()}(null!=(e=i.initSegment)&&e.data?td(i.initSegment.data,new Uint8Array(s)).buffer:s,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,t=>{this._appendCues(t,i.level),l.trigger(h.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},e=>{let r="Missing initPTS for VTT MPEGTS"===e.message;r?a.push(t):this._fallbackToIMSC1(i,s),l.logger.log(`Failed to parse VTT cue: ${e}`),r&&n>i.cc||l.trigger(h.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:e})})}_fallbackToIMSC1(t,e){let i=this.tracks[t.level];i.textCodec||rG(e,this.initPTS[t.cc],()=>{i.textCodec=rN,this._parseIMSC1(t,e)},()=>{i.textCodec="wvtt"})}_appendCues(t,e){let i=this.hls;if(this.config.renderTextTracksNatively){let i=this.textTracks[e];if(!i||"disabled"===i.mode)return;t.forEach(t=>s1(i,t))}else{let s=this.tracks[e];if(!s)return;let r=s.default?"default":"subtitles"+e;i.trigger(h.CUES_PARSED,{type:"subtitles",cues:t,track:r})}}onFragDecrypted(t,e){let{frag:i}=e;i.type===x.SUBTITLE&&this.onFragLoaded(h.FRAG_LOADED,e)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(t,e){if(!this.enabled||!this.config.enableCEA708Captions)return;let{frag:i,samples:s}=e;if(i.type!==x.MAIN||"NONE"!==this.closedCaptionsForLevel(i))for(let t=0;t<s.length;t++){let e=s[t].bytes;if(e){this.cea608Parser1||this.initCea608Parsers();let i=this.extractCea608Data(e);this.cea608Parser1.addData(s[t].pts,i[0]),this.cea608Parser2.addData(s[t].pts,i[1])}}}onBufferFlushing(t,{startOffset:e,endOffset:i,endOffsetSubtitles:s,type:r}){let{media:a}=this;if(a&&!(a.currentTime<i)){if(!r||"video"===r){let{captionsTracks:t}=this;Object.keys(t).forEach(s=>s5(t[s],e,i))}if(this.config.renderTextTracksNatively&&0===e&&void 0!==s){let{textTracks:t}=this;Object.keys(t).forEach(i=>s5(t[i],e,s))}}}extractCea608Data(t){let e=[[],[]],i=31&t[0],s=2;for(let r=0;r<i;r++){let i=t[s++],r=127&t[s++],a=127&t[s++];if((0!==r||0!==a)&&(4&i)!=0){let t=3&i;(0===t||1===t)&&(e[t].push(r),e[t].push(a))}}return e}},audioStreamController:class extends iu{constructor(t,e,i){super(t,e,i,"audio-stream-controller",x.AUDIO),this.mainAnchor=null,this.mainFragLoading=null,this.audioOnly=!1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.resetItem()}resetItem(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null}registerListeners(){super.registerListeners();let{hls:t}=this;t.on(h.LEVEL_LOADED,this.onLevelLoaded,this),t.on(h.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.on(h.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(h.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.on(h.BUFFER_RESET,this.onBufferReset,this),t.on(h.BUFFER_CREATED,this.onBufferCreated,this),t.on(h.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(h.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(h.INIT_PTS_FOUND,this.onInitPtsFound,this),t.on(h.FRAG_LOADING,this.onFragLoading,this),t.on(h.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){let{hls:t}=this;t&&(super.unregisterListeners(),t.off(h.LEVEL_LOADED,this.onLevelLoaded,this),t.off(h.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.off(h.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(h.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.off(h.BUFFER_RESET,this.onBufferReset,this),t.off(h.BUFFER_CREATED,this.onBufferCreated,this),t.off(h.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(h.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(h.INIT_PTS_FOUND,this.onInitPtsFound,this),t.off(h.FRAG_LOADING,this.onFragLoading,this),t.off(h.FRAG_BUFFERED,this.onFragBuffered,this))}onInitPtsFound(t,{frag:e,id:i,initPTS:s,timescale:r}){if(i===x.MAIN){let t=e.cc,i=this.fragCurrent;if(this.initPTS[t]={baseTime:s,timescale:r},this.log(`InitPTS for cc: ${t} found from main: ${s}/${r}`),this.mainAnchor=e,this.state===id.WAITING_INIT_PTS){let i=this.waitingData;(i||this.loadingParts)&&(!i||i.frag.cc===t)||this.syncWithAnchor(e,null==i?void 0:i.frag)}else!this.hls.hasEnoughToStart&&i&&i.cc!==t?(i.abortRequests(),this.syncWithAnchor(e,i)):this.state===id.IDLE&&this.tick()}}getLoadPosition(){return!this.startFragRequested&&this.nextLoadPosition>=0?this.nextLoadPosition:super.getLoadPosition()}syncWithAnchor(t,e){var i;let s=(null==(i=this.mainFragLoading)?void 0:i.frag)||null;if(e&&(null==s?void 0:s.cc)===e.cc)return;let r=(s||t).cc,a=tJ(this.getLevelDetails(),r,this.getLoadPosition());a&&(this.log(`Waiting fragment cc (${null==e?void 0:e.cc}) cancelled because video is at cc ${t.cc}`),this.startFragRequested=!1,this.nextLoadPosition=a.start,this.resetLoadingState(),this.state===id.IDLE&&this.doTickIdle())}startLoad(t,e){if(!this.levels){this.startPosition=t,this.state=id.STOPPED;return}let i=this.lastCurrentTime;this.stopLoad(),this.setInterval(100),i>0&&-1===t?(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),t=i,this.state=id.IDLE):this.state=id.WAITING_TRACK,this.nextLoadPosition=this.lastCurrentTime=t+this.timelineOffset,this.startPosition=e?-1:t,this.tick()}doTick(){switch(this.state){case id.IDLE:this.doTickIdle();break;case id.WAITING_TRACK:{let{levels:t,trackId:e}=this,i=null==t?void 0:t[e],s=null==i?void 0:i.details;if(s&&!this.waitForLive(i)){if(this.waitForCdnTuneIn(s))break;this.state=id.WAITING_INIT_PTS}break}case id.FRAG_LOADING_WAITING_RETRY:{var t;let e=performance.now(),i=this.retryDate;if(!i||e>=i||null!=(t=this.media)&&t.seeking){let{levels:t,trackId:e}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((null==t?void 0:t[e])||null),this.state=id.IDLE}break}case id.WAITING_INIT_PTS:{let t=this.waitingData;if(t){let{frag:e,part:i,cache:s,complete:r}=t,a=this.mainAnchor;if(void 0!==this.initPTS[e.cc]){this.waitingData=null,this.state=id.FRAG_LOADING;let t={frag:e,part:i,payload:s.flush().buffer,networkDetails:null};this._handleFragmentLoadProgress(t),r&&super._handleFragmentLoadComplete(t)}else a&&a.cc!==t.frag.cc&&this.syncWithAnchor(a,t.frag)}else this.state=id.IDLE}}this.onTickEnd()}resetLoadingState(){let t=this.waitingData;t&&(this.fragmentTracker.removeFragment(t.frag),this.waitingData=null),super.resetLoadingState()}onTickEnd(){let{media:t}=this;null!=t&&t.readyState&&(this.lastCurrentTime=t.currentTime)}doTickIdle(){var t;let{hls:e,levels:i,media:s,trackId:r}=this,a=e.config;if(!this.buffering||!s&&!this.primaryPrefetch&&(this.startFragRequested||!a.startFragPrefetch)||!(null!=i&&i[r]))return;let n=i[r],l=n.details;if(!l||this.waitForLive(n)||this.waitForCdnTuneIn(l)){this.state=id.WAITING_TRACK,this.startFragRequested=!1;return}let o=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&o&&(this.bufferFlushed=!1,this.afterBufferFlushed(o,K.AUDIO,x.AUDIO));let d=this.getFwdBufferInfo(o,x.AUDIO);if(null===d)return;if(!this.switchingTrack&&this._streamEnded(d,l)){e.trigger(h.BUFFER_EOS,{type:"audio"}),this.state=id.ENDED;return}let u=d.len,c=e.maxBufferLength,f=l.fragments,g=f[0].start,p=this.getLoadPosition(),m=this.flushing?p:d.end;if(this.switchingTrack&&s&&l.PTSKnown&&p<g&&(d.end>g||d.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),s.currentTime=g+.05),u>=c&&!this.switchingTrack&&m<f[f.length-1].start)return;let y=this.getNextFragment(m,l);if(y&&this.isLoopLoading(y,m)&&(y=this.getNextFragmentLoopLoading(y,l,d,x.MAIN,c)),!y){this.bufferFlushed=!0;return}let v=(null==(t=this.mainFragLoading)?void 0:t.frag)||null;if(!this.audioOnly&&this.startFragRequested&&v&&Y(y)&&!y.endList&&(!l.live||!this.loadingParts&&m<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(v)===t9.OK&&(this.mainFragLoading=v=null),v&&Y(v))){if(y.start>v.end){let t=this.fragmentTracker.getFragAtPos(m,x.MAIN);t&&t.end>v.end&&(v=t,this.mainFragLoading={frag:t,targetBufferTime:null})}if(y.start>v.end)return}this.loadFragment(y,n,m)}onMediaDetaching(t,e){this.bufferFlushed=this.flushing=!1,super.onMediaDetaching(t,e)}onAudioTracksUpdated(t,{audioTracks:e}){this.resetTransmuxer(),this.levels=e.map(t=>new tB(t))}onAudioTrackSwitching(t,e){let i=!!e.url;this.trackId=e.id;let{fragCurrent:s}=this;s&&(s.abortRequests(),this.removeUnbufferedFrags(s.start)),this.resetLoadingState(),i?(this.switchingTrack=e,this.flushAudioIfNeeded(e),this.state!==id.STOPPED&&(this.setInterval(100),this.state=id.IDLE,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=e,this.clearInterval())}onManifestLoading(){super.onManifestLoading(),this.bufferFlushed=this.flushing=this.audioOnly=!1,this.resetItem(),this.trackId=-1}onLevelLoaded(t,e){this.mainDetails=e.details;let i=this.cachedTrackLoadedData;i&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(h.AUDIO_TRACK_LOADED,i))}onAudioTrackLoaded(t,e){var i,s;let{levels:r}=this,{details:a,id:n,groupId:l,track:o}=e;if(!r)return void this.warn(`Audio tracks reset while loading track ${n} "${o.name}" of "${l}"`);let d=this.mainDetails;if(!d||a.endCC>d.endCC||d.expired){this.cachedTrackLoadedData=e,this.state!==id.STOPPED&&(this.state=id.WAITING_TRACK);return}this.cachedTrackLoadedData=null,this.log(`Audio track ${n} "${o.name}" of "${l}" loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""},duration:${a.totalduration}`);let u=r[n],c=0;if(a.live||null!=(i=u.details)&&i.live){if(this.checkLiveUpdate(a),a.deltaUpdateFailed)return;u.details&&(c=this.alignPlaylists(a,u.details,null==(s=this.levelLastLoaded)?void 0:s.details)),a.alignedSliding||(il(a,d),a.alignedSliding||io(a,d),c=a.fragmentStart)}u.details=a,this.levelLastLoaded=u,this.startFragRequested||this.setStartPosition(d,c),this.hls.trigger(h.AUDIO_TRACK_UPDATED,{details:a,id:n,groupId:e.groupId}),this.state!==id.WAITING_TRACK||this.waitForCdnTuneIn(a)||(this.state=id.IDLE),this.tick()}_handleFragmentLoadProgress(t){var e;let i=t.frag,{part:s,payload:r}=t,{config:a,trackId:n,levels:l}=this;if(!l)return void this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);let o=l[n];if(!o)return void this.warn("Audio track is undefined on fragment load progress");let h=o.details;if(!h){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(i.start);return}let d=a.defaultAudioCodec||o.audioCodec||"mp4a.40.2",u=this.transmuxer;u||(u=this.transmuxer=new sy(this.hls,x.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));let c=this.initPTS[i.cc],f=null==(e=i.initSegment)?void 0:e.data;if(void 0!==c){let t=s?s.index:-1,e=new ef(i.level,i.sn,i.stats.chunkCount,r.byteLength,t,-1!==t);u.push(r,f,d,"",i,s,h.totalduration,!1,e,c)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${h.startSN} ,${h.endSN}],track ${n}`);let{cache:t}=this.waitingData=this.waitingData||{frag:i,part:s,cache:new ig,complete:!1};t.push(new Uint8Array(r)),this.state!==id.STOPPED&&(this.state=id.WAITING_INIT_PTS)}}_handleFragmentLoadComplete(t){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(t)}onBufferReset(){this.mediaBuffer=null}onBufferCreated(t,e){this.bufferFlushed=this.flushing=!1;let i=e.tracks.audio;i&&(this.mediaBuffer=i.buffer||null)}onFragLoading(t,e){!this.audioOnly&&e.frag.type===x.MAIN&&Y(e.frag)&&(this.mainFragLoading=e,this.state===id.IDLE&&this.tick())}onFragBuffered(t,e){let{frag:i,part:s}=e;if(i.type!==x.AUDIO){this.audioOnly||i.type!==x.MAIN||i.elementaryStreams.video||i.elementaryStreams.audiovideo||(this.audioOnly=!0,this.mainFragLoading=null);return}if(this.fragContextChanged(i))return void this.warn(`Fragment ${i.sn}${s?" p: "+s.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);if(Y(i)){this.fragPrevious=i;let t=this.switchingTrack;t&&(this.bufferedTrack=t,this.switchingTrack=null,this.hls.trigger(h.AUDIO_TRACK_SWITCHED,k({},t)))}this.fragBufferedComplete(i,s),this.media&&this.tick()}onError(t,e){var i;if(e.fatal){this.state=id.ERROR;return}switch(e.details){case o.FRAG_GAP:case o.FRAG_PARSING_ERROR:case o.FRAG_DECRYPT_ERROR:case o.FRAG_LOAD_ERROR:case o.FRAG_LOAD_TIMEOUT:case o.KEY_LOAD_ERROR:case o.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(x.AUDIO,e);break;case o.AUDIO_TRACK_LOAD_ERROR:case o.AUDIO_TRACK_LOAD_TIMEOUT:case o.LEVEL_PARSING_ERROR:e.levelRetry||this.state!==id.WAITING_TRACK||(null==(i=e.context)?void 0:i.type)!==_.AUDIO_TRACK||(this.state=id.IDLE);break;case o.BUFFER_ADD_CODEC_ERROR:case o.BUFFER_APPEND_ERROR:if("audio"!==e.parent)return;this.resetLoadingState();break;case o.BUFFER_FULL_ERROR:if("audio"!==e.parent)return;this.reduceLengthAndFlushBuffer(e)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case o.INTERNAL_EXCEPTION:this.recoverWorkerError(e)}}onBufferFlushing(t,{type:e}){e!==K.VIDEO&&(this.flushing=!0)}onBufferFlushed(t,{type:e}){if(e!==K.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===id.ENDED&&(this.state=id.IDLE);let t=this.mediaBuffer||this.media;t&&(this.afterBufferFlushed(t,e,x.AUDIO),this.tick())}}_handleTransmuxComplete(t){var e;let i="audio",{hls:s}=this,{remuxResult:r,chunkMeta:a}=t,n=this.getCurrentContext(a);if(!n)return void this.resetWhenMissingContext(a);let{frag:l,part:o,level:d}=n,{details:u}=d,{audio:c,text:f,id3:g,initSegment:p}=r;if(this.fragContextChanged(l)||!u)return void this.fragmentTracker.removeFragment(l);if(this.state=id.PARSING,this.switchingTrack&&c&&this.completeAudioSwitch(this.switchingTrack),null!=p&&p.tracks){let t=l.initSegment||l;this._bufferInitSegment(d,p.tracks,t,a),s.trigger(h.FRAG_PARSING_INIT_SEGMENT,{frag:t,id:i,tracks:p.tracks})}if(c){let{startPTS:t,endPTS:e,startDTS:i,endDTS:s}=c;o&&(o.elementaryStreams[K.AUDIO]={startPTS:t,endPTS:e,startDTS:i,endDTS:s}),l.setElementaryStreamInfo(K.AUDIO,t,e,i,s),this.bufferFragmentData(c,l,o,a)}if(null!=g&&null!=(e=g.samples)&&e.length){let t=R({id:i,frag:l,details:u},g);s.trigger(h.FRAG_PARSING_METADATA,t)}if(f){let t=R({id:i,frag:l,details:u},f);s.trigger(h.FRAG_PARSING_USERDATA,t)}}_bufferInitSegment(t,e,i,s){if(this.state!==id.PARSING||(e.video&&delete e.video,e.audiovideo&&delete e.audiovideo,!e.audio))return;let r=e.audio;r.id=x.AUDIO;let a=t.audioCodec;this.log(`Init audio buffer, container:${r.container}, codecs[level/parsed]=[${a}/${r.codec}]`),a&&1===a.split(",").length&&(r.levelCodec=a),this.hls.trigger(h.BUFFER_CODECS,e);let n=r.initSegment;if(null!=n&&n.byteLength){let t={type:"audio",frag:i,part:null,chunkMeta:s,parent:i.type,data:n};this.hls.trigger(h.BUFFER_APPENDING,t)}this.tickImmediate()}loadFragment(t,e,i){let s=this.fragmentTracker.getState(t);if(this.switchingTrack||s===t9.NOT_LOADED||s===t9.PARTIAL){var r;if(Y(t))if(null!=(r=e.details)&&r.live&&!this.initPTS[t.cc]){this.log(`Waiting for video PTS in continuity counter ${t.cc} of live stream before loading audio fragment ${t.sn} of level ${this.trackId}`),this.state=id.WAITING_INIT_PTS;let i=this.mainDetails;i&&i.fragmentStart!==e.details.fragmentStart&&io(e.details,i)}else super.loadFragment(t,e,i);else this._loadInitSegment(t,e)}else this.clearTrackerIfNeeded(t)}flushAudioIfNeeded(t){if(this.media&&this.bufferedTrack){let{name:e,lang:i,assocLang:s,characteristics:r,audioCodec:a,channels:n}=this.bufferedTrack;tY({name:e,lang:i,assocLang:s,characteristics:r,audioCodec:a,channels:n},t,tj)||(tq(t.url,this.hls)?(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null):this.bufferedTrack=t)}}completeAudioSwitch(t){let{hls:e}=this;this.flushAudioIfNeeded(t),this.bufferedTrack=t,this.switchingTrack=null,e.trigger(h.AUDIO_TRACK_SWITCHED,k({},t))}},audioTrackController:class extends sv{constructor(t){super(t,"audio-track-controller"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){let{hls:t}=this;t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.MANIFEST_PARSED,this.onManifestParsed,this),t.on(h.LEVEL_LOADING,this.onLevelLoading,this),t.on(h.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(h.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.on(h.ERROR,this.onError,this)}unregisterListeners(){let{hls:t}=this;t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.MANIFEST_PARSED,this.onManifestParsed,this),t.off(h.LEVEL_LOADING,this.onLevelLoading,this),t.off(h.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(h.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.off(h.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(t,e){this.tracks=e.audioTracks||[]}onAudioTrackLoaded(t,e){let{id:i,groupId:s,details:r}=e,a=this.tracksInGroup[i];if(!a||a.groupId!==s)return void this.warn(`Audio track with id:${i} and group:${s} not found in active group ${null==a?void 0:a.groupId}`);let n=a.details;a.details=e.details,this.log(`Audio track ${i} "${a.name}" lang:${a.lang} group:${s} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,e,n)}onLevelLoading(t,e){this.switchLevel(e.level)}onLevelSwitching(t,e){this.switchLevel(e.level)}switchLevel(t){let e=this.hls.levels[t];if(!e)return;let i=e.audioGroups||null,s=this.groupIds,r=this.currentTrack;if(!i||(null==s?void 0:s.length)!==(null==i?void 0:i.length)||null!=i&&i.some(t=>(null==s?void 0:s.indexOf(t))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;let t=this.tracks.filter(t=>!i||-1!==i.indexOf(t.groupId));if(t.length)this.selectDefaultTrack&&!t.some(t=>t.default)&&(this.selectDefaultTrack=!1),t.forEach((t,e)=>{t.id=e});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=t;let e=this.hls.config.audioPreference;if(!r&&e){let i=tW(e,t,tj);if(i>-1)r=t[i];else{let t=tW(e,this.tracks);r=this.tracks[t]}}let s=this.findTrackId(r);-1===s&&r&&(s=this.findTrackId(null)),this.log(`Updating audio tracks, ${t.length} track(s) found in group(s): ${null==i?void 0:i.join(",")}`),this.hls.trigger(h.AUDIO_TRACKS_UPDATED,{audioTracks:t});let n=this.trackId;if(-1!==s&&-1===n)this.setAudioTrack(s);else if(t.length&&-1===n){var a;let e=Error(`No audio track selected for current audio group-ID(s): ${null==(a=this.groupIds)?void 0:a.join(",")} track count: ${t.length}`);this.warn(e.message),this.hls.trigger(h.ERROR,{type:l.MEDIA_ERROR,details:o.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:e})}}}onError(t,e){!e.fatal&&e.context&&(e.context.type!==_.AUDIO_TRACK||e.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(e.context.groupId)||this.checkRetry(e))}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(t){this.selectDefaultTrack=!1,this.setAudioTrack(t)}setAudioOption(t){let e=this.hls;if(e.config.audioPreference=t,t){let i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){let s=this.currentTrack;if(s&&tY(t,s,tj))return s;let r=tW(t,this.tracksInGroup,tj);if(r>-1){let t=this.tracksInGroup[r];return this.setAudioTrack(r),t}if(s){let s=e.loadLevel;-1===s&&(s=e.firstAutoLevel);let r=function(t,e,i,s,r){let a=e[s],n=e.reduce((t,e,i)=>{let s=e.uri;return(t[s]||(t[s]=[])).push(i),t},{})[a.uri];n.length>1&&(s=Math.max.apply(Math,n));let l=a.videoRange,o=a.frameRate,h=a.codecSet.substring(0,4),d=tz(e,s,e=>{if(e.videoRange!==l||e.frameRate!==o||e.codecSet.substring(0,4)!==h)return!1;let s=e.audioGroups;return tW(t,i.filter(t=>!s||-1!==s.indexOf(t.groupId)),r)>-1});return d>-1?d:tz(e,s,e=>{let s=e.audioGroups;return tW(t,i.filter(t=>!s||-1!==s.indexOf(t.groupId)),r)>-1})}(t,e.levels,i,s,tj);if(-1===r)return null;e.nextLoadLevel=r}if(t.channels||t.audioCodec){let e=tW(t,i);if(e>-1)return i[e]}}}return null}setAudioTrack(t){let e=this.tracksInGroup;if(t<0||t>=e.length)return void this.warn(`Invalid audio track id: ${t}`);this.selectDefaultTrack=!1;let i=this.currentTrack,s=e[t],r=s.details&&!s.details.live;if(t===this.trackId&&s===i&&r||(this.log(`Switching to audio-track ${t} "${s.name}" lang:${s.lang} group:${s.groupId} channels:${s.channels}`),this.trackId=t,this.currentTrack=s,this.hls.trigger(h.AUDIO_TRACK_SWITCHING,k({},s)),r))return;let a=this.switchParams(s.url,null==i?void 0:i.details,s.details);this.loadPlaylist(a)}findTrackId(t){let e=this.tracksInGroup;for(let i=0;i<e.length;i++){let s=e[i];if((!this.selectDefaultTrack||s.default)&&(!t||tY(t,s,tj)))return i}if(t){let{name:i,lang:s,assocLang:r,characteristics:a,audioCodec:n,channels:l}=t;for(let t=0;t<e.length;t++)if(tY({name:i,lang:s,assocLang:r,characteristics:a,audioCodec:n,channels:l},e[t],tj))return t;for(let i=0;i<e.length;i++){let s=e[i];if(sT(t.attrs,s.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return i}for(let i=0;i<e.length;i++){let s=e[i];if(sT(t.attrs,s.attrs,["LANGUAGE"]))return i}}return -1}loadPlaylist(t){super.loadPlaylist();let e=this.currentTrack;this.shouldLoadPlaylist(e)&&tq(e.url,this.hls)&&this.scheduleLoading(e,t)}loadingPlaylist(t,e){super.loadingPlaylist(t,e);let i=t.id,s=t.groupId,r=this.getUrlWithDirectives(t.url,e),a=t.details,n=null==a?void 0:a.age;this.log(`Loading audio-track ${i} "${t.name}" lang:${t.lang} group:${s}${(null==e?void 0:e.msn)!==void 0?" at sn "+e.msn+" part "+e.part:""}${n&&a.live?" age "+n.toFixed(1)+(a.type?" "+a.type:""):""} ${r}`),this.hls.trigger(h.AUDIO_TRACK_LOADING,{url:r,id:i,groupId:s,deliveryDirectives:e||null,track:t})}},emeController:sZ,cmcdController:class{constructor(t){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=t=>{try{this.apply(t,{ot:sD.MANIFEST,su:!this.initialized})}catch(t){this.hls.logger.warn("Could not generate manifest CMCD data.",t)}},this.applyFragmentData=t=>{try{let{frag:e,part:i}=t,s=this.hls.levels[e.level],r=this.getObjectType(e),a={d:1e3*(i||e).duration,ot:r};(r===sD.VIDEO||r===sD.AUDIO||r==sD.MUXED)&&(a.br=s.bitrate/1e3,a.tb=this.getTopBandwidth(r)/1e3,a.bl=this.getBufferLength(r));let n=i?this.getNextPart(i):this.getNextFrag(e);null!=n&&n.url&&n.url!==e.url&&(a.nor=n.url),this.apply(t,a)}catch(t){this.hls.logger.warn("Could not generate segment CMCD data.",t)}},this.hls=t;let e=this.config=t.config,{cmcd:i}=e;null!=i&&(e.pLoader=this.createPlaylistLoader(),e.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||t.sessionId,this.cid=i.contentId,this.useHeaders=!0===i.useHeaders,this.includeKeys=i.includeKeys,this.registerListeners())}registerListeners(){let t=this.hls;t.on(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(h.MEDIA_DETACHED,this.onMediaDetached,this),t.on(h.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){let t=this.hls;t.off(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(h.MEDIA_DETACHED,this.onMediaDetached,this),t.off(h.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null}onMediaAttached(t,e){this.media=e.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(t,e){var i,s;this.audioBuffer=null==(i=e.tracks.audio)?void 0:i.buffer,this.videoBuffer=null==(s=e.tracks.video)?void 0:s.buffer}createData(){var t;return{v:1,sf:"h",sid:this.sid,cid:this.cid,pr:null==(t=this.media)?void 0:t.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(t,e={}){R(e,this.createData());let i=e.ot===sD.INIT||e.ot===sD.VIDEO||e.ot===sD.MUXED;this.starved&&i&&(e.bs=!0,e.su=!0,this.starved=!1),null==e.su&&(e.su=this.buffering);let{includeKeys:s}=this;s&&(e=Object.keys(e).reduce((t,i)=>(s.includes(i)&&(t[i]=e[i]),t),{}));let r={baseUrl:t.url};if(this.useHeaders){var a;t.headers||(t.headers={}),a=t.headers,R(a,function(t,e={}){let i={};if(!t)return i;let s=Object.entries(t),r=Object.entries(sP).concat(Object.entries((null==e?void 0:e.customHeaderMap)||{}));return Object.entries(s.reduce((t,e)=>{var i,s;let[a,n]=e,l=(null==(i=r.find(t=>t[1].includes(a)))?void 0:i[0])||sk.REQUEST;return null!=t[l]||(t[l]={}),t[l][a]=n,t},{})).reduce((t,[i,s])=>(t[i]=sY(s,e),t),i)}(e,r))}else t.url=function(t,e,i){let s=function(t,e={}){if(!t)return"";let i=sY(t,e);return`CMCD=${encodeURIComponent(i)}`}(e,i);if(!s)return t;if(sj.test(t))return t.replace(sj,s);let r=t.includes("?")?"&":"?";return`${t}${r}${s}`}(t.url,e,r)}getNextFrag(t){var e;let i=null==(e=this.hls.levels[t.level])?void 0:e.details;if(i){let e=t.sn-i.startSN;return i.fragments[e+1]}}getNextPart(t){var e,i;let{index:s,fragment:r}=t,a=null==(e=this.hls.levels[r.level])||null==(i=e.details)?void 0:i.partList;if(a){let{sn:t}=r;for(let e=a.length-1;e>=0;e--){let i=a[e];if(i.index===s&&i.fragment.sn===t)return a[e+1]}}}getObjectType(t){let{type:e}=t;return"subtitle"===e?sD.TIMED_TEXT:"initSegment"===t.sn?sD.INIT:"audio"===e?sD.AUDIO:"main"===e?this.hls.audioTracks.length?sD.VIDEO:sD.MUXED:void 0}getTopBandwidth(t){let e,i=0,s=this.hls;if(t===sD.AUDIO)e=s.audioTracks;else{let t=s.maxAutoLevel,i=t>-1?t+1:s.levels.length;e=s.levels.slice(0,i)}return e.forEach(t=>{t.bitrate>i&&(i=t.bitrate)}),i>0?i:NaN}getBufferLength(t){let e=this.media,i=t===sD.AUDIO?this.audioBuffer:this.videoBuffer;return i&&e?1e3*em.bufferInfo(i,e.currentTime,this.config.maxBufferHole).len:NaN}createPlaylistLoader(){let{pLoader:t}=this.config,e=this.applyPlaylistData,i=t||this.config.loader;return class{constructor(t){this.loader=void 0,this.loader=new i(t)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(t,i,s){e(t),this.loader.load(t,i,s)}}}createFragmentLoader(){let{fLoader:t}=this.config,e=this.applyFragmentData,i=t||this.config.loader;return class{constructor(t){this.loader=void 0,this.loader=new i(t)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(t,i,s){e(t),this.loader.load(t,i,s)}}}},contentSteeringController:class extends P{constructor(t){super("content-steering",t.logger),this.hls=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this._pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=t,this.registerListeners()}registerListeners(){let t=this.hls;t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(h.MANIFEST_PARSED,this.onManifestParsed,this),t.on(h.ERROR,this.onError,this)}unregisterListeners(){let t=this.hls;t&&(t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(h.MANIFEST_PARSED,this.onManifestParsed,this),t.off(h.ERROR,this.onError,this))}pathways(){return(this.levels||[]).reduce((t,e)=>(-1===t.indexOf(e.pathwayId)&&t.push(e.pathwayId),t),[])}get pathwayPriority(){return this._pathwayPriority}set pathwayPriority(t){this.updatePathwayPriority(t)}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){let t=1e3*this.timeToLoad-(performance.now()-this.updated);if(t>0)return void this.scheduleRefresh(this.uri,t)}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){-1!==this.reloadTimer&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(t){let e=this.levels;e&&(this.levels=e.filter(e=>e!==t))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(t,e){let{contentSteering:i}=e;null!==i&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(t,e){this.audioTracks=e.audioTracks,this.subtitleTracks=e.subtitleTracks}onError(t,e){let{errorAction:i}=e;if((null==i?void 0:i.action)===t4.SendAlternateToPenaltyBox&&i.flags===t8.MoveAllAlternatesMatchingHost){let t=this.levels,s=this._pathwayPriority,r=this.pathwayId;if(e.context){let{groupId:i,pathwayId:s,type:a}=e.context;i&&t?r=this.getPathwayForGroupId(i,a,r):s&&(r=s)}r in this.penalizedPathways||(this.penalizedPathways[r]=performance.now()),!s&&t&&(s=this.pathways()),s&&s.length>1&&(this.updatePathwayPriority(s),i.resolved=this.pathwayId!==r),i.resolved||this.warn(`Could not resolve ${e.details} ("${e.error.message}") with content-steering for Pathway: ${r} levels: ${t?t.length:t} priorities: ${tG(s)} penalized: ${tG(this.penalizedPathways)}`)}}filterParsedLevels(t){this.levels=t;let e=this.getLevelsForPathway(this.pathwayId);if(0===e.length){let i=t[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),e=this.getLevelsForPathway(i),this.pathwayId=i}return e.length!==t.length&&this.log(`Found ${e.length}/${t.length} levels in Pathway "${this.pathwayId}"`),e}getLevelsForPathway(t){return null===this.levels?[]:this.levels.filter(e=>t===e.pathwayId)}updatePathwayPriority(t){let e;this._pathwayPriority=t;let i=this.penalizedPathways,s=performance.now();Object.keys(i).forEach(t=>{s-i[t]>3e5&&delete i[t]});for(let s=0;s<t.length;s++){let r=t[s];if(r in i)continue;if(r===this.pathwayId)return;let a=this.hls.nextLoadLevel,n=this.hls.levels[a];if((e=this.getLevelsForPathway(r)).length>0){this.log(`Setting Pathway to "${r}"`),this.pathwayId=r,ii(e),this.hls.trigger(h.LEVELS_UPDATED,{levels:e});let t=this.hls.levels[a];n&&t&&this.levels&&(t.attrs["STABLE-VARIANT-ID"]!==n.attrs["STABLE-VARIANT-ID"]&&t.bitrate!==n.bitrate&&this.log(`Unstable Pathways change from bitrate ${n.bitrate} to ${t.bitrate}`),this.hls.nextLoadLevel=a);break}}}getPathwayForGroupId(t,e,i){let s=this.getLevelsForPathway(i).concat(this.levels||[]);for(let i=0;i<s.length;i++)if(e===_.AUDIO_TRACK&&s[i].hasAudioGroup(t)||e===_.SUBTITLE_TRACK&&s[i].hasSubtitleGroup(t))return s[i].pathwayId;return i}clonePathways(t){let e=this.levels;if(!e)return;let i={},s={};t.forEach(t=>{let{ID:r,"BASE-ID":a,"URI-REPLACEMENT":n}=t;if(e.some(t=>t.pathwayId===r))return;let l=this.getLevelsForPathway(a).map(t=>{let e=new eS(t.attrs);e["PATHWAY-ID"]=r;let a=e.AUDIO&&`${e.AUDIO}_clone_${r}`,l=e.SUBTITLES&&`${e.SUBTITLES}_clone_${r}`;a&&(i[e.AUDIO]=a,e.AUDIO=a),l&&(s[e.SUBTITLES]=l,e.SUBTITLES=l);let o=sq(t.uri,e["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",n),h=new tB({attrs:e,audioCodec:t.audioCodec,bitrate:t.bitrate,height:t.height,name:t.name,url:o,videoCodec:t.videoCodec,width:t.width});if(t.audioGroups)for(let e=1;e<t.audioGroups.length;e++)h.addGroupId("audio",`${t.audioGroups[e]}_clone_${r}`);if(t.subtitleGroups)for(let e=1;e<t.subtitleGroups.length;e++)h.addGroupId("text",`${t.subtitleGroups[e]}_clone_${r}`);return h});e.push(...l),sz(this.audioTracks,i,n,r),sz(this.subtitleTracks,s,n,r)})}loadSteeringManifest(t){let e,i=this.hls.config,s=i.loader;this.loader&&this.loader.destroy(),this.loader=new s(i);try{e=new self.URL(t)}catch(e){this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${t}`);return}if("data:"!==e.protocol){let t=0|(this.hls.bandwidthEstimate||i.abrEwmaDefaultEstimate);e.searchParams.set("_HLS_pathway",this.pathwayId),e.searchParams.set("_HLS_throughput",""+t)}let r={responseType:"json",url:e.href},a=i.steeringManifestLoadPolicy.default,n=a.errorRetry||a.timeoutRetry||{},l={loadPolicy:a,timeout:a.maxLoadTimeMs,maxRetry:n.maxNumRetry||0,retryDelay:n.retryDelayMs||0,maxRetryDelay:n.maxRetryDelayMs||0};this.log(`Requesting steering manifest: ${e}`),this.loader.load(r,l,{onSuccess:(t,i,s,r)=>{this.log(`Loaded steering manifest: "${e}"`);let a=t.data;if((null==a?void 0:a.VERSION)!==1)return void this.log(`Steering VERSION ${a.VERSION} not supported!`);this.updated=performance.now(),this.timeToLoad=a.TTL;let{"RELOAD-URI":n,"PATHWAY-CLONES":l,"PATHWAY-PRIORITY":o}=a;if(n)try{this.uri=new self.URL(n,e).href}catch(t){this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${n}`);return}this.scheduleRefresh(this.uri||s.url),l&&this.clonePathways(l);let d={steeringManifest:a,url:e.toString()};this.hls.trigger(h.STEERING_MANIFEST_LOADED,d),o&&this.updatePathwayPriority(o)},onError:(t,e,i,s)=>{if(this.log(`Error loading steering manifest: ${t.code} ${t.text} (${e.url})`),this.stopLoad(),410===t.code){this.enabled=!1,this.log(`Steering manifest ${e.url} no longer available`);return}let r=1e3*this.timeToLoad;if(429===t.code){let t=this.loader;if("function"==typeof(null==t?void 0:t.getResponseHeader)){let e=t.getResponseHeader("Retry-After");e&&(r=1e3*parseFloat(e))}this.log(`Steering manifest ${e.url} rate limited`);return}this.scheduleRefresh(this.uri||e.url,r)},onTimeout:(t,e,i)=>{this.log(`Timeout loading steering manifest (${e.url})`),this.scheduleRefresh(this.uri||e.url)}})}scheduleRefresh(t,e=1e3*this.timeToLoad){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var e;let i=null==(e=this.hls)?void 0:e.media;if(i&&!i.ended)return void this.loadSteeringManifest(t);this.scheduleRefresh(t,1e3*this.timeToLoad)},e)}},interstitialsController:class extends P{constructor(t,e){super("interstitials",t.logger),this.HlsPlayerClass=void 0,this.hls=void 0,this.assetListLoader=void 0,this.mediaSelection=null,this.altSelection=null,this.media=null,this.detachedData=null,this.requiredTracks=null,this.manager=null,this.playerQueue=[],this.bufferedPos=-1,this.timelinePos=-1,this.schedule=void 0,this.playingItem=null,this.bufferingItem=null,this.waitingItem=null,this.endedItem=null,this.playingAsset=null,this.endedAsset=null,this.bufferingAsset=null,this.shouldPlay=!1,this.onPlay=()=>{this.shouldPlay=!0},this.onPause=()=>{this.shouldPlay=!1},this.onSeeking=()=>{let t=this.currentTime;if(void 0===t||this.playbackDisabled)return;let e=t-this.timelinePos;if(Math.abs(e)<1/7056e5)return;let i=e<=-.01;this.timelinePos=t,this.bufferedPos=t;let s=this.playingItem;if(!s)return void this.checkBuffer();if(i&&this.schedule.resetErrorsInRange(t,t-e)&&this.updateSchedule(),this.checkBuffer(),i&&t<s.start||t>=s.end){var r;let t=this.schedule.findItemIndexAtTime(this.timelinePos);if(!this.isInterstitial(s)&&null!=(r=this.media)&&r.paused&&(this.shouldPlay=!1),!i){let e=this.findItemIndex(s);if(t>e){let i=this.schedule.findJumpRestrictedIndex(e+1,t);if(i>e)return void this.setSchedulePosition(i)}}this.setSchedulePosition(t);return}let a=this.playingAsset;if(!a){if(this.playingLastItem&&this.isInterstitial(s)){let e=s.event.assetList[0];e&&(this.endedItem=this.playingItem,this.playingItem=null,this.setScheduleToAssetAtTime(t,e))}return}let n=a.timelineStart,l=a.duration||0;(i&&t<n||t>=n+l)&&this.setScheduleToAssetAtTime(t,a)},this.onTimeupdate=()=>{let t=this.currentTime;if(void 0===t||this.playbackDisabled||!(t>this.timelinePos))return;this.timelinePos=t,t>this.bufferedPos&&this.checkBuffer();let e=this.playingItem;if(!e||this.playingLastItem)return;if(t>=e.end){this.timelinePos=e.end;let t=this.findItemIndex(e);this.setSchedulePosition(t+1)}let i=this.playingAsset;i&&t>=i.timelineStart+(i.duration||0)&&this.setScheduleToAssetAtTime(t,i)},this.onScheduleUpdate=(t,e)=>{let i=this.schedule,s=this.playingItem,r=i.events||[],a=i.items||[],n=i.durations,l=t.map(t=>t.identifier),o=!!(r.length||l.length);(o||e)&&this.log(`INTERSTITIALS_UPDATED (${r.length}): ${r}
Schedule: ${a.map(t=>rr(t))} pos: ${this.timelinePos}`),l.length&&this.log(`Removed events ${l}`),this.playerQueue.forEach(t=>{if(t.interstitial.appendInPlace){let e=t.assetItem.timelineStart,i=t.timelineOffset-e;if(i)try{t.timelineOffset=e}catch(s){Math.abs(i)>.025&&this.warn(`${s} ("${t.assetId}" ${t.timelineOffset}->${e})`)}}});let d=null;if(s){let t=this.updateItem(s,this.timelinePos);this.itemsMatch(s,t)&&(this.playingItem=t,this.waitingItem=this.endedItem=null,d=()=>this.trimInPlace(t,s))}else this.waitingItem=this.updateItem(this.waitingItem),this.endedItem=this.updateItem(this.endedItem);let u=this.bufferingItem;if(u){let t=this.updateItem(u,this.bufferedPos);this.itemsMatch(u,t)?(this.bufferingItem=t,d||(d=()=>this.trimInPlace(t,u))):u.event&&(this.bufferingItem=this.playingItem,this.clearInterstitial(u.event,null))}if(t.forEach(t=>{t.assetList.forEach(t=>{this.clearAssetPlayer(t.identifier,null)})}),o||e){if(this.hls.trigger(h.INTERSTITIALS_UPDATED,{events:r.slice(0),schedule:a.slice(0),durations:n,removedIds:l}),this.isInterstitial(s)&&l.includes(s.event.identifier)){this.warn(`Interstitial "${s.event.identifier}" removed while playing`),this.primaryFallback(s.event);return}d&&d(),this.checkBuffer()}},this.hls=t,this.HlsPlayerClass=e,this.assetListLoader=new ra(t),this.schedule=new rs(this.onScheduleUpdate,t.logger),this.registerListeners()}registerListeners(){let t=this.hls;t.on(h.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.LEVEL_UPDATED,this.onLevelUpdated,this),t.on(h.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(h.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),t.on(h.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.on(h.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),t.on(h.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),t.on(h.ASSET_LIST_LOADED,this.onAssetListLoaded,this),t.on(h.BUFFER_APPENDED,this.onBufferAppended,this),t.on(h.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(h.BUFFERED_TO_END,this.onBufferedToEnd,this),t.on(h.MEDIA_ENDED,this.onMediaEnded,this),t.on(h.ERROR,this.onError,this),t.on(h.DESTROYING,this.onDestroying,this)}unregisterListeners(){let t=this.hls;t&&(t.off(h.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.LEVEL_UPDATED,this.onLevelUpdated,this),t.off(h.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(h.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),t.off(h.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.off(h.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),t.off(h.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),t.off(h.ASSET_LIST_LOADED,this.onAssetListLoaded,this),t.off(h.BUFFER_CODECS,this.onBufferCodecs,this),t.off(h.BUFFER_APPENDED,this.onBufferAppended,this),t.off(h.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(h.BUFFERED_TO_END,this.onBufferedToEnd,this),t.off(h.MEDIA_ENDED,this.onMediaEnded,this),t.off(h.ERROR,this.onError,this),t.off(h.DESTROYING,this.onDestroying,this))}startLoad(){this.resumeBuffering()}stopLoad(){this.pauseBuffering()}resumeBuffering(){var t;null==(t=this.getBufferingPlayer())||t.resumeBuffering()}pauseBuffering(){var t;null==(t=this.getBufferingPlayer())||t.pauseBuffering()}destroy(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.manager=null,this.hls=this.HlsPlayerClass=this.schedule=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null}onDestroying(){let t=this.primaryMedia||this.media;t&&this.removeMediaListeners(t)}removeMediaListeners(t){sQ(t,"play",this.onPlay),sQ(t,"pause",this.onPause),sQ(t,"seeking",this.onSeeking),sQ(t,"timeupdate",this.onTimeupdate)}onMediaAttaching(t,e){let i=this.media=e.media;sX(i,"seeking",this.onSeeking),sX(i,"timeupdate",this.onTimeupdate),sX(i,"play",this.onPlay),sX(i,"pause",this.onPause)}onMediaAttached(t,e){let i=this.effectivePlayingItem,s=this.detachedData;if(this.detachedData=null,null===i)this.checkStart();else if(!s){this.clearScheduleState();let t=this.findItemIndex(i);this.setSchedulePosition(t)}}clearScheduleState(){this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null}onMediaDetaching(t,e){let i=!!e.transferMedia,s=this.media;if(this.media=null,!i&&(s&&this.removeMediaListeners(s),this.detachedData)){let t=this.getBufferingPlayer();t&&(this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,t.detachMedia()),this.shouldPlay=!1}}get interstitialsManager(){if(!this.manager){if(!this.hls)return null;let o=this,h=()=>o.bufferingItem||o.waitingItem,d=t=>t?o.getAssetPlayer(t.identifier):t,u=(t,e,i,s,r)=>{if(t){let a=t[e].start,n=t.event;if(n){if("playout"===e||n.timelineOccupancy!==s8.Point){let t=d(i);(null==t?void 0:t.interstitial)===n&&(a+=t.assetItem.startOffset+t[r])}}else a+=("bufferedPos"===s?f():o[s])-t.start;return a}return 0},c=(t,e)=>{if(0!==t&&"primary"!==e&&o.schedule.length){var i;let s=o.schedule.findItemIndexAtTime(t),r=null==(i=o.schedule.items)?void 0:i[s];if(r)return t+(r[e].start-r.start)}return t},f=()=>{let t=o.bufferedPos;return t===Number.MAX_VALUE?g("primary"):Math.max(t,0)},g=t=>{var e;return null!=(e=o.primaryDetails)&&e.live?o.primaryDetails.edge:o.schedule.durations[t]},p=(t,e)=>{var i,s,r;let a=o.effectivePlayingItem;if(null!=a&&null!=(i=a.event)&&i.restrictions.skip)return;o.log(`seek to ${t} "${e}"`);let n=o.effectivePlayingItem,l=o.schedule.findItemIndexAtTime(t,e),h=null==(s=o.schedule.items)?void 0:s[l],c=o.getBufferingPlayer(),f=null==c?void 0:c.interstitial,g=null==f?void 0:f.appendInPlace,p=n&&o.itemsMatch(n,h);if(n&&(g||p)){let i=d(o.playingAsset),s=(null==i?void 0:i.media)||o.primaryMedia;if(s){let r="primary"===e?s.currentTime:u(n,e,o.playingAsset,"timelinePos","currentTime"),a=t-r,l=(g?r:s.currentTime)+a;if(l>=0&&(!i||g||l<=i.duration)){s.currentTime=l;return}}}if(h){let i=t;if("primary"!==e){let s=t-h[e].start;i=h.start+s}let s=!o.isInterstitial(h);if((!o.isInterstitial(n)||n.event.appendInPlace)&&(s||h.event.appendInPlace)){let t=o.media||(g?null==c?void 0:c.media:null);t&&(t.currentTime=i)}else if(n){let a=o.findItemIndex(n);if(l>a){let t=o.schedule.findJumpRestrictedIndex(a+1,l);if(t>a)return void o.setSchedulePosition(t)}let d=0;if(s)o.timelinePos=i,o.checkBuffer();else{let i=null==h||null==(r=h.event)?void 0:r.assetList;if(i){let s=t-(h[e]||h).start;for(let t=i.length;t--;){let e=i[t];if(e.duration&&s>=e.startOffset&&s<e.startOffset+e.duration){d=t;break}}}}o.setSchedulePosition(l,d)}}},m=()=>{let t=o.effectivePlayingItem;if(o.isInterstitial(t))return t;let e=h();return o.isInterstitial(e)?e:null},y={get currentTime(){let t=m(),e=o.effectivePlayingItem;if(e&&e===t)return u(e,"playout",o.effectivePlayingAsset,"timelinePos","currentTime")-e.playout.start;return 0},set currentTime(time){let t=m(),e=o.effectivePlayingItem;e&&e===t&&p(time+e.playout.start,"playout")},get duration(){let t=m();if(t)return t.playout.end-t.playout.start;return 0},get assetPlayers(){var t;let e=null==(t=m())?void 0:t.event.assetList;if(e)return e.map(t=>o.getAssetPlayer(t.identifier));return[]},get playingIndex(){var e;let t=null==(e=m())?void 0:e.event;if(t&&o.effectivePlayingAsset)return t.findAssetIndex(o.effectivePlayingAsset);return -1},get scheduleItem(){return m()}};this.manager={get events(){var i,s;return(null==(i=o.schedule)||null==(s=i.events)?void 0:s.slice(0))||[]},get schedule(){var r,a;return(null==(r=o.schedule)||null==(a=r.items)?void 0:a.slice(0))||[]},get interstitialPlayer(){if(m())return y;return null},get playerQueue(){return o.playerQueue.slice(0)},get bufferingAsset(){return o.bufferingAsset},get bufferingItem(){return h()},get bufferingIndex(){let t=h();return o.findItemIndex(t)},get playingAsset(){return o.effectivePlayingAsset},get playingItem(){return o.effectivePlayingItem},get playingIndex(){let t=o.effectivePlayingItem;return o.findItemIndex(t)},primary:{get bufferedEnd(){return f()},get currentTime(){let t=o.timelinePos;return t>0?t:0},set currentTime(time){p(time,"primary")},get duration(){return g("primary")},get seekableStart(){var n;return(null==(n=o.primaryDetails)?void 0:n.fragmentStart)||0}},integrated:{get bufferedEnd(){return u(h(),"integrated",o.bufferingAsset,"bufferedPos","bufferedEnd")},get currentTime(){return u(o.effectivePlayingItem,"integrated",o.effectivePlayingAsset,"timelinePos","currentTime")},set currentTime(time){p(time,"integrated")},get duration(){return g("integrated")},get seekableStart(){var l;return c((null==(l=o.primaryDetails)?void 0:l.fragmentStart)||0,"integrated")}},skip:()=>{let t=o.effectivePlayingItem,e=null==t?void 0:t.event;if(e&&!e.restrictions.skip){let i=o.findItemIndex(t);e.appendInPlace?p(t.playout.start+t.event.duration+.001,"playout"):o.advanceAfterAssetEnded(e,i,1/0)}}}}return this.manager}get effectivePlayingItem(){return this.waitingItem||this.playingItem||this.endedItem}get effectivePlayingAsset(){return this.playingAsset||this.endedAsset}get playingLastItem(){var t;let e=this.playingItem,i=null==(t=this.schedule)?void 0:t.items;return!!this.playbackStarted&&!!e&&!!i&&this.findItemIndex(e)===i.length-1}get playbackStarted(){return null!==this.effectivePlayingItem}get currentTime(){var t,e,i;if(null===this.mediaSelection)return;let s=this.waitingItem||this.playingItem;if(this.isInterstitial(s)&&!s.event.appendInPlace)return;let a=this.media;!a&&null!=(t=this.bufferingItem)&&null!=(e=t.event)&&e.appendInPlace&&(a=this.primaryMedia);let n=null==(i=a)?void 0:i.currentTime;if(void 0!==n&&r(n))return n}get primaryMedia(){var t;return this.media||(null==(t=this.detachedData)?void 0:t.media)||null}isInterstitial(t){return!!(null!=t&&t.event)}retreiveMediaSource(t,e){let i=this.getAssetPlayer(t);i&&this.transferMediaFromPlayer(i,e)}transferMediaFromPlayer(t,e){let i=t.interstitial.appendInPlace,s=t.media;if(i&&s===this.primaryMedia){if(this.bufferingAsset=null,(!e||this.isInterstitial(e)&&!e.event.appendInPlace)&&e&&s){this.detachedData={media:s};return}let i=t.transferMedia();this.log(`transfer MediaSource from ${t} ${tG(i)}`),this.detachedData=i}else e&&s&&(this.shouldPlay||(this.shouldPlay=!s.paused))}transferMediaTo(t,e){var i,s;let r;if(t.media===e)return;let a=null,n=this.hls,l=t!==n,o=l&&t.interstitial.appendInPlace,h=null==(i=this.detachedData)?void 0:i.mediaSource;if(n.media)o&&(a=n.transferMedia(),this.detachedData=a),r="Primary";else if(h){let t=this.getBufferingPlayer();t?(a=t.transferMedia(),r=`${t}`):r="detached MediaSource"}else r="detached media";if(!a){if(h)a=this.detachedData,this.log(`using detachedData: MediaSource ${tG(a)}`);else if(!this.detachedData||n.media===e){let t=this.playerQueue;t.length>1&&t.forEach(t=>{if(l&&t.interstitial.appendInPlace!==o){let e=t.interstitial;this.clearInterstitial(t.interstitial,null),e.appendInPlace=!1,e.appendInPlace&&this.warn(`Could not change append strategy for queued assets ${e}`)}}),this.hls.detachMedia(),this.detachedData={media:e}}}let d=a&&"mediaSource"in a&&(null==(s=a.mediaSource)?void 0:s.readyState)!=="closed",u=d&&a?a:e;if(this.log(`${d?"transfering MediaSource":"attaching media"} to ${l?t:"Primary"} from ${r}`),u===a){let e=l&&t.assetId===this.schedule.assetIdAtEnd;u.overrides={duration:this.schedule.duration,endOfStream:!l||e,cueRemoval:!l}}t.attachMedia(u)}onInterstitialCueEnter(){this.onTimeupdate()}checkStart(){let t=this.schedule,e=t.events;if(!e||this.playbackDisabled||!this.media)return;-1===this.bufferedPos&&(this.bufferedPos=0);let i=this.timelinePos,s=this.effectivePlayingItem;if(-1===i){let i=this.hls.startPosition;if(this.timelinePos=i,e.length&&e[0].cue.pre){let i=t.findEventIndex(e[0].identifier);this.setSchedulePosition(i)}else if(i>=0||!this.primaryLive){let e=this.timelinePos=i>0?i:0,s=t.findItemIndexAtTime(e);this.setSchedulePosition(s)}}else if(s&&!this.playingItem){let e=t.findItemIndex(s);this.setSchedulePosition(e)}}advanceAfterAssetEnded(t,e,i){let s=rt(t,i);if(t.isAssetPastPlayoutLimit(s)){let i=this.schedule.items;if(i){let s=e+1;if(s>=i.length)return void this.setSchedulePosition(-1);let r=t.resumeTime;this.timelinePos<r&&(this.timelinePos=r,this.checkBuffer()),this.setSchedulePosition(s)}}else this.setSchedulePosition(e,s)}setScheduleToAssetAtTime(t,e){let i=this.schedule,s=e.parentIdentifier,r=i.getEvent(s);if(r){let e=i.findEventIndex(s),a=i.findAssetIndex(r,t);this.advanceAfterAssetEnded(r,e,a-1)}}setSchedulePosition(t,e){let i=this.schedule.items;if(!i||this.playbackDisabled)return;this.log(`setSchedulePosition ${t}, ${e}`);let s=t>=0?i[t]:null,r=this.playingItem,a=this.playingLastItem;if(this.isInterstitial(r)){var n,l;let o=r.event,d=this.playingAsset,u=null==d?void 0:d.identifier,c=u?this.getAssetPlayer(u):null;if(c&&u&&(!this.eventItemsMatch(r,s)||void 0!==e&&u!==(null==(n=o.assetList)?void 0:n[e].identifier))){let e=o.findAssetIndex(d);this.log(`INTERSTITIAL_ASSET_ENDED ${e+1}/${o.assetList.length} ${re(d)}`),this.endedAsset=d,this.playingAsset=null,this.hls.trigger(h.INTERSTITIAL_ASSET_ENDED,{asset:d,assetListIndex:e,event:o,schedule:i.slice(0),scheduleIndex:t,player:c}),this.retreiveMediaSource(u,s),c.media&&!(null!=(l=this.detachedData)&&l.mediaSource)&&c.detachMedia()}if(!this.eventItemsMatch(r,s)&&(this.endedItem=r,this.playingItem=null,this.log(`INTERSTITIAL_ENDED ${o} ${rr(r)}`),o.hasPlayed=!0,this.hls.trigger(h.INTERSTITIAL_ENDED,{event:o,schedule:i.slice(0),scheduleIndex:t}),o.cue.once)){this.updateSchedule();let t=this.schedule.items;if(s&&t){let i=this.schedule.findItemIndex(s);this.advanceSchedule(i,t,e,r,a)}return}}this.advanceSchedule(t,i,e,r,a)}advanceSchedule(t,e,i,s,r){let a=t>=0?e[t]:null,n=this.primaryMedia,l=this.playerQueue;if(l.length&&l.forEach(e=>{let i=e.interstitial,s=this.schedule.findEventIndex(i.identifier);(s<t||s>t+1)&&this.clearInterstitial(i,a)}),this.isInterstitial(a)){this.timelinePos=Math.min(Math.max(this.timelinePos,a.start),a.end);let r=a.event;if(void 0===i){i=this.schedule.findAssetIndex(r,this.timelinePos);let e=rt(r,i-1);if(r.isAssetPastPlayoutLimit(e))return void this.advanceAfterAssetEnded(r,t,i);i=e}let l=this.waitingItem;this.assetsBuffered(a,n)||this.setBufferingItem(a);let o=this.preloadAssets(r,i);if(this.eventItemsMatch(a,l||s)||(this.waitingItem=a,this.log(`INTERSTITIAL_STARTED ${rr(a)} ${r.appendInPlace?"append in place":""}`),this.hls.trigger(h.INTERSTITIAL_STARTED,{event:r,schedule:e.slice(0),scheduleIndex:t})),!r.assetListLoaded)return void this.log(`Waiting for ASSET-LIST to complete loading ${r}`);if(r.assetListLoader&&(r.assetListLoader.destroy(),r.assetListLoader=void 0),!n)return void this.log(`Waiting for attachMedia to start Interstitial ${r}`);this.waitingItem=this.endedItem=null,this.playingItem=a;let d=r.assetList[i];if(!d){let s=e[t+1],a=this.media;s&&a&&!this.isInterstitial(s)&&a.currentTime<s.start&&(a.currentTime=this.timelinePos=s.start),this.advanceAfterAssetEnded(r,t,i||0);return}if(o||(o=this.getAssetPlayer(d.identifier)),null===o||o.destroyed){let t=r.assetList.length;this.warn(`asset ${i+1}/${t} player destroyed ${r}`),o=this.createAssetPlayer(r,d,i)}if(!this.eventItemsMatch(a,this.bufferingItem)&&r.appendInPlace&&this.isAssetBuffered(d))return;this.startAssetPlayer(o,i,e,t,n),this.shouldPlay&&rn(o.media)}else null!==a?(this.resumePrimary(a,t,s),this.shouldPlay&&rn(this.hls.media)):r&&this.isInterstitial(s)&&(this.endedItem=null,this.playingItem=s,s.event.appendInPlace||this.attachPrimary(this.schedule.durations.primary,null))}get playbackDisabled(){return!1===this.hls.config.enableInterstitialPlayback}get primaryDetails(){var t,e;return null==(t=this.mediaSelection)||null==(e=t.main)?void 0:e.details}get primaryLive(){var t;return!!(null!=(t=this.primaryDetails)&&t.live)}resumePrimary(t,e,i){var s;if(this.playingItem=t,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(t),this.log(`resuming ${rr(t)}`),!(null!=(s=this.detachedData)&&s.mediaSource)){let i=this.timelinePos;(i<t.start||i>=t.end)&&(i=this.getPrimaryResumption(t,e),this.timelinePos=i),this.attachPrimary(i,t)}if(!i)return;let r=this.schedule.items;r&&(this.log(`INTERSTITIALS_PRIMARY_RESUMED ${rr(t)}`),this.hls.trigger(h.INTERSTITIALS_PRIMARY_RESUMED,{schedule:r.slice(0),scheduleIndex:e}),this.checkBuffer())}getPrimaryResumption(t,e){let i=t.start;if(this.primaryLive){let t=this.primaryDetails;if(0===e)return this.hls.startPosition;if(t&&(i<t.fragmentStart||i>t.edge))return this.hls.liveSyncPosition||-1}return i}isAssetBuffered(t){let e=this.getAssetPlayer(t.identifier);return null!=e&&e.hls?e.hls.bufferedToEnd:em.bufferInfo(this.primaryMedia,this.timelinePos,0).end+1>=t.timelineStart+(t.duration||0)}attachPrimary(t,e,i){e?this.setBufferingItem(e):this.bufferingItem=this.playingItem,this.bufferingAsset=null;let s=this.primaryMedia;if(!s)return;let r=this.hls;r.media?this.checkBuffer():(this.transferMediaTo(r,s),i&&this.startLoadingPrimaryAt(t,i)),i||(this.timelinePos=t,this.startLoadingPrimaryAt(t,i))}startLoadingPrimaryAt(t,e){var i;let s=this.hls;!s.loadingEnabled||!s.media||Math.abs(((null==(i=s.mainForwardBufferInfo)?void 0:i.start)||s.media.currentTime)-t)>.5?s.startLoad(t,e):s.bufferingEnabled||s.resumeBuffering()}onManifestLoading(){this.stopLoad(),this.schedule.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=!1,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(h.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(h.BUFFER_CODECS,this.onBufferCodecs,this)}onLevelUpdated(t,e){if(-1===e.level)return;let i=this.hls.levels[e.level],s=k(k({},this.mediaSelection||this.altSelection),{},{main:i});this.mediaSelection=s,this.schedule.parseInterstitialDateRanges(s,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart()}onAudioTrackUpdated(t,e){let i=this.hls.audioTracks[e.id],s=this.mediaSelection;if(!s){this.altSelection=k(k({},this.altSelection),{},{audio:i});return}let r=k(k({},s),{},{audio:i});this.mediaSelection=r}onSubtitleTrackUpdated(t,e){let i=this.hls.subtitleTracks[e.id],s=this.mediaSelection;if(!s){this.altSelection=k(k({},this.altSelection),{},{subtitles:i});return}let r=k(k({},s),{},{subtitles:i});this.mediaSelection=r}onAudioTrackSwitching(t,e){let i=tK(e);this.playerQueue.forEach(t=>t.hls.setAudioOption(e)||t.hls.setAudioOption(i))}onSubtitleTrackSwitch(t,e){let i=tK(e);this.playerQueue.forEach(t=>t.hls.setSubtitleOption(e)||-1!==e.id&&t.hls.setSubtitleOption(i))}onBufferCodecs(t,e){let i=e.tracks;i&&(this.requiredTracks=i)}onBufferAppended(t,e){this.checkBuffer()}onBufferFlushed(t,e){let i=this.playingItem;if(i&&!this.itemsMatch(i,this.bufferingItem)&&!this.isInterstitial(i)){let t=this.timelinePos;this.bufferedPos=t,this.checkBuffer()}}onBufferedToEnd(t){let e=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&e){for(let t=0;t<e.length;t++){let s=e[t];if(s.cue.post){var i;let t=this.schedule.findEventIndex(s.identifier),e=null==(i=this.schedule.items)?void 0:i[t];this.isInterstitial(e)&&this.eventItemsMatch(e,this.bufferingItem)&&this.bufferedToItem(e,0);break}}this.bufferedPos=Number.MAX_VALUE}}onMediaEnded(t){let e=this.playingItem;if(!this.playingLastItem&&e){let t=this.findItemIndex(e);this.setSchedulePosition(t+1)}else this.shouldPlay=!1}updateItem(t,e){let i=this.schedule.items;return t&&i&&i[this.findItemIndex(t,e)]||null}trimInPlace(t,e){if(this.isInterstitial(t)&&t.event.appendInPlace&&e.end-t.end>.25){t.event.assetList.forEach((e,i)=>{t.event.isAssetPastPlayoutLimit(i)&&this.clearAssetPlayer(e.identifier,null)});let e=t.end+.25,i=em.bufferInfo(this.primaryMedia,e,0);(i.end>e||(i.nextStart||0)>e)&&(this.attachPrimary(e,null),this.flushFrontBuffer(e))}}itemsMatch(t,e){return!!e&&(t===e||t.event&&e.event&&this.eventItemsMatch(t,e)||!t.event&&!e.event&&this.findItemIndex(t)===this.findItemIndex(e))}eventItemsMatch(t,e){var i;return!!e&&(t===e||t.event.identifier===(null==(i=e.event)?void 0:i.identifier))}findItemIndex(t,e){return t?this.schedule.findItemIndex(t,e):-1}updateSchedule(){let t=this.mediaSelection;t&&this.schedule.updateSchedule(t,[])}checkBuffer(t){let e=this.schedule.items;if(!e)return;let i=em.bufferInfo(this.primaryMedia,this.timelinePos,0);t&&(this.bufferedPos=this.timelinePos),t||(t=i.len<1),this.updateBufferedPos(i.end,e,t)}updateBufferedPos(t,e,i){let s=this.schedule,r=this.bufferingItem;if(this.bufferedPos>t)return;if(1===e.length&&this.itemsMatch(e[0],r)){this.bufferedPos=t;return}let a=this.playingItem,n=this.findItemIndex(a),l=s.findItemIndexAtTime(t);if(this.bufferedPos<t){var o,h;let i=this.findItemIndex(r),s=Math.min(i+1,e.length-1),a=e[s];if((-1===l&&r&&t>=r.end||null!=(o=a.event)&&o.appendInPlace&&t+.01>=a.start)&&(l=s),s-n>1&&(null==r||null==(h=r.event)?void 0:h.appendInPlace)===!1)return;if(this.bufferedPos=t,l>i&&l>n)this.bufferedToItem(a);else{let e=this.primaryDetails;this.primaryLive&&e&&t>e.edge-e.targetduration&&a.start<e.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(a)&&this.preloadAssets(a.event,0)}}else i&&a&&!this.itemsMatch(a,r)&&(l===n?this.bufferedToItem(a):l===n+1&&this.bufferedToItem(e[l]))}assetsBuffered(t,e){return 0!==t.event.assetList.length&&!t.event.assetList.some(t=>{let i=this.getAssetPlayer(t.identifier);return!(null!=i&&i.bufferedInPlaceToEnd(e))})}setBufferingItem(t){let e=this.bufferingItem,i=this.schedule;if(this.itemsMatch(t,e))this.bufferingItem!==t&&(this.bufferingItem=t);else{let{items:s,events:r}=i;if(!s||!r)return e;let a=this.isInterstitial(t),n=this.getBufferingPlayer();this.bufferingItem=t,this.bufferedPos=Math.max(t.start,Math.min(t.end,this.timelinePos));let l=n?n.remaining:e?e.end-this.timelinePos:0;this.log(`INTERSTITIALS_BUFFERED_TO_BOUNDARY ${rr(t)}`+(e?` (${l.toFixed(2)} remaining)`:"")),this.playbackDisabled||(a?t.event.assetList.forEach(t=>{let e=this.getAssetPlayer(t.identifier);e&&e.resumeBuffering()}):(this.hls.resumeBuffering(),this.playerQueue.forEach(t=>t.pauseBuffering()))),this.hls.trigger(h.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:r.slice(0),schedule:s.slice(0),bufferingIndex:this.findItemIndex(t),playingIndex:this.findItemIndex(this.playingItem)})}return e}bufferedToItem(t,e=0){let i=this.setBufferingItem(t);if(!this.playbackDisabled){if(this.isInterstitial(t))this.bufferedToEvent(t,e);else if(null!==i){this.bufferingAsset=null;let e=this.detachedData;e&&e.mediaSource?this.attachPrimary(t.start,t,!0):this.preloadPrimary(t)}}}preloadPrimary(t){let e=this.findItemIndex(t),i=this.getPrimaryResumption(t,e);this.startLoadingPrimaryAt(i)}bufferedToEvent(t,e){let i=t.event,s=0===i.assetList.length&&!i.assetListLoader,r=i.cue.once;if(s||!r){let t=this.preloadAssets(i,e);if(null!=t&&t.interstitial.appendInPlace){let s=i.assetList[e],r=this.primaryMedia;s&&r&&this.bufferAssetPlayer(t,r)}}}preloadAssets(t,e){let i=t.assetUrl,s=t.assetList.length,r=0===s&&!t.assetListLoader,a=t.cue.once;if(r){let r,a=t.timelineStart;if(t.appendInPlace){var n;let e=this.playingItem;this.isInterstitial(e)||(null==e||null==(n=e.nextEvent)?void 0:n.identifier)!==t.identifier||this.flushFrontBuffer(a+.25)}let l=0;if(!this.playingItem&&this.primaryLive&&-1===(l=this.hls.startPosition)&&(l=this.hls.liveSyncPosition||0),l&&!(t.cue.pre||t.cue.post)){let t=l-a;t>0&&(r=Math.round(1e3*t)/1e3)}if(this.log(`Load interstitial asset ${e+1}/${i?1:s} ${t}${r?` live-start: ${l} start-offset: ${r}`:""}`),i)return this.createAsset(t,0,0,a,t.duration,i);let o=this.assetListLoader.loadAssetList(t,r);o&&(t.assetListLoader=o)}else if(!a&&s){for(let i=e;i<s;i++){let e=t.assetList[i],s=this.getAssetPlayerQueueIndex(e.identifier);(-1===s||this.playerQueue[s].destroyed)&&!e.error&&this.createAssetPlayer(t,e,i)}return this.getAssetPlayer(t.assetList[e].identifier)}return null}flushFrontBuffer(t){let e=this.requiredTracks;e&&(this.log(`Removing front buffer starting at ${t}`),Object.keys(e).forEach(e=>{this.hls.trigger(h.BUFFER_FLUSHING,{startOffset:t,endOffset:1/0,type:e})}))}getAssetPlayerQueueIndex(t){let e=this.playerQueue;for(let i=0;i<e.length;i++)if(t===e[i].assetId)return i;return -1}getAssetPlayer(t){let e=this.getAssetPlayerQueueIndex(t);return this.playerQueue[e]||null}getBufferingPlayer(){let{playerQueue:t,primaryMedia:e}=this;if(e){for(let i=0;i<t.length;i++)if(t[i].media===e)return t[i]}return null}createAsset(t,e,i,s,r,a){let n={parentIdentifier:t.identifier,identifier:`${t.identifier}-${e+1}-${s4(a)}`,duration:r,startOffset:i,timelineStart:s,uri:a};return this.createAssetPlayer(t,n,e)}createAssetPlayer(t,e,i){let s=this.hls,r=s.userConfig,a=r.videoPreference,n=s.loadLevelObj||s.levels[s.currentLevel];(a||n)&&(a=R({},a),n.videoCodec&&(a.videoCodec=n.videoCodec),n.videoRange&&(a.allowedVideoRanges=[n.videoRange]));let d=s.audioTracks[s.audioTrack],u=s.subtitleTracks[s.subtitleTrack],c=0;if(this.primaryLive||t.appendInPlace){let t=this.timelinePos-e.timelineStart;if(t>1){let i=e.duration;i&&t<i&&(c=t)}}let f=e.identifier,g=k(k({},r),{},{autoStartLoad:!0,startFragPrefetch:!0,primarySessionId:s.sessionId,assetPlayerId:f,abrEwmaDefaultEstimate:s.bandwidthEstimate,interstitialsController:void 0,startPosition:c,liveDurationInfinity:!1,testBandwidth:!1,videoPreference:a,audioPreference:d||r.audioPreference,subtitlePreference:u||r.subtitlePreference});t.appendInPlace&&(t.appendInPlaceStarted=!0,e.timelineStart&&(g.timelineOffset=e.timelineStart));let p=g.cmcd;null!=p&&p.sessionId&&p.contentId&&(g.cmcd=R({},p,{contentId:s4(e.uri)})),this.getAssetPlayer(f)&&this.warn(`Duplicate date range identifier ${t} and asset ${f}`);let m=new ri(this.HlsPlayerClass,g,t,e);this.playerQueue.push(m),t.assetList[i]=e;let y=s=>{if(s.live){let e=Error(`Interstitials MUST be VOD assets ${t}`),s={fatal:!0,type:l.OTHER_ERROR,details:o.INTERSTITIAL_ASSET_ITEM_ERROR,error:e};this.handleAssetItemError(s,t,this.schedule.findEventIndex(t.identifier),i,e.message);return}let r=s.edge-s.fragmentStart,a=e.duration;(null===a||r>a)&&(this.log(`Interstitial asset "${f}" duration change ${a} > ${r}`),e.duration=r,this.updateSchedule())};m.on(h.LEVEL_UPDATED,(t,{details:e})=>y(e)),m.on(h.LEVEL_PTS_UPDATED,(t,{details:e})=>y(e));let v=(t,e)=>{let i=this.getAssetPlayer(f);if(i&&e.tracks){i.off(h.BUFFER_CODECS,v),i.tracks=e.tracks;let t=this.primaryMedia;this.bufferingAsset===i.assetItem&&t&&!i.media&&this.bufferAssetPlayer(i,t)}};m.on(h.BUFFER_CODECS,v);let E=()=>{var i,s;let r=this.getAssetPlayer(f);if(this.log(`buffered to end of asset ${r}`),!r)return;let a=this.schedule.findEventIndex(t.identifier),n=null==(i=this.schedule.items)?void 0:i[a];if(this.isInterstitial(n)){let i=t.findAssetIndex(e),r=rt(t,i);if(t.isAssetPastPlayoutLimit(r)){let t=null==(s=this.schedule.items)?void 0:s[a+1];t&&this.bufferedToItem(t)}else this.bufferedToItem(n,r)}};m.on(h.BUFFERED_TO_END,E);let T=e=>()=>{if(!this.getAssetPlayer(f))return;this.shouldPlay=!0;let i=this.schedule.findEventIndex(t.identifier);this.advanceAfterAssetEnded(t,i,e)};return m.once(h.MEDIA_ENDED,T(i)),m.once(h.PLAYOUT_LIMIT_REACHED,T(1/0)),m.on(h.ERROR,(e,s)=>{let r=this.getAssetPlayer(f);if(s.details===o.BUFFER_STALLED_ERROR){if(null!=r&&r.media){let e=r.currentTime,i=r.duration-e;e&&t.appendInPlace&&i/r.media.playbackRate<.5?(this.log(`Advancing buffer past end of asset ${f} ${t} at ${r.media.currentTime}`),E()):(this.warn(`Stalled at ${e} of ${e+i} in asset ${f} ${t}`),this.onTimeupdate(),this.checkBuffer(!0))}return}this.handleAssetItemError(s,t,this.schedule.findEventIndex(t.identifier),i,`Asset player error ${s.error} ${t}`)}),m.on(h.DESTROYING,()=>{if(!this.getAssetPlayer(f))return;let e=Error(`Asset player destroyed unexpectedly ${f}`),s={fatal:!0,type:l.OTHER_ERROR,details:o.INTERSTITIAL_ASSET_ITEM_ERROR,error:e};this.handleAssetItemError(s,t,this.schedule.findEventIndex(t.identifier),i,e.message)}),this.log(`INTERSTITIAL_ASSET_PLAYER_CREATED ${re(e)}`),this.hls.trigger(h.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:e,assetListIndex:i,event:t,player:m}),m}clearInterstitial(t,e){t.assetList.forEach(t=>{this.clearAssetPlayer(t.identifier,e)}),t.reset()}resetAssetPlayer(t){let e=this.getAssetPlayerQueueIndex(t);if(-1!==e){this.log(`reset asset player "${t}" after error`);let i=this.playerQueue[e];this.transferMediaFromPlayer(i,null),i.resetDetails()}}clearAssetPlayer(t,e){let i=this.getAssetPlayerQueueIndex(t);if(-1!==i){this.log(`clear asset player "${t}" toSegment: ${e?rr(e):e}`);let s=this.playerQueue[i];this.transferMediaFromPlayer(s,e),this.playerQueue.splice(i,1),s.destroy()}}emptyPlayerQueue(){let t;for(;t=this.playerQueue.pop();)t.destroy();this.playerQueue=[]}startAssetPlayer(t,e,i,s,r){let{interstitial:a,assetItem:n,assetId:l}=t,o=a.assetList.length,d=this.playingAsset;this.endedAsset=null,this.playingAsset=n,d&&d.identifier===l||(d&&(this.clearAssetPlayer(d.identifier,i[s]),delete d.error),this.log(`INTERSTITIAL_ASSET_STARTED ${e+1}/${o} ${re(n)}`),this.hls.trigger(h.INTERSTITIAL_ASSET_STARTED,{asset:n,assetListIndex:e,event:a,schedule:i.slice(0),scheduleIndex:s,player:t})),this.bufferAssetPlayer(t,r)}bufferAssetPlayer(t,e){var i,s;let{interstitial:r,assetItem:a}=t,n=this.schedule.findEventIndex(r.identifier),h=null==(i=this.schedule.items)?void 0:i[n];if(!h)return;this.setBufferingItem(h),this.bufferingAsset=a;let d=this.getBufferingPlayer();if(d===t)return;let u=r.appendInPlace;if(u&&(null==d?void 0:d.interstitial.appendInPlace)===!1)return;let c=(null==d?void 0:d.tracks)||(null==(s=this.detachedData)?void 0:s.tracks)||this.requiredTracks;if(u&&a!==this.playingAsset){if(!t.tracks)return;if(c&&!B(c,t.tracks)){let e=Error(`Asset ${re(a)} SourceBuffer tracks ('${Object.keys(t.tracks)}') are not compatible with primary content tracks ('${Object.keys(c)}')`),i={fatal:!0,type:l.OTHER_ERROR,details:o.INTERSTITIAL_ASSET_ITEM_ERROR,error:e},s=r.findAssetIndex(a);this.handleAssetItemError(i,r,n,s,e.message);return}}this.transferMediaTo(t,e)}handleAssetItemError(t,e,i,s,r){if(t.details===o.BUFFER_STALLED_ERROR)return;let a=e.assetList[s];this.warn(`INTERSTITIAL_ASSET_ERROR ${a?re(a):a} ${t.error}`);let n=null==a?void 0:a.identifier,l=this.getAssetPlayerQueueIndex(n),d=this.playerQueue[l]||null,u=this.schedule.items,c=R({},t,{fatal:!1,errorAction:t6(!0),asset:a,assetListIndex:s,event:e,schedule:u,scheduleIndex:i,player:d});if(this.hls.trigger(h.INTERSTITIAL_ASSET_ERROR,c),!t.fatal)return;let f=this.playingAsset,g=Error(r);if(a&&(this.clearAssetPlayer(n,null),a.error=g),e.assetList.some(t=>!t.error)){if(e.appendInPlace){for(let t=s;t<e.assetList.length;t++)this.resetAssetPlayer(e.assetList[t].identifier);this.updateSchedule()}}else e.error=g;e.error?this.primaryFallback(e):f&&f.identifier===n&&this.advanceAfterAssetEnded(e,i,s)}primaryFallback(t){let e=t.timelineStart,i=this.effectivePlayingItem;if(this.updateSchedule(),i){this.log(`Fallback to primary from event "${t.identifier}" start: ${e} pos: ${this.timelinePos} playing: ${i?rr(i):"<none>"} error: ${t.error}`);let s=this.timelinePos;-1===s&&(s=this.hls.startPosition);let r=this.updateItem(i,s);this.itemsMatch(i,r)&&this.clearInterstitial(t,null),t.appendInPlace&&(this.attachPrimary(e,null),this.flushFrontBuffer(e));let a=this.schedule.findItemIndexAtTime(s);this.setSchedulePosition(a)}else this.checkStart()}onAssetListLoaded(t,e){var i,s;let r=e.event,a=r.identifier,n=e.assetListResponse.ASSETS;if(!this.schedule.hasEvent(a))return;let l=r.timelineStart,o=r.duration,h=0;n.forEach((t,e)=>{let i=parseFloat(t.DURATION);this.createAsset(r,e,h,l+h,i,t.URI),h+=i}),r.duration=h,this.log(`Loaded asset-list with duration: ${h} (was: ${o}) ${r}`);let d=this.waitingItem,u=(null==d?void 0:d.event.identifier)===a;this.updateSchedule();let c=null==(i=this.bufferingItem)?void 0:i.event;if(u){let t=this.schedule.findEventIndex(a),e=null==(s=this.schedule.items)?void 0:s[t];if(e){if(!this.playingItem&&this.timelinePos>e.end&&this.schedule.findItemIndexAtTime(this.timelinePos)!==t){r.error=Error(`Interstitial no longer within playback range ${this.timelinePos} ${r}`),this.primaryFallback(r);return}this.setBufferingItem(e)}this.setSchedulePosition(t)}else if((null==c?void 0:c.identifier)===a&&c.appendInPlace){let t=r.assetList[0],e=this.getAssetPlayer(t.identifier),i=this.primaryMedia;t&&e&&i&&this.bufferAssetPlayer(e,i)}}onError(t,e){switch(e.details){case o.ASSET_LIST_PARSING_ERROR:case o.ASSET_LIST_LOAD_ERROR:case o.ASSET_LIST_LOAD_TIMEOUT:{let t=e.interstitial;t&&this.primaryFallback(t);break}case o.BUFFER_STALLED_ERROR:this.onTimeupdate(),this.checkBuffer(!0)}}}});class r8 extends ec{constructor(t,e){super("gap-controller",t.logger),this.hls=null,this.fragmentTracker=null,this.media=null,this.mediaSource=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.buffered={},this.lastCurrentTime=0,this.ended=0,this.waiting=0,this.onMediaPlaying=()=>{this.ended=0,this.waiting=0},this.onMediaWaiting=()=>{var t;null!=(t=this.media)&&t.seeking||(this.waiting=self.performance.now(),this.tick())},this.onMediaEnded=()=>{if(this.hls){var t;this.ended=(null==(t=this.media)?void 0:t.currentTime)||1,this.hls.trigger(h.MEDIA_ENDED,{stalled:!1})}},this.hls=t,this.fragmentTracker=e,this.registerListeners()}registerListeners(){let{hls:t}=this;t&&(t.on(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(h.BUFFER_APPENDED,this.onBufferAppended,this))}unregisterListeners(){let{hls:t}=this;t&&(t.off(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(h.BUFFER_APPENDED,this.onBufferAppended,this))}destroy(){super.destroy(),this.unregisterListeners(),this.media=this.hls=this.fragmentTracker=null,this.mediaSource=void 0}onMediaAttached(t,e){this.setInterval(100),this.mediaSource=e.mediaSource;let i=this.media=e.media;sX(i,"playing",this.onMediaPlaying),sX(i,"waiting",this.onMediaWaiting),sX(i,"ended",this.onMediaEnded)}onMediaDetaching(t,e){this.clearInterval();let{media:i}=this;i&&(sQ(i,"playing",this.onMediaPlaying),sQ(i,"waiting",this.onMediaWaiting),sQ(i,"ended",this.onMediaEnded),this.media=null),this.mediaSource=void 0}onBufferAppended(t,e){this.buffered=e.timeRanges}get hasBuffered(){return Object.keys(this.buffered).length>0}tick(){var t;if(!(null!=(t=this.media)&&t.readyState)||!this.hasBuffered)return;let e=this.media.currentTime;this.poll(e,this.lastCurrentTime),this.lastCurrentTime=e}poll(t,e){var i,s,r;let a=null==(i=this.hls)?void 0:i.config;if(!a)return;let n=this.media;if(!n)return;let{seeking:l}=n,o=this.seeking&&!l,d=!this.seeking&&l,u=n.paused&&!l||n.ended||0===n.playbackRate;if(this.seeking=l,t!==e){e&&(this.ended=0),this.moved=!0,!l&&(this.nudgeRetry=0,a.nudgeOnVideoHole&&!u&&t>e&&this.nudgeOnVideoHole(t,e)),0===this.waiting&&this.stallResolved(t);return}if(d||o){o&&this.stallResolved(t);return}if(u){this.nudgeRetry=0,this.stallResolved(t),!this.ended&&n.ended&&this.hls&&(this.ended=t||1,this.hls.trigger(h.MEDIA_ENDED,{stalled:!1}));return}if(!em.getBuffered(n).length){this.nudgeRetry=0;return}let c=em.bufferInfo(n,t,0),f=c.nextStart||0,g=this.fragmentTracker;if(l&&g&&this.hls){let e=r6(this.hls.inFlightFragments,t),i=c.len>2,s=!f||e||f-t>2&&!g.getPartialFragment(t);if(i||s)return;this.moved=!1}let p=null==(s=this.hls)?void 0:s.latestLevelDetails;if(!this.moved&&null!==this.stalled&&g){if(!(c.len>0)&&!f)return;let e=Math.max(f,c.start||0)-t,i=null!=p&&p.live?2*p.targetduration:2,s=g.getPartialFragment(t);if(e>0&&(e<=i||s)){n.paused||this._trySkipBufferHole(s);return}}let m=a.detectStallWithCurrentTimeMs,y=self.performance.now(),v=this.waiting,E=this.stalled;if(null===E)if(v>0&&y-v<m)E=this.stalled=v;else{this.stalled=y;return}let T=y-E;if(!l&&(T>=m||v)&&this.hls){if((null==(r=this.mediaSource)?void 0:r.readyState)==="ended"&&!(null!=p&&p.live)&&1>Math.abs(t-((null==p?void 0:p.edge)||0))){if(this.ended)return;this.ended=t||1,this.hls.trigger(h.MEDIA_ENDED,{stalled:!0});return}if(this._reportStall(c),!this.media||!this.hls)return}let b=em.bufferInfo(n,t,a.maxBufferHole);this._tryFixBufferStall(b,T,t)}stallResolved(t){let e=this.stalled;if(e&&this.hls&&(this.stalled=null,this.stallReported)){let i=self.performance.now()-e;this.log(`playback not stuck anymore @${t}, after ${Math.round(i)}ms`),this.stallReported=!1,this.waiting=0,this.hls.trigger(h.STALL_RESOLVED,{})}}nudgeOnVideoHole(t,e){var i;let s=this.buffered.video;if(this.hls&&this.media&&this.fragmentTracker&&null!=(i=this.buffered.audio)&&i.length&&s&&s.length>1&&t>s.end(0)){let i=em.bufferedInfo(em.timeRangesToArray(this.buffered.audio),t,0);if(i.len>1&&e>=i.start){let i=em.timeRangesToArray(s),r=em.bufferedInfo(i,e,0).bufferedIndex;if(r>-1&&r<i.length-1){let e=em.bufferedInfo(i,t,0).bufferedIndex,s=i[r].end,a=i[r+1].start;if((-1===e||e>r)&&a-s<1&&t-s<2){let i=Error(`nudging playhead to flush pipeline after video hole. currentTime: ${t} hole: ${s} -> ${a} buffered index: ${e}`);this.warn(i.message),this.media.currentTime+=1e-6;let r=this.fragmentTracker.getPartialFragment(t)||void 0,n=em.bufferInfo(this.media,t,0);this.hls.trigger(h.ERROR,{type:l.MEDIA_ERROR,details:o.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:i,reason:i.message,frag:r,buffer:n.len,bufferInfo:n})}}}}}_tryFixBufferStall(t,e,i){var s,r;let{fragmentTracker:a,media:n}=this,l=null==(s=this.hls)?void 0:s.config;if(!n||!a||!l)return;let o=null==(r=this.hls)?void 0:r.latestLevelDetails,h=a.getPartialFragment(i);if((h||null!=o&&o.live&&i<o.fragmentStart)&&(this._trySkipBufferHole(h)||!this.media))return;let d=t.buffered,u=this.adjacentTraversal(t,i);(d&&d.length>1&&t.len>l.maxBufferHole||t.nextStart&&(t.nextStart-i<l.maxBufferHole||u))&&(e>1e3*l.highBufferWatchdogPeriod||this.waiting)&&(this.warn("Trying to nudge playhead over buffer-hole"),this._tryNudgeBuffer(t))}adjacentTraversal(t,e){let i=this.fragmentTracker,s=t.nextStart;if(i&&s){let t=i.getFragAtPos(e,x.MAIN),r=i.getFragAtPos(s,x.MAIN);if(t&&r)return r.sn-t.sn<2}return!1}_reportStall(t){let{hls:e,media:i,stallReported:s,stalled:r}=this;if(!s&&null!==r&&i&&e){this.stallReported=!0;let s=Error(`Playback stalling at @${i.currentTime} due to low buffer (${tG(t)})`);this.warn(s.message),e.trigger(h.ERROR,{type:l.MEDIA_ERROR,details:o.BUFFER_STALLED_ERROR,fatal:!1,error:s,buffer:t.len,bufferInfo:t,stalled:{start:r}})}}_trySkipBufferHole(t){var e,i;let{fragmentTracker:s,media:r}=this,a=null==(e=this.hls)?void 0:e.config;if(!r||!s||!a)return 0;let n=r.currentTime,d=em.bufferInfo(r,n,0),u=n<d.start?d.start:d.nextStart;if(u&&this.hls){let e=d.len<=a.maxBufferHole,c=d.len>0&&d.len<1&&r.readyState<3,f=u-n;if(f>0&&(e||c)){if(f>a.maxBufferHole){let e=!1;if(0===n){let t=s.getAppendedFrag(0,x.MAIN);t&&u<t.end&&(e=!0)}if(!e){let e=t||s.getAppendedFrag(n,x.MAIN);if(e){if(!(null!=(i=this.hls.loadLevelObj)&&i.details)||r6(this.hls.inFlightFragments,u))return 0;let t=!1,r=e.end;for(;r<u;){let e=s.getPartialFragment(r);if(e)r+=e.duration;else{t=!0;break}}if(t)return 0}}}let e=Math.max(u+.05,n+.1);if(this.warn(`skipping hole, adjusting currentTime from ${n} to ${e}`),this.moved=!0,r.currentTime=e,!(null!=t&&t.gap)){let i=Error(`fragment loaded with buffer holes, seeking from ${n} to ${e}`);this.hls.trigger(h.ERROR,{type:l.MEDIA_ERROR,details:o.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:i,reason:i.message,frag:t||void 0,buffer:d.len,bufferInfo:d})}return e}}return 0}_tryNudgeBuffer(t){let{hls:e,media:i,nudgeRetry:s}=this,r=null==e?void 0:e.config;if(!i||!r)return 0;let a=i.currentTime;if(this.nudgeRetry++,s<r.nudgeMaxRetry){let n=a+(s+1)*r.nudgeOffset,d=Error(`Nudging 'currentTime' from ${a} to ${n}`);this.warn(d.message),i.currentTime=n,e.trigger(h.ERROR,{type:l.MEDIA_ERROR,details:o.BUFFER_NUDGE_ON_STALL,error:d,fatal:!1,buffer:t.len,bufferInfo:t})}else{let i=Error(`Playhead still not moving while enough data buffered @${a} after ${r.nudgeMaxRetry} nudges`);this.error(i.message),e.trigger(h.ERROR,{type:l.MEDIA_ERROR,details:o.BUFFER_STALLED_ERROR,error:i,fatal:!0,buffer:t.len,bufferInfo:t})}}}function r6(t,e){let i=r9(t.main);if(i&&i.start<=e)return i;let s=r9(t.audio);return s&&s.start<=e?s:null}function r9(t){if(!t)return null;switch(t.state){case id.IDLE:case id.STOPPED:case id.ENDED:case id.ERROR:return null}return t.frag}function r7(){if("undefined"!=typeof self)return self.VTTCue||self.TextTrackCue}function at(t,e,i,s,r){let a=new t(e,i,"");try{a.value=s,r&&(a.type=r)}catch(n){a=new t(e,i,tG(r?k({type:r},s):s))}return a}const ae=(()=>{let t=r7();try{t&&new t(0,Number.POSITIVE_INFINITY,"")}catch(t){return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();class ai{constructor(t){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.removeCues=!0,this.onEventCueEnter=()=>{this.hls&&this.hls.trigger(h.EVENT_CUE_ENTER,{})},this.hls=t,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=this.onEventCueEnter=null}_registerListeners(){let{hls:t}=this;t.on(h.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.on(h.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(h.LEVEL_UPDATED,this.onLevelUpdated,this),t.on(h.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)}_unregisterListeners(){let{hls:t}=this;t.off(h.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.off(h.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(h.LEVEL_UPDATED,this.onLevelUpdated,this),t.off(h.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)}onMediaAttaching(t,e){var i;this.media=e.media,(null==(i=e.overrides)?void 0:i.cueRemoval)===!1&&(this.removeCues=!1)}onMediaAttached(){let t=this.hls.latestLevelDetails;t&&this.updateDateRangeCues(t)}onMediaDetaching(t,e){this.media=null,e.transferMedia||(this.id3Track&&(this.removeCues&&s2(this.id3Track,this.onEventCueEnter),this.id3Track=null),this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(t){let e=this.getID3Track(t.textTracks);return e.mode="hidden",e}getID3Track(t){if(this.media){for(let e=0;e<t.length;e++){let i=t[e];if("metadata"===i.kind&&"id3"===i.label)return s0(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(t,e){if(!this.media)return;let{hls:{config:{enableEmsgMetadataCues:i,enableID3MetadataCues:s}}}=this;if(!i&&!s)return;let{samples:r}=e;this.id3Track||(this.id3Track=this.createTrack(this.media));let a=r7();if(a)for(let t=0;t<r.length;t++){let e=r[t].type;if(e===iM.emsg&&!i||!s)continue;let n=ik(r[t].data);if(n){let i=r[t].pts,s=i+r[t].duration;s>ae&&(s=ae),s-i<=0&&(s=i+.25);for(let t=0;t<n.length;t++){let r=n[t];if(!iP(r)){this.updateId3CueEnds(i,e);let t=at(a,i,s,r,e);t&&this.id3Track.addCue(t)}}}}}updateId3CueEnds(t,e){var i;let s=null==(i=this.id3Track)?void 0:i.cues;if(s)for(let i=s.length;i--;){let r=s[i];r.type===e&&r.startTime<t&&r.endTime===ae&&(r.endTime=t)}}onBufferFlushing(t,{startOffset:e,endOffset:i,type:s}){let{id3Track:r,hls:a}=this;if(!a)return;let{config:{enableEmsgMetadataCues:n,enableID3MetadataCues:l}}=a;if(r&&(n||l)){let t;s5(r,e,i,"audio"===s?t=>t.type===iM.audioId3&&l:"video"===s?t=>t.type===iM.emsg&&n:t=>t.type===iM.audioId3&&l||t.type===iM.emsg&&n)}}onLevelUpdated(t,{details:e}){this.updateDateRangeCues(e,!0)}onLevelPtsUpdated(t,e){Math.abs(e.drift)>.01&&this.updateDateRangeCues(e.details)}updateDateRangeCues(t,e){var i,s;if(!this.media||!t.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;let{id3Track:a}=this,{dateRanges:n}=t,l=Object.keys(n),o=this.dateRangeCuesAppended;if(a&&e)if(null!=(i=a.cues)&&i.length){let t=Object.keys(o).filter(t=>!l.includes(t));for(let e=t.length;e--;){let i=t[e],s=o[i].cues;delete o[i],Object.keys(s).forEach(t=>{try{let e=s[t];e.removeEventListener("enter",this.onEventCueEnter),a.removeCue(e)}catch(t){}})}}else o=this.dateRangeCuesAppended={};let h=t.fragments[t.fragments.length-1];if(0===l.length||!r(null==h?void 0:h.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));let d=r7();for(let t=0;t<l.length;t++){let e=l[t],i=n[e],r=i.startTime,a=o[e],h=(null==a?void 0:a.cues)||{},u=(null==a?void 0:a.durationKnown)||!1,c=ae,{duration:f,endDate:g}=i;if(g&&null!==f)c=r+f,u=!0;else if(i.endOnNext&&!u){let t=l.reduce((t,e)=>{if(e!==i.id){let s=n[e];if(s.class===i.class&&s.startDate>i.startDate&&(!t||i.startDate<t.startDate))return s}return t},null);t&&(c=t.startTime,u=!0)}let p=Object.keys(i.attr);for(let t=0;t<p.length;t++){let n=p[t];if("ID"===n||"CLASS"===n||"CUE"===n||"START-DATE"===n||"DURATION"===n||"END-DATE"===n||"END-ON-NEXT"===n)continue;let l=h[n];if(l)u&&!a.durationKnown?l.endTime=c:Math.abs(l.startTime-r)>.01&&(l.startTime=r,l.endTime=c);else if(d){let t=i.attr[n];("SCTE35-OUT"===n||"SCTE35-IN"===n||"SCTE35-CMD"===n)&&(s=t,t=Uint8Array.from(s.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer);let a=at(d,r,c,{key:n,data:t},iM.dateRange);a&&(a.id=e,this.id3Track.addCue(a),h[n]=a,this.hls.config.interstitialsController&&("X-ASSET-LIST"===n||"X-ASSET-URL"===n)&&a.addEventListener("enter",this.onEventCueEnter))}}o[e]={cues:h,dateRange:i,durationKnown:u}}}}class as{constructor(t){this.hls=void 0,this.config=void 0,this.media=null,this.currentTime=0,this.stallCount=0,this._latency=null,this._targetLatencyUpdated=!1,this.onTimeupdate=()=>{let{media:t}=this,e=this.levelDetails;if(!t||!e)return;this.currentTime=t.currentTime;let i=this.computeLatency();if(null===i)return;this._latency=i;let{lowLatencyMode:s,maxLiveSyncPlaybackRate:r}=this.config;if(!s||1===r||!e.live)return;let a=this.targetLatency;if(null===a)return;let n=i-a;if(n<Math.min(this.maxLatency,a+e.targetduration)&&n>.05&&this.forwardBufferLength>1){let e=Math.min(Math.min(2,Math.max(1,r)),Math.max(1,Math.round(2/(1+Math.exp(-.75*n-this.edgeStalled))*20)/20));this.changeMediaPlaybackRate(t,e)}else 1!==t.playbackRate&&0!==t.playbackRate&&this.changeMediaPlaybackRate(t,1)},this.hls=t,this.config=t.config,this.registerListeners()}get levelDetails(){var t;return(null==(t=this.hls)?void 0:t.latestLevelDetails)||null}get latency(){return this._latency||0}get maxLatency(){let{config:t}=this;if(void 0!==t.liveMaxLatencyDuration)return t.liveMaxLatencyDuration;let e=this.levelDetails;return e?t.liveMaxLatencyDurationCount*e.targetduration:0}get targetLatency(){let t=this.levelDetails;if(null===t||null===this.hls)return null;let{holdBack:e,partHoldBack:i,targetduration:s}=t,{liveSyncDuration:r,liveSyncDurationCount:a,lowLatencyMode:n}=this.config,l=this.hls.userConfig,o=n&&i||e;return(this._targetLatencyUpdated||l.liveSyncDuration||l.liveSyncDurationCount||0===o)&&(o=void 0!==r?r:a*s),o+Math.min(this.stallCount*this.config.liveSyncOnStallIncrease,s)}set targetLatency(t){this.stallCount=0,this.config.liveSyncDuration=t,this._targetLatencyUpdated=!0}get liveSyncPosition(){let t=this.estimateLiveEdge(),e=this.targetLatency;if(null===t||null===e)return null;let i=this.levelDetails;if(null===i)return null;let s=i.edge,r=t-e-this.edgeStalled;return Math.min(Math.max(s-i.totalduration,r),s-(this.config.lowLatencyMode&&i.partTarget||i.targetduration))}get drift(){let t=this.levelDetails;return null===t?1:t.drift}get edgeStalled(){let t=this.levelDetails;if(null===t)return 0;let e=3*(this.config.lowLatencyMode&&t.partTarget||t.targetduration);return Math.max(t.age-e,0)}get forwardBufferLength(){let{media:t}=this,e=this.levelDetails;if(!t||!e)return 0;let i=t.buffered.length;return(i?t.buffered.end(i-1):e.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.hls=null}registerListeners(){let{hls:t}=this;t&&(t.on(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.LEVEL_UPDATED,this.onLevelUpdated,this),t.on(h.ERROR,this.onError,this))}unregisterListeners(){let{hls:t}=this;t&&(t.off(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.LEVEL_UPDATED,this.onLevelUpdated,this),t.off(h.ERROR,this.onError,this))}onMediaAttached(t,e){this.media=e.media,this.media.addEventListener("timeupdate",this.onTimeupdate)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.onTimeupdate),this.media=null)}onManifestLoading(){this._latency=null,this.stallCount=0}onLevelUpdated(t,{details:e}){e.advanced&&this.onTimeupdate(),!e.live&&this.media&&this.media.removeEventListener("timeupdate",this.onTimeupdate)}onError(t,e){var i;e.details===o.BUFFER_STALLED_ERROR&&(this.stallCount++,this.hls&&null!=(i=this.levelDetails)&&i.live&&this.hls.logger.warn("[latency-controller]: Stall detected, adjusting target latency"))}changeMediaPlaybackRate(t,e){var i,s;t.playbackRate!==e&&(null==(i=this.hls)||i.logger.debug(`[latency-controller]: latency=${this.latency.toFixed(3)}, targetLatency=${null==(s=this.targetLatency)?void 0:s.toFixed(3)}, forwardBufferLength=${this.forwardBufferLength.toFixed(3)}: adjusting playback rate from ${t.playbackRate} to ${e}`),t.playbackRate=e)}estimateLiveEdge(){let t=this.levelDetails;return null===t?null:t.edge+t.age}computeLatency(){let t=this.estimateLiveEdge();return null===t?null:t-this.currentTime}}class ar extends sv{constructor(t,e){super(t,"level-controller"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=e,this._registerListeners()}_registerListeners(){let{hls:t}=this;t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(h.LEVEL_LOADED,this.onLevelLoaded,this),t.on(h.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(h.FRAG_BUFFERED,this.onFragBuffered,this),t.on(h.ERROR,this.onError,this)}_unregisterListeners(){let{hls:t}=this;t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(h.LEVEL_LOADED,this.onLevelLoaded,this),t.off(h.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(h.FRAG_BUFFERED,this.onFragBuffered,this),t.off(h.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(t=>{t.loadError=0,t.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(t,e){this.resetLevels()}onManifestLoaded(t,e){let i=this.hls.config.preferManagedMediaSource,s=[],r={},a={},n=!1,l=!1,o=!1;e.levels.forEach(t=>{let e=t.attrs,{audioCodec:h,videoCodec:d}=t;h&&(t.audioCodec=h=tx(h,i)||void 0),d&&(d=t.videoCodec=function(t){let e=t.split(",");for(let t=0;t<e.length;t++){let i=e[t].split(".");i.length>2&&"avc1"===i[0]&&(e[t]=`avc1.${parseInt(i[1]).toString(16)}${("000"+parseInt(i[2]).toString(16)).slice(-4)}`)}return e.join(",")}(d));let{width:u,height:c,unknownCodecs:f}=t,g=f?f.length:0;if(f)for(let e=g;e--;){let i=f[e];this.isAudioSupported(i)?(t.audioCodec=h=h?`${h},${i}`:i,g--,tm.audio[h.substring(0,4)]=2):this.isVideoSupported(i)&&(t.videoCodec=d=d?`${d},${i}`:i,g--,tm.video[d.substring(0,4)]=2)}if(n||(n=!!(u&&c)),l||(l=!!d),o||(o=!!h),g||h&&!this.isAudioSupported(h)||d&&!this.isVideoSupported(d))return void this.log(`Some or all CODECS not supported "${e.CODECS}"`);let{CODECS:p,"FRAME-RATE":m,"HDCP-LEVEL":y,"PATHWAY-ID":v,RESOLUTION:E,"VIDEO-RANGE":T}=e,b=`${v||"."}-`,S=`${b}${t.bitrate}-${E}-${m}-${p}-${T}-${y}`;if(r[S])if(r[S].uri===t.url||t.attrs["PATHWAY-ID"])r[S].addGroupId("audio",e.AUDIO),r[S].addGroupId("text",e.SUBTITLES);else{let e=a[S]+=1;t.attrs["PATHWAY-ID"]=Array(e+1).join(".");let i=this.createLevel(t);r[S]=i,s.push(i)}else{let e=this.createLevel(t);r[S]=e,a[S]=1,s.push(e)}}),this.filterAndSortMediaOptions(s,e,n,l,o)}createLevel(t){let e=new tB(t),i=t.supplemental;if(null!=i&&i.videoCodec&&!this.isVideoSupported(i.videoCodec)){let t=Error(`SUPPLEMENTAL-CODECS not supported "${i.videoCodec}"`);this.log(t.message),e.supportedResult=tk(t,[])}return e}isAudioSupported(t){return tv(t,"audio",this.hls.config.preferManagedMediaSource)}isVideoSupported(t){return tv(t,"video",this.hls.config.preferManagedMediaSource)}filterAndSortMediaOptions(t,e,i,s,r){let a=[],n=[],d=t;if((i||s)&&r&&(d=d.filter(({videoCodec:t,videoRange:e,width:i,height:s})=>{var r;return(!!t||!!(i&&s))&&!!(r=e)&&tw.indexOf(r)>-1})),0===d.length)return void Promise.resolve().then(()=>{if(this.hls){let t="no level with compatible codecs found in manifest",i=t;e.levels.length&&(i=`one or more CODECS in variant not supported: ${tG(e.levels.map(t=>t.attrs.CODECS).filter((t,e,i)=>i.indexOf(t)===e))}`,this.warn(i),t+=` (${i})`);let s=Error(t);this.hls.trigger(h.ERROR,{type:l.MEDIA_ERROR,details:o.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:e.url,error:s,reason:i})}});e.audioTracks&&aa(a=e.audioTracks.filter(t=>!t.audioCodec||this.isAudioSupported(t.audioCodec))),e.subtitles&&aa(n=e.subtitles);let u=d.slice(0);d.sort((t,e)=>{if(t.attrs["HDCP-LEVEL"]!==e.attrs["HDCP-LEVEL"])return(t.attrs["HDCP-LEVEL"]||"")>(e.attrs["HDCP-LEVEL"]||"")?1:-1;if(i&&t.height!==e.height)return t.height-e.height;if(t.frameRate!==e.frameRate)return t.frameRate-e.frameRate;if(t.videoRange!==e.videoRange)return tw.indexOf(t.videoRange)-tw.indexOf(e.videoRange);if(t.videoCodec!==e.videoCodec){let i=tb(t.videoCodec),s=tb(e.videoCodec);if(i!==s)return s-i}if(t.uri===e.uri&&t.codecSet!==e.codecSet){let i=tS(t.codecSet),s=tS(e.codecSet);if(i!==s)return s-i}return t.averageBitrate!==e.averageBitrate?t.averageBitrate-e.averageBitrate:0});let c=u[0];if(this.steering&&(d=this.steering.filterParsedLevels(d)).length!==u.length){for(let t=0;t<u.length;t++)if(u[t].pathwayId===d[0].pathwayId){c=u[t];break}}this._levels=d;for(let t=0;t<d.length;t++)if(d[t]===c){var f;this._firstLevel=t;let e=c.bitrate,i=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${d.length} level(s) found, first bitrate: ${e}`),(null==(f=this.hls.userConfig)?void 0:f.abrEwmaDefaultEstimate)===void 0){let t=Math.min(e,this.hls.config.abrEwmaDefaultEstimateMax);t>i&&i===this.hls.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=t)}break}let g=r&&!s,p=this.hls.config,m=!!(p.audioStreamController&&p.audioTrackController),y={levels:d,audioTracks:a,subtitleTracks:n,sessionData:e.sessionData,sessionKeys:e.sessionKeys,firstLevel:this._firstLevel,stats:e.stats,audio:r,video:s,altAudio:m&&!g&&a.some(t=>!!t.url)};this.hls.trigger(h.MANIFEST_PARSED,y)}get levels(){return 0===this._levels.length?null:this._levels}get loadLevelObj(){return this.currentLevel}get level(){return this.currentLevelIndex}set level(t){let e=this._levels;if(0===e.length)return;if(t<0||t>=e.length){let i=Error("invalid level idx"),s=t<0;if(this.hls.trigger(h.ERROR,{type:l.OTHER_ERROR,details:o.LEVEL_SWITCH_ERROR,level:t,fatal:s,error:i,reason:i.message}),s)return;t=Math.min(t,e.length-1)}let i=this.currentLevelIndex,s=this.currentLevel,r=s?s.attrs["PATHWAY-ID"]:void 0,a=e[t],n=a.attrs["PATHWAY-ID"];if(this.currentLevelIndex=t,this.currentLevel=a,i===t&&s&&r===n)return;this.log(`Switching to level ${t} (${a.height?a.height+"p ":""}${a.videoRange?a.videoRange+" ":""}${a.codecSet?a.codecSet+" ":""}@${a.bitrate})${n?" with Pathway "+n:""} from level ${i}${r?" with Pathway "+r:""}`);let d={level:t,attrs:a.attrs,details:a.details,bitrate:a.bitrate,averageBitrate:a.averageBitrate,maxBitrate:a.maxBitrate,realBitrate:a.realBitrate,width:a.width,height:a.height,codecSet:a.codecSet,audioCodec:a.audioCodec,videoCodec:a.videoCodec,audioGroups:a.audioGroups,subtitleGroups:a.subtitleGroups,loaded:a.loaded,loadError:a.loadError,fragmentError:a.fragmentError,name:a.name,id:a.id,uri:a.uri,url:a.url,urlId:0,audioGroupIds:a.audioGroupIds,textGroupIds:a.textGroupIds};this.hls.trigger(h.LEVEL_SWITCHING,d);let u=a.details;if(!u||u.live){let t=this.switchParams(a.uri,null==s?void 0:s.details,u);this.loadPlaylist(t)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(t){this.manualLevelIndex=t,void 0===this._startLevel&&(this._startLevel=t),-1!==t&&(this.level=t)}get firstLevel(){return this._firstLevel}set firstLevel(t){this._firstLevel=t}get startLevel(){if(void 0===this._startLevel){let t=this.hls.config.startLevel;return void 0!==t?t:this.hls.firstAutoLevel}return this._startLevel}set startLevel(t){this._startLevel=t}get pathways(){return this.steering?this.steering.pathways():[]}get pathwayPriority(){return this.steering?this.steering.pathwayPriority:null}set pathwayPriority(t){if(this.steering){let e=this.steering.pathways(),i=t.filter(t=>-1!==e.indexOf(t));if(t.length<1)return void this.warn(`pathwayPriority ${t} should contain at least one pathway from list: ${e}`);this.steering.pathwayPriority=i}}onError(t,e){!e.fatal&&e.context&&e.context.type===_.LEVEL&&e.context.level===this.level&&this.checkRetry(e)}onFragBuffered(t,{frag:e}){if(void 0!==e&&e.type===x.MAIN){let t=e.elementaryStreams;if(!Object.keys(t).some(e=>!!t[e]))return;let i=this._levels[e.level];null!=i&&i.loadError&&(this.log(`Resetting level error count of ${i.loadError} on frag buffered`),i.loadError=0)}}onLevelLoaded(t,e){var i,s;let{level:r,details:a}=e,n=e.levelInfo;if(!n){this.warn(`Invalid level index ${r}`),null!=(s=e.deliveryDirectives)&&s.skip&&(a.deltaUpdateFailed=!0);return}if(n===this.currentLevel||e.withoutMultiVariant){0===n.fragmentError&&(n.loadError=0);let t=n.details;t===e.details&&t.advanced&&(t=void 0),this.playlistLoaded(r,e,t)}else null!=(i=e.deliveryDirectives)&&i.skip&&(a.deltaUpdateFailed=!0)}loadPlaylist(t){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentLevel)&&this.scheduleLoading(this.currentLevel,t)}loadingPlaylist(t,e){super.loadingPlaylist(t,e);let i=this.getUrlWithDirectives(t.uri,e),s=this.currentLevelIndex,r=t.attrs["PATHWAY-ID"],a=t.details,n=null==a?void 0:a.age;this.log(`Loading level index ${s}${(null==e?void 0:e.msn)!==void 0?" at sn "+e.msn+" part "+e.part:""}${r?" Pathway "+r:""}${n&&a.live?" age "+n.toFixed(1)+(a.type?" "+a.type:""):""} ${i}`),this.hls.trigger(h.LEVEL_LOADING,{url:i,level:s,levelInfo:t,pathwayId:t.attrs["PATHWAY-ID"],id:0,deliveryDirectives:e||null})}get nextLoadLevel(){return -1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(t){this.level=t,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=t)}removeLevel(t){var e;if(1===this._levels.length)return;let i=this._levels.filter((e,i)=>i!==t||(this.steering&&this.steering.removeLevel(e),e===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,e.details&&e.details.fragments.forEach(t=>t.level=-1)),!1));ii(i),this._levels=i,this.currentLevelIndex>-1&&null!=(e=this.currentLevel)&&e.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.manualLevelIndex>-1&&(this.manualLevelIndex=this.currentLevelIndex);let s=i.length-1;this._firstLevel=Math.min(this._firstLevel,s),this._startLevel&&(this._startLevel=Math.min(this._startLevel,s)),this.hls.trigger(h.LEVELS_UPDATED,{levels:i})}onLevelsUpdated(t,{levels:e}){this._levels=e}checkMaxAutoUpdated(){let{autoLevelCapping:t,maxAutoLevel:e,maxHdcpLevel:i}=this.hls;this._maxAutoLevel!==e&&(this._maxAutoLevel=e,this.hls.trigger(h.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:t,levels:this.levels,maxAutoLevel:e,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:i}))}}function aa(t){let e={};t.forEach(t=>{let i=t.groupId||"";t.id=e[i]=e[i]||0,e[i]++})}function an(){return self.SourceBuffer||self.WebKitSourceBuffer}function al(){if(!N())return!1;let t=an();return!t||t.prototype&&"function"==typeof t.prototype.appendBuffer&&"function"==typeof t.prototype.remove}class ao extends iu{constructor(t,e,i){super(t,e,i,"stream-controller",x.MAIN),this.audioCodecSwap=!1,this.level=-1,this._forceStartLoad=!1,this._hasEnoughToStart=!1,this.altAudio=0,this.audioOnly=!1,this.fragPlaying=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this.onMediaPlaying=()=>{this.tick()},this.onMediaSeeked=()=>{let t=this.media,e=t?t.currentTime:null;if(null===e||!r(e)||(this.log(`Media seeked to ${e.toFixed(3)}`),!this.getBufferedFrag(e)))return;let i=this.getFwdBufferInfoAtPos(t,e,x.MAIN,0);if(null===i||0===i.len)return void this.warn(`Main forward buffer length at ${e} on "seeked" event ${i?i.len:"empty"})`);this.tick()},this.registerListeners()}registerListeners(){super.registerListeners();let{hls:t}=this;t.on(h.MANIFEST_PARSED,this.onManifestParsed,this),t.on(h.LEVEL_LOADING,this.onLevelLoading,this),t.on(h.LEVEL_LOADED,this.onLevelLoaded,this),t.on(h.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.on(h.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(h.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.on(h.BUFFER_CREATED,this.onBufferCreated,this),t.on(h.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(h.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(h.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){super.unregisterListeners();let{hls:t}=this;t.off(h.MANIFEST_PARSED,this.onManifestParsed,this),t.off(h.LEVEL_LOADED,this.onLevelLoaded,this),t.off(h.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.off(h.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(h.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.off(h.BUFFER_CREATED,this.onBufferCreated,this),t.off(h.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(h.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(h.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this.onMediaPlaying=this.onMediaSeeked=null,this.unregisterListeners(),super.onHandlerDestroying()}startLoad(t,e){if(this.levels){let{lastCurrentTime:i,hls:s}=this;if(this.stopLoad(),this.setInterval(100),this.level=-1,!this.startFragRequested){let t=s.startLevel;-1===t&&(s.config.testBandwidth&&this.levels.length>1?(t=0,this.bitrateTest=!0):t=s.firstAutoLevel),s.nextLoadLevel=t,this.level=s.loadLevel,this._hasEnoughToStart=!!e}i>0&&-1===t&&!e&&(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),t=i),this.state=id.IDLE,this.nextLoadPosition=this.lastCurrentTime=t+this.timelineOffset,this.startPosition=e?-1:t,this.tick()}else this._forceStartLoad=!0,this.state=id.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case id.WAITING_LEVEL:{let{levels:t,level:e}=this,i=null==t?void 0:t[e],s=null==i?void 0:i.details;if(!s||s.live&&(this.levelLastLoaded!==i||this.waitForLive(i)))this.hls.nextLoadLevel!==this.level&&(this.state=id.IDLE);else{if(this.waitForCdnTuneIn(s))break;this.state=id.IDLE}break}case id.FRAG_LOADING_WAITING_RETRY:{var t;let e=self.performance.now(),i=this.retryDate;if(!i||e>=i||null!=(t=this.media)&&t.seeking){let{levels:t,level:e}=this,i=null==t?void 0:t[e];this.resetStartWhenNotLoaded(i||null),this.state=id.IDLE}}}this.state===id.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){var t;super.onTickEnd(),null!=(t=this.media)&&t.readyState&&!1===this.media.seeking&&(this.lastCurrentTime=this.media.currentTime),this.checkFragmentChanged()}doTickIdle(){let{hls:t,levelLastLoaded:e,levels:i,media:s}=this;if(null===e||!s&&!this.primaryPrefetch&&(this.startFragRequested||!t.config.startFragPrefetch)||this.altAudio&&this.audioOnly)return;let r=this.buffering?t.nextLoadLevel:t.loadLevel;if(!(null!=i&&i[r]))return;let a=i[r],n=this.getMainFwdBufferInfo();if(null===n)return;let l=this.getLevelDetails();if(l&&this._streamEnded(n,l)){let t={};2===this.altAudio&&(t.type="video"),this.hls.trigger(h.BUFFER_EOS,t),this.state=id.ENDED;return}if(!this.buffering)return;t.loadLevel!==r&&-1===t.manualLevel&&this.log(`Adapting to level ${r} from level ${this.level}`),this.level=t.nextLoadLevel=r;let o=a.details;if(!o||this.state===id.WAITING_LEVEL||this.waitForLive(a)){this.level=r,this.state=id.WAITING_LEVEL,this.startFragRequested=!1;return}let d=n.len,u=this.getMaxBufferLength(a.maxBitrate);if(d>=u)return;this.backtrackFragment&&this.backtrackFragment.start>n.end&&(this.backtrackFragment=null);let c=this.backtrackFragment?this.backtrackFragment.start:n.end,f=this.getNextFragment(c,o);if(this.couldBacktrack&&!this.fragPrevious&&f&&Y(f)&&this.fragmentTracker.getState(f)!==t9.OK){var g;let t=(null!=(g=this.backtrackFragment)?g:f).sn-o.startSN,e=o.fragments[t-1];e&&f.cc===e.cc&&(f=e,this.fragmentTracker.removeFragment(e))}else this.backtrackFragment&&n.len&&(this.backtrackFragment=null);if(f&&this.isLoopLoading(f,c)){if(!f.gap){let t=this.audioOnly&&!this.altAudio?K.AUDIO:K.VIDEO,e=(t===K.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;e&&this.afterBufferFlushed(e,t,x.MAIN)}f=this.getNextFragmentLoopLoading(f,o,n,x.MAIN,u)}f&&(!f.initSegment||f.initSegment.data||this.bitrateTest||(f=f.initSegment),this.loadFragment(f,a,c))}loadFragment(t,e,i){let s=this.fragmentTracker.getState(t);s===t9.NOT_LOADED||s===t9.PARTIAL?Y(t)?this.bitrateTest?(this.log(`Fragment ${t.sn} of level ${t.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(t,e)):super.loadFragment(t,e,i):this._loadInitSegment(t,e):this.clearTrackerIfNeeded(t)}getBufferedFrag(t){return this.fragmentTracker.getBufferedFrag(t,x.MAIN)}followingBufferedFrag(t){return t?this.getBufferedFrag(t.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){let{levels:t,media:e}=this;if(null!=e&&e.readyState){let i,s=this.getAppendedFrag(e.currentTime);s&&s.start>1&&this.flushMainBuffer(0,s.start-1);let r=this.getLevelDetails();if(null!=r&&r.live){let t=this.getMainFwdBufferInfo();if(!t||t.len<2*r.targetduration)return}if(!e.paused&&t){let e=t[this.hls.nextLoadLevel],s=this.fragLastKbps;i=s&&this.fragCurrent?this.fragCurrent.duration*e.maxBitrate/(1e3*s)+1:0}else i=0;let a=this.getBufferedFrag(e.currentTime+i);if(a){let t=this.followingBufferedFrag(a);if(t){this.abortCurrentFrag();let e=t.maxStartPTS?t.maxStartPTS:t.start,i=t.duration,s=Math.max(a.end,e+Math.min(Math.max(i-this.config.maxFragLookUpTolerance,i*(this.couldBacktrack?.5:.125)),i*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(s,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){let t=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,t&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.state){case id.KEY_LOADING:case id.FRAG_LOADING:case id.FRAG_LOADING_WAITING_RETRY:case id.PARSING:case id.PARSED:this.state=id.IDLE}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(t,e){super.flushMainBuffer(t,e,2===this.altAudio?"video":null)}onMediaAttached(t,e){super.onMediaAttached(t,e);let i=e.media;sX(i,"playing",this.onMediaPlaying),sX(i,"seeked",this.onMediaSeeked)}onMediaDetaching(t,e){let{media:i}=this;i&&(sQ(i,"playing",this.onMediaPlaying),sQ(i,"seeked",this.onMediaSeeked)),this.videoBuffer=null,this.fragPlaying=null,super.onMediaDetaching(t,e),e.transferMedia||(this._hasEnoughToStart=!1)}onManifestLoading(){super.onManifestLoading(),this.log("Trigger BUFFER_RESET"),this.hls.trigger(h.BUFFER_RESET,void 0),this.couldBacktrack=!1,this.fragLastKbps=0,this.fragPlaying=this.backtrackFragment=null,this.altAudio=0,this.audioOnly=!1}onManifestParsed(t,e){let i=!1,s=!1;e.levels.forEach(t=>{let e=t.audioCodec;e&&(i=i||-1!==e.indexOf("mp4a.40.2"),s=s||-1!==e.indexOf("mp4a.40.5"))}),this.audioCodecSwitch=i&&s&&!function(){var t;let e=an();return"function"==typeof(null==e||null==(t=e.prototype)?void 0:t.changeType)}(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=e.levels,this.startFragRequested=!1}onLevelLoading(t,e){let{levels:i}=this;if(!i||this.state!==id.IDLE)return;let s=e.levelInfo;(!s.details||s.details.live&&(this.levelLastLoaded!==s||s.details.expired)||this.waitForCdnTuneIn(s.details))&&(this.state=id.WAITING_LEVEL)}onLevelLoaded(t,e){var i,s;let{levels:r,startFragRequested:a}=this,n=e.level,l=e.details,o=l.totalduration;if(!r)return void this.warn(`Levels were reset while loading level ${n}`);this.log(`Level ${n} loaded [${l.startSN},${l.endSN}]${l.lastPartSn?`[part-${l.lastPartSn}-${l.lastPartIndex}]`:""}, cc [${l.startCC}, ${l.endCC}] duration:${o}`);let d=e.levelInfo,u=this.fragCurrent;u&&(this.state===id.FRAG_LOADING||this.state===id.FRAG_LOADING_WAITING_RETRY)&&u.level!==e.level&&u.loader&&this.abortCurrentFrag();let c=0;if(l.live||null!=(i=d.details)&&i.live){if(this.checkLiveUpdate(l),l.deltaUpdateFailed)return;c=this.alignPlaylists(l,d.details,null==(s=this.levelLastLoaded)?void 0:s.details)}if(d.details=l,this.levelLastLoaded=d,a||this.setStartPosition(l,c),this.hls.trigger(h.LEVEL_UPDATED,{details:l,level:n}),this.state===id.WAITING_LEVEL){if(this.waitForCdnTuneIn(l))return;this.state=id.IDLE}a&&l.live&&this.synchronizeToLiveEdge(l),this.tick()}synchronizeToLiveEdge(t){let{config:e,media:i}=this;if(!i)return;let s=this.hls.liveSyncPosition,r=this.getLoadPosition(),a=t.fragmentStart,n=t.edge,l=r>=a-e.maxFragLookUpTolerance&&r<=n;if(null!==s&&i.duration>s&&(r<s||!l)){let a=void 0!==e.liveMaxLatencyDuration?e.liveMaxLatencyDuration:e.liveMaxLatencyDurationCount*t.targetduration;if((!l&&i.readyState<4||r<n-a)&&(this._hasEnoughToStart||(this.nextLoadPosition=s),i.readyState))if(this.warn(`Playback: ${r.toFixed(3)} is located too far from the end of live sliding playlist: ${n}, reset currentTime to : ${s.toFixed(3)}`),"buffered"===this.config.liveSyncMode){var o;let t=em.bufferInfo(i,s,0);if(!(null!=t&&null!=(o=t.buffered)&&o.length)||t.start<=r){i.currentTime=s;return}let{nextStart:e}=em.bufferedInfo(t.buffered,r,0);e&&(i.currentTime=e)}else i.currentTime=s}}_handleFragmentLoadProgress(t){var e;let i=t.frag,{part:s,payload:r}=t,{levels:a}=this;if(!a)return void this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);let n=a[i.level];if(!n)return void this.warn(`Level ${i.level} not found on progress`);let l=n.details;if(!l){this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`),this.fragmentTracker.removeFragment(i);return}let o=n.videoCodec,h=l.PTSKnown||!l.live,d=null==(e=i.initSegment)?void 0:e.data,u=this._getAudioCodec(n),c=this.transmuxer=this.transmuxer||new sy(this.hls,x.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),f=s?s.index:-1,g=new ef(i.level,i.sn,i.stats.chunkCount,r.byteLength,f,-1!==f),p=this.initPTS[i.cc];c.push(r,d,u,o,i,s,l.totalduration,h,g,p)}onAudioTrackSwitching(t,e){let i=this.hls,s=2===this.altAudio;if(tq(e.url,i))this.altAudio=1;else{if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;let t=this.fragCurrent;t&&(this.log("Switching to main audio track, cancel main fragment load"),t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();if(s){this.fragmentTracker.removeAllFragments(),i.once(h.BUFFER_FLUSHED,()=>{var t;null==(t=this.hls)||t.trigger(h.AUDIO_TRACK_SWITCHED,e)}),i.trigger(h.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null});return}i.trigger(h.AUDIO_TRACK_SWITCHED,e)}}onAudioTrackSwitched(t,e){let i=tq(e.url,this.hls);if(i){let t=this.videoBuffer;t&&this.mediaBuffer!==t&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=t)}this.altAudio=2*!!i,this.tick()}onBufferCreated(t,e){let i,s,r=e.tracks,a=!1;for(let t in r){let e=r[t];if("main"===e.id){if(s=t,i=e,"video"===t){let e=r[t];e&&(this.videoBuffer=e.buffer)}}else a=!0}a&&i?(this.log(`Alternate track found, use ${s}.buffered to schedule main fragment loading`),this.mediaBuffer=i.buffer):this.mediaBuffer=this.media}onFragBuffered(t,e){let{frag:i,part:s}=e,r=i.type===x.MAIN;if(r){if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${s?" p: "+s.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),this.state===id.PARSED&&(this.state=id.IDLE);return}let t=s?s.stats:i.stats;this.fragLastKbps=Math.round(8*t.total/(t.buffering.end-t.loading.first)),Y(i)&&(this.fragPrevious=i),this.fragBufferedComplete(i,s)}let a=this.media;a&&(!this._hasEnoughToStart&&em.getBuffered(a).length&&(this._hasEnoughToStart=!0,this.seekToStartPos()),r&&this.tick())}get hasEnoughToStart(){return this._hasEnoughToStart}onError(t,e){var i;if(e.fatal){this.state=id.ERROR;return}switch(e.details){case o.FRAG_GAP:case o.FRAG_PARSING_ERROR:case o.FRAG_DECRYPT_ERROR:case o.FRAG_LOAD_ERROR:case o.FRAG_LOAD_TIMEOUT:case o.KEY_LOAD_ERROR:case o.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(x.MAIN,e);break;case o.LEVEL_LOAD_ERROR:case o.LEVEL_LOAD_TIMEOUT:case o.LEVEL_PARSING_ERROR:e.levelRetry||this.state!==id.WAITING_LEVEL||(null==(i=e.context)?void 0:i.type)!==_.LEVEL||(this.state=id.IDLE);break;case o.BUFFER_ADD_CODEC_ERROR:case o.BUFFER_APPEND_ERROR:if("main"!==e.parent)return;this.resetLoadingState();break;case o.BUFFER_FULL_ERROR:if("main"!==e.parent)return;this.reduceLengthAndFlushBuffer(e)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case o.INTERNAL_EXCEPTION:this.recoverWorkerError(e)}}onFragLoadEmergencyAborted(){this.state=id.IDLE,this._hasEnoughToStart||(this.startFragRequested=!1,this.nextLoadPosition=this.lastCurrentTime),this.tickImmediate()}onBufferFlushed(t,{type:e}){if(e!==K.AUDIO||!this.altAudio){let t=(e===K.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;t&&(this.afterBufferFlushed(t,e,x.MAIN),this.tick())}}onLevelsUpdated(t,e){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level,-1===this.level&&this.resetWhenMissingContext(this.fragCurrent)),this.levels=e.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){let{media:t}=this;if(!t)return;let e=t.currentTime,i=this.startPosition;if(i>=0&&e<i){if(t.seeking)return void this.log(`could not seek to ${i}, already seeking at ${e}`);let s=this.timelineOffset;s&&i&&(i+=s);let r=this.getLevelDetails(),a=em.getBuffered(t),n=a.length?a.start(0):0,l=n-i,o=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);(this.config.startOnSegmentBoundary||l>0&&(l<o||this.loadingParts&&l<2*((null==r?void 0:r.partTarget)||0)))&&(this.log(`adjusting start position by ${l} to match buffer start`),i+=l,this.startPosition=i),e<i&&(this.log(`seek to target start position ${i} from current time ${e} buffer start ${n}`),t.currentTime=i)}}_getAudioCodec(t){let e=this.config.defaultAudioCodec||t.audioCodec;return this.audioCodecSwap&&e&&(this.log("Swapping audio codec"),e=-1!==e.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),e}_loadBitrateTestFrag(t,e){t.bitrateTest=!0,this._doFragLoad(t,e).then(t=>{let{hls:i}=this,s=null==t?void 0:t.frag;if(!s||this.fragContextChanged(s))return;e.fragmentError=0,this.state=id.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;let r=s.stats;r.parsing.start=r.parsing.end=r.buffering.start=r.buffering.end=self.performance.now(),i.trigger(h.FRAG_LOADED,t),s.bitrateTest=!1})}_handleTransmuxComplete(t){var e;let i=this.playlistType,{hls:s}=this,{remuxResult:a,chunkMeta:n}=t,l=this.getCurrentContext(n);if(!l)return void this.resetWhenMissingContext(n);let{frag:o,part:d,level:u}=l,{video:c,text:f,id3:g,initSegment:p}=a,{details:m}=u,y=this.altAudio?void 0:a.audio;if(this.fragContextChanged(o))return void this.fragmentTracker.removeFragment(o);if(this.state=id.PARSING,p){if(null!=p&&p.tracks){let t=o.initSegment||o;this._bufferInitSegment(u,p.tracks,t,n),s.trigger(h.FRAG_PARSING_INIT_SEGMENT,{frag:t,id:i,tracks:p.tracks})}let t=p.initPTS,e=p.timescale;r(t)&&(this.initPTS[o.cc]={baseTime:t,timescale:e},s.trigger(h.INIT_PTS_FOUND,{frag:o,id:i,initPTS:t,timescale:e}))}if(c&&m){y&&"audiovideo"===c.type&&this.logMuxedErr(o);let t=m.fragments[o.sn-1-m.startSN],e=o.sn===m.startSN,i=!t||o.cc>t.cc;if(!1!==a.independent){let{startPTS:t,endPTS:s,startDTS:r,endDTS:a}=c;if(d)d.elementaryStreams[c.type]={startPTS:t,endPTS:s,startDTS:r,endDTS:a};else if(c.firstKeyFrame&&c.independent&&1===n.id&&!i&&(this.couldBacktrack=!0),c.dropped&&c.independent){let r=this.getMainFwdBufferInfo(),n=(r?r.end:this.getLoadPosition())+this.config.maxBufferHole,l=c.firstKeyFramePTS?c.firstKeyFramePTS:t;if(!e&&n<l-this.config.maxBufferHole&&!i)return void this.backtrack(o);i&&(o.gap=!0),o.setElementaryStreamInfo(c.type,o.start,s,o.start,a,!0)}else e&&t-(m.appliedTimelineOffset||0)>2&&(o.gap=!0);o.setElementaryStreamInfo(c.type,t,s,r,a),this.backtrackFragment&&(this.backtrackFragment=o),this.bufferFragmentData(c,o,d,n,e||i)}else{if(!e&&!i)return void this.backtrack(o);o.gap=!0}}if(y){let{startPTS:t,endPTS:e,startDTS:i,endDTS:s}=y;d&&(d.elementaryStreams[K.AUDIO]={startPTS:t,endPTS:e,startDTS:i,endDTS:s}),o.setElementaryStreamInfo(K.AUDIO,t,e,i,s),this.bufferFragmentData(y,o,d,n)}if(m&&null!=g&&null!=(e=g.samples)&&e.length){let t={id:i,frag:o,details:m,samples:g.samples};s.trigger(h.FRAG_PARSING_METADATA,t)}if(m&&f){let t={id:i,frag:o,details:m,samples:f.samples};s.trigger(h.FRAG_PARSING_USERDATA,t)}}logMuxedErr(t){this.warn(`${Y(t)?"Media":"Init"} segment with muxed audiovideo where only video expected: ${t.url}`)}_bufferInitSegment(t,e,i,s){if(this.state!==id.PARSING)return;this.audioOnly=!!e.audio&&!e.video,this.altAudio&&!this.audioOnly&&(delete e.audio,e.audiovideo&&this.logMuxedErr(i));let{audio:r,video:a,audiovideo:n}=e;if(r){let i=tL(r.codec,t.audioCodec);"mp4a"===i&&(i="mp4a.40.5");let s=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){i&&(i=-1!==i.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5");let t=r.metadata;t&&"channelCount"in t&&1!==(t.channelCount||1)&&-1===s.indexOf("firefox")&&(i="mp4a.40.5")}i&&-1!==i.indexOf("mp4a.40.5")&&-1!==s.indexOf("android")&&"audio/mpeg"!==r.container&&(i="mp4a.40.2",this.log(`Android: force audio codec to ${i}`)),t.audioCodec&&t.audioCodec!==i&&this.log(`Swapping manifest audio codec "${t.audioCodec}" for "${i}"`),r.levelCodec=i,r.id=x.MAIN,this.log(`Init audio buffer, container:${r.container}, codecs[selected/level/parsed]=[${i||""}/${t.audioCodec||""}/${r.codec}]`),delete e.audiovideo}if(a){a.levelCodec=t.videoCodec,a.id=x.MAIN;let i=a.codec;if((null==i?void 0:i.length)===4)switch(i){case"hvc1":case"hev1":a.codec="hvc1.1.6.L120.90";break;case"av01":a.codec="av01.0.04M.08";break;case"avc1":a.codec="avc1.42e01e"}this.log(`Init video buffer, container:${a.container}, codecs[level/parsed]=[${t.videoCodec||""}/${i}]${a.codec!==i?" parsed-corrected="+a.codec:""}${a.supplemental?" supplemental="+a.supplemental:""}`),delete e.audiovideo}n&&(this.log(`Init audiovideo buffer, container:${n.container}, codecs[level/parsed]=[${t.codecs}/${n.codec}]`),delete e.video,delete e.audio);let l=Object.keys(e);if(l.length){if(this.hls.trigger(h.BUFFER_CODECS,e),!this.hls)return;l.forEach(t=>{let r=e[t].initSegment;null!=r&&r.byteLength&&this.hls.trigger(h.BUFFER_APPENDING,{type:t,data:r,frag:i,part:null,chunkMeta:s,parent:i.type})})}this.tickImmediate()}getMainFwdBufferInfo(){let t=this.mediaBuffer&&2===this.altAudio?this.mediaBuffer:this.media;return this.getFwdBufferInfo(t,x.MAIN)}get maxBufferLength(){let{levels:t,level:e}=this,i=null==t?void 0:t[e];return i?this.getMaxBufferLength(i.maxBitrate):this.config.maxBufferLength}backtrack(t){this.couldBacktrack=!0,this.backtrackFragment=t,this.resetTransmuxer(),this.flushBufferGap(t),this.fragmentTracker.removeFragment(t),this.fragPrevious=null,this.nextLoadPosition=t.start,this.state=id.IDLE}checkFragmentChanged(){let t=this.media,e=null;if(t&&t.readyState>1&&!1===t.seeking){let i=t.currentTime;if(em.isBuffered(t,i)?e=this.getAppendedFrag(i):em.isBuffered(t,i+.1)&&(e=this.getAppendedFrag(i+.1)),e){this.backtrackFragment=null;let t=this.fragPlaying,i=e.level;(!t||e.sn!==t.sn||t.level!==i)&&(this.fragPlaying=e,this.hls.trigger(h.FRAG_CHANGED,{frag:e}),t&&t.level===i||this.hls.trigger(h.LEVEL_SWITCHED,{level:i}))}}}get nextLevel(){let t=this.nextBufferedFrag;return t?t.level:-1}get currentFrag(){var t;if(this.fragPlaying)return this.fragPlaying;let e=(null==(t=this.media)?void 0:t.currentTime)||this.lastCurrentTime;return r(e)?this.getAppendedFrag(e):null}get currentProgramDateTime(){var t;let e=(null==(t=this.media)?void 0:t.currentTime)||this.lastCurrentTime;if(r(e)){let t=this.getLevelDetails(),i=this.currentFrag||(t?tQ(null,t.fragments,e):null);if(i){let t=i.programDateTime;if(null!==t)return new Date(t+(e-i.start)*1e3)}}return null}get currentLevel(){let t=this.currentFrag;return t?t.level:-1}get nextBufferedFrag(){let t=this.currentFrag;return t?this.followingBufferedFrag(t):null}get forceStartLoad(){return this._forceStartLoad}}class ah{constructor(t){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=t}abort(t){for(let i in this.keyUriToKeyInfo){let s=this.keyUriToKeyInfo[i].loader;if(s){var e;if(t&&t!==(null==(e=s.context)?void 0:e.frag.type))return;s.abort()}}}detach(){for(let t in this.keyUriToKeyInfo){let e=this.keyUriToKeyInfo[t];(e.mediaKeySessionContext||e.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[t]}}destroy(){for(let t in this.detach(),this.keyUriToKeyInfo){let e=this.keyUriToKeyInfo[t].loader;e&&e.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(t,e=o.KEY_LOAD_ERROR,i,s,r){return new eu({type:l.NETWORK_ERROR,details:e,fatal:!1,frag:t,response:r,error:i,networkDetails:s})}loadClear(t,e){if(this.emeController&&this.config.emeEnabled&&!this.emeController.getSelectedKeySystemFormats().length){if(e.length){let{sn:i,cc:s}=t;for(let t=0;t<e.length;t++){let r=e[t];if(s<=r.cc&&("initSegment"===i||"initSegment"===r.sn||i<r.sn))return this.emeController.selectKeySystemFormat(r).then(t=>{if(r.setKeyFormat(t),this.emeController&&this.config.requireKeySystemAccessOnStart){let e=eC(t);if(e)return this.emeController.getKeySystemAccess([e])}})}}else if(this.config.requireKeySystemAccessOnStart){let t=eF(this.config);if(t.length)return this.emeController.getKeySystemAccess(t)}}return null}load(t){return!t.decryptdata&&t.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(t).then(e=>this.loadInternal(t,e)):this.loadInternal(t)}loadInternal(t,e){var i,s,r;e&&t.setKeyFormat(e);let a=t.decryptdata;if(!a){let i=Error(e?`Expected frag.decryptdata to be defined after setting format ${e}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(t,o.KEY_LOAD_ERROR,i))}let n=a.uri;if(!n)return Promise.reject(this.createKeyLoadError(t,o.KEY_LOAD_ERROR,Error(`Invalid key URI: "${n}"`)));let l=this.keyUriToKeyInfo[n];if(null!=(i=l)&&i.decryptdata.key)return a.key=l.decryptdata.key,Promise.resolve({frag:t,keyInfo:l});if(null!=(s=l)&&s.keyLoadPromise)switch(null==(r=l.mediaKeySessionContext)?void 0:r.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return l.keyLoadPromise.then(e=>(a.key=e.keyInfo.decryptdata.key,{frag:t,keyInfo:l}))}switch(l=this.keyUriToKeyInfo[n]={decryptdata:a,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},a.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":if("identity"===a.keyFormat)return this.loadKeyHTTP(l,t);return this.loadKeyEME(l,t);case"AES-128":case"AES-256":case"AES-256-CTR":return this.loadKeyHTTP(l,t);default:return Promise.reject(this.createKeyLoadError(t,o.KEY_LOAD_ERROR,Error(`Key supplied with unsupported METHOD: "${a.method}"`)))}}loadKeyEME(t,e){let i={frag:e,keyInfo:t};if(this.emeController&&this.config.emeEnabled){let e=this.emeController.loadKey(i);if(e)return(t.keyLoadPromise=e.then(e=>(t.mediaKeySessionContext=e,i))).catch(e=>{throw t.keyLoadPromise=null,e})}return Promise.resolve(i)}loadKeyHTTP(t,e){let i=this.config,s=new i.loader(i);return e.keyLoader=t.loader=s,t.keyLoadPromise=new Promise((r,a)=>{let n={keyInfo:t,frag:e,responseType:"arraybuffer",url:t.decryptdata.uri},l=i.keyLoadPolicy.default,h={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0};s.load(n,h,{onSuccess:(t,e,i,s)=>{let{frag:n,keyInfo:l,url:h}=i;if(!n.decryptdata||l!==this.keyUriToKeyInfo[h])return a(this.createKeyLoadError(n,o.KEY_LOAD_ERROR,Error("after key load, decryptdata unset or changed"),s));l.decryptdata.key=n.decryptdata.key=new Uint8Array(t.data),n.keyLoader=null,l.loader=null,r({frag:n,keyInfo:l})},onError:(t,i,s,r)=>{this.resetLoader(i),a(this.createKeyLoadError(e,o.KEY_LOAD_ERROR,Error(`HTTP Error ${t.code} loading key ${t.text}`),s,k({url:n.url,data:void 0},t)))},onTimeout:(t,i,s)=>{this.resetLoader(i),a(this.createKeyLoadError(e,o.KEY_LOAD_TIMEOUT,Error("key loading timed out"),s))},onAbort:(t,i,s)=>{this.resetLoader(i),a(this.createKeyLoadError(e,o.INTERNAL_ABORTED,Error("key loading aborted"),s))}})})}resetLoader(t){let{frag:e,keyInfo:i,url:s}=t,r=i.loader;e.keyLoader===r&&(e.keyLoader=null,i.loader=null),delete this.keyUriToKeyInfo[s],r&&r.destroy()}}function ad(t){let{type:e}=t;switch(e){case _.AUDIO_TRACK:return x.AUDIO;case _.SUBTITLE_TRACK:return x.SUBTITLE;default:return x.MAIN}}function au(t,e){let i=t.url;return(void 0===i||0===i.indexOf("data:"))&&(i=e.url),i}class ac{constructor(t){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.onManifestLoaded=this.checkAutostartLoad,this.hls=t,this.registerListeners()}startLoad(t){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){let{hls:t}=this;t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.LEVEL_LOADING,this.onLevelLoading,this),t.on(h.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.on(h.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),t.on(h.LEVELS_UPDATED,this.onLevelsUpdated,this)}unregisterListeners(){let{hls:t}=this;t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.LEVEL_LOADING,this.onLevelLoading,this),t.off(h.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.off(h.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),t.off(h.LEVELS_UPDATED,this.onLevelsUpdated,this)}createInternalLoader(t){let e=this.hls.config,i=e.pLoader,s=e.loader,r=new(i||s)(e);return this.loaders[t.type]=r,r}getInternalLoader(t){return this.loaders[t.type]}resetInternalLoader(t){this.loaders[t]&&delete this.loaders[t]}destroyInternalLoaders(){for(let t in this.loaders){let e=this.loaders[t];e&&e.destroy(),this.resetInternalLoader(t)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(t,e){let{url:i}=e;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:_.MANIFEST,url:i,deliveryDirectives:null,levelOrTrack:null})}onLevelLoading(t,e){let{id:i,level:s,pathwayId:r,url:a,deliveryDirectives:n,levelInfo:l}=e;this.load({id:i,level:s,pathwayId:r,responseType:"text",type:_.LEVEL,url:a,deliveryDirectives:n,levelOrTrack:l})}onAudioTrackLoading(t,e){let{id:i,groupId:s,url:r,deliveryDirectives:a,track:n}=e;this.load({id:i,groupId:s,level:null,responseType:"text",type:_.AUDIO_TRACK,url:r,deliveryDirectives:a,levelOrTrack:n})}onSubtitleTrackLoading(t,e){let{id:i,groupId:s,url:r,deliveryDirectives:a,track:n}=e;this.load({id:i,groupId:s,level:null,responseType:"text",type:_.SUBTITLE_TRACK,url:r,deliveryDirectives:a,levelOrTrack:n})}onLevelsUpdated(t,e){let i=this.loaders[_.LEVEL];if(i){let t=i.context;t&&!e.levels.some(e=>e===t.levelOrTrack)&&(i.abort(),delete this.loaders[_.LEVEL])}}load(t){var e;let i,s=this.hls.config,a=this.getInternalLoader(t);if(a){let e=this.hls.logger,i=a.context;if(i&&i.levelOrTrack===t.levelOrTrack&&(i.url===t.url||i.deliveryDirectives&&!t.deliveryDirectives))return void(i.url===t.url?e.log(`[playlist-loader]: ignore ${t.url} ongoing request`):e.log(`[playlist-loader]: ignore ${t.url} in favor of ${i.url}`));e.log(`[playlist-loader]: aborting previous loader for type: ${t.type}`),a.abort()}if(i=t.type===_.MANIFEST?s.manifestLoadPolicy.default:R({},s.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),a=this.createInternalLoader(t),r(null==(e=t.deliveryDirectives)?void 0:e.part)){let e;if(t.type===_.LEVEL&&null!==t.level?e=this.hls.levels[t.level].details:t.type===_.AUDIO_TRACK&&null!==t.id?e=this.hls.audioTracks[t.id].details:t.type===_.SUBTITLE_TRACK&&null!==t.id&&(e=this.hls.subtitleTracks[t.id].details),e){let t=e.partTarget,s=e.targetduration;if(t&&s){let e=1e3*Math.max(3*t,.8*s);i=R({},i,{maxTimeToFirstByteMs:Math.min(e,i.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(e,i.maxTimeToFirstByteMs)})}}}let n=i.errorRetry||i.timeoutRetry||{},l={loadPolicy:i,timeout:i.maxLoadTimeMs,maxRetry:n.maxNumRetry||0,retryDelay:n.retryDelayMs||0,maxRetryDelay:n.maxRetryDelayMs||0};a.load(t,l,{onSuccess:(t,e,i,s)=>{let r=this.getInternalLoader(i);this.resetInternalLoader(i.type);let a=t.data;if(0!==a.indexOf("#EXTM3U"))return void this.handleManifestParsingError(t,i,Error("no EXTM3U delimiter"),s||null,e);e.parsing.start=performance.now(),eY.isMediaPlaylist(a)||i.type!==_.MANIFEST?this.handleTrackOrLevelPlaylist(t,e,i,s||null,r):this.handleMasterPlaylist(t,e,i,s)},onError:(t,e,i,s)=>{this.handleNetworkError(e,i,!1,t,s)},onTimeout:(t,e,i)=>{this.handleNetworkError(e,i,!0,void 0,t)}})}checkAutostartLoad(){if(!this.hls)return;let{config:{autoStartLoad:t,startPosition:e},forceStartLoad:i}=this.hls;(t||i)&&(this.hls.logger.log(`${t?"auto":"force"} startLoad with configured startPosition ${e}`),this.hls.startLoad(e))}handleMasterPlaylist(t,e,i,s){let r=this.hls,a=t.data,n=au(t,i),l=eY.parseMasterPlaylist(a,n);if(l.playlistParsingError)return void this.handleManifestParsingError(t,i,l.playlistParsingError,s,e);let{contentSteering:o,levels:d,sessionData:u,sessionKeys:c,startTimeOffset:f,variableList:g}=l;this.variableList=g;let{AUDIO:p=[],SUBTITLES:m,"CLOSED-CAPTIONS":y}=eY.parseMasterPlaylistMedia(a,n,l);p.length&&(p.some(t=>!t.url)||!d[0].audioCodec||d[0].attrs.AUDIO||(this.hls.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),p.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new eS({}),bitrate:0,url:""}))),r.trigger(h.MANIFEST_LOADED,{levels:d,audioTracks:p,subtitles:m,captions:y,contentSteering:o,url:n,stats:e,networkDetails:s,sessionData:u,sessionKeys:c,startTimeOffset:f,variableList:g})}handleTrackOrLevelPlaylist(t,e,i,s,a){let n=this.hls,{id:l,level:o,type:d}=i,u=au(t,i),c=r(o)?o:r(l)?l:0,f=ad(i),g=eY.parseLevelPlaylist(t.data,u,c,f,0,this.variableList);if(d===_.MANIFEST){let t={attrs:new eS({}),bitrate:0,details:g,name:"",url:u};g.requestScheduled=e.loading.start+e9(g,0),n.trigger(h.MANIFEST_LOADED,{levels:[t],audioTracks:[],url:u,stats:e,networkDetails:s,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}e.parsing.end=performance.now(),i.levelDetails=g,this.handlePlaylistLoaded(g,t,e,i,s,a)}handleManifestParsingError(t,e,i,s,r){this.hls.trigger(h.ERROR,{type:l.NETWORK_ERROR,details:o.MANIFEST_PARSING_ERROR,fatal:e.type===_.MANIFEST,url:t.url,err:i,error:i,reason:i.message,response:t,context:e,networkDetails:s,stats:r})}handleNetworkError(t,e,i=!1,s,r){let a=`A network ${i?"timeout":"error"+(s?" (status "+s.code+")":"")} occurred while loading ${t.type}`;t.type===_.LEVEL?a+=`: ${t.level} id: ${t.id}`:(t.type===_.AUDIO_TRACK||t.type===_.SUBTITLE_TRACK)&&(a+=` id: ${t.id} group-id: "${t.groupId}"`);let n=Error(a);this.hls.logger.warn(`[playlist-loader]: ${a}`);let d=o.UNKNOWN,u=!1,c=this.getInternalLoader(t);switch(t.type){case _.MANIFEST:d=i?o.MANIFEST_LOAD_TIMEOUT:o.MANIFEST_LOAD_ERROR,u=!0;break;case _.LEVEL:d=i?o.LEVEL_LOAD_TIMEOUT:o.LEVEL_LOAD_ERROR,u=!1;break;case _.AUDIO_TRACK:d=i?o.AUDIO_TRACK_LOAD_TIMEOUT:o.AUDIO_TRACK_LOAD_ERROR,u=!1;break;case _.SUBTITLE_TRACK:d=i?o.SUBTITLE_TRACK_LOAD_TIMEOUT:o.SUBTITLE_LOAD_ERROR,u=!1}c&&this.resetInternalLoader(t.type);let f={type:l.NETWORK_ERROR,details:d,fatal:u,url:t.url,loader:c,context:t,error:n,networkDetails:e,stats:r};s&&(f.response=k({url:(null==e?void 0:e.url)||t.url,data:void 0},s)),this.hls.trigger(h.ERROR,f)}handlePlaylistLoaded(t,e,i,s,r,a){let n=this.hls,{type:d,level:u,id:c,groupId:f,deliveryDirectives:g}=s,p=au(e,s),m=ad(s),y="number"==typeof s.level&&m===x.MAIN?u:void 0;if(!t.fragments.length){let a=t.playlistParsingError=Error("No Segments found in Playlist");n.trigger(h.ERROR,{type:l.NETWORK_ERROR,details:o.LEVEL_EMPTY_ERROR,fatal:!1,url:p,error:a,reason:a.message,response:e,context:s,level:y,parent:m,networkDetails:r,stats:i});return}t.targetduration||(t.playlistParsingError=Error("Missing Target Duration"));let v=t.playlistParsingError;if(v){if(this.hls.logger.warn(v),!n.config.ignorePlaylistParsingErrors)return void n.trigger(h.ERROR,{type:l.NETWORK_ERROR,details:o.LEVEL_PARSING_ERROR,fatal:!1,url:p,error:v,reason:v.message,response:e,context:s,level:y,parent:m,networkDetails:r,stats:i});t.playlistParsingError=null}switch(t.live&&a&&(a.getCacheAge&&(t.ageHeader=a.getCacheAge()||0),(!a.getCacheAge||isNaN(t.ageHeader))&&(t.ageHeader=0)),d){case _.MANIFEST:case _.LEVEL:n.trigger(h.LEVEL_LOADED,{details:t,levelInfo:s.levelOrTrack||n.levels[0],level:y||0,id:c||0,stats:i,networkDetails:r,deliveryDirectives:g,withoutMultiVariant:d===_.MANIFEST});break;case _.AUDIO_TRACK:n.trigger(h.AUDIO_TRACK_LOADED,{details:t,track:s.levelOrTrack,id:c||0,groupId:f||"",stats:i,networkDetails:r,deliveryDirectives:g});break;case _.SUBTITLE_TRACK:n.trigger(h.SUBTITLE_TRACK_LOADED,{details:t,track:s.levelOrTrack,id:c||0,groupId:f||"",stats:i,networkDetails:r,deliveryDirectives:g})}}}class af{static get version(){return iy}static isMSESupported(){return al()}static isSupported(){if(!al())return!1;let t=N();return"function"==typeof(null==t?void 0:t.isTypeSupported)&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(e=>t.isTypeSupported(tT(e,"video")))||["mp4a.40.2","fLaC"].some(e=>t.isTypeSupported(tT(e,"audio"))))}static getMediaSource(){return N()}static get Events(){return h}static get MetadataSchema(){return iM}static get ErrorTypes(){return l}static get ErrorDetails(){return o}static get DefaultConfig(){return af.defaultConfig?af.defaultConfig:r4}static set DefaultConfig(t){af.defaultConfig=t}constructor(t={}){this.config=void 0,this.userConfig=void 0,this.logger=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new im,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioStreamController=void 0,this.subtititleStreamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.interstitialsController=void 0,this.gapController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this._url=null,this._sessionId=void 0,this.triggeringException=void 0,this.started=!1;let e=this.logger=function(t,e,i){let s=w();if("object"==typeof console&&!0===t||"object"==typeof t){let r=["debug","log","info","warn","error"];r.forEach(e=>{s[e]=O(e,t,i)});try{s.log(`Debug logs enabled for "${e}" in hls.js version 1.6.5`)}catch(t){return w()}r.forEach(e=>{F[e]=O(e,t)})}else R(F,s);return s}(t.debug||!1,"Hls instance",t.assetPlayerId),i=this.config=function(t,e,i){if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==e.liveMaxLatencyDurationCount&&(void 0===e.liveSyncDurationCount||e.liveMaxLatencyDurationCount<=e.liveSyncDurationCount))throw Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==e.liveMaxLatencyDuration&&(void 0===e.liveSyncDuration||e.liveMaxLatencyDuration<=e.liveSyncDuration))throw Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');let s=function t(e){return e&&"object"==typeof e?Array.isArray(e)?e.map(t):Object.keys(e).reduce((i,s)=>(i[s]=t(e[s]),i),{}):e}(t),r=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return["manifest","level","frag"].forEach(t=>{let a=`${"level"===t?"playlist":t}LoadPolicy`,n=void 0===e[a],l=[];r.forEach(i=>{let r=`${t}Loading${i}`,o=e[r];if(void 0!==o&&n){l.push(r);let t=s[a].default;switch(e[a]={default:t},i){case"TimeOut":t.maxLoadTimeMs=o,t.maxTimeToFirstByteMs=o;break;case"MaxRetry":t.errorRetry.maxNumRetry=o,t.timeoutRetry.maxNumRetry=o;break;case"RetryDelay":t.errorRetry.retryDelayMs=o,t.timeoutRetry.retryDelayMs=o;break;case"MaxRetryTimeout":t.errorRetry.maxRetryDelayMs=o,t.timeoutRetry.maxRetryDelayMs=o}}}),l.length&&i.warn(`hls.js config: "${l.join('", "')}" setting(s) are deprecated, use "${a}": ${tG(e[a])}`)}),k(k({},s),e)}(af.DefaultConfig,t,e);this.userConfig=t,i.progressive&&function(t,e){let i=t.loader;i!==r0&&i!==r3?(e.log("[config]: Custom loader detected, cannot enable progressive streaming"),t.progressive=!1):function(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(t){}return!1}()&&(t.loader=r0,t.progressive=!0,t.enableSoftwareAES=!0,e.log("[config]: Progressive streaming enabled, using FetchLoader"))}(i,e);let{abrController:s,bufferController:r,capLevelController:a,errorController:n,fpsController:l}=i,o=new n(this),d=this.abrController=new s(this),u=new t7(this),c=i.interstitialsController,f=c?this.interstitialsController=new c(this,af):null,g=this.bufferController=new r(this,u),p=this.capLevelController=new a(this),m=new l(this),y=new ac(this),v=i.contentSteeringController,E=v?new v(this):null,T=this.levelController=new ar(this,E),b=new ai(this),S=new ah(this.config),A=this.streamController=new ao(this,u,S),_=this.gapController=new r8(this,u);p.setStreamController(A),m.setStreamController(A);let x=[y,T,A];f&&x.splice(1,0,f),E&&x.splice(1,0,E),this.networkControllers=x;let L=[d,g,_,p,m,b,u];this.audioTrackController=this.createController(i.audioTrackController,x);let I=i.audioStreamController;I&&x.push(this.audioStreamController=new I(this,u,S)),this.subtitleTrackController=this.createController(i.subtitleTrackController,x);let D=i.subtitleStreamController;D&&x.push(this.subtititleStreamController=new D(this,u,S)),this.createController(i.timelineController,L),S.emeController=this.emeController=this.createController(i.emeController,L),this.cmcdController=this.createController(i.cmcdController,L),this.latencyController=this.createController(as,L),this.coreComponents=L,x.push(o);let P=o.onErrorOut;"function"==typeof P&&this.on(h.ERROR,P,o),this.on(h.MANIFEST_LOADED,y.onManifestLoaded,y)}createController(t,e){if(t){let i=new t(this);return e&&e.push(i),i}return null}on(t,e,i=this){this._emitter.on(t,e,i)}once(t,e,i=this){this._emitter.once(t,e,i)}removeAllListeners(t){this._emitter.removeAllListeners(t)}off(t,e,i=this,s){this._emitter.off(t,e,i,s)}listeners(t){return this._emitter.listeners(t)}emit(t,e,i){return this._emitter.emit(t,e,i)}trigger(t,e){if(this.config.debug)return this.emit(t,t,e);try{return this.emit(t,t,e)}catch(e){if(this.logger.error("An internal error happened while handling event "+t+'. Error message: "'+e.message+'". Here is a stacktrace:',e),!this.triggeringException){this.triggeringException=!0;let i=t===h.ERROR;this.trigger(h.ERROR,{type:l.OTHER_ERROR,details:o.INTERNAL_EXCEPTION,fatal:i,event:t,error:e}),this.triggeringException=!1}}return!1}listenerCount(t){return this._emitter.listenerCount(t)}destroy(){this.logger.log("destroy"),this.trigger(h.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this._url=null,this.networkControllers.forEach(t=>t.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(t=>t.destroy()),this.coreComponents.length=0;let t=this.config;t.xhrSetup=t.fetchSetup=void 0,this.userConfig=null}attachMedia(t){if(!t||"media"in t&&!t.media){let e=Error(`attachMedia failed: invalid argument (${t})`);this.trigger(h.ERROR,{type:l.OTHER_ERROR,details:o.ATTACH_MEDIA_ERROR,fatal:!0,error:e});return}this.logger.log("attachMedia"),this._media&&(this.logger.warn("media must be detached before attaching"),this.detachMedia());let e="media"in t,i=e?t.media:t,s=e?t:{media:i};this._media=i,this.trigger(h.MEDIA_ATTACHING,s)}detachMedia(){this.logger.log("detachMedia"),this.trigger(h.MEDIA_DETACHING,{}),this._media=null}transferMedia(){this._media=null;let t=this.bufferController.transferMedia();return this.trigger(h.MEDIA_DETACHING,{transferMedia:t}),t}loadSource(t){this.stopLoad();let e=this.media,i=this._url,s=this._url=V.buildAbsoluteURL(self.location.href,t,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.logger.log(`loadSource:${s}`),e&&i&&(i!==s||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(e)),this.trigger(h.MANIFEST_LOADING,{url:t})}get url(){return this._url}get hasEnoughToStart(){return this.streamController.hasEnoughToStart}get startPosition(){return this.streamController.startPositionValue}startLoad(t=-1,e){this.logger.log(`startLoad(${t+(e?", <skip seek to start>":"")})`),this.started=!0,this.resumeBuffering();for(let i=0;i<this.networkControllers.length&&(this.networkControllers[i].startLoad(t,e),this.started&&this.networkControllers);i++);}stopLoad(){this.logger.log("stopLoad"),this.started=!1;for(let t=0;t<this.networkControllers.length&&(this.networkControllers[t].stopLoad(),!this.started&&this.networkControllers);t++);}get loadingEnabled(){return this.started}get bufferingEnabled(){return this.streamController.bufferingEnabled}resumeBuffering(){this.bufferingEnabled||(this.logger.log("resume buffering"),this.networkControllers.forEach(t=>{t.resumeBuffering&&t.resumeBuffering()}))}pauseBuffering(){this.bufferingEnabled&&(this.logger.log("pause buffering"),this.networkControllers.forEach(t=>{t.pauseBuffering&&t.pauseBuffering()}))}get inFlightFragments(){let t={[x.MAIN]:this.streamController.inFlightFrag};return this.audioStreamController&&(t[x.AUDIO]=this.audioStreamController.inFlightFrag),this.subtititleStreamController&&(t[x.SUBTITLE]=this.subtititleStreamController.inFlightFrag),t}swapAudioCodec(){this.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){this.logger.log("recoverMediaError");let t=this._media,e=null==t?void 0:t.currentTime;this.detachMedia(),t&&(this.attachMedia(t),e&&this.startLoad(e))}removeLevel(t){this.levelController.removeLevel(t)}get sessionId(){let t=this._sessionId;return t||(t=this._sessionId=function(){try{return crypto.randomUUID()}catch(t){try{let t=URL.createObjectURL(new Blob),e=t.toString();return URL.revokeObjectURL(t),e.slice(e.lastIndexOf("/")+1)}catch(e){let t=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?i:3&i|8).toString(16)})}}}()),t}get levels(){return this.levelController.levels||[]}get latestLevelDetails(){return this.streamController.getLevelDetails()||null}get loadLevelObj(){return this.levelController.loadLevelObj}get currentLevel(){return this.streamController.currentLevel}set currentLevel(t){this.logger.log(`set currentLevel:${t}`),this.levelController.manualLevel=t,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(t){this.logger.log(`set nextLevel:${t}`),this.levelController.manualLevel=t,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(t){this.logger.log(`set loadLevel:${t}`),this.levelController.manualLevel=t}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(t){this.levelController.nextLoadLevel=t}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(t){this.logger.log(`set firstLevel:${t}`),this.levelController.firstLevel=t}get startLevel(){let t=this.levelController.startLevel;return -1===t&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:t}set startLevel(t){this.logger.log(`set startLevel:${t}`),-1!==t&&(t=Math.max(t,this.minAutoLevel)),this.levelController.startLevel=t}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(t){let e=!!t;e!==this.config.capLevelToPlayerSize&&(e?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=e)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){let{bwEstimator:t}=this.abrController;return t?t.getEstimate():NaN}set bandwidthEstimate(t){this.abrController.resetEstimator(t)}get abrEwmaDefaultEstimate(){let{bwEstimator:t}=this.abrController;return t?t.defaultEstimate:NaN}get ttfbEstimate(){let{bwEstimator:t}=this.abrController;return t?t.getEstimateTTFB():NaN}set autoLevelCapping(t){this._autoLevelCapping!==t&&(this.logger.log(`set autoLevelCapping:${t}`),this._autoLevelCapping=t,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(t){tM.indexOf(t)>-1&&this._maxHdcpLevel!==t&&(this._maxHdcpLevel=t,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return -1===this.levelController.manualLevel}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){let{levels:t,config:{minAutoBitrate:e}}=this;if(!t)return 0;let i=t.length;for(let s=0;s<i;s++)if(t[s].maxBitrate>=e)return s;return 0}get maxAutoLevel(){let t,{levels:e,autoLevelCapping:i,maxHdcpLevel:s}=this;if(t=-1===i&&null!=e&&e.length?e.length-1:i,s)for(let i=t;i--;){let t=e[i].attrs["HDCP-LEVEL"];if(t&&t<=s)return i}return t}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(t){this.abrController.nextAutoLevel=t}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}get maxBufferLength(){return this.streamController.maxBufferLength}setAudioOption(t){var e;return(null==(e=this.audioTrackController)?void 0:e.setAudioOption(t))||null}setSubtitleOption(t){var e;return(null==(e=this.subtitleTrackController)?void 0:e.setSubtitleOption(t))||null}get allAudioTracks(){let t=this.audioTrackController;return t?t.allAudioTracks:[]}get audioTracks(){let t=this.audioTrackController;return t?t.audioTracks:[]}get audioTrack(){let t=this.audioTrackController;return t?t.audioTrack:-1}set audioTrack(t){let e=this.audioTrackController;e&&(e.audioTrack=t)}get allSubtitleTracks(){let t=this.subtitleTrackController;return t?t.allSubtitleTracks:[]}get subtitleTracks(){let t=this.subtitleTrackController;return t?t.subtitleTracks:[]}get subtitleTrack(){let t=this.subtitleTrackController;return t?t.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(t){let e=this.subtitleTrackController;e&&(e.subtitleTrack=t)}get subtitleDisplay(){let t=this.subtitleTrackController;return!!t&&t.subtitleDisplay}set subtitleDisplay(t){let e=this.subtitleTrackController;e&&(e.subtitleDisplay=t)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(t){this.config.lowLatencyMode=t}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}set targetLatency(t){this.latencyController.targetLatency=t}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}get pathways(){return this.levelController.pathways}get pathwayPriority(){return this.levelController.pathwayPriority}set pathwayPriority(t){this.levelController.pathwayPriority=t}get bufferedToEnd(){var t;return!!(null!=(t=this.bufferController)&&t.bufferedToEnd)}get interstitialsManager(){var t;return(null==(t=this.interstitialsController)?void 0:t.interstitialsManager)||null}getMediaDecodingInfo(t,e=this.allAudioTracks){return tC(t,tH(e),navigator.mediaCapabilities)}}function ag(t){return t+.5|0}af.defaultConfig=void 0;const ap=(t,e,i)=>Math.max(Math.min(t,i),e);function am(t){return ap(ag(2.55*t),0,255)}function ay(t){return ap(ag(255*t),0,255)}function av(t){return ap(ag(t/2.55)/100,0,1)}function aE(t){return ap(ag(100*t),0,100)}const aT={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,A:10,B:11,C:12,D:13,E:14,F:15,a:10,b:11,c:12,d:13,e:14,f:15},ab=[..."0123456789ABCDEF"],aS=t=>ab[15&t],aA=t=>ab[(240&t)>>4]+ab[15&t],a_=t=>(240&t)>>4==(15&t),ax=t=>a_(t.r)&&a_(t.g)&&a_(t.b)&&a_(t.a),aL=(t,e)=>t<255?e(t):"",aI=/^(hsla?|hwb|hsv)\(\s*([-+.e\d]+)(?:deg)?[\s,]+([-+.e\d]+)%[\s,]+([-+.e\d]+)%(?:[\s,]+([-+.e\d]+)(%)?)?\s*\)$/;function aR(t,e,i){let s=e*Math.min(i,1-i),r=(e,r=(e+t/30)%12)=>i-s*Math.max(Math.min(r-3,9-r,1),-1);return[r(0),r(8),r(4)]}function aD(t,e,i){let s=(s,r=(s+t/60)%6)=>i-i*e*Math.max(Math.min(r,4-r,1),0);return[s(5),s(3),s(1)]}function ak(t,e,i){let s,r=aR(t,1,.5);for(e+i>1&&(s=1/(e+i),e*=s,i*=s),s=0;s<3;s++)r[s]*=1-e-i,r[s]+=e;return r}function aP(t){let e,i,s,r=t.r/255,a=t.g/255,n=t.b/255,l=Math.max(r,a,n),o=Math.min(r,a,n),h=(l+o)/2;l!==o&&(s=l-o,i=h>.5?s/(2-l-o):s/(l+o),e=60*(e=r===l?(a-n)/s+6*(a<n):a===l?(n-r)/s+2:(r-a)/s+4)+.5);return[0|e,i||0,h]}function aC(t,e,i,s){return(Array.isArray(e)?t(e[0],e[1],e[2]):t(e,i,s)).map(ay)}function aM(t){return(t%360+360)%360}const aw={x:"dark",Z:"light",Y:"re",X:"blu",W:"gr",V:"medium",U:"slate",A:"ee",T:"ol",S:"or",B:"ra",C:"lateg",D:"ights",R:"in",Q:"turquois",E:"hi",P:"ro",O:"al",N:"le",M:"de",L:"yello",F:"en",K:"ch",G:"arks",H:"ea",I:"ightg",J:"wh"},aO={OiceXe:"f0f8ff",antiquewEte:"faebd7",aqua:"ffff",aquamarRe:"7fffd4",azuY:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"0",blanKedOmond:"ffebcd",Xe:"ff",XeviTet:"8a2be2",bPwn:"a52a2a",burlywood:"deb887",caMtXe:"5f9ea0",KartYuse:"7fff00",KocTate:"d2691e",cSO:"ff7f50",cSnflowerXe:"6495ed",cSnsilk:"fff8dc",crimson:"dc143c",cyan:"ffff",xXe:"8b",xcyan:"8b8b",xgTMnPd:"b8860b",xWay:"a9a9a9",xgYF:"6400",xgYy:"a9a9a9",xkhaki:"bdb76b",xmagFta:"8b008b",xTivegYF:"556b2f",xSange:"ff8c00",xScEd:"9932cc",xYd:"8b0000",xsOmon:"e9967a",xsHgYF:"8fbc8f",xUXe:"483d8b",xUWay:"2f4f4f",xUgYy:"2f4f4f",xQe:"ced1",xviTet:"9400d3",dAppRk:"ff1493",dApskyXe:"bfff",dimWay:"696969",dimgYy:"696969",dodgerXe:"1e90ff",fiYbrick:"b22222",flSOwEte:"fffaf0",foYstWAn:"228b22",fuKsia:"ff00ff",gaRsbSo:"dcdcdc",ghostwEte:"f8f8ff",gTd:"ffd700",gTMnPd:"daa520",Way:"808080",gYF:"8000",gYFLw:"adff2f",gYy:"808080",honeyMw:"f0fff0",hotpRk:"ff69b4",RdianYd:"cd5c5c",Rdigo:"4b0082",ivSy:"fffff0",khaki:"f0e68c",lavFMr:"e6e6fa",lavFMrXsh:"fff0f5",lawngYF:"7cfc00",NmoncEffon:"fffacd",ZXe:"add8e6",ZcSO:"f08080",Zcyan:"e0ffff",ZgTMnPdLw:"fafad2",ZWay:"d3d3d3",ZgYF:"90ee90",ZgYy:"d3d3d3",ZpRk:"ffb6c1",ZsOmon:"ffa07a",ZsHgYF:"20b2aa",ZskyXe:"87cefa",ZUWay:"778899",ZUgYy:"778899",ZstAlXe:"b0c4de",ZLw:"ffffe0",lime:"ff00",limegYF:"32cd32",lRF:"faf0e6",magFta:"ff00ff",maPon:"800000",VaquamarRe:"66cdaa",VXe:"cd",VScEd:"ba55d3",VpurpN:"9370db",VsHgYF:"3cb371",VUXe:"7b68ee",VsprRggYF:"fa9a",VQe:"48d1cc",VviTetYd:"c71585",midnightXe:"191970",mRtcYam:"f5fffa",mistyPse:"ffe4e1",moccasR:"ffe4b5",navajowEte:"ffdead",navy:"80",Tdlace:"fdf5e6",Tive:"808000",TivedBb:"6b8e23",Sange:"ffa500",SangeYd:"ff4500",ScEd:"da70d6",pOegTMnPd:"eee8aa",pOegYF:"98fb98",pOeQe:"afeeee",pOeviTetYd:"db7093",papayawEp:"ffefd5",pHKpuff:"ffdab9",peru:"cd853f",pRk:"ffc0cb",plum:"dda0dd",powMrXe:"b0e0e6",purpN:"800080",YbeccapurpN:"663399",Yd:"ff0000",Psybrown:"bc8f8f",PyOXe:"4169e1",saddNbPwn:"8b4513",sOmon:"fa8072",sandybPwn:"f4a460",sHgYF:"2e8b57",sHshell:"fff5ee",siFna:"a0522d",silver:"c0c0c0",skyXe:"87ceeb",UXe:"6a5acd",UWay:"708090",UgYy:"708090",snow:"fffafa",sprRggYF:"ff7f",stAlXe:"4682b4",tan:"d2b48c",teO:"8080",tEstN:"d8bfd8",tomato:"ff6347",Qe:"40e0d0",viTet:"ee82ee",JHt:"f5deb3",wEte:"ffffff",wEtesmoke:"f5f5f5",Lw:"ffff00",LwgYF:"9acd32"},aF=/^rgba?\(\s*([-+.\d]+)(%)?[\s,]+([-+.e\d]+)(%)?[\s,]+([-+.e\d]+)(%)?(?:[\s,/]+([-+.e\d]+)(%)?)?\s*\)$/,aN=t=>t<=.0031308?12.92*t:1.055*Math.pow(t,1/2.4)-.055,aB=t=>t<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4);function aU(t,e,i){if(t){let s=aP(t);s[e]=Math.max(0,Math.min(s[e]+s[e]*i,0===e?360:1)),t.r=(s=aC(aR,s,void 0,void 0))[0],t.g=s[1],t.b=s[2]}}function a$(t,e){return t?Object.assign(e||{},t):t}function aG(t){var e={r:0,g:0,b:0,a:255};return Array.isArray(t)?t.length>=3&&(e={r:t[0],g:t[1],b:t[2],a:255},t.length>3&&(e.a=ay(t[3]))):(e=a$(t,{r:0,g:0,b:0,a:1})).a=ay(e.a),e}class aV{constructor(t){let i;if(t instanceof aV)return t;let s=typeof t;if("object"===s)i=aG(t);else{var r,a;"string"===s&&(a=t.length,"#"===t[0]&&(4===a||5===a?r={r:255&17*aT[t[1]],g:255&17*aT[t[2]],b:255&17*aT[t[3]],a:5===a?17*aT[t[4]]:255}:(7===a||9===a)&&(r={r:aT[t[1]]<<4|aT[t[2]],g:aT[t[3]]<<4|aT[t[4]],b:aT[t[5]]<<4|aT[t[6]],a:9===a?aT[t[7]]<<4|aT[t[8]]:255})),i=r||function(t){e||((e=function(){let t,e,i,s,r,a={},n=Object.keys(aO),l=Object.keys(aw);for(t=0;t<n.length;t++){for(e=0,s=r=n[t];e<l.length;e++)i=l[e],r=r.replace(i,aw[i]);i=parseInt(aO[s],16),a[r]=[i>>16&255,i>>8&255,255&i]}return a}()).transparent=[0,0,0,0]);let i=e[t.toLowerCase()];return i&&{r:i[0],g:i[1],b:i[2],a:4===i.length?i[3]:255}}(t)||("r"===t.charAt(0)?function(t){let e,i,s,r=aF.exec(t),a=255;if(r){if(r[7]!==e){let t=+r[7];a=r[8]?am(t):ap(255*t,0,255)}return e=+r[1],i=+r[3],s=+r[5],e=255&(r[2]?am(e):ap(e,0,255)),{r:e,g:i=255&(r[4]?am(i):ap(i,0,255)),b:s=255&(r[6]?am(s):ap(s,0,255)),a:a}}}(t):function(t){let e,i=aI.exec(t),s=255;if(!i)return;i[5]!==e&&(s=i[6]?am(+i[5]):ay(+i[5]));let r=aM(+i[2]),a=i[3]/100,n=i[4]/100;return{r:(e="hwb"===i[1]?aC(ak,r,a,n):"hsv"===i[1]?aC(aD,r,a,n):aC(aR,r,a,n))[0],g:e[1],b:e[2],a:s}}(t)))}this._rgb=i,this._valid=!!i}get valid(){return this._valid}get rgb(){var t=a$(this._rgb);return t&&(t.a=av(t.a)),t}set rgb(t){this._rgb=aG(t)}rgbString(){var t;return this._valid?(t=this._rgb)&&(t.a<255?`rgba(${t.r}, ${t.g}, ${t.b}, ${av(t.a)})`:`rgb(${t.r}, ${t.g}, ${t.b})`):void 0}hexString(){var t,e;return this._valid?(e=ax(t=this._rgb)?aS:aA,t?"#"+e(t.r)+e(t.g)+e(t.b)+aL(t.a,e):void 0):void 0}hslString(){return this._valid?function(t){if(!t)return;let e=aP(t),i=e[0],s=aE(e[1]),r=aE(e[2]);return t.a<255?`hsla(${i}, ${s}%, ${r}%, ${av(t.a)})`:`hsl(${i}, ${s}%, ${r}%)`}(this._rgb):void 0}mix(t,e){if(t){let i,s=this.rgb,r=t.rgb,a=e===i?.5:e,n=2*a-1,l=s.a-r.a,o=((n*l==-1?n:(n+l)/(1+n*l))+1)/2;i=1-o,s.r=255&o*s.r+i*r.r+.5,s.g=255&o*s.g+i*r.g+.5,s.b=255&o*s.b+i*r.b+.5,s.a=a*s.a+(1-a)*r.a,this.rgb=s}return this}interpolate(t,e){return t&&(this._rgb=function(t,e,i){let s=aB(av(t.r)),r=aB(av(t.g)),a=aB(av(t.b));return{r:ay(aN(s+i*(aB(av(e.r))-s))),g:ay(aN(r+i*(aB(av(e.g))-r))),b:ay(aN(a+i*(aB(av(e.b))-a))),a:t.a+i*(e.a-t.a)}}(this._rgb,t._rgb,e)),this}clone(){return new aV(this.rgb)}alpha(t){return this._rgb.a=ay(t),this}clearer(t){let e=this._rgb;return e.a*=1-t,this}greyscale(){let t=this._rgb,e=ag(.3*t.r+.59*t.g+.11*t.b);return t.r=t.g=t.b=e,this}opaquer(t){let e=this._rgb;return e.a*=1+t,this}negate(){let t=this._rgb;return t.r=255-t.r,t.g=255-t.g,t.b=255-t.b,this}lighten(t){return aU(this._rgb,2,t),this}darken(t){return aU(this._rgb,2,-t),this}saturate(t){return aU(this._rgb,1,t),this}desaturate(t){return aU(this._rgb,1,-t),this}rotate(t){var e,i;return e=this._rgb,(i=aP(e))[0]=aM(i[0]+t),e.r=(i=aC(aR,i,void 0,void 0))[0],e.g=i[1],e.b=i[2],this}}function aH(){}const aK=(s=0,()=>s++);function aW(t){return null==t}function aY(t){if(Array.isArray&&Array.isArray(t))return!0;let e=Object.prototype.toString.call(t);return"[object"===e.slice(0,7)&&"Array]"===e.slice(-6)}function aj(t){return null!==t&&"[object Object]"===Object.prototype.toString.call(t)}function az(t){return("number"==typeof t||t instanceof Number)&&isFinite(+t)}function aq(t,e){return az(t)?t:e}function aX(t,e){return void 0===t?e:t}const aQ=(t,e)=>"string"==typeof t&&t.endsWith("%")?parseFloat(t)/100:t/e,aZ=(t,e)=>"string"==typeof t&&t.endsWith("%")?parseFloat(t)/100*e:+t;function aJ(t,e,i){if(t&&"function"==typeof t.call)return t.apply(i,e)}function a0(t,e,i,s){let r,a,n;if(aY(t))if(a=t.length,s)for(r=a-1;r>=0;r--)e.call(i,t[r],r);else for(r=0;r<a;r++)e.call(i,t[r],r);else if(aj(t))for(r=0,a=(n=Object.keys(t)).length;r<a;r++)e.call(i,t[n[r]],n[r])}function a1(t,e){let i,s,r,a;if(!t||!e||t.length!==e.length)return!1;for(i=0,s=t.length;i<s;++i)if(r=t[i],a=e[i],r.datasetIndex!==a.datasetIndex||r.index!==a.index)return!1;return!0}function a2(t){if(aY(t))return t.map(a2);if(aj(t)){let e=Object.create(null),i=Object.keys(t),s=i.length,r=0;for(;r<s;++r)e[i[r]]=a2(t[i[r]]);return e}return t}function a5(t){return -1===["__proto__","prototype","constructor"].indexOf(t)}function a3(t,e,i,s){if(!a5(t))return;let r=e[t],a=i[t];aj(r)&&aj(a)?a4(r,a,s):e[t]=a2(a)}function a4(t,e,i){let s,r=aY(e)?e:[e],a=r.length;if(!aj(t))return t;let n=(i=i||{}).merger||a3;for(let e=0;e<a;++e){if(!aj(s=r[e]))continue;let a=Object.keys(s);for(let e=0,r=a.length;e<r;++e)n(a[e],t,s,i)}return t}function a8(t,e){return a4(t,e,{merger:a6})}function a6(t,e,i){if(!a5(t))return;let s=e[t],r=i[t];aj(s)&&aj(r)?a8(s,r):Object.prototype.hasOwnProperty.call(e,t)||(e[t]=a2(r))}const a9={"":t=>t,x:t=>t.x,y:t=>t.y};function a7(t,e){return(a9[e]||(a9[e]=function(t){let e=function(t){let e=t.split("."),i=[],s="";for(let t of e)(s+=t).endsWith("\\")?s=s.slice(0,-1)+".":(i.push(s),s="");return i}(t);return t=>{for(let i of e){if(""===i)break;t=t&&t[i]}return t}}(e)))(t)}function nt(t){return t.charAt(0).toUpperCase()+t.slice(1)}const ne=t=>void 0!==t,ni=t=>"function"==typeof t,ns=(t,e)=>{if(t.size!==e.size)return!1;for(let i of t)if(!e.has(i))return!1;return!0},nr=Math.PI,na=2*nr,nn=na+nr,nl=Number.POSITIVE_INFINITY,no=nr/180,nh=nr/2,nd=nr/4,nu=2*nr/3,nc=Math.log10,nf=Math.sign;function ng(t,e,i){return Math.abs(t-e)<i}function np(t){let e=Math.round(t),i=Math.pow(10,Math.floor(nc(t=ng(t,e,t/1e3)?e:t))),s=t/i;return(s<=1?1:s<=2?2:s<=5?5:10)*i}function nm(t){return"symbol"!=typeof t&&("object"!=typeof t||null===t||!!(Symbol.toPrimitive in t||"toString"in t||"valueOf"in t))&&!isNaN(parseFloat(t))&&isFinite(t)}function ny(t,e,i){let s,r,a;for(s=0,r=t.length;s<r;s++)isNaN(a=t[s][i])||(e.min=Math.min(e.min,a),e.max=Math.max(e.max,a))}function nv(t){return nr/180*t}function nE(t){if(!az(t))return;let e=1,i=0;for(;Math.round(t*e)/e!==t;)e*=10,i++;return i}function nT(t,e){let i=e.x-t.x,s=e.y-t.y,r=Math.sqrt(i*i+s*s),a=Math.atan2(s,i);return a<-.5*nr&&(a+=na),{angle:a,distance:r}}function nb(t,e){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function nS(t,e){return(t-e+nn)%na-nr}function nA(t){return(t%na+na)%na}function n_(t,e,i,s){let r=nA(t),a=nA(e),n=nA(i),l=nA(a-r),o=nA(n-r),h=nA(r-a),d=nA(r-n);return r===a||r===n||s&&a===n||l>o&&h<d}function nx(t,e,i){return Math.max(e,Math.min(i,t))}function nL(t,e,i,s=1e-6){return t>=Math.min(e,i)-s&&t<=Math.max(e,i)+s}function nI(t,e,i){let s;i=i||(i=>t[i]<e);let r=t.length-1,a=0;for(;r-a>1;)i(s=a+r>>1)?a=s:r=s;return{lo:a,hi:r}}const nR=(t,e,i,s)=>nI(t,i,s?s=>{let r=t[s][e];return r<i||r===i&&t[s+1][e]===i}:s=>t[s][e]<i),nD=(t,e,i)=>nI(t,i,s=>t[s][e]>=i),nk=["push","pop","shift","splice","unshift"];function nP(t,e){let i=t._chartjs;if(!i)return;let s=i.listeners,r=s.indexOf(e);-1!==r&&s.splice(r,1),s.length>0||(nk.forEach(e=>{delete t[e]}),delete t._chartjs)}function nC(t){let e=new Set(t);return e.size===t.length?t:Array.from(e)}const nM="undefined"==typeof window?function(t){return t()}:window.requestAnimationFrame;function nw(t,e){let i=[],s=!1;return function(...r){i=r,s||(s=!0,nM.call(window,()=>{s=!1,t.apply(e,i)}))}}const nO=t=>"start"===t?"left":"end"===t?"right":"center",nF=(t,e,i)=>"start"===t?e:"end"===t?i:(e+i)/2,nN=(t,e,i,s)=>t===(s?"left":"right")?i:"center"===t?(e+i)/2:e;function nB(t,e,i){let s=e.length,r=0,a=s;if(t._sorted){let{iScale:n,vScale:l,_parsed:o}=t,h=t.dataset&&t.dataset.options?t.dataset.options.spanGaps:null,d=n.axis,{min:u,max:c,minDefined:f,maxDefined:g}=n.getUserBounds();if(f){if(r=Math.min(nR(o,d,u).lo,i?s:nR(e,d,n.getPixelForValue(u)).lo),h){let t=o.slice(0,r+1).reverse().findIndex(t=>!aW(t[l.axis]));r-=Math.max(0,t)}r=nx(r,0,s-1)}if(g){let t=Math.max(nR(o,n.axis,c,!0).hi+1,i?0:nR(e,d,n.getPixelForValue(c),!0).hi+1);if(h){let e=o.slice(t-1).findIndex(t=>!aW(t[l.axis]));t+=Math.max(0,e)}a=nx(t,r,s)-r}else a=s-r}return{start:r,count:a}}function nU(t){let{xScale:e,yScale:i,_scaleRanges:s}=t,r={xmin:e.min,xmax:e.max,ymin:i.min,ymax:i.max};if(!s)return t._scaleRanges=r,!0;let a=s.xmin!==e.min||s.xmax!==e.max||s.ymin!==i.min||s.ymax!==i.max;return Object.assign(s,r),a}const n$=t=>0===t||1===t,nG=(t,e,i)=>-(Math.pow(2,10*(t-=1))*Math.sin((t-e)*na/i)),nV=(t,e,i)=>Math.pow(2,-10*t)*Math.sin((t-e)*na/i)+1,nH={linear:t=>t,easeInQuad:t=>t*t,easeOutQuad:t=>-t*(t-2),easeInOutQuad:t=>(t/=.5)<1?.5*t*t:-.5*(--t*(t-2)-1),easeInCubic:t=>t*t*t,easeOutCubic:t=>(t-=1)*t*t+1,easeInOutCubic:t=>(t/=.5)<1?.5*t*t*t:.5*((t-=2)*t*t+2),easeInQuart:t=>t*t*t*t,easeOutQuart:t=>-((t-=1)*t*t*t-1),easeInOutQuart:t=>(t/=.5)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2),easeInQuint:t=>t*t*t*t*t,easeOutQuint:t=>(t-=1)*t*t*t*t+1,easeInOutQuint:t=>(t/=.5)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2),easeInSine:t=>-Math.cos(t*nh)+1,easeOutSine:t=>Math.sin(t*nh),easeInOutSine:t=>-.5*(Math.cos(nr*t)-1),easeInExpo:t=>0===t?0:Math.pow(2,10*(t-1)),easeOutExpo:t=>1===t?1:-Math.pow(2,-10*t)+1,easeInOutExpo:t=>n$(t)?t:t<.5?.5*Math.pow(2,10*(2*t-1)):.5*(-Math.pow(2,-10*(2*t-1))+2),easeInCirc:t=>t>=1?t:-(Math.sqrt(1-t*t)-1),easeOutCirc:t=>Math.sqrt(1-(t-=1)*t),easeInOutCirc:t=>(t/=.5)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1),easeInElastic:t=>n$(t)?t:nG(t,.075,.3),easeOutElastic:t=>n$(t)?t:nV(t,.075,.3),easeInOutElastic:t=>n$(t)?t:t<.5?.5*nG(2*t,.1125,.45):.5+.5*nV(2*t-1,.1125,.45),easeInBack:t=>t*t*(2.70158*t-1.70158),easeOutBack:t=>(t-=1)*t*(2.70158*t+1.70158)+1,easeInOutBack(t){let e=1.70158;return(t/=.5)<1?.5*(t*t*(((e*=1.525)+1)*t-e)):.5*((t-=2)*t*(((e*=1.525)+1)*t+e)+2)},easeInBounce:t=>1-nH.easeOutBounce(1-t),easeOutBounce:t=>t<.36363636363636365?7.5625*t*t:t<.7272727272727273?7.5625*(t-=.5454545454545454)*t+.75:t<.9090909090909091?7.5625*(t-=.8181818181818182)*t+.9375:7.5625*(t-=.9545454545454546)*t+.984375,easeInOutBounce:t=>t<.5?.5*nH.easeInBounce(2*t):.5*nH.easeOutBounce(2*t-1)+.5};function nK(t){if(t&&"object"==typeof t){let e=t.toString();return"[object CanvasPattern]"===e||"[object CanvasGradient]"===e}return!1}function nW(t){return nK(t)?t:new aV(t)}function nY(t){return nK(t)?t:new aV(t).saturate(.5).darken(.1).hexString()}const nj=["x","y","borderWidth","radius","tension"],nz=["color","borderColor","backgroundColor"],nq=new Map;function nX(t,e,i){return(function(t,e){let i=t+JSON.stringify(e=e||{}),s=nq.get(i);return s||(s=new Intl.NumberFormat(t,e),nq.set(i,s)),s})(e,i).format(t)}const nQ={values:t=>aY(t)?t:""+t,numeric(t,e,i){let s;if(0===t)return"0";let r=this.chart.options.locale,a=t;if(i.length>1){var n,l;let e,r=Math.max(Math.abs(i[0].value),Math.abs(i[i.length-1].value));(r<1e-4||r>1e15)&&(s="scientific"),n=t,Math.abs(e=(l=i).length>3?l[2].value-l[1].value:l[1].value-l[0].value)>=1&&n!==Math.floor(n)&&(e=n-Math.floor(n)),a=e}let o=nc(Math.abs(a)),h=isNaN(o)?1:Math.max(Math.min(-1*Math.floor(o),20),0),d={notation:s,minimumFractionDigits:h,maximumFractionDigits:h};return Object.assign(d,this.options.ticks.format),nX(t,r,d)},logarithmic(t,e,i){return 0===t?"0":[1,2,3,5,10,15].includes(i[e].significand||t/Math.pow(10,Math.floor(nc(t))))||e>.8*i.length?nQ.numeric.call(this,t,e,i):""}},nZ=Object.create(null),nJ=Object.create(null);function n0(t,e){if(!e)return t;let i=e.split(".");for(let e=0,s=i.length;e<s;++e){let s=i[e];t=t[s]||(t[s]=Object.create(null))}return t}function n1(t,e,i){return"string"==typeof e?a4(n0(t,e),i):a4(n0(t,""),e)}var n2=new class{constructor(t,e){this.animation=void 0,this.backgroundColor="rgba(0,0,0,0.1)",this.borderColor="rgba(0,0,0,0.1)",this.color="#666",this.datasets={},this.devicePixelRatio=t=>t.chart.platform.getDevicePixelRatio(),this.elements={},this.events=["mousemove","mouseout","click","touchstart","touchmove"],this.font={family:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",size:12,style:"normal",lineHeight:1.2,weight:null},this.hover={},this.hoverBackgroundColor=(t,e)=>nY(e.backgroundColor),this.hoverBorderColor=(t,e)=>nY(e.borderColor),this.hoverColor=(t,e)=>nY(e.color),this.indexAxis="x",this.interaction={mode:"nearest",intersect:!0,includeInvisible:!1},this.maintainAspectRatio=!0,this.onHover=null,this.onClick=null,this.parsing=!0,this.plugins={},this.responsive=!0,this.scale=void 0,this.scales={},this.showLine=!0,this.drawActiveElementsOnTop=!0,this.describe(t),this.apply(e)}set(t,e){return n1(this,t,e)}get(t){return n0(this,t)}describe(t,e){return n1(nJ,t,e)}override(t,e){return n1(nZ,t,e)}route(t,e,i,s){let r=n0(this,t),a=n0(this,i),n="_"+e;Object.defineProperties(r,{[n]:{value:r[e],writable:!0},[e]:{enumerable:!0,get(){let t=this[n],e=a[s];return aj(t)?Object.assign({},e,t):aX(t,e)},set(t){this[n]=t}}})}apply(t){t.forEach(t=>t(this))}}({_scriptable:t=>!t.startsWith("on"),_indexable:t=>"events"!==t,hover:{_fallback:"interaction"},interaction:{_scriptable:!1,_indexable:!1}},[function(t){t.set("animation",{delay:void 0,duration:1e3,easing:"easeOutQuart",fn:void 0,from:void 0,loop:void 0,to:void 0,type:void 0}),t.describe("animation",{_fallback:!1,_indexable:!1,_scriptable:t=>"onProgress"!==t&&"onComplete"!==t&&"fn"!==t}),t.set("animations",{colors:{type:"color",properties:nz},numbers:{type:"number",properties:nj}}),t.describe("animations",{_fallback:"animation"}),t.set("transitions",{active:{animation:{duration:400}},resize:{animation:{duration:0}},show:{animations:{colors:{from:"transparent"},visible:{type:"boolean",duration:0}}},hide:{animations:{colors:{to:"transparent"},visible:{type:"boolean",easing:"linear",fn:t=>0|t}}}})},function(t){t.set("layout",{autoPadding:!0,padding:{top:0,right:0,bottom:0,left:0}})},function(t){t.set("scale",{display:!0,offset:!1,reverse:!1,beginAtZero:!1,bounds:"ticks",clip:!0,grace:0,grid:{display:!0,lineWidth:1,drawOnChartArea:!0,drawTicks:!0,tickLength:8,tickWidth:(t,e)=>e.lineWidth,tickColor:(t,e)=>e.color,offset:!1},border:{display:!0,dash:[],dashOffset:0,width:1},title:{display:!1,text:"",padding:{top:4,bottom:4}},ticks:{minRotation:0,maxRotation:50,mirror:!1,textStrokeWidth:0,textStrokeColor:"",padding:3,display:!0,autoSkip:!0,autoSkipPadding:3,labelOffset:0,callback:nQ.values,minor:{},major:{},align:"center",crossAlign:"near",showLabelBackdrop:!1,backdropColor:"rgba(255, 255, 255, 0.75)",backdropPadding:2}}),t.route("scale.ticks","color","","color"),t.route("scale.grid","color","","borderColor"),t.route("scale.border","color","","borderColor"),t.route("scale.title","color","","color"),t.describe("scale",{_fallback:!1,_scriptable:t=>!t.startsWith("before")&&!t.startsWith("after")&&"callback"!==t&&"parser"!==t,_indexable:t=>"borderDash"!==t&&"tickBorderDash"!==t&&"dash"!==t}),t.describe("scales",{_fallback:"scale"}),t.describe("scale.ticks",{_scriptable:t=>"backdropPadding"!==t&&"callback"!==t,_indexable:t=>"backdropPadding"!==t})}]);function n5(t,e,i,s,r){let a=e[r];return a||(a=e[r]=t.measureText(r).width,i.push(r)),a>s&&(s=a),s}function n3(t,e,i){let s=t.currentDevicePixelRatio,r=0!==i?Math.max(i/2,.5):0;return Math.round((e-r)*s)/s+r}function n4(t,e){(e||t)&&((e=e||t.getContext("2d")).save(),e.resetTransform(),e.clearRect(0,0,t.width,t.height),e.restore())}function n8(t,e,i,s){n6(t,e,i,s,null)}function n6(t,e,i,s,r){let a,n,l,o,h,d,u,c,f=e.pointStyle,g=e.rotation,p=e.radius,m=(g||0)*no;if(f&&"object"==typeof f&&("[object HTMLImageElement]"===(a=f.toString())||"[object HTMLCanvasElement]"===a)){t.save(),t.translate(i,s),t.rotate(m),t.drawImage(f,-f.width/2,-f.height/2,f.width,f.height),t.restore();return}if(!isNaN(p)&&!(p<=0)){switch(t.beginPath(),f){default:r?t.ellipse(i,s,r/2,p,0,0,na):t.arc(i,s,p,0,na),t.closePath();break;case"triangle":d=r?r/2:p,t.moveTo(i+Math.sin(m)*d,s-Math.cos(m)*p),m+=nu,t.lineTo(i+Math.sin(m)*d,s-Math.cos(m)*p),m+=nu,t.lineTo(i+Math.sin(m)*d,s-Math.cos(m)*p),t.closePath();break;case"rectRounded":h=.516*p,n=Math.cos(m+nd)*(o=p-h),u=Math.cos(m+nd)*(r?r/2-h:o),l=Math.sin(m+nd)*o,c=Math.sin(m+nd)*(r?r/2-h:o),t.arc(i-u,s-l,h,m-nr,m-nh),t.arc(i+c,s-n,h,m-nh,m),t.arc(i+u,s+l,h,m,m+nh),t.arc(i-c,s+n,h,m+nh,m+nr),t.closePath();break;case"rect":if(!g){o=Math.SQRT1_2*p,d=r?r/2:o,t.rect(i-d,s-o,2*d,2*o);break}m+=nd;case"rectRot":u=Math.cos(m)*(r?r/2:p),n=Math.cos(m)*p,l=Math.sin(m)*p,c=Math.sin(m)*(r?r/2:p),t.moveTo(i-u,s-l),t.lineTo(i+c,s-n),t.lineTo(i+u,s+l),t.lineTo(i-c,s+n),t.closePath();break;case"crossRot":m+=nd;case"cross":u=Math.cos(m)*(r?r/2:p),n=Math.cos(m)*p,l=Math.sin(m)*p,c=Math.sin(m)*(r?r/2:p),t.moveTo(i-u,s-l),t.lineTo(i+u,s+l),t.moveTo(i+c,s-n),t.lineTo(i-c,s+n);break;case"star":u=Math.cos(m)*(r?r/2:p),n=Math.cos(m)*p,l=Math.sin(m)*p,c=Math.sin(m)*(r?r/2:p),t.moveTo(i-u,s-l),t.lineTo(i+u,s+l),t.moveTo(i+c,s-n),t.lineTo(i-c,s+n),m+=nd,u=Math.cos(m)*(r?r/2:p),n=Math.cos(m)*p,l=Math.sin(m)*p,c=Math.sin(m)*(r?r/2:p),t.moveTo(i-u,s-l),t.lineTo(i+u,s+l),t.moveTo(i+c,s-n),t.lineTo(i-c,s+n);break;case"line":n=r?r/2:Math.cos(m)*p,l=Math.sin(m)*p,t.moveTo(i-n,s-l),t.lineTo(i+n,s+l);break;case"dash":t.moveTo(i,s),t.lineTo(i+Math.cos(m)*(r?r/2:p),s+Math.sin(m)*p);break;case!1:t.closePath()}t.fill(),e.borderWidth>0&&t.stroke()}}function n9(t,e,i){return i=i||.5,!e||t&&t.x>e.left-i&&t.x<e.right+i&&t.y>e.top-i&&t.y<e.bottom+i}function n7(t,e){t.save(),t.beginPath(),t.rect(e.left,e.top,e.right-e.left,e.bottom-e.top),t.clip()}function lt(t){t.restore()}function le(t,e,i,s,r){if(!e)return t.lineTo(i.x,i.y);if("middle"===r){let s=(e.x+i.x)/2;t.lineTo(s,e.y),t.lineTo(s,i.y)}else"after"===r!=!!s?t.lineTo(e.x,i.y):t.lineTo(i.x,e.y);t.lineTo(i.x,i.y)}function li(t,e,i,s){if(!e)return t.lineTo(i.x,i.y);t.bezierCurveTo(s?e.cp1x:e.cp2x,s?e.cp1y:e.cp2y,s?i.cp2x:i.cp1x,s?i.cp2y:i.cp1y,i.x,i.y)}function ls(t,e,i,s,r,a={}){let n,l,o=aY(e)?e:[e],h=a.strokeWidth>0&&""!==a.strokeColor;for(t.save(),t.font=r.string,a.translation&&t.translate(a.translation[0],a.translation[1]),aW(a.rotation)||t.rotate(a.rotation),a.color&&(t.fillStyle=a.color),a.textAlign&&(t.textAlign=a.textAlign),a.textBaseline&&(t.textBaseline=a.textBaseline),n=0;n<o.length;++n)l=o[n],a.backdrop&&function(t,e){let i=t.fillStyle;t.fillStyle=e.color,t.fillRect(e.left,e.top,e.width,e.height),t.fillStyle=i}(t,a.backdrop),h&&(a.strokeColor&&(t.strokeStyle=a.strokeColor),aW(a.strokeWidth)||(t.lineWidth=a.strokeWidth),t.strokeText(l,i,s,a.maxWidth)),t.fillText(l,i,s,a.maxWidth),function(t,e,i,s,r){if(r.strikethrough||r.underline){let a=t.measureText(s),n=e-a.actualBoundingBoxLeft,l=e+a.actualBoundingBoxRight,o=i-a.actualBoundingBoxAscent,h=i+a.actualBoundingBoxDescent,d=r.strikethrough?(o+h)/2:h;t.strokeStyle=t.fillStyle,t.beginPath(),t.lineWidth=r.decorationWidth||2,t.moveTo(n,d),t.lineTo(l,d),t.stroke()}}(t,i,s,l,a),s+=Number(r.lineHeight);t.restore()}function lr(t,e){let{x:i,y:s,w:r,h:a,radius:n}=e;t.arc(i+n.topLeft,s+n.topLeft,n.topLeft,1.5*nr,nr,!0),t.lineTo(i,s+a-n.bottomLeft),t.arc(i+n.bottomLeft,s+a-n.bottomLeft,n.bottomLeft,nr,nh,!0),t.lineTo(i+r-n.bottomRight,s+a),t.arc(i+r-n.bottomRight,s+a-n.bottomRight,n.bottomRight,nh,0,!0),t.lineTo(i+r,s+n.topRight),t.arc(i+r-n.topRight,s+n.topRight,n.topRight,0,-nh,!0),t.lineTo(i+n.topLeft,s)}const la=/^(normal|(\d+(?:\.\d+)?)(px|em|%)?)$/,ln=/^(normal|italic|initial|inherit|unset|(oblique( -?[0-9]?[0-9]deg)?))$/,ll=t=>+t||0;function lo(t,e){let i={},s=aj(e),r=s?Object.keys(e):e,a=aj(t)?s?i=>aX(t[i],t[e[i]]):e=>t[e]:()=>t;for(let t of r)i[t]=ll(a(t));return i}function lh(t){return lo(t,{top:"y",right:"x",bottom:"y",left:"x"})}function ld(t){return lo(t,["topLeft","topRight","bottomLeft","bottomRight"])}function lu(t){let e=lh(t);return e.width=e.left+e.right,e.height=e.top+e.bottom,e}function lc(t,e){t=t||{},e=e||n2.font;let i=aX(t.size,e.size);"string"==typeof i&&(i=parseInt(i,10));let s=aX(t.style,e.style);s&&!(""+s).match(ln)&&(console.warn('Invalid font style specified: "'+s+'"'),s=void 0);let r={family:aX(t.family,e.family),lineHeight:function(t,e){let i=(""+t).match(la);if(!i||"normal"===i[1])return 1.2*e;switch(t=+i[2],i[3]){case"px":return t;case"%":t/=100}return e*t}(aX(t.lineHeight,e.lineHeight),i),size:i,style:s,weight:aX(t.weight,e.weight),string:""};return r.string=!r||aW(r.size)||aW(r.family)?null:(r.style?r.style+" ":"")+(r.weight?r.weight+" ":"")+r.size+"px "+r.family,r}function lf(t,e,i,s){let r,a,n,l=!0;for(r=0,a=t.length;r<a;++r)if(void 0!==(n=t[r])&&(void 0!==e&&"function"==typeof n&&(n=n(e),l=!1),void 0!==i&&aY(n)&&(n=n[i%n.length],l=!1),void 0!==n))return s&&!l&&(s.cacheable=!1),n}function lg(t,e){return Object.assign(Object.create(t),e)}function lp(t,e=[""],i,s,r=()=>t[0]){let a=i||t;return void 0===s&&(s=l_("_fallback",t)),new Proxy({[Symbol.toStringTag]:"Object",_cacheable:!0,_scopes:t,_rootScopes:a,_fallback:s,_getTarget:r,override:i=>lp([i,...t],e,a,s)},{deleteProperty:(e,i)=>(delete e[i],delete e._keys,delete t[0][i],!0),get:(i,s)=>lT(i,s,()=>(function(t,e,i,s){let r;for(let a of e)if(void 0!==(r=l_(lv(a,t),i)))return lE(t,r)?lS(i,s,t,r):r})(s,e,t,i)),getOwnPropertyDescriptor:(t,e)=>Reflect.getOwnPropertyDescriptor(t._scopes[0],e),getPrototypeOf:()=>Reflect.getPrototypeOf(t[0]),has:(t,e)=>lx(t).includes(e),ownKeys:t=>lx(t),set(t,e,i){let s=t._storage||(t._storage=r());return t[e]=s[e]=i,delete t._keys,!0}})}function lm(t,e,i,s){return new Proxy({_cacheable:!1,_proxy:t,_context:e,_subProxy:i,_stack:new Set,_descriptors:ly(t,s),setContext:e=>lm(t,e,i,s),override:r=>lm(t.override(r),e,i,s)},{deleteProperty:(e,i)=>(delete e[i],delete t[i],!0),get:(t,e,i)=>lT(t,e,()=>(function(t,e,i){let{_proxy:s,_context:r,_subProxy:a,_descriptors:n}=t,l=s[e];return ni(l)&&n.isScriptable(e)&&(l=function(t,e,i,s){let{_proxy:r,_context:a,_subProxy:n,_stack:l}=i;if(l.has(t))throw Error("Recursion detected: "+Array.from(l).join("->")+"->"+t);l.add(t);let o=e(a,n||s);return l.delete(t),lE(t,o)&&(o=lS(r._scopes,r,t,o)),o}(e,l,t,i)),aY(l)&&l.length&&(l=function(t,e,i,s){let{_proxy:r,_context:a,_subProxy:n,_descriptors:l}=i;if(void 0!==a.index&&s(t))return e[a.index%e.length];if(aj(e[0])){let i=e,s=r._scopes.filter(t=>t!==i);for(let o of(e=[],i)){let i=lS(s,r,t,o);e.push(lm(i,a,n&&n[t],l))}}return e}(e,l,t,n.isIndexable)),lE(e,l)&&(l=lm(l,r,a&&a[e],n)),l})(t,e,i)),getOwnPropertyDescriptor:(e,i)=>e._descriptors.allKeys?Reflect.has(t,i)?{enumerable:!0,configurable:!0}:void 0:Reflect.getOwnPropertyDescriptor(t,i),getPrototypeOf:()=>Reflect.getPrototypeOf(t),has:(e,i)=>Reflect.has(t,i),ownKeys:()=>Reflect.ownKeys(t),set:(e,i,s)=>(t[i]=s,delete e[i],!0)})}function ly(t,e={scriptable:!0,indexable:!0}){let{_scriptable:i=e.scriptable,_indexable:s=e.indexable,_allKeys:r=e.allKeys}=t;return{allKeys:r,scriptable:i,indexable:s,isScriptable:ni(i)?i:()=>i,isIndexable:ni(s)?s:()=>s}}const lv=(t,e)=>t?t+nt(e):e,lE=(t,e)=>aj(e)&&"adapters"!==t&&(null===Object.getPrototypeOf(e)||e.constructor===Object);function lT(t,e,i){if(Object.prototype.hasOwnProperty.call(t,e)||"constructor"===e)return t[e];let s=i();return t[e]=s,s}const lb=(t,e)=>!0===t?e:"string"==typeof t?a7(e,t):void 0;function lS(t,e,i,s){var r;let a=e._rootScopes,n=(r=e._fallback,ni(r)?r(i,s):r),l=[...t,...a],o=new Set;o.add(s);let h=lA(o,l,i,n||i,s);return null!==h&&(void 0===n||n===i||null!==(h=lA(o,l,n,h,s)))&&lp(Array.from(o),[""],a,n,()=>(function(t,e,i){let s=t._getTarget();e in s||(s[e]={});let r=s[e];return aY(r)&&aj(i)?i:r||{}})(e,i,s))}function lA(t,e,i,s,r){for(;i;)i=function(t,e,i,s,r){for(let n of e){let e=lb(i,n);if(e){var a;t.add(e);let n=(a=e._fallback,ni(a)?a(i,r):a);if(void 0!==n&&n!==i&&n!==s)return n}else if(!1===e&&void 0!==s&&i!==s)return null}return!1}(t,e,i,s,r);return i}function l_(t,e){for(let i of e){if(!i)continue;let e=i[t];if(void 0!==e)return e}}function lx(t){let e=t._keys;return e||(e=t._keys=function(t){let e=new Set;for(let i of t)for(let t of Object.keys(i).filter(t=>!t.startsWith("_")))e.add(t);return Array.from(e)}(t._scopes)),e}function lL(t,e,i,s){let r,a,n,{iScale:l}=t,{key:o="r"}=this._parsing,h=Array(s);for(r=0;r<s;++r)n=e[a=r+i],h[r]={r:l.parse(a7(n,o),a)};return h}const lI=Number.EPSILON||1e-14,lR=(t,e)=>e<t.length&&!t[e].skip&&t[e],lD=t=>"x"===t?"y":"x";function lk(t,e,i){return Math.max(Math.min(t,i),e)}function lP(){return"undefined"!=typeof window&&"undefined"!=typeof document}function lC(t){let e=t.parentNode;return e&&"[object ShadowRoot]"===e.toString()&&(e=e.host),e}function lM(t,e,i){let s;return"string"==typeof t?(s=parseInt(t,10),-1!==t.indexOf("%")&&(s=s/100*e.parentNode[i])):s=t,s}const lw=t=>t.ownerDocument.defaultView.getComputedStyle(t,null),lO=["top","right","bottom","left"];function lF(t,e,i){let s={};i=i?"-"+i:"";for(let r=0;r<4;r++){let a=lO[r];s[a]=parseFloat(t[e+"-"+a+i])||0}return s.width=s.left+s.right,s.height=s.top+s.bottom,s}const lN=(t,e,i)=>(t>0||e>0)&&(!i||!i.shadowRoot);function lB(t,e){if("native"in t)return t;let{canvas:i,currentDevicePixelRatio:s}=e,r=lw(i),a="border-box"===r.boxSizing,n=lF(r,"padding"),l=lF(r,"border","width"),{x:o,y:h,box:d}=function(t,e){let i,s,r=t.touches,a=r&&r.length?r[0]:t,{offsetX:n,offsetY:l}=a,o=!1;if(lN(n,l,t.target))i=n,s=l;else{let t=e.getBoundingClientRect();i=a.clientX-t.left,s=a.clientY-t.top,o=!0}return{x:i,y:s,box:o}}(t,i),u=n.left+(d&&l.left),c=n.top+(d&&l.top),{width:f,height:g}=e;return a&&(f-=n.width+l.width,g-=n.height+l.height),{x:Math.round((o-u)/f*i.width/s),y:Math.round((h-c)/g*i.height/s)}}const lU=t=>Math.round(10*t)/10;function l$(t,e,i){let s=e||1,r=Math.floor(t.height*s),a=Math.floor(t.width*s);t.height=Math.floor(t.height),t.width=Math.floor(t.width);let n=t.canvas;return n.style&&(i||!n.style.height&&!n.style.width)&&(n.style.height=`${t.height}px`,n.style.width=`${t.width}px`),(t.currentDevicePixelRatio!==s||n.height!==r||n.width!==a)&&(t.currentDevicePixelRatio=s,n.height=r,n.width=a,t.ctx.setTransform(s,0,0,s,0,0),!0)}const lG=function(){let t=!1;try{let e={get passive(){return t=!0,!1}};lP()&&(window.addEventListener("test",null,e),window.removeEventListener("test",null,e))}catch(t){}return t}();function lV(t,e){let i=lw(t).getPropertyValue(e),s=i&&i.match(/^(\d+)(\.\d+)?px$/);return s?+s[1]:void 0}function lH(t,e,i,s){return{x:t.x+i*(e.x-t.x),y:t.y+i*(e.y-t.y)}}function lK(t,e,i,s){return{x:t.x+i*(e.x-t.x),y:"middle"===s?i<.5?t.y:e.y:"after"===s?i<1?t.y:e.y:i>0?e.y:t.y}}function lW(t,e,i,s){let r={x:t.cp2x,y:t.cp2y},a={x:e.cp1x,y:e.cp1y},n=lH(t,r,i),l=lH(r,a,i),o=lH(a,e,i),h=lH(n,l,i),d=lH(l,o,i);return lH(h,d,i)}function lY(t,e,i){var s;return t?(s=i,{x:t=>e+e+s-t,setWidth(t){s=t},textAlign:t=>"center"===t?t:"right"===t?"left":"right",xPlus:(t,e)=>t-e,leftForLtr:(t,e)=>t-e}):{x:t=>t,setWidth(t){},textAlign:t=>t,xPlus:(t,e)=>t+e,leftForLtr:(t,e)=>t}}function lj(t,e){let i,s;("ltr"===e||"rtl"===e)&&(s=[(i=t.canvas.style).getPropertyValue("direction"),i.getPropertyPriority("direction")],i.setProperty("direction",e,"important"),t.prevTextDirection=s)}function lz(t,e){void 0!==e&&(delete t.prevTextDirection,t.canvas.style.setProperty("direction",e[0],e[1]))}function lq(t){return"angle"===t?{between:n_,compare:nS,normalize:nA}:{between:nL,compare:(t,e)=>t-e,normalize:t=>t}}function lX({start:t,end:e,count:i,loop:s,style:r}){return{start:t%i,end:e%i,loop:s&&(e-t+1)%i==0,style:r}}function lQ(t,e,i){let s,r,a;if(!i)return[t];let{property:n,start:l,end:o}=i,h=e.length,{compare:d,between:u,normalize:c}=lq(n),{start:f,end:g,loop:p,style:m}=function(t,e,i){let s,{property:r,start:a,end:n}=i,{between:l,normalize:o}=lq(r),h=e.length,{start:d,end:u,loop:c}=t;if(c){for(d+=h,u+=h,s=0;s<h&&l(o(e[d%h][r]),a,n);++s)d--,u--;d%=h,u%=h}return u<d&&(u+=h),{start:d,end:u,loop:c,style:t.style}}(t,e,i),y=[],v=!1,E=null,T=()=>u(l,a,s)&&0!==d(l,a),b=()=>0===d(o,s)||u(o,a,s),S=()=>v||T(),A=()=>!v||b();for(let t=f,i=f;t<=g;++t)(r=e[t%h]).skip||(s=c(r[n]))!==a&&(v=u(s,l,o),null===E&&S()&&(E=0===d(s,l)?t:i),null!==E&&A()&&(y.push(lX({start:E,end:t,loop:p,count:h,style:m})),E=null),i=t,a=s);return null!==E&&y.push(lX({start:E,end:g,loop:p,count:h,style:m})),y}function lZ(t,e){let i=[],s=t.segments;for(let r=0;r<s.length;r++){let a=lQ(s[r],t.points,e);a.length&&i.push(...a)}return i}function lJ(t,e,i,s){return s&&s.setContext&&i?function(t,e,i,s){let r=t._chart.getContext(),a=l0(t.options),{_datasetIndex:n,options:{spanGaps:l}}=t,o=i.length,h=[],d=a,u=e[0].start,c=u;function f(t,e,s,r){let a=l?-1:1;if(t!==e){for(t+=o;i[t%o].skip;)t-=a;for(;i[e%o].skip;)e+=a;t%o!=e%o&&(h.push({start:t%o,end:e%o,loop:s,style:r}),d=r,u=e%o)}}for(let t of e){let e,a=i[(u=l?u:t.start)%o];for(c=u+1;c<=t.end;c++){let l=i[c%o];(function(t,e){if(!e)return!1;let i=[],s=function(t,e){return nK(e)?(i.includes(e)||i.push(e),i.indexOf(e)):e};return JSON.stringify(t,s)!==JSON.stringify(e,s)})(e=l0(s.setContext(lg(r,{type:"segment",p0:a,p1:l,p0DataIndex:(c-1)%o,p1DataIndex:c%o,datasetIndex:n}))),d)&&f(u,c-1,t.loop,d),a=l,d=e}u<c-1&&f(u,c-1,t.loop,d)}return h}(t,e,i,s):e}function l0(t){return{backgroundColor:t.backgroundColor,borderCapStyle:t.borderCapStyle,borderDash:t.borderDash,borderDashOffset:t.borderDashOffset,borderJoinStyle:t.borderJoinStyle,borderWidth:t.borderWidth,borderColor:t.borderColor}}function l1(t,e,i){return t.options.clip?t[i]:e[i]}function l2(t,e){let i=e._clip;if(i.disabled)return!1;let s=function(t,e){let{xScale:i,yScale:s}=t;return i&&s?{left:l1(i,e,"left"),right:l1(i,e,"right"),top:l1(s,e,"top"),bottom:l1(s,e,"bottom")}:e}(e,t.chartArea);return{left:!1===i.left?0:s.left-(!0===i.left?0:i.left),right:!1===i.right?t.width:s.right+(!0===i.right?0:i.right),top:!1===i.top?0:s.top-(!0===i.top?0:i.top),bottom:!1===i.bottom?t.height:s.bottom+(!0===i.bottom?0:i.bottom)}}var l5=new class{constructor(){this._request=null,this._charts=new Map,this._running=!1,this._lastDate=void 0}_notify(t,e,i,s){let r=e.listeners[s],a=e.duration;r.forEach(s=>s({chart:t,initial:e.initial,numSteps:a,currentStep:Math.min(i-e.start,a)}))}_refresh(){this._request||(this._running=!0,this._request=nM.call(window,()=>{this._update(),this._request=null,this._running&&this._refresh()}))}_update(t=Date.now()){let e=0;this._charts.forEach((i,s)=>{let r;if(!i.running||!i.items.length)return;let a=i.items,n=a.length-1,l=!1;for(;n>=0;--n)(r=a[n])._active?(r._total>i.duration&&(i.duration=r._total),r.tick(t),l=!0):(a[n]=a[a.length-1],a.pop());l&&(s.draw(),this._notify(s,i,t,"progress")),a.length||(i.running=!1,this._notify(s,i,t,"complete"),i.initial=!1),e+=a.length}),this._lastDate=t,0===e&&(this._running=!1)}_getAnims(t){let e=this._charts,i=e.get(t);return i||(i={running:!1,initial:!0,items:[],listeners:{complete:[],progress:[]}},e.set(t,i)),i}listen(t,e,i){this._getAnims(t).listeners[e].push(i)}add(t,e){e&&e.length&&this._getAnims(t).items.push(...e)}has(t){return this._getAnims(t).items.length>0}start(t){let e=this._charts.get(t);e&&(e.running=!0,e.start=Date.now(),e.duration=e.items.reduce((t,e)=>Math.max(t,e._duration),0),this._refresh())}running(t){if(!this._running)return!1;let e=this._charts.get(t);return!!e&&!!e.running&&!!e.items.length}stop(t){let e=this._charts.get(t);if(!e||!e.items.length)return;let i=e.items,s=i.length-1;for(;s>=0;--s)i[s].cancel();e.items=[],this._notify(t,e,Date.now(),"complete")}remove(t){return this._charts.delete(t)}};const l3="transparent",l4={boolean:(t,e,i)=>i>.5?e:t,color(t,e,i){let s=nW(t||l3),r=s.valid&&nW(e||l3);return r&&r.valid?r.mix(s,i).hexString():e},number:(t,e,i)=>t+(e-t)*i};class l8{constructor(t,e,i,s){let r=e[i];s=lf([t.to,s,r,t.from]);let a=lf([t.from,r,s]);this._active=!0,this._fn=t.fn||l4[t.type||typeof a],this._easing=nH[t.easing]||nH.linear,this._start=Math.floor(Date.now()+(t.delay||0)),this._duration=this._total=Math.floor(t.duration),this._loop=!!t.loop,this._target=e,this._prop=i,this._from=a,this._to=s,this._promises=void 0}active(){return this._active}update(t,e,i){if(this._active){this._notify(!1);let s=this._target[this._prop],r=i-this._start,a=this._duration-r;this._start=i,this._duration=Math.floor(Math.max(a,t.duration)),this._total+=r,this._loop=!!t.loop,this._to=lf([t.to,e,s,t.from]),this._from=lf([t.from,s,e])}}cancel(){this._active&&(this.tick(Date.now()),this._active=!1,this._notify(!1))}tick(t){let e,i=t-this._start,s=this._duration,r=this._prop,a=this._from,n=this._loop,l=this._to;if(this._active=a!==l&&(n||i<s),!this._active){this._target[r]=l,this._notify(!0);return}if(i<0){this._target[r]=a;return}e=i/s%2,e=n&&e>1?2-e:e,e=this._easing(Math.min(1,Math.max(0,e))),this._target[r]=this._fn(a,l,e)}wait(){let t=this._promises||(this._promises=[]);return new Promise((e,i)=>{t.push({res:e,rej:i})})}_notify(t){let e=t?"res":"rej",i=this._promises||[];for(let t=0;t<i.length;t++)i[t][e]()}}class l6{constructor(t,e){this._chart=t,this._properties=new Map,this.configure(e)}configure(t){if(!aj(t))return;let e=Object.keys(n2.animation),i=this._properties;Object.getOwnPropertyNames(t).forEach(s=>{let r=t[s];if(!aj(r))return;let a={};for(let t of e)a[t]=r[t];(aY(r.properties)&&r.properties||[s]).forEach(t=>{t!==s&&i.has(t)||i.set(t,a)})})}_animateOptions(t,e){let i=e.options,s=function(t,e){if(!e)return;let i=t.options;if(!i){t.options=e;return}return i.$shared&&(t.options=i=Object.assign({},i,{$shared:!1,$animations:{}})),i}(t,i);if(!s)return[];let r=this._createAnimations(s,i);return i.$shared&&(function(t,e){let i=[],s=Object.keys(e);for(let e=0;e<s.length;e++){let r=t[s[e]];r&&r.active()&&i.push(r.wait())}return Promise.all(i)})(t.options.$animations,i).then(()=>{t.options=i},()=>{}),r}_createAnimations(t,e){let i,s=this._properties,r=[],a=t.$animations||(t.$animations={}),n=Object.keys(e),l=Date.now();for(i=n.length-1;i>=0;--i){let o=n[i];if("$"===o.charAt(0))continue;if("options"===o){r.push(...this._animateOptions(t,e));continue}let h=e[o],d=a[o],u=s.get(o);if(d)if(u&&d.active()){d.update(u,h,l);continue}else d.cancel();if(!u||!u.duration){t[o]=h;continue}a[o]=d=new l8(u,t,o,h),r.push(d)}return r}update(t,e){if(0===this._properties.size)return void Object.assign(t,e);let i=this._createAnimations(t,e);if(i.length)return l5.add(this._chart,i),!0}}function l9(t,e){let i=t&&t.options||{},s=i.reverse,r=void 0===i.min?e:0,a=void 0===i.max?e:0;return{start:s?a:r,end:s?r:a}}function l7(t,e){let i,s,r=[],a=t._getSortedDatasetMetas(e);for(i=0,s=a.length;i<s;++i)r.push(a[i].index);return r}function ot(t,e,i,s={}){let r,a,n,l,o=t.keys,h="single"===s.mode;if(null===e)return;let d=!1;for(r=0,a=o.length;r<a;++r){if((n=+o[r])===i){if(d=!0,s.all)continue;break}az(l=t.values[n])&&(h||0===e||nf(e)===nf(l))&&(e+=l)}return d||s.all?e:0}function oe(t,e){let i=t&&t.options.stacked;return i||void 0===i&&void 0!==e.stack}function oi(t,e,i,s){for(let r of e.getMatchingVisibleMetas(s).reverse()){let e=t[r.index];if(i&&e>0||!i&&e<0)return r.index}return null}function os(t,e){let i,{chart:s,_cachedMeta:r}=t,a=s._stacks||(s._stacks={}),{iScale:n,vScale:l,index:o}=r,h=n.axis,d=l.axis,u=`${n.id}.${l.id}.${r.stack||r.type}`,c=e.length;for(let t=0;t<c;++t){let s=e[t],{[h]:n,[d]:c}=s;(i=(s._stacks||(s._stacks={}))[d]=function(t,e,i){let s=t[e]||(t[e]={});return s[i]||(s[i]={})}(a,u,n))[o]=c,i._top=oi(i,l,!0,r.type),i._bottom=oi(i,l,!1,r.type),(i._visualValues||(i._visualValues={}))[o]=c}}function or(t,e){let i=t.scales;return Object.keys(i).filter(t=>i[t].axis===e).shift()}function oa(t,e){let i=t.controller.index,s=t.vScale&&t.vScale.axis;if(s)for(let r of e=e||t._parsed){let t=r._stacks;if(!t||void 0===t[s]||void 0===t[s][i])return;delete t[s][i],void 0!==t[s]._visualValues&&void 0!==t[s]._visualValues[i]&&delete t[s]._visualValues[i]}}const on=t=>"reset"===t||"none"===t,ol=(t,e)=>e?t:Object.assign({},t),oo=(t,e,i)=>t&&!e.hidden&&e._stacked&&{keys:l7(i,!0),values:null};class oh{static defaults={};static datasetElementType=null;static dataElementType=null;constructor(t,e){this.chart=t,this._ctx=t.ctx,this.index=e,this._cachedDataOpts={},this._cachedMeta=this.getMeta(),this._type=this._cachedMeta.type,this.options=void 0,this._parsing=!1,this._data=void 0,this._objectData=void 0,this._sharedOptions=void 0,this._drawStart=void 0,this._drawCount=void 0,this.enableOptionSharing=!1,this.supportsDecimation=!1,this.$context=void 0,this._syncList=[],this.datasetElementType=new.target.datasetElementType,this.dataElementType=new.target.dataElementType,this.initialize()}initialize(){let t=this._cachedMeta;this.configure(),this.linkScales(),t._stacked=oe(t.vScale,t),this.addElements(),this.options.fill&&!this.chart.isPluginEnabled("filler")&&console.warn("Tried to use the 'fill' option without the 'Filler' plugin enabled. Please import and register the 'Filler' plugin and make sure it is not disabled in the options")}updateIndex(t){this.index!==t&&oa(this._cachedMeta),this.index=t}linkScales(){let t=this.chart,e=this._cachedMeta,i=this.getDataset(),s=(t,e,i,s)=>"x"===t?e:"r"===t?s:i,r=e.xAxisID=aX(i.xAxisID,or(t,"x")),a=e.yAxisID=aX(i.yAxisID,or(t,"y")),n=e.rAxisID=aX(i.rAxisID,or(t,"r")),l=e.indexAxis,o=e.iAxisID=s(l,r,a,n),h=e.vAxisID=s(l,a,r,n);e.xScale=this.getScaleForId(r),e.yScale=this.getScaleForId(a),e.rScale=this.getScaleForId(n),e.iScale=this.getScaleForId(o),e.vScale=this.getScaleForId(h)}getDataset(){return this.chart.data.datasets[this.index]}getMeta(){return this.chart.getDatasetMeta(this.index)}getScaleForId(t){return this.chart.scales[t]}_getOtherScale(t){let e=this._cachedMeta;return t===e.iScale?e.vScale:e.iScale}reset(){this._update("reset")}_destroy(){let t=this._cachedMeta;this._data&&nP(this._data,this),t._stacked&&oa(t)}_dataCheck(){let t=this.getDataset(),e=t.data||(t.data=[]),i=this._data;if(aj(e)){let t=this._cachedMeta;this._data=function(t,e){let i,s,r,{iScale:a,vScale:n}=e,l="x"===a.axis?"x":"y",o="x"===n.axis?"x":"y",h=Object.keys(t),d=Array(h.length);for(i=0,s=h.length;i<s;++i)r=h[i],d[i]={[l]:r,[o]:t[r]};return d}(e,t)}else if(i!==e){if(i){nP(i,this);let t=this._cachedMeta;oa(t),t._parsed=[]}e&&Object.isExtensible(e)&&function(t,e){if(t._chartjs)return t._chartjs.listeners.push(e);Object.defineProperty(t,"_chartjs",{configurable:!0,enumerable:!1,value:{listeners:[e]}}),nk.forEach(e=>{let i="_onData"+nt(e),s=t[e];Object.defineProperty(t,e,{configurable:!0,enumerable:!1,value(...e){let r=s.apply(this,e);return t._chartjs.listeners.forEach(t=>{"function"==typeof t[i]&&t[i](...e)}),r}})})}(e,this),this._syncList=[],this._data=e}}addElements(){let t=this._cachedMeta;this._dataCheck(),this.datasetElementType&&(t.dataset=new this.datasetElementType)}buildOrUpdateElements(t){let e=this._cachedMeta,i=this.getDataset(),s=!1;this._dataCheck();let r=e._stacked;e._stacked=oe(e.vScale,e),e.stack!==i.stack&&(s=!0,oa(e),e.stack=i.stack),this._resyncElements(t),(s||r!==e._stacked)&&(os(this,e._parsed),e._stacked=oe(e.vScale,e))}configure(){let t=this.chart.config,e=t.datasetScopeKeys(this._type),i=t.getOptionScopes(this.getDataset(),e,!0);this.options=t.createResolver(i,this.getContext()),this._parsing=this.options.parsing,this._cachedDataOpts={}}parse(t,e){let i,s,r,{_cachedMeta:a,_data:n}=this,{iScale:l,_stacked:o}=a,h=l.axis,d=0===t&&e===n.length||a._sorted,u=t>0&&a._parsed[t-1];if(!1===this._parsing)a._parsed=n,a._sorted=!0,r=n;else{r=aY(n[t])?this.parseArrayData(a,n,t,e):aj(n[t])?this.parseObjectData(a,n,t,e):this.parsePrimitiveData(a,n,t,e);let l=()=>null===s[h]||u&&s[h]<u[h];for(i=0;i<e;++i)a._parsed[i+t]=s=r[i],d&&(l()&&(d=!1),u=s);a._sorted=d}o&&os(this,r)}parsePrimitiveData(t,e,i,s){let r,a,{iScale:n,vScale:l}=t,o=n.axis,h=l.axis,d=n.getLabels(),u=n===l,c=Array(s);for(r=0;r<s;++r)a=r+i,c[r]={[o]:u||n.parse(d[a],a),[h]:l.parse(e[a],a)};return c}parseArrayData(t,e,i,s){let r,a,n,{xScale:l,yScale:o}=t,h=Array(s);for(r=0;r<s;++r)n=e[a=r+i],h[r]={x:l.parse(n[0],a),y:o.parse(n[1],a)};return h}parseObjectData(t,e,i,s){let r,a,n,{xScale:l,yScale:o}=t,{xAxisKey:h="x",yAxisKey:d="y"}=this._parsing,u=Array(s);for(r=0;r<s;++r)n=e[a=r+i],u[r]={x:l.parse(a7(n,h),a),y:o.parse(a7(n,d),a)};return u}getParsed(t){return this._cachedMeta._parsed[t]}getDataElement(t){return this._cachedMeta.data[t]}applyStack(t,e,i){let s=this.chart,r=this._cachedMeta,a=e[t.axis];return ot({keys:l7(s,!0),values:e._stacks[t.axis]._visualValues},a,r.index,{mode:i})}updateRangeFromParsed(t,e,i,s){let r=i[e.axis],a=null===r?NaN:r,n=s&&i._stacks[e.axis];s&&n&&(s.values=n,a=ot(s,r,this._cachedMeta.index)),t.min=Math.min(t.min,a),t.max=Math.max(t.max,a)}getMinMax(t,e){let i,s,r=this._cachedMeta,a=r._parsed,n=r._sorted&&t===r.iScale,l=a.length,o=this._getOtherScale(t),h=oo(e,r,this.chart),d={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY},{min:u,max:c}=function(t){let{min:e,max:i,minDefined:s,maxDefined:r}=t.getUserBounds();return{min:s?e:Number.NEGATIVE_INFINITY,max:r?i:Number.POSITIVE_INFINITY}}(o);function f(){let e=(s=a[i])[o.axis];return!az(s[t.axis])||u>e||c<e}for(i=0;i<l&&(f()||(this.updateRangeFromParsed(d,t,s,h),!n));++i);if(n){for(i=l-1;i>=0;--i)if(!f()){this.updateRangeFromParsed(d,t,s,h);break}}return d}getAllParsedValues(t){let e,i,s,r=this._cachedMeta._parsed,a=[];for(e=0,i=r.length;e<i;++e)az(s=r[e][t.axis])&&a.push(s);return a}getMaxOverflow(){return!1}getLabelAndValue(t){let e=this._cachedMeta,i=e.iScale,s=e.vScale,r=this.getParsed(t);return{label:i?""+i.getLabelForValue(r[i.axis]):"",value:s?""+s.getLabelForValue(r[s.axis]):""}}_update(t){var e;let i,s,r,a,n=this._cachedMeta;this.update(t||"default"),aj(e=aX(this.options.clip,function(t,e,i){if(!1===i)return!1;let s=l9(t,i),r=l9(e,i);return{top:r.end,right:s.end,bottom:r.start,left:s.start}}(n.xScale,n.yScale,this.getMaxOverflow())))?(i=e.top,s=e.right,r=e.bottom,a=e.left):i=s=r=a=e,n._clip={top:i,right:s,bottom:r,left:a,disabled:!1===e}}update(t){}draw(){let t,e=this._ctx,i=this.chart,s=this._cachedMeta,r=s.data||[],a=i.chartArea,n=[],l=this._drawStart||0,o=this._drawCount||r.length-l,h=this.options.drawActiveElementsOnTop;for(s.dataset&&s.dataset.draw(e,a,l,o),t=l;t<l+o;++t){let i=r[t];i.hidden||(i.active&&h?n.push(i):i.draw(e,a))}for(t=0;t<n.length;++t)n[t].draw(e,a)}getStyle(t,e){let i=e?"active":"default";return void 0===t&&this._cachedMeta.dataset?this.resolveDatasetElementOptions(i):this.resolveDataElementOptions(t||0,i)}getContext(t,e,i){var s;let r,a=this.getDataset();if(t>=0&&t<this._cachedMeta.data.length){let e=this._cachedMeta.data[t];(r=e.$context||(e.$context=lg(this.getContext(),{active:!1,dataIndex:t,parsed:void 0,raw:void 0,element:e,index:t,mode:"default",type:"data"}))).parsed=this.getParsed(t),r.raw=a.data[t],r.index=r.dataIndex=t}else(r=this.$context||(this.$context=lg(this.chart.getContext(),{active:!1,dataset:void 0,datasetIndex:s=this.index,index:s,mode:"default",type:"dataset"}))).dataset=a,r.index=r.datasetIndex=this.index;return r.active=!!e,r.mode=i,r}resolveDatasetElementOptions(t){return this._resolveElementOptions(this.datasetElementType.id,t)}resolveDataElementOptions(t,e){return this._resolveElementOptions(this.dataElementType.id,e,t)}_resolveElementOptions(t,e="default",i){let s="active"===e,r=this._cachedDataOpts,a=t+"-"+e,n=r[a],l=this.enableOptionSharing&&ne(i);if(n)return ol(n,l);let o=this.chart.config,h=o.datasetElementScopeKeys(this._type,t),d=s?[`${t}Hover`,"hover",t,""]:[t,""],u=o.getOptionScopes(this.getDataset(),h),c=Object.keys(n2.elements[t]),f=o.resolveNamedOptions(u,c,()=>this.getContext(i,s,e),d);return f.$shared&&(f.$shared=l,r[a]=Object.freeze(ol(f,l))),f}_resolveAnimations(t,e,i){let s,r=this.chart,a=this._cachedDataOpts,n=`animation-${e}`,l=a[n];if(l)return l;if(!1!==r.options.animation){let r=this.chart.config,a=r.datasetAnimationScopeKeys(this._type,e),n=r.getOptionScopes(this.getDataset(),a);s=r.createResolver(n,this.getContext(t,i,e))}let o=new l6(r,s&&s.animations);return s&&s._cacheable&&(a[n]=Object.freeze(o)),o}getSharedOptions(t){if(t.$shared)return this._sharedOptions||(this._sharedOptions=Object.assign({},t))}includeOptions(t,e){return!e||on(t)||this.chart._animationsDisabled}_getSharedOptions(t,e){let i=this.resolveDataElementOptions(t,e),s=this._sharedOptions,r=this.getSharedOptions(i),a=this.includeOptions(e,r)||r!==s;return this.updateSharedOptions(r,e,i),{sharedOptions:r,includeOptions:a}}updateElement(t,e,i,s){on(s)?Object.assign(t,i):this._resolveAnimations(e,s).update(t,i)}updateSharedOptions(t,e,i){t&&!on(e)&&this._resolveAnimations(void 0,e).update(t,i)}_setStyle(t,e,i,s){t.active=s;let r=this.getStyle(e,s);this._resolveAnimations(e,i,s).update(t,{options:!s&&this.getSharedOptions(r)||r})}removeHoverStyle(t,e,i){this._setStyle(t,i,"active",!1)}setHoverStyle(t,e,i){this._setStyle(t,i,"active",!0)}_removeDatasetHoverStyle(){let t=this._cachedMeta.dataset;t&&this._setStyle(t,void 0,"active",!1)}_setDatasetHoverStyle(){let t=this._cachedMeta.dataset;t&&this._setStyle(t,void 0,"active",!0)}_resyncElements(t){let e=this._data,i=this._cachedMeta.data;for(let[t,e,i]of this._syncList)this[t](e,i);this._syncList=[];let s=i.length,r=e.length,a=Math.min(r,s);a&&this.parse(0,a),r>s?this._insertElements(s,r-s,t):r<s&&this._removeElements(r,s-r)}_insertElements(t,e,i=!0){let s,r=this._cachedMeta,a=r.data,n=t+e,l=t=>{for(t.length+=e,s=t.length-1;s>=n;s--)t[s]=t[s-e]};for(l(a),s=t;s<n;++s)a[s]=new this.dataElementType;this._parsing&&l(r._parsed),this.parse(t,e),i&&this.updateElements(a,t,e,"reset")}updateElements(t,e,i,s){}_removeElements(t,e){let i=this._cachedMeta;if(this._parsing){let s=i._parsed.splice(t,e);i._stacked&&oa(i,s)}i.data.splice(t,e)}_sync(t){if(this._parsing)this._syncList.push(t);else{let[e,i,s]=t;this[e](i,s)}this.chart._dataChanges.push([this.index,...t])}_onDataPush(){let t=arguments.length;this._sync(["_insertElements",this.getDataset().data.length-t,t])}_onDataPop(){this._sync(["_removeElements",this._cachedMeta.data.length-1,1])}_onDataShift(){this._sync(["_removeElements",0,1])}_onDataSplice(t,e){e&&this._sync(["_removeElements",t,e]);let i=arguments.length-2;i&&this._sync(["_insertElements",t,i])}_onDataUnshift(){this._sync(["_insertElements",0,arguments.length])}}function od(t,e,i,s){return aY(t)?!function(t,e,i,s){let r=i.parse(t[0],s),a=i.parse(t[1],s),n=Math.min(r,a),l=Math.max(r,a),o=n,h=l;Math.abs(n)>Math.abs(l)&&(o=l,h=n),e[i.axis]=h,e._custom={barStart:o,barEnd:h,start:r,end:a,min:n,max:l}}(t,e,i,s):e[i.axis]=i.parse(t,s),e}function ou(t,e,i,s){let r,a,n,l,o=t.iScale,h=t.vScale,d=o.getLabels(),u=o===h,c=[];for(r=i,a=i+s;r<a;++r)l=e[r],(n={})[o.axis]=u||o.parse(d[r],r),c.push(od(l,n,h,r));return c}function oc(t){return t&&void 0!==t.barStart&&void 0!==t.barEnd}function of(t,e,i,s){var r,a,n;return t=s?og((r=t,a=e,n=i,t=r===a?n:r===n?a:r),i,e):og(t,e,i)}function og(t,e,i){return"start"===t?e:"end"===t?i:t}class op extends oh{static id="doughnut";static defaults={datasetElementType:!1,dataElementType:"arc",animation:{animateRotate:!0,animateScale:!1},animations:{numbers:{type:"number",properties:["circumference","endAngle","innerRadius","outerRadius","startAngle","x","y","offset","borderWidth","spacing"]}},cutout:"50%",rotation:0,circumference:360,radius:"100%",spacing:0,indexAxis:"r"};static descriptors={_scriptable:t=>"spacing"!==t,_indexable:t=>"spacing"!==t&&!t.startsWith("borderDash")&&!t.startsWith("hoverBorderDash")};static overrides={aspectRatio:1,plugins:{legend:{labels:{generateLabels(t){let e=t.data;if(e.labels.length&&e.datasets.length){let{labels:{pointStyle:i,color:s}}=t.legend.options;return e.labels.map((e,r)=>{let a=t.getDatasetMeta(0).controller.getStyle(r);return{text:e,fillStyle:a.backgroundColor,strokeStyle:a.borderColor,fontColor:s,lineWidth:a.borderWidth,pointStyle:i,hidden:!t.getDataVisibility(r),index:r}})}return[]}},onClick(t,e,i){i.chart.toggleDataVisibility(e.index),i.chart.update()}}}};constructor(t,e){super(t,e),this.enableOptionSharing=!0,this.innerRadius=void 0,this.outerRadius=void 0,this.offsetX=void 0,this.offsetY=void 0}linkScales(){}parse(t,e){let i=this.getDataset().data,s=this._cachedMeta;if(!1===this._parsing)s._parsed=i;else{let r,a,n=t=>+i[t];if(aj(i[t])){let{key:t="value"}=this._parsing;n=e=>+a7(i[e],t)}for(r=t,a=t+e;r<a;++r)s._parsed[r]=n(r)}}_getRotation(){return nv(this.options.rotation-90)}_getCircumference(){return nv(this.options.circumference)}_getRotationExtents(){let t=na,e=-na;for(let i=0;i<this.chart.data.datasets.length;++i)if(this.chart.isDatasetVisible(i)&&this.chart.getDatasetMeta(i).type===this._type){let s=this.chart.getDatasetMeta(i).controller,r=s._getRotation(),a=s._getCircumference();t=Math.min(t,r),e=Math.max(e,r+a)}return{rotation:t,circumference:e-t}}update(t){let{chartArea:e}=this.chart,i=this._cachedMeta,s=i.data,r=this.getMaxBorderWidth()+this.getMaxOffset(s)+this.options.spacing,a=Math.max((Math.min(e.width,e.height)-r)/2,0),n=Math.min(aQ(this.options.cutout,a),1),l=this._getRingWeight(this.index),{circumference:o,rotation:h}=this._getRotationExtents(),{ratioX:d,ratioY:u,offsetX:c,offsetY:f}=function(t,e,i){let s=1,r=1,a=0,n=0;if(e<na){let l=t+e,o=Math.cos(t),h=Math.sin(t),d=Math.cos(l),u=Math.sin(l),c=(e,s,r)=>n_(e,t,l,!0)?1:Math.max(s,s*i,r,r*i),f=(e,s,r)=>n_(e,t,l,!0)?-1:Math.min(s,s*i,r,r*i),g=c(0,o,d),p=c(nh,h,u),m=f(nr,o,d),y=f(nr+nh,h,u);s=(g-m)/2,r=(p-y)/2,a=-(g+m)/2,n=-(p+y)/2}return{ratioX:s,ratioY:r,offsetX:a,offsetY:n}}(h,o,n),g=Math.max(Math.min((e.width-r)/d,(e.height-r)/u)/2,0),p=aZ(this.options.radius,g),m=Math.max(p*n,0),y=(p-m)/this._getVisibleDatasetWeightTotal();this.offsetX=c*p,this.offsetY=f*p,i.total=this.calculateTotal(),this.outerRadius=p-y*this._getRingWeightOffset(this.index),this.innerRadius=Math.max(this.outerRadius-y*l,0),this.updateElements(s,0,s.length,t)}_circumference(t,e){let i=this.options,s=this._cachedMeta,r=this._getCircumference();return e&&i.animation.animateRotate||!this.chart.getDataVisibility(t)||null===s._parsed[t]||s.data[t].hidden?0:this.calculateCircumference(s._parsed[t]*r/na)}updateElements(t,e,i,s){let r,a="reset"===s,n=this.chart,l=n.chartArea,o=n.options.animation,h=(l.left+l.right)/2,d=(l.top+l.bottom)/2,u=a&&o.animateScale,c=u?0:this.innerRadius,f=u?0:this.outerRadius,{sharedOptions:g,includeOptions:p}=this._getSharedOptions(e,s),m=this._getRotation();for(r=0;r<e;++r)m+=this._circumference(r,a);for(r=e;r<e+i;++r){let e=this._circumference(r,a),i=t[r],n={x:h+this.offsetX,y:d+this.offsetY,startAngle:m,endAngle:m+e,circumference:e,outerRadius:f,innerRadius:c};p&&(n.options=g||this.resolveDataElementOptions(r,i.active?"active":s)),m+=e,this.updateElement(i,r,n,s)}}calculateTotal(){let t,e=this._cachedMeta,i=e.data,s=0;for(t=0;t<i.length;t++){let r=e._parsed[t];null!==r&&!isNaN(r)&&this.chart.getDataVisibility(t)&&!i[t].hidden&&(s+=Math.abs(r))}return s}calculateCircumference(t){let e=this._cachedMeta.total;return e>0&&!isNaN(t)?Math.abs(t)/e*na:0}getLabelAndValue(t){let e=this._cachedMeta,i=this.chart,s=i.data.labels||[],r=nX(e._parsed[t],i.options.locale);return{label:s[t]||"",value:r}}getMaxBorderWidth(t){let e,i,s,r,a,n=0,l=this.chart;if(!t){for(e=0,i=l.data.datasets.length;e<i;++e)if(l.isDatasetVisible(e)){t=(s=l.getDatasetMeta(e)).data,r=s.controller;break}}if(!t)return 0;for(e=0,i=t.length;e<i;++e)"inner"!==(a=r.resolveDataElementOptions(e)).borderAlign&&(n=Math.max(n,a.borderWidth||0,a.hoverBorderWidth||0));return n}getMaxOffset(t){let e=0;for(let i=0,s=t.length;i<s;++i){let t=this.resolveDataElementOptions(i);e=Math.max(e,t.offset||0,t.hoverOffset||0)}return e}_getRingWeightOffset(t){let e=0;for(let i=0;i<t;++i)this.chart.isDatasetVisible(i)&&(e+=this._getRingWeight(i));return e}_getRingWeight(t){return Math.max(aX(this.chart.data.datasets[t].weight,1),0)}_getVisibleDatasetWeightTotal(){return this._getRingWeightOffset(this.chart.data.datasets.length)||1}}class om extends oh{static id="polarArea";static defaults={dataElementType:"arc",animation:{animateRotate:!0,animateScale:!0},animations:{numbers:{type:"number",properties:["x","y","startAngle","endAngle","innerRadius","outerRadius"]}},indexAxis:"r",startAngle:0};static overrides={aspectRatio:1,plugins:{legend:{labels:{generateLabels(t){let e=t.data;if(e.labels.length&&e.datasets.length){let{labels:{pointStyle:i,color:s}}=t.legend.options;return e.labels.map((e,r)=>{let a=t.getDatasetMeta(0).controller.getStyle(r);return{text:e,fillStyle:a.backgroundColor,strokeStyle:a.borderColor,fontColor:s,lineWidth:a.borderWidth,pointStyle:i,hidden:!t.getDataVisibility(r),index:r}})}return[]}},onClick(t,e,i){i.chart.toggleDataVisibility(e.index),i.chart.update()}}},scales:{r:{type:"radialLinear",angleLines:{display:!1},beginAtZero:!0,grid:{circular:!0},pointLabels:{display:!1},startAngle:0}}};constructor(t,e){super(t,e),this.innerRadius=void 0,this.outerRadius=void 0}getLabelAndValue(t){let e=this._cachedMeta,i=this.chart,s=i.data.labels||[],r=nX(e._parsed[t].r,i.options.locale);return{label:s[t]||"",value:r}}parseObjectData(t,e,i,s){return lL.bind(this)(t,e,i,s)}update(t){let e=this._cachedMeta.data;this._updateRadius(),this.updateElements(e,0,e.length,t)}getMinMax(){let t=this._cachedMeta,e={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};return t.data.forEach((t,i)=>{let s=this.getParsed(i).r;!isNaN(s)&&this.chart.getDataVisibility(i)&&(s<e.min&&(e.min=s),s>e.max&&(e.max=s))}),e}_updateRadius(){let t=this.chart,e=t.chartArea,i=t.options,s=Math.max(Math.min(e.right-e.left,e.bottom-e.top)/2,0),r=Math.max(i.cutoutPercentage?s/100*i.cutoutPercentage:1,0),a=(s-r)/t.getVisibleDatasetCount();this.outerRadius=s-a*this.index,this.innerRadius=this.outerRadius-a}updateElements(t,e,i,s){let r,a="reset"===s,n=this.chart,l=n.options.animation,o=this._cachedMeta.rScale,h=o.xCenter,d=o.yCenter,u=o.getIndexAngle(0)-.5*nr,c=u,f=360/this.countVisibleElements();for(r=0;r<e;++r)c+=this._computeAngle(r,s,f);for(r=e;r<e+i;r++){let e=t[r],i=c,g=c+this._computeAngle(r,s,f),p=n.getDataVisibility(r)?o.getDistanceFromCenterForValue(this.getParsed(r).r):0;c=g,a&&(l.animateScale&&(p=0),l.animateRotate&&(i=g=u));let m={x:h,y:d,innerRadius:0,outerRadius:p,startAngle:i,endAngle:g,options:this.resolveDataElementOptions(r,e.active?"active":s)};this.updateElement(e,r,m,s)}}countVisibleElements(){let t=this._cachedMeta,e=0;return t.data.forEach((t,i)=>{!isNaN(this.getParsed(i).r)&&this.chart.getDataVisibility(i)&&e++}),e}_computeAngle(t,e,i){return this.chart.getDataVisibility(t)?nv(this.resolveDataElementOptions(t,e).angle||i):0}}var oy=Object.freeze({__proto__:null,BarController:class extends oh{static id="bar";static defaults={datasetElementType:!1,dataElementType:"bar",categoryPercentage:.8,barPercentage:.9,grouped:!0,animations:{numbers:{type:"number",properties:["x","y","base","width","height"]}}};static overrides={scales:{_index_:{type:"category",offset:!0,grid:{offset:!0}},_value_:{type:"linear",beginAtZero:!0}}};parsePrimitiveData(t,e,i,s){return ou(t,e,i,s)}parseArrayData(t,e,i,s){return ou(t,e,i,s)}parseObjectData(t,e,i,s){let r,a,n,l,{iScale:o,vScale:h}=t,{xAxisKey:d="x",yAxisKey:u="y"}=this._parsing,c="x"===o.axis?d:u,f="x"===h.axis?d:u,g=[];for(r=i,a=i+s;r<a;++r)l=e[r],(n={})[o.axis]=o.parse(a7(l,c),r),g.push(od(a7(l,f),n,h,r));return g}updateRangeFromParsed(t,e,i,s){super.updateRangeFromParsed(t,e,i,s);let r=i._custom;r&&e===this._cachedMeta.vScale&&(t.min=Math.min(t.min,r.min),t.max=Math.max(t.max,r.max))}getMaxOverflow(){return 0}getLabelAndValue(t){let{iScale:e,vScale:i}=this._cachedMeta,s=this.getParsed(t),r=s._custom,a=oc(r)?"["+r.start+", "+r.end+"]":""+i.getLabelForValue(s[i.axis]);return{label:""+e.getLabelForValue(s[e.axis]),value:a}}initialize(){this.enableOptionSharing=!0,super.initialize(),this._cachedMeta.stack=this.getDataset().stack}update(t){let e=this._cachedMeta;this.updateElements(e.data,0,e.data.length,t)}updateElements(t,e,i,s){let r="reset"===s,{index:a,_cachedMeta:{vScale:n}}=this,l=n.getBasePixel(),o=n.isHorizontal(),h=this._getRuler(),{sharedOptions:d,includeOptions:u}=this._getSharedOptions(e,s);for(let c=e;c<e+i;c++){let e=this.getParsed(c),i=r||aW(e[n.axis])?{base:l,head:l}:this._calculateBarValuePixels(c),f=this._calculateBarIndexPixels(c,h),g=(e._stacks||{})[n.axis],p={horizontal:o,base:i.base,enableBorderRadius:!g||oc(e._custom)||a===g._top||a===g._bottom,x:o?i.head:f.center,y:o?f.center:i.head,height:o?f.size:Math.abs(i.size),width:o?Math.abs(i.size):f.size};u&&(p.options=d||this.resolveDataElementOptions(c,t[c].active?"active":s));let m=p.options||t[c].options;!function(t,e,i,s){let r,a,n,l,o,h=e.borderSkipped,d={};if(!h){t.borderSkipped=d;return}if(!0===h){t.borderSkipped={top:!0,right:!0,bottom:!0,left:!0};return}let{start:u,end:c,reverse:f,top:g,bottom:p}=(t.horizontal?(r=t.base>t.x,a="left",n="right"):(r=t.base<t.y,a="bottom",n="top"),r?(l="end",o="start"):(l="start",o="end"),{start:a,end:n,reverse:r,top:l,bottom:o});"middle"===h&&i&&(t.enableBorderRadius=!0,(i._top||0)===s?h=g:(i._bottom||0)===s?h=p:(d[of(p,u,c,f)]=!0,h=g)),d[of(h,u,c,f)]=!0,t.borderSkipped=d}(p,m,g,a),function(t,{inflateAmount:e},i){t.inflateAmount="auto"===e?.33*(1===i):e}(p,m,h.ratio),this.updateElement(t[c],c,p,s)}}_getStacks(t,e){let{iScale:i}=this._cachedMeta,s=i.getMatchingVisibleMetas(this._type).filter(t=>t.controller.options.grouped),r=i.options.stacked,a=[],n=this._cachedMeta.controller.getParsed(e),l=n&&n[i.axis],o=t=>{let e=t._parsed.find(t=>t[i.axis]===l),s=e&&e[t.vScale.axis];if(aW(s)||isNaN(s))return!0};for(let i of s)if(!(void 0!==e&&o(i))&&((!1===r||-1===a.indexOf(i.stack)||void 0===r&&void 0===i.stack)&&a.push(i.stack),i.index===t))break;return a.length||a.push(void 0),a}_getStackCount(t){return this._getStacks(void 0,t).length}_getStackIndex(t,e,i){let s=this._getStacks(t,i),r=void 0!==e?s.indexOf(e):-1;return -1===r?s.length-1:r}_getRuler(){let t,e,i=this.options,s=this._cachedMeta,r=s.iScale,a=[];for(t=0,e=s.data.length;t<e;++t)a.push(r.getPixelForValue(this.getParsed(t)[r.axis],t));let n=i.barThickness;return{min:n||function(t){let e,i,s,r,a=t.iScale,n=function(t,e){if(!t._cache.$bar){let i=t.getMatchingVisibleMetas(e),s=[];for(let e=0,r=i.length;e<r;e++)s=s.concat(i[e].controller.getAllParsedValues(t));t._cache.$bar=nC(s.sort((t,e)=>t-e))}return t._cache.$bar}(a,t.type),l=a._length,o=()=>{32767!==s&&-32768!==s&&(ne(r)&&(l=Math.min(l,Math.abs(s-r)||l)),r=s)};for(e=0,i=n.length;e<i;++e)s=a.getPixelForValue(n[e]),o();for(e=0,r=void 0,i=a.ticks.length;e<i;++e)s=a.getPixelForTick(e),o();return l}(s),pixels:a,start:r._startPixel,end:r._endPixel,stackCount:this._getStackCount(),scale:r,grouped:i.grouped,ratio:n?1:i.categoryPercentage*i.barPercentage}}_calculateBarValuePixels(t){let e,i,{_cachedMeta:{vScale:s,_stacked:r,index:a},options:{base:n,minBarLength:l}}=this,o=n||0,h=this.getParsed(t),d=h._custom,u=oc(d),c=h[s.axis],f=0,g=r?this.applyStack(s,h,r):c;g!==c&&(f=g-c,g=c),u&&(c=d.barStart,g=d.barEnd-d.barStart,0!==c&&nf(c)!==nf(d.barEnd)&&(f=0),f+=c);let p=aW(n)||u?f:n,m=s.getPixelForValue(p);if(Math.abs(i=(e=this.chart.getDataVisibility(t)?s.getPixelForValue(f+g):m)-m)<l){var y;i=(0!==(y=i)?nf(y):(s.isHorizontal()?1:-1)*(s.min>=o?1:-1))*l,c===o&&(m-=i/2);let t=s.getPixelForDecimal(0),n=s.getPixelForDecimal(1),d=Math.min(t,n);e=(m=Math.max(Math.min(m,Math.max(t,n)),d))+i,r&&!u&&(h._stacks[s.axis]._visualValues[a]=s.getValueForPixel(e)-s.getValueForPixel(m))}if(m===s.getPixelForValue(o)){let t=nf(i)*s.getLineWidthForValue(o)/2;m+=t,i-=t}return{size:i,base:m,head:e,center:e+i/2}}_calculateBarIndexPixels(t,e){let i,s,r=e.scale,a=this.options,n=a.skipNull,l=aX(a.maxBarThickness,1/0);if(e.grouped){let r=n?this._getStackCount(t):e.stackCount,o="flex"===a.barThickness?function(t,e,i,s){let r=e.pixels,a=r[t],n=t>0?r[t-1]:null,l=t<r.length-1?r[t+1]:null,o=i.categoryPercentage;null===n&&(n=a-(null===l?e.end-e.start:l-a)),null===l&&(l=a+a-n);let h=a-(a-Math.min(n,l))/2*o;return{chunk:Math.abs(l-n)/2*o/s,ratio:i.barPercentage,start:h}}(t,e,a,r):function(t,e,i,s){let r,a,n=i.barThickness;return aW(n)?(r=e.min*i.categoryPercentage,a=i.barPercentage):(r=n*s,a=1),{chunk:r/s,ratio:a,start:e.pixels[t]-r/2}}(t,e,a,r),h=this._getStackIndex(this.index,this._cachedMeta.stack,n?t:void 0);i=o.start+o.chunk*h+o.chunk/2,s=Math.min(l,o.chunk*o.ratio)}else i=r.getPixelForValue(this.getParsed(t)[r.axis],t),s=Math.min(l,e.min*e.ratio);return{base:i-s/2,head:i+s/2,center:i,size:s}}draw(){let t=this._cachedMeta,e=t.vScale,i=t.data,s=i.length,r=0;for(;r<s;++r)null===this.getParsed(r)[e.axis]||i[r].hidden||i[r].draw(this._ctx)}},BubbleController:class extends oh{static id="bubble";static defaults={datasetElementType:!1,dataElementType:"point",animations:{numbers:{type:"number",properties:["x","y","borderWidth","radius"]}}};static overrides={scales:{x:{type:"linear"},y:{type:"linear"}}};initialize(){this.enableOptionSharing=!0,super.initialize()}parsePrimitiveData(t,e,i,s){let r=super.parsePrimitiveData(t,e,i,s);for(let t=0;t<r.length;t++)r[t]._custom=this.resolveDataElementOptions(t+i).radius;return r}parseArrayData(t,e,i,s){let r=super.parseArrayData(t,e,i,s);for(let t=0;t<r.length;t++){let s=e[i+t];r[t]._custom=aX(s[2],this.resolveDataElementOptions(t+i).radius)}return r}parseObjectData(t,e,i,s){let r=super.parseObjectData(t,e,i,s);for(let t=0;t<r.length;t++){let s=e[i+t];r[t]._custom=aX(s&&s.r&&+s.r,this.resolveDataElementOptions(t+i).radius)}return r}getMaxOverflow(){let t=this._cachedMeta.data,e=0;for(let i=t.length-1;i>=0;--i)e=Math.max(e,t[i].size(this.resolveDataElementOptions(i))/2);return e>0&&e}getLabelAndValue(t){let e=this._cachedMeta,i=this.chart.data.labels||[],{xScale:s,yScale:r}=e,a=this.getParsed(t),n=s.getLabelForValue(a.x),l=r.getLabelForValue(a.y),o=a._custom;return{label:i[t]||"",value:"("+n+", "+l+(o?", "+o:"")+")"}}update(t){let e=this._cachedMeta.data;this.updateElements(e,0,e.length,t)}updateElements(t,e,i,s){let r="reset"===s,{iScale:a,vScale:n}=this._cachedMeta,{sharedOptions:l,includeOptions:o}=this._getSharedOptions(e,s),h=a.axis,d=n.axis;for(let u=e;u<e+i;u++){let e=t[u],i=!r&&this.getParsed(u),c={},f=c[h]=r?a.getPixelForDecimal(.5):a.getPixelForValue(i[h]),g=c[d]=r?n.getBasePixel():n.getPixelForValue(i[d]);c.skip=isNaN(f)||isNaN(g),o&&(c.options=l||this.resolveDataElementOptions(u,e.active?"active":s),r&&(c.options.radius=0)),this.updateElement(e,u,c,s)}}resolveDataElementOptions(t,e){let i=this.getParsed(t),s=super.resolveDataElementOptions(t,e);s.$shared&&(s=Object.assign({},s,{$shared:!1}));let r=s.radius;return"active"!==e&&(s.radius=0),s.radius+=aX(i&&i._custom,r),s}},DoughnutController:op,LineController:class extends oh{static id="line";static defaults={datasetElementType:"line",dataElementType:"point",showLine:!0,spanGaps:!1};static overrides={scales:{_index_:{type:"category"},_value_:{type:"linear"}}};initialize(){this.enableOptionSharing=!0,this.supportsDecimation=!0,super.initialize()}update(t){let e=this._cachedMeta,{dataset:i,data:s=[],_dataset:r}=e,a=this.chart._animationsDisabled,{start:n,count:l}=nB(e,s,a);this._drawStart=n,this._drawCount=l,nU(e)&&(n=0,l=s.length),i._chart=this.chart,i._datasetIndex=this.index,i._decimated=!!r._decimated,i.points=s;let o=this.resolveDatasetElementOptions(t);this.options.showLine||(o.borderWidth=0),o.segment=this.options.segment,this.updateElement(i,void 0,{animated:!a,options:o},t),this.updateElements(s,n,l,t)}updateElements(t,e,i,s){let r="reset"===s,{iScale:a,vScale:n,_stacked:l,_dataset:o}=this._cachedMeta,{sharedOptions:h,includeOptions:d}=this._getSharedOptions(e,s),u=a.axis,c=n.axis,{spanGaps:f,segment:g}=this.options,p=nm(f)?f:Number.POSITIVE_INFINITY,m=this.chart._animationsDisabled||r||"none"===s,y=e+i,v=t.length,E=e>0&&this.getParsed(e-1);for(let i=0;i<v;++i){let f=t[i],v=m?f:{};if(i<e||i>=y){v.skip=!0;continue}let T=this.getParsed(i),b=aW(T[c]),S=v[u]=a.getPixelForValue(T[u],i),A=v[c]=r||b?n.getBasePixel():n.getPixelForValue(l?this.applyStack(n,T,l):T[c],i);v.skip=isNaN(S)||isNaN(A)||b,v.stop=i>0&&Math.abs(T[u]-E[u])>p,g&&(v.parsed=T,v.raw=o.data[i]),d&&(v.options=h||this.resolveDataElementOptions(i,f.active?"active":s)),m||this.updateElement(f,i,v,s),E=T}}getMaxOverflow(){let t=this._cachedMeta,e=t.dataset,i=e.options&&e.options.borderWidth||0,s=t.data||[];return s.length?Math.max(i,s[0].size(this.resolveDataElementOptions(0)),s[s.length-1].size(this.resolveDataElementOptions(s.length-1)))/2:i}draw(){let t=this._cachedMeta;t.dataset.updateControlPoints(this.chart.chartArea,t.iScale.axis),super.draw()}},PieController:class extends op{static id="pie";static defaults={cutout:0,rotation:0,circumference:360,radius:"100%"}},PolarAreaController:om,RadarController:class extends oh{static id="radar";static defaults={datasetElementType:"line",dataElementType:"point",indexAxis:"r",showLine:!0,elements:{line:{fill:"start"}}};static overrides={aspectRatio:1,scales:{r:{type:"radialLinear"}}};getLabelAndValue(t){let e=this._cachedMeta.vScale,i=this.getParsed(t);return{label:e.getLabels()[t],value:""+e.getLabelForValue(i[e.axis])}}parseObjectData(t,e,i,s){return lL.bind(this)(t,e,i,s)}update(t){let e=this._cachedMeta,i=e.dataset,s=e.data||[],r=e.iScale.getLabels();if(i.points=s,"resize"!==t){let e=this.resolveDatasetElementOptions(t);this.options.showLine||(e.borderWidth=0);let a={_loop:!0,_fullLoop:r.length===s.length,options:e};this.updateElement(i,void 0,a,t)}this.updateElements(s,0,s.length,t)}updateElements(t,e,i,s){let r=this._cachedMeta.rScale,a="reset"===s;for(let n=e;n<e+i;n++){let e=t[n],i=this.resolveDataElementOptions(n,e.active?"active":s),l=r.getPointPositionForValue(n,this.getParsed(n).r),o=a?r.xCenter:l.x,h=a?r.yCenter:l.y,d={x:o,y:h,angle:l.angle,skip:isNaN(o)||isNaN(h),options:i};this.updateElement(e,n,d,s)}}},ScatterController:class extends oh{static id="scatter";static defaults={datasetElementType:!1,dataElementType:"point",showLine:!1,fill:!1};static overrides={interaction:{mode:"point"},scales:{x:{type:"linear"},y:{type:"linear"}}};getLabelAndValue(t){let e=this._cachedMeta,i=this.chart.data.labels||[],{xScale:s,yScale:r}=e,a=this.getParsed(t),n=s.getLabelForValue(a.x),l=r.getLabelForValue(a.y);return{label:i[t]||"",value:"("+n+", "+l+")"}}update(t){let e=this._cachedMeta,{data:i=[]}=e,s=this.chart._animationsDisabled,{start:r,count:a}=nB(e,i,s);if(this._drawStart=r,this._drawCount=a,nU(e)&&(r=0,a=i.length),this.options.showLine){this.datasetElementType||this.addElements();let{dataset:r,_dataset:a}=e;r._chart=this.chart,r._datasetIndex=this.index,r._decimated=!!a._decimated,r.points=i;let n=this.resolveDatasetElementOptions(t);n.segment=this.options.segment,this.updateElement(r,void 0,{animated:!s,options:n},t)}else this.datasetElementType&&(delete e.dataset,this.datasetElementType=!1);this.updateElements(i,r,a,t)}addElements(){let{showLine:t}=this.options;!this.datasetElementType&&t&&(this.datasetElementType=this.chart.registry.getElement("line")),super.addElements()}updateElements(t,e,i,s){let r="reset"===s,{iScale:a,vScale:n,_stacked:l,_dataset:o}=this._cachedMeta,h=this.resolveDataElementOptions(e,s),d=this.getSharedOptions(h),u=this.includeOptions(s,d),c=a.axis,f=n.axis,{spanGaps:g,segment:p}=this.options,m=nm(g)?g:Number.POSITIVE_INFINITY,y=this.chart._animationsDisabled||r||"none"===s,v=e>0&&this.getParsed(e-1);for(let h=e;h<e+i;++h){let e=t[h],i=this.getParsed(h),g=y?e:{},E=aW(i[f]),T=g[c]=a.getPixelForValue(i[c],h),b=g[f]=r||E?n.getBasePixel():n.getPixelForValue(l?this.applyStack(n,i,l):i[f],h);g.skip=isNaN(T)||isNaN(b)||E,g.stop=h>0&&Math.abs(i[c]-v[c])>m,p&&(g.parsed=i,g.raw=o.data[h]),u&&(g.options=d||this.resolveDataElementOptions(h,e.active?"active":s)),y||this.updateElement(e,h,g,s),v=i}this.updateSharedOptions(d,s,h)}getMaxOverflow(){let t=this._cachedMeta,e=t.data||[];if(!this.options.showLine){let t=0;for(let i=e.length-1;i>=0;--i)t=Math.max(t,e[i].size(this.resolveDataElementOptions(i))/2);return t>0&&t}let i=t.dataset,s=i.options&&i.options.borderWidth||0;return e.length?Math.max(s,e[0].size(this.resolveDataElementOptions(0)),e[e.length-1].size(this.resolveDataElementOptions(e.length-1)))/2:s}}});function ov(){throw Error("This method is not implemented: Check that a complete date adapter is provided.")}class oE{static override(t){Object.assign(oE.prototype,t)}options;constructor(t){this.options=t||{}}init(){}formats(){return ov()}parse(){return ov()}format(){return ov()}add(){return ov()}diff(){return ov()}startOf(){return ov()}endOf(){return ov()}}function oT(t,e,i,s,r){let a=t.getSortedVisibleDatasetMetas(),n=i[e];for(let t=0,i=a.length;t<i;++t){let{index:i,data:l}=a[t],{lo:o,hi:h}=function(t,e,i,s){let{controller:r,data:a,_sorted:n}=t,l=r._cachedMeta.iScale,o=t.dataset&&t.dataset.options?t.dataset.options.spanGaps:null;if(l&&e===l.axis&&"r"!==e&&n&&a.length){let n=l._reversePixels?nD:nR;if(s){if(r._sharedOptions){let t=a[0],s="function"==typeof t.getRange&&t.getRange(e);if(s){let t=n(a,e,i-s),r=n(a,e,i+s);return{lo:t.lo,hi:r.hi}}}}else{let s=n(a,e,i);if(o){let{vScale:e}=r._cachedMeta,{_parsed:i}=t,a=i.slice(0,s.lo+1).reverse().findIndex(t=>!aW(t[e.axis]));s.lo-=Math.max(0,a);let n=i.slice(s.hi).findIndex(t=>!aW(t[e.axis]));s.hi+=Math.max(0,n)}return s}}return{lo:0,hi:a.length-1}}(a[t],e,n,r);for(let t=o;t<=h;++t){let e=l[t];e.skip||s(e,i,t)}}}function ob(t,e,i,s,r){let a=[];return(r||t.isPointInArea(e))&&oT(t,i,e,function(i,n,l){(r||n9(i,t.chartArea,0))&&i.inRange(e.x,e.y,s)&&a.push({element:i,datasetIndex:n,index:l})},!0),a}function oS(t,e,i,s,r,a){let n;return a||t.isPointInArea(e)?"r"!==i||s?function(t,e,i,s,r,a){let n=[],l=function(t){let e=-1!==t.indexOf("x"),i=-1!==t.indexOf("y");return function(t,s){return Math.sqrt(Math.pow(e?Math.abs(t.x-s.x):0,2)+Math.pow(i?Math.abs(t.y-s.y):0,2))}}(i),o=Number.POSITIVE_INFINITY;return oT(t,i,e,function(i,h,d){let u=i.inRange(e.x,e.y,r);if(s&&!u)return;let c=i.getCenterPoint(r);if(!(a||t.isPointInArea(c))&&!u)return;let f=l(e,c);f<o?(n=[{element:i,datasetIndex:h,index:d}],o=f):f===o&&n.push({element:i,datasetIndex:h,index:d})}),n}(t,e,i,s,r,a):(n=[],oT(t,i,e,function(t,i,s){let{startAngle:a,endAngle:l}=t.getProps(["startAngle","endAngle"],r),{angle:o}=nT(t,{x:e.x,y:e.y});n_(o,a,l)&&n.push({element:t,datasetIndex:i,index:s})}),n):[]}function oA(t,e,i,s,r){let a=[],n="x"===i?"inXRange":"inYRange",l=!1;return(oT(t,i,e,(t,s,o)=>{t[n]&&t[n](e[i],r)&&(a.push({element:t,datasetIndex:s,index:o}),l=l||t.inRange(e.x,e.y,r))}),s&&!l)?[]:a}var o_={modes:{index(t,e,i,s){let r=lB(e,t),a=i.axis||"x",n=i.includeInvisible||!1,l=i.intersect?ob(t,r,a,s,n):oS(t,r,a,!1,s,n),o=[];return l.length?(t.getSortedVisibleDatasetMetas().forEach(t=>{let e=l[0].index,i=t.data[e];i&&!i.skip&&o.push({element:i,datasetIndex:t.index,index:e})}),o):[]},dataset(t,e,i,s){let r=lB(e,t),a=i.axis||"xy",n=i.includeInvisible||!1,l=i.intersect?ob(t,r,a,s,n):oS(t,r,a,!1,s,n);if(l.length>0){let e=l[0].datasetIndex,i=t.getDatasetMeta(e).data;l=[];for(let t=0;t<i.length;++t)l.push({element:i[t],datasetIndex:e,index:t})}return l},point(t,e,i,s){let r=lB(e,t);return ob(t,r,i.axis||"xy",s,i.includeInvisible||!1)},nearest(t,e,i,s){let r=lB(e,t),a=i.axis||"xy",n=i.includeInvisible||!1;return oS(t,r,a,i.intersect,s,n)},x(t,e,i,s){let r=lB(e,t);return oA(t,r,"x",i.intersect,s)},y(t,e,i,s){let r=lB(e,t);return oA(t,r,"y",i.intersect,s)}}};const ox=["left","top","right","bottom"];function oL(t,e){return t.filter(t=>t.pos===e)}function oI(t,e){return t.filter(t=>-1===ox.indexOf(t.pos)&&t.box.axis===e)}function oR(t,e){return t.sort((t,i)=>{let s=e?i:t,r=e?t:i;return s.weight===r.weight?s.index-r.index:s.weight-r.weight})}function oD(t,e,i,s){return Math.max(t[i],e[i])+Math.max(t[s],e[s])}function ok(t,e){t.top=Math.max(t.top,e.top),t.left=Math.max(t.left,e.left),t.bottom=Math.max(t.bottom,e.bottom),t.right=Math.max(t.right,e.right)}function oP(t,e,i,s){let r,a,n,l,o,h,d=[];for(r=0,a=t.length,o=0;r<a;++r){(l=(n=t[r]).box).update(n.width||e.w,n.height||e.h,function(t,e){let i=e.maxPadding;var s=t?["left","right"]:["top","bottom"];let r={left:0,top:0,right:0,bottom:0};return s.forEach(t=>{r[t]=Math.max(e[t],i[t])}),r}(n.horizontal,e));let{same:a,other:u}=function(t,e,i,s){let{pos:r,box:a}=i,n=t.maxPadding;if(!aj(r)){i.size&&(t[r]-=i.size);let e=s[i.stack]||{size:0,count:1};e.size=Math.max(e.size,i.horizontal?a.height:a.width),i.size=e.size/e.count,t[r]+=i.size}a.getPadding&&ok(n,a.getPadding());let l=Math.max(0,e.outerWidth-oD(n,t,"left","right")),o=Math.max(0,e.outerHeight-oD(n,t,"top","bottom")),h=l!==t.w,d=o!==t.h;return t.w=l,t.h=o,i.horizontal?{same:h,other:d}:{same:d,other:h}}(e,i,n,s);o|=a&&d.length,h=h||u,l.fullSize||d.push(n)}return o&&oP(d,e,i,s)||h}function oC(t,e,i,s,r){t.top=i,t.left=e,t.right=e+s,t.bottom=i+r,t.width=s,t.height=r}function oM(t,e,i,s){let r=i.padding,{x:a,y:n}=e;for(let l of t){let t=l.box,o=s[l.stack]||{count:1,placed:0,weight:1},h=l.stackWeight/o.weight||1;if(l.horizontal){let s=e.w*h,a=o.size||t.height;ne(o.start)&&(n=o.start),t.fullSize?oC(t,r.left,n,i.outerWidth-r.right-r.left,a):oC(t,e.left+o.placed,n,s,a),o.start=n,o.placed+=s,n=t.bottom}else{let s=e.h*h,n=o.size||t.width;ne(o.start)&&(a=o.start),t.fullSize?oC(t,a,r.top,n,i.outerHeight-r.bottom-r.top):oC(t,a,e.top+o.placed,n,s),o.start=a,o.placed+=s,a=t.right}}e.x=a,e.y=n}var ow={addBox(t,e){t.boxes||(t.boxes=[]),e.fullSize=e.fullSize||!1,e.position=e.position||"top",e.weight=e.weight||0,e._layers=e._layers||function(){return[{z:0,draw(t){e.draw(t)}}]},t.boxes.push(e)},removeBox(t,e){let i=t.boxes?t.boxes.indexOf(e):-1;-1!==i&&t.boxes.splice(i,1)},configure(t,e,i){e.fullSize=i.fullSize,e.position=i.position,e.weight=i.weight},update(t,e,i,s){if(!t)return;let r=lu(t.options.layout.padding),a=Math.max(e-r.width,0),n=Math.max(i-r.height,0),l=function(t){let e=function(t){let e,i,s,r,a,n,l=[];for(e=0,i=(t||[]).length;e<i;++e)s=t[e],({position:r,options:{stack:a,stackWeight:n=1}}=s),l.push({index:e,box:s,pos:r,horizontal:s.isHorizontal(),weight:s.weight,stack:a&&r+a,stackWeight:n});return l}(t),i=oR(e.filter(t=>t.box.fullSize),!0),s=oR(oL(e,"left"),!0),r=oR(oL(e,"right")),a=oR(oL(e,"top"),!0),n=oR(oL(e,"bottom")),l=oI(e,"x"),o=oI(e,"y");return{fullSize:i,leftAndTop:s.concat(a),rightAndBottom:r.concat(o).concat(n).concat(l),chartArea:oL(e,"chartArea"),vertical:s.concat(r).concat(o),horizontal:a.concat(n).concat(l)}}(t.boxes),o=l.vertical,h=l.horizontal;a0(t.boxes,t=>{"function"==typeof t.beforeLayout&&t.beforeLayout()});let d=Object.freeze({outerWidth:e,outerHeight:i,padding:r,availableWidth:a,availableHeight:n,vBoxMaxWidth:a/2/(o.reduce((t,e)=>e.box.options&&!1===e.box.options.display?t:t+1,0)||1),hBoxMaxHeight:n/2}),u=Object.assign({},r);ok(u,lu(s));let c=Object.assign({maxPadding:u,w:a,h:n,x:r.left,y:r.top},r),f=function(t,e){let i,s,r,a=function(t){let e={};for(let i of t){let{stack:t,pos:s,stackWeight:r}=i;if(!t||!ox.includes(s))continue;let a=e[t]||(e[t]={count:0,placed:0,weight:0,size:0});a.count++,a.weight+=r}return e}(t),{vBoxMaxWidth:n,hBoxMaxHeight:l}=e;for(i=0,s=t.length;i<s;++i){let{fullSize:s}=(r=t[i]).box,o=a[r.stack],h=o&&r.stackWeight/o.weight;r.horizontal?(r.width=h?h*n:s&&e.availableWidth,r.height=l):(r.width=n,r.height=h?h*l:s&&e.availableHeight)}return a}(o.concat(h),d);oP(l.fullSize,c,d,f),oP(o,c,d,f),oP(h,c,d,f)&&oP(o,c,d,f);let g=c.maxPadding;function p(t){let e=Math.max(g[t]-c[t],0);return c[t]+=e,e}c.y+=p("top"),c.x+=p("left"),p("right"),p("bottom"),oM(l.leftAndTop,c,d,f),c.x+=c.w,c.y+=c.h,oM(l.rightAndBottom,c,d,f),t.chartArea={left:c.left,top:c.top,right:c.left+c.w,bottom:c.top+c.h,height:c.h,width:c.w},a0(l.chartArea,e=>{let i=e.box;Object.assign(i,t.chartArea),i.update(c.w,c.h,{left:0,top:0,right:0,bottom:0})})}};class oO{acquireContext(t,e){}releaseContext(t){return!1}addEventListener(t,e,i){}removeEventListener(t,e,i){}getDevicePixelRatio(){return 1}getMaximumSize(t,e,i,s){return e=Math.max(0,e||t.width),i=i||t.height,{width:e,height:Math.max(0,s?Math.floor(e/s):i)}}isAttached(t){return!0}updateConfig(t){}}class oF extends oO{acquireContext(t){return t&&t.getContext&&t.getContext("2d")||null}updateConfig(t){t.options.animation=!1}}const oN="$chartjs",oB={touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup",pointerenter:"mouseenter",pointerdown:"mousedown",pointermove:"mousemove",pointerup:"mouseup",pointerleave:"mouseout",pointerout:"mouseout"},oU=t=>null===t||""===t,o$=!!lG&&{passive:!0};function oG(t,e){for(let i of t)if(i===e||i.contains(e))return!0}function oV(t,e,i){let s=t.canvas,r=new MutationObserver(t=>{let e=!1;for(let i of t)e=(e=e||oG(i.addedNodes,s))&&!oG(i.removedNodes,s);e&&i()});return r.observe(document,{childList:!0,subtree:!0}),r}function oH(t,e,i){let s=t.canvas,r=new MutationObserver(t=>{let e=!1;for(let i of t)e=(e=e||oG(i.removedNodes,s))&&!oG(i.addedNodes,s);e&&i()});return r.observe(document,{childList:!0,subtree:!0}),r}const oK=new Map;let oW=0;function oY(){let t=window.devicePixelRatio;t!==oW&&(oW=t,oK.forEach((e,i)=>{i.currentDevicePixelRatio!==t&&e()}))}function oj(t,e,i){let s=t.canvas,r=s&&lC(s);if(!r)return;let a=nw((t,e)=>{let s=r.clientWidth;i(t,e),s<r.clientWidth&&i()},window),n=new ResizeObserver(t=>{let e=t[0],i=e.contentRect.width,s=e.contentRect.height;(0!==i||0!==s)&&a(i,s)});return n.observe(r),oK.size||window.addEventListener("resize",oY),oK.set(t,a),n}function oz(t,e,i){i&&i.disconnect(),"resize"===e&&(oK.delete(t),oK.size||window.removeEventListener("resize",oY))}function oq(t,e,i){let s=t.canvas,r=nw(e=>{null!==t.ctx&&i(function(t,e){let i=oB[t.type]||t.type,{x:s,y:r}=lB(t,e);return{type:i,chart:e,native:t,x:void 0!==s?s:null,y:void 0!==r?r:null}}(e,t))},t);return s&&s.addEventListener(e,r,o$),r}class oX extends oO{acquireContext(t,e){let i=t&&t.getContext&&t.getContext("2d");return i&&i.canvas===t?(!function(t,e){let i=t.style,s=t.getAttribute("height"),r=t.getAttribute("width");if(t[oN]={initial:{height:s,width:r,style:{display:i.display,height:i.height,width:i.width}}},i.display=i.display||"block",i.boxSizing=i.boxSizing||"border-box",oU(r)){let e=lV(t,"width");void 0!==e&&(t.width=e)}if(oU(s))if(""===t.style.height)t.height=t.width/(e||2);else{let e=lV(t,"height");void 0!==e&&(t.height=e)}}(t,e),i):null}releaseContext(t){let e=t.canvas;if(!e[oN])return!1;let i=e[oN].initial;["height","width"].forEach(t=>{let s=i[t];aW(s)?e.removeAttribute(t):e.setAttribute(t,s)});let s=i.style||{};return Object.keys(s).forEach(t=>{e.style[t]=s[t]}),e.width=e.width,delete e[oN],!0}addEventListener(t,e,i){this.removeEventListener(t,e);let s=t.$proxies||(t.$proxies={}),r={attach:oV,detach:oH,resize:oj}[e]||oq;s[e]=r(t,e,i)}removeEventListener(t,e){let i=t.$proxies||(t.$proxies={}),s=i[e];s&&((({attach:oz,detach:oz,resize:oz})[e]||function(t,e,i){t&&t.canvas&&t.canvas.removeEventListener(e,i,o$)})(t,e,s),i[e]=void 0)}getDevicePixelRatio(){return window.devicePixelRatio}getMaximumSize(t,e,i,s){return function(t,e,i,s){let r=lw(t),a=lF(r,"margin"),n=lM(r.maxWidth,t,"clientWidth")||nl,l=lM(r.maxHeight,t,"clientHeight")||nl,o=function(t,e,i){let s,r;if(void 0===e||void 0===i){let a=t&&lC(t);if(a){let t=a.getBoundingClientRect(),n=lw(a),l=lF(n,"border","width"),o=lF(n,"padding");e=t.width-o.width-l.width,i=t.height-o.height-l.height,s=lM(n.maxWidth,a,"clientWidth"),r=lM(n.maxHeight,a,"clientHeight")}else e=t.clientWidth,i=t.clientHeight}return{width:e,height:i,maxWidth:s||nl,maxHeight:r||nl}}(t,e,i),{width:h,height:d}=o;if("content-box"===r.boxSizing){let t=lF(r,"border","width"),e=lF(r,"padding");h-=e.width+t.width,d-=e.height+t.height}return h=Math.max(0,h-a.width),d=Math.max(0,s?h/s:d-a.height),h=lU(Math.min(h,n,o.maxWidth)),d=lU(Math.min(d,l,o.maxHeight)),h&&!d&&(d=lU(h/2)),(void 0!==e||void 0!==i)&&s&&o.height&&d>o.height&&(h=lU(Math.floor((d=o.height)*s))),{width:h,height:d}}(t,e,i,s)}isAttached(t){let e=t&&lC(t);return!!(e&&e.isConnected)}}class oQ{static defaults={};static defaultRoutes=void 0;x;y;active=!1;options;$animations;tooltipPosition(t){let{x:e,y:i}=this.getProps(["x","y"],t);return{x:e,y:i}}hasValue(){return nm(this.x)&&nm(this.y)}getProps(t,e){let i=this.$animations;if(!e||!i)return this;let s={};return t.forEach(t=>{s[t]=i[t]&&i[t].active()?i[t]._to:this[t]}),s}}function oZ(t,e,i,s,r){let a,n,l,o=aX(s,0),h=Math.min(aX(r,t.length),t.length),d=0;for(i=Math.ceil(i),r&&(i=(a=r-s)/Math.floor(a/i)),l=o;l<0;)l=Math.round(o+ ++d*i);for(n=Math.max(o,0);n<h;n++)n===l&&(e.push(t[n]),l=Math.round(o+ ++d*i))}const oJ=t=>"left"===t?"right":"right"===t?"left":t,o0=(t,e,i)=>"top"===e||"left"===e?t[e]+i:t[e]-i,o1=(t,e)=>Math.min(e||t,t);function o2(t,e){let i=[],s=t.length/e,r=t.length,a=0;for(;a<r;a+=s)i.push(t[Math.floor(a)]);return i}function o5(t){return t.drawTicks?t.tickLength:0}function o3(t,e){if(!t.display)return 0;let i=lc(t.font,e),s=lu(t.padding);return(aY(t.text)?t.text.length:1)*i.lineHeight+s.height}class o4 extends oQ{constructor(t){super(),this.id=t.id,this.type=t.type,this.options=void 0,this.ctx=t.ctx,this.chart=t.chart,this.top=void 0,this.bottom=void 0,this.left=void 0,this.right=void 0,this.width=void 0,this.height=void 0,this._margins={left:0,right:0,top:0,bottom:0},this.maxWidth=void 0,this.maxHeight=void 0,this.paddingTop=void 0,this.paddingBottom=void 0,this.paddingLeft=void 0,this.paddingRight=void 0,this.axis=void 0,this.labelRotation=void 0,this.min=void 0,this.max=void 0,this._range=void 0,this.ticks=[],this._gridLineItems=null,this._labelItems=null,this._labelSizes=null,this._length=0,this._maxLength=0,this._longestTextCache={},this._startPixel=void 0,this._endPixel=void 0,this._reversePixels=!1,this._userMax=void 0,this._userMin=void 0,this._suggestedMax=void 0,this._suggestedMin=void 0,this._ticksLength=0,this._borderValue=0,this._cache={},this._dataLimitsCached=!1,this.$context=void 0}init(t){this.options=t.setContext(this.getContext()),this.axis=t.axis,this._userMin=this.parse(t.min),this._userMax=this.parse(t.max),this._suggestedMin=this.parse(t.suggestedMin),this._suggestedMax=this.parse(t.suggestedMax)}parse(t,e){return t}getUserBounds(){let{_userMin:t,_userMax:e,_suggestedMin:i,_suggestedMax:s}=this;return t=aq(t,Number.POSITIVE_INFINITY),e=aq(e,Number.NEGATIVE_INFINITY),i=aq(i,Number.POSITIVE_INFINITY),s=aq(s,Number.NEGATIVE_INFINITY),{min:aq(t,i),max:aq(e,s),minDefined:az(t),maxDefined:az(e)}}getMinMax(t){let e,{min:i,max:s,minDefined:r,maxDefined:a}=this.getUserBounds();if(r&&a)return{min:i,max:s};let n=this.getMatchingVisibleMetas();for(let l=0,o=n.length;l<o;++l)e=n[l].controller.getMinMax(this,t),r||(i=Math.min(i,e.min)),a||(s=Math.max(s,e.max));return i=a&&i>s?s:i,s=r&&i>s?i:s,{min:aq(i,aq(s,i)),max:aq(s,aq(i,s))}}getPadding(){return{left:this.paddingLeft||0,top:this.paddingTop||0,right:this.paddingRight||0,bottom:this.paddingBottom||0}}getTicks(){return this.ticks}getLabels(){let t=this.chart.data;return this.options.labels||(this.isHorizontal()?t.xLabels:t.yLabels)||t.labels||[]}getLabelItems(t=this.chart.chartArea){return this._labelItems||(this._labelItems=this._computeLabelItems(t))}beforeLayout(){this._cache={},this._dataLimitsCached=!1}beforeUpdate(){aJ(this.options.beforeUpdate,[this])}update(t,e,i){let{beginAtZero:s,grace:r,ticks:a}=this.options,n=a.sampleSize;this.beforeUpdate(),this.maxWidth=t,this.maxHeight=e,this._margins=i=Object.assign({left:0,right:0,top:0,bottom:0},i),this.ticks=null,this._labelSizes=null,this._gridLineItems=null,this._labelItems=null,this.beforeSetDimensions(),this.setDimensions(),this.afterSetDimensions(),this._maxLength=this.isHorizontal()?this.width+i.left+i.right:this.height+i.top+i.bottom,this._dataLimitsCached||(this.beforeDataLimits(),this.determineDataLimits(),this.afterDataLimits(),this._range=function(t,e,i){let{min:s,max:r}=t,a=aZ(e,(r-s)/2),n=(t,e)=>i&&0===t?0:t+e;return{min:n(s,-Math.abs(a)),max:n(r,a)}}(this,r,s),this._dataLimitsCached=!0),this.beforeBuildTicks(),this.ticks=this.buildTicks()||[],this.afterBuildTicks();let l=n<this.ticks.length;this._convertTicksToLabels(l?o2(this.ticks,n):this.ticks),this.configure(),this.beforeCalculateLabelRotation(),this.calculateLabelRotation(),this.afterCalculateLabelRotation(),a.display&&(a.autoSkip||"auto"===a.source)&&(this.ticks=function(t,e){let i=t.options.ticks,s=function(t){let e=t.options.offset,i=t._tickSize();return Math.floor(Math.min(t._length/i+ +!e,t._maxLength/i))}(t),r=Math.min(i.maxTicksLimit||s,s),a=i.major.enabled?function(t){let e,i,s=[];for(e=0,i=t.length;e<i;e++)t[e].major&&s.push(e);return s}(e):[],n=a.length,l=a[0],o=a[n-1],h=[];if(n>r)return function(t,e,i,s){let r,a=0,n=i[0];for(r=0,s=Math.ceil(s);r<t.length;r++)r===n&&(e.push(t[r]),n=i[++a*s])}(e,h,a,n/r),h;let d=function(t,e,i){let s=function(t){let e,i,s=t.length;if(s<2)return!1;for(i=t[0],e=1;e<s;++e)if(t[e]-t[e-1]!==i)return!1;return i}(t),r=e.length/i;if(!s)return Math.max(r,1);let a=function(t){let e,i=[],s=Math.sqrt(t);for(e=1;e<s;e++)t%e==0&&(i.push(e),i.push(t/e));return s===(0|s)&&i.push(s),i.sort((t,e)=>t-e).pop(),i}(s);for(let t=0,e=a.length-1;t<e;t++){let e=a[t];if(e>r)return e}return Math.max(r,1)}(a,e,r);if(n>0){let t,i,s=n>1?Math.round((o-l)/(n-1)):null;for(oZ(e,h,d,aW(s)?0:l-s,l),t=0,i=n-1;t<i;t++)oZ(e,h,d,a[t],a[t+1]);return oZ(e,h,d,o,aW(s)?e.length:o+s),h}return oZ(e,h,d),h}(this,this.ticks),this._labelSizes=null,this.afterAutoSkip()),l&&this._convertTicksToLabels(this.ticks),this.beforeFit(),this.fit(),this.afterFit(),this.afterUpdate()}configure(){let t,e,i=this.options.reverse;this.isHorizontal()?(t=this.left,e=this.right):(t=this.top,e=this.bottom,i=!i),this._startPixel=t,this._endPixel=e,this._reversePixels=i,this._length=e-t,this._alignToPixels=this.options.alignToPixels}afterUpdate(){aJ(this.options.afterUpdate,[this])}beforeSetDimensions(){aJ(this.options.beforeSetDimensions,[this])}setDimensions(){this.isHorizontal()?(this.width=this.maxWidth,this.left=0,this.right=this.width):(this.height=this.maxHeight,this.top=0,this.bottom=this.height),this.paddingLeft=0,this.paddingTop=0,this.paddingRight=0,this.paddingBottom=0}afterSetDimensions(){aJ(this.options.afterSetDimensions,[this])}_callHooks(t){this.chart.notifyPlugins(t,this.getContext()),aJ(this.options[t],[this])}beforeDataLimits(){this._callHooks("beforeDataLimits")}determineDataLimits(){}afterDataLimits(){this._callHooks("afterDataLimits")}beforeBuildTicks(){this._callHooks("beforeBuildTicks")}buildTicks(){return[]}afterBuildTicks(){this._callHooks("afterBuildTicks")}beforeTickToLabelConversion(){aJ(this.options.beforeTickToLabelConversion,[this])}generateTickLabels(t){let e,i,s,r=this.options.ticks;for(e=0,i=t.length;e<i;e++)(s=t[e]).label=aJ(r.callback,[s.value,e,t],this)}afterTickToLabelConversion(){aJ(this.options.afterTickToLabelConversion,[this])}beforeCalculateLabelRotation(){aJ(this.options.beforeCalculateLabelRotation,[this])}calculateLabelRotation(){let t,e,i,s=this.options,r=s.ticks,a=o1(this.ticks.length,s.ticks.maxTicksLimit),n=r.minRotation||0,l=r.maxRotation,o=n;if(!this._isVisible()||!r.display||n>=l||a<=1||!this.isHorizontal()){this.labelRotation=n;return}let h=this._getLabelSizes(),d=h.widest.width,u=h.highest.height,c=nx(this.chart.width-d,0,this.maxWidth);d+6>(t=s.offset?this.maxWidth/a:c/(a-1))&&(t=c/(a-(s.offset?.5:1)),e=this.maxHeight-o5(s.grid)-r.padding-o3(s.title,this.chart.options.font),i=Math.sqrt(d*d+u*u),o=Math.max(n,Math.min(l,o=180/nr*Math.min(Math.asin(nx((h.highest.height+6)/t,-1,1)),Math.asin(nx(e/i,-1,1))-Math.asin(nx(u/i,-1,1)))))),this.labelRotation=o}afterCalculateLabelRotation(){aJ(this.options.afterCalculateLabelRotation,[this])}afterAutoSkip(){}beforeFit(){aJ(this.options.beforeFit,[this])}fit(){let t={width:0,height:0},{chart:e,options:{ticks:i,title:s,grid:r}}=this,a=this._isVisible(),n=this.isHorizontal();if(a){let a=o3(s,e.options.font);if(n?(t.width=this.maxWidth,t.height=o5(r)+a):(t.height=this.maxHeight,t.width=o5(r)+a),i.display&&this.ticks.length){let{first:e,last:s,widest:r,highest:a}=this._getLabelSizes(),l=2*i.padding,o=nv(this.labelRotation),h=Math.cos(o),d=Math.sin(o);if(n){let e=i.mirror?0:d*r.width+h*a.height;t.height=Math.min(this.maxHeight,t.height+e+l)}else{let e=i.mirror?0:h*r.width+d*a.height;t.width=Math.min(this.maxWidth,t.width+e+l)}this._calculatePadding(e,s,d,h)}}this._handleMargins(),n?(this.width=this._length=e.width-this._margins.left-this._margins.right,this.height=t.height):(this.width=t.width,this.height=this._length=e.height-this._margins.top-this._margins.bottom)}_calculatePadding(t,e,i,s){let{ticks:{align:r,padding:a},position:n}=this.options,l=0!==this.labelRotation,o="top"!==n&&"x"===this.axis;if(this.isHorizontal()){let n=this.getPixelForTick(0)-this.left,h=this.right-this.getPixelForTick(this.ticks.length-1),d=0,u=0;l?o?(d=s*t.width,u=i*e.height):(d=i*t.height,u=s*e.width):"start"===r?u=e.width:"end"===r?d=t.width:"inner"!==r&&(d=t.width/2,u=e.width/2),this.paddingLeft=Math.max((d-n+a)*this.width/(this.width-n),0),this.paddingRight=Math.max((u-h+a)*this.width/(this.width-h),0)}else{let i=e.height/2,s=t.height/2;"start"===r?(i=0,s=t.height):"end"===r&&(i=e.height,s=0),this.paddingTop=i+a,this.paddingBottom=s+a}}_handleMargins(){this._margins&&(this._margins.left=Math.max(this.paddingLeft,this._margins.left),this._margins.top=Math.max(this.paddingTop,this._margins.top),this._margins.right=Math.max(this.paddingRight,this._margins.right),this._margins.bottom=Math.max(this.paddingBottom,this._margins.bottom))}afterFit(){aJ(this.options.afterFit,[this])}isHorizontal(){let{axis:t,position:e}=this.options;return"top"===e||"bottom"===e||"x"===t}isFullSize(){return this.options.fullSize}_convertTicksToLabels(t){let e,i;for(this.beforeTickToLabelConversion(),this.generateTickLabels(t),e=0,i=t.length;e<i;e++)aW(t[e].label)&&(t.splice(e,1),i--,e--);this.afterTickToLabelConversion()}_getLabelSizes(){let t=this._labelSizes;if(!t){let e=this.options.ticks.sampleSize,i=this.ticks;e<i.length&&(i=o2(i,e)),this._labelSizes=t=this._computeLabelSizes(i,i.length,this.options.ticks.maxTicksLimit)}return t}_computeLabelSizes(t,e,i){let s,r,a,n,l,o,h,d,u,c,f,{ctx:g,_longestTextCache:p}=this,m=[],y=[],v=Math.floor(e/o1(e,i)),E=0,T=0;for(s=0;s<e;s+=v){if(n=t[s].label,g.font=o=(l=this._resolveTickFontOptions(s)).string,h=p[o]=p[o]||{data:{},gc:[]},d=l.lineHeight,u=c=0,aW(n)||aY(n)){if(aY(n))for(r=0,a=n.length;r<a;++r)aW(f=n[r])||aY(f)||(u=n5(g,h.data,h.gc,u,f),c+=d)}else u=n5(g,h.data,h.gc,u,n),c=d;m.push(u),y.push(c),E=Math.max(u,E),T=Math.max(c,T)}a0(p,t=>{let i,s=t.gc,r=s.length/2;if(r>e){for(i=0;i<r;++i)delete t.data[s[i]];s.splice(0,r)}});let b=m.indexOf(E),S=y.indexOf(T),A=t=>({width:m[t]||0,height:y[t]||0});return{first:A(0),last:A(e-1),widest:A(b),highest:A(S),widths:m,heights:y}}getLabelForValue(t){return t}getPixelForValue(t,e){return NaN}getValueForPixel(t){}getPixelForTick(t){let e=this.ticks;return t<0||t>e.length-1?null:this.getPixelForValue(e[t].value)}getPixelForDecimal(t){this._reversePixels&&(t=1-t);let e=this._startPixel+t*this._length;return nx(this._alignToPixels?n3(this.chart,e,0):e,-32768,32767)}getDecimalForPixel(t){let e=(t-this._startPixel)/this._length;return this._reversePixels?1-e:e}getBasePixel(){return this.getPixelForValue(this.getBaseValue())}getBaseValue(){let{min:t,max:e}=this;return t<0&&e<0?e:t>0&&e>0?t:0}getContext(t){var e;let i=this.ticks||[];if(t>=0&&t<i.length){let e=i[t];return e.$context||(e.$context=lg(this.getContext(),{tick:e,index:t,type:"tick"}))}return this.$context||(this.$context=(e=this.chart.getContext(),lg(e,{scale:this,type:"scale"})))}_tickSize(){let t=this.options.ticks,e=nv(this.labelRotation),i=Math.abs(Math.cos(e)),s=Math.abs(Math.sin(e)),r=this._getLabelSizes(),a=t.autoSkipPadding||0,n=r?r.widest.width+a:0,l=r?r.highest.height+a:0;return this.isHorizontal()?l*i>n*s?n/i:l/s:l*s<n*i?l/i:n/s}_isVisible(){let t=this.options.display;return"auto"!==t?!!t:this.getMatchingVisibleMetas().length>0}_computeGridLineItems(t){let e,i,s,r,a,n,l,o,h,d,u,c,f=this.axis,g=this.chart,p=this.options,{grid:m,position:y,border:v}=p,E=m.offset,T=this.isHorizontal(),b=this.ticks.length+ +!!E,S=o5(m),A=[],_=v.setContext(this.getContext()),x=_.display?_.width:0,L=x/2,I=function(t){return n3(g,t,x)};if("top"===y)e=I(this.bottom),n=this.bottom-S,o=e-L,d=I(t.top)+L,c=t.bottom;else if("bottom"===y)e=I(this.top),d=t.top,c=I(t.bottom)-L,n=e+L,o=this.top+S;else if("left"===y)e=I(this.right),a=this.right-S,l=e-L,h=I(t.left)+L,u=t.right;else if("right"===y)e=I(this.left),h=t.left,u=I(t.right)-L,a=e+L,l=this.left+S;else if("x"===f){if("center"===y)e=I((t.top+t.bottom)/2+.5);else if(aj(y)){let t=Object.keys(y)[0],i=y[t];e=I(this.chart.scales[t].getPixelForValue(i))}d=t.top,c=t.bottom,o=(n=e+L)+S}else if("y"===f){if("center"===y)e=I((t.left+t.right)/2);else if(aj(y)){let t=Object.keys(y)[0],i=y[t];e=I(this.chart.scales[t].getPixelForValue(i))}l=(a=e-L)-S,h=t.left,u=t.right}let R=aX(p.ticks.maxTicksLimit,b),D=Math.max(1,Math.ceil(b/R));for(i=0;i<b;i+=D){let t=this.getContext(i),e=m.setContext(t),f=v.setContext(t),p=e.lineWidth,y=e.color,b=f.dash||[],S=f.dashOffset,_=e.tickWidth,x=e.tickColor,L=e.tickBorderDash||[],I=e.tickBorderDashOffset;void 0!==(s=function(t,e,i){let s,r=t.ticks.length,a=Math.min(e,r-1),n=t._startPixel,l=t._endPixel,o=t.getPixelForTick(a);if(!i||(s=1===r?Math.max(o-n,l-o):0===e?(t.getPixelForTick(1)-o)/2:(o-t.getPixelForTick(a-1))/2,!((o+=a<e?s:-s)<n-1e-6)&&!(o>l+1e-6)))return o}(this,i,E))&&(r=n3(g,s,p),T?a=l=h=u=r:n=o=d=c=r,A.push({tx1:a,ty1:n,tx2:l,ty2:o,x1:h,y1:d,x2:u,y2:c,width:p,color:y,borderDash:b,borderDashOffset:S,tickWidth:_,tickColor:x,tickBorderDash:L,tickBorderDashOffset:I}))}return this._ticksLength=b,this._borderValue=e,A}_computeLabelItems(t){let e,i,s,r,a,n,l,o,h,d,u,c=this.axis,f=this.options,{position:g,ticks:p}=f,m=this.isHorizontal(),y=this.ticks,{align:v,crossAlign:E,padding:T,mirror:b}=p,S=o5(f.grid),A=S+T,_=b?-T:A,x=-nv(this.labelRotation),L=[],I="middle";if("top"===g)a=this.bottom-_,n=this._getXAxisLabelAlignment();else if("bottom"===g)a=this.top+_,n=this._getXAxisLabelAlignment();else if("left"===g){let t=this._getYAxisLabelAlignment(S);n=t.textAlign,r=t.x}else if("right"===g){let t=this._getYAxisLabelAlignment(S);n=t.textAlign,r=t.x}else if("x"===c){if("center"===g)a=(t.top+t.bottom)/2+A;else if(aj(g)){let t=Object.keys(g)[0],e=g[t];a=this.chart.scales[t].getPixelForValue(e)+A}n=this._getXAxisLabelAlignment()}else if("y"===c){if("center"===g)r=(t.left+t.right)/2-A;else if(aj(g)){let t=Object.keys(g)[0],e=g[t];r=this.chart.scales[t].getPixelForValue(e)}n=this._getYAxisLabelAlignment(S).textAlign}"y"===c&&("start"===v?I="top":"end"===v&&(I="bottom"));let R=this._getLabelSizes();for(e=0,i=y.length;e<i;++e){let t;s=y[e].label;let c=p.setContext(this.getContext(e));l=this.getPixelForTick(e)+p.labelOffset,h=(o=this._resolveTickFontOptions(e)).lineHeight;let f=(d=aY(s)?s.length:1)/2,v=c.color,T=c.textStrokeColor,S=c.textStrokeWidth,A=n;if(m?(r=l,"inner"===n&&(A=e===i-1?this.options.reverse?"left":"right":0===e?this.options.reverse?"right":"left":"center"),u="top"===g?"near"===E||0!==x?-d*h+h/2:"center"===E?-R.highest.height/2-f*h+h:-R.highest.height+h/2:"near"===E||0!==x?h/2:"center"===E?R.highest.height/2-f*h:R.highest.height-d*h,b&&(u*=-1),0===x||c.showLabelBackdrop||(r+=h/2*Math.sin(x))):(a=l,u=(1-d)*h/2),c.showLabelBackdrop){let s=lu(c.backdropPadding),r=R.heights[e],a=R.widths[e],l=u-s.top,o=0-s.left;switch(I){case"middle":l-=r/2;break;case"bottom":l-=r}switch(n){case"center":o-=a/2;break;case"right":o-=a;break;case"inner":e===i-1?o-=a:e>0&&(o-=a/2)}t={left:o,top:l,width:a+s.width,height:r+s.height,color:c.backdropColor}}L.push({label:s,font:o,textOffset:u,options:{rotation:x,color:v,strokeColor:T,strokeWidth:S,textAlign:A,textBaseline:I,translation:[r,a],backdrop:t}})}return L}_getXAxisLabelAlignment(){let{position:t,ticks:e}=this.options;if(-nv(this.labelRotation))return"top"===t?"left":"right";let i="center";return"start"===e.align?i="left":"end"===e.align?i="right":"inner"===e.align&&(i="inner"),i}_getYAxisLabelAlignment(t){let e,i,{position:s,ticks:{crossAlign:r,mirror:a,padding:n}}=this.options,l=this._getLabelSizes(),o=t+n,h=l.widest.width;return"left"===s?a?(i=this.right+n,"near"===r?e="left":"center"===r?(e="center",i+=h/2):(e="right",i+=h)):(i=this.right-o,"near"===r?e="right":"center"===r?(e="center",i-=h/2):(e="left",i=this.left)):"right"===s?a?(i=this.left+n,"near"===r?e="right":"center"===r?(e="center",i-=h/2):(e="left",i-=h)):(i=this.left+o,"near"===r?e="left":"center"===r?(e="center",i+=h/2):(e="right",i=this.right)):e="right",{textAlign:e,x:i}}_computeLabelArea(){if(this.options.ticks.mirror)return;let t=this.chart,e=this.options.position;return"left"===e||"right"===e?{top:0,left:this.left,bottom:t.height,right:this.right}:"top"===e||"bottom"===e?{top:this.top,left:0,bottom:this.bottom,right:t.width}:void 0}drawBackground(){let{ctx:t,options:{backgroundColor:e},left:i,top:s,width:r,height:a}=this;e&&(t.save(),t.fillStyle=e,t.fillRect(i,s,r,a),t.restore())}getLineWidthForValue(t){let e=this.options.grid;if(!this._isVisible()||!e.display)return 0;let i=this.ticks.findIndex(e=>e.value===t);return i>=0?e.setContext(this.getContext(i)).lineWidth:0}drawGrid(t){let e,i,s=this.options.grid,r=this.ctx,a=this._gridLineItems||(this._gridLineItems=this._computeGridLineItems(t)),n=(t,e,i)=>{i.width&&i.color&&(r.save(),r.lineWidth=i.width,r.strokeStyle=i.color,r.setLineDash(i.borderDash||[]),r.lineDashOffset=i.borderDashOffset,r.beginPath(),r.moveTo(t.x,t.y),r.lineTo(e.x,e.y),r.stroke(),r.restore())};if(s.display)for(e=0,i=a.length;e<i;++e){let t=a[e];s.drawOnChartArea&&n({x:t.x1,y:t.y1},{x:t.x2,y:t.y2},t),s.drawTicks&&n({x:t.tx1,y:t.ty1},{x:t.tx2,y:t.ty2},{color:t.tickColor,width:t.tickWidth,borderDash:t.tickBorderDash,borderDashOffset:t.tickBorderDashOffset})}}drawBorder(){let t,e,i,s,{chart:r,ctx:a,options:{border:n,grid:l}}=this,o=n.setContext(this.getContext()),h=n.display?o.width:0;if(!h)return;let d=l.setContext(this.getContext(0)).lineWidth,u=this._borderValue;this.isHorizontal()?(t=n3(r,this.left,h)-h/2,e=n3(r,this.right,d)+d/2,i=s=u):(i=n3(r,this.top,h)-h/2,s=n3(r,this.bottom,d)+d/2,t=e=u),a.save(),a.lineWidth=o.width,a.strokeStyle=o.color,a.beginPath(),a.moveTo(t,i),a.lineTo(e,s),a.stroke(),a.restore()}drawLabels(t){if(!this.options.ticks.display)return;let e=this.ctx,i=this._computeLabelArea();for(let s of(i&&n7(e,i),this.getLabelItems(t))){let t=s.options,i=s.font;ls(e,s.label,0,s.textOffset,i,t)}i&&lt(e)}drawTitle(){let t,{ctx:e,options:{position:i,title:s,reverse:r}}=this;if(!s.display)return;let a=lc(s.font),n=lu(s.padding),l=s.align,o=a.lineHeight/2;"bottom"===i||"center"===i||aj(i)?(o+=n.bottom,aY(s.text)&&(o+=a.lineHeight*(s.text.length-1))):o+=n.top;let{titleX:h,titleY:d,maxWidth:u,rotation:c}=function(t,e,i,s){let r,a,n,{top:l,left:o,bottom:h,right:d,chart:u}=t,{chartArea:c,scales:f}=u,g=0,p=h-l,m=d-o;if(t.isHorizontal()){if(a=nF(s,o,d),aj(i)){let t=Object.keys(i)[0],s=i[t];n=f[t].getPixelForValue(s)+p-e}else n="center"===i?(c.bottom+c.top)/2+p-e:o0(t,i,e);r=d-o}else{if(aj(i)){let t=Object.keys(i)[0],s=i[t];a=f[t].getPixelForValue(s)-m+e}else a="center"===i?(c.left+c.right)/2-m+e:o0(t,i,e);n=nF(s,h,l),g="left"===i?-nh:nh}return{titleX:a,titleY:n,maxWidth:r,rotation:g}}(this,o,i,l);ls(e,s.text,0,0,a,{color:s.color,maxWidth:u,rotation:c,textAlign:(t=nO(l),(r&&"right"!==i||!r&&"right"===i)&&(t=oJ(t)),t),textBaseline:"middle",translation:[h,d]})}draw(t){this._isVisible()&&(this.drawBackground(),this.drawGrid(t),this.drawBorder(),this.drawTitle(),this.drawLabels(t))}_layers(){let t=this.options,e=t.ticks&&t.ticks.z||0,i=aX(t.grid&&t.grid.z,-1),s=aX(t.border&&t.border.z,0);return this._isVisible()&&this.draw===o4.prototype.draw?[{z:i,draw:t=>{this.drawBackground(),this.drawGrid(t),this.drawTitle()}},{z:s,draw:()=>{this.drawBorder()}},{z:e,draw:t=>{this.drawLabels(t)}}]:[{z:e,draw:t=>{this.draw(t)}}]}getMatchingVisibleMetas(t){let e,i,s=this.chart.getSortedVisibleDatasetMetas(),r=this.axis+"AxisID",a=[];for(e=0,i=s.length;e<i;++e){let i=s[e];i[r]!==this.id||t&&i.type!==t||a.push(i)}return a}_resolveTickFontOptions(t){return lc(this.options.ticks.setContext(this.getContext(t)).font)}_maxDigits(){let t=this._resolveTickFontOptions(0).lineHeight;return(this.isHorizontal()?this.width:this.height)/t}}class o8{constructor(t,e,i){this.type=t,this.scope=e,this.override=i,this.items=Object.create(null)}isForType(t){return Object.prototype.isPrototypeOf.call(this.type.prototype,t.prototype)}register(t){var e;let i,s=Object.getPrototypeOf(t);"id"in(e=s)&&"defaults"in e&&(i=this.register(s));let r=this.items,a=t.id,n=this.scope+"."+a;if(!a)throw Error("class does not have id: "+t);return a in r||(r[a]=t,function(t,e,i){var s,r;let a=a4(Object.create(null),[i?n2.get(i):{},n2.get(e),t.defaults]);n2.set(e,a),t.defaultRoutes&&(s=e,Object.keys(r=t.defaultRoutes).forEach(t=>{let e=t.split("."),i=e.pop(),a=[s].concat(e).join("."),n=r[t].split("."),l=n.pop(),o=n.join(".");n2.route(a,i,o,l)})),t.descriptors&&n2.describe(e,t.descriptors)}(t,n,i),this.override&&n2.override(t.id,t.overrides)),n}get(t){return this.items[t]}unregister(t){let e=this.items,i=t.id,s=this.scope;i in e&&delete e[i],s&&i in n2[s]&&(delete(0,n2)[s][i],this.override&&delete(0,nZ)[i])}}var o6=new class{constructor(){this.controllers=new o8(oh,"datasets",!0),this.elements=new o8(oQ,"elements"),this.plugins=new o8(Object,"plugins"),this.scales=new o8(o4,"scales"),this._typedRegistries=[this.controllers,this.scales,this.elements]}add(...t){this._each("register",t)}remove(...t){this._each("unregister",t)}addControllers(...t){this._each("register",t,this.controllers)}addElements(...t){this._each("register",t,this.elements)}addPlugins(...t){this._each("register",t,this.plugins)}addScales(...t){this._each("register",t,this.scales)}getController(t){return this._get(t,this.controllers,"controller")}getElement(t){return this._get(t,this.elements,"element")}getPlugin(t){return this._get(t,this.plugins,"plugin")}getScale(t){return this._get(t,this.scales,"scale")}removeControllers(...t){this._each("unregister",t,this.controllers)}removeElements(...t){this._each("unregister",t,this.elements)}removePlugins(...t){this._each("unregister",t,this.plugins)}removeScales(...t){this._each("unregister",t,this.scales)}_each(t,e,i){[...e].forEach(e=>{let s=i||this._getRegistryForType(e);i||s.isForType(e)||s===this.plugins&&e.id?this._exec(t,s,e):a0(e,e=>{let s=i||this._getRegistryForType(e);this._exec(t,s,e)})})}_exec(t,e,i){let s=nt(t);aJ(i["before"+s],[],i),e[t](i),aJ(i["after"+s],[],i)}_getRegistryForType(t){for(let e=0;e<this._typedRegistries.length;e++){let i=this._typedRegistries[e];if(i.isForType(t))return i}return this.plugins}_get(t,e,i){let s=e.get(t);if(void 0===s)throw Error('"'+t+'" is not a registered '+i+".");return s}};class o9{constructor(){this._init=[]}notify(t,e,i,s){"beforeInit"===e&&(this._init=this._createDescriptors(t,!0),this._notify(this._init,t,"install"));let r=s?this._descriptors(t).filter(s):this._descriptors(t),a=this._notify(r,t,e,i);return"afterDestroy"===e&&(this._notify(r,t,"stop"),this._notify(this._init,t,"uninstall")),a}_notify(t,e,i,s){for(let r of(s=s||{},t)){let t=r.plugin;if(!1===aJ(t[i],[e,s,r.options],t)&&s.cancelable)return!1}return!0}invalidate(){aW(this._cache)||(this._oldCache=this._cache,this._cache=void 0)}_descriptors(t){if(this._cache)return this._cache;let e=this._cache=this._createDescriptors(t);return this._notifyStateChanges(t),e}_createDescriptors(t,e){let i=t&&t.config,s=aX(i.options&&i.options.plugins,{}),r=function(t){let e={},i=[],s=Object.keys(o6.plugins.items);for(let t=0;t<s.length;t++)i.push(o6.getPlugin(s[t]));let r=t.plugins||[];for(let t=0;t<r.length;t++){let s=r[t];-1===i.indexOf(s)&&(i.push(s),e[s.id]=!0)}return{plugins:i,localIds:e}}(i);return!1!==s||e?function(t,{plugins:e,localIds:i},s,r){let a=[],n=t.getContext();for(let o of e){var l;let e=o.id,h=(l=s[e],r||!1!==l?!0===l?{}:l:null);null!==h&&a.push({plugin:o,options:function(t,{plugin:e,local:i},s,r){let a=t.pluginScopeKeys(e),n=t.getOptionScopes(s,a);return i&&e.defaults&&n.push(e.defaults),t.createResolver(n,r,[""],{scriptable:!1,indexable:!1,allKeys:!0})}(t.config,{plugin:o,local:i[e]},h,n)})}return a}(t,r,s,e):[]}_notifyStateChanges(t){let e=this._oldCache||[],i=this._cache,s=(t,e)=>t.filter(t=>!e.some(e=>t.plugin.id===e.plugin.id));this._notify(s(e,i),t,"stop"),this._notify(s(i,e),t,"start")}}function o7(t,e){let i=n2.datasets[t]||{};return((e.datasets||{})[t]||{}).indexAxis||e.indexAxis||i.indexAxis||"x"}function ht(t){if("x"===t||"y"===t||"r"===t)return t}function he(t,...e){if(ht(t))return t;for(let s of e){var i;let e=s.axis||("top"===(i=s.position)||"bottom"===i?"x":"left"===i||"right"===i?"y":void 0)||t.length>1&&ht(t[0].toLowerCase());if(e)return e}throw Error(`Cannot determine type of '${t}' axis. Please provide 'axis' or 'position' option.`)}function hi(t,e,i){if(i[e+"AxisID"]===t)return{axis:e}}function hs(t){let e=t.options||(t.options={});e.plugins=aX(e.plugins,{}),e.scales=function(t,e){let i=nZ[t.type]||{scales:{}},s=e.scales||{},r=o7(t.type,e),a=Object.create(null);return Object.keys(s).forEach(e=>{let n=s[e];if(!aj(n))return console.error(`Invalid scale configuration for scale: ${e}`);if(n._proxy)return console.warn(`Ignoring resolver passed as options for scale: ${e}`);let l=he(e,n,function(t,e){if(e.data&&e.data.datasets){let i=e.data.datasets.filter(e=>e.xAxisID===t||e.yAxisID===t);if(i.length)return hi(t,"x",i[0])||hi(t,"y",i[0])}return{}}(e,t),n2.scales[n.type]),o=l===r?"_index_":"_value_",h=i.scales||{};a[e]=a8(Object.create(null),[{axis:l},n,h[l],h[o]])}),t.data.datasets.forEach(i=>{let r=i.type||t.type,n=i.indexAxis||o7(r,e),l=(nZ[r]||{}).scales||{};Object.keys(l).forEach(t=>{let e,r=(e=t,"_index_"===t?e=n:"_value_"===t&&(e="x"===n?"y":"x"),e),o=i[r+"AxisID"]||r;a[o]=a[o]||Object.create(null),a8(a[o],[{axis:r},s[o],l[t]])})}),Object.keys(a).forEach(t=>{let e=a[t];a8(e,[n2.scales[e.type],n2.scale])}),a}(t,e)}function hr(t){return(t=t||{}).datasets=t.datasets||[],t.labels=t.labels||[],t}const ha=new Map,hn=new Set;function hl(t,e){let i=ha.get(t);return i||(i=e(),ha.set(t,i),hn.add(i)),i}const ho=(t,e,i)=>{let s=a7(e,i);void 0!==s&&t.add(s)};class hh{constructor(t){var e;this._config=((e=(e=t)||{}).data=hr(e.data),hs(e),e),this._scopeCache=new Map,this._resolverCache=new Map}get platform(){return this._config.platform}get type(){return this._config.type}set type(t){this._config.type=t}get data(){return this._config.data}set data(t){this._config.data=hr(t)}get options(){return this._config.options}set options(t){this._config.options=t}get plugins(){return this._config.plugins}update(){let t=this._config;this.clearCache(),hs(t)}clearCache(){this._scopeCache.clear(),this._resolverCache.clear()}datasetScopeKeys(t){return hl(t,()=>[[`datasets.${t}`,""]])}datasetAnimationScopeKeys(t,e){return hl(`${t}.transition.${e}`,()=>[[`datasets.${t}.transitions.${e}`,`transitions.${e}`],[`datasets.${t}`,""]])}datasetElementScopeKeys(t,e){return hl(`${t}-${e}`,()=>[[`datasets.${t}.elements.${e}`,`datasets.${t}`,`elements.${e}`,""]])}pluginScopeKeys(t){let e=t.id,i=this.type;return hl(`${i}-plugin-${e}`,()=>[[`plugins.${e}`,...t.additionalOptionScopes||[]]])}_cachedScopes(t,e){let i=this._scopeCache,s=i.get(t);return(!s||e)&&(s=new Map,i.set(t,s)),s}getOptionScopes(t,e,i){let{options:s,type:r}=this,a=this._cachedScopes(t,i),n=a.get(e);if(n)return n;let l=new Set;e.forEach(e=>{t&&(l.add(t),e.forEach(e=>ho(l,t,e))),e.forEach(t=>ho(l,s,t)),e.forEach(t=>ho(l,nZ[r]||{},t)),e.forEach(t=>ho(l,n2,t)),e.forEach(t=>ho(l,nJ,t))});let o=Array.from(l);return 0===o.length&&o.push(Object.create(null)),hn.has(e)&&a.set(e,o),o}chartOptionScopes(){let{options:t,type:e}=this;return[t,nZ[e]||{},n2.datasets[e]||{},{type:e},n2,nJ]}resolveNamedOptions(t,e,i,s=[""]){let r={$shared:!0},{resolver:a,subPrefixes:n}=hd(this._resolverCache,t,s),l=a;if(function(t,e){let{isScriptable:i,isIndexable:s}=ly(t);for(let r of e){let e=i(r),a=s(r),n=(a||e)&&t[r];if(e&&(ni(n)||hu(n))||a&&aY(n))return!0}return!1}(a,e)){r.$shared=!1,i=ni(i)?i():i;let e=this.createResolver(t,i,n);l=lm(a,i,e)}for(let t of e)r[t]=l[t];return r}createResolver(t,e,i=[""],s){let{resolver:r}=hd(this._resolverCache,t,i);return aj(e)?lm(r,e,void 0,s):r}}function hd(t,e,i){let s=t.get(e);s||(s=new Map,t.set(e,s));let r=i.join(),a=s.get(r);return a||(a={resolver:lp(e,i),subPrefixes:i.filter(t=>!t.toLowerCase().includes("hover"))},s.set(r,a)),a}const hu=t=>aj(t)&&Object.getOwnPropertyNames(t).some(e=>ni(t[e])),hc=["top","bottom","left","right","chartArea"];function hf(t,e){return"top"===t||"bottom"===t||-1===hc.indexOf(t)&&"x"===e}function hg(t,e){return function(i,s){return i[t]===s[t]?i[e]-s[e]:i[t]-s[t]}}function hp(t){let e=t.chart,i=e.options.animation;e.notifyPlugins("afterRender"),aJ(i&&i.onComplete,[t],e)}function hm(t){let e=t.chart,i=e.options.animation;aJ(i&&i.onProgress,[t],e)}function hy(t){return lP()&&"string"==typeof t?t=document.getElementById(t):t&&t.length&&(t=t[0]),t&&t.canvas&&(t=t.canvas),t}const hv={},hE=t=>{let e=hy(t);return Object.values(hv).filter(t=>t.canvas===e).pop()};class hT{static defaults=n2;static instances=hv;static overrides=nZ;static registry=o6;static version="4.4.9";static getChart=hE;static register(...t){o6.add(...t),hb()}static unregister(...t){o6.remove(...t),hb()}constructor(t,e){var i,s;let r,a=this.config=new hh(e),n=hy(t),l=hE(n);if(l)throw Error("Canvas is already in use. Chart with ID '"+l.id+"' must be destroyed before the canvas with ID '"+l.canvas.id+"' can be reused.");let o=a.createResolver(a.chartOptionScopes(),this.getContext());this.platform=new(a.platform||(!lP()||"undefined"!=typeof OffscreenCanvas&&n instanceof OffscreenCanvas?oF:oX)),this.platform.updateConfig(a);let h=this.platform.acquireContext(n,o.aspectRatio),d=h&&h.canvas,u=d&&d.height,c=d&&d.width;if(this.id=aK(),this.ctx=h,this.canvas=d,this.width=c,this.height=u,this._options=o,this._aspectRatio=this.aspectRatio,this._layers=[],this._metasets=[],this._stacks=void 0,this.boxes=[],this.currentDevicePixelRatio=void 0,this.chartArea=void 0,this._active=[],this._lastEvent=void 0,this._listeners={},this._responsiveListeners=void 0,this._sortedMetasets=[],this.scales={},this._plugins=new o9,this.$proxies={},this._hiddenIndices={},this.attached=!1,this._animationsDisabled=void 0,this.$context=void 0,this._doResize=(i=t=>this.update(t),s=o.resizeDelay||0,function(...t){return s?(clearTimeout(r),r=setTimeout(i,s,t)):i.apply(this,t),s}),this._dataChanges=[],hv[this.id]=this,!h||!d)return void console.error("Failed to create chart: can't acquire context from the given item");l5.listen(this,"complete",hp),l5.listen(this,"progress",hm),this._initialize(),this.attached&&this.update()}get aspectRatio(){let{options:{aspectRatio:t,maintainAspectRatio:e},width:i,height:s,_aspectRatio:r}=this;return aW(t)?e&&r?r:s?i/s:null:t}get data(){return this.config.data}set data(t){this.config.data=t}get options(){return this._options}set options(t){this.config.options=t}get registry(){return o6}_initialize(){return this.notifyPlugins("beforeInit"),this.options.responsive?this.resize():l$(this,this.options.devicePixelRatio),this.bindEvents(),this.notifyPlugins("afterInit"),this}clear(){return n4(this.canvas,this.ctx),this}stop(){return l5.stop(this),this}resize(t,e){l5.running(this)?this._resizeBeforeDraw={width:t,height:e}:this._resize(t,e)}_resize(t,e){let i=this.options,s=this.canvas,r=i.maintainAspectRatio&&this.aspectRatio,a=this.platform.getMaximumSize(s,t,e,r),n=i.devicePixelRatio||this.platform.getDevicePixelRatio(),l=this.width?"resize":"attach";this.width=a.width,this.height=a.height,this._aspectRatio=this.aspectRatio,l$(this,n,!0)&&(this.notifyPlugins("resize",{size:a}),aJ(i.onResize,[this,a],this),this.attached&&this._doResize(l)&&this.render())}ensureScalesHaveIDs(){a0(this.options.scales||{},(t,e)=>{t.id=e})}buildOrUpdateScales(){let t=this.options,e=t.scales,i=this.scales,s=Object.keys(i).reduce((t,e)=>(t[e]=!1,t),{}),r=[];e&&(r=r.concat(Object.keys(e).map(t=>{let i=e[t],s=he(t,i),r="r"===s,a="x"===s;return{options:i,dposition:r?"chartArea":a?"bottom":"left",dtype:r?"radialLinear":a?"category":"linear"}}))),a0(r,e=>{let r=e.options,a=r.id,n=he(a,r),l=aX(r.type,e.dtype);(void 0===r.position||hf(r.position,n)!==hf(e.dposition))&&(r.position=e.dposition),s[a]=!0;let o=null;a in i&&i[a].type===l?o=i[a]:i[(o=new(o6.getScale(l))({id:a,type:l,ctx:this.ctx,chart:this})).id]=o,o.init(r,t)}),a0(s,(t,e)=>{t||delete i[e]}),a0(i,t=>{ow.configure(this,t,t.options),ow.addBox(this,t)})}_updateMetasets(){let t=this._metasets,e=this.data.datasets.length,i=t.length;if(t.sort((t,e)=>t.index-e.index),i>e){for(let t=e;t<i;++t)this._destroyDatasetMeta(t);t.splice(e,i-e)}this._sortedMetasets=t.slice(0).sort(hg("order","index"))}_removeUnreferencedMetasets(){let{_metasets:t,data:{datasets:e}}=this;t.length>e.length&&delete this._stacks,t.forEach((t,i)=>{0===e.filter(e=>e===t._dataset).length&&this._destroyDatasetMeta(i)})}buildOrUpdateControllers(){let t,e,i=[],s=this.data.datasets;for(this._removeUnreferencedMetasets(),t=0,e=s.length;t<e;t++){let e=s[t],r=this.getDatasetMeta(t),a=e.type||this.config.type;if(r.type&&r.type!==a&&(this._destroyDatasetMeta(t),r=this.getDatasetMeta(t)),r.type=a,r.indexAxis=e.indexAxis||o7(a,this.options),r.order=e.order||0,r.index=t,r.label=""+e.label,r.visible=this.isDatasetVisible(t),r.controller)r.controller.updateIndex(t),r.controller.linkScales();else{let e=o6.getController(a),{datasetElementType:s,dataElementType:n}=n2.datasets[a];Object.assign(e,{dataElementType:o6.getElement(n),datasetElementType:s&&o6.getElement(s)}),r.controller=new e(this,t),i.push(r.controller)}}return this._updateMetasets(),i}_resetElements(){a0(this.data.datasets,(t,e)=>{this.getDatasetMeta(e).controller.reset()},this)}reset(){this._resetElements(),this.notifyPlugins("reset")}update(t){let e=this.config;e.update();let i=this._options=e.createResolver(e.chartOptionScopes(),this.getContext()),s=this._animationsDisabled=!i.animation;if(this._updateScales(),this._checkEventBindings(),this._updateHiddenIndices(),this._plugins.invalidate(),!1===this.notifyPlugins("beforeUpdate",{mode:t,cancelable:!0}))return;let r=this.buildOrUpdateControllers();this.notifyPlugins("beforeElementsUpdate");let a=0;for(let t=0,e=this.data.datasets.length;t<e;t++){let{controller:e}=this.getDatasetMeta(t),i=!s&&-1===r.indexOf(e);e.buildOrUpdateElements(i),a=Math.max(+e.getMaxOverflow(),a)}a=this._minPadding=i.layout.autoPadding?a:0,this._updateLayout(a),s||a0(r,t=>{t.reset()}),this._updateDatasets(t),this.notifyPlugins("afterUpdate",{mode:t}),this._layers.sort(hg("z","_idx"));let{_active:n,_lastEvent:l}=this;l?this._eventHandler(l,!0):n.length&&this._updateHoverStyles(n,n,!0),this.render()}_updateScales(){a0(this.scales,t=>{ow.removeBox(this,t)}),this.ensureScalesHaveIDs(),this.buildOrUpdateScales()}_checkEventBindings(){let t=this.options;ns(new Set(Object.keys(this._listeners)),new Set(t.events))&&!!this._responsiveListeners===t.responsive||(this.unbindEvents(),this.bindEvents())}_updateHiddenIndices(){let{_hiddenIndices:t}=this;for(let{method:i,start:s,count:r}of this._getUniformDataChanges()||[]){var e="_removeElements"===i?-r:r;for(let i of Object.keys(t)){let r=+i;if(r>=s){let a=t[i];delete t[i],(e>0||r>s)&&(t[r+e]=a)}}}}_getUniformDataChanges(){let t=this._dataChanges;if(!t||!t.length)return;this._dataChanges=[];let e=this.data.datasets.length,i=e=>new Set(t.filter(t=>t[0]===e).map((t,e)=>e+","+t.splice(1).join(","))),s=i(0);for(let t=1;t<e;t++)if(!ns(s,i(t)))return;return Array.from(s).map(t=>t.split(",")).map(t=>({method:t[1],start:+t[2],count:+t[3]}))}_updateLayout(t){if(!1===this.notifyPlugins("beforeLayout",{cancelable:!0}))return;ow.update(this,this.width,this.height,t);let e=this.chartArea,i=e.width<=0||e.height<=0;this._layers=[],a0(this.boxes,t=>{i&&"chartArea"===t.position||(t.configure&&t.configure(),this._layers.push(...t._layers()))},this),this._layers.forEach((t,e)=>{t._idx=e}),this.notifyPlugins("afterLayout")}_updateDatasets(t){if(!1!==this.notifyPlugins("beforeDatasetsUpdate",{mode:t,cancelable:!0})){for(let t=0,e=this.data.datasets.length;t<e;++t)this.getDatasetMeta(t).controller.configure();for(let e=0,i=this.data.datasets.length;e<i;++e)this._updateDataset(e,ni(t)?t({datasetIndex:e}):t);this.notifyPlugins("afterDatasetsUpdate",{mode:t})}}_updateDataset(t,e){let i=this.getDatasetMeta(t),s={meta:i,index:t,mode:e,cancelable:!0};!1!==this.notifyPlugins("beforeDatasetUpdate",s)&&(i.controller._update(e),s.cancelable=!1,this.notifyPlugins("afterDatasetUpdate",s))}render(){!1!==this.notifyPlugins("beforeRender",{cancelable:!0})&&(l5.has(this)?this.attached&&!l5.running(this)&&l5.start(this):(this.draw(),hp({chart:this})))}draw(){let t;if(this._resizeBeforeDraw){let{width:t,height:e}=this._resizeBeforeDraw;this._resizeBeforeDraw=null,this._resize(t,e)}if(this.clear(),this.width<=0||this.height<=0||!1===this.notifyPlugins("beforeDraw",{cancelable:!0}))return;let e=this._layers;for(t=0;t<e.length&&e[t].z<=0;++t)e[t].draw(this.chartArea);for(this._drawDatasets();t<e.length;++t)e[t].draw(this.chartArea);this.notifyPlugins("afterDraw")}_getSortedDatasetMetas(t){let e,i,s=this._sortedMetasets,r=[];for(e=0,i=s.length;e<i;++e){let i=s[e];(!t||i.visible)&&r.push(i)}return r}getSortedVisibleDatasetMetas(){return this._getSortedDatasetMetas(!0)}_drawDatasets(){if(!1===this.notifyPlugins("beforeDatasetsDraw",{cancelable:!0}))return;let t=this.getSortedVisibleDatasetMetas();for(let e=t.length-1;e>=0;--e)this._drawDataset(t[e]);this.notifyPlugins("afterDatasetsDraw")}_drawDataset(t){let e=this.ctx,i={meta:t,index:t.index,cancelable:!0},s=l2(this,t);!1!==this.notifyPlugins("beforeDatasetDraw",i)&&(s&&n7(e,s),t.controller.draw(),s&&lt(e),i.cancelable=!1,this.notifyPlugins("afterDatasetDraw",i))}isPointInArea(t){return n9(t,this.chartArea,this._minPadding)}getElementsAtEventForMode(t,e,i,s){let r=o_.modes[e];return"function"==typeof r?r(this,t,i,s):[]}getDatasetMeta(t){let e=this.data.datasets[t],i=this._metasets,s=i.filter(t=>t&&t._dataset===e).pop();return s||(s={type:null,data:[],dataset:null,controller:null,hidden:null,xAxisID:null,yAxisID:null,order:e&&e.order||0,index:t,_dataset:e,_parsed:[],_sorted:!1},i.push(s)),s}getContext(){return this.$context||(this.$context=lg(null,{chart:this,type:"chart"}))}getVisibleDatasetCount(){return this.getSortedVisibleDatasetMetas().length}isDatasetVisible(t){let e=this.data.datasets[t];if(!e)return!1;let i=this.getDatasetMeta(t);return"boolean"==typeof i.hidden?!i.hidden:!e.hidden}setDatasetVisibility(t,e){this.getDatasetMeta(t).hidden=!e}toggleDataVisibility(t){this._hiddenIndices[t]=!this._hiddenIndices[t]}getDataVisibility(t){return!this._hiddenIndices[t]}_updateVisibility(t,e,i){let s=i?"show":"hide",r=this.getDatasetMeta(t),a=r.controller._resolveAnimations(void 0,s);ne(e)?(r.data[e].hidden=!i,this.update()):(this.setDatasetVisibility(t,i),a.update(r,{visible:i}),this.update(e=>e.datasetIndex===t?s:void 0))}hide(t,e){this._updateVisibility(t,e,!1)}show(t,e){this._updateVisibility(t,e,!0)}_destroyDatasetMeta(t){let e=this._metasets[t];e&&e.controller&&e.controller._destroy(),delete this._metasets[t]}_stop(){let t,e;for(this.stop(),l5.remove(this),t=0,e=this.data.datasets.length;t<e;++t)this._destroyDatasetMeta(t)}destroy(){this.notifyPlugins("beforeDestroy");let{canvas:t,ctx:e}=this;this._stop(),this.config.clearCache(),t&&(this.unbindEvents(),n4(t,e),this.platform.releaseContext(e),this.canvas=null,this.ctx=null),delete hv[this.id],this.notifyPlugins("afterDestroy")}toBase64Image(...t){return this.canvas.toDataURL(...t)}bindEvents(){this.bindUserEvents(),this.options.responsive?this.bindResponsiveEvents():this.attached=!0}bindUserEvents(){let t=this._listeners,e=this.platform,i=(i,s)=>{e.addEventListener(this,i,s),t[i]=s},s=(t,e,i)=>{t.offsetX=e,t.offsetY=i,this._eventHandler(t)};a0(this.options.events,t=>i(t,s))}bindResponsiveEvents(){let t;this._responsiveListeners||(this._responsiveListeners={});let e=this._responsiveListeners,i=this.platform,s=(t,s)=>{i.addEventListener(this,t,s),e[t]=s},r=(t,s)=>{e[t]&&(i.removeEventListener(this,t,s),delete e[t])},a=(t,e)=>{this.canvas&&this.resize(t,e)},n=()=>{r("attach",n),this.attached=!0,this.resize(),s("resize",a),s("detach",t)};t=()=>{this.attached=!1,r("resize",a),this._stop(),this._resize(0,0),s("attach",n)},i.isAttached(this.canvas)?n():t()}unbindEvents(){a0(this._listeners,(t,e)=>{this.platform.removeEventListener(this,e,t)}),this._listeners={},a0(this._responsiveListeners,(t,e)=>{this.platform.removeEventListener(this,e,t)}),this._responsiveListeners=void 0}updateHoverStyle(t,e,i){let s,r,a,n=i?"set":"remove";for("dataset"===e&&this.getDatasetMeta(t[0].datasetIndex).controller["_"+n+"DatasetHoverStyle"](),r=0,a=t.length;r<a;++r){let e=(s=t[r])&&this.getDatasetMeta(s.datasetIndex).controller;e&&e[n+"HoverStyle"](s.element,s.datasetIndex,s.index)}}getActiveElements(){return this._active||[]}setActiveElements(t){let e=this._active||[],i=t.map(({datasetIndex:t,index:e})=>{let i=this.getDatasetMeta(t);if(!i)throw Error("No dataset found at index "+t);return{datasetIndex:t,element:i.data[e],index:e}});a1(i,e)||(this._active=i,this._lastEvent=null,this._updateHoverStyles(i,e))}notifyPlugins(t,e,i){return this._plugins.notify(this,t,e,i)}isPluginEnabled(t){return 1===this._plugins._cache.filter(e=>e.plugin.id===t).length}_updateHoverStyles(t,e,i){let s=this.options.hover,r=(t,e)=>t.filter(t=>!e.some(e=>t.datasetIndex===e.datasetIndex&&t.index===e.index)),a=r(e,t),n=i?t:r(t,e);a.length&&this.updateHoverStyle(a,s.mode,!1),n.length&&s.mode&&this.updateHoverStyle(n,s.mode,!0)}_eventHandler(t,e){let i={event:t,replay:e,cancelable:!0,inChartArea:this.isPointInArea(t)},s=e=>(e.options.events||this.options.events).includes(t.native.type);if(!1===this.notifyPlugins("beforeEvent",i,s))return;let r=this._handleEvent(t,e,i.inChartArea);return i.cancelable=!1,this.notifyPlugins("afterEvent",i,s),(r||i.changed)&&this.render(),this}_handleEvent(t,e,i){var s;let{_active:r=[],options:a}=this,n=this._getActiveElements(t,r,i,e),l="mouseup"===t.type||"click"===t.type||"contextmenu"===t.type,o=(s=this._lastEvent,i&&"mouseout"!==t.type?l?s:t:null);i&&(this._lastEvent=null,aJ(a.onHover,[t,n,this],this),l&&aJ(a.onClick,[t,n,this],this));let h=!a1(n,r);return(h||e)&&(this._active=n,this._updateHoverStyles(n,r,e)),this._lastEvent=o,h}_getActiveElements(t,e,i,s){if("mouseout"===t.type)return[];if(!i)return e;let r=this.options.hover;return this.getElementsAtEventForMode(t,r.mode,r,s)}}function hb(){return a0(hT.instances,t=>t._plugins.invalidate())}function hS(t,e,i,s){return{x:i+t*Math.cos(e),y:s+t*Math.sin(e)}}function hA(t,e,i,s,r,a){let{x:n,y:l,startAngle:o,pixelMargin:h,innerRadius:d}=e,u=Math.max(e.outerRadius+s+i-h,0),c=d>0?d+s+i+h:0,f=0,g=r-o;if(s){let t=u>0?u-s:0,e=((d>0?d-s:0)+t)/2;f=(g-(0!==e?g*e/(e+s):g))/2}let p=Math.max(.001,g*u-i/nr)/u,m=(g-p)/2,y=o+m+f,v=r-m-f,{outerStart:E,outerEnd:T,innerStart:b,innerEnd:S}=function(t,e,i,s){let r=lo(t.options.borderRadius,["outerStart","outerEnd","innerStart","innerEnd"]),a=(i-e)/2,n=Math.min(a,s*e/2),l=t=>{let e=(i-Math.min(a,t))*s/2;return nx(t,0,Math.min(a,e))};return{outerStart:l(r.outerStart),outerEnd:l(r.outerEnd),innerStart:nx(r.innerStart,0,n),innerEnd:nx(r.innerEnd,0,n)}}(e,c,u,v-y),A=u-E,_=u-T,x=y+E/A,L=v-T/_,I=c+b,R=c+S,D=y+b/I,k=v-S/R;if(t.beginPath(),a){let e=(x+L)/2;if(t.arc(n,l,u,x,e),t.arc(n,l,u,e,L),T>0){let e=hS(_,L,n,l);t.arc(e.x,e.y,T,L,v+nh)}let i=hS(R,v,n,l);if(t.lineTo(i.x,i.y),S>0){let e=hS(R,k,n,l);t.arc(e.x,e.y,S,v+nh,k+Math.PI)}let s=(v-S/c+(y+b/c))/2;if(t.arc(n,l,c,v-S/c,s,!0),t.arc(n,l,c,s,y+b/c,!0),b>0){let e=hS(I,D,n,l);t.arc(e.x,e.y,b,D+Math.PI,y-nh)}let r=hS(A,y,n,l);if(t.lineTo(r.x,r.y),E>0){let e=hS(A,x,n,l);t.arc(e.x,e.y,E,y-nh,x)}}else{t.moveTo(n,l);let e=Math.cos(x)*u+n,i=Math.sin(x)*u+l;t.lineTo(e,i);let s=Math.cos(L)*u+n,r=Math.sin(L)*u+l;t.lineTo(s,r)}t.closePath()}function h_(t,e,i=e){t.lineCap=aX(i.borderCapStyle,e.borderCapStyle),t.setLineDash(aX(i.borderDash,e.borderDash)),t.lineDashOffset=aX(i.borderDashOffset,e.borderDashOffset),t.lineJoin=aX(i.borderJoinStyle,e.borderJoinStyle),t.lineWidth=aX(i.borderWidth,e.borderWidth),t.strokeStyle=aX(i.borderColor,e.borderColor)}function hx(t,e,i){t.lineTo(i.x,i.y)}function hL(t,e,i={}){let s=t.length,{start:r=0,end:a=s-1}=i,{start:n,end:l}=e,o=Math.max(r,n),h=Math.min(a,l);return{count:s,start:o,loop:e.loop,ilen:h<o&&!(r<n&&a<n||r>l&&a>l)?s+h-o:h-o}}function hI(t,e,i,s){let r,a,n,{points:l,options:o}=e,{count:h,start:d,loop:u,ilen:c}=hL(l,i,s),f=o.stepped?le:o.tension||"monotone"===o.cubicInterpolationMode?li:hx,{move:g=!0,reverse:p}=s||{};for(r=0;r<=c;++r)(a=l[(d+(p?c-r:r))%h]).skip||(g?(t.moveTo(a.x,a.y),g=!1):f(t,n,a,p,o.stepped),n=a);return u&&f(t,n,a=l[(d+(p?c:0))%h],p,o.stepped),!!u}function hR(t,e,i,s){let r,a,n,l,o,h,d=e.points,{count:u,start:c,ilen:f}=hL(d,i,s),{move:g=!0,reverse:p}=s||{},m=0,y=0,v=t=>(c+(p?f-t:t))%u,E=()=>{l!==o&&(t.lineTo(m,o),t.lineTo(m,l),t.lineTo(m,h))};for(g&&(a=d[v(0)],t.moveTo(a.x,a.y)),r=0;r<=f;++r){if((a=d[v(r)]).skip)continue;let e=a.x,i=a.y,s=0|e;s===n?(i<l?l=i:i>o&&(o=i),m=(y*m+e)/++y):(E(),t.lineTo(e,i),n=s,y=0,l=o=i),h=i}E()}function hD(t){let e=t.options,i=e.borderDash&&e.borderDash.length;return t._decimated||t._loop||e.tension||"monotone"===e.cubicInterpolationMode||e.stepped||i?hI:hR}const hk="function"==typeof Path2D;class hP extends oQ{static id="line";static defaults={borderCapStyle:"butt",borderDash:[],borderDashOffset:0,borderJoinStyle:"miter",borderWidth:3,capBezierPoints:!0,cubicInterpolationMode:"default",fill:!1,spanGaps:!1,stepped:!1,tension:0};static defaultRoutes={backgroundColor:"backgroundColor",borderColor:"borderColor"};static descriptors={_scriptable:!0,_indexable:t=>"borderDash"!==t&&"fill"!==t};constructor(t){super(),this.animated=!0,this.options=void 0,this._chart=void 0,this._loop=void 0,this._fullLoop=void 0,this._path=void 0,this._points=void 0,this._segments=void 0,this._decimated=!1,this._pointsUpdated=!1,this._datasetIndex=void 0,t&&Object.assign(this,t)}updateControlPoints(t,e){let i=this.options;if((i.tension||"monotone"===i.cubicInterpolationMode)&&!i.stepped&&!this._pointsUpdated){let s=i.spanGaps?this._loop:this._fullLoop;!function(t,e,i,s,r){let a,n,l,o;if(e.spanGaps&&(t=t.filter(t=>!t.skip)),"monotone"===e.cubicInterpolationMode)!function(t,e="x"){let i,s,r,a=lD(e),n=t.length,l=Array(n).fill(0),o=Array(n),h=lR(t,0);for(i=0;i<n;++i)if(s=r,r=h,h=lR(t,i+1),r){if(h){let t=h[e]-r[e];l[i]=0!==t?(h[a]-r[a])/t:0}o[i]=s?h?nf(l[i-1])!==nf(l[i])?0:(l[i-1]+l[i])/2:l[i-1]:l[i]}!function(t,e,i){let s,r,a,n,l,o=t.length,h=lR(t,0);for(let d=0;d<o-1;++d)if(l=h,h=lR(t,d+1),l&&h){if(ng(e[d],0,lI)){i[d]=i[d+1]=0;continue}(n=Math.pow(s=i[d]/e[d],2)+Math.pow(r=i[d+1]/e[d],2))<=9||(a=3/Math.sqrt(n),i[d]=s*a*e[d],i[d+1]=r*a*e[d])}}(t,l,o),function(t,e,i="x"){let s,r,a,n=lD(i),l=t.length,o=lR(t,0);for(let h=0;h<l;++h){if(r=a,a=o,o=lR(t,h+1),!a)continue;let l=a[i],d=a[n];r&&(s=(l-r[i])/3,a[`cp1${i}`]=l-s,a[`cp1${n}`]=d-s*e[h]),o&&(s=(o[i]-l)/3,a[`cp2${i}`]=l+s,a[`cp2${n}`]=d+s*e[h])}}(t,o,e)}(t,r);else{let i=s?t[t.length-1]:t[0];for(a=0,n=t.length;a<n;++a)o=function(t,e,i,s){let r=t.skip?e:t,a=i.skip?e:i,n=nb(e,r),l=nb(a,e),o=n/(n+l),h=l/(n+l);o=isNaN(o)?0:o,h=isNaN(h)?0:h;let d=s*o,u=s*h;return{previous:{x:e.x-d*(a.x-r.x),y:e.y-d*(a.y-r.y)},next:{x:e.x+u*(a.x-r.x),y:e.y+u*(a.y-r.y)}}}(i,l=t[a],t[Math.min(a+1,n-!s)%n],e.tension),l.cp1x=o.previous.x,l.cp1y=o.previous.y,l.cp2x=o.next.x,l.cp2y=o.next.y,i=l}e.capBezierPoints&&function(t,e){let i,s,r,a,n,l=n9(t[0],e);for(i=0,s=t.length;i<s;++i)n=a,a=l,l=i<s-1&&n9(t[i+1],e),a&&(r=t[i],n&&(r.cp1x=lk(r.cp1x,e.left,e.right),r.cp1y=lk(r.cp1y,e.top,e.bottom)),l&&(r.cp2x=lk(r.cp2x,e.left,e.right),r.cp2y=lk(r.cp2y,e.top,e.bottom)))}(t,i)}(this._points,i,t,s,e),this._pointsUpdated=!0}}set points(t){this._points=t,delete this._segments,delete this._path,this._pointsUpdated=!1}get points(){return this._points}get segments(){return this._segments||(this._segments=function(t,e){let i=t.points,s=t.options.spanGaps,r=i.length;if(!r)return[];let a=!!t._loop,{start:n,end:l}=function(t,e,i,s){let r=0,a=e-1;if(i&&!s)for(;r<e&&!t[r].skip;)r++;for(;r<e&&t[r].skip;)r++;for(r%=e,i&&(a+=r);a>r&&t[a%e].skip;)a--;return{start:r,end:a%=e}}(i,r,a,s);if(!0===s)return lJ(t,[{start:n,end:l,loop:a}],i,e);let o=l<n?l+r:l,h=!!t._fullLoop&&0===n&&l===r-1;return lJ(t,function(t,e,i,s){let r,a=t.length,n=[],l=e,o=t[e];for(r=e+1;r<=i;++r){let i=t[r%a];i.skip||i.stop?o.skip||(s=!1,n.push({start:e%a,end:(r-1)%a,loop:s}),e=l=i.stop?r:null):(l=r,o.skip&&(e=r)),o=i}return null!==l&&n.push({start:e%a,end:l%a,loop:s}),n}(i,n,o,h),i,e)}(this,this.options.segment))}first(){let t=this.segments,e=this.points;return t.length&&e[t[0].start]}last(){let t=this.segments,e=this.points,i=t.length;return i&&e[t[i-1].end]}interpolate(t,e){let i,s,r=this.options,a=t[e],n=this.points,l=lZ(this,{property:e,start:a,end:a});if(!l.length)return;let o=[],h=r.stepped?lK:r.tension||"monotone"===r.cubicInterpolationMode?lW:lH;for(i=0,s=l.length;i<s;++i){let{start:s,end:d}=l[i],u=n[s],c=n[d];if(u===c){o.push(u);continue}let f=Math.abs((a-u[e])/(c[e]-u[e])),g=h(u,c,f,r.stepped);g[e]=t[e],o.push(g)}return 1===o.length?o[0]:o}pathSegment(t,e,i){return hD(this)(t,this,e,i)}path(t,e,i){let s=this.segments,r=hD(this),a=this._loop;for(let n of(e=e||0,i=i||this.points.length-e,s))a&=r(t,this,n,{start:e,end:e+i-1});return!!a}draw(t,e,i,s){let r=this.options||{};(this.points||[]).length&&r.borderWidth&&(t.save(),function(t,e,i,s){if(hk&&!e.options.segment){let r;(r=e._path)||(r=e._path=new Path2D,e.path(r,i,s)&&r.closePath()),h_(t,e.options),t.stroke(r)}else{let{segments:r,options:a}=e,n=hD(e);for(let l of r)h_(t,a,l.style),t.beginPath(),n(t,e,l,{start:i,end:i+s-1})&&t.closePath(),t.stroke()}}(t,this,i,s),t.restore()),this.animated&&(this._pointsUpdated=!1,this._path=void 0)}}function hC(t,e,i,s){let r=t.options,{[i]:a}=t.getProps([i],s);return Math.abs(e-a)<r.radius+r.hitRadius}function hM(t,e){let i,s,r,a,n,{x:l,y:o,base:h,width:d,height:u}=t.getProps(["x","y","base","width","height"],e);return t.horizontal?(n=u/2,i=Math.min(l,h),s=Math.max(l,h),r=o-n,a=o+n):(i=l-(n=d/2),s=l+n,r=Math.min(o,h),a=Math.max(o,h)),{left:i,top:r,right:s,bottom:a}}function hw(t,e,i,s){return t?0:nx(e,i,s)}function hO(t,e,i,s){let r=null===e,a=null===i,n=t&&!(r&&a)&&hM(t,s);return n&&(r||nL(e,n.left,n.right))&&(a||nL(i,n.top,n.bottom))}function hF(t,e){t.rect(e.x,e.y,e.w,e.h)}function hN(t,e,i={}){let s=t.x!==i.x?-e:0,r=t.y!==i.y?-e:0,a=(t.x+t.w!==i.x+i.w?e:0)-s,n=(t.y+t.h!==i.y+i.h?e:0)-r;return{x:t.x+s,y:t.y+r,w:t.w+a,h:t.h+n,radius:t.radius}}var hB=Object.freeze({__proto__:null,ArcElement:class extends oQ{static id="arc";static defaults={borderAlign:"center",borderColor:"#fff",borderDash:[],borderDashOffset:0,borderJoinStyle:void 0,borderRadius:0,borderWidth:2,offset:0,spacing:0,angle:void 0,circular:!0};static defaultRoutes={backgroundColor:"backgroundColor"};static descriptors={_scriptable:!0,_indexable:t=>"borderDash"!==t};circumference;endAngle;fullCircles;innerRadius;outerRadius;pixelMargin;startAngle;constructor(t){super(),this.options=void 0,this.circumference=void 0,this.startAngle=void 0,this.endAngle=void 0,this.innerRadius=void 0,this.outerRadius=void 0,this.pixelMargin=0,this.fullCircles=0,t&&Object.assign(this,t)}inRange(t,e,i){let{angle:s,distance:r}=nT(this.getProps(["x","y"],i),{x:t,y:e}),{startAngle:a,endAngle:n,innerRadius:l,outerRadius:o,circumference:h}=this.getProps(["startAngle","endAngle","innerRadius","outerRadius","circumference"],i),d=(this.options.spacing+this.options.borderWidth)/2,u=aX(h,n-a),c=n_(s,a,n)&&a!==n,f=u>=na||c,g=nL(r,l+d,o+d);return f&&g}getCenterPoint(t){let{x:e,y:i,startAngle:s,endAngle:r,innerRadius:a,outerRadius:n}=this.getProps(["x","y","startAngle","endAngle","innerRadius","outerRadius"],t),{offset:l,spacing:o}=this.options,h=(s+r)/2,d=(a+n+o+l)/2;return{x:e+Math.cos(h)*d,y:i+Math.sin(h)*d}}tooltipPosition(t){return this.getCenterPoint(t)}draw(t){let{options:e,circumference:i}=this,s=(e.offset||0)/4,r=(e.spacing||0)/2,a=e.circular;if(this.pixelMargin=.33*("inner"===e.borderAlign),this.fullCircles=i>na?Math.floor(i/na):0,0===i||this.innerRadius<0||this.outerRadius<0)return;t.save();let n=(this.startAngle+this.endAngle)/2;t.translate(Math.cos(n)*s,Math.sin(n)*s);let l=s*(1-Math.sin(Math.min(nr,i||0)));t.fillStyle=e.backgroundColor,t.strokeStyle=e.borderColor,function(t,e,i,s,r){let{fullCircles:a,startAngle:n,circumference:l}=e,o=e.endAngle;if(a){hA(t,e,i,s,o,r);for(let e=0;e<a;++e)t.fill();isNaN(l)||(o=n+(l%na||na))}hA(t,e,i,s,o,r),t.fill()}(t,this,l,r,a),function(t,e,i,s,r){let{fullCircles:a,startAngle:n,circumference:l,options:o}=e,{borderWidth:h,borderJoinStyle:d,borderDash:u,borderDashOffset:c}=o,f="inner"===o.borderAlign;if(!h)return;t.setLineDash(u||[]),t.lineDashOffset=c,f?(t.lineWidth=2*h,t.lineJoin=d||"round"):(t.lineWidth=h,t.lineJoin=d||"bevel");let g=e.endAngle;if(a){hA(t,e,i,s,g,r);for(let e=0;e<a;++e)t.stroke();isNaN(l)||(g=n+(l%na||na))}f&&function(t,e,i){let{startAngle:s,pixelMargin:r,x:a,y:n,outerRadius:l,innerRadius:o}=e,h=r/l;t.beginPath(),t.arc(a,n,l,s-h,i+h),o>r?(h=r/o,t.arc(a,n,o,i+h,s-h,!0)):t.arc(a,n,r,i+nh,s-nh),t.closePath(),t.clip()}(t,e,g),a||(hA(t,e,i,s,g,r),t.stroke())}(t,this,l,r,a),t.restore()}},BarElement:class extends oQ{static id="bar";static defaults={borderSkipped:"start",borderWidth:0,borderRadius:0,inflateAmount:"auto",pointStyle:void 0};static defaultRoutes={backgroundColor:"backgroundColor",borderColor:"borderColor"};constructor(t){super(),this.options=void 0,this.horizontal=void 0,this.base=void 0,this.width=void 0,this.height=void 0,this.inflateAmount=void 0,t&&Object.assign(this,t)}draw(t){var e;let{inflateAmount:i,options:{borderColor:s,backgroundColor:r}}=this,{inner:a,outer:n}=function(t){let e=hM(t),i=e.right-e.left,s=e.bottom-e.top,r=function(t,e,i){let s=t.options.borderWidth,r=t.borderSkipped,a=lh(s);return{t:hw(r.top,a.top,0,i),r:hw(r.right,a.right,0,e),b:hw(r.bottom,a.bottom,0,i),l:hw(r.left,a.left,0,e)}}(t,i/2,s/2),a=function(t,e,i){let{enableBorderRadius:s}=t.getProps(["enableBorderRadius"]),r=t.options.borderRadius,a=ld(r),n=Math.min(e,i),l=t.borderSkipped,o=s||aj(r);return{topLeft:hw(!o||l.top||l.left,a.topLeft,0,n),topRight:hw(!o||l.top||l.right,a.topRight,0,n),bottomLeft:hw(!o||l.bottom||l.left,a.bottomLeft,0,n),bottomRight:hw(!o||l.bottom||l.right,a.bottomRight,0,n)}}(t,i/2,s/2);return{outer:{x:e.left,y:e.top,w:i,h:s,radius:a},inner:{x:e.left+r.l,y:e.top+r.t,w:i-r.l-r.r,h:s-r.t-r.b,radius:{topLeft:Math.max(0,a.topLeft-Math.max(r.t,r.l)),topRight:Math.max(0,a.topRight-Math.max(r.t,r.r)),bottomLeft:Math.max(0,a.bottomLeft-Math.max(r.b,r.l)),bottomRight:Math.max(0,a.bottomRight-Math.max(r.b,r.r))}}}}(this),l=(e=n.radius).topLeft||e.topRight||e.bottomLeft||e.bottomRight?lr:hF;t.save(),(n.w!==a.w||n.h!==a.h)&&(t.beginPath(),l(t,hN(n,i,a)),t.clip(),l(t,hN(a,-i,n)),t.fillStyle=s,t.fill("evenodd")),t.beginPath(),l(t,hN(a,i)),t.fillStyle=r,t.fill(),t.restore()}inRange(t,e,i){return hO(this,t,e,i)}inXRange(t,e){return hO(this,t,null,e)}inYRange(t,e){return hO(this,null,t,e)}getCenterPoint(t){let{x:e,y:i,base:s,horizontal:r}=this.getProps(["x","y","base","horizontal"],t);return{x:r?(e+s)/2:e,y:r?i:(i+s)/2}}getRange(t){return"x"===t?this.width/2:this.height/2}},LineElement:hP,PointElement:class extends oQ{static id="point";parsed;skip;stop;static defaults={borderWidth:1,hitRadius:1,hoverBorderWidth:1,hoverRadius:4,pointStyle:"circle",radius:3,rotation:0};static defaultRoutes={backgroundColor:"backgroundColor",borderColor:"borderColor"};constructor(t){super(),this.options=void 0,this.parsed=void 0,this.skip=void 0,this.stop=void 0,t&&Object.assign(this,t)}inRange(t,e,i){let s=this.options,{x:r,y:a}=this.getProps(["x","y"],i);return Math.pow(t-r,2)+Math.pow(e-a,2)<Math.pow(s.hitRadius+s.radius,2)}inXRange(t,e){return hC(this,t,"x",e)}inYRange(t,e){return hC(this,t,"y",e)}getCenterPoint(t){let{x:e,y:i}=this.getProps(["x","y"],t);return{x:e,y:i}}size(t){let e=(t=t||this.options||{}).radius||0,i=(e=Math.max(e,e&&t.hoverRadius||0))&&t.borderWidth||0;return(e+i)*2}draw(t,e){let i=this.options;!this.skip&&!(i.radius<.1)&&n9(this,e,this.size(i)/2)&&(t.strokeStyle=i.borderColor,t.lineWidth=i.borderWidth,t.fillStyle=i.backgroundColor,n8(t,i,this.x,this.y))}getRange(){let t=this.options||{};return t.radius+t.hitRadius}}});const hU=["rgb(54, 162, 235)","rgb(255, 99, 132)","rgb(255, 159, 64)","rgb(255, 205, 86)","rgb(75, 192, 192)","rgb(153, 102, 255)","rgb(201, 203, 207)"],h$=hU.map(t=>t.replace("rgb(","rgba(").replace(")",", 0.5)"));function hG(t){return hU[t%hU.length]}function hV(t){return h$[t%h$.length]}function hH(t){let e;for(e in t)if(t[e].borderColor||t[e].backgroundColor)return!0;return!1}function hK(t){if(t._decimated){let e=t._data;delete t._decimated,delete t._data,Object.defineProperty(t,"data",{configurable:!0,enumerable:!0,writable:!0,value:e})}}function hW(t){t.data.datasets.forEach(t=>{hK(t)})}function hY(t,e,i,s){if(s)return;let r=e[t],a=i[t];return"angle"===t&&(r=nA(r),a=nA(a)),{property:t,start:r,end:a}}function hj(t,e,i){for(;e>t;e--){let t=i[e];if(!isNaN(t.x)&&!isNaN(t.y))break}return e}function hz(t,e,i,s){return t&&e?s(t[i],e[i]):t?t[i]:e?e[i]:0}function hq(t,e){let i=[],s=!1;return aY(t)?(s=!0,i=t):i=function(t,e){let{x:i=null,y:s=null}=t||{},r=e.points,a=[];return e.segments.forEach(({start:t,end:e})=>{e=hj(t,e,r);let n=r[t],l=r[e];null!==s?(a.push({x:n.x,y:s}),a.push({x:l.x,y:s})):null!==i&&(a.push({x:i,y:n.y}),a.push({x:i,y:l.y}))}),a}(t,e),i.length?new hP({points:i,options:{tension:0},_loop:s,_fullLoop:s}):null}function hX(t){return t&&!1!==t.fill}class hQ{constructor(t){this.x=t.x,this.y=t.y,this.radius=t.radius}pathSegment(t,e,i){let{x:s,y:r,radius:a}=this;return e=e||{start:0,end:na},t.arc(s,r,a,e.end,e.start,!0),!i.bounds}interpolate(t){let{x:e,y:i,radius:s}=this,r=t.angle;return{x:e+Math.cos(r)*s,y:i+Math.sin(r)*s,angle:r}}}function hZ(t,e,i){let s=function(t){let{chart:e,fill:i,line:s}=t;if(az(i)){var r,a=e,n=i;let t=a.getDatasetMeta(n);return t&&a.isDatasetVisible(n)?t.dataset:null}if("stack"===i)return function(t){let{scale:e,index:i,line:s}=t,r=[],a=s.segments,n=s.points,l=function(t,e){let i=[],s=t.getMatchingVisibleMetas("line");for(let t=0;t<s.length;t++){let r=s[t];if(r.index===e)break;r.hidden||i.unshift(r.dataset)}return i}(e,i);l.push(hq({x:null,y:e.bottom},s));for(let t=0;t<a.length;t++){let e=a[t];for(let t=e.start;t<=e.end;t++)!function(t,e,i){let s=[];for(let r=0;r<i.length;r++){let{first:a,last:n,point:l}=function(t,e,i){let s=t.interpolate(e,"x");if(!s)return{};let r=s[i],a=t.segments,n=t.points,l=!1,o=!1;for(let t=0;t<a.length;t++){let e=a[t],s=n[e.start][i],h=n[e.end][i];if(nL(r,s,h)){l=r===s,o=r===h;break}}return{first:l,last:o,point:s}}(i[r],e,"x");if(l&&(!a||!n)){if(a)s.unshift(l);else if(t.push(l),!n)break}}t.push(...s)}(r,n[t],l)}return new hP({points:r,options:{}})}(t);if("shape"===i)return!0;let l=((r=t).scale||{}).getPointPositionForValue?function(t){let e,{scale:i,fill:s}=t,r=i.options,a=i.getLabels().length,n=r.reverse?i.max:i.min,l="start"===s?n:"end"===s?i.options.reverse?i.min:i.max:aj(s)?s.value:i.getBaseValue(),o=[];if(r.grid.circular){let t=i.getPointPositionForValue(0,n);return new hQ({x:t.x,y:t.y,radius:i.getDistanceFromCenterForValue(l)})}for(let t=0;t<a;++t)o.push(i.getPointPositionForValue(t,l));return o}(r):function(t){let e,{scale:i={},fill:s}=t,r=(e=null,"start"===s?e=i.bottom:"end"===s?e=i.top:aj(s)?e=i.getPixelForValue(s.value):i.getBasePixel&&(e=i.getBasePixel()),e);if(az(r)){let t=i.isHorizontal();return{x:t?r:null,y:t?null:r}}return null}(r);return l instanceof hQ?l:hq(l,s)}(e),{chart:r,index:a,line:n,scale:l,axis:o}=e,h=n.options,d=h.fill,u=h.backgroundColor,{above:c=u,below:f=u}=d||{},g=r.getDatasetMeta(a),p=l2(r,g);s&&n.points.length&&(n7(t,i),function(t,e){let{line:i,target:s,above:r,below:a,area:n,scale:l,clip:o}=e,h=i._loop?"angle":e.axis;t.save(),"x"===h&&a!==r&&(hJ(t,s,n.top),h0(t,{line:i,target:s,color:r,scale:l,property:h,clip:o}),t.restore(),t.save(),hJ(t,s,n.bottom)),h0(t,{line:i,target:s,color:a,scale:l,property:h,clip:o}),t.restore()}(t,{line:n,target:s,above:c,below:f,area:i,scale:l,axis:o,clip:p}),lt(t))}function hJ(t,e,i){let{segments:s,points:r}=e,a=!0,n=!1;for(let l of(t.beginPath(),s)){let{start:s,end:o}=l,h=r[s],d=r[hj(s,o,r)];a?(t.moveTo(h.x,h.y),a=!1):(t.lineTo(h.x,i),t.lineTo(h.x,h.y)),(n=!!e.pathSegment(t,l,{move:n}))?t.closePath():t.lineTo(d.x,i)}t.lineTo(e.first().x,i),t.closePath(),t.clip()}function h0(t,e){let{line:i,target:s,property:r,color:a,scale:n,clip:l}=e;for(let{source:e,target:o,start:h,end:d}of function(t,e,i){let s=t.segments,r=t.points,a=e.points,n=[];for(let t of s){let{start:s,end:l}=t;l=hj(s,l,r);let o=hY(i,r[s],r[l],t.loop);if(!e.segments){n.push({source:t,target:o,start:r[s],end:r[l]});continue}for(let s of lZ(e,o)){let e=hY(i,a[s.start],a[s.end],s.loop);for(let a of lQ(t,r,e))n.push({source:a,target:s,start:{[i]:hz(o,e,"start",Math.max)},end:{[i]:hz(o,e,"end",Math.min)}})}}return n}(i,s,r)){let u,{style:{backgroundColor:c=a}={}}=e,f=!0!==s;t.save(),t.fillStyle=c,function(t,e,i,s){let r=e.chart.chartArea,{property:a,start:n,end:l}=s||{};if("x"===a||"y"===a){let e,s,o,h;"x"===a?(e=n,s=r.top,o=l,h=r.bottom):(e=r.left,s=n,o=r.right,h=l),t.beginPath(),i&&(e=Math.max(e,i.left),o=Math.min(o,i.right),s=Math.max(s,i.top),h=Math.min(h,i.bottom)),t.rect(e,s,o-e,h-s),t.clip()}}(t,n,l,f&&hY(r,h,d)),t.beginPath();let g=!!i.pathSegment(t,e);if(f){g?t.closePath():h1(t,s,d,r);let e=!!s.pathSegment(t,o,{move:g,reverse:!0});(u=g&&e)||h1(t,s,h,r)}t.closePath(),t.fill(u?"evenodd":"nonzero"),t.restore()}}function h1(t,e,i,s){let r=e.interpolate(i,s);r&&t.lineTo(r.x,r.y)}const h2=(t,e)=>{let{boxHeight:i=e,boxWidth:s=e}=t;return t.usePointStyle&&(i=Math.min(i,e),s=t.pointStyleWidth||Math.min(s,e)),{boxWidth:s,boxHeight:i,itemHeight:Math.max(e,i)}},h5=(t,e)=>null!==t&&null!==e&&t.datasetIndex===e.datasetIndex&&t.index===e.index;class h3 extends oQ{constructor(t){super(),this._added=!1,this.legendHitBoxes=[],this._hoveredItem=null,this.doughnutMode=!1,this.chart=t.chart,this.options=t.options,this.ctx=t.ctx,this.legendItems=void 0,this.columnSizes=void 0,this.lineWidths=void 0,this.maxHeight=void 0,this.maxWidth=void 0,this.top=void 0,this.bottom=void 0,this.left=void 0,this.right=void 0,this.height=void 0,this.width=void 0,this._margins=void 0,this.position=void 0,this.weight=void 0,this.fullSize=void 0}update(t,e,i){this.maxWidth=t,this.maxHeight=e,this._margins=i,this.setDimensions(),this.buildLabels(),this.fit()}setDimensions(){this.isHorizontal()?(this.width=this.maxWidth,this.left=this._margins.left,this.right=this.width):(this.height=this.maxHeight,this.top=this._margins.top,this.bottom=this.height)}buildLabels(){let t=this.options.labels||{},e=aJ(t.generateLabels,[this.chart],this)||[];t.filter&&(e=e.filter(e=>t.filter(e,this.chart.data))),t.sort&&(e=e.sort((e,i)=>t.sort(e,i,this.chart.data))),this.options.reverse&&e.reverse(),this.legendItems=e}fit(){let t,e,{options:i,ctx:s}=this;if(!i.display){this.width=this.height=0;return}let r=i.labels,a=lc(r.font),n=a.size,l=this._computeTitleHeight(),{boxWidth:o,itemHeight:h}=h2(r,n);s.font=a.string,this.isHorizontal()?(t=this.maxWidth,e=this._fitRows(l,n,o,h)+10):(e=this.maxHeight,t=this._fitCols(l,a,o,h)+10),this.width=Math.min(t,i.maxWidth||this.maxWidth),this.height=Math.min(e,i.maxHeight||this.maxHeight)}_fitRows(t,e,i,s){let{ctx:r,maxWidth:a,options:{labels:{padding:n}}}=this,l=this.legendHitBoxes=[],o=this.lineWidths=[0],h=s+n,d=t;r.textAlign="left",r.textBaseline="middle";let u=-1,c=-h;return this.legendItems.forEach((t,f)=>{let g=i+e/2+r.measureText(t.text).width;(0===f||o[o.length-1]+g+2*n>a)&&(d+=h,o[o.length-(f>0?0:1)]=0,c+=h,u++),l[f]={left:0,top:c,row:u,width:g,height:s},o[o.length-1]+=g+n}),d}_fitCols(t,e,i,s){let{ctx:r,maxHeight:a,options:{labels:{padding:n}}}=this,l=this.legendHitBoxes=[],o=this.columnSizes=[],h=a-t,d=n,u=0,c=0,f=0,g=0;return this.legendItems.forEach((t,a)=>{var p,m,y,v,E,T,b,S,A,_,x,L;let I,R,{itemWidth:D,itemHeight:k}=(p=i,m=e,y=r,v=t,E=s,{itemWidth:(T=v,b=p,S=m,A=y,(I=T.text)&&"string"!=typeof I&&(I=I.reduce((t,e)=>t.length>e.length?t:e)),b+S.size/2+A.measureText(I).width),itemHeight:(_=E,x=v,L=m.lineHeight,R=_,"string"!=typeof x.text&&(R=h4(x,L)),R)});a>0&&c+k+2*n>h&&(d+=u+n,o.push({width:u,height:c}),f+=u+n,g++,u=c=0),l[a]={left:f,top:c,col:g,width:D,height:k},u=Math.max(u,D),c+=k+n}),d+=u,o.push({width:u,height:c}),d}adjustHitBoxes(){if(!this.options.display)return;let t=this._computeTitleHeight(),{legendHitBoxes:e,options:{align:i,labels:{padding:s},rtl:r}}=this,a=lY(r,this.left,this.width);if(this.isHorizontal()){let r=0,n=nF(i,this.left+s,this.right-this.lineWidths[r]);for(let l of e)r!==l.row&&(r=l.row,n=nF(i,this.left+s,this.right-this.lineWidths[r])),l.top+=this.top+t+s,l.left=a.leftForLtr(a.x(n),l.width),n+=l.width+s}else{let r=0,n=nF(i,this.top+t+s,this.bottom-this.columnSizes[r].height);for(let l of e)l.col!==r&&(r=l.col,n=nF(i,this.top+t+s,this.bottom-this.columnSizes[r].height)),l.top=n,l.left+=this.left+s,l.left=a.leftForLtr(a.x(l.left),l.width),n+=l.height+s}}isHorizontal(){return"top"===this.options.position||"bottom"===this.options.position}draw(){if(this.options.display){let t=this.ctx;n7(t,this),this._draw(),lt(t)}}_draw(){let t,{options:e,columnSizes:i,lineWidths:s,ctx:r}=this,{align:a,labels:n}=e,l=n2.color,o=lY(e.rtl,this.left,this.width),h=lc(n.font),{padding:d}=n,u=h.size,c=u/2;this.drawTitle(),r.textAlign=o.textAlign("left"),r.textBaseline="middle",r.lineWidth=.5,r.font=h.string;let{boxWidth:f,boxHeight:g,itemHeight:p}=h2(n,u),m=function(t,e,i){if(isNaN(f)||f<=0||isNaN(g)||g<0)return;r.save();let s=aX(i.lineWidth,1);if(r.fillStyle=aX(i.fillStyle,l),r.lineCap=aX(i.lineCap,"butt"),r.lineDashOffset=aX(i.lineDashOffset,0),r.lineJoin=aX(i.lineJoin,"miter"),r.lineWidth=s,r.strokeStyle=aX(i.strokeStyle,l),r.setLineDash(aX(i.lineDash,[])),n.usePointStyle){let a={radius:g*Math.SQRT2/2,pointStyle:i.pointStyle,rotation:i.rotation,borderWidth:s};n6(r,a,o.xPlus(t,f/2),e+c,n.pointStyleWidth&&f)}else{let a=e+Math.max((u-g)/2,0),n=o.leftForLtr(t,f),l=ld(i.borderRadius);r.beginPath(),Object.values(l).some(t=>0!==t)?lr(r,{x:n,y:a,w:f,h:g,radius:l}):r.rect(n,a,f,g),r.fill(),0!==s&&r.stroke()}r.restore()},y=function(t,e,i){ls(r,i.text,t,e+p/2,h,{strikethrough:i.hidden,textAlign:o.textAlign(i.textAlign)})},v=this.isHorizontal(),E=this._computeTitleHeight();t=v?{x:nF(a,this.left+d,this.right-s[0]),y:this.top+d+E,line:0}:{x:this.left+d,y:nF(a,this.top+E+d,this.bottom-i[0].height),line:0},lj(this.ctx,e.textDirection);let T=p+d;this.legendItems.forEach((l,u)=>{r.strokeStyle=l.fontColor,r.fillStyle=l.fontColor;let g=r.measureText(l.text).width,p=o.textAlign(l.textAlign||(l.textAlign=n.textAlign)),b=f+c+g,S=t.x,A=t.y;if(o.setWidth(this.width),v?u>0&&S+b+d>this.right&&(A=t.y+=T,t.line++,S=t.x=nF(a,this.left+d,this.right-s[t.line])):u>0&&A+T>this.bottom&&(S=t.x=S+i[t.line].width+d,t.line++,A=t.y=nF(a,this.top+E+d,this.bottom-i[t.line].height)),m(o.x(S),A,l),S=nN(p,S+f+c,v?S+b:this.right,e.rtl),y(o.x(S),A,l),v)t.x+=b+d;else if("string"!=typeof l.text){let e=h.lineHeight;t.y+=h4(l,e)+d}else t.y+=T}),lz(this.ctx,e.textDirection)}drawTitle(){let t,e=this.options,i=e.title,s=lc(i.font),r=lu(i.padding);if(!i.display)return;let a=lY(e.rtl,this.left,this.width),n=this.ctx,l=i.position,o=s.size/2,h=r.top+o,d=this.left,u=this.width;if(this.isHorizontal())u=Math.max(...this.lineWidths),t=this.top+h,d=nF(e.align,d,this.right-u);else{let i=this.columnSizes.reduce((t,e)=>Math.max(t,e.height),0);t=h+nF(e.align,this.top,this.bottom-i-e.labels.padding-this._computeTitleHeight())}let c=nF(l,d,d+u);n.textAlign=a.textAlign(nO(l)),n.textBaseline="middle",n.strokeStyle=i.color,n.fillStyle=i.color,n.font=s.string,ls(n,i.text,c,t,s)}_computeTitleHeight(){let t=this.options.title,e=lc(t.font),i=lu(t.padding);return t.display?e.lineHeight+i.height:0}_getLegendItemAt(t,e){let i,s,r;if(nL(t,this.left,this.right)&&nL(e,this.top,this.bottom)){for(i=0,r=this.legendHitBoxes;i<r.length;++i)if(nL(t,(s=r[i]).left,s.left+s.width)&&nL(e,s.top,s.top+s.height))return this.legendItems[i]}return null}handleEvent(t){var e,i;let s=this.options;if(e=t.type,i=s,("mousemove"!==e&&"mouseout"!==e||!i.onHover&&!i.onLeave)&&(!i.onClick||"click"!==e&&"mouseup"!==e))return;let r=this._getLegendItemAt(t.x,t.y);if("mousemove"===t.type||"mouseout"===t.type){let e=this._hoveredItem,i=h5(e,r);e&&!i&&aJ(s.onLeave,[t,e,this],this),this._hoveredItem=r,r&&!i&&aJ(s.onHover,[t,r,this],this)}else r&&aJ(s.onClick,[t,r,this],this)}}function h4(t,e){return e*(t.text?t.text.length:0)}class h8 extends oQ{constructor(t){super(),this.chart=t.chart,this.options=t.options,this.ctx=t.ctx,this._padding=void 0,this.top=void 0,this.bottom=void 0,this.left=void 0,this.right=void 0,this.width=void 0,this.height=void 0,this.position=void 0,this.weight=void 0,this.fullSize=void 0}update(t,e){let i=this.options;if(this.left=0,this.top=0,!i.display){this.width=this.height=this.right=this.bottom=0;return}this.width=this.right=t,this.height=this.bottom=e;let s=aY(i.text)?i.text.length:1;this._padding=lu(i.padding);let r=s*lc(i.font).lineHeight+this._padding.height;this.isHorizontal()?this.height=r:this.width=r}isHorizontal(){let t=this.options.position;return"top"===t||"bottom"===t}_drawArgs(t){let e,i,s,{top:r,left:a,bottom:n,right:l,options:o}=this,h=o.align,d=0;return this.isHorizontal()?(i=nF(h,a,l),s=r+t,e=l-a):("left"===o.position?(i=a+t,s=nF(h,n,r),d=-.5*nr):(i=l-t,s=nF(h,r,n),d=.5*nr),e=n-r),{titleX:i,titleY:s,maxWidth:e,rotation:d}}draw(){let t=this.ctx,e=this.options;if(!e.display)return;let i=lc(e.font),s=i.lineHeight/2+this._padding.top,{titleX:r,titleY:a,maxWidth:n,rotation:l}=this._drawArgs(s);ls(t,e.text,0,0,i,{color:e.color,maxWidth:n,rotation:l,textAlign:nO(e.align),textBaseline:"middle",translation:[r,a]})}}const h6=new WeakMap,h9={average(t){let e,i;if(!t.length)return!1;let s=new Set,r=0,a=0;for(e=0,i=t.length;e<i;++e){let i=t[e].element;if(i&&i.hasValue()){let t=i.tooltipPosition();s.add(t.x),r+=t.y,++a}}return 0!==a&&0!==s.size&&{x:[...s].reduce((t,e)=>t+e)/s.size,y:r/a}},nearest(t,e){let i,s,r;if(!t.length)return!1;let a=e.x,n=e.y,l=Number.POSITIVE_INFINITY;for(i=0,s=t.length;i<s;++i){let s=t[i].element;if(s&&s.hasValue()){let t=nb(e,s.getCenterPoint());t<l&&(l=t,r=s)}}if(r){let t=r.tooltipPosition();a=t.x,n=t.y}return{x:a,y:n}}};function h7(t,e){return e&&(aY(e)?Array.prototype.push.apply(t,e):t.push(e)),t}function dt(t){return("string"==typeof t||t instanceof String)&&t.indexOf("\n")>-1?t.split("\n"):t}function de(t,e){let i=t.chart.ctx,{body:s,footer:r,title:a}=t,{boxWidth:n,boxHeight:l}=e,o=lc(e.bodyFont),h=lc(e.titleFont),d=lc(e.footerFont),u=a.length,c=r.length,f=s.length,g=lu(e.padding),p=g.height,m=0,y=s.reduce((t,e)=>t+e.before.length+e.lines.length+e.after.length,0);y+=t.beforeBody.length+t.afterBody.length,u&&(p+=u*h.lineHeight+(u-1)*e.titleSpacing+e.titleMarginBottom),y&&(p+=f*(e.displayColors?Math.max(l,o.lineHeight):o.lineHeight)+(y-f)*o.lineHeight+(y-1)*e.bodySpacing),c&&(p+=e.footerMarginTop+c*d.lineHeight+(c-1)*e.footerSpacing);let v=0,E=function(t){m=Math.max(m,i.measureText(t).width+v)};return i.save(),i.font=h.string,a0(t.title,E),i.font=o.string,a0(t.beforeBody.concat(t.afterBody),E),v=e.displayColors?n+2+e.boxPadding:0,a0(s,t=>{a0(t.before,E),a0(t.lines,E),a0(t.after,E)}),v=0,i.font=d.string,a0(t.footer,E),i.restore(),{width:m+=g.width,height:p}}function di(t,e,i){let s=i.yAlign||e.yAlign||function(t,e){let{y:i,height:s}=e;return i<s/2?"top":i>t.height-s/2?"bottom":"center"}(t,i);return{xAlign:i.xAlign||e.xAlign||function(t,e,i,s){let{x:r,width:a}=i,{width:n,chartArea:{left:l,right:o}}=t,h="center";return"center"===s?h=r<=(l+o)/2?"left":"right":r<=a/2?h="left":r>=n-a/2&&(h="right"),function(t,e,i,s){let{x:r,width:a}=s,n=i.caretSize+i.caretPadding;if("left"===t&&r+a+n>e.width||"right"===t&&r-a-n<0)return!0}(h,t,e,i)&&(h="center"),h}(t,e,i,s),yAlign:s}}function ds(t,e,i,s){let{caretSize:r,caretPadding:a,cornerRadius:n}=t,{xAlign:l,yAlign:o}=i,h=r+a,{topLeft:d,topRight:u,bottomLeft:c,bottomRight:f}=ld(n),g=function(t,e){let{x:i,width:s}=t;return"right"===e?i-=s:"center"===e&&(i-=s/2),i}(e,l),p=function(t,e,i){let{y:s,height:r}=t;return"top"===e?s+=i:"bottom"===e?s-=r+i:s-=r/2,s}(e,o,h);return"center"===o?"left"===l?g+=h:"right"===l&&(g-=h):"left"===l?g-=Math.max(d,c)+r:"right"===l&&(g+=Math.max(u,f)+r),{x:nx(g,0,s.width-e.width),y:nx(p,0,s.height-e.height)}}function dr(t,e,i){let s=lu(i.padding);return"center"===e?t.x+t.width/2:"right"===e?t.x+t.width-s.right:t.x+s.left}function da(t,e){let i=e&&e.dataset&&e.dataset.tooltip&&e.dataset.tooltip.callbacks;return i?t.override(i):t}const dn={beforeTitle:aH,title(t){if(t.length>0){let e=t[0],i=e.chart.data.labels,s=i?i.length:0;if(this&&this.options&&"dataset"===this.options.mode)return e.dataset.label||"";if(e.label)return e.label;if(s>0&&e.dataIndex<s)return i[e.dataIndex]}return""},afterTitle:aH,beforeBody:aH,beforeLabel:aH,label(t){if(this&&this.options&&"dataset"===this.options.mode)return t.label+": "+t.formattedValue||t.formattedValue;let e=t.dataset.label||"";e&&(e+=": ");let i=t.formattedValue;return aW(i)||(e+=i),e},labelColor(t){let e=t.chart.getDatasetMeta(t.datasetIndex).controller.getStyle(t.dataIndex);return{borderColor:e.borderColor,backgroundColor:e.backgroundColor,borderWidth:e.borderWidth,borderDash:e.borderDash,borderDashOffset:e.borderDashOffset,borderRadius:0}},labelTextColor(){return this.options.bodyColor},labelPointStyle(t){let e=t.chart.getDatasetMeta(t.datasetIndex).controller.getStyle(t.dataIndex);return{pointStyle:e.pointStyle,rotation:e.rotation}},afterLabel:aH,afterBody:aH,beforeFooter:aH,footer:aH,afterFooter:aH};function dl(t,e,i,s){let r=t[e].call(i,s);return void 0===r?dn[e].call(i,s):r}class dh extends oQ{static positioners=h9;constructor(t){super(),this.opacity=0,this._active=[],this._eventPosition=void 0,this._size=void 0,this._cachedAnimations=void 0,this._tooltipItems=[],this.$animations=void 0,this.$context=void 0,this.chart=t.chart,this.options=t.options,this.dataPoints=void 0,this.title=void 0,this.beforeBody=void 0,this.body=void 0,this.afterBody=void 0,this.footer=void 0,this.xAlign=void 0,this.yAlign=void 0,this.x=void 0,this.y=void 0,this.height=void 0,this.width=void 0,this.caretX=void 0,this.caretY=void 0,this.labelColors=void 0,this.labelPointStyles=void 0,this.labelTextColors=void 0}initialize(t){this.options=t,this._cachedAnimations=void 0,this.$context=void 0}_resolveAnimations(){let t=this._cachedAnimations;if(t)return t;let e=this.chart,i=this.options.setContext(this.getContext()),s=i.enabled&&e.options.animation&&i.animations,r=new l6(this.chart,s);return s._cacheable&&(this._cachedAnimations=Object.freeze(r)),r}getContext(){var t;return this.$context||(this.$context=(t=this.chart.getContext(),lg(t,{tooltip:this,tooltipItems:this._tooltipItems,type:"tooltip"})))}getTitle(t,e){let{callbacks:i}=e,s=dl(i,"beforeTitle",this,t),r=dl(i,"title",this,t),a=dl(i,"afterTitle",this,t),n=[];return n=h7(n,dt(s)),n=h7(n,dt(r)),n=h7(n,dt(a))}getBeforeBody(t,e){return h7([],dt(dl(e.callbacks,"beforeBody",this,t)))}getBody(t,e){let{callbacks:i}=e,s=[];return a0(t,t=>{let e={before:[],lines:[],after:[]},r=da(i,t);h7(e.before,dt(dl(r,"beforeLabel",this,t))),h7(e.lines,dl(r,"label",this,t)),h7(e.after,dt(dl(r,"afterLabel",this,t))),s.push(e)}),s}getAfterBody(t,e){return h7([],dt(dl(e.callbacks,"afterBody",this,t)))}getFooter(t,e){let{callbacks:i}=e,s=dl(i,"beforeFooter",this,t),r=dl(i,"footer",this,t),a=dl(i,"afterFooter",this,t),n=[];return n=h7(n,dt(s)),n=h7(n,dt(r)),n=h7(n,dt(a))}_createItems(t){let e,i,s=this._active,r=this.chart.data,a=[],n=[],l=[],o=[];for(e=0,i=s.length;e<i;++e)o.push(function(t,e){let{element:i,datasetIndex:s,index:r}=e,a=t.getDatasetMeta(s).controller,{label:n,value:l}=a.getLabelAndValue(r);return{chart:t,label:n,parsed:a.getParsed(r),raw:t.data.datasets[s].data[r],formattedValue:l,dataset:a.getDataset(),dataIndex:r,datasetIndex:s,element:i}}(this.chart,s[e]));return t.filter&&(o=o.filter((e,i,s)=>t.filter(e,i,s,r))),t.itemSort&&(o=o.sort((e,i)=>t.itemSort(e,i,r))),a0(o,e=>{let i=da(t.callbacks,e);a.push(dl(i,"labelColor",this,e)),n.push(dl(i,"labelPointStyle",this,e)),l.push(dl(i,"labelTextColor",this,e))}),this.labelColors=a,this.labelPointStyles=n,this.labelTextColors=l,this.dataPoints=o,o}update(t,e){let i,s=this.options.setContext(this.getContext()),r=this._active,a=[];if(r.length){let t=h9[s.position].call(this,r,this._eventPosition);a=this._createItems(s),this.title=this.getTitle(a,s),this.beforeBody=this.getBeforeBody(a,s),this.body=this.getBody(a,s),this.afterBody=this.getAfterBody(a,s),this.footer=this.getFooter(a,s);let e=this._size=de(this,s),n=Object.assign({},t,e),l=di(this.chart,s,n),o=ds(s,n,l,this.chart);this.xAlign=l.xAlign,this.yAlign=l.yAlign,i={opacity:1,x:o.x,y:o.y,width:e.width,height:e.height,caretX:t.x,caretY:t.y}}else 0!==this.opacity&&(i={opacity:0});this._tooltipItems=a,this.$context=void 0,i&&this._resolveAnimations().update(this,i),t&&s.external&&s.external.call(this,{chart:this.chart,tooltip:this,replay:e})}drawCaret(t,e,i,s){let r=this.getCaretPosition(t,i,s);e.lineTo(r.x1,r.y1),e.lineTo(r.x2,r.y2),e.lineTo(r.x3,r.y3)}getCaretPosition(t,e,i){let s,r,a,n,l,o,{xAlign:h,yAlign:d}=this,{caretSize:u,cornerRadius:c}=i,{topLeft:f,topRight:g,bottomLeft:p,bottomRight:m}=ld(c),{x:y,y:v}=t,{width:E,height:T}=e;return"center"===d?(l=v+T/2,"left"===h?(r=(s=y)-u,n=l+u,o=l-u):(r=(s=y+E)+u,n=l-u,o=l+u),a=s):(r="left"===h?y+Math.max(f,p)+u:"right"===h?y+E-Math.max(g,m)-u:this.caretX,"top"===d?(l=(n=v)-u,s=r-u,a=r+u):(l=(n=v+T)+u,s=r+u,a=r-u),o=n),{x1:s,x2:r,x3:a,y1:n,y2:l,y3:o}}drawTitle(t,e,i){let s,r,a,n=this.title,l=n.length;if(l){let o=lY(i.rtl,this.x,this.width);for(a=0,t.x=dr(this,i.titleAlign,i),e.textAlign=o.textAlign(i.titleAlign),e.textBaseline="middle",s=lc(i.titleFont),r=i.titleSpacing,e.fillStyle=i.titleColor,e.font=s.string;a<l;++a)e.fillText(n[a],o.x(t.x),t.y+s.lineHeight/2),t.y+=s.lineHeight+r,a+1===l&&(t.y+=i.titleMarginBottom-r)}}_drawColorBox(t,e,i,s,r){let a=this.labelColors[i],n=this.labelPointStyles[i],{boxHeight:l,boxWidth:o}=r,h=lc(r.bodyFont),d=dr(this,"left",r),u=s.x(d),c=l<h.lineHeight?(h.lineHeight-l)/2:0,f=e.y+c;if(r.usePointStyle){let e={radius:Math.min(o,l)/2,pointStyle:n.pointStyle,rotation:n.rotation,borderWidth:1},i=s.leftForLtr(u,o)+o/2,h=f+l/2;t.strokeStyle=r.multiKeyBackground,t.fillStyle=r.multiKeyBackground,n8(t,e,i,h),t.strokeStyle=a.borderColor,t.fillStyle=a.backgroundColor,n8(t,e,i,h)}else{t.lineWidth=aj(a.borderWidth)?Math.max(...Object.values(a.borderWidth)):a.borderWidth||1,t.strokeStyle=a.borderColor,t.setLineDash(a.borderDash||[]),t.lineDashOffset=a.borderDashOffset||0;let e=s.leftForLtr(u,o),i=s.leftForLtr(s.xPlus(u,1),o-2),n=ld(a.borderRadius);Object.values(n).some(t=>0!==t)?(t.beginPath(),t.fillStyle=r.multiKeyBackground,lr(t,{x:e,y:f,w:o,h:l,radius:n}),t.fill(),t.stroke(),t.fillStyle=a.backgroundColor,t.beginPath(),lr(t,{x:i,y:f+1,w:o-2,h:l-2,radius:n}),t.fill()):(t.fillStyle=r.multiKeyBackground,t.fillRect(e,f,o,l),t.strokeRect(e,f,o,l),t.fillStyle=a.backgroundColor,t.fillRect(i,f+1,o-2,l-2))}t.fillStyle=this.labelTextColors[i]}drawBody(t,e,i){let s,r,a,n,l,o,{body:h}=this,{bodySpacing:d,bodyAlign:u,displayColors:c,boxHeight:f,boxWidth:g,boxPadding:p}=i,m=lc(i.bodyFont),y=m.lineHeight,v=0,E=lY(i.rtl,this.x,this.width),T=function(i){e.fillText(i,E.x(t.x+v),t.y+y/2),t.y+=y+d},b=E.textAlign(u);for(e.textAlign=u,e.textBaseline="middle",e.font=m.string,t.x=dr(this,b,i),e.fillStyle=i.bodyColor,a0(this.beforeBody,T),v=c&&"right"!==b?"center"===u?g/2+p:g+2+p:0,a=0,l=h.length;a<l;++a){for(s=h[a],e.fillStyle=this.labelTextColors[a],a0(s.before,T),r=s.lines,c&&r.length&&(this._drawColorBox(e,t,a,E,i),y=Math.max(m.lineHeight,f)),n=0,o=r.length;n<o;++n)T(r[n]),y=m.lineHeight;a0(s.after,T)}v=0,y=m.lineHeight,a0(this.afterBody,T),t.y-=d}drawFooter(t,e,i){let s,r,a=this.footer,n=a.length;if(n){let l=lY(i.rtl,this.x,this.width);for(t.x=dr(this,i.footerAlign,i),t.y+=i.footerMarginTop,e.textAlign=l.textAlign(i.footerAlign),e.textBaseline="middle",s=lc(i.footerFont),e.fillStyle=i.footerColor,e.font=s.string,r=0;r<n;++r)e.fillText(a[r],l.x(t.x),t.y+s.lineHeight/2),t.y+=s.lineHeight+i.footerSpacing}}drawBackground(t,e,i,s){let{xAlign:r,yAlign:a}=this,{x:n,y:l}=t,{width:o,height:h}=i,{topLeft:d,topRight:u,bottomLeft:c,bottomRight:f}=ld(s.cornerRadius);e.fillStyle=s.backgroundColor,e.strokeStyle=s.borderColor,e.lineWidth=s.borderWidth,e.beginPath(),e.moveTo(n+d,l),"top"===a&&this.drawCaret(t,e,i,s),e.lineTo(n+o-u,l),e.quadraticCurveTo(n+o,l,n+o,l+u),"center"===a&&"right"===r&&this.drawCaret(t,e,i,s),e.lineTo(n+o,l+h-f),e.quadraticCurveTo(n+o,l+h,n+o-f,l+h),"bottom"===a&&this.drawCaret(t,e,i,s),e.lineTo(n+c,l+h),e.quadraticCurveTo(n,l+h,n,l+h-c),"center"===a&&"left"===r&&this.drawCaret(t,e,i,s),e.lineTo(n,l+d),e.quadraticCurveTo(n,l,n+d,l),e.closePath(),e.fill(),s.borderWidth>0&&e.stroke()}_updateAnimationTarget(t){let e=this.chart,i=this.$animations,s=i&&i.x,r=i&&i.y;if(s||r){let i=h9[t.position].call(this,this._active,this._eventPosition);if(!i)return;let a=this._size=de(this,t),n=Object.assign({},i,this._size),l=di(e,t,n),o=ds(t,n,l,e);(s._to!==o.x||r._to!==o.y)&&(this.xAlign=l.xAlign,this.yAlign=l.yAlign,this.width=a.width,this.height=a.height,this.caretX=i.x,this.caretY=i.y,this._resolveAnimations().update(this,o))}}_willRender(){return!!this.opacity}draw(t){let e=this.options.setContext(this.getContext()),i=this.opacity;if(!i)return;this._updateAnimationTarget(e);let s={width:this.width,height:this.height},r={x:this.x,y:this.y};i=.001>Math.abs(i)?0:i;let a=lu(e.padding),n=this.title.length||this.beforeBody.length||this.body.length||this.afterBody.length||this.footer.length;e.enabled&&n&&(t.save(),t.globalAlpha=i,this.drawBackground(r,t,s,e),lj(t,e.textDirection),r.y+=a.top,this.drawTitle(r,t,e),this.drawBody(r,t,e),this.drawFooter(r,t,e),lz(t,e.textDirection),t.restore())}getActiveElements(){return this._active||[]}setActiveElements(t,e){let i=this._active,s=t.map(({datasetIndex:t,index:e})=>{let i=this.chart.getDatasetMeta(t);if(!i)throw Error("Cannot find a dataset at index "+t);return{datasetIndex:t,element:i.data[e],index:e}}),r=!a1(i,s),a=this._positionChanged(s,e);(r||a)&&(this._active=s,this._eventPosition=e,this._ignoreReplayEvents=!0,this.update(!0))}handleEvent(t,e,i=!0){if(e&&this._ignoreReplayEvents)return!1;this._ignoreReplayEvents=!1;let s=this.options,r=this._active||[],a=this._getActiveElements(t,r,e,i),n=this._positionChanged(a,t),l=e||!a1(a,r)||n;return l&&(this._active=a,(s.enabled||s.external)&&(this._eventPosition={x:t.x,y:t.y},this.update(!0,e))),l}_getActiveElements(t,e,i,s){let r=this.options;if("mouseout"===t.type)return[];if(!s)return e.filter(t=>this.chart.data.datasets[t.datasetIndex]&&void 0!==this.chart.getDatasetMeta(t.datasetIndex).controller.getParsed(t.index));let a=this.chart.getElementsAtEventForMode(t,r.mode,r,i);return r.reverse&&a.reverse(),a}_positionChanged(t,e){let{caretX:i,caretY:s,options:r}=this,a=h9[r.position].call(this,t,e);return!1!==a&&(i!==a.x||s!==a.y)}}var dd=Object.freeze({__proto__:null,Colors:{id:"colors",defaults:{enabled:!0,forceOverride:!1},beforeLayout(t,e,i){let s;if(!i.enabled)return;let{data:{datasets:r},options:a}=t.config,{elements:n}=a,l=hH(r)||a&&(a.borderColor||a.backgroundColor)||n&&hH(n)||"rgba(0,0,0,0.1)"!==n2.borderColor||"rgba(0,0,0,0.1)"!==n2.backgroundColor;if(!i.forceOverride&&l)return;let o=(s=0,(e,i)=>{var r,a,n;let l=t.getDatasetMeta(i).controller;l instanceof op?(r=s,e.backgroundColor=e.data.map(()=>hG(r++)),s=r):l instanceof om?(a=s,e.backgroundColor=e.data.map(()=>hV(a++)),s=a):l&&(e.borderColor=hG(n=s),e.backgroundColor=hV(n),s=++n)});r.forEach(o)}},Decimation:{id:"decimation",defaults:{algorithm:"min-max",enabled:!1},beforeElementsUpdate:(t,e,i)=>{if(!i.enabled)return void hW(t);let s=t.width;t.data.datasets.forEach((e,r)=>{let a,{_data:n,indexAxis:l}=e,o=t.getDatasetMeta(r),h=n||e.data;if("y"===lf([l,t.options.indexAxis])||!o.controller.supportsDecimation)return;let d=t.scales[o.xAxisID];if("linear"!==d.type&&"time"!==d.type||t.options.parsing)return;let{start:u,count:c}=function(t,e){let i,s=e.length,r=0,{iScale:a}=t,{min:n,max:l,minDefined:o,maxDefined:h}=a.getUserBounds();return o&&(r=nx(nR(e,a.axis,n).lo,0,s-1)),i=h?nx(nR(e,a.axis,l).hi+1,r,s)-r:s-r,{start:r,count:i}}(o,h);if(c<=(i.threshold||4*s))return void hK(e);switch(aW(n)&&(e._data=h,delete e.data,Object.defineProperty(e,"data",{configurable:!0,enumerable:!0,get:function(){return this._decimated},set:function(t){this._data=t}})),i.algorithm){case"lttb":a=function(t,e,i,s,r){let a,n,l,o,h,d=r.samples||s;if(d>=i)return t.slice(e,e+i);let u=[],c=(i-2)/(d-2),f=0,g=e+i-1,p=e;for(a=0,u[f++]=t[p];a<d-2;a++){let s,r=0,d=0,g=Math.floor((a+1)*c)+1+e,m=Math.min(Math.floor((a+2)*c)+1,i)+e,y=m-g;for(s=g;s<m;s++)r+=t[s].x,d+=t[s].y;r/=y,d/=y;let v=Math.floor(a*c)+1+e,E=Math.min(Math.floor((a+1)*c)+1,i)+e,{x:T,y:b}=t[p];for(l=o=-1,s=v;s<E;s++)(o=.5*Math.abs((T-r)*(t[s].y-b)-(T-t[s].x)*(d-b)))>l&&(l=o,n=t[s],h=s);u[f++]=n,p=h}return u[f++]=t[g],u}(h,u,c,s,i);break;case"min-max":a=function(t,e,i,s){let r,a,n,l,o,h,d,u,c,f,g=0,p=0,m=[],y=t[e].x,v=t[e+i-1].x-y;for(r=e;r<e+i;++r){n=((a=t[r]).x-y)/v*s,l=a.y;let e=0|n;if(e===o)l<c?(c=l,h=r):l>f&&(f=l,d=r),g=(p*g+a.x)/++p;else{let i=r-1;if(!aW(h)&&!aW(d)){let e=Math.min(h,d),s=Math.max(h,d);e!==u&&e!==i&&m.push({...t[e],x:g}),s!==u&&s!==i&&m.push({...t[s],x:g})}r>0&&i!==u&&m.push(t[i]),m.push(a),o=e,p=0,c=f=l,h=d=u=r}}return m}(h,u,c,s);break;default:throw Error(`Unsupported decimation algorithm '${i.algorithm}'`)}e._decimated=a})},destroy(t){hW(t)}},Filler:{id:"filler",afterDatasetsUpdate(t,e,i){let s,r,a,n,l=(t.data.datasets||[]).length,o=[];for(r=0;r<l;++r)a=(s=t.getDatasetMeta(r)).dataset,n=null,a&&a.options&&a instanceof hP&&(n={visible:t.isDatasetVisible(r),index:r,fill:function(t,e,i){var s,r,a,n;let l=function(t){let e=t.options,i=e.fill,s=aX(i&&i.target,i);return void 0===s&&(s=!!e.backgroundColor),!1!==s&&null!==s&&(!0===s?"origin":s)}(t);if(aj(l))return!isNaN(l.value)&&l;let o=parseFloat(l);return az(o)&&Math.floor(o)===o?(s=l[0],r=e,a=o,n=i,("-"===s||"+"===s)&&(a=r+a),a!==r&&!(a<0)&&!(a>=n)&&a):["origin","start","end","stack","shape"].indexOf(l)>=0&&l}(a,r,l),chart:t,axis:s.controller.options.indexAxis,scale:s.vScale,line:a}),s.$filler=n,o.push(n);for(r=0;r<l;++r)(n=o[r])&&!1!==n.fill&&(n.fill=function(t,e,i){let s,r=t[e].fill,a=[e];if(!i)return r;for(;!1!==r&&-1===a.indexOf(r);){if(!az(r))return r;if(!(s=t[r]))break;if(s.visible)return r;a.push(r),r=s.fill}return!1}(o,r,i.propagate))},beforeDraw(t,e,i){let s="beforeDraw"===i.drawTime,r=t.getSortedVisibleDatasetMetas(),a=t.chartArea;for(let e=r.length-1;e>=0;--e){let i=r[e].$filler;i&&(i.line.updateControlPoints(a,i.axis),s&&i.fill&&hZ(t.ctx,i,a))}},beforeDatasetsDraw(t,e,i){if("beforeDatasetsDraw"!==i.drawTime)return;let s=t.getSortedVisibleDatasetMetas();for(let e=s.length-1;e>=0;--e){let i=s[e].$filler;hX(i)&&hZ(t.ctx,i,t.chartArea)}},beforeDatasetDraw(t,e,i){let s=e.meta.$filler;hX(s)&&"beforeDatasetDraw"===i.drawTime&&hZ(t.ctx,s,t.chartArea)},defaults:{propagate:!0,drawTime:"beforeDatasetDraw"}},Legend:{id:"legend",_element:h3,start(t,e,i){let s=t.legend=new h3({ctx:t.ctx,options:i,chart:t});ow.configure(t,s,i),ow.addBox(t,s)},stop(t){ow.removeBox(t,t.legend),delete t.legend},beforeUpdate(t,e,i){let s=t.legend;ow.configure(t,s,i),s.options=i},afterUpdate(t){let e=t.legend;e.buildLabels(),e.adjustHitBoxes()},afterEvent(t,e){e.replay||t.legend.handleEvent(e.event)},defaults:{display:!0,position:"top",align:"center",fullSize:!0,reverse:!1,weight:1e3,onClick(t,e,i){let s=e.datasetIndex,r=i.chart;r.isDatasetVisible(s)?(r.hide(s),e.hidden=!0):(r.show(s),e.hidden=!1)},onHover:null,onLeave:null,labels:{color:t=>t.chart.options.color,boxWidth:40,padding:10,generateLabels(t){let e=t.data.datasets,{labels:{usePointStyle:i,pointStyle:s,textAlign:r,color:a,useBorderRadius:n,borderRadius:l}}=t.legend.options;return t._getSortedDatasetMetas().map(t=>{let o=t.controller.getStyle(i?0:void 0),h=lu(o.borderWidth);return{text:e[t.index].label,fillStyle:o.backgroundColor,fontColor:a,hidden:!t.visible,lineCap:o.borderCapStyle,lineDash:o.borderDash,lineDashOffset:o.borderDashOffset,lineJoin:o.borderJoinStyle,lineWidth:(h.width+h.height)/4,strokeStyle:o.borderColor,pointStyle:s||o.pointStyle,rotation:o.rotation,textAlign:r||o.textAlign,borderRadius:n&&(l||o.borderRadius),datasetIndex:t.index}},this)}},title:{color:t=>t.chart.options.color,display:!1,position:"center",text:""}},descriptors:{_scriptable:t=>!t.startsWith("on"),labels:{_scriptable:t=>!["generateLabels","filter","sort"].includes(t)}}},SubTitle:{id:"subtitle",start(t,e,i){let s=new h8({ctx:t.ctx,options:i,chart:t});ow.configure(t,s,i),ow.addBox(t,s),h6.set(t,s)},stop(t){ow.removeBox(t,h6.get(t)),h6.delete(t)},beforeUpdate(t,e,i){let s=h6.get(t);ow.configure(t,s,i),s.options=i},defaults:{align:"center",display:!1,font:{weight:"normal"},fullSize:!0,padding:0,position:"top",text:"",weight:1500},defaultRoutes:{color:"color"},descriptors:{_scriptable:!0,_indexable:!1}},Title:{id:"title",_element:h8,start(t,e,i){let s=new h8({ctx:t.ctx,options:i,chart:t});ow.configure(t,s,i),ow.addBox(t,s),t.titleBlock=s},stop(t){let e=t.titleBlock;ow.removeBox(t,e),delete t.titleBlock},beforeUpdate(t,e,i){let s=t.titleBlock;ow.configure(t,s,i),s.options=i},defaults:{align:"center",display:!1,font:{weight:"bold"},fullSize:!0,padding:10,position:"top",text:"",weight:2e3},defaultRoutes:{color:"color"},descriptors:{_scriptable:!0,_indexable:!1}},Tooltip:{id:"tooltip",_element:dh,positioners:h9,afterInit(t,e,i){i&&(t.tooltip=new dh({chart:t,options:i}))},beforeUpdate(t,e,i){t.tooltip&&t.tooltip.initialize(i)},reset(t,e,i){t.tooltip&&t.tooltip.initialize(i)},afterDraw(t){let e=t.tooltip;if(e&&e._willRender()){let i={tooltip:e};if(!1===t.notifyPlugins("beforeTooltipDraw",{...i,cancelable:!0}))return;e.draw(t.ctx),t.notifyPlugins("afterTooltipDraw",i)}},afterEvent(t,e){if(t.tooltip){let i=e.replay;t.tooltip.handleEvent(e.event,i,e.inChartArea)&&(e.changed=!0)}},defaults:{enabled:!0,external:null,position:"average",backgroundColor:"rgba(0,0,0,0.8)",titleColor:"#fff",titleFont:{weight:"bold"},titleSpacing:2,titleMarginBottom:6,titleAlign:"left",bodyColor:"#fff",bodySpacing:2,bodyFont:{},bodyAlign:"left",footerColor:"#fff",footerSpacing:2,footerMarginTop:6,footerFont:{weight:"bold"},footerAlign:"left",padding:6,caretPadding:2,caretSize:5,cornerRadius:6,boxHeight:(t,e)=>e.bodyFont.size,boxWidth:(t,e)=>e.bodyFont.size,multiKeyBackground:"#fff",displayColors:!0,boxPadding:0,borderColor:"rgba(0,0,0,0)",borderWidth:0,animation:{duration:400,easing:"easeOutQuart"},animations:{numbers:{type:"number",properties:["x","y","width","height","caretX","caretY"]},opacity:{easing:"linear",duration:200}},callbacks:dn},defaultRoutes:{bodyFont:"font",footerFont:"font",titleFont:"font"},descriptors:{_scriptable:t=>"filter"!==t&&"itemSort"!==t&&"external"!==t,_indexable:!1,callbacks:{_scriptable:!1,_indexable:!1},animation:{_fallback:!1},animations:{_fallback:"animation"}},additionalOptionScopes:["interaction"]}});const du=(t,e,i,s)=>("string"==typeof e?(i=t.push(e)-1,s.unshift({index:i,label:e})):isNaN(e)&&(i=null),i),dc=(t,e)=>null===t?null:nx(Math.round(t),0,e);function df(t){let e=this.getLabels();return t>=0&&t<e.length?e[t]:t}function dg(t,e,{horizontal:i,minRotation:s}){let r=nv(s),a=(i?Math.sin(r):Math.cos(r))||.001,n=.75*e*(""+t).length;return Math.min(e/a,n)}class dp extends o4{constructor(t){super(t),this.start=void 0,this.end=void 0,this._startValue=void 0,this._endValue=void 0,this._valueRange=0}parse(t,e){return aW(t)||("number"==typeof t||t instanceof Number)&&!isFinite(+t)?null:+t}handleTickRangeOptions(){let{beginAtZero:t}=this.options,{minDefined:e,maxDefined:i}=this.getUserBounds(),{min:s,max:r}=this,a=t=>s=e?s:t,n=t=>r=i?r:t;if(t){let t=nf(s),e=nf(r);t<0&&e<0?n(0):t>0&&e>0&&a(0)}if(s===r){let e=0===r?1:Math.abs(.05*r);n(r+e),t||a(s-e)}this.min=s,this.max=r}getTickLimit(){let t,{maxTicksLimit:e,stepSize:i}=this.options.ticks;return i?(t=Math.ceil(this.max/i)-Math.floor(this.min/i)+1)>1e3&&(console.warn(`scales.${this.id}.ticks.stepSize: ${i} would result generating up to ${t} ticks. Limiting to 1000.`),t=1e3):(t=this.computeTickLimit(),e=e||11),e&&(t=Math.min(e,t)),t}computeTickLimit(){return Number.POSITIVE_INFINITY}buildTicks(){let t=this.options,e=t.ticks,i=this.getTickLimit(),s=function(t,e){let i,s,r,a,n=[],{bounds:l,step:o,min:h,max:d,precision:u,count:c,maxTicks:f,maxDigits:g,includeBounds:p}=t,m=o||1,y=f-1,{min:v,max:E}=e,T=!aW(h),b=!aW(d),S=!aW(c),A=(E-v)/(g+1),_=np((E-v)/y/m)*m;if(_<1e-14&&!T&&!b)return[{value:v},{value:E}];(a=Math.ceil(E/_)-Math.floor(v/_))>y&&(_=np(a*_/y/m)*m),aW(u)||(_=Math.ceil(_*(i=Math.pow(10,u)))/i),"ticks"===l?(s=Math.floor(v/_)*_,r=Math.ceil(E/_)*_):(s=v,r=E),T&&b&&o&&function(t,e){let i=Math.round(t);return i-e<=t&&i+e>=t}((d-h)/o,_/1e3)?(a=Math.round(Math.min((d-h)/_,f)),_=(d-h)/a,s=h,r=d):S?(s=T?h:s,_=((r=b?d:r)-s)/(a=c-1)):a=ng(a=(r-s)/_,Math.round(a),_/1e3)?Math.round(a):Math.ceil(a);let x=Math.max(nE(_),nE(s));s=Math.round(s*(i=Math.pow(10,aW(u)?x:u)))/i,r=Math.round(r*i)/i;let L=0;for(T&&(p&&s!==h?(n.push({value:h}),s<h&&L++,ng(Math.round((s+L*_)*i)/i,h,dg(h,A,t))&&L++):s<h&&L++);L<a;++L){let t=Math.round((s+L*_)*i)/i;if(b&&t>d)break;n.push({value:t})}return b&&p&&r!==d?n.length&&ng(n[n.length-1].value,d,dg(d,A,t))?n[n.length-1].value=d:n.push({value:d}):b&&r!==d||n.push({value:r}),n}({maxTicks:i=Math.max(2,i),bounds:t.bounds,min:t.min,max:t.max,precision:e.precision,step:e.stepSize,count:e.count,maxDigits:this._maxDigits(),horizontal:this.isHorizontal(),minRotation:e.minRotation||0,includeBounds:!1!==e.includeBounds},this._range||this);return"ticks"===t.bounds&&ny(s,this,"value"),t.reverse?(s.reverse(),this.start=this.max,this.end=this.min):(this.start=this.min,this.end=this.max),s}configure(){let t=this.ticks,e=this.min,i=this.max;if(super.configure(),this.options.offset&&t.length){let s=(i-e)/Math.max(t.length-1,1)/2;e-=s,i+=s}this._startValue=e,this._endValue=i,this._valueRange=i-e}getLabelForValue(t){return nX(t,this.chart.options.locale,this.options.ticks.format)}}class dm extends dp{static id="linear";static defaults={ticks:{callback:nQ.numeric}};determineDataLimits(){let{min:t,max:e}=this.getMinMax(!0);this.min=az(t)?t:0,this.max=az(e)?e:1,this.handleTickRangeOptions()}computeTickLimit(){let t=this.isHorizontal(),e=t?this.width:this.height,i=nv(this.options.ticks.minRotation),s=(t?Math.sin(i):Math.cos(i))||.001;return Math.ceil(e/Math.min(40,this._resolveTickFontOptions(0).lineHeight/s))}getPixelForValue(t){return null===t?NaN:this.getPixelForDecimal((t-this._startValue)/this._valueRange)}getValueForPixel(t){return this._startValue+this.getDecimalForPixel(t)*this._valueRange}}const dy=t=>Math.floor(nc(t)),dv=(t,e)=>Math.pow(10,dy(t)+e);function dE(t){return 1==t/Math.pow(10,dy(t))}function dT(t,e,i){let s=Math.pow(10,i),r=Math.floor(t/s);return Math.ceil(e/s)-r}class db extends o4{static id="logarithmic";static defaults={ticks:{callback:nQ.logarithmic,major:{enabled:!0}}};constructor(t){super(t),this.start=void 0,this.end=void 0,this._startValue=void 0,this._valueRange=0}parse(t,e){let i=dp.prototype.parse.apply(this,[t,e]);if(0===i){this._zero=!0;return}return az(i)&&i>0?i:null}determineDataLimits(){let{min:t,max:e}=this.getMinMax(!0);this.min=az(t)?Math.max(0,t):null,this.max=az(e)?Math.max(0,e):null,this.options.beginAtZero&&(this._zero=!0),this._zero&&this.min!==this._suggestedMin&&!az(this._userMin)&&(this.min=t===dv(this.min,0)?dv(this.min,-1):dv(this.min,0)),this.handleTickRangeOptions()}handleTickRangeOptions(){let{minDefined:t,maxDefined:e}=this.getUserBounds(),i=this.min,s=this.max,r=e=>i=t?i:e,a=t=>s=e?s:t;i===s&&(i<=0?(r(1),a(10)):(r(dv(i,-1)),a(dv(s,1)))),i<=0&&r(dv(s,-1)),s<=0&&a(dv(i,1)),this.min=i,this.max=s}buildTicks(){let t=this.options,e=function(t,{min:e,max:i}){e=aq(t.min,e);let s=[],r=dy(e),a=function(t,e){let i=dy(e-t);for(;dT(t,e,i)>10;)i++;for(;10>dT(t,e,i);)i--;return Math.min(i,dy(t))}(e,i),n=a<0?Math.pow(10,Math.abs(a)):1,l=Math.pow(10,a),o=r>a?Math.pow(10,r):0,h=Math.round((e-o)*n)/n,d=Math.floor((e-o)/l/10)*l*10,u=Math.floor((h-d)/Math.pow(10,a)),c=aq(t.min,Math.round((o+d+u*Math.pow(10,a))*n)/n);for(;c<i;)s.push({value:c,major:dE(c),significand:u}),u>=10?u=u<15?15:20:u++,u>=20&&(u=2,n=++a>=0?1:n),c=Math.round((o+d+u*Math.pow(10,a))*n)/n;let f=aq(t.max,c);return s.push({value:f,major:dE(f),significand:u}),s}({min:this._userMin,max:this._userMax},this);return"ticks"===t.bounds&&ny(e,this,"value"),t.reverse?(e.reverse(),this.start=this.max,this.end=this.min):(this.start=this.min,this.end=this.max),e}getLabelForValue(t){return void 0===t?"0":nX(t,this.chart.options.locale,this.options.ticks.format)}configure(){let t=this.min;super.configure(),this._startValue=nc(t),this._valueRange=nc(this.max)-nc(t)}getPixelForValue(t){return((void 0===t||0===t)&&(t=this.min),null===t||isNaN(t))?NaN:this.getPixelForDecimal(t===this.min?0:(nc(t)-this._startValue)/this._valueRange)}getValueForPixel(t){let e=this.getDecimalForPixel(t);return Math.pow(10,this._startValue+e*this._valueRange)}}function dS(t){let e=t.ticks;if(e.display&&t.display){let t=lu(e.backdropPadding);return aX(e.font&&e.font.size,n2.font.size)+t.height}return 0}function dA(t,e,i,s,r){return t===s||t===r?{start:e-i/2,end:e+i/2}:t<s||t>r?{start:e-i,end:e}:{start:e,end:e+i}}function d_(t,e,i,s){let{ctx:r}=t;if(i)r.arc(t.xCenter,t.yCenter,e,0,na);else{let i=t.getPointPosition(0,e);r.moveTo(i.x,i.y);for(let a=1;a<s;a++)i=t.getPointPosition(a,e),r.lineTo(i.x,i.y)}}class dx extends dp{static id="radialLinear";static defaults={display:!0,animate:!0,position:"chartArea",angleLines:{display:!0,lineWidth:1,borderDash:[],borderDashOffset:0},grid:{circular:!1},startAngle:0,ticks:{showLabelBackdrop:!0,callback:nQ.numeric},pointLabels:{backdropColor:void 0,backdropPadding:2,display:!0,font:{size:10},callback:t=>t,padding:5,centerPointLabels:!1}};static defaultRoutes={"angleLines.color":"borderColor","pointLabels.color":"color","ticks.color":"color"};static descriptors={angleLines:{_fallback:"grid"}};constructor(t){super(t),this.xCenter=void 0,this.yCenter=void 0,this.drawingArea=void 0,this._pointLabels=[],this._pointLabelItems=[]}setDimensions(){let t=this._padding=lu(dS(this.options)/2),e=this.width=this.maxWidth-t.width,i=this.height=this.maxHeight-t.height;this.xCenter=Math.floor(this.left+e/2+t.left),this.yCenter=Math.floor(this.top+i/2+t.top),this.drawingArea=Math.floor(Math.min(e,i)/2)}determineDataLimits(){let{min:t,max:e}=this.getMinMax(!1);this.min=az(t)&&!isNaN(t)?t:0,this.max=az(e)&&!isNaN(e)?e:0,this.handleTickRangeOptions()}computeTickLimit(){return Math.ceil(this.drawingArea/dS(this.options))}generateTickLabels(t){dp.prototype.generateTickLabels.call(this,t),this._pointLabels=this.getLabels().map((t,e)=>{let i=aJ(this.options.pointLabels.callback,[t,e],this);return i||0===i?i:""}).filter((t,e)=>this.chart.getDataVisibility(e))}fit(){let t=this.options;t.display&&t.pointLabels.display?function(t){let e={l:t.left+t._padding.left,r:t.right-t._padding.right,t:t.top+t._padding.top,b:t.bottom-t._padding.bottom},i=Object.assign({},e),s=[],r=[],a=t._pointLabels.length,n=t.options.pointLabels,l=n.centerPointLabels?nr/a:0;for(let d=0;d<a;d++){var o,h;let a=n.setContext(t.getPointLabelContext(d));r[d]=a.padding;let u=t.getPointPosition(d,t.drawingArea+r[d],l),c=lc(a.font),f=(o=t.ctx,h=aY(h=t._pointLabels[d])?h:[h],{w:function(t,e,i,s){let r,a,n,l,o,h=(s=s||{}).data=s.data||{},d=s.garbageCollect=s.garbageCollect||[];s.font!==e&&(h=s.data={},d=s.garbageCollect=[],s.font=e),t.save(),t.font=e;let u=0,c=i.length;for(r=0;r<c;r++)if(null==(l=i[r])||aY(l)){if(aY(l))for(a=0,n=l.length;a<n;a++)null==(o=l[a])||aY(o)||(u=n5(t,h,d,u,o))}else u=n5(t,h,d,u,l);t.restore();let f=d.length/2;if(f>i.length){for(r=0;r<f;r++)delete h[d[r]];d.splice(0,f)}return u}(o,c.string,h),h:h.length*c.lineHeight});s[d]=f;let g=nA(t.getIndexAngle(d)+l),p=Math.round(180/nr*g);!function(t,e,i,s,r){let a=Math.abs(Math.sin(i)),n=Math.abs(Math.cos(i)),l=0,o=0;s.start<e.l?(l=(e.l-s.start)/a,t.l=Math.min(t.l,e.l-l)):s.end>e.r&&(l=(s.end-e.r)/a,t.r=Math.max(t.r,e.r+l)),r.start<e.t?(o=(e.t-r.start)/n,t.t=Math.min(t.t,e.t-o)):r.end>e.b&&(o=(r.end-e.b)/n,t.b=Math.max(t.b,e.b+o))}(i,e,g,dA(p,u.x,f.w,0,180),dA(p,u.y,f.h,90,270))}t.setCenterPoint(e.l-i.l,i.r-e.r,e.t-i.t,i.b-e.b),t._pointLabelItems=function(t,e,i){let s,r=[],a=t._pointLabels.length,n=t.options,{centerPointLabels:l,display:o}=n.pointLabels,h={extra:dS(n)/2,additionalAngle:l?nr/a:0};for(let n=0;n<a;n++){h.padding=i[n],h.size=e[n];let a=function(t,e,i){var s,r,a,n,l,o,h;let d=t.drawingArea,{extra:u,additionalAngle:c,padding:f,size:g}=i,p=t.getPointPosition(e,d+u+f,c),m=Math.round(180/nr*nA(p.angle+nh)),y=(s=p.y,r=g.h,90===(a=m)||270===a?s-=r/2:(a>270||a<90)&&(s-=r),s),v=0===(n=m)||180===n?"center":n<180?"left":"right",E=(l=p.x,o=g.w,"right"===(h=v)?l-=o:"center"===h&&(l-=o/2),l);return{visible:!0,x:p.x,y:y,textAlign:v,left:E,top:y,right:E+g.w,bottom:y+g.h}}(t,n,h);r.push(a),"auto"===o&&(a.visible=function(t,e){if(!e)return!0;let{left:i,top:s,right:r,bottom:a}=t;return!(n9({x:i,y:s},e)||n9({x:i,y:a},e)||n9({x:r,y:s},e)||n9({x:r,y:a},e))}(a,s),a.visible&&(s=a))}return r}(t,s,r)}(this):this.setCenterPoint(0,0,0,0)}setCenterPoint(t,e,i,s){this.xCenter+=Math.floor((t-e)/2),this.yCenter+=Math.floor((i-s)/2),this.drawingArea-=Math.min(this.drawingArea/2,Math.max(t,e,i,s))}getIndexAngle(t){return nA(t*(na/(this._pointLabels.length||1))+nv(this.options.startAngle||0))}getDistanceFromCenterForValue(t){if(aW(t))return NaN;let e=this.drawingArea/(this.max-this.min);return this.options.reverse?(this.max-t)*e:(t-this.min)*e}getValueForDistanceFromCenter(t){if(aW(t))return NaN;let e=t/(this.drawingArea/(this.max-this.min));return this.options.reverse?this.max-e:this.min+e}getPointLabelContext(t){let e=this._pointLabels||[];if(t>=0&&t<e.length){let i=e[t];return lg(this.getContext(),{label:i,index:t,type:"pointLabel"})}}getPointPosition(t,e,i=0){let s=this.getIndexAngle(t)-nh+i;return{x:Math.cos(s)*e+this.xCenter,y:Math.sin(s)*e+this.yCenter,angle:s}}getPointPositionForValue(t,e){return this.getPointPosition(t,this.getDistanceFromCenterForValue(e))}getBasePosition(t){return this.getPointPositionForValue(t||0,this.getBaseValue())}getPointLabelPosition(t){let{left:e,top:i,right:s,bottom:r}=this._pointLabelItems[t];return{left:e,top:i,right:s,bottom:r}}drawBackground(){let{backgroundColor:t,grid:{circular:e}}=this.options;if(t){let i=this.ctx;i.save(),i.beginPath(),d_(this,this.getDistanceFromCenterForValue(this._endValue),e,this._pointLabels.length),i.closePath(),i.fillStyle=t,i.fill(),i.restore()}}drawGrid(){let t,e,i,s=this.ctx,r=this.options,{angleLines:a,grid:n,border:l}=r,o=this._pointLabels.length;if(r.pointLabels.display&&function(t,e){let{ctx:i,options:{pointLabels:s}}=t;for(let r=e-1;r>=0;r--){let e=t._pointLabelItems[r];if(!e.visible)continue;let a=s.setContext(t.getPointLabelContext(r));!function(t,e,i){let{left:s,top:r,right:a,bottom:n}=i,{backdropColor:l}=e;if(!aW(l)){let i=ld(e.borderRadius),o=lu(e.backdropPadding);t.fillStyle=l;let h=s-o.left,d=r-o.top,u=a-s+o.width,c=n-r+o.height;Object.values(i).some(t=>0!==t)?(t.beginPath(),lr(t,{x:h,y:d,w:u,h:c,radius:i}),t.fill()):t.fillRect(h,d,u,c)}}(i,a,e);let n=lc(a.font),{x:l,y:o,textAlign:h}=e;ls(i,t._pointLabels[r],l,o+n.lineHeight/2,n,{color:a.color,textAlign:h,textBaseline:"middle"})}}(this,o),n.display&&this.ticks.forEach((t,i)=>{if(0!==i||0===i&&this.min<0){e=this.getDistanceFromCenterForValue(t.value);let s=this.getContext(i),r=n.setContext(s),a=l.setContext(s);!function(t,e,i,s,r){let a=t.ctx,n=e.circular,{color:l,lineWidth:o}=e;(n||s)&&l&&o&&!(i<0)&&(a.save(),a.strokeStyle=l,a.lineWidth=o,a.setLineDash(r.dash||[]),a.lineDashOffset=r.dashOffset,a.beginPath(),d_(t,i,n,s),a.closePath(),a.stroke(),a.restore())}(this,r,e,o,a)}}),a.display){for(s.save(),t=o-1;t>=0;t--){let n=a.setContext(this.getPointLabelContext(t)),{color:l,lineWidth:o}=n;o&&l&&(s.lineWidth=o,s.strokeStyle=l,s.setLineDash(n.borderDash),s.lineDashOffset=n.borderDashOffset,e=this.getDistanceFromCenterForValue(r.reverse?this.min:this.max),i=this.getPointPosition(t,e),s.beginPath(),s.moveTo(this.xCenter,this.yCenter),s.lineTo(i.x,i.y),s.stroke())}s.restore()}}drawBorder(){}drawLabels(){let t,e,i=this.ctx,s=this.options,r=s.ticks;if(!r.display)return;let a=this.getIndexAngle(0);i.save(),i.translate(this.xCenter,this.yCenter),i.rotate(a),i.textAlign="center",i.textBaseline="middle",this.ticks.forEach((a,n)=>{if(0===n&&this.min>=0&&!s.reverse)return;let l=r.setContext(this.getContext(n)),o=lc(l.font);if(t=this.getDistanceFromCenterForValue(this.ticks[n].value),l.showLabelBackdrop){i.font=o.string,e=i.measureText(a.label).width,i.fillStyle=l.backdropColor;let s=lu(l.backdropPadding);i.fillRect(-e/2-s.left,-t-o.size/2-s.top,e+s.width,o.size+s.height)}ls(i,a.label,0,-t,o,{color:l.color,strokeColor:l.textStrokeColor,strokeWidth:l.textStrokeWidth})}),i.restore()}drawTitle(){}}const dL={millisecond:{common:!0,size:1,steps:1e3},second:{common:!0,size:1e3,steps:60},minute:{common:!0,size:6e4,steps:60},hour:{common:!0,size:36e5,steps:24},day:{common:!0,size:864e5,steps:30},week:{common:!1,size:6048e5,steps:4},month:{common:!0,size:2628e6,steps:12},quarter:{common:!1,size:7884e6,steps:4},year:{common:!0,size:3154e7}},dI=Object.keys(dL);function dR(t,e){return t-e}function dD(t,e){if(aW(e))return null;let i=t._adapter,{parser:s,round:r,isoWeekday:a}=t._parseOpts,n=e;return("function"==typeof s&&(n=s(n)),az(n)||(n="string"==typeof s?i.parse(n,s):i.parse(n)),null===n)?null:(r&&(n="week"===r&&(nm(a)||!0===a)?i.startOf(n,"isoWeek",a):i.startOf(n,r)),+n)}function dk(t,e,i,s){let r=dI.length;for(let a=dI.indexOf(t);a<r-1;++a){let t=dL[dI[a]],r=t.steps?t.steps:Number.MAX_SAFE_INTEGER;if(t.common&&Math.ceil((i-e)/(r*t.size))<=s)return dI[a]}return dI[r-1]}function dP(t,e,i){if(i){if(i.length){let{lo:s,hi:r}=nI(i,e);t[i[s]>=e?i[s]:i[r]]=!0}}else t[e]=!0}function dC(t,e,i){let s,r,a=[],n={},l=e.length;for(s=0;s<l;++s)n[r=e[s]]=s,a.push({value:r,major:!1});return 0!==l&&i?function(t,e,i,s){let r,a,n=t._adapter,l=+n.startOf(e[0].value,s),o=e[e.length-1].value;for(r=l;r<=o;r=+n.add(r,1,s))(a=i[r])>=0&&(e[a].major=!0);return e}(t,a,n,i):a}class dM extends o4{static id="time";static defaults={bounds:"data",adapters:{},time:{parser:!1,unit:!1,round:!1,isoWeekday:!1,minUnit:"millisecond",displayFormats:{}},ticks:{source:"auto",callback:!1,major:{enabled:!1}}};constructor(t){super(t),this._cache={data:[],labels:[],all:[]},this._unit="day",this._majorUnit=void 0,this._offsets={},this._normalized=!1,this._parseOpts=void 0}init(t,e={}){let i=t.time||(t.time={}),s=this._adapter=new oE(t.adapters.date);s.init(e),a8(i.displayFormats,s.formats()),this._parseOpts={parser:i.parser,round:i.round,isoWeekday:i.isoWeekday},super.init(t),this._normalized=e.normalized}parse(t,e){return void 0===t?null:dD(this,t)}beforeLayout(){super.beforeLayout(),this._cache={data:[],labels:[],all:[]}}determineDataLimits(){let t=this.options,e=this._adapter,i=t.time.unit||"day",{min:s,max:r,minDefined:a,maxDefined:n}=this.getUserBounds();function l(t){a||isNaN(t.min)||(s=Math.min(s,t.min)),n||isNaN(t.max)||(r=Math.max(r,t.max))}a&&n||(l(this._getLabelBounds()),("ticks"!==t.bounds||"labels"!==t.ticks.source)&&l(this.getMinMax(!1))),s=az(s)&&!isNaN(s)?s:+e.startOf(Date.now(),i),r=az(r)&&!isNaN(r)?r:+e.endOf(Date.now(),i)+1,this.min=Math.min(s,r-1),this.max=Math.max(s+1,r)}_getLabelBounds(){let t=this.getLabelTimestamps(),e=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY;return t.length&&(e=t[0],i=t[t.length-1]),{min:e,max:i}}buildTicks(){let t=this.options,e=t.time,i=t.ticks,s="labels"===i.source?this.getLabelTimestamps():this._generate();"ticks"===t.bounds&&s.length&&(this.min=this._userMin||s[0],this.max=this._userMax||s[s.length-1]);let r=this.min,a=function(t,e,i){let s=0,r=t.length;for(;s<r&&t[s]<e;)s++;for(;r>s&&t[r-1]>i;)r--;return s>0||r<t.length?t.slice(s,r):t}(s,r,this.max);return this._unit=e.unit||(i.autoSkip?dk(e.minUnit,this.min,this.max,this._getLabelCapacity(r)):function(t,e,i,s,r){for(let a=dI.length-1;a>=dI.indexOf(i);a--){let i=dI[a];if(dL[i].common&&t._adapter.diff(r,s,i)>=e-1)return i}return dI[i?dI.indexOf(i):0]}(this,a.length,e.minUnit,this.min,this.max)),this._majorUnit=i.major.enabled&&"year"!==this._unit?function(t){for(let e=dI.indexOf(t)+1,i=dI.length;e<i;++e)if(dL[dI[e]].common)return dI[e]}(this._unit):void 0,this.initOffsets(s),t.reverse&&a.reverse(),dC(this,a,this._majorUnit)}afterAutoSkip(){this.options.offsetAfterAutoskip&&this.initOffsets(this.ticks.map(t=>+t.value))}initOffsets(t=[]){let e,i,s=0,r=0;this.options.offset&&t.length&&(e=this.getDecimalForValue(t[0]),s=1===t.length?1-e:(this.getDecimalForValue(t[1])-e)/2,i=this.getDecimalForValue(t[t.length-1]),r=1===t.length?i:(i-this.getDecimalForValue(t[t.length-2]))/2);let a=t.length<3?.5:.25;s=nx(s,0,a),r=nx(r,0,a),this._offsets={start:s,end:r,factor:1/(s+1+r)}}_generate(){let t,e,i=this._adapter,s=this.min,r=this.max,a=this.options,n=a.time,l=n.unit||dk(n.minUnit,s,r,this._getLabelCapacity(s)),o=aX(a.ticks.stepSize,1),h="week"===l&&n.isoWeekday,d=nm(h)||!0===h,u={},c=s;if(d&&(c=+i.startOf(c,"isoWeek",h)),c=+i.startOf(c,d?"day":l),i.diff(r,s,l)>1e5*o)throw Error(s+" and "+r+" are too far apart with stepSize of "+o+" "+l);let f="data"===a.ticks.source&&this.getDataTimestamps();for(t=c,e=0;t<r;t=+i.add(t,o,l),e++)dP(u,t,f);return(t===r||"ticks"===a.bounds||1===e)&&dP(u,t,f),Object.keys(u).sort(dR).map(t=>+t)}getLabelForValue(t){let e=this._adapter,i=this.options.time;return i.tooltipFormat?e.format(t,i.tooltipFormat):e.format(t,i.displayFormats.datetime)}format(t,e){let i=this.options.time.displayFormats,s=this._unit,r=e||i[s];return this._adapter.format(t,r)}_tickFormatFunction(t,e,i,s){let r=this.options,a=r.ticks.callback;if(a)return aJ(a,[t,e,i],this);let n=r.time.displayFormats,l=this._unit,o=this._majorUnit,h=l&&n[l],d=o&&n[o],u=i[e],c=o&&d&&u&&u.major;return this._adapter.format(t,s||(c?d:h))}generateTickLabels(t){let e,i,s;for(e=0,i=t.length;e<i;++e)(s=t[e]).label=this._tickFormatFunction(s.value,e,t)}getDecimalForValue(t){return null===t?NaN:(t-this.min)/(this.max-this.min)}getPixelForValue(t){let e=this._offsets,i=this.getDecimalForValue(t);return this.getPixelForDecimal((e.start+i)*e.factor)}getValueForPixel(t){let e=this._offsets,i=this.getDecimalForPixel(t)/e.factor-e.end;return this.min+i*(this.max-this.min)}_getLabelSize(t){let e=this.options.ticks,i=this.ctx.measureText(t).width,s=nv(this.isHorizontal()?e.maxRotation:e.minRotation),r=Math.cos(s),a=Math.sin(s),n=this._resolveTickFontOptions(0).size;return{w:i*r+n*a,h:i*a+n*r}}_getLabelCapacity(t){let e=this.options.time,i=e.displayFormats,s=i[e.unit]||i.millisecond,r=this._tickFormatFunction(t,0,dC(this,[t],this._majorUnit),s),a=this._getLabelSize(r),n=Math.floor(this.isHorizontal()?this.width/a.w:this.height/a.h)-1;return n>0?n:1}getDataTimestamps(){let t,e,i=this._cache.data||[];if(i.length)return i;let s=this.getMatchingVisibleMetas();if(this._normalized&&s.length)return this._cache.data=s[0].controller.getAllParsedValues(this);for(t=0,e=s.length;t<e;++t)i=i.concat(s[t].controller.getAllParsedValues(this));return this._cache.data=this.normalize(i)}getLabelTimestamps(){let t,e,i=this._cache.labels||[];if(i.length)return i;let s=this.getLabels();for(t=0,e=s.length;t<e;++t)i.push(dD(this,s[t]));return this._cache.labels=this._normalized?i:this.normalize(i)}normalize(t){return nC(t.sort(dR))}}function dw(t,e,i){let s,r,a,n,l=0,o=t.length-1;i?(e>=t[l].pos&&e<=t[o].pos&&({lo:l,hi:o}=nR(t,"pos",e)),{pos:s,time:a}=t[l],{pos:r,time:n}=t[o]):(e>=t[l].time&&e<=t[o].time&&({lo:l,hi:o}=nR(t,"time",e)),{time:s,pos:a}=t[l],{time:r,pos:n}=t[o]);let h=r-s;return h?a+(n-a)*(e-s)/h:a}class dO extends dM{static id="timeseries";static defaults=dM.defaults;constructor(t){super(t),this._table=[],this._minPos=void 0,this._tableRange=void 0}initOffsets(){let t=this._getTimestampsForTable(),e=this._table=this.buildLookupTable(t);this._minPos=dw(e,this.min),this._tableRange=dw(e,this.max)-this._minPos,super.initOffsets(t)}buildLookupTable(t){let e,i,s,{min:r,max:a}=this,n=[],l=[];for(e=0,i=t.length;e<i;++e)(s=t[e])>=r&&s<=a&&n.push(s);if(n.length<2)return[{time:r,pos:0},{time:a,pos:1}];for(e=0,i=n.length;e<i;++e)Math.round((n[e+1]+n[e-1])/2)!==(s=n[e])&&l.push({time:s,pos:e/(i-1)});return l}_generate(){let t=this.min,e=this.max,i=super.getDataTimestamps();return i.includes(t)&&i.length||i.splice(0,0,t),i.includes(e)&&1!==i.length||i.push(e),i.sort((t,e)=>t-e)}_getTimestampsForTable(){let t=this._cache.all||[];if(t.length)return t;let e=this.getDataTimestamps(),i=this.getLabelTimestamps();return t=e.length&&i.length?this.normalize(e.concat(i)):e.length?e:i,t=this._cache.all=t}getDecimalForValue(t){return(dw(this._table,t)-this._minPos)/this._tableRange}getValueForPixel(t){let e=this._offsets,i=this.getDecimalForPixel(t)/e.factor-e.end;return dw(this._table,i*this._tableRange+this._minPos,!0)}}var dF=Object.freeze({__proto__:null,CategoryScale:class extends o4{static id="category";static defaults={ticks:{callback:df}};constructor(t){super(t),this._startValue=void 0,this._valueRange=0,this._addedLabels=[]}init(t){let e=this._addedLabels;if(e.length){let t=this.getLabels();for(let{index:i,label:s}of e)t[i]===s&&t.splice(i,1);this._addedLabels=[]}super.init(t)}parse(t,e){if(aW(t))return null;let i=this.getLabels();return dc(e=isFinite(e)&&i[e]===t?e:function(t,e,i,s){let r=t.indexOf(e);return -1===r?du(t,e,i,s):r!==t.lastIndexOf(e)?i:r}(i,t,aX(e,t),this._addedLabels),i.length-1)}determineDataLimits(){let{minDefined:t,maxDefined:e}=this.getUserBounds(),{min:i,max:s}=this.getMinMax(!0);"ticks"===this.options.bounds&&(t||(i=0),e||(s=this.getLabels().length-1)),this.min=i,this.max=s}buildTicks(){let t=this.min,e=this.max,i=this.options.offset,s=[],r=this.getLabels();r=0===t&&e===r.length-1?r:r.slice(t,e+1),this._valueRange=Math.max(r.length-!i,1),this._startValue=this.min-.5*!!i;for(let i=t;i<=e;i++)s.push({value:i});return s}getLabelForValue(t){return df.call(this,t)}configure(){super.configure(),this.isHorizontal()||(this._reversePixels=!this._reversePixels)}getPixelForValue(t){return"number"!=typeof t&&(t=this.parse(t)),null===t?NaN:this.getPixelForDecimal((t-this._startValue)/this._valueRange)}getPixelForTick(t){let e=this.ticks;return t<0||t>e.length-1?null:this.getPixelForValue(e[t].value)}getValueForPixel(t){return Math.round(this._startValue+this.getDecimalForPixel(t)*this._valueRange)}getBasePixel(){return this.bottom}},LinearScale:dm,LogarithmicScale:db,RadialLinearScale:dx,TimeScale:dM,TimeSeriesScale:dO});hT.register(oy,hB,dd,dF);const dN=document.getElementById("majors-chart-container"),dB=document.getElementById("majors-chart");dN&&dB&&new IntersectionObserver((t,e)=>{t.forEach(t=>{t.isIntersecting&&!i&&(i=new hT(dB,{type:"bar",data:{labels:["Social Sciences","STEM","Arts & Design"],datasets:[{data:[56,41,3],backgroundColor:["rgba(231, 82, 36, 1)","rgba(39, 39, 42, 1)"]}]},options:{scales:{x:{beginAtZero:!0}},indexAxis:"y",plugins:{legend:{display:!1}},animation:{duration:2e3}}}),e.observe(dN))})},{threshold:.3}).observe(dN);const dU=document.getElementById("hero"),d$=window.innerWidth<=640?"assets/video/logn_hero_mobile.m3u8":"assets/video/logn_hero.m3u8";if(af.isSupported()){let t=new af;t.loadSource(d$),t.attachMedia(dU),t.on(af.Events.MANIFEST_PARSED,function(){dU.play()}),t.on(af.Events.ERROR,function(t,e){console.error("HLS.js error:",e)})}else dU.canPlayType("application/vnd.apple.mpegurl")&&(dU.src=d$,dU.addEventListener("loadedmetadata",function(){dU.play()}));document.querySelectorAll(".do-toggle-play").forEach(t=>{let e=t.getAttribute("data-video-target");if(!e)return void console.error("No data-video-target attribute");let i=document.getElementById(e);return i?"VIDEO"!==i.tagName?void console.error("Element is not HTMLVideoElement"):void t.addEventListener("click",()=>{i.paused?i.play():i.pause()}):void console.error(`No video element found with id="${e}"`)});
//# sourceMappingURL=pages.e7ec1f44.js.map
